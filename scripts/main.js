(()=>{var ot=Object.defineProperty;var Xt=(t,e,n)=>e in t?ot(t,e,{enumerable:!0,configurable:!0,writable:!0,value:n}):t[e]=n;var r=(t,e)=>ot(t,"name",{value:e,configurable:!0});var he=(t,e,n)=>(Xt(t,typeof e!="symbol"?e+"":e,n),n),it=(t,e,n)=>{if(!e.has(t))throw TypeError("Cannot "+n)};var st=(t,e,n)=>(it(t,e,"read from private field"),n?n.call(t):e.get(t)),X=(t,e,n)=>{if(e.has(t))throw TypeError("Cannot add the same private member more than once");e instanceof WeakSet?e.add(t):e.set(t,n)};var L=(t,e,n)=>(it(t,e,"access private method"),n);var ae="Compendium.pf2e.other-effects.Item.I9lfZUiCwMiGogVi",k={[void 0]:0,observed:0,concealed:1,hidden:2,undetected:3,unnoticed:4},H=["observed","concealed","hidden","undetected","unnoticed"],_=["none","lesser","standard","greater","greater-prone"],x={[void 0]:0,none:0,lesser:1,standard:2,greater:3,"greater-prone":4},w={cover:"none",visibility:"observed"},Ie=["attack-roll","spell-attack-roll"],rt=[...Ie,"skill-check","perception-check"];var Oe={cover:"modules/pf2e-perception/images/cover.webp",concealed:"systems/pf2e/icons/conditions/concealed.webp",hidden:"systems/pf2e/icons/conditions/hidden.webp",undetected:"systems/pf2e/icons/conditions/undetected.webp",unnoticed:"systems/pf2e/icons/conditions/unnoticed.webp"};var h="pf2e-perception";function z(t){return`modules/${h}/templates/${t}.hbs`}r(z,"templatePath");function g(...t){let e=t.at(-1),n=typeof e=="object",o=n?t.slice(0,-1):t;return o.unshift(h),game.i18n[n?"format":"localize"](o.join("."),e)}r(g,"localize");function V(t,e){return t.getFlag(h,e)}r(V,"getFlag");function He(t,e,n){return t.setFlag(h,e,n)}r(He,"setFlag");function ct(t,e){return t.unsetFlag(h,e,!0)}r(ct,"unsetFlag");function at(t){return getProperty(t,`flags.${h}`)??{}}r(at,"getFlags");function I(t){return game.settings.get(h,t)}r(I,"getSetting");function Ee(t,e){return game.settings.set(h,t,e)}r(Ee,"setSetting");function lt(){return game.user.role>=I("permission")}r(lt,"hasPermission");function ut(t){let e=game.i18n.localize(`PF2E.condition.${t}.name`);return game.pf2e.ConditionManager.getCondition("flat-footed",{name:e}).toObject()}r(ut,"createFlatFootedSource");function le(t){let e=x[t]===3?4:x[t];return{_id:"I9lfZUiCwMiGogVi",img:"systems/pf2e/icons/conditions-2/status_acup.webp",name:g("cover",t),system:{description:{gm:"",value:"<p>When you're behind an obstacle that could block weapons, guard you against explosions, and make you harder to detect, you're behind cover. Standard cover gives you a +2 circumstance bonus to AC, to Reflex saves against area effects, and to Stealth checks to Hide, Sneak, or otherwise avoid detection. You can increase this to greater cover using the Take Cover basic action, increasing the circumstance bonus to +4. If cover is especially light, typically when it's provided by a creature, you have lesser cover, which grants a +1 circumstance bonus to AC. A creature with standard cover or greater cover can attempt to use Stealth to Hide, but lesser cover isn't sufficient.</p>"},rules:[{domain:"all",key:"RollOption",option:`self:cover-bonus:${e}`},{domain:"all",key:"RollOption",option:`self:cover-level:${t}`},{key:"FlatModifier",predicate:[{or:[{and:["self:condition:prone","item:ranged"]},{not:"self:cover-level:greater-prone"}]}],selector:"ac",type:"circumstance",value:e},{key:"FlatModifier",predicate:["area-effect",{not:"self:cover-level:greater-prone"}],selector:"reflex",type:"circumstance",value:e},{key:"FlatModifier",predicate:[{or:["action:hide","action:sneak","avoid-detection"]},{not:"self:cover-level:greater-prone"}],selector:"stealth",type:"circumstance",value:e},{key:"FlatModifier",predicate:["action:avoid-notice",{not:"self:cover-level:greater-prone"}],selector:"initiative",type:"circumstance",value:e}],slug:"effect-cover"},type:"effect",flags:{core:{sourceId:ae},[h]:{level:t,bonus:e}}}}r(le,"createCoverSource");function Ae(t,e=void 0){if(t)return t.system.rules.find(n=>n.key==="ChoiceSet"&&(!e||n.flag===e))}r(Ae,"findChoiceSetRule");function De(t,e="origin"){let n={};return t.forEach(o=>{let i=o.split(":");if(i.at(1)!=="pf2perception")return;let s=i.at(0)==="self"?e:i.at(0),c=i.at(-1),a=[s,...i.slice(2,-1)].join("."),l=getProperty(n,a);l?l.push(c):l=[c],setProperty(n,a,l)}),n}r(De,"optionsToObject");function $e(t,e){if(!t||!e)return t;if(e.reduce&&["all",t].some(o=>e.reduce.includes(o))){let o=H.indexOf(t);t=H[Math.max(0,o-1)]}return t}r($e,"updateVisibilityFromOptions");var P=class extends Array{constructor(...e){super(...Array.isArray(e[0])?e[0]:e),this.isValid=P.isValid(this)}static isValid(e){return this.isArray(e)}static isArray(e){return super.isArray(e)&&e.every(n=>Z.isStatement(n))}static test(e=[],n){return e instanceof P?e.test(n):new P(...e).test(n)}test(e){if(this.length===0)return!0;if(!this.isValid)return console.warn("PF2e System | The provided predicate set is malformed."),!1;let n=e instanceof Set?e:new Set(e);return this.every(o=>this.#e(o,n))}toObject(){return deepClone([...this])}clone(){return new P(this.toObject())}#e(e,n){return typeof e=="string"&&n.has(e)||Z.isBinaryOp(e)&&this.#n(e,n)||Z.isCompound(e)&&this.#t(e,n)}#n(e,n){if("eq"in e)return n.has(`${e.eq[0]}:${e.eq[1]}`);{let o=Object.keys(e)[0],[i,s]=Object.values(e)[0],c=Array.from(n),a=r(d=>{let f=Number(d);if(!Number.isNaN(f))return[f];let y=new RegExp(String.raw`^${d}:([^:]+)$`);return c.map(m=>Number(y.exec(m)?.[1]||NaN)).filter(m=>!Number.isNaN(m))},"getValues"),l=a(i),u=a(s);switch(o){case"gt":return l.some(d=>u.every(f=>d>f));case"gte":return l.some(d=>u.every(f=>d>=f));case"lt":return l.some(d=>u.every(f=>d<f));case"lte":return l.some(d=>u.every(f=>d<=f));default:return console.warn("PF2e System | Malformed binary operation encountered"),!1}}}#t(e,n){return"and"in e&&e.and.every(o=>this.#e(o,n))||"nand"in e&&!e.nand.every(o=>this.#e(o,n))||"or"in e&&e.or.some(o=>this.#e(o,n))||"xor"in e&&e.xor.filter(o=>this.#e(o,n)).length===1||"nor"in e&&!e.nor.some(o=>this.#e(o,n))||"not"in e&&!this.#e(e.not,n)||"if"in e&&!(this.#e(e.if,n)&&!this.#e(e.then,n))}};r(P,"PredicatePF2e");var we,Z=class{static isStatement(e){return e instanceof Object?this.isCompound(e)||this.isBinaryOp(e):typeof e=="string"?this.isAtomic(e):!1}static isAtomic(e){return typeof e=="string"&&e.length>0||this.isBinaryOp(e)}static isBinaryOp(e){if(!We(e))return!1;let n=Object.entries(e);if(n.length>1)return!1;let[o,i]=n[0];return st(this,we).has(o)&&Array.isArray(i)&&i.length===2&&typeof i[0]=="string"&&["string","number"].includes(typeof i[1])}static isCompound(e){return We(e)&&(this.isAnd(e)||this.isOr(e)||this.isNand(e)||this.isXor(e)||this.isNor(e)||this.isNot(e)||this.isIf(e))}static isAnd(e){return Object.keys(e).length===1&&Array.isArray(e.and)&&e.and.every(n=>this.isStatement(n))}static isNand(e){return Object.keys(e).length===1&&Array.isArray(e.nand)&&e.nand.every(n=>this.isStatement(n))}static isOr(e){return Object.keys(e).length===1&&Array.isArray(e.or)&&e.or.every(n=>this.isStatement(n))}static isXor(e){return Object.keys(e).length===1&&Array.isArray(e.xor)&&e.xor.every(n=>this.isStatement(n))}static isNor(e){return Object.keys(e).length===1&&Array.isArray(e.nor)&&e.nor.every(n=>this.isStatement(n))}static isNot(e){return Object.keys(e).length===1&&!!e.not&&this.isStatement(e.not)}static isIf(e){return Object.keys(e).length===2&&this.isStatement(e.if)&&this.isStatement(e.then)}};r(Z,"StatementValidator"),we=new WeakMap,X(Z,we,new Set(["eq","gt","gte","lt","lte"]));async function Ye({affects:t,origin:e,target:n,item:o,domains:i,options:s}){if(!(e&&n))return[];let[c,a]=t==="target"?[e,n]:[n,e],l=[...s,...a.getSelfRollOptions(t)],u=o?o.isOfType("spell")?{spell:o}:{weapon:o}:{};return(await Promise.all(i.flatMap(d=>c.synthetics.ephemeralEffects[d]?.[t]??[]).map(d=>d({test:l,resolvables:u})))).flatMap(d=>d??[])}r(Ye,"extractEphemeralEffects");function dt(t,e){let n={name:t,label:game.i18n.localize(e[t]??t)};return Zt(CONFIG.PF2E.traitsDescriptions,t)&&(n.description=CONFIG.PF2E.traitsDescriptions[t]),n}r(dt,"traitSlugToObject");function Zt(t,e){return(typeof e=="string"||typeof e=="number")&&e in t}r(Zt,"objectHasKey");function ft(t,e){return t.isOfType("spell")?null:t.rangeIncrement&&typeof e=="number"?Math.max(Math.ceil(e/t.rangeIncrement),1):null}r(ft,"getRangeIncrement");function pt(t){if(!t.isOfType("creature"))return!1;let{flanking:e}=t.attributes;if(!e.flankable)return!1;let n=t.getRollOptions();return typeof e.flatFootable=="number"?!P.test([{lte:["origin:level",e.flatFootable]}],n):e.flatFootable}r(pt,"isOffGuardFromFlanking");function We(t){return typeof t=="object"&&t!==null}r(We,"isObject");function gt(t,e){let n="";for(let o of["standard","exposure"]){let i=J(t.object,o);n+=`<div class="form-group">
    <label>${g(`settings.${o}.name`)}</label>
    <input type="checkbox" name="flags.pf2e-perception.${o}" ${i?"checked":""}>
    <p class="notes">${g(`settings.${o}.short`)}</p>
</div>`}n+="<hr>",e.find('.tab[data-tab="basic"] hr').first().after(n),t.setPosition()}r(gt,"renderSceneConfig");function R(t){if(t=t instanceof Token?t.document:t,!(t instanceof TokenDocument))return[];let e=t.scene.tokens.filter(n=>n!==t&&n.actor?.isOfType("creature"));if(I("encounter")){let n=game.combats.active;return n?e.filter(o=>{let i=o.actor,s=i.traits;return i.type==="familiar"||s.has("minion")||s.has("eidolon")||n.getCombatantByToken(o.id)}):e}return e}r(R,"getValidTokens");function W(t,e){let n=R(t).map(o=>o.id);return e.filter(o=>{let i=o instanceof Token||o instanceof TokenDocument?o.id:o;return n.includes(i)})}r(W,"validateTokens");function J(t,e){return V(t,e)??I(e)}r(J,"getSceneSetting");function ue(t,e=1){let n=Object.getPrototypeOf(t);return e>1?ue(n,e-1):n}r(ue,"getPrototype");function Fe(t,e){return t.name.localeCompare(e.name)}r(Fe,"sortByName");var j=class extends Application{#e;#n;#t;#o;#i;constructor({token:e,resolve:n,selected:o=[]},i={}){super(i),this.#e=e,this.#n=n,this.#t=o,this.#i=(s,c)=>{let a=s.id,l=this.element.find("[data-token-id]");l.removeClass("hover"),c&&l.filter(`[data-token-id=${a}]`).addClass("hover")},Hooks.on("hoverToken",this.#i)}async close(e={}){Hooks.off("hoverToken",this.#i),this.#n?.(e.resolve??!1),super.close(e)}static get defaultOptions(){return mergeObject(super.defaultOptions,{minimizable:!1})}static async openMenu(e,n={}){if(e.token instanceof TokenDocument&&(e.token=e.token.object),!e.token){ui.notifications.error(g("menu.no-token"));return}n.id=`${h}-${e.token.document.uuid}`;let o=Object.values(ui.windows).find(i=>i.id===n.id);return o&&o.close(),new Promise(i=>{e.resolve=i,new this(e,n).render(!0)})}static createPropertyData(e,n,o){let i=w[o],s=e[o]??i,c=n[o]??i;return{original:s,current:c,changed:s!==c,custom:c!==i,originalCustom:s!==i}}get token(){return this.#e}get document(){return this.#e.document}get actor(){return this.#e.actor}get scene(){return this.#e.scene}get selected(){return this.#t.length?W(this.token,this.#t):[]}get currentData(){return deepClone(this.#s)}get#s(){return this.#o||(this.#o=this.getSavedData()),this.#o}getSavedData(){let e=O(this.document)??{};return deepClone(e)}reset(){this.#o=this.getSavedData(),this.#t=[],this.render()}isSelected(e){let n=typeof e=="object"?e.id:e;return this.#t.includes(n)}getData(e){let n=_.map(o=>({value:o,label:g(`cover.${o}`)}));return{i18n:g,covers:U(this.actor)?n:n.slice(0,-1),visibilities:H.map(o=>({value:o,label:g(`visibility.${o}`)}))}}activateListeners(e){e.find("[data-token-id]").on("mouseenter",n=>{let{tokenId:o}=n.currentTarget.dataset,i=this.scene.tokens.get(o)?.object;!i||i.controlled||i._onHoverIn(n,{hoverOutOthers:!0})}),e.find("[data-action=close]").on("click",()=>{this.close({resolve:!0})}),e.find("select[name=visibility], select[name=cover]").on("change",n=>{let o=n.currentTarget,i=o.name,s=w[i],c=o.value||s,a=o.closest(".token")?.dataset.tokenId,l=a?[a]:this.#t;for(let u of l)setProperty(this.#s,`${u}.${i}`,c);a?(o.classList.toggle("changed",c!==o.dataset.original),o.classList.toggle("custom",c!==s)):this.render()}),e.find("[data-action=accept]").on("click",n=>{this._saveData(this.#s),this.close({resolve:!0})})}_saveData(e){Re(this.document,e)}_setSelected(e){this.#t=e??this.element.find("[data-token-id].ui-selected").toArray().map(n=>n.dataset.tokenId)}_spliIntoAlliances(e){let n=[],o=[],i=[],s=this.actor.alliance,c=s==="party"?"opposition":s==="opposition"?"party":null;for(let a of e)if(c){let l=a.actor?a.actor.alliance:a.alliance;l===s?n.push(a):l===c?o.push(a):l===null&&i.push(a)}else i.push(a);return{allies:n.sort(Fe),neutral:i.sort(Fe),enemies:o.sort(Fe),hasTokens:n.length||o.length||i.length}}};r(j,"BaseMenu");var ve=class extends j{get title(){return g("menu.perception.title",{name:this.token.name})}get template(){return z("perception")}getData(e){let n=this.selected,o=this.currentData,i=this.getSavedData(),s=R(this.token).map(({id:c,name:a,actor:l})=>{let u=o[c]??{},d=i[c]??{};return{id:c,name:a,alliance:l.alliance,cover:j.createPropertyData(d,u,"cover"),visibility:j.createPropertyData(d,u,"visibility"),selected:n.includes(c)}});return{...super.getData(e),...this._spliIntoAlliances(s)}}activateListeners(e){super.activateListeners(e),e.filter(".tokens").selectable({autoRefresh:!1,filter:".token",cancel:"header,select",stop:()=>this._setSelected()}),e.find("[data-action=select-all]").on("click",n=>{let o=$(n.currentTarget).closest("section"),i=(o.length?o:e).find("[data-token-id]"),s=i.filter(":not(.ui-selected)").length===0;i.toggleClass("ui-selected",!s),this._setSelected()}),e.find("[data-action=use-selection]").on("click",n=>{this._setSelected(canvas.tokens.controlled.map(o=>o.id)),this.render()}),e.find("[data-action=reset]").on("click",n=>this.reset())}};r(ve,"PerceptionMenu");var Jt=[{x:0,y:0},{x:1,y:0},{x:0,y:1},{x:1,y:1}],Qt=[{x:.25,y:.25},{x:.5,y:.25},{x:.75,y:.25},{x:.25,y:.5},{x:.5,y:.5},{x:.75,y:.5},{x:.25,y:.75},{x:.5,y:.75},{x:.75,y:.75}];function mt(t,e){let n=1-e;return{top:{A:N({x:e,y:e},t),B:N({x:n,y:e},t)},right:{A:N({x:n,y:e},t),B:N({x:n,y:n},t)},bottom:{A:N({x:n,y:n},t),B:N({x:e,y:n},t)},left:{A:N({x:e,y:n},t),B:N({x:e,y:e},t)}}}r(mt,"getRectEdges");function ye(t,e,n=!1){return n&&B(t,e),CONFIG.Canvas.polygonBackends.move.testCollision(t,e,{type:"move",mode:"any"})}r(ye,"lineIntersectWall");function Ve(t,e,n=!1){for(let o of en(e.bounds))if(ye(t,o,n))return!0;return!1}r(Ve,"pointToTokenIntersectWall");function N(t,e){return{x:e.x+e.width*t.x,y:e.y+e.height*t.y}}r(N,"getRectPoint");function Q(){canvas.controls.debug.clear()}r(Q,"clearDebug");function B(t,e,n="blue"){let o=n==="blue"?26316:n==="red"?16711680:1483011;canvas.controls.debug.lineStyle(4,o).moveTo(t.x,t.y).lineTo(e.x,e.y)}r(B,"drawDebugLine");function*en(t){for(let e of Qt)yield N(e,t)}r(en,"rectSpread");function*ht(t){for(let e of Jt)yield N(e,t)}r(ht,"rectCorners");function Me(t,e=!1){if(t=t instanceof Token?t:t.object,t.document.hasStatusEffect(CONFIG.specialStatusEffects.INVISIBLE))return;let n=t.scene;if(n!==canvas.scene||!n.tokenVision||n.darkness<n.globalLightThreshold||!J(n,"exposure"))return;e&&Q();let o=t.document.bounds,i=null;for(let s of canvas.effects.lightSources){if(!s.active)continue;let c=s.data.bright,a=s.data.dim;if(s.object===t){if(c)return"bright";a&&(i="dim");continue}let l=[];for(let u of ht(o))s.shape.contains(u.x,u.y)?l.push(u):e&&B(s,u,"red");if(l.length){if(s.ratio===1)return e&&B(s,l,"green"),"bright";if(s.ratio===0){e&&B(s,l,"blue"),i="dim";continue}for(let u of l)if(new Ray(s,u).distance<=c)if(e)B(s,u,"green"),i="bright";else return"bright";else e?(B(s,u,"blue"),i!=="bright"&&(i="dim")):i="dim"}}return i}r(Me,"getLightExposure");function vt(t,e){!lt()||!t.object.actor?.isOfType("creature")||(e.find(".col.left").append('<div class="control-icon" data-action="pf2e-perception"><i class="fa-solid fa-eye"></i></div>'),e.find("[data-action=pf2e-perception]").on("click",n=>ve.openMenu({token:t.object})))}r(vt,"renderTokenHUD");function yt(t,e){for(let n of e)delete n.flags?.[h]}r(yt,"pasteToken");function O(t,...e){return e.unshift("data"),t=t instanceof Token?t.document:t,V(t,e.join("."))}r(O,"getTokenData");async function kt(t){return t=t instanceof Token?t.document:t,ct(t,"data")}r(kt,"clearTokenData");async function Re(t,e){let n=R(t).map(i=>i.id),o={};for(let i in e){if(!n.includes(i)){o[`flags.${h}.data.-=${i}`]=!0;continue}let s=e[i],c=O(t,i)??{};if(s.visibility===w.visibility&&delete s.visibility,s.cover===w.cover&&delete s.cover,!(c.cover===s.cover&&c.visibility===s.visibility))if(!s.visibility&&!s.cover)o[`flags.${h}.data.-=${i}`]=!0;else for(let a of["cover","visibility"])c[a]!==s[a]&&(s[a]?o[`flags.${h}.data.${i}.${a}`]=s[a]:o[`flags.${h}.data.${i}.-=${a}`]=!0)}return t=t instanceof Token?t.document:t,t.update(o)}r(Re,"setTokenData");function qe(t,e,n=!1){let o=t.scene;if(!J(o,"standard"))return!1;n&&Q();let i=I("standard-type");if(i==="center")return ye(t.center,e.center,n);if(i==="points")return Ve(t.center,e,n)}r(qe,"hasStandardCover");var ee={tiny:0,sm:1,med:2,lg:3,huge:4,grg:5};function Ke(t,e,n=!1){let o=I("lesser");if(o==="none")return;let i,s=t.center,c=e.center;n&&(Q(),B(s,c));let a=r(p=>{let S=ee[p.actor.size];return S-l>=2&&S-u>=2},"isExtraLarge"),l=ee[t.actor.size],u=ee[e.actor.size],d=t.scene.tokens.contents.filter(p=>p.actor).sort((p,S)=>ee[S.actor.size]-ee[p.actor.size]),f=l<ee.huge&&u<ee.huge&&d.filter(a).length,y=o==="ten"?.1:o==="twenty"?.2:0,m=r(p=>(n&&B(p.A,p.B,"red"),lineSegmentIntersects(s,c,p.A,p.B)),"intersectsEdge"),v=o==="cross"?p=>m(p.top)&&m(p.bottom)||m(p.left)&&m(p.right):p=>Object.values(p).some(S=>m(S));for(let p of d){let S=p.object;if(p.hidden||S===t||S===e)continue;let C=mt(S.bounds,y);if(v(C))return f?"standard":"lesser";a(p)&&f--}return i}r(Ke,"getCreatureCover");function de(t,e){let n=(()=>{let l=t.actor,u=["unnoticed","undetected","hidden","concealed"];for(let d of u)if(l.hasCondition(d))return d})(),o=O(t,e.id,"visibility"),i=k[n]>k[o]?n:o,s=k[i];if(s>=k.undetected)return i;let c=Me(t),a=c==="dim"?"concealed":c===null?"hidden":void 0;return s>k[a]?i:a}r(de,"getVisibility");function bt(t,e,n,o){let i=e.flags?.["pf2e-perception"];if(i&&(i.data||i["-=data"]!==void 0)){if(t.object.renderFlags.set({refreshVisibility:!0}),game.user.isGM)return;let s=Hooks.on("refreshToken",c=>{!t.object!==c&&(Hooks.off("refreshToken",s),game.combat?.getCombatantByToken(t.id)&&ui.combat.render())})}}r(bt,"updateToken");function Ct(t,e){e?Le(t):fe(t)}r(Ct,"hoverToken");function Tt(t){fe(t),game.user.isGM||ui.combat.render()}r(Tt,"deleteToken");function St(t){fe(t),Hooks.once("sightRefresh",()=>t.hover&&Le(t))}r(St,"controlToken");function fe(t){if(!t?.id)return $(".pf2e-conditionals").remove();$(`.pf2e-conditionals[data-hover-id=${t.id}]`).remove(),$(`.pf2e-conditionals[data-token-id=${t.id}]`).remove()}r(fe,"clearConditionals");function Le(t){let e=R(t);for(let n of e)Xe(n,t)}r(Le,"showAllConditionals");async function Xe(t,e){if(t=t instanceof Token?t:t.object,!t.visible||!t.actor?.isOfType("creature"))return;let n=O(t,e.id);if(isEmpty(n))return;if(!game.user.isGM&&!e.document.hasPlayerOwner&&k[n.visibility]>=k.hidden){if(!n.cover)return;n={cover:n.cover}}let o=t.worldTransform.a,i=canvas.clientCoordinatesFromCanvas(t.document._source),s=`<div class="pf2e-conditionals" data-hover-id="${t.id}" data-token-id="${e.id}" `;s+=`style="top: ${i.y}px; left: ${i.x+t.hitArea.width*o/2}px;">`;let c=I("icon-path");Object.entries(n).map(([a,l])=>{let u=a==="cover"?"cover":l,d=c[u]||Oe[u];(d.startsWith("systems")||d.startsWith("modules"))&&(d=`../../../${d}`),s+=`<div class="conditional"><img src="${d}"></img></div>`}),s+="</div>",$(document.body).append(s)}r(Xe,"showConditionals");function _e(t,e,n,o=!1){let s=n.includes("item:ranged")?U(e.actor):!1,c=Y(e.actor,!0);if(s&&x[c]>x.lesser)return"greater-prone";!s&&c==="greater-prone"&&(c=void 0);let a=O(e,t.id,"cover");return s&&x[a]>x.lesser||(!s&&a==="greater-prone"&&(a=void 0),x[a]<x.standard&&x[c]<x.standard&&qe(t,e,o)?a="standard":!a&&!c&&t.distanceTo(e)>5&&(a=Ke(t,e,o)),s&&x[a]>x.lesser)?"greater-prone":x[a]>x[c]?a:void 0}r(_e,"getConditionalCover");async function xt(t){let[e,n]=canvas.ready&&!t.viewOnly?[canvas.tokens.controlled.find(b=>b.actor===this)??this.getActiveTokens().shift()??null,t.target?.token??t.target?.actor?.getActiveTokens().shift()??null]:[null,null],o=this.getRollOptions(t.domains??[]),i=await Ye({affects:"origin",origin:this,target:t.target?.actor??n?.actor??null,item:t.item??null,domains:t.domains,options:[...t.options,...t.item?.getRollOptions("item")??[]]}),s=t.viewOnly||!n?.actor?this:this.getContextualClone([...o,...n.actor.getSelfRollOptions("target")],i),c=t.statistic instanceof game.pf2e.StatisticModifier,a=c?s.system.actions?.flatMap(b=>[b,b.altUsages??[]].flat())??[]:[],l=t.viewOnly?t.statistic:c?a.find(b=>t.item?.id!==b.item.id||t?.item.name!==b.item.name?!1:t.item.isOfType("melee")&&b.item.isOfType("melee")?!0:t.item.isOfType("weapon")&&b.item.isOfType("weapon")&&t.item.isMelee===b.item.isMelee)??t.statistic:t.statistic,u=(()=>{if(s===this)return t.item??null;if(l&&"item"in l&&l.item instanceof Item&&l.item.isOfType("melee","spell","weapon"))return l.item;let b=s.items.get(t.item?.id??"");return b?.isOfType("melee","spell","weapon")?b:t.item??null})(),d=u?.getRollOptions("item")??[],y=[["attack","strike-damage","attack-spell-damage"].some(b=>t.domains.includes(b))?"attack":[],c&&u?.isOfType("weapon")&&u.baseType==="alchemical-bomb"?"manipulate":[]].flat();if(u?.isOfType("weapon","melee"))for(let b of this.synthetics.strikeAdjustments)b.adjustTraits?.(u,y);let m=y.map(b=>dt(b,CONFIG.PF2E.actionTraits)),v=e&&n?e.distanceTo(n):null,[p,S]=typeof v=="number"?[`origin:distance:${v}`,`target:distance:${v}`]:[null,null],C=r(b=>{let me=b?.getSelfRollOptions("target")??[];if(n){me.push("target");let nt=this.synthetics.targetMarks.get(n.document.uuid);nt&&me.push(`target:mark:${nt}`)}return me},"getTargetRollOptions"),E=C(n?.actor),D=await Ye({affects:"target",origin:s,target:n?.actor??null,item:u,domains:t.domains,options:[...t.options,...d,...E]}),[F,G]=t.item?.isOfType("melee")?[t.item.reach,t.item.isMelee]:t.item?.isOfType("weapon")?[this.getReach({action:"attack",weapon:t.item}),t.item.isMelee]:[null,!1];if(e&&n&&tn({selfToken:e,targetToken:n,ephemeralEffects:D,options:[...t.options,...s.getSelfRollOptions("origin"),...d,...E]}),!!(G&&typeof F=="number"&&t.statistic instanceof game.pf2e.StatisticModifier&&n&&e?.isFlanking(n,{reach:F}))&&t.target?.token?.actor&&pt(t.target.token.actor)){let b=game.i18n.localize("PF2E.Item.Condition.Flanked"),me=game.pf2e.ConditionManager.getCondition("flat-footed",{name:b});D.push(me.toObject())}let K=t.viewOnly?null:(t.target?.actor??n?.actor)?.getContextualClone([...s.getSelfRollOptions("origin"),...d,...p?[p]:[]],D)??null,ce=new Set([...t.options,...o,...K?C(K):E,...d,"attack"]);S&&ce.add(S);let Ge=u?ft(u,v):null;Ge&&ce.add(`target:range-increment:${Ge}`);let qt={actor:s,token:e?.document??null,statistic:l,item:u,modifiers:[]},Kt=K&&n&&v!==null?{actor:K,token:n.document,distance:v,rangeIncrement:Ge}:null;return{options:ce,self:qt,target:Kt,traits:m}}r(xt,"getRollContext");function tn({ephemeralEffects:t,selfToken:e,targetToken:n,options:o}){let i=_e(e,n,o);if(o=De(o),o.origin?.cover&&i&&o.origin.cover.reduce&&["all",i].some(a=>o.origin.cover.reduce.includes(a))){let a=_.indexOf(i);i=_[Math.max(0,a-1)]}let s=$e(de(e,n),o.target?.visibility);o.target?.visibility?.cancel&&["all",s].some(a=>o.target.visibility.cancel.includes(a))&&(s=void 0),x[i]>x.none&&t.push(le(i)),k[s]>k.concealed&&t.push(ut(s))}r(tn,"addConditionals");function te(t,e=!1){if(!t)return;let n=t.id,o=t.isToken;return(e?game.user.targets:canvas.tokens.controlled).find(s=>o?s.actor===t:s.actor.id===n)??t.getActiveTokens().shift()??null}r(te,"getActorToken");function U(t){return t.itemTypes.condition.some(e=>e.slug==="prone")}r(U,"isProne");function Y(t,e=!1){let n=t.itemTypes.effect.find(o=>o.sourceId===ae);return e?Ae(n)?.selection.level:n}r(Y,"getCoverEffect");function Et(t,e){let n=t.token;if(!n)return;let o=game.user.isGM,i=n.hasPlayerOwner,{cover:s,selected:c,skipWait:a,validated:l,blindCheck:u,pointOut:d}=at(t),f=t.getFlag("pf2e","context");if(u&&!o&&i)e.find(".message-sender").text(n.name),e.find(".flavor-text").html(u);else if(s){if(o){let y=Je({property:"cover",skipWait:a,validated:l});e.find(".message-content").append(y),e.find("[data-action=validate-cover]").on("click",()=>{ne.openMenu({token:n,selected:c,value:s,message:t})})}else if(!a){let y=Ze("cover",l);e.find(".message-content").append(y)}}else if(f?.visibility){l||e.find(".message-buttons").remove();let y=e.find(".flavor-text");!o&&i&&(e.find(".message-sender").text(n.name),y.empty());let m=g(`message.flat-check.${l===void 0?"blind":l?"success":"failure"}`),v=Dt(m,l);if(y.append(v),o)for(let p of["success","failure"])y.append(Qe({action:`${p}-message`,icon:"fa-solid fa-message",label:g("message.flat-check.button",p)})),e.find(`[data-action=${p}-message]`).on("click",()=>{He(t,"validated",p==="success")})}else if(f?.type==="skill-check")o?f.options.includes("action:hide")&&Ot({token:n,html:e,message:t,skipWait:a,validated:l,selected:f.selected,ValidationMenu:oe}):i&&f.options.includes("action:hide")&&It({token:n,message:t,html:e,validated:l});else if(f?.type==="perception-check")o?f.options.includes("action:seek")&&Ot({token:n,html:e,message:t,skipWait:a,validated:l,selected:f.selected,ValidationMenu:ie}):i&&f.options.includes("action:seek")&&It({token:n,message:t,html:e,validated:l});else if(d){let y=n.scene.tokens.get(d);if(!y)return;if(o){let m='<div style="display: grid; grid-template-columns: 1fr auto; gap: 3px">';m+=Je({property:"visibility",skipWait:a,validated:l}),m+=Qe({action:"ping-token",icon:"fa-solid fa-signal-stream"}),m+="</div>",e.find(".message-content").append(m),e.find("[data-action=validate-visibility]").on("click",async()=>{ke.openMenu({message:t,token:y,originator:n,selected:canvas.tokens.controlled.map(v=>v.id)})}),e.find("[data-action=ping-token]").on("click",()=>{canvas.ping(y.center)})}else if(i){let m=Ze("visibility",l);e.find(".message-content").append(m)}}}r(Et,"renderChatMessage");function At(t){V(t,"validated")||He(t,"validated",!0)}r(At,"validateMessage");function It({html:t,token:e,message:n,validated:o}){t.find(".message-sender").text(e.name);let i=n.getFlag("pf2e","modifierName");i+=Ze("visibility",o),t.find(".flavor-text").html(i)}r(It,"addBlindSkillCheckFlavor");function Ze(t,e){let n=g(`message.${t}.player.${e?"validated":"wait"}`);return Dt(n,e)}r(Ze,"createWaitHint");function Dt(t,e){return e===!0?t='<i class="fa-solid fa-check" style="color: green;"></i> '+t:e===!1&&(t='<i class="fa-solid fa-xmark" style="color: red;"></i> '+t),`<i style="display: block; font-size: .9em; text-align: end;">${t}</i>`}r(Dt,"createHint");function Ot({skipWait:t,validated:e,html:n,message:o,ValidationMenu:i,token:s,selected:c}){let a=Je({property:"visibility",skipWait:t,validated:e});n.find(".flavor-text").append(a),n.find("[data-action=validate-visibility]").on("click",async()=>{let l=o.rolls[0];i.openMenu({token:s,message:o,roll:l,selected:c})})}r(Ot,"addVisibilityValidationButton");function Je({skipWait:t,validated:e,property:n}){let o=g(`message.${n}.gm.${t?"check":e?"validated":"validate"}`);return!t&&e&&(o+='<i class="fa-solid fa-check" style="color: green; margin-left: 0.3em;"></i>'),Qe({action:`validate-${n}`,icon:"fa-solid fa-list",label:o})}r(Je,"createValidateButton");function Qe({action:t,icon:e,label:n}){let o=`<button type="button" style="margin: 0 0 5px; padding-block: 0;" data-action="${t}">`;return e&&(o+=`<i class="${e}" ${n?"":'style="margin: 0;"'}></i>`),n&&(o+=`${e?" ":""}${n}`),o+="</button>",o}r(Qe,"createChatButton");async function et({content:t,token:e,flags:n,secret:o}){let i={content:t,speaker:ChatMessage.getSpeaker({token:e instanceof Token?e.document:e})};return n&&setProperty(i,`flags.${h}`,n),o&&(i.type=CONST.CHAT_MESSAGE_TYPES.WHISPER,i.whisper=ChatMessage.getWhisperRecipients("gm")),ChatMessage.create(i)}r(et,"createTokenMessage");var Pe={LOWER_BY_TWO:-2,LOWER:-1,INCREASE:1,INCREASE_BY_TWO:2,TO_CRITICAL_FAILURE:"criticalFailure",TO_FAILURE:"failure",TO_SUCCESS:"success",TO_CRITICAL_SUCCESS:"criticalSuccess"},$t=["criticalFailure","failure","success","criticalSuccess"],Ue,wt,pe,je,se,be,Ne,Ft,q=class{constructor(e,n,o=null){X(this,Ue);X(this,pe);X(this,se);X(this,Ne);e instanceof Roll?(this.dieResult=(e.isDeterministic?e.terms.find(i=>i instanceof NumericTerm):e.dice.find(i=>i instanceof Die&&i.faces===20))?.total??1,this.rollTotal=e.total):(this.dieResult=e.dieValue,this.rollTotal=e.dieValue+e.modifier),this.dc=typeof n=="number"?{value:n}:n,this.unadjusted=L(this,Ne,Ft).call(this),this.adjustment=L(this,Ue,wt).call(this,this.unadjusted,o),this.value=this.adjustment?L(this,pe,je).call(this,this.adjustment.amount,this.unadjusted):this.unadjusted}},A=q;r(A,"DegreeOfSuccess"),Ue=new WeakSet,wt=r(function(e,n){if(!n)return null;for(let o of["all",...$t]){let{label:i,amount:s}=n[o]??{};if(s&&i&&!(e===q.CRITICAL_SUCCESS&&s===Pe.INCREASE)&&!(e===q.CRITICAL_FAILURE&&s===Pe.LOWER)&&(o==="all"||$t.indexOf(o)===e))return{label:i,amount:s}}return null},"#getDegreeAdjustment"),pe=new WeakSet,je=r(function(e,n){switch(e){case"criticalFailure":return 0;case"failure":return 1;case"success":return 2;case"criticalSuccess":return 3;default:return Math.clamped(n+e,0,3)}},"#adjustDegreeOfSuccess"),se=new WeakSet,be=r(function(e){return this.dieResult===20?L(this,pe,je).call(this,Pe.INCREASE,e):this.dieResult===1?L(this,pe,je).call(this,Pe.LOWER,e):e},"#adjustDegreeByDieValue"),Ne=new WeakSet,Ft=r(function(){let e=this.dc.value;return this.rollTotal-e>=10?L(this,se,be).call(this,q.CRITICAL_SUCCESS):e-this.rollTotal>=10?L(this,se,be).call(this,q.CRITICAL_FAILURE):this.rollTotal>=e?L(this,se,be).call(this,q.SUCCESS):L(this,se,be).call(this,q.FAILURE)},"#calculateDegreeOfSuccess"),he(A,"CRITICAL_FAILURE",0),he(A,"FAILURE",1),he(A,"SUCCESS",2),he(A,"CRITICAL_SUCCESS",3);var nn={burst:"circle",emanation:"circle",line:"ray",cone:"cone",rect:"rect"};function Rt(t,e){sn({type:t,token:e,distance:t==="cone"?30:15,traits:["concentrate","secret"]})}r(Rt,"createSeekTemplate");function on(t){return t.scene.templates.find(e=>V(e,"tokenId")===t.id)}r(on,"getTokenTemplate");function Vt(t){if(!Mt(t))return null;let e=on(t);return e?rn(e.object):null}r(Vt,"getTokenTemplateTokens");async function Ce(t){let e=t.scene.templates.filter(n=>V(n,"tokenId")===t.id);for(let n of e)await n.delete()}r(Ce,"deleteTokenTemplate");function Mt(t){return canvas.scene===t.scene?!0:(ui.notifications.error(g("template.scene")),!1)}r(Mt,"checkScene");function sn({type:t,distance:e,traits:n,fillColor:o,width:i,token:s}){if(!Mt(s))return;let c={distance:e,t:nn[t],fillColor:o||game.user.color,flags:{[h]:{tokenId:s.id}}};c.t==="ray"?c.width=i||CONFIG.MeasuredTemplate.defaults.width*(canvas.dimensions?.distance??1):c.t==="cone"&&(c.angle=CONFIG.MeasuredTemplate.defaults.angle),n&&setProperty(c,"flags.pf2e.origin.traits",n);let a=new CONFIG.MeasuredTemplate.documentClass(c,{parent:canvas.scene});new CONFIG.MeasuredTemplate.objectClass(a).drawPreview()}r(sn,"createTemplate");function rn(t,{collisionOrigin:e,collisionType:n="move"}={}){if(!canvas.scene)return[];let{grid:o,dimensions:i}=canvas;if(!(o&&i))return[];let s=o.getHighlightLayer(t.highlightId);if(!s||o.type!==CONST.GRID_TYPES.SQUARE)return[];let c=e??t.center,a=canvas.tokens.quadtree.getObjects(s.getLocalBounds(void 0,!0)),l=[];for(let u of a){let d=u.document,f=[];for(let y=0;y<d.height;y++){let m=u.y+y*o.size;if(f.push(`${u.x}.${m}`),d.width>1)for(let v=1;v<d.width;v++)f.push(`${u.x+v*o.size}.${m}`)}for(let y of f){if(!s.positions.has(y))continue;let[m,v]=y.split(".").map(C=>Number(C)),p={x:m+i.size*.5,y:v+i.size*.5};if(p.x<0||p.y<0)continue;if(!(canvas.ready&&n&&CONFIG.Canvas.polygonBackends[n].testCollision(c,p,{type:n,mode:"any"}))){l.push(u);break}}}return l}r(rn,"getTokens");var Te=class extends j{static async openMenu(e,n){let o=await super.openMenu(e,n);return o&&e.message&&At(e.message),o}get title(){return g("menu.validation.title",{name:this.token.name})}get template(){return z("validation")}get selected(){let e=super.selected;if(e.length)return e;let n=this.token,o=n.actor.alliance;return R(n).filter(i=>i.actor.alliance!==o).map(i=>i.id)}getSavedData(e=!0){let n=super.getSavedData();return e?this._convertData(n):n}_convertData(e){let n=this.property,o=this.scene,i=this.selected,s=w[n],c=n==="cover"?_:H;for(let a of i){let l=o.tokens.get(a),u=`${a}.${n}`,d=getProperty(e,u)??s,f=this.processValue({token:l,value:d});c.includes(f)||(f=d),d!==f&&setProperty(e,u,f)}return e}processValue(e){throw new Error(`${this.constructor.name} doesn't have a 'processValue' method defined`)}getData(e){let{covers:n,visibilities:o,i18n:i}=super.getData(e),s=this.currentData,c=this.getSavedData(!1),a=this.property,l=this.selected,u=R(this.token);u=u.map(({id:f,name:y,actor:m})=>{let v=s[f]??{},p=c[f]??{};return{id:f,name:y,alliance:m.alliance,selected:l.includes(f),...j.createPropertyData(p,v,a)}});let d=I("validation");return d==="selected"?u=u.filter(f=>f.selected):d==="changed"&&(u=u.filter(f=>f.changed)),{...this._spliIntoAlliances(u),i18n:i,property:a,options:a==="cover"?n:o,showSelected:d==="all",showChanges:d!=="changed"}}activateListeners(e){super.activateListeners(e),e.find("[data-action=cancel]").on("click",n=>{this.close()})}};r(Te,"ValidationMenu");var ne=class extends Te{#e;constructor(e,n={}){super(e,n),this.#e=e.value}get property(){return"cover"}processValue(){return this.#e}};r(ne,"CoverValidationMenu");var ge=class extends Te{#e;constructor(e,n={}){super(e,n),this.#e=e.roll}get property(){return"visibility"}get roll(){return this.#e}};r(ge,"VisibilityValidationMenu");var oe=class extends ge{processValue({token:e,value:n}){let o=this.roll,i=e.actor.perception.dc.value,s=k[n],c=new A(o,i).value;return c>=A.SUCCESS&&s<k.hidden?"hidden":c<=A.FAILURE&&s>=k.hidden?"observed":n}};r(oe,"HideValidationMenu");var ke=class extends ge{#e;constructor(e,n={}){super(e,n),this.#e=e.originator}get selected(){let e=this.token,n=e.actor.alliance,o=this.#e.id,i=O(e)??{};return R(e).filter(s=>{if(s.id===o||s.actor.alliance===n)return!1;let c=getProperty(i,`${s.id}.visibility`);return k[c]>=k.undetected}).map(s=>s.id)}processValue({token:e,value:n}){return k[n]>=k.undetected?"hidden":n}};r(ke,"PointOutValidationMenu");var Be=class extends ge{getSavedData(e=!0){let n=this.token.id,o=R(this.token),i={};for(let s of o){let c=O(s,n);c&&(i[s.id]=deepClone(c))}return e?this._convertData(i):i}getData(){let e=super.getData();return e.isReversed=!0,e.options=H.map(n=>({value:n,label:g(`visibility.reversed.${n}`)})),e}_saveData(e){let n=this.scene,o=this.token.id,i=[];for(let[s,c]of Object.entries(e)){let a={_id:s},l=n.tokens.get(s);if(l){c.visibility===w.visibility&&delete c.visibility;let u=O(l,o);if(u?.visibility===c.visibility)continue;!u.cover&&!c.visibility?a[`flags.${h}.data.-=${o}`]=!0:c.visibility?a[`flags.${h}.data.${o}.visibility`]=c.visibility:a[`flags.${h}.data.${o}.-=visibility`]=!0}else a[`flags.${h}.data.-=${o}`]=!0;i.push(a)}n.updateEmbeddedDocuments("Token",i)}};r(Be,"ReverseVisibilityValidationMenu");var ie=class extends Be{static async openMenu(e,n){await super.openMenu(e,n)&&Ce(e.token)}processValue({token:e,value:n}){let o=this.roll,i=e.actor.skills.stealth.dc.value,s=k[n],c=new A(o,i).value;return c>=A.CRITICAL_SUCCESS&&s>=k.hidden||c>=A.SUCCESS&&s===k.hidden?"observed":c>=A.SUCCESS&&s>=k.undetected?"hidden":n}};r(ie,"SeekValidationMenu");function _t(){let t=game.pf2e.actions.get("hide"),e=ue(t,2).constructor,n=ue(t.toActionVariant(),2).constructor,o=ue(t,1).constructor,i=ue(t.toActionVariant(),1).constructor;fn(e,n),dn(o,i),ln(o,i),cn(e,n)}r(_t,"setupActions");function cn(t,e){class n extends e{async use(s={}){let c=g("action.point-out"),a=ze(s,c);a&&an(this,a)}}r(n,"PointOutVariant");class o extends t{constructor(){super({cost:1,name:`${h}.action.point-out`,description:`${h}.action.point-out.description`,rollOptions:["action:point-out"],slug:"point-out",traits:["auditory","manipulate","visual"]})}toActionVariant(s={}){return s.name??=this.name,new n(this,s)}}r(o,"PointOut"),game.pf2e.actions.set("point-out",new o)}r(cn,"setupPointOut");async function an({name:t,traits:e},n){let o=game.user.targets.filter(u=>u.actor).first(),i=o?O(o,n.id,"visibility"):void 0,s=o&&k[i]<k.undetected,c;if(s){let u=o.actor.skills.stealth.dc.value;c=g("message.point-out.short-check",{check:`@Check[type:perception|dc:${u}|traits:auditory,manipulate,visual|showDC:gm]`})}else c=g("message.point-out.short");let a=await renderTemplate(z("point-out"),{description:c,name:t,traits:e.map(u=>({slug:u,tooltip:CONFIG.PF2E.traitsDescriptions[u],name:CONFIG.PF2E.actionTraits[u]}))}),l={pointOut:s?o.id:void 0};et({content:a,token:n,flags:l})}r(an,"pointOut");function ln(t,e){class n extends e{async use(s={}){let c=game.i18n.localize("PF2E.Actions.Seek.Title"),a=ze(s,c);if(!a)return;if(!await un(a))return Ce(a);s.actors=[a.actor];let l=await super.use(s);if(game.user.isGM){let{selected:u}=l[0].message.getFlag("pf2e","context");u&&Pt({token:a,result:l,ValidationMenu:ie})}return l}}r(n,"SeekVariant");class o extends t{constructor(){super({cost:1,description:"PF2E.Actions.Seek.Description",name:"PF2E.Actions.Seek.Title",notes:[{outcome:["criticalSuccess"],text:"PF2E.Actions.Seek.Notes.criticalSuccess"},{outcome:["success"],text:"PF2E.Actions.Seek.Notes.success"}],rollOptions:["action:seek"],slug:"seek",statistic:"perception",traits:["concentrate","secret"]})}toActionVariant(s){return new n(this,s)}}r(o,"Seek"),game.pf2e.actions.set("seek",new o)}r(ln,"setupSeek");async function un(t){let e=game.i18n.localize("PF2E.Foot"),n='<p style="margin: 0 0.3em; text-align: center;">';return n+=`${g("dialog.seek.hint")}</p><p>`,n+=Lt("create-cone","fa-thin fa-cubes",game.i18n.format("PF2E.TemplateLabel",{size:30,unit:e,shape:game.i18n.localize(CONFIG.PF2E.areaTypes.cone)})),n+=Lt("create-burst","fa-thin fa-cubes",game.i18n.format("PF2E.TemplateLabel",{size:15,unit:e,shape:game.i18n.localize(CONFIG.PF2E.areaTypes.burst)})),n+="</p>",Dialog.wait({title:`${t.name} - ${game.i18n.localize("PF2E.Actions.Seek.Title")}`,content:n,buttons:{ok:{icon:'<i class="fa-solid fa-check"></i>',label:g("dialog.seek.accept"),callback:()=>!0},no:{icon:'<i class="fa-solid fa-xmark"></i>',label:g("dialog.seek.cancel"),callback:o=>!1}},close:()=>!1,render:o=>{o.filter(".dialog-content").find("[data-action=create-cone], [data-action=create-burst]").on("click",s=>{let{action:c}=s.currentTarget.dataset;Ce(t),Rt(c==="create-cone"?"cone":"burst",t)})}},{width:300,left:10})}r(un,"seek");function dn(t,e){class n extends e{async use(s={}){let c=game.i18n.localize("PF2E.Actions.Hide.Title"),a=ze(s,c);if(!a)return;s.actors=[a.actor];let l=await super.use(s);return game.user.isGM&&Pt({token:a,result:l,ValidationMenu:oe}),l}}r(n,"HideVariant");class o extends t{constructor(){super({cost:1,description:"PF2E.Actions.Hide.Description",name:"PF2E.Actions.Hide.Title",rollOptions:["action:hide"],slug:"hide",statistic:"stealth",traits:["secret"],notes:[{outcome:["success","criticalSuccess"],text:"PF2E.Actions.Hide.Notes.success"}]})}toActionVariant(s){return new n(this,s)}}r(o,"Hide"),game.pf2e.actions.set("hide",new o)}r(dn,"setupHide");function fn(t,e){class n extends e{async use(s={}){let c=g("action.take-cover"),a=ze(s,c);a&&pn(a)}}r(n,"TakeCoverVariant");class o extends t{constructor(){super({cost:1,description:"PF2E.Actions.TakeCover.Description",img:"systems/pf2e/icons/conditions-2/status_acup.webp",name:"PF2E.Actions.TakeCover.Title",slug:"take-cover"})}toActionVariant(s){return new n(this,s)}}r(o,"TakeCover"),game.pf2e.actions.set("take-cover",new o)}r(fn,"setupCover");async function pn(t){let e=t.actor,n=Y(e),o=W(t,game.user.targets.ids);if(n&&!o.length)return n.delete();let i=O(t)??{},s=Object.entries(i).reduce((l,[u,{cover:d}])=>(d&&(l[u]=d),l),{}),c=await renderTemplate(z("covers-dialog"),{i18n:g,hasTargets:!!o.length,hasCovers:!isEmpty(s),hasTargetCover:o.some(l=>l in s),isProne:U(e)}),a=new Dialog({title:`${t.name} - ${g("action.take-cover")}`,content:c,buttons:{},render:l=>{l.find("button").on("click",async u=>{let{level:d}=u.currentTarget.dataset,f=I("skip-cover"),y=r(async(m,v)=>{v=v?o:void 0;let p=m===w.cover?v?"remove":"remove-all":"take",S=await et({content:g(`message.cover.${p}`,{cover:g(`cover.${m}`)}),flags:{selected:v,cover:m,skipWait:f},token:t});if(f){if(m===w.cover&&!v)return kt(t);let C=deepClone(O(t))??{};for(let E of o)setProperty(C,`${E}.cover`,m);return Re(t,C)}else game.user.isGM&&ne.openMenu({token:t,selected:v,value:m,message:S})},"process");if(d==="remove-all")y(w.cover);else if(d==="remove")y(w.cover,!0);else if(o.length)y(d,!0);else{let m=le(d);e.createEmbeddedDocuments("Item",[m])}a.close()})}}).render(!0)}r(pn,"takeCover");function ze(t,e){let n=t.tokens?.filter(s=>s.actor)??[];Array.isArray(n)||(n=[n]);let o=t.actors??[];if(Array.isArray(o)||(o=[o]),!n.length&&o.length===1&&(n=[te(o[0])].filter(Boolean)),n.length||(n=canvas.tokens.controlled.filter(s=>s.actor)),n.length||(n=[te(game.user.character)].filter(Boolean)),n.length>1){ui.notifications.warn(g("action.only-one",{action:e}));return}else if(!n.length){ui.notifications.warn(g("action.must-one",{action:e}));return}let i=n[0];if(!i?.actor?.isOfType("creature")){ui.notifications.warn(g("action.must-creature",{action:e}));return}return i}r(ze,"getSelectedToken");function Lt(t,e,n){return`<button type="button" data-action="${t}" style="margin: 0 0 5px; padding: 0;">
    <i class="${e}"></i> ${n}</button>
</button>`}r(Lt,"createButton");function Pt({token:t,result:e,ValidationMenu:n}){let o=e[0].roll,i=e[0].message,s=i.getFlag("pf2e","context.selected");n.openMenu({token:t,roll:o,selected:s,message:i})}r(Pt,"openVisibilityValidationMenu");async function jt(t,...e){let n=e[1];if(!n)return t(...e);Array.isArray(n.options)&&(n.options=new Set(n.options));let{actor:o,createMessage:i="true",type:s,token:c,target:a,isReroll:l}=n,u=c??te(o),d=a?.token,f=Ie.includes(s),y=I("flat-check");if(l||!i||!u||!rt.includes(s)||f&&(!d||y==="none"))return t(...e);if(f&&d.actor){let m=De(n.options).origin,v=$e(de(d,u),m?.visibility);if(!v)return t(...e);if(v==="concealed"&&u.actor?.hasLowLightVision)return t(...e);let p=m?.[v]?.dc?.[0];if(p==0)return t(...e);let S=p??(v==="concealed"?5:11),C=await new Roll("1d20").evaluate({async:!0}),E=C.total,D=E>=S,F=k[v]>=k.undetected,G=D?2:1,xe=`${game.i18n.localize("PF2E.FlatCheck")}:`;xe+=`<strong> ${game.i18n.localize(`PF2E.condition.${v}.name`)}</strong>`,xe+=(await game.pf2e.Check.createResultFlavor({target:a,degree:{value:G,unadjusted:G,adjustment:null,dieResult:E,rollTotal:E,dc:{value:S}}})).outerHTML;let K={flavor:xe,speaker:ChatMessage.getSpeaker({token:u instanceof Token?u.document:u})};if(F){n.options.add("secret"),n.isSuccess=D,n.visibility=v;let ce=`${game.i18n.localize("PF2E.FlatCheck")}:`;ce+=`<strong> ${game.i18n.localize("PF2E.condition.undetected.name")}</strong>`,K.flags={[h]:{blindCheck:ce}}}if(await C.toMessage(K,{rollMode:F?game.user.isGM?"gmroll":"blindroll":"roll"}),y!=="roll"&&!F&&!D)return}else if(n.options.has("action:hide"))n.selected=game.user.targets.ids;else if(n.options.has("action:seek")){let m=Vt(u);if(m===void 0)return t(...e);let v=m??Array.from(game.user.targets);n.selected=W(u,v).filter(p=>!p.document.hidden).map(p=>p.id)}return t(...e)}r(jt,"checkRoll");function Ut(t,e){let{createMessage:n="true",type:o,token:i,target:s,isReroll:c,options:a,dc:l}=t.context,u=i,d=s?.token,f=s?.actor;if(c||!n||!u||!d||!f||!Ie.includes(o))return;let y=Y(f),m=y?Ae(y)?.selection.level??V(y,"level"):void 0,v=t[h]?.coverOverride??m,p='<div class="roll-mode-panel">';p+=`<div class="label">${g("dice-checks.cover.label")}</div>`,p+=`<select name="overrideCover"><option value="">${g("dice-checks.cover.none")}</option>`,(U(f)?_.slice(1):_.slice(1,-1)).forEach(C=>{let E=C===v?"selected":"",D=g(`cover.${C}`);p+=`<option value="${C}" ${E}>${D}</option>`}),p+="</select></div>",p+="<hr>",e.find(".roll-mode-panel").before(p),e.find("select[name=overrideCover]").on("change",C=>{let E=C.currentTarget.value||void 0;setProperty(t,`${h}.coverOverride`,E),v=E}),e.find("button.roll")[0].addEventListener("click",C=>{C.preventDefault(),C.stopPropagation(),C.stopImmediatePropagation();let E=!1,D=deepClone(f._source.items);if(v!==m){E=!0;let F=D.findIndex(G=>getProperty(G,"flags.core.sourceId")===ae);if(F!==-1&&D.splice(F,1),v){let G=le(v);D.push(G)}}if(E&&(s.actor=f.clone({items:D},{keepId:!0}),l?.slug)){let F=s.actor.getStatistic(l.slug)?.dc;F&&(l.value=F.value,l.statistic=F)}t.resolve(!0),t.isResolved=!0,t.close()},!0),t.setPosition()}r(Ut,"renderCheckModifiersDialog");function Nt(t,e,n){return t(e,n)?!tt(n)||!re(n,"basicSight")&&!gn(n):!1}r(Nt,"basicSightCanDetect");function Bt(t,e,n){return t(e,n)?game.settings.get("pf2e","automation.rulesBasedVision")?!e.object.actor?.hasCondition("deafened")&&tt(n)&&!re(n,"hearing"):!0:!1}r(Bt,"hearingCanDetect");function zt(t,e,n){return t(e,n)?tt(n)&&!re(n,"feelTremor"):!1}r(zt,"feelTremorCanDetect");function tt(t){return!!(t instanceof Token&&t.actor)}r(tt,"isValidTarget");function Gt(t,e,n){for(let o of e){let i=O(t,o.id,"visibility");if(k[i]>=n)return!0}return!1}r(Gt,"reachesThreshold");function re(t,e,n=!1){let i=(game.user.isGM?canvas.tokens.controlled:t.scene.tokens.filter(s=>s.isOwner)).filter(s=>s.detectionModes.some(c=>c.id===e));return Gt(t,i,n?k.unnoticed:k.undetected)}r(re,"isUndetected");function gn(t){let e=canvas.tokens.controlled;return!game.user.isGM&&!e.length&&(e=t.scene.tokens.filter(n=>n.isOwner),e.length!==1)?!1:Gt(t,e,k.hidden)}r(gn,"isHidden");function Ht(t,e){I("target")&&hn(e),mn(e)}r(Ht,"renderCombatTracker");function mn(t){if(!canvas.ready)return;let e=game.combats.viewed?.combatants;e?.size&&t.find("#combat-tracker .combatant").each((n,o)=>{let{combatantId:i}=o.dataset,s=e.get(i??"")?.token;s&&re(s,"basicSight",!0)&&o.remove()})}r(mn,"hideUndetected");function hn(t){t.find("[data-control=toggleTarget]").each((e,n)=>{n.addEventListener("click",o=>{o.preventDefault(),o.stopPropagation(),o.stopImmediatePropagation();let{combatantId:i}=o.currentTarget.closest(".combatant").dataset,c=game.combats.viewed.combatants.get(i??"")?.token;if(!c)return;let a=Array.from(game.user.targets).some(l=>l.document===c);c.object.setTarget(!a,{releaseOthers:!o.shiftKey})},!0)})}r(hn,"setupToggleTarget");function Wt(t,e){let n=I("encounter");e.find(".form-group").last().after(`<div class="form-group">
    <label>${g("settings.encounter.name")}</label>
    <input type="checkbox" name="pf2e-perception.encounter" ${n?"checked":""}>
    <p class="notes">${g("settings.encounter.short")}</p>
</div>`),e.find('input[name="pf2e-perception.encounter"]').on("change",o=>{let i=o.currentTarget.checked;Ee("encounter",i)})}r(Wt,"renderCombatTrackerConfig");var vn=["cover","concealed","hidden","undetected","unnoticed"],Se=class extends FormApplication{static get defaultOptions(){return foundry.utils.mergeObject(super.defaultOptions,{template:z("icon-path-menu"),title:g("settings.icon-path.name"),width:500})}getData(){let e=I("icon-path");return{icons:vn.map(o=>({name:o,placeholder:Oe[o],value:e[o]??"",label:o==="cover"?g("icon-path.cover"):game.i18n.localize(CONFIG.PF2E.conditionTypes[o])})),i18n:g}}activateListeners(e){super.activateListeners(e),e.find("button[name=cancel]").on("click",n=>{n.prefentDefault(),this.close()})}async _updateObject(e,n){Ee("icon-path",n)}};r(Se,"IconPathMenu");function Yt(){M("icon-path",Object,{},{config:!1}),game.settings.registerMenu(h,"icon-path-menu",{name:T("icon-path","name"),label:T("icon-path","label"),icon:"fa-solid fa-list",restricted:!0,type:Se}),M("permission",String,CONST.USER_ROLES.GAMEMASTER,{choices:{1:T("permission","choices.1"),2:T("permission","choices.2"),3:T("permission","choices.3"),4:T("permission","choices.4")}}),M("target",Boolean,!0,{onChange:()=>ui.combat?.render()}),M("lesser",String,"ten",{choices:{none:T("lesser","choices.none"),cross:T("lesser","choices.cross"),zero:T("lesser","choices.zero"),ten:T("lesser","choices.ten"),twenty:T("lesser","choices.twenty")}}),M("standard",Boolean,!0),M("standard-type",String,"center",{choices:{center:T("standard-type","choices.center"),points:T("standard-type","choices.points")}}),M("skip-cover",Boolean,!0),M("validation",String,"all",{choices:{all:T("validation","choices.all"),selected:T("validation","choices.selected"),changed:T("validation","choices.changed")}}),M("exposure",Boolean,!0),M("flat-check",String,"cancel",{choices:{none:T("flat-check","choices.none"),roll:T("flat-check","choices.roll"),cancel:T("flat-check","choices.cancel")}}),M("encounter",Boolean,!1)}r(Yt,"registerSettings");function T(t,e){return`${h}.settings.${t}.${e}`}r(T,"path");function M(t,e,n,o={}){game.settings.register(h,t,{name:T(t,"name"),hint:T(t,"hint"),scope:"world",config:!0,type:e,default:n,...o})}r(M,"register");var yn="game.pf2e.Check.roll",kn="CONFIG.Actor.documentClass.prototype.getRollContext",bn="CONFIG.Canvas.detectionModes.basicSight._canDetect",Cn="CONFIG.Canvas.detectionModes.hearing._canDetect",Tn="CONFIG.Canvas.detectionModes.feelTremor._canDetect";Hooks.once("init",()=>{Yt(),_t(),libWrapper.register(h,yn,jt),libWrapper.register(h,kn,xt,"OVERRIDE"),libWrapper.register(h,bn,Nt),libWrapper.register(h,Cn,Bt),libWrapper.register(h,Tn,zt),game.data.users.find(e=>e._id===game.data.userId).role>=CONST.USER_ROLES.GAMEMASTER?(Hooks.on("renderSceneConfig",gt),Hooks.on("renderCombatTrackerConfig",Wt)):Hooks.on("renderCombatTracker",Ht)});Hooks.once("ready",()=>{game.modules.get(h).api={geometry:{clearDebug:Q,lineIntersectWall:ye,pointToTokenIntersectWall:Ve},token:{getCreatureCover:Ke,getVisibility:de,clearConditionals:fe,showConditionals:Xe,showAllConditionals:Le,hasStandardCover:qe,getTokenData:O},lighting:{getLightExposure:Me},actor:{getActorToken:te,isProne:U,getCoverEffect:Y,getConditionalCover:_e},scene:{getValidTokens:R,validateTokens:W,getSceneSetting:J},detection:{isUndetected:re}}});Hooks.on("hoverToken",Ct);Hooks.on("pasteToken",yt);Hooks.on("updateToken",bt);Hooks.on("deleteToken",Tt);Hooks.on("controlToken",St);Hooks.on("renderTokenHUD",vt);Hooks.on("canvasPan",()=>fe());Hooks.on("renderChatMessage",Et);Hooks.on("renderCheckModifiersDialog",Ut);})();
//# sourceMappingURL=main.js.map
