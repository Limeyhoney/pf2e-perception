(()=>{var At=Object.defineProperty;var An=(t,e,n)=>e in t?At(t,e,{enumerable:!0,configurable:!0,writable:!0,value:n}):t[e]=n;var r=(t,e)=>At(t,"name",{value:e,configurable:!0});var Se=(t,e,n)=>(An(t,typeof e!="symbol"?e+"":e,n),n),Dt=(t,e,n)=>{if(!e.has(t))throw TypeError("Cannot "+n)};var Rt=(t,e,n)=>(Dt(t,e,"read from private field"),n?n.call(t):e.get(t)),te=(t,e,n)=>{if(e.has(t))throw TypeError("Cannot add the same private member more than once");e instanceof WeakSet?e.add(t):e.set(t,n)};var V=(t,e,n)=>(Dt(t,e,"access private method"),n);var ge="Compendium.pf2e.other-effects.Item.I9lfZUiCwMiGogVi",T={[void 0]:0,observed:0,concealed:1,hidden:2,undetected:3,unnoticed:4},ne=["observed","concealed","hidden","undetected","unnoticed"],W=["none","lesser","standard","greater","greater-prone"],I={[void 0]:0,none:0,lesser:1,standard:2,greater:3,"greater-prone":4},F={cover:"none",visibility:"observed"},me=["attack-roll","spell-attack-roll"],wt=[...me,"skill-check","perception-check"],Ne={cover:"modules/pf2e-perception/images/cover.webp",concealed:"systems/pf2e/icons/conditions/concealed.webp",hidden:"systems/pf2e/icons/conditions/hidden.webp",undetected:"systems/pf2e/icons/conditions/undetected.webp",unnoticed:"systems/pf2e/icons/conditions/unnoticed.webp"},Ce={BLINDED:0,NORMAL:1,LOWLIGHT:2,DARKVISION:3},ut="#000000",dt="#656665",Lt=["darkness","dance-of-darkness","ravenous-darkness"],Ft=["obscuring-mist"];var g="pf2e-perception";function Y(t){return`modules/${g}/templates/${t}.hbs`}r(Y,"templatePath");function m(...t){let e=t.at(-1),n=typeof e=="object",o=n?t.slice(0,-1):t;return o.unshift(g),game.i18n[n?"format":"localize"](o.join("."),e)}r(m,"localize");function w(t,e){return t.getFlag(g,e)}r(w,"getFlag");function ft(t,e,n){return t.setFlag(g,e,n)}r(ft,"setFlag");function $t(t,e){return t.unsetFlag(g,e,!0)}r($t,"unsetFlag");function Mt(t){return getProperty(t,`flags.${g}`)??{}}r(Mt,"getFlags");function E(t){return game.settings.get(g,t)}r(E,"getSetting");function Ve(t,e){return game.settings.set(g,t,e)}r(Ve,"setSetting");function Pt(){return game.user.role>=E("permission")}r(Pt,"hasPermission");function _t(t){let e=game.i18n.localize(`PF2E.condition.${t}.name`);return game.pf2e.ConditionManager.getCondition("flat-footed",{name:e}).toObject()}r(_t,"createFlatFootedSource");function he(t,e){return e??=I[t]===3?4:I[t],{_id:"I9lfZUiCwMiGogVi",img:"systems/pf2e/icons/conditions-2/status_acup.webp",name:m("cover",t),system:{description:{gm:"",value:"<p>When you're behind an obstacle that could block weapons, guard you against explosions, and make you harder to detect, you're behind cover. Standard cover gives you a +2 circumstance bonus to AC, to Reflex saves against area effects, and to Stealth checks to Hide, Sneak, or otherwise avoid detection. You can increase this to greater cover using the Take Cover basic action, increasing the circumstance bonus to +4. If cover is especially light, typically when it's provided by a creature, you have lesser cover, which grants a +1 circumstance bonus to AC. A creature with standard cover or greater cover can attempt to use Stealth to Hide, but lesser cover isn't sufficient.</p>"},rules:[{domain:"all",key:"RollOption",option:`self:cover-bonus:${e}`},{domain:"all",key:"RollOption",option:`self:cover-level:${t}`},{key:"FlatModifier",predicate:[{or:[{and:["self:condition:prone","item:ranged"]},{not:"self:cover-level:greater-prone"}]}],selector:"ac",type:"circumstance",value:e},{key:"FlatModifier",predicate:["area-effect",{not:"self:cover-level:greater-prone"}],selector:"reflex",type:"circumstance",value:e},{key:"FlatModifier",predicate:[{or:["action:hide","action:sneak","avoid-detection"]},{not:"self:cover-level:greater-prone"}],selector:"stealth",type:"circumstance",value:e},{key:"FlatModifier",predicate:["action:avoid-notice",{not:"self:cover-level:greater-prone"}],selector:"initiative",type:"circumstance",value:e}],slug:"effect-cover"},type:"effect",flags:{core:{sourceId:ge},[g]:{level:t,bonus:e}}}}r(he,"createCoverSource");function Ge(t,e=void 0){if(t)return t.system.rules.find(n=>n.key==="ChoiceSet"&&(!e||n.flag===e))}r(Ge,"findChoiceSetRule");function oe(t,e="origin"){let n={};return t.forEach(o=>{let s=o.split(":");if(s.at(1)!=="pf2perception")return;let i=s.at(0)==="self"?e:s.at(0),c=s.at(-1),a=[i,...s.slice(2,-1)].join("."),l=getProperty(n,a);l?l.push(c):l=[c],setProperty(n,a,l)}),n}r(oe,"optionsToObject");function Ue(t,e,n,o){let s=r(a=>a?["all",t].some(l=>a.includes(l)):!1,"test"),i=s(e.origin?.[n]?.[o]),c=s(e.target?.[n]?.[`${o}-self`]);return i||c}r(Ue,"testOption");function xe(t,...e){let n=getProperty(t.origin,e.join("."))??[],o=getProperty(t.target,[...e.slice(0,-1),e.at(-1)+"-self"].join("."))??[];return[...n,...o]}r(xe,"getOption");function Oe(t,e,n){let o=n==="cover"?W:ne;if(e=Array.isArray(e)?oe(e):e,t&&Ue(t,e,n,"cancel"))return;let s=xe(e,n,"set")?.[0];if(s&&o.includes(s))return s===o[0]?void 0:s;if(t&&Ue(t,e,n,"reduce")){let i=o.indexOf(t);return o[Math.max(0,i-1)]}return t}r(Oe,"updateFromOptions");var G=class extends Array{constructor(...e){super(...Array.isArray(e[0])?e[0]:e),this.isValid=G.isValid(this)}static isValid(e){return this.isArray(e)}static isArray(e){return super.isArray(e)&&e.every(n=>ie.isStatement(n))}static test(e=[],n){return e instanceof G?e.test(n):new G(...e).test(n)}test(e){if(this.length===0)return!0;if(!this.isValid)return console.warn("PF2e System | The provided predicate set is malformed."),!1;let n=e instanceof Set?e:new Set(e);return this.every(o=>this.#e(o,n))}toObject(){return deepClone([...this])}clone(){return new G(this.toObject())}#e(e,n){return typeof e=="string"&&n.has(e)||ie.isBinaryOp(e)&&this.#n(e,n)||ie.isCompound(e)&&this.#t(e,n)}#n(e,n){if("eq"in e)return n.has(`${e.eq[0]}:${e.eq[1]}`);{let o=Object.keys(e)[0],[s,i]=Object.values(e)[0],c=Array.from(n),a=r(d=>{let f=Number(d);if(!Number.isNaN(f))return[f];let v=new RegExp(String.raw`^${d}:([^:]+)$`);return c.map(y=>Number(v.exec(y)?.[1]||NaN)).filter(y=>!Number.isNaN(y))},"getValues"),l=a(s),u=a(i);switch(o){case"gt":return l.some(d=>u.every(f=>d>f));case"gte":return l.some(d=>u.every(f=>d>=f));case"lt":return l.some(d=>u.every(f=>d<f));case"lte":return l.some(d=>u.every(f=>d<=f));default:return console.warn("PF2e System | Malformed binary operation encountered"),!1}}}#t(e,n){return"and"in e&&e.and.every(o=>this.#e(o,n))||"nand"in e&&!e.nand.every(o=>this.#e(o,n))||"or"in e&&e.or.some(o=>this.#e(o,n))||"xor"in e&&e.xor.filter(o=>this.#e(o,n)).length===1||"nor"in e&&!e.nor.some(o=>this.#e(o,n))||"not"in e&&!this.#e(e.not,n)||"if"in e&&!(this.#e(e.if,n)&&!this.#e(e.then,n))}};r(G,"PredicatePF2e");var je,ie=class{static isStatement(e){return e instanceof Object?this.isCompound(e)||this.isBinaryOp(e):typeof e=="string"?this.isAtomic(e):!1}static isAtomic(e){return typeof e=="string"&&e.length>0||this.isBinaryOp(e)}static isBinaryOp(e){if(!pt(e))return!1;let n=Object.entries(e);if(n.length>1)return!1;let[o,s]=n[0];return Rt(this,je).has(o)&&Array.isArray(s)&&s.length===2&&typeof s[0]=="string"&&["string","number"].includes(typeof s[1])}static isCompound(e){return pt(e)&&(this.isAnd(e)||this.isOr(e)||this.isNand(e)||this.isXor(e)||this.isNor(e)||this.isNot(e)||this.isIf(e))}static isAnd(e){return Object.keys(e).length===1&&Array.isArray(e.and)&&e.and.every(n=>this.isStatement(n))}static isNand(e){return Object.keys(e).length===1&&Array.isArray(e.nand)&&e.nand.every(n=>this.isStatement(n))}static isOr(e){return Object.keys(e).length===1&&Array.isArray(e.or)&&e.or.every(n=>this.isStatement(n))}static isXor(e){return Object.keys(e).length===1&&Array.isArray(e.xor)&&e.xor.every(n=>this.isStatement(n))}static isNor(e){return Object.keys(e).length===1&&Array.isArray(e.nor)&&e.nor.every(n=>this.isStatement(n))}static isNot(e){return Object.keys(e).length===1&&!!e.not&&this.isStatement(e.not)}static isIf(e){return Object.keys(e).length===2&&this.isStatement(e.if)&&this.isStatement(e.then)}};r(ie,"StatementValidator"),je=new WeakMap,te(ie,je,new Set(["eq","gt","gte","lt","lte"]));async function gt({affects:t,origin:e,target:n,item:o,domains:s,options:i}){if(!(e&&n))return[];let[c,a]=t==="target"?[e,n]:[n,e],l=[...i,...a.getSelfRollOptions(t)],u=o?o.isOfType("spell")?{spell:o}:{weapon:o}:{};return(await Promise.all(s.flatMap(d=>c.synthetics.ephemeralEffects[d]?.[t]??[]).map(d=>d({test:l,resolvables:u})))).flatMap(d=>d??[])}r(gt,"extractEphemeralEffects");function Nt(t,e){let n={name:t,label:game.i18n.localize(e[t]??t)};return Dn(CONFIG.PF2E.traitsDescriptions,t)&&(n.description=CONFIG.PF2E.traitsDescriptions[t]),n}r(Nt,"traitSlugToObject");function Dn(t,e){return(typeof e=="string"||typeof e=="number")&&e in t}r(Dn,"objectHasKey");function Vt(t,e){return t.isOfType("spell")?null:t.rangeIncrement&&typeof e=="number"?Math.max(Math.ceil(e/t.rangeIncrement),1):null}r(Vt,"getRangeIncrement");function Gt(t){if(!t.isOfType("creature"))return!1;let{flanking:e}=t.attributes;if(!e.flankable)return!1;let n=t.getRollOptions();return typeof e.flatFootable=="number"?!G.test([{lte:["origin:level",e.flatFootable]}],n):e.flatFootable}r(Gt,"isOffGuardFromFlanking");function pt(t){return typeof t=="object"&&t!==null}r(pt,"isObject");function Ut(t,e){let n="",o=["standard","npc-vision"];for(let i of o){let c=ye(t.object,i);n+=`<div class="form-group pf2e-perception-injected">
    <label>${m(`settings.${i}.name`)}</label>
    <input type="checkbox" name="flags.pf2e-perception.${i}" ${c?"checked":""}>
    <p class="notes">${m(`settings.${i}.short`)}</p>
</div>`}n+="<hr>",e.find('.tab[data-tab="basic"] hr').first().after(n);let s=e.find(".pf2e-perception-injected").toArray().reduce((i,c)=>(i+=c.clientHeight,i),0);t.setPosition({top:t.position.top-s/2})}r(Ut,"renderSceneConfig");function M(t){if(t=t instanceof Token?t.document:t,!(t instanceof TokenDocument))return[];let e=t.scene.tokens.filter(n=>n!==t&&n.actor?.isOfType("creature"));if(E("encounter")){let n=game.combats.active;return n?e.filter(o=>{let s=o.actor,i=s.traits;return s.type==="familiar"||i.has("minion")||i.has("eidolon")||n.getCombatantByToken(o.id)}):e}return e}r(M,"getValidTokens");function q(t,e){let n=M(t).map(o=>o.id);return e.filter(o=>{let s=o instanceof Token||o instanceof TokenDocument?o.id:o;return n.includes(s)})}r(q,"validateTokens");function ye(t,e){return w(t,e)??E(e)}r(ye,"getSceneSetting");function ve(t,e=1){let n=Object.getPrototypeOf(t);return e>1?ve(n,e-1):n}r(ve,"getPrototype");function ze(t,e){return t.name.localeCompare(e.name)}r(ze,"sortByName");function He(t){return t=Number(t),isNaN(t)?void 0:t}r(He,"asNumberOnly");var U=class extends Application{#e;#n;#t;#o;#i;constructor({token:e,resolve:n,selected:o=[]},s={}){super(s),this.#e=e,this.#n=n,this.#t=o,this.#i=(i,c)=>{let a=i.id,l=this.element.find("[data-token-id]");l.removeClass("hover"),c&&l.filter(`[data-token-id=${a}]`).addClass("hover")},Hooks.on("hoverToken",this.#i)}async close(e={}){Hooks.off("hoverToken",this.#i),this.#n?.(e.resolve??!1),super.close(e)}static get defaultOptions(){return mergeObject(super.defaultOptions,{minimizable:!1})}static async openMenu(e,n={}){if(e.token instanceof TokenDocument&&(e.token=e.token.object),!e.token){ui.notifications.error(m("menu.no-token"));return}n.id=`${g}-${e.token.document.uuid}`;let o=Object.values(ui.windows).find(s=>s.id===n.id);return o&&o.close(),new Promise(s=>{e.resolve=s,new this(e,n).render(!0)})}static createPropertyData(e,n,o){let s=F[o],i=e[o]??s,c=n[o]??s;return{original:i,current:c,changed:i!==c,custom:c!==s,originalCustom:i!==s}}get token(){return this.#e}get document(){return this.#e.document}get actor(){return this.#e.actor}get scene(){return this.#e.scene}get selected(){return this.#t.length?q(this.token,this.#t):[]}get currentData(){return deepClone(this.#s)}get#s(){return this.#o||(this.#o=this.getSavedData()),this.#o}getSavedData(){let e=A(this.document)??{};return deepClone(e)}reset(){this.#o=this.getSavedData(),this.#t=[],this.render()}isSelected(e){let n=typeof e=="object"?e.id:e;return this.#t.includes(n)}getData(e){let n=W.map(o=>({value:o,label:m(`cover.${o}`)}));return{i18n:m,covers:j(this.actor)?n:n.slice(0,-1),visibilities:ne.map(o=>({value:o,label:m(`visibility.${o}`)}))}}activateListeners(e){e.find("[data-token-id]").on("mouseenter",n=>{let{tokenId:o}=n.currentTarget.dataset,s=this.scene.tokens.get(o)?.object;!s||s.controlled||s._onHoverIn(n,{hoverOutOthers:!0})}),e.find("[data-action=close]").on("click",()=>{this.close({resolve:!0})}),e.find("select[name=visibility], select[name=cover]").on("change",n=>{let o=n.currentTarget,s=o.name,i=F[s],c=o.value||i,a=o.closest(".token")?.dataset.tokenId,l=a?[a]:this.#t;for(let u of l)setProperty(this.#s,`${u}.${s}`,c);a?(o.classList.toggle("changed",c!==o.dataset.original),o.classList.toggle("custom",c!==i)):this.render()}),e.find("[data-action=accept]").on("click",n=>{this._saveData(this.#s),this.close({resolve:!0})})}_saveData(e){Be(this.document,e)}_setSelected(e){this.#t=e??this.element.find("[data-token-id].ui-selected").toArray().map(n=>n.dataset.tokenId)}_spliIntoAlliances(e){let n=[],o=[],s=[],i=this.actor.alliance,c=i==="party"?"opposition":i==="opposition"?"party":null;for(let a of e)if(c){let l=a.actor?a.actor.alliance:a.alliance;l===i?n.push(a):l===c?o.push(a):l===null&&s.push(a)}else s.push(a);return{allies:n.sort(ze),neutral:s.sort(ze),enemies:o.sort(ze),hasTokens:n.length||o.length||s.length}}};r(U,"BaseMenu");var Ie=class extends U{get title(){return m("menu.perception.title",{name:this.token.name})}get template(){return Y("perception")}getData(e){let n=this.selected,o=this.currentData,s=this.getSavedData(),i=M(this.token).map(({id:c,name:a,actor:l})=>{let u=o[c]??{},d=s[c]??{};return{id:c,name:a,alliance:l.alliance,cover:U.createPropertyData(d,u,"cover"),visibility:U.createPropertyData(d,u,"visibility"),selected:n.includes(c)}});return{...super.getData(e),...this._spliIntoAlliances(i)}}activateListeners(e){super.activateListeners(e),e.filter(".tokens").selectable({autoRefresh:!1,filter:".token",cancel:"header,select",stop:()=>this._setSelected()}),e.find("[data-action=select-all]").on("click",n=>{let o=$(n.currentTarget).closest("section"),s=(o.length?o:e).find("[data-token-id]"),i=s.filter(":not(.ui-selected)").length===0;s.toggleClass("ui-selected",!i),this._setSelected()}),e.find("[data-action=use-selection]").on("click",n=>{this._setSelected(canvas.tokens.controlled.map(o=>o.id)),this.render()}),e.find("[data-action=reset]").on("click",n=>this.reset())}};r(Ie,"PerceptionMenu");var Rn=[{x:0,y:0},{x:1,y:0},{x:0,y:1},{x:1,y:1}],wn=[{x:.25,y:.25},{x:.5,y:.25},{x:.75,y:.25},{x:.25,y:.5},{x:.5,y:.5},{x:.75,y:.5},{x:.25,y:.75},{x:.5,y:.75},{x:.75,y:.75}];function We(t,e){let n=1-e;return{top:{A:z({x:e,y:e},t),B:z({x:n,y:e},t)},right:{A:z({x:n,y:e},t),B:z({x:n,y:n},t)},bottom:{A:z({x:n,y:n},t),B:z({x:e,y:n},t)},left:{A:z({x:e,y:n},t),B:z({x:e,y:e},t)}}}r(We,"getRectEdges");function Ee(t,e,n=!1){return n&&H(t,e),CONFIG.Canvas.polygonBackends.move.testCollision(t,e,{type:"move",mode:"any"})}r(Ee,"lineIntersectWall");function Ye(t,e,n=!1){for(let o of Ln(e.bounds))if(Ee(t,o,n))return!0;return!1}r(Ye,"pointToTokenIntersectWall");function z(t,e){return{x:e.x+e.width*t.x,y:e.y+e.height*t.y}}r(z,"getRectPoint");function se(){canvas.controls.debug.clear()}r(se,"clearDebug");function H(t,e,n="blue"){let o=n==="blue"?26316:n==="red"?16711680:1483011;canvas.controls.debug.lineStyle(4,o).moveTo(t.x,t.y).lineTo(e.x,e.y)}r(H,"drawDebugLine");function*Ln(t){for(let e of wn)yield z(e,t)}r(Ln,"rectSpread");function*jt(t){for(let e of Rn)yield z(e,t)}r(jt,"rectCorners");function Ke(t,e=!1){if(t=t instanceof Token?t:t.object,t.document.hasStatusEffect(CONFIG.specialStatusEffects.INVISIBLE))return;let n=t.scene;if(n!==canvas.scene||!n.tokenVision||n.darkness<n.globalLightThreshold)return;e&&se();let o=t.document.bounds,s=null;for(let i of canvas.effects.lightSources){if(!i.active)continue;let c=i.data.bright,a=i.data.dim;if(i.object===t){if(c)return"bright";a&&(s="dim");continue}let l=[];for(let u of jt(o))i.shape.contains(u.x,u.y)?l.push(u):e&&H(i,u,"red");if(l.length){if(i.ratio===1)return e&&H(i,l,"green"),"bright";if(i.ratio===0){e&&H(i,l,"blue"),s="dim";continue}for(let u of l)if(new Ray(i,u).distance<=c)if(e)H(i,u,"green"),s="bright";else return"bright";else e?(H(i,u,"blue"),s!=="bright"&&(s="dim")):s="dim"}}return s}r(Ke,"getLightExposure");function Fn(t,e){return canvas.dimensions?canvas.grid.type!==CONST.GRID_TYPES.SQUARE?canvas.grid.measureDistance(t,e):$n(new Ray(t,e)):NaN}r(Fn,"measureDistance");function $n(t,{reach:e=null}={}){if(!canvas.dimensions)return NaN;let n=canvas.dimensions.size,o=canvas.dimensions.distance,s=Math.ceil(Math.abs(t.dx/n)),i=Math.ceil(Math.abs(t.dy/n)),c=Math.ceil(Math.abs((t.dz||0)/n)),a=[s,i,c].sort((f,v)=>f-v),l={doubleDiagonal:a[0],diagonal:a[1]-a[0],straight:a[2]-a[1]},u=l.diagonal+l.doubleDiagonal>1&&e===10?1:0;return(Math.floor(l.doubleDiagonal*1.75+l.diagonal*1.5+l.straight)-u)*o}r($n,"measureDistanceOnGrid");function zt({areaType:t,object:e,colors:n,document:o,collisionType:s="move",preview:i=!1,collisionOrigin:c}){if(!e.id&&!i)return;let{grid:a,dimensions:l}=canvas;if(!(a&&l))return;let u=o.angle??0,d=o.direction??45,f=a.getHighlightLayer(e.highlightId)?.clear();if(!f)return;let[v,y]=a.getCenter(o.x,o.y),[p,k]=a.grid.getGridPositionFromPixels(v,y),C=(360+(d-u*.5)%360)%360,h=(360+(d+u*.5)%360)%360,S=canvas.grid.getSnappedPosition(o.x,o.y,e.layer.gridPrecision),D=r((R,b,x)=>(R=(360+R%360)%360,b=(360+b%360)%360,x=(360+x%360)%360,R<b?x>=R&&x<=b:x>=R||x<=b),"withinAngle"),P=(()=>{if(t!=="cone")return{x:0,y:0};let R=(d>=0?360-d:-d)%360,b=S.x%l.size!==0?Math.sign(1*Math.round(Math.cos(Math.toRadians(R))*100)/100)/2:0,x=S.y%l.size!==0?-Math.sign(1*Math.round(Math.sin(Math.toRadians(R))*100)/100)/2:0;return{x:b*l.size,y:x*l.size}})(),J=Math.clamped(o.width??0,1.5,2),ct=o.distance??0,ee=ct*J/l.distance,fe=Math.ceil(ee/(l.size/a.h)),pe=Math.ceil(ee/(l.size/a.w)),at=r(R=>{if(!(t==="emanation"&&e instanceof Token))return{x:0,y:0};if(e.w<=l.size)return{x:0,y:0};let b=(e.w-l.size)/2,x=r((_,B)=>B===_?0:B>_?b:-b,"getCoordinate");return{x:x(e.center.x,R.x),y:x(e.center.y,R.y)}},"offsetEmanationOrigin");for(let R=-pe;R<pe;R++)for(let b=-fe;b<fe;b++){let[x,_]=canvas.grid.grid.getPixelsFromGridPosition(p+R,k+b),B={x:x+l.size*.5,y:_+l.size*.5};if(B.x<0||B.y<0)continue;let It=at(B),lt={x:S.x+P.x+It.x,y:S.y+P.y+It.y};if(t==="cone"){let Et=new Ray(lt,B),En=(360+Et.angle/(Math.PI/180)%360)%360;if(Et.distance>0&&!D(C,h,En))continue}if(Fn(B,lt)>ct)continue;canvas.ready&&CONFIG.Canvas.polygonBackends[s].testCollision(c??lt,B,{type:s,mode:"any"})?(a.grid.highlightGridPosition(f,{x,y:_,border:1,color:0}),f.beginFill(0,.5).moveTo(x,_).lineTo(x+l.size,_+l.size).endFill()):a.grid.highlightGridPosition(f,{x,y:_,border:n.border,color:n.fill})}}r(zt,"highlightGrid");var Mn={burst:"circle",emanation:"circle",line:"ray",cone:"cone",rect:"rect"};function qe({type:t,token:e,distance:n}){mt(e)&&(n??=t==="cone"?30:15,Ae({type:t,distance:n,traits:["concentrate","secret"],flags:{type:"seek",tokenId:e.id,collisionType:"sight",collisionOrigin:e.center}}))}r(qe,"createSeekTemplate");function Ht({type:t="burst",distance:e=20,conceal:n=!1}={}){Ae({type:t,distance:e,fillColor:ut,flags:{type:"darkness",conceal:n}})}r(Ht,"createDarknessTemplate");function Bt({type:t="burst",distance:e=20}={}){Ae({type:t,distance:e,fillColor:dt,flags:{type:"mist"}})}r(Bt,"createMistTemplate");function Wt(t,e){return e&&!mt(e)?null:canvas.scene.templates.filter(n=>w(n,"type")===t)??[]}r(Wt,"getTemplates");function ke(t){return Wt("darkness",t)}r(ke,"getDarknessTemplates");function Qe(t){return Wt("mist",t)}r(Qe,"getMistTemplates");function Xe(t){if(!mt(t))return null;let e=canvas.scene.templates.find(n=>w(n,"type")==="seek");return e?(t=t instanceof Token?t.document:t,Q(e,{collisionType:"sight",collisionOrigin:t.center})):null}r(Xe,"getSeekTemplateTokens");async function K(t){let e=t.scene.templates.filter(n=>w(n,"type")==="seek"&&w(n,"tokenId")===t.id);for(let n of e)await n.delete()}r(K,"deleteSeekTemplate");function mt(t){return canvas.scene===t.scene?!0:(ui.notifications.error(m("template.scene")),!1)}r(mt,"checkScene");function Ae({type:t,distance:e,traits:n,fillColor:o,width:s,flags:i}){let c={distance:e,t:Mn[t],fillColor:o||game.user.color,flags:{[g]:i}};c.t==="ray"?c.width=s||CONFIG.MeasuredTemplate.defaults.width*(canvas.dimensions?.distance??1):c.t==="cone"&&(c.angle=CONFIG.MeasuredTemplate.defaults.angle),n&&setProperty(c,"flags.pf2e.origin.traits",n);let a=new CONFIG.MeasuredTemplate.documentClass(c,{parent:canvas.scene});new CONFIG.MeasuredTemplate.objectClass(a).drawPreview()}r(Ae,"createTemplate");function Q(t,{collisionOrigin:e,collisionType:n="move"}={}){if(t=t instanceof MeasuredTemplateDocument?t.object:t,!canvas.scene)return[];let{grid:o,dimensions:s}=canvas;if(!(o&&s))return[];let i=o.getHighlightLayer(t.highlightId);if(!i||o.type!==CONST.GRID_TYPES.SQUARE)return[];let c=e??t.center,a=canvas.tokens.quadtree.getObjects(i.getLocalBounds(void 0,!0)),l=[];for(let u of a){let d=u.document,f=[];for(let v=0;v<d.height;v++){let y=u.y+v*o.size;if(f.push(`${u.x}.${y}`),d.width>1)for(let p=1;p<d.width;p++)f.push(`${u.x+p*o.size}.${y}`)}for(let v of f){if(!i.positions.has(v))continue;let[y,p]=v.split(".").map(h=>Number(h)),k={x:y+s.size*.5,y:p+s.size*.5};if(k.x<0||k.y<0)continue;if(!(canvas.ready&&n&&CONFIG.Canvas.polygonBackends[n].testCollision(c,k,{type:n,mode:"any"}))){l.push(u);break}}}return l}r(Q,"getTemplateTokens");function Yt(){if(!["circle","cone"].includes(this.type)||canvas.grid.type!==CONST.GRID_TYPES.SQUARE)return MeasuredTemplate.prototype.highlightGrid.call(this);if(!this.isVisible){canvas.grid.getHighlightLayer(this.highlightId)?.clear();return}let t=w(this.document,"collisionType"),e=w(this.document,"collisionOrigin");zt({areaType:this.type==="circle"?"burst":"cone",object:this,document:this.document,colors:{border:this.borderColor,fill:this.fillColor},preview:!0,collisionType:t,collisionOrigin:e})}r(Yt,"highlightTemplateGrid");function Kt(t){let{slug:e,castLevel:n=0}=t.getFlag("pf2e","origin")??{};Lt.includes(e)?t.updateSource({fillColor:ut,[`flags.${g}`]:{type:"darkness",conceal:n>=4}}):Ft.includes(e)&&t.updateSource({fillColor:dt,[`flags.${g}`]:{type:"mist"}})}r(Kt,"preCreateMeasuredTemplate");function Ze(t){w(t,"type")==="darkness"&&canvas.perception.update({initializeVision:!0})}r(Ze,"onMeasuredTemplate");function qt(t,e){!Pt()||!t.object.actor?.isOfType("creature")||(e.find(".col.left").append('<div class="control-icon" data-action="pf2e-perception"><i class="fa-solid fa-eye"></i></div>'),e.find("[data-action=pf2e-perception]").on("click",n=>Ie.openMenu({token:t.object})))}r(qt,"renderTokenHUD");function Qt(t,e){for(let n of e)delete n.flags?.[g]}r(Qt,"pasteToken");function A(t,...e){return e.unshift("data"),t=t instanceof Token?t.document:t,w(t,e.join("."))}r(A,"getTokenData");async function Xt(t){return t=t instanceof Token?t.document:t,$t(t,"data")}r(Xt,"clearTokenData");async function Be(t,e){let n=M(t).map(s=>s.id),o={};for(let s in e){if(!n.includes(s)){o[`flags.${g}.data.-=${s}`]=!0;continue}let i=e[s],c=A(t,s)??{};if(i.visibility===F.visibility&&delete i.visibility,i.cover===F.cover&&delete i.cover,!(c.cover===i.cover&&c.visibility===i.visibility))if(!i.visibility&&!i.cover)o[`flags.${g}.data.-=${s}`]=!0;else for(let a of["cover","visibility"])c[a]!==i[a]&&(i[a]?o[`flags.${g}.data.${s}.${a}`]=i[a]:o[`flags.${g}.data.${s}.-=${a}`]=!0)}return t=t instanceof Token?t.document:t,t.update(o)}r(Be,"setTokenData");function ht(t,e,n=!1){let o=t.scene;if(!ye(o,"standard"))return!1;n&&se();let s=E("standard-type");return s==="center"?Ee(t.center,e.center,n):s==="points"?Ye(t.center,e,n):!1}r(ht,"hasStandardCover");var re={tiny:0,sm:1,med:2,lg:3,huge:4,grg:5};function yt(t,e,n=[],o=!1){let s=E("lesser");if(s==="none")return;t=t instanceof Token?t.document:t,e=e instanceof Token?e.document:e,n=oe(n);let i=[...n.target?.cover?.ignore??[],...n.origin?.cover?.ignore??[]],c,a=t.center,l=e.center;o&&(se(),H(a,l));let u=r(h=>{let S=re[h.actor.size];return S-d>=2&&S-f>=2},"isExtraLarge"),d=re[t.actor.size],f=re[e.actor.size],v=t.scene.tokens.contents.filter(h=>h.actor&&!h.hidden&&h!==t&&h!==e&&!i.includes(h.id)).sort((h,S)=>re[S.actor.size]-re[h.actor.size]),y=d<re.huge&&f<re.huge&&v.filter(u).length,p=s==="ten"?.1:s==="twenty"?.2:0,k=r(h=>(o&&H(h.A,h.B,"red"),lineSegmentIntersects(a,l,h.A,h.B)),"intersectsEdge"),C=s==="cross"?h=>k(h.top)&&k(h.bottom)||k(h.left)&&k(h.right):h=>Object.values(h).some(S=>k(S));for(let h of v){let S=h.object,D=We(S.bounds,p);if(C(D))return y?"standard":"lesser";u(h)&&y--}return c}r(yt,"getCreatureCover");function be(t,e){t=t instanceof Token?t:t.object,e=e instanceof Token?e:e.object;let n=(()=>{let p=t.actor,k=["unnoticed","undetected","hidden","concealed"];for(let C of k)if(p.hasCondition(C))return C})(),o=A(t,e.id,"visibility"),s=T[n]>T[o]?n:o;if(T[s]>=T.hidden)return s;let i=e.actor,c=i?.hasLowLightVision,a=i?.hasDarkvision;if(i&&tt(i))return s;let u,d=ke(t);if(d?.length){let p;for(let k of d){let C=Q(k);if(!C.length)continue;if(C.includes(t)||C.includes(e))u=!0;else continue;if(!a)return"hidden";w(k,"conceal")&&(p="concealed")}if(p==="concealed"&&(s="concealed"),u&&s==="concealed")return s}let f=Qe(t);if(f?.length)for(let p of f){let k=Q(p);if(!k.length)continue;if(k.includes(t)||k.includes(e))return"concealed"}if(u)return s;let v=Ke(t),y=v==="dim"?"concealed":v===null?"hidden":void 0;return(y==="concealed"&&c||y==="hidden"&&a)&&(y=void 0),T[s]>T[y]?s:y}r(be,"getVisibility");function Zt(t,e,n,o){let s=e.flags?.["pf2e-perception"];if(s&&(s.data||s["-=data"]!==void 0)){if(t.object.renderFlags.set({refreshVisibility:!0}),game.user.isGM)return;let i=Hooks.on("refreshToken",c=>{!t.object!==c&&(Hooks.off("refreshToken",i),game.combat?.getCombatantByToken(t.id)&&ui.combat.render())})}}r(Zt,"updateToken");function Jt(t,e){e?Je(t):ce(t)}r(Jt,"hoverToken");function en(t){ce(t),game.user.isGM||ui.combat.render()}r(en,"deleteToken");function tn(t){ce(t),Hooks.once("sightRefresh",()=>t.hover&&Je(t))}r(tn,"controlToken");function ce(t){if(!t?.id)return $(".pf2e-conditionals").remove();$(`.pf2e-conditionals[data-hover-id=${t.id}]`).remove(),$(`.pf2e-conditionals[data-token-id=${t.id}]`).remove()}r(ce,"clearConditionals");function Je(t){let e=M(t);for(let n of e)vt(n,t)}r(Je,"showAllConditionals");async function vt(t,e){if(t=t instanceof Token?t:t.object,!t.visible||!t.actor?.isOfType("creature"))return;let n=A(t,e.id);if(isEmpty(n))return;if(!game.user.isGM&&!e.document.hasPlayerOwner&&T[n.visibility]>=T.hidden){if(!n.cover)return;n={cover:n.cover}}let o=t.worldTransform.a,s=canvas.clientCoordinatesFromCanvas(t.document._source),i=`<div class="pf2e-conditionals" data-hover-id="${t.id}" data-token-id="${e.id}" `;i+=`style="top: ${s.y}px; left: ${s.x+t.hitArea.width*o/2}px;">`;let c=E("icon-path");Object.entries(n).map(([a,l])=>{let u=a==="cover"?"cover":l,d=c[u]||Ne[u];(d.startsWith("systems")||d.startsWith("modules"))&&(d=`../../../${d}`),i+=`<div class="conditional"><img src="${d}"></img></div>`}),i+="</div>",$(document.body).append(i)}r(vt,"showConditionals");function et(t,e,n,o=!1){let i=n.includes("item:ranged")?j(e.actor):!1,c=X(e.actor,!0);if(i&&I[c]>I.lesser)return"greater-prone";!i&&c==="greater-prone"&&(c=void 0);let a=A(e,t.id,"cover");return i&&I[a]>I.lesser||(!i&&a==="greater-prone"&&(a=void 0),I[a]<I.standard&&I[c]<I.standard&&ht(t,e,o)?a="standard":!a&&!c&&t.distanceTo(e)>5&&(a=yt(t,e,n,o)),i&&I[a]>I.lesser)?"greater-prone":I[a]>I[c]?a:void 0}r(et,"getConditionalCover");function nn(){return!!(this.sight.enabled&&this.actor?.isOfType("creature")&&this.scene?.rulesBasedVision)}r(nn,"rulesBasedVision");function on(t){ye(t.scene,"npc-vision")&&t.actor?.isOfType("npc")&&t.updateSource({"sight.enabled":!0})}r(on,"preCreateToken");async function sn(t){let[e,n]=canvas.ready&&!t.viewOnly?[canvas.tokens.controlled.find(b=>b.actor===this)??this.getActiveTokens().shift()??null,t.target?.token??t.target?.actor?.getActiveTokens().shift()??null]:[null,null],o=this.getRollOptions(t.domains??[]),s=await gt({affects:"origin",origin:this,target:t.target?.actor??n?.actor??null,item:t.item??null,domains:t.domains,options:[...t.options,...t.item?.getRollOptions("item")??[]]}),i=t.viewOnly||!n?.actor?this:this.getContextualClone([...o,...n.actor.getSelfRollOptions("target")],s),c=t.statistic instanceof game.pf2e.StatisticModifier,a=c?i.system.actions?.flatMap(b=>[b,b.altUsages??[]].flat())??[]:[],l=t.viewOnly?t.statistic:c?a.find(b=>t.item?.id!==b.item.id||t?.item.name!==b.item.name?!1:t.item.isOfType("melee")&&b.item.isOfType("melee")?!0:t.item.isOfType("weapon")&&b.item.isOfType("weapon")&&t.item.isMelee===b.item.isMelee)??t.statistic:t.statistic,u=(()=>{if(i===this)return t.item??null;if(l&&"item"in l&&l.item instanceof Item&&l.item.isOfType("melee","spell","weapon"))return l.item;let b=i.items.get(t.item?.id??"");return b?.isOfType("melee","spell","weapon")?b:t.item??null})(),d=u?.getRollOptions("item")??[],v=[["attack","strike-damage","attack-spell-damage"].some(b=>t.domains.includes(b))?"attack":[],c&&u?.isOfType("weapon")&&u.baseType==="alchemical-bomb"?"manipulate":[]].flat();if(u?.isOfType("weapon","melee"))for(let b of this.synthetics.strikeAdjustments)b.adjustTraits?.(u,v);let y=v.map(b=>Nt(b,CONFIG.PF2E.actionTraits)),p=e&&n?e.distanceTo(n):null,[k,C]=typeof p=="number"?[`origin:distance:${p}`,`target:distance:${p}`]:[null,null],h=r(b=>{let x=b?.getSelfRollOptions("target")??[];if(n){x.push("target");let _=this.synthetics.targetMarks.get(n.document.uuid);_&&x.push(`target:mark:${_}`)}return x},"getTargetRollOptions"),S=h(n?.actor),D=await gt({affects:"target",origin:i,target:n?.actor??null,item:u,domains:t.domains,options:[...t.options,...d,...S]}),[P,J]=t.item?.isOfType("melee")?[t.item.reach,t.item.isMelee]:t.item?.isOfType("weapon")?[this.getReach({action:"attack",weapon:t.item}),t.item.isMelee]:[null,!1];if(e&&n&&Pn({selfToken:e,targetToken:n,ephemeralEffects:D,options:[...t.options,...i.getSelfRollOptions("origin"),...d,...S]}),!!(J&&typeof P=="number"&&t.statistic instanceof game.pf2e.StatisticModifier&&n&&e?.isFlanking(n,{reach:P}))&&t.target?.token?.actor&&Gt(t.target.token.actor)){let b=game.i18n.localize("PF2E.Item.Condition.Flanked"),x=game.pf2e.ConditionManager.getCondition("flat-footed",{name:b});D.push(x.toObject())}let ee=t.viewOnly?null:(t.target?.actor??n?.actor)?.getContextualClone([...i.getSelfRollOptions("origin"),...d,...k?[k]:[]],D)??null,fe=new Set([...t.options,...o,...ee?h(ee):S,...d,"attack"]);C&&fe.add(C);let pe=u?Vt(u,p):null;pe&&fe.add(`target:range-increment:${pe}`);let at={actor:i,token:e?.document??null,statistic:l,item:u,modifiers:[]},R=ee&&n&&p!==null?{actor:ee,token:n.document,distance:p,rangeIncrement:pe}:null;return{options:fe,self:at,target:R,traits:y}}r(sn,"getRollContext");function Pn({ephemeralEffects:t,selfToken:e,targetToken:n,options:o}){let s=et(e,n,o),i=be(e,n);o=oe(o),s=Oe(s,o,"cover"),i=Oe(i,o,"visibility");let c;if(s){let a=xe(o,s,"ac")?.[0];a=He(a),a===0?s=void 0:a&&(c=a)}i&&Ue(i,o,"visibility","noff")&&(i=void 0),I[s]>I.none&&t.push(he(s,c)),T[i]>T.concealed&&t.push(_t(i))}r(Pn,"addConditionals");function ae(t,e=!1){if(!t)return;let n=t.id,o=t.isToken;return(e?game.user.targets:canvas.tokens.controlled).find(i=>o?i.actor===t:i.actor.id===n)??t.getActiveTokens().shift()??null}r(ae,"getActorToken");function j(t){return t.itemTypes.condition.some(e=>e.slug==="prone")}r(j,"isProne");function X(t,e=!1){let n=t.itemTypes.effect.find(o=>o.sourceId===ge);return e?Ge(n)?.selection.level:n}r(X,"getCoverEffect");function rn(){let t=this.system.traits.senses.value,e=cn(t),n=this.rules.filter(o=>o.key==="Sense").map(o=>o.selector.toLowerCase());return e.push(...n),this.getCondition("blinded")?Ce.BLINDED:e.includes("darkvision")||e.includes("greaterdarkvision")?Ce.DARKVISION:e.includes("lowlightvision")?Ce.LOWLIGHT:Ce.NORMAL}r(rn,"visionLevel");function tt(t){let e=t.system.traits.senses.value;return Array.isArray(e)?e.some(n=>n.type==="greaterDarkvision"):typeof e=="object"?(e=cn(e.value),e.includes("greaterdarkvision")):!1}r(tt,"hasGreaterDarkvision");function cn(t){return t.toLowerCase().replaceAll(/[ -]/g,"").split(",")}r(cn,"splitNPCSenses");var nt={LOWER_BY_TWO:-2,LOWER:-1,INCREASE:1,INCREASE_BY_TWO:2,TO_CRITICAL_FAILURE:"criticalFailure",TO_FAILURE:"failure",TO_SUCCESS:"success",TO_CRITICAL_SUCCESS:"criticalSuccess"},an=["criticalFailure","failure","success","criticalSuccess"],it,ln,Te,ot,le,De,st,un,Z=class{constructor(e,n,o=null){te(this,it);te(this,Te);te(this,le);te(this,st);e instanceof Roll?(this.dieResult=(e.isDeterministic?e.terms.find(s=>s instanceof NumericTerm):e.dice.find(s=>s instanceof Die&&s.faces===20))?.total??1,this.rollTotal=e.total):(this.dieResult=e.dieValue,this.rollTotal=e.dieValue+e.modifier),this.dc=typeof n=="number"?{value:n}:n,this.unadjusted=V(this,st,un).call(this),this.adjustment=V(this,it,ln).call(this,this.unadjusted,o),this.value=this.adjustment?V(this,Te,ot).call(this,this.adjustment.amount,this.unadjusted):this.unadjusted}},L=Z;r(L,"DegreeOfSuccess"),it=new WeakSet,ln=r(function(e,n){if(!n)return null;for(let o of["all",...an]){let{label:s,amount:i}=n[o]??{};if(i&&s&&!(e===Z.CRITICAL_SUCCESS&&i===nt.INCREASE)&&!(e===Z.CRITICAL_FAILURE&&i===nt.LOWER)&&(o==="all"||an.indexOf(o)===e))return{label:s,amount:i}}return null},"#getDegreeAdjustment"),Te=new WeakSet,ot=r(function(e,n){switch(e){case"criticalFailure":return 0;case"failure":return 1;case"success":return 2;case"criticalSuccess":return 3;default:return Math.clamped(n+e,0,3)}},"#adjustDegreeOfSuccess"),le=new WeakSet,De=r(function(e){return this.dieResult===20?V(this,Te,ot).call(this,nt.INCREASE,e):this.dieResult===1?V(this,Te,ot).call(this,nt.LOWER,e):e},"#adjustDegreeByDieValue"),st=new WeakSet,un=r(function(){let e=this.dc.value;return this.rollTotal-e>=10?V(this,le,De).call(this,Z.CRITICAL_SUCCESS):e-this.rollTotal>=10?V(this,le,De).call(this,Z.CRITICAL_FAILURE):this.rollTotal>=e?V(this,le,De).call(this,Z.SUCCESS):V(this,le,De).call(this,Z.FAILURE)},"#calculateDegreeOfSuccess"),Se(L,"CRITICAL_FAILURE",0),Se(L,"FAILURE",1),Se(L,"SUCCESS",2),Se(L,"CRITICAL_SUCCESS",3);var Re=class extends U{static async openMenu(e,n){let o=await super.openMenu(e,n);return o&&e.message&&dn(e.message),o}get title(){return m("menu.validation.title",{name:this.token.name})}get template(){return Y("validation")}get selected(){let e=super.selected;return e.length?e:this.globalSelection}get globalSelection(){let e=this.token,n=e.actor.alliance;return M(e).filter(o=>o.actor.alliance!==n).map(o=>o.id)}getSavedData(e=!0){let n=super.getSavedData();return e?this._convertData(n):n}_convertData(e){let n=this.property,o=this.scene,s=this.selected,i=F[n],c=n==="cover"?W:ne;for(let a of s){let l=o.tokens.get(a),u=`${a}.${n}`,d=getProperty(e,u)??i,f=this.processValue({token:l,value:d});c.includes(f)||(f=d),d!==f&&setProperty(e,u,f)}return e}processValue(e){throw new Error(`${this.constructor.name} doesn't have a 'processValue' method defined`)}getData(e){let{covers:n,visibilities:o,i18n:s}=super.getData(e),i=this.currentData,c=this.getSavedData(!1),a=this.property,l=this.selected,u=M(this.token);u=u.map(({id:f,name:v,actor:y})=>{let p=i[f]??{},k=c[f]??{};return{id:f,name:v,alliance:y.alliance,selected:l.includes(f),...U.createPropertyData(k,p,a)}});let d=E("validation");return d==="selected"?u=u.filter(f=>f.selected):d==="changed"&&(u=u.filter(f=>f.changed)),{...this._spliIntoAlliances(u),i18n:s,property:a,options:a==="cover"?n:o,showSelected:l.length!==u.length&&d==="all",showChanges:d!=="changed"}}activateListeners(e){super.activateListeners(e),e.find("[data-action=cancel]").on("click",n=>{this.close()})}};r(Re,"ValidationMenu");var we=class extends Re{#e;constructor(e,n={}){super(e,n),this.#e=e.value}get property(){return"cover"}processValue(){return this.#e}};r(we,"CoverValidationMenu");var ue=class extends Re{#e;constructor(e,n={}){super(e,n),this.#e=e.roll}get property(){return"visibility"}get roll(){return this.#e}};r(ue,"VisibilityValidationMenu");var Le=class extends ue{processValue({token:e,value:n}){let o=this.roll,s=e.actor.perception.dc.value,i=T[n],c=new L(o,s).value;return c>=L.SUCCESS&&i<T.hidden?"hidden":c<=L.FAILURE&&i>=T.hidden?"observed":n}};r(Le,"HideValidationMenu");var Fe=class extends ue{get selected(){return M(this.token).map(e=>e.id)}processValue({token:e,value:n}){return T[n]>=T.hidden?"observed":n}};r(Fe,"UnHideValidationMenu");var $e=class extends ue{#e;constructor(e,n={}){super(e,n),this.#e=e.originator}get selected(){let e=this.token,n=e.actor.alliance,o=this.#e.id,s=A(e)??{};return M(e).filter(i=>{if(i.id===o||i.actor.alliance===n)return!1;let c=getProperty(s,`${i.id}.visibility`);return T[c]>=T.undetected}).map(i=>i.id)}processValue({token:e,value:n}){return T[n]>=T.undetected?"hidden":n}};r($e,"PointOutValidationMenu");var rt=class extends ue{getSavedData(e=!0){let n=this.token.id,o=M(this.token),s={};for(let i of o){let c=A(i,n);c&&(s[i.id]=deepClone(c))}return e?this._convertData(s):s}getData(){let e=super.getData();return e.isReversed=!0,e.options=ne.map(n=>({value:n,label:m(`visibility.reversed.${n}`)})),e}_saveData(e){let n=this.scene,o=this.token.id,s=[];for(let[i,c]of Object.entries(e)){let a={_id:i},l=n.tokens.get(i);if(l){c.visibility===F.visibility&&delete c.visibility;let u=A(l,o);if(u?.visibility===c.visibility)continue;!u.cover&&!c.visibility?a[`flags.${g}.data.-=${o}`]=!0:c.visibility?a[`flags.${g}.data.${o}.visibility`]=c.visibility:a[`flags.${g}.data.${o}.-=visibility`]=!0}else a[`flags.${g}.data.-=${o}`]=!0;s.push(a)}n.updateEmbeddedDocuments("Token",s)}};r(rt,"ReverseVisibilityValidationMenu");var Me=class extends rt{#e;constructor(e,n={}){super(e,n),this.#e=e.fromTemplate}get globalSelection(){return this.#e?[]:super.globalSelection}static async openMenu(e,n){await super.openMenu(e,n)&&K(e.token)}processValue({token:e,value:n}){let o=this.roll,s=e.actor.skills.stealth.dc.value,i=T[n],c=new L(o,s).value;return c>=L.CRITICAL_SUCCESS&&i>=T.hidden||c>=L.SUCCESS&&i===T.hidden?"observed":c>=L.SUCCESS&&i>=T.undetected?"hidden":n}};r(Me,"SeekValidationMenu");function Tt(t,e){let n=t.token;if(!n)return;let o=game.user.isGM,s=n.hasPlayerOwner,{cover:i,selected:c,skipWait:a,validated:l,pointOut:u}=Mt(t),d=t.getFlag("pf2e","context");if(i){if(o){let f=bt({property:"cover",skipWait:a,validated:l});e.find(".message-content").append(f),e.find("[data-action=validate-cover]").on("click",()=>{we.openMenu({token:n,selected:c,value:i,message:t})})}else if(!a){let f=kt("cover",l);e.find(".message-content").append(f)}}else if(d?.pf2ePerception?.visibility){l||e.find(".message-buttons").remove();let f=e.find(".flavor-text");!o&&s&&(e.find(".message-sender").text(n.name),f.empty());let v=m(`message.flat-check.${l===void 0?"blind":l?"success":"failure"}`),y=gn(v,l);if(f.append(y),o)for(let p of["success","failure"])f.append(St({action:`${p}-message`,icon:"fa-solid fa-message",label:m("message.flat-check.button",p)})),e.find(`[data-action=${p}-message]`).on("click",()=>{ft(t,"validated",p==="success")})}else if(d?.type==="skill-check"&&d.pf2ePerception)if(o){if(d.options.includes("action:hide")){let f=bt({property:"visibility",skipWait:a,validated:l});e.find(".flavor-text").append(f),e.find("[data-action=validate-visibility]").on("click",()=>{Le.openMenu({token:n,message:t,roll:t.rolls[0],selected:d.pf2ePerception.selected})})}}else s&&d.options.includes("action:hide")&&pn({token:n,message:t,html:e,validated:l});else if(d?.type==="perception-check"&&d.pf2ePerception)if(o){if(d.options.includes("action:seek")){let f=fn({skipWait:a,validated:l,smallAction:"delete-template",smallIcon:"fa-thin fa-cubes",smallSlashed:!0});e.find(".flavor-text").append(f),e.find("[data-action=validate-visibility]").on("click",()=>{Me.openMenu({token:n,message:t,roll:t.rolls[0],selected:d.pf2ePerception.selected,fromTemplate:d.pf2ePerception.fromTemplate})}),e.find("[data-action=delete-template").on("click",()=>{K(n)})}}else s&&d.options.includes("action:seek")&&pn({token:n,message:t,html:e,validated:l});else if(u){let f=n.scene.tokens.get(u);if(!f)return;if(o){let v=fn({skipWait:a,validated:l,smallAction:"ping-token",smallIcon:"fa-solid fa-signal-stream"});e.find(".message-content").append(v),e.find("[data-action=validate-visibility]").on("click",()=>{$e.openMenu({message:t,token:f,originator:n,selected:canvas.tokens.controlled.map(y=>y.id)})}),e.find("[data-action=ping-token]").on("click",()=>{canvas.ping(f.center)})}else if(s){let v=kt("visibility",l);e.find(".message-content").append(v)}}if(o&&me.includes(d?.type)){let v=`<span style="position: absolute; right: 0px; bottom: 1px;">
    <button data-action="unhide" title="${m("message.unhide.tooltip")}" style="width: 22px; height: 22px; font-size: 10px; line-height: 1px;">
        <i class="fa-duotone fa-eye-slash" style="right: 1px;"></i>
    </button>
</span>`;e.find(".dice-result .dice-total").append(v),e.find("[data-action=unhide]").on("click",y=>{y.stopPropagation(),Fe.openMenu({token:n})})}}r(Tt,"renderChatMessage");function dn(t){w(t,"validated")||ft(t,"validated",!0)}r(dn,"validateMessage");function fn({skipWait:t,validated:e,smallIcon:n,smallAction:o,smallSlashed:s}){let i='<div style="display: grid; grid-template-columns: 1fr auto; gap: 3px">';return i+=bt({property:"visibility",skipWait:t,validated:e}),i+=St({action:o,icon:n,slashed:s,tooltip:m(`message.visibility.small-button.${o}`)}),i+="</div>",i}r(fn,"createValidateCombo");function pn({html:t,token:e,message:n,validated:o}){t.find(".message-sender").text(e.name);let s=n.getFlag("pf2e","modifierName");s+=kt("visibility",o),t.find(".flavor-text").html(s)}r(pn,"addBlindSkillCheckFlavor");function kt(t,e){let n=m(`message.${t}.player.${e?"validated":"wait"}`);return gn(n,e)}r(kt,"createWaitHint");function gn(t,e){return e===!0?t='<i class="fa-solid fa-check" style="color: green;"></i> '+t:e===!1&&(t='<i class="fa-solid fa-xmark" style="color: red;"></i> '+t),`<i style="display: block; font-size: .9em; text-align: end;">${t}</i>`}r(gn,"createHint");function bt({skipWait:t,validated:e,property:n}){let o=m(`message.${n}.gm.${t?"check":e?"validated":"validate"}`);return!t&&e&&(o+='<i class="fa-solid fa-check" style="color: green; margin-left: 0.3em;"></i>'),St({action:`validate-${n}`,icon:"fa-solid fa-list",label:o})}r(bt,"createValidateButton");function St({action:t,icon:e,label:n,tooltip:o,slashed:s=!1}){let i=`<button type="button" style="margin: 0 0 5px; padding-block: 0; position: relative;" data-action="${t}" title="${o}">`;return e&&(i+=`<i class="${e}" ${n?"":'style="margin: 0;"'}></i>`,s&&(i+='<i class="fa-solid fa-slash-forward" style="position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); font-size: 1.2em;"></i>')),n&&(i+=`${e?" ":""}${n}`),i+="</button>",i}r(St,"createChatButton");async function Ct({content:t,token:e,flags:n,secret:o}){let s={content:t,speaker:ChatMessage.getSpeaker({token:e instanceof Token?e.document:e})};return n&&setProperty(s,`flags.${g}`,n),o&&(s.type=CONST.CHAT_MESSAGE_TYPES.WHISPER,s.whisper=ChatMessage.getWhisperRecipients("gm")),ChatMessage.create(s)}r(Ct,"createTokenMessage");function hn(){let t=game.pf2e.actions.get("hide"),e=ve(t,2).constructor,n=ve(t.toActionVariant(),2).constructor,o=ve(t,1).constructor,s=ve(t.toActionVariant(),1).constructor;zn(e,n),jn(o,s),Un(o,s),Vn(o,s),_n(e,n)}r(hn,"setupActions");function _n(t,e){class n extends e{async use(i={}){let c=m("action.point-out"),a=Pe(i,c);a&&Nn(this,a)}}r(n,"PointOutVariant");class o extends t{constructor(){super({cost:1,name:`${g}.action.point-out`,description:`${g}.action.point-out.description`,rollOptions:["action:point-out"],slug:"point-out",traits:["auditory","manipulate","visual"]})}toActionVariant(i={}){return i.name??=this.name,new n(this,i)}}r(o,"PointOut"),game.pf2e.actions.set("point-out",new o)}r(_n,"setupPointOut");async function Nn({name:t,traits:e},n){let o=game.user.targets.filter(u=>u.actor).first(),s=o?A(o,n.id,"visibility"):void 0,i=o&&T[s]<T.undetected,c;if(i){let u=o.actor.skills.stealth.dc.value;c=m("message.point-out.short-check",{check:`@Check[type:perception|dc:${u}|traits:auditory,manipulate,visual|showDC:gm]`})}else c=m("message.point-out.short");let a=await renderTemplate(Y("point-out"),{description:c,name:t,traits:e.map(u=>({slug:u,tooltip:CONFIG.PF2E.traitsDescriptions[u],name:CONFIG.PF2E.actionTraits[u]}))}),l={pointOut:i?o.id:void 0};Ct({content:a,token:n,flags:l})}r(Nn,"pointOut");function Vn(t,e){class n extends e{async use(i={}){let c=game.i18n.localize("PF2E.Actions.Seek.Title"),a=Pe(i,c);if(a)return await Gn(a)?(i.actors=[a.actor],super.use(i)):K(a)}}r(n,"SeekVariant");class o extends t{constructor(){super({cost:1,description:"PF2E.Actions.Seek.Description",name:"PF2E.Actions.Seek.Title",notes:[{outcome:["criticalSuccess"],text:"PF2E.Actions.Seek.Notes.criticalSuccess"},{outcome:["success"],text:"PF2E.Actions.Seek.Notes.success"}],rollOptions:["action:seek"],slug:"seek",statistic:"perception",traits:["concentrate","secret"]})}toActionVariant(i){return new n(this,i)}}r(o,"Seek"),game.pf2e.actions.set("seek",new o)}r(Vn,"setupSeek");async function Gn(t){let e=game.i18n.localize("PF2E.Foot"),n='<p style="margin: 0 0.3em; text-align: center;">';return n+=`${m("dialog.seek.hint")}</p><p>`,n+=mn("create-cone","fa-thin fa-cubes",game.i18n.format("PF2E.TemplateLabel",{size:30,unit:e,shape:game.i18n.localize(CONFIG.PF2E.areaTypes.cone)})),n+=mn("create-burst","fa-thin fa-cubes",game.i18n.format("PF2E.TemplateLabel",{size:15,unit:e,shape:game.i18n.localize(CONFIG.PF2E.areaTypes.burst)})),n+="</p>",Dialog.wait({title:`${t.name} - ${game.i18n.localize("PF2E.Actions.Seek.Title")}`,content:n,buttons:{ok:{icon:'<i class="fa-solid fa-check"></i>',label:m("dialog.seek.accept"),callback:()=>!0},no:{icon:'<i class="fa-solid fa-xmark"></i>',label:m("dialog.seek.cancel"),callback:o=>!1}},close:()=>!1,render:o=>{o.filter(".dialog-content").find("[data-action=create-cone], [data-action=create-burst]").on("click",i=>{let{action:c}=i.currentTarget.dataset;K(t),qe({type:c==="create-cone"?"cone":"burst",token:t})})}},{width:300,left:10})}r(Gn,"seek");function Un(t,e){class n extends e{async use(i={}){let c=game.i18n.localize("PF2E.Actions.Sneak.Title"),a=Pe(i,c);if(a)return i.actors=[a.actor],super.use(i)}}r(n,"SneakVariant");class o extends t{constructor(){super({cost:1,description:"PF2E.Actions.Sneak.Description",name:"PF2E.Actions.Sneak.Title",notes:[{outcome:["success","criticalSuccess"],text:"PF2E.Actions.Sneak.Notes.success"},{outcome:["failure"],text:"PF2E.Actions.Sneak.Notes.failure"},{outcome:["criticalFailure"],text:"PF2E.Actions.Sneak.Notes.criticalFailure"}],rollOptions:["action:sneak"],slug:"sneak",traits:["move","secret"]})}toActionVariant(i){return new n(this,i)}}r(o,"Sneak")}r(Un,"setupSneak");function jn(t,e){class n extends e{async use(i={}){let c=game.i18n.localize("PF2E.Actions.Hide.Title"),a=Pe(i,c);if(a)return i.actors=[a.actor],super.use(i)}}r(n,"HideVariant");class o extends t{constructor(){super({cost:1,description:"PF2E.Actions.Hide.Description",name:"PF2E.Actions.Hide.Title",rollOptions:["action:hide"],slug:"hide",statistic:"stealth",traits:["secret"],notes:[{outcome:["success","criticalSuccess"],text:"PF2E.Actions.Hide.Notes.success"}]})}toActionVariant(i){return new n(this,i)}}r(o,"Hide"),game.pf2e.actions.set("hide",new o)}r(jn,"setupHide");function zn(t,e){class n extends e{async use(i={}){let c=m("action.take-cover"),a=Pe(i,c);a&&Hn(a)}}r(n,"TakeCoverVariant");class o extends t{constructor(){super({cost:1,description:"PF2E.Actions.TakeCover.Description",img:"systems/pf2e/icons/conditions-2/status_acup.webp",name:"PF2E.Actions.TakeCover.Title",slug:"take-cover"})}toActionVariant(i){return new n(this,i)}}r(o,"TakeCover"),game.pf2e.actions.set("take-cover",new o)}r(zn,"setupCover");async function Hn(t){let e=t.actor,n=X(e),o=q(t,game.user.targets.ids);if(n&&!o.length)return n.delete();let s=A(t)??{},i=Object.entries(s).reduce((l,[u,{cover:d}])=>(d&&(l[u]=d),l),{}),c=await renderTemplate(Y("covers-dialog"),{i18n:m,hasTargets:!!o.length,hasCovers:!isEmpty(i),hasTargetCover:o.some(l=>l in i),isProne:j(e)}),a=new Dialog({title:`${t.name} - ${m("action.take-cover")}`,content:c,buttons:{},render:l=>{l.find("button").on("click",async u=>{let{level:d}=u.currentTarget.dataset,f=E("skip-cover"),v=r(async(y,p)=>{p=p?o:void 0;let k=y===F.cover?p?"remove":"remove-all":"take",C=await Ct({content:m(`message.cover.${k}`,{cover:m(`cover.${y}`)}),flags:{selected:p,cover:y,skipWait:f},token:t});if(f){if(y===F.cover&&!p)return Xt(t);let h=deepClone(A(t))??{};for(let S of o)setProperty(h,`${S}.cover`,y);return Be(t,h)}},"process");if(d==="remove-all")v(F.cover);else if(d==="remove")v(F.cover,!0);else if(o.length)v(d,!0);else{let y=he(d);e.createEmbeddedDocuments("Item",[y])}a.close()})}}).render(!0)}r(Hn,"takeCover");function Pe(t,e){let n=t.tokens?.filter(i=>i.actor)??[];Array.isArray(n)||(n=[n]);let o=t.actors??[];if(Array.isArray(o)||(o=[o]),!n.length&&o.length===1&&(n=[ae(o[0])].filter(Boolean)),n.length||(n=canvas.tokens.controlled.filter(i=>i.actor)),n.length||(n=[ae(game.user.character)].filter(Boolean)),n.length>1){ui.notifications.warn(m("action.only-one",{action:e}));return}else if(!n.length){ui.notifications.warn(m("action.must-one",{action:e}));return}let s=n[0];if(!s?.actor?.isOfType("creature")){ui.notifications.warn(m("action.must-creature",{action:e}));return}return s}r(Pe,"getSelectedToken");function mn(t,e,n){return`<button type="button" data-action="${t}" style="margin: 0 0 5px; padding: 0;">
    <i class="${e}"></i> ${n}</button>
</button>`}r(mn,"createButton");function yn(t,e,n){return t(e,n)?!xt(n)||!de(n,"basicSight")&&!Ot(n):!1}r(yn,"basicSightCanDetect");function vn(t,e,n){return t(e,n)?game.settings.get("pf2e","automation.rulesBasedVision")?!e.object.actor?.hasCondition("deafened")&&xt(n)&&!de(n,"hearing"):!0:!1}r(vn,"hearingCanDetect");function kn(t,e,n){return t(e,n)?xt(n)&&!de(n,"feelTremor"):!1}r(kn,"feelTremorCanDetect");function xt(t){return!!(t instanceof Token&&t.actor)}r(xt,"isValidTarget");function bn(t,e,n){for(let o of e){let s=A(t,o.id,"visibility");if(T[s]>=n)return!0}return!1}r(bn,"reachesThreshold");function de(t,e,n=!1){let s=(game.user.isGM?canvas.tokens.controlled:t.scene.tokens.filter(c=>c.isOwner)).filter(c=>c.detectionModes.some(a=>a.id===e)),i=n?T.unnoticed:T.undetected;return bn(t,s,i)}r(de,"isUndetected");function Ot(t){let e=canvas.tokens.controlled;if(!game.user.isGM&&!e.length&&(e=t.scene.tokens.filter(s=>s.isOwner),e.length!==1))return!1;if(bn(t,e,T.hidden))return!0;let o=ke(t);if(!o||(e=e.filter(s=>!s.actor.hasDarkvision),!e.length))return!1;for(let s of o){let i=Q(s);if(i.length){if(i.includes(t))return!0;for(let c of e)if(i.includes(c))return!0}}return!1}r(Ot,"isHidden");var Tn={geometry:{clearDebug:se,getRectEdges:We,lineIntersectWall:Ee,pointToTokenIntersectWall:Ye},token:{getCreatureCover:yt,getVisibility:be,clearConditionals:ce,showConditionals:vt,showAllConditionals:Je,hasStandardCover:ht,getTokenData:A,getConditionalCover:et},lighting:{getLightExposure:Ke},actor:{getActorToken:ae,isProne:j,getCoverEffect:X,hasGreaterDarkvision:tt},scene:{getValidTokens:M,validateTokens:q,getSceneSetting:ye},detection:{isUndetected:de,isHidden:Ot},template:{createSeekTemplate:qe,createDarknessTemplate:Ht,createMistTemplate:Bt,getDarknessTemplates:ke,getMistTemplates:Qe,getSeekTemplateTokens:Xe,deleteSeekTemplate:K,createTemplate:Ae,getTemplateTokens:Q}};async function Sn(t,...e){let n=e[1];if(!n)return t(...e);Array.isArray(n.options)&&(n.options=new Set(n.options));let{actor:o,createMessage:s="true",type:i,token:c,target:a,isReroll:l}=n,u=c??ae(o),d=a?.token,f=me.includes(i),v=E("flat-check");if(l||!s||!u||!wt.includes(i)||f&&(!d||v==="none"))return t(...e);if(f&&d.actor){let y=oe(n.options),p=Oe(be(d,u),y,"visibility");if(!p)return t(...e);let k=xe(y,p==="concealed"?"concealed":"hidden","dc")?.[0];if(k=He(k),k===0)return t(...e);let C=k??(p==="concealed"?5:11),h=T[p]>=T.undetected,D=(await new u.actor.perception.constructor(u.actor,{slug:"visibility-check",label:`${game.i18n.localize("PF2E.FlatCheck")}: ${game.i18n.localize(`PF2E.condition.${p}.name`)}`,check:{type:"flat-check"}}).roll({dc:C,target:d.actor,rollMode:h?game.user.isGM?"gmroll":"blindroll":"roll"})).degreeOfSuccess>1;if(h&&(n.options.add("secret"),n.pf2ePerception={isSuccess:D,visibility:p}),v!=="roll"&&!h&&!D)return}else if(n.options.has("action:hide"))setProperty(n,"pf2ePerception.selected",game.user.targets.ids);else if(n.options.has("action:seek")){let y=Xe(u),p=y??Array.from(game.user.targets),k=q(u,p).filter(C=>!C.document.hidden).map(C=>C.id);setProperty(n,"pf2ePerception.selected",k),setProperty(n,"pf2ePerception.fromTemplate",!!y)}return t(...e)}r(Sn,"checkRoll");function Cn(t,e){let{createMessage:n="true",type:o,token:s,target:i,isReroll:c,options:a,dc:l}=t.context,u=s,d=i?.token,f=i?.actor;if(c||!n||!u||!d||!f||!me.includes(o))return;let v=X(f),y=v?Ge(v)?.selection.level??w(v,"level"):void 0,p=t[g]?.coverOverride??y,k='<div class="roll-mode-panel">';k+=`<div class="label">${m("dice-checks.cover.label")}</div>`,k+=`<select name="overrideCover"><option value="">${m("dice-checks.cover.none")}</option>`,(j(f)?W.slice(1):W.slice(1,-1)).forEach(h=>{let S=h===p?"selected":"",D=m(`cover.${h}`);k+=`<option value="${h}" ${S}>${D}</option>`}),k+="</select></div>",k+="<hr>",e.find(".roll-mode-panel").before(k),e.find("select[name=overrideCover]").on("change",h=>{let S=h.currentTarget.value||void 0;setProperty(t,`${g}.coverOverride`,S),p=S}),e.find("button.roll")[0].addEventListener("click",h=>{h.preventDefault(),h.stopPropagation(),h.stopImmediatePropagation();let S=!1,D=deepClone(f._source.items);if(p!==y){S=!0;let P=D.findIndex(J=>getProperty(J,"flags.core.sourceId")===ge);if(P!==-1&&D.splice(P,1),p){let J=he(p);D.push(J)}}if(S&&(i.actor=f.clone({items:D},{keepId:!0}),l?.slug)){let P=i.actor.getStatistic(l.slug)?.dc;P&&(l.value=P.value,l.statistic=P)}t.resolve(!0),t.isResolved=!0,t.close()},!0),t.setPosition()}r(Cn,"renderCheckModifiersDialog");function xn(t,e){E("target")&&Wn(e),Bn(e)}r(xn,"renderCombatTracker");function Bn(t){if(!canvas.ready)return;let e=game.combats.viewed?.combatants;e?.size&&t.find("#combat-tracker .combatant").each((n,o)=>{let{combatantId:s}=o.dataset,i=e.get(s??"")?.token;i&&de(i,"basicSight",!0)&&o.remove()})}r(Bn,"hideUndetected");function Wn(t){t.find("[data-control=toggleTarget]").each((e,n)=>{n.addEventListener("click",o=>{o.preventDefault(),o.stopPropagation(),o.stopImmediatePropagation();let{combatantId:s}=o.currentTarget.closest(".combatant").dataset,c=game.combats.viewed.combatants.get(s??"")?.token;if(!c)return;let a=Array.from(game.user.targets).some(l=>l.document===c);c.object.setTarget(!a,{releaseOthers:!o.shiftKey})},!0)})}r(Wn,"setupToggleTarget");function On(t,e){let n=E("encounter");e.find(".form-group").last().after(`<div class="form-group">
    <label>${m("settings.encounter.name")}</label>
    <input type="checkbox" name="pf2e-perception.encounter" ${n?"checked":""}>
    <p class="notes">${m("settings.encounter.short")}</p>
</div>`),e.find('input[name="pf2e-perception.encounter"]').on("change",o=>{let s=o.currentTarget.checked;Ve("encounter",s)})}r(On,"renderCombatTrackerConfig");var Yn=["cover","concealed","hidden","undetected","unnoticed"],_e=class extends FormApplication{static get defaultOptions(){return foundry.utils.mergeObject(super.defaultOptions,{template:Y("icon-path-menu"),title:m("settings.icon-path.name"),width:500})}getData(){let e=E("icon-path");return{icons:Yn.map(o=>({name:o,placeholder:Ne[o],value:e[o]??"",label:o==="cover"?m("icon-path.cover"):game.i18n.localize(CONFIG.PF2E.conditionTypes[o])})),i18n:m}}activateListeners(e){super.activateListeners(e),e.find("button[name=cancel]").on("click",n=>{n.prefentDefault(),this.close()})}async _updateObject(e,n){Ve("icon-path",n)}};r(_e,"IconPathMenu");function In(){N("icon-path",Object,{},{config:!1}),game.settings.registerMenu(g,"icon-path-menu",{name:O("icon-path","name"),label:O("icon-path","label"),icon:"fa-solid fa-list",restricted:!0,type:_e}),N("permission",String,CONST.USER_ROLES.GAMEMASTER,{choices:{1:O("permission","choices.1"),2:O("permission","choices.2"),3:O("permission","choices.3"),4:O("permission","choices.4")}}),N("npc-vision",Boolean,!1),N("target",Boolean,!0,{onChange:()=>ui.combat?.render()}),N("lesser",String,"ten",{choices:{none:O("lesser","choices.none"),cross:O("lesser","choices.cross"),zero:O("lesser","choices.zero"),ten:O("lesser","choices.ten"),twenty:O("lesser","choices.twenty")}}),N("standard",Boolean,!0),N("standard-type",String,"center",{choices:{center:O("standard-type","choices.center"),points:O("standard-type","choices.points")}}),N("skip-cover",Boolean,!0),N("validation",String,"all",{choices:{all:O("validation","choices.all"),selected:O("validation","choices.selected"),changed:O("validation","choices.changed")}}),N("flat-check",String,"cancel",{choices:{none:O("flat-check","choices.none"),roll:O("flat-check","choices.roll"),cancel:O("flat-check","choices.cancel")}}),N("encounter",Boolean,!1)}r(In,"registerSettings");function O(t,e){return`${g}.settings.${t}.${e}`}r(O,"path");function N(t,e,n,o={}){game.settings.register(g,t,{name:O(t,"name"),hint:O(t,"hint"),scope:"world",config:!0,type:e,default:n,...o})}r(N,"register");var Kn="game.pf2e.Check.roll",qn="CONFIG.Token.documentClass.prototype.rulesBasedVision",Qn="CONFIG.MeasuredTemplate.objectClass.prototype.highlightGrid",Xn="CONFIG.Actor.documentClass.prototype.getRollContext",Zn="CONFIG.PF2E.Actor.documentClasses.npc.prototype.visionLevel",Jn="CONFIG.Canvas.detectionModes.basicSight._canDetect",eo="CONFIG.Canvas.detectionModes.hearing._canDetect",to="CONFIG.Canvas.detectionModes.feelTremor._canDetect";Hooks.once("init",()=>{In(),hn(),libWrapper.register(g,Kn,Sn),libWrapper.register(g,Qn,Yt,"OVERRIDE"),libWrapper.register(g,qn,nn,"OVERRIDE"),libWrapper.register(g,Xn,sn,"OVERRIDE"),libWrapper.register(g,Zn,rn,"OVERRIDE"),libWrapper.register(g,Jn,yn),libWrapper.register(g,eo,vn),libWrapper.register(g,to,kn),game.data.users.find(e=>e._id===game.data.userId).role>=CONST.USER_ROLES.GAMEMASTER?(Hooks.on("renderSceneConfig",Ut),Hooks.on("renderCombatTrackerConfig",On)):Hooks.on("renderCombatTracker",xn)});Hooks.once("ready",()=>{game.modules.get(g).api=Tn,Hooks.on("renderChatMessage",Tt);for(let t of document.querySelectorAll("#chat-log .chat-message")){let e=game.messages.get(t.dataset.messageId);e&&Tt(e,$(t))}game.user.isGM&&game.modules.get("pf2e-rules-based-npc-vision")?.active&&ui.notifications.error(`${g}.warning.npc-vision`,{permanent:!0,localize:!0})});Hooks.on("hoverToken",Jt);Hooks.on("pasteToken",Qt);Hooks.on("updateToken",Zt);Hooks.on("deleteToken",en);Hooks.on("controlToken",tn);Hooks.on("renderTokenHUD",qt);Hooks.on("preCreateToken",on);Hooks.on("canvasPan",()=>ce());Hooks.on("renderCheckModifiersDialog",Cn);Hooks.on("preCreateMeasuredTemplate",Kt);Hooks.on("createMeasuredTemplate",Ze);Hooks.on("updateMeasuredTemplate",Ze);Hooks.on("deleteMeasuredTemplate",Ze);})();
//# sourceMappingURL=main.js.map
