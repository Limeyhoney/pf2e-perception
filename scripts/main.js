(()=>{var It=Object.defineProperty;var Rn=(t,e,n)=>e in t?It(t,e,{enumerable:!0,configurable:!0,writable:!0,value:n}):t[e]=n;var r=(t,e)=>It(t,"name",{value:e,configurable:!0});var xe=(t,e,n)=>(Rn(t,typeof e!="symbol"?e+"":e,n),n),Et=(t,e,n)=>{if(!e.has(t))throw TypeError("Cannot "+n)};var At=(t,e,n)=>(Et(t,e,"read from private field"),n?n.call(t):e.get(t)),ie=(t,e,n)=>{if(e.has(t))throw TypeError("Cannot add the same private member more than once");e instanceof WeakSet?e.add(t):e.set(t,n)};var U=(t,e,n)=>(Et(t,e,"access private method"),n);var he="Compendium.pf2e.other-effects.Item.I9lfZUiCwMiGogVi",S={[void 0]:0,observed:0,concealed:1,hidden:2,undetected:3,unnoticed:4},oe=["observed","concealed","hidden","undetected","unnoticed"],q=["none","lesser","standard","greater","greater-prone"],A={[void 0]:0,none:0,lesser:1,standard:2,greater:3,"greater-prone":4},V={cover:"none",visibility:"observed"},me=["attack-roll","spell-attack-roll"],Dt=[...me,"skill-check","perception-check"],Ne={cover:"modules/pf2e-perception/images/cover.webp",concealed:"systems/pf2e/icons/conditions/concealed.webp",hidden:"systems/pf2e/icons/conditions/hidden.webp",undetected:"systems/pf2e/icons/conditions/undetected.webp",unnoticed:"systems/pf2e/icons/conditions/unnoticed.webp"},Oe={BLINDED:0,NORMAL:1,LOWLIGHT:2,DARKVISION:3},ut="#000000",dt="#656665",Rt="#809e71",$t=["darkness","dance-of-darkness","ravenous-darkness"],wt=["obscuring-mist","stinking-cloud"];var m="pf2e-perception";function Y(t){return`modules/${m}/templates/${t}.hbs`}r(Y,"templatePath");function v(...t){let e=t.at(-1),n=typeof e=="object",i=n?t.slice(0,-1):t;return i.unshift(m),game.i18n[n?"format":"localize"](i.join("."),e)}r(v,"localize");function F(t,e){return t.getFlag(m,e)}r(F,"getFlag");function ft(t,e,n){return t.setFlag(m,e,n)}r(ft,"setFlag");function Ft(t,e){return t.unsetFlag(m,e,!0)}r(Ft,"unsetFlag");function Pt(t){return getProperty(t,`flags.${m}`)??{}}r(Pt,"getFlags");function D(t){return game.settings.get(m,t)}r(D,"getSetting");function je(t,e){return game.settings.set(m,t,e)}r(je,"setSetting");function Lt(){return game.user.role>=D("permission")}r(Lt,"hasPermission");function Mt(t){let e=game.i18n.localize(`PF2E.condition.${t}.name`);return game.pf2e.ConditionManager.getCondition("flat-footed",{name:e}).toObject()}r(Mt,"createFlatFootedSource");function ye(t,e){return e??=A[t]===3?4:A[t],{_id:"I9lfZUiCwMiGogVi",img:"systems/pf2e/icons/conditions-2/status_acup.webp",name:v("cover",t),system:{description:{gm:"",value:"<p>When you're behind an obstacle that could block weapons, guard you against explosions, and make you harder to detect, you're behind cover. Standard cover gives you a +2 circumstance bonus to AC, to Reflex saves against area effects, and to Stealth checks to Hide, Sneak, or otherwise avoid detection. You can increase this to greater cover using the Take Cover basic action, increasing the circumstance bonus to +4. If cover is especially light, typically when it's provided by a creature, you have lesser cover, which grants a +1 circumstance bonus to AC. A creature with standard cover or greater cover can attempt to use Stealth to Hide, but lesser cover isn't sufficient.</p>"},rules:[{domain:"all",key:"RollOption",option:`self:cover-bonus:${e}`},{domain:"all",key:"RollOption",option:`self:cover-level:${t}`},{key:"FlatModifier",predicate:[{or:[{and:["self:condition:prone","item:ranged"]},{not:"self:cover-level:greater-prone"}]}],selector:"ac",type:"circumstance",value:e},{key:"FlatModifier",predicate:["area-effect",{not:"self:cover-level:greater-prone"}],selector:"reflex",type:"circumstance",value:e},{key:"FlatModifier",predicate:[{or:["action:hide","action:sneak","avoid-detection"]},{not:"self:cover-level:greater-prone"}],selector:"stealth",type:"circumstance",value:e},{key:"FlatModifier",predicate:["action:avoid-notice",{not:"self:cover-level:greater-prone"}],selector:"initiative",type:"circumstance",value:e}],slug:"effect-cover"},type:"effect",flags:{core:{sourceId:he},[m]:{level:t,bonus:e}}}}r(ye,"createCoverSource");function Ge(t,e=void 0){if(t)return t.system.rules.find(n=>n.key==="ChoiceSet"&&(!e||n.flag===e))}r(Ge,"findChoiceSetRule");var z=class extends Array{constructor(...e){super(...Array.isArray(e[0])?e[0]:e),this.isValid=z.isValid(this)}static isValid(e){return this.isArray(e)}static isArray(e){return super.isArray(e)&&e.every(n=>se.isStatement(n))}static test(e=[],n){return e instanceof z?e.test(n):new z(...e).test(n)}test(e){if(this.length===0)return!0;if(!this.isValid)return console.warn("PF2e System | The provided predicate set is malformed."),!1;let n=e instanceof Set?e:new Set(e);return this.every(i=>this.#e(i,n))}toObject(){return deepClone([...this])}clone(){return new z(this.toObject())}#e(e,n){return typeof e=="string"&&n.has(e)||se.isBinaryOp(e)&&this.#n(e,n)||se.isCompound(e)&&this.#t(e,n)}#n(e,n){if("eq"in e)return n.has(`${e.eq[0]}:${e.eq[1]}`);{let i=Object.keys(e)[0],[s,o]=Object.values(e)[0],c=Array.from(n),u=r(d=>{let f=Number(d);if(!Number.isNaN(f))return[f];let y=new RegExp(String.raw`^${d}:([^:]+)$`);return c.map(p=>Number(y.exec(p)?.[1]||NaN)).filter(p=>!Number.isNaN(p))},"getValues"),a=u(s),l=u(o);switch(i){case"gt":return a.some(d=>l.every(f=>d>f));case"gte":return a.some(d=>l.every(f=>d>=f));case"lt":return a.some(d=>l.every(f=>d<f));case"lte":return a.some(d=>l.every(f=>d<=f));default:return console.warn("PF2e System | Malformed binary operation encountered"),!1}}}#t(e,n){return"and"in e&&e.and.every(i=>this.#e(i,n))||"nand"in e&&!e.nand.every(i=>this.#e(i,n))||"or"in e&&e.or.some(i=>this.#e(i,n))||"xor"in e&&e.xor.filter(i=>this.#e(i,n)).length===1||"nor"in e&&!e.nor.some(i=>this.#e(i,n))||"not"in e&&!this.#e(e.not,n)||"if"in e&&!(this.#e(e.if,n)&&!this.#e(e.then,n))}};r(z,"PredicatePF2e");var Ue,se=class{static isStatement(e){return e instanceof Object?this.isCompound(e)||this.isBinaryOp(e):typeof e=="string"?this.isAtomic(e):!1}static isAtomic(e){return typeof e=="string"&&e.length>0||this.isBinaryOp(e)}static isBinaryOp(e){if(!pt(e))return!1;let n=Object.entries(e);if(n.length>1)return!1;let[i,s]=n[0];return At(this,Ue).has(i)&&Array.isArray(s)&&s.length===2&&typeof s[0]=="string"&&["string","number"].includes(typeof s[1])}static isCompound(e){return pt(e)&&(this.isAnd(e)||this.isOr(e)||this.isNand(e)||this.isXor(e)||this.isNor(e)||this.isNot(e)||this.isIf(e))}static isAnd(e){return Object.keys(e).length===1&&Array.isArray(e.and)&&e.and.every(n=>this.isStatement(n))}static isNand(e){return Object.keys(e).length===1&&Array.isArray(e.nand)&&e.nand.every(n=>this.isStatement(n))}static isOr(e){return Object.keys(e).length===1&&Array.isArray(e.or)&&e.or.every(n=>this.isStatement(n))}static isXor(e){return Object.keys(e).length===1&&Array.isArray(e.xor)&&e.xor.every(n=>this.isStatement(n))}static isNor(e){return Object.keys(e).length===1&&Array.isArray(e.nor)&&e.nor.every(n=>this.isStatement(n))}static isNot(e){return Object.keys(e).length===1&&!!e.not&&this.isStatement(e.not)}static isIf(e){return Object.keys(e).length===2&&this.isStatement(e.if)&&this.isStatement(e.then)}};r(se,"StatementValidator"),Ue=new WeakMap,ie(se,Ue,new Set(["eq","gt","gte","lt","lte"]));async function gt({affects:t,origin:e,target:n,item:i,domains:s,options:o}){if(!(e&&n))return[];let[c,u]=t==="target"?[e,n]:[n,e],a=[...o,...u.getSelfRollOptions(t)],l=i?i.isOfType("spell")?{spell:i}:{weapon:i}:{};return(await Promise.all(s.flatMap(d=>c.synthetics.ephemeralEffects[d]?.[t]??[]).map(d=>d({test:a,resolvables:l})))).flatMap(d=>d??[])}r(gt,"extractEphemeralEffects");function Vt(t,e){let n={name:t,label:game.i18n.localize(e[t]??t)};return $n(CONFIG.PF2E.traitsDescriptions,t)&&(n.description=CONFIG.PF2E.traitsDescriptions[t]),n}r(Vt,"traitSlugToObject");function $n(t,e){return(typeof e=="string"||typeof e=="number")&&e in t}r($n,"objectHasKey");function _t(t,e){return t.isOfType("spell")?null:t.rangeIncrement&&typeof e=="number"?Math.max(Math.ceil(e/t.rangeIncrement),1):null}r(_t,"getRangeIncrement");function Nt(t){if(!t.isOfType("creature"))return!1;let{flanking:e}=t.attributes;if(!e.flankable)return!1;let n=t.getRollOptions();return typeof e.flatFootable=="number"?!z.test([{lte:["origin:level",e.flatFootable]}],n):e.flatFootable}r(Nt,"isOffGuardFromFlanking");function pt(t){return typeof t=="object"&&t!==null}r(pt,"isObject");var ve={cover:{cancel:{targets:["lesser","standard","greater","greater-prone"]},set:{targets:["none","lesser","standard","greater","greater-prone"],value:["none","lesser","standard","greater","greater-prone"]},reduce:{targets:["lesser","standard","greater","greater-prone"]},ignore:{targets:"string"},ac:{targets:["lesser","standard","greater","greater-prone"],value:"number"}},visibility:{cancel:{targets:["concealed","hidden","undetected","unnoticed"]},set:{targets:["observed","concealed","hidden","undetected","unnoticed"],value:["observed","concealed","hidden","undetected","unnoticed"]},reduce:{targets:["concealed","hidden","undetected","unnoticed"]},noff:{targets:["hidden","undetected","unnoticed"]},noinvis:{},dc:{targets:["concealed","hidden"],value:"number"}}},wn={cover:Object.keys(ve.cover),visibility:Object.keys(ve.visibility),all:[...Object.keys(ve.cover),...Object.keys(ve.visibility)]};function jt(){let t=game.pf2e.RuleElements.builtin.RollOption.defineSchema(),e=t.predicate.constructor,n=t.value.constructor;class i extends game.pf2e.RuleElement{constructor(o,c){typeof o.targets=="string"&&(o.targets=[o.targets]),super({priority:CONST.ACTIVE_EFFECT_MODES.CUSTOM,...o},c);let u=wn[o.type];if(!u)return;if(!u?.includes(o.selector)){this.failValidation(`The type "${o.type}" only accepts the following selectors: ${u.join(", ")}.`);return}let a=ve[o.type]?.[o.selector];if(!a)return;let l=r(p=>{let{name:h,uuid:T}=this.item;console.warn(`PF2e System | PF2ePerception rules element on item ${h} (${T}) simple warning: ${p}`)},"selectorWarn"),d=Array.isArray(a.targets)?[...a.targets,"all"]:a.targets,f=Array.isArray(d)?d.join(", "):null;if(!d&&o.targets?.length){l(`The selector "${o.selector}" doesn't accept any targets property.`);return}if(o.selector==="ignore"&&!o.targets?.length){let p=`The selector "${o.selector}" requires a targets property with the id of a token on the scene.`;this.failValidation(p);return}if(f&&o.targets?.some(p=>!d.includes(p))){let p=`The targets property of selector "${o.selector}" only accepts the following: ${f}.`;this.failValidation(p);return}else if(!f&&d&&o.targets?.some(p=>typeof p!==d)){let p=`The targets property of selector "${o.selector}" needs to be of type "${d}".`;this.failValidation(p);return}let y=a.value;if(!y&&a.value){l(`The selector "${o.selector}" doesn't accept any value property.`);return}y&&typeof o.value!==y&&this.failValidation(`The selector "${o.selector}" only accept a value property of type ${y}.`)}static defineSchema(){let{fields:o}=foundry.data;return{...super.defineSchema(),type:new o.StringField({required:!0,nullable:!1,blank:!1,choices:["visibility","cover"]}),affects:new o.StringField({required:!0,nullable:!1,blank:!1,initial:"self",choices:["self","other"]}),selector:new o.StringField({required:!0,nullable:!1,blank:!1}),targets:new o.ArrayField(new o.StringField({required:!0,nullable:!1,blank:!1,initial:void 0}),{required:!0,nullable:!1,initial:["all"]}),predicate:new e({required:!1,nullable:!1}),value:new n({required:!1,initial:void 0})}}test(o,c){return c?super.test(o):!1}addToPerception(o,c,u){if(!this.test(u,!0))return;let l=`${this.affects==="self"?o:o==="origin"?"target":"origin"}.${this.type}.${this.selector}`,d=ve[this.type][this.selector];if(!d.targets){setProperty(c,l,!0);return}let f=this.targets.includes("all")?d.targets:this.targets;if(!d.value){for(let y of f){let p=`${l}.${y}`;setProperty(c,p,!0)}return}for(let y of f){let p=`${l}.${y}`,h=getProperty(c,p);h?h.add(this.value):h=new Set([this.value]),setProperty(c,p,h)}}}r(i,"PF2ePerceptionRuleElement"),game.pf2e.RuleElements.custom.PF2ePerception=i}r(jt,"setupRuleElement");function X(t,e,{distance:n,extraOptions:i=[]}={}){if(!t.actor||!e.actor)return{};let s={origin:t.actor?.rules.filter(l=>!l.ignored&&l.key==="PF2ePerception")??[],target:e.actor?.rules.filter(l=>!l.ignored&&l.key==="PF2ePerception")??[]};if(!s.origin.length&&!s.target.length)return{};let o={origin:t.actor.getRollOptions(),target:e.actor.getRollOptions()},c={origin:e.actor.getSelfRollOptions("target"),target:t.actor.getSelfRollOptions("origin")};t=t instanceof Token?t:t.object,e=e instanceof Token?e:e.object,n??=t.distanceTo(e);let u=[`origin:distance:${n}`,`target:distance:${n}`],a={};for(let l of["origin","target"]){let d=[...i,...o[l],...c[l],...u];for(let f of s[l])f.addToPerception(l,a,d)}return a}r(X,"perceptionRules");function j(t,e,n,i,s){let o=t[e]?.[n]?.[i];return s?o?.[s]:o}r(j,"getPerception");function ke(t,e,n,i){let s=n==="cover"?q:oe;if(i&&j(t,e,n,"cancel",i))return;let o=j(t,e,n,"set",i)?.first();if(o&&s.includes(o))i=o;else if(i&&j(t,e,n,"reduce",i)){let c=s.indexOf(i);i=s[Math.max(0,c-1)]}return i===s[0]?void 0:i}r(ke,"updateFromPerceptionRules");function Gt(t,e){let n="",i=["standard","npc-vision"];for(let o of i){let c=be(t.object,o);n+=`<div class="form-group pf2e-perception-injected">
    <label>${v(`settings.${o}.name`)}</label>
    <input type="checkbox" name="flags.pf2e-perception.${o}" ${c?"checked":""}>
    <p class="notes">${v(`settings.${o}.short`)}</p>
</div>`}n+="<hr>",e.find('.tab[data-tab="basic"] hr').first().after(n);let s=e.find(".pf2e-perception-injected").toArray().reduce((o,c)=>(o+=c.clientHeight,o),0);t.setPosition({top:t.position.top-s/2})}r(Gt,"renderSceneConfig");function _(t){if(t=t instanceof Token?t.document:t,!(t instanceof TokenDocument))return[];let e=t.scene.tokens.filter(n=>n!==t&&n.actor?.isOfType("creature"));if(D("encounter")){let n=game.combats.active;return n?e.filter(i=>{let s=i.actor,o=s.traits;return s.type==="familiar"||o.has("minion")||o.has("eidolon")||n.getCombatantByToken(i.id)}):e}return e}r(_,"getValidTokens");function Z(t,e){let n=_(t).map(i=>i.id);return e.filter(i=>{let s=i instanceof Token||i instanceof TokenDocument?i.id:i;return n.includes(s)})}r(Z,"validateTokens");function be(t,e){return F(t,e)??D(e)}r(be,"getSceneSetting");function Te(t,e=1){let n=Object.getPrototypeOf(t);return e>1?Te(n,e-1):n}r(Te,"getPrototype");function ze(t,e){return t.name.localeCompare(e.name)}r(ze,"sortByName");function Be(t){return t=Number(t),isNaN(t)?void 0:t}r(Be,"asNumberOnly");var B=class extends Application{#e;#n;#t;#i;#o;constructor({token:e,resolve:n,selected:i=[]},s={}){super(s),this.#e=e,this.#n=n,this.#t=i,this.#o=(o,c)=>{let u=o.id,a=this.element.find("[data-token-id]");a.removeClass("hover"),c&&a.filter(`[data-token-id=${u}]`).addClass("hover")},Hooks.on("hoverToken",this.#o)}async close(e={}){Hooks.off("hoverToken",this.#o),this.#n?.(e.resolve??!1),super.close(e)}static get defaultOptions(){return mergeObject(super.defaultOptions,{minimizable:!1})}static async openMenu(e,n={}){if(e.token instanceof TokenDocument&&(e.token=e.token.object),!e.token){ui.notifications.error(v("menu.no-token"));return}n.id=`${m}-${e.token.document.uuid}`;let i=Object.values(ui.windows).find(s=>s.id===n.id);return i&&i.close(),new Promise(s=>{e.resolve=s,new this(e,n).render(!0)})}static createPropertyData(e,n,i){let s=V[i],o=e[i]??s,c=n[i]??s;return{original:o,current:c,changed:o!==c,custom:c!==s,originalCustom:o!==s}}get token(){return this.#e}get document(){return this.#e.document}get actor(){return this.#e.actor}get scene(){return this.#e.scene}get selected(){return this.#t.length?Z(this.token,this.#t):[]}get currentData(){return deepClone(this.#s)}get#s(){return this.#i||(this.#i=this.getSavedData()),this.#i}getSavedData(){let e=P(this.document)??{};return deepClone(e)}reset(){this.#i=this.getSavedData(),this.#t=[],this.render()}isSelected(e){let n=typeof e=="object"?e.id:e;return this.#t.includes(n)}getData(e){return{i18n:v,covers:q.map(n=>({value:n,label:v(`cover.${n}`)})),visibilities:oe.map(n=>({value:n,label:v(`visibility.${n}`)}))}}activateListeners(e){e.find("[data-token-id]").on("mouseenter",n=>{let{tokenId:i}=n.currentTarget.dataset,s=this.scene.tokens.get(i)?.object;!s||s.controlled||s._onHoverIn(n,{hoverOutOthers:!0})}),e.find("[data-action=close]").on("click",()=>{this.close({resolve:!0})}),e.find("select[name=visibility], select[name=cover]").on("change",n=>{let i=n.currentTarget,s=i.name,o=V[s],c=i.value||o,u=i.closest(".token")?.dataset.tokenId,a=u?[u]:this.#t;for(let l of a)setProperty(this.#s,`${l}.${s}`,c);u?(i.classList.toggle("changed",c!==i.dataset.original),i.classList.toggle("custom",c!==o)):this.render()}),e.find("[data-action=accept]").on("click",n=>{this._saveData(this.#s),this.close({resolve:!0})})}_saveData(e){He(this.document,e)}_setSelected(e){this.#t=e??this.element.find("[data-token-id].ui-selected").toArray().map(n=>n.dataset.tokenId)}_spliIntoAlliances(e){let n=[],i=[],s=[],o=this.actor.alliance,c=o==="party"?"opposition":o==="opposition"?"party":null;for(let u of e)if(c){let a=u.actor?u.actor.alliance:u.alliance;a===o?n.push(u):a===c?i.push(u):a===null&&s.push(u)}else s.push(u);return{allies:n.sort(ze),neutral:s.sort(ze),enemies:i.sort(ze),hasTokens:n.length||i.length||s.length}}};r(B,"BaseMenu");var Ie=class extends B{get title(){return v("menu.perception.title",{name:this.token.name})}get template(){return Y("perception")}getData(e){let n=this.selected,i=this.currentData,s=this.getSavedData(),o=_(this.token).map(({id:c,name:u,actor:a})=>{let l=i[c]??{},d=s[c]??{};return{id:c,name:u,alliance:a.alliance,cover:B.createPropertyData(d,l,"cover"),visibility:B.createPropertyData(d,l,"visibility"),selected:n.includes(c)}});return{...super.getData(e),...this._spliIntoAlliances(o)}}activateListeners(e){super.activateListeners(e),e.filter(".tokens").selectable({autoRefresh:!1,filter:".token",cancel:"header,select",stop:()=>this._setSelected()}),e.find("[data-action=select-all]").on("click",n=>{let i=$(n.currentTarget).closest("section"),s=(i.length?i:e).find("[data-token-id]"),o=s.filter(":not(.ui-selected)").length===0;s.toggleClass("ui-selected",!o),this._setSelected()}),e.find("[data-action=use-selection]").on("click",n=>{this._setSelected(canvas.tokens.controlled.map(i=>i.id)),this.render()}),e.find("[data-action=reset]").on("click",n=>this.reset())}};r(Ie,"PerceptionMenu");var Fn=[{x:0,y:0},{x:1,y:0},{x:0,y:1},{x:1,y:1}],Pn=[{x:.25,y:.25},{x:.5,y:.25},{x:.75,y:.25},{x:.25,y:.5},{x:.5,y:.5},{x:.75,y:.5},{x:.25,y:.75},{x:.5,y:.75},{x:.75,y:.75}];function We(t,e){let n=1-e;return{top:{A:H({x:e,y:e},t),B:H({x:n,y:e},t)},right:{A:H({x:n,y:e},t),B:H({x:n,y:n},t)},bottom:{A:H({x:n,y:n},t),B:H({x:e,y:n},t)},left:{A:H({x:e,y:n},t),B:H({x:e,y:e},t)}}}r(We,"getRectEdges");function Ee(t,e,n=!1){return n&&W(t,e),CONFIG.Canvas.polygonBackends.move.testCollision(t,e,{type:"move",mode:"any"})}r(Ee,"lineIntersectWall");function qe(t,e,n=!1){for(let i of Ln(e.bounds))if(Ee(t,i,n))return!0;return!1}r(qe,"pointToTokenIntersectWall");function H(t,e){return{x:e.x+e.width*t.x,y:e.y+e.height*t.y}}r(H,"getRectPoint");function re(){canvas.controls.debug.clear()}r(re,"clearDebug");function W(t,e,n="blue"){let i=n==="blue"?26316:n==="red"?16711680:1483011;canvas.controls.debug.lineStyle(4,i).moveTo(t.x,t.y).lineTo(e.x,e.y)}r(W,"drawDebugLine");function*Ln(t){for(let e of Pn)yield H(e,t)}r(Ln,"rectSpread");function*Ut(t){for(let e of Fn)yield H(e,t)}r(Ut,"rectCorners");function Ye(t,e=!1){if(t=t instanceof Token?t:t.object,t.document.hasStatusEffect(CONFIG.specialStatusEffects.INVISIBLE))return;let n=t.scene;if(n!==canvas.scene||!n.tokenVision||n.darkness<n.globalLightThreshold)return;e&&re();let i=t.document.bounds,s=null;for(let o of canvas.effects.lightSources){if(!o.active)continue;let c=o.data.bright,u=o.data.dim;if(o.object===t){if(c)return"bright";u&&(s="dim");continue}let a=[];for(let l of Ut(i))o.shape.contains(l.x,l.y)?a.push(l):e&&W(o,l,"red");if(a.length){if(o.ratio===1)return e&&W(o,a,"green"),"bright";if(o.ratio===0){e&&W(o,a,"blue"),s="dim";continue}for(let l of a)if(new Ray(o,l).distance<=c)if(e)W(o,l,"green"),s="bright";else return"bright";else e?(W(o,l,"blue"),s!=="bright"&&(s="dim")):s="dim"}}return s}r(Ye,"getLightExposure");function Mn(t,e){return canvas.dimensions?canvas.grid.type!==CONST.GRID_TYPES.SQUARE?canvas.grid.measureDistance(t,e):Vn(new Ray(t,e)):NaN}r(Mn,"measureDistance");function Vn(t,{reach:e=null}={}){if(!canvas.dimensions)return NaN;let n=canvas.dimensions.size,i=canvas.dimensions.distance,s=Math.ceil(Math.abs(t.dx/n)),o=Math.ceil(Math.abs(t.dy/n)),c=Math.ceil(Math.abs((t.dz||0)/n)),u=[s,o,c].sort((f,y)=>f-y),a={doubleDiagonal:u[0],diagonal:u[1]-u[0],straight:u[2]-u[1]},l=a.diagonal+a.doubleDiagonal>1&&e===10?1:0;return(Math.floor(a.doubleDiagonal*1.75+a.diagonal*1.5+a.straight)-l)*i}r(Vn,"measureDistanceOnGrid");function zt({areaType:t,object:e,colors:n,document:i,collisionType:s="move",preview:o=!1,collisionOrigin:c}){if(!e.id&&!o)return;let{grid:u,dimensions:a}=canvas;if(!(u&&a))return;let l=i.angle??0,d=i.direction??45,f=u.getHighlightLayer(e.highlightId)?.clear();if(!f)return;let[y,p]=u.getCenter(i.x,i.y),[h,T]=u.grid.getGridPositionFromPixels(y,p),E=(360+(d-l*.5)%360)%360,g=(360+(d+l*.5)%360)%360,k=canvas.grid.getSnappedPosition(i.x,i.y,e.layer.gridPrecision),x=r((R,b,C)=>(R=(360+R%360)%360,b=(360+b%360)%360,C=(360+C%360)%360,R<b?C>=R&&C<=b:C>=R||C<=b),"withinAngle"),O=(()=>{if(t!=="cone")return{x:0,y:0};let R=(d>=0?360-d:-d)%360,b=k.x%a.size!==0?Math.sign(1*Math.round(Math.cos(Math.toRadians(R))*100)/100)/2:0,C=k.y%a.size!==0?-Math.sign(1*Math.round(Math.sin(Math.toRadians(R))*100)/100)/2:0;return{x:b*a.size,y:C*a.size}})(),M=Math.clamped(i.width??0,1.5,2),_e=i.distance??0,Q=_e*M/a.distance,fe=Math.ceil(Q/(a.size/u.h)),pe=Math.ceil(Q/(a.size/u.w)),at=r(R=>{if(!(t==="emanation"&&e instanceof Token))return{x:0,y:0};if(e.w<=a.size)return{x:0,y:0};let b=(e.w-a.size)/2,C=r((w,N)=>N===w?0:N>w?b:-b,"getCoordinate");return{x:C(e.center.x,R.x),y:C(e.center.y,R.y)}},"offsetEmanationOrigin");for(let R=-pe;R<pe;R++)for(let b=-fe;b<fe;b++){let[C,w]=canvas.grid.grid.getPixelsFromGridPosition(h+R,T+b),N={x:C+a.size*.5,y:w+a.size*.5};if(N.x<0||N.y<0)continue;let ge=at(N),lt={x:k.x+O.x+ge.x,y:k.y+O.y+ge.y};if(t==="cone"){let Ot=new Ray(lt,N),Dn=(360+Ot.angle/(Math.PI/180)%360)%360;if(Ot.distance>0&&!x(E,g,Dn))continue}if(Mn(N,lt)>_e)continue;canvas.ready&&CONFIG.Canvas.polygonBackends[s].testCollision(c??lt,N,{type:s,mode:"any"})?(u.grid.highlightGridPosition(f,{x:C,y:w,border:1,color:0}),f.beginFill(0,.5).moveTo(C,w).lineTo(C+a.size,w+a.size).endFill()):u.grid.highlightGridPosition(f,{x:C,y:w,border:n.border,color:n.fill})}}r(zt,"highlightGrid");var _n={burst:"circle",emanation:"circle",line:"ray",cone:"cone",rect:"rect"};function Ke({type:t,token:e,distance:n}){ht(e)&&(n??=t==="cone"?30:15,Ae({type:t,distance:n,traits:["concentrate","secret"],flags:{type:"seek",tokenId:e.id,collisionType:"sight",collisionOrigin:e.center}}))}r(Ke,"createSeekTemplate");function Bt({type:t="burst",distance:e=20,conceal:n=!1}={}){Ae({type:t,distance:e,fillColor:ut,flags:{type:"darkness",conceal:n}})}r(Bt,"createDarknessTemplate");function Ht({type:t="burst",distance:e=20}={}){Ae({type:t,distance:e,fillColor:dt,flags:{type:"mist"}})}r(Ht,"createMistTemplate");function Wt(t,e){return e&&!ht(e)?null:canvas.scene.templates.filter(n=>F(n,"type")===t)??[]}r(Wt,"getTemplates");function Qe(t){return Wt("darkness",t)}r(Qe,"getDarknessTemplates");function Xe(t){return Wt("mist",t)}r(Xe,"getMistTemplates");function Ze(t){if(!ht(t))return null;let e=canvas.scene.templates.find(n=>F(n,"type")==="seek");return e?(t=t instanceof Token?t.document:t,Se(e,{collisionType:"sight",collisionOrigin:t.center})):null}r(Ze,"getSeekTemplateTokens");async function K(t){let e=t.scene.templates.filter(n=>F(n,"type")==="seek"&&F(n,"tokenId")===t.id);for(let n of e)await n.delete()}r(K,"deleteSeekTemplate");function ht(t){return canvas.scene===t.scene?!0:(ui.notifications.error(v("template.scene")),!1)}r(ht,"checkScene");function Ae({type:t,distance:e,traits:n,fillColor:i,width:s,flags:o}){let c={distance:e,t:_n[t],fillColor:i||game.user.color,flags:{[m]:o}};c.t==="ray"?c.width=s||CONFIG.MeasuredTemplate.defaults.width*(canvas.dimensions?.distance??1):c.t==="cone"&&(c.angle=CONFIG.MeasuredTemplate.defaults.angle),n&&setProperty(c,"flags.pf2e.origin.traits",n);let u=new CONFIG.MeasuredTemplate.documentClass(c,{parent:canvas.scene});new CONFIG.MeasuredTemplate.objectClass(u).drawPreview()}r(Ae,"createTemplate");function Se(t,{collisionOrigin:e,collisionType:n="move"}={}){if(t=t instanceof MeasuredTemplateDocument?t.object:t,!canvas.scene)return[];let{grid:i,dimensions:s}=canvas;if(!(i&&s))return[];let o=i.getHighlightLayer(t.highlightId);if(!o||i.type!==CONST.GRID_TYPES.SQUARE)return[];let c=e??t.center,u=canvas.tokens.quadtree.getObjects(o.getLocalBounds(void 0,!0)),a=[];for(let l of u){let d=l.document,f=[];for(let y=0;y<d.height;y++){let p=l.y+y*i.size;if(f.push(`${l.x}.${p}`),d.width>1)for(let h=1;h<d.width;h++)f.push(`${l.x+h*i.size}.${p}`)}for(let y of f){if(!o.positions.has(y))continue;let[p,h]=y.split(".").map(g=>Number(g)),T={x:p+s.size*.5,y:h+s.size*.5};if(T.x<0||T.y<0)continue;if(!(canvas.ready&&n&&CONFIG.Canvas.polygonBackends[n].testCollision(c,T,{type:n,mode:"any"}))){a.push(l);break}}}return a}r(Se,"getTemplateTokens");function qt(){if(!["circle","cone"].includes(this.type)||canvas.grid.type!==CONST.GRID_TYPES.SQUARE)return MeasuredTemplate.prototype.highlightGrid.call(this);if(!this.isVisible){canvas.grid.getHighlightLayer(this.highlightId)?.clear();return}let t=F(this.document,"collisionType"),e=F(this.document,"collisionOrigin");zt({areaType:this.type==="circle"?"burst":"cone",object:this,document:this.document,colors:{border:this.borderColor,fill:this.fillColor},preview:!0,collisionType:t,collisionOrigin:e})}r(qt,"highlightTemplateGrid");function Yt(t){let{type:e,slug:n,castLevel:i=0}=t.getFlag("pf2e","origin")??{};e==="spell"&&($t.includes(n)?t.updateSource({fillColor:ut,[`flags.${m}`]:{type:"darkness",conceal:i>=4}}):wt.includes(n)?t.updateSource({fillColor:dt,[`flags.${m}`]:{type:"mist"}}):n==="cloudkill"&&t.updateSource({fillColor:Rt,[`flags.${m}`]:{type:"mist"}}))}r(Yt,"preCreateMeasuredTemplate");function Je(t){F(t,"type")==="darkness"&&canvas.perception.update({initializeVision:!0})}r(Je,"onMeasuredTemplate");function Kt(t,e){!Lt()||!t.object.actor?.isOfType("creature")||(e.find(".col.left").append('<div class="control-icon" data-action="pf2e-perception"><i class="fa-solid fa-eye"></i></div>'),e.find("[data-action=pf2e-perception]").on("click",n=>Ie.openMenu({token:t.object})))}r(Kt,"renderTokenHUD");function Qt(t,e){for(let n of e)delete n.flags?.[m]}r(Qt,"pasteToken");function P(t,...e){return e.unshift("data"),t=t instanceof Token?t.document:t,F(t,e.join("."))}r(P,"getTokenData");async function Xt(t){return t=t instanceof Token?t.document:t,Ft(t,"data")}r(Xt,"clearTokenData");async function He(t,e){let n=_(t).map(s=>s.id),i={};for(let s in e){if(!n.includes(s)){i[`flags.${m}.data.-=${s}`]=!0;continue}let o=e[s],c=P(t,s)??{};if(o.visibility===V.visibility&&delete o.visibility,o.cover===V.cover&&delete o.cover,!(c.cover===o.cover&&c.visibility===o.visibility))if(!o.visibility&&!o.cover)i[`flags.${m}.data.-=${s}`]=!0;else for(let u of["cover","visibility"])c[u]!==o[u]&&(o[u]?i[`flags.${m}.data.${s}.${u}`]=o[u]:i[`flags.${m}.data.${s}.-=${u}`]=!0)}return t=t instanceof Token?t.document:t,t.update(i)}r(He,"setTokenData");function mt(t,e,n=!1){let i=t.scene;if(!be(i,"standard"))return!1;n&&re();let s=D("standard-type");return s==="center"?Ee(t.center,e.center,n):s==="points"?qe(t.center,e,n):!1}r(mt,"hasStandardCover");var ce={tiny:0,sm:1,med:2,lg:3,huge:4,grg:5};function et(t,e,{perception:n={},options:i=[],affects:s="origin",debug:o=!1}={}){let c=i.includes("item:ranged")?ee(e.actor):!1,u=r(d=>ke(n,s,"cover",d),"returnValue"),a=te(e.actor,!0);if(c&&A[a]>A.lesser)return u("greater-prone");!c&&a==="greater-prone"&&(a=void 0);let l=P(e,t.id,"cover");return c&&A[l]>A.lesser||(!c&&l==="greater-prone"&&(l=void 0),A[l]<A.standard&&A[a]<A.standard&&mt(t,e,o)?l="standard":!l&&!a&&t.distanceTo(e)>5&&(l=yt(t,e,{perception:n,debug:o})),c&&A[l]>A.lesser)?u("greater-prone"):u(A[l]>A[a]?l:void 0)}r(et,"getCover");function yt(t,e,{perception:n={},debug:i=!1}){let s=D("lesser");if(s==="none")return;t=t instanceof Token?t.document:t,e=e instanceof Token?e.document:e;let o=(()=>{let g=Object.keys(n.origin?.cover?.ignore??{}),k=Object.keys(n.target?.cover?.ignore??{});return new Set([...g,...k])})(),c,u=t.center,a=e.center;i&&(re(),W(u,a));let l=r(g=>{let k=ce[g.actor.size];return k-d>=2&&k-f>=2},"isExtraLarge"),d=ce[t.actor.size],f=ce[e.actor.size],y=t.scene.tokens.contents.filter(g=>g.actor&&!g.hidden&&g!==t&&g!==e&&!o.has(g.id)).sort((g,k)=>ce[k.actor.size]-ce[g.actor.size]),p=d<ce.huge&&f<ce.huge&&y.filter(l).length,h=s==="ten"?.1:s==="twenty"?.2:0,T=r(g=>(i&&W(g.A,g.B,"red"),lineSegmentIntersects(u,a,g.A,g.B)),"intersectsEdge"),E=s==="cross"?g=>T(g.top)&&T(g.bottom)||T(g.left)&&T(g.right):g=>Object.values(g).some(k=>T(k));for(let g of y){let k=g.object,x=We(k.bounds,h);if(E(x))return p?"standard":"lesser";l(g)&&p--}return c}r(yt,"getCreatureCover");function J(t,e,{perception:n={},affects:i="origin",debug:s=!1}={}){t=t instanceof Token?t:t.object,e=e instanceof Token?e:e.object;let o=t.actor,c=e.actor,u=(()=>{if(o){for(let k of["unnoticed","undetected","hidden","concealed"])if(o.hasCondition(k))return k}})(),a=r(k=>l?(S[k]<S.hidden&&(k="hidden"),(sn(c)||j(n,i,"visibility","noinvis"))&&(k="concealed"),ke(n,i,"visibility",k)):ke(n,i,"visibility",k),"returnValue"),l=o?.hasCondition("invisible"),d=P(t,e.id,"visibility"),f=S[u]>S[d]?u:d;if(S[f]>=S.hidden||l)return a(f);let y=c?.hasLowLightVision,p=c?.hasDarkvision,h=c&&nt(c);if(h&&f==="concealed")return a(f);let T;if(!h){let k=Qe(t);if(k?.length){let x;for(let O of k){let M=Se(O);if(!M.length)continue;if(M.includes(t)||M.includes(e))T=!0;else continue;if(!p)return a("hidden");F(O,"conceal")&&(x="concealed")}if(x==="concealed"&&(f="concealed"),T&&f==="concealed")return a(f)}}if(f!=="concealed"){let k=Xe(t);if(k?.length)for(let x of k){let O=Se(x);if(!O.length)continue;if(O.includes(t)||O.includes(e))return a("concealed")}}if(T||h)return a(f);let E=Ye(t,s),g=E==="dim"?"concealed":E===null?"hidden":void 0;return(g==="concealed"&&y||g==="hidden"&&p)&&(g=void 0),S[g]>S[f]&&(f=g),a(f)}r(J,"getVisibility");function Zt(t,e,n,i){let s=e.flags?.["pf2e-perception"];if(s&&(s.data||s["-=data"]!==void 0)){if(t.object.renderFlags.set({refreshVisibility:!0}),game.user.isGM)return;let o=Hooks.on("refreshToken",c=>{!t.object!==c&&(Hooks.off("refreshToken",o),game.combat?.getCombatantByToken(t.id)&&ui.combat.render())})}}r(Zt,"updateToken");function Jt(t,e){e?tt(t):ae(t)}r(Jt,"hoverToken");function en(t){ae(t),game.user.isGM||ui.combat.render()}r(en,"deleteToken");function tn(t,e){e&&(ae(),Hooks.once("sightRefresh",()=>t.hover&&tt(t)))}r(tn,"controlToken");function ae(t){if(!t?.id)return $(".pf2e-conditionals").remove();$(`.pf2e-conditionals[data-hover-id=${t.id}]`).remove(),$(`.pf2e-conditionals[data-token-id=${t.id}]`).remove()}r(ae,"clearConditionals");function tt(t){let e=_(t);for(let n of e)vt(n,t)}r(tt,"showAllConditionals");async function vt(t,e){if(t=t instanceof Token?t:t.object,!t.visible||!t.actor?.isOfType("creature"))return;let n=P(t,e.id);if(isEmpty(n))return;if(!game.user.isGM&&!e.document.hasPlayerOwner&&S[n.visibility]>=S.hidden){if(!n.cover)return;n={cover:n.cover}}let i=t.worldTransform.a,s=canvas.clientCoordinatesFromCanvas(t.document._source),o=`<div class="pf2e-conditionals" data-hover-id="${t.id}" data-token-id="${e.id}" `;o+=`style="top: ${s.y}px; left: ${s.x+t.hitArea.width*i/2}px;">`;let c=D("icon-path");Object.entries(n).map(([u,a])=>{let l=u==="cover"?"cover":a,d=c[l]||Ne[l];(d.startsWith("systems")||d.startsWith("modules"))&&(d=`../../../${d}`),o+=`<div class="conditional"><img src="${d}"></img></div>`}),o+="</div>",$(document.body).append(o)}r(vt,"showConditionals");function nn(){return!!(this.sight.enabled&&this.actor?.isOfType("creature")&&this.scene?.rulesBasedVision)}r(nn,"rulesBasedVision");function on(t){be(t.scene,"npc-vision")&&t.actor?.isOfType("npc")&&t.updateSource({"sight.enabled":!0})}r(on,"preCreateToken");async function rn(t){let[e,n]=canvas.ready&&!t.viewOnly?[canvas.tokens.controlled.find(b=>b.actor===this)??this.getActiveTokens().shift()??null,t.target?.token??t.target?.actor?.getActiveTokens().shift()??null]:[null,null],i=this.getRollOptions(t.domains??[]),s=await gt({affects:"origin",origin:this,target:t.target?.actor??n?.actor??null,item:t.item??null,domains:t.domains,options:[...t.options,...t.item?.getRollOptions("item")??[]]}),o=t.viewOnly||!n?.actor?this:this.getContextualClone([...i,...n.actor.getSelfRollOptions("target")],s),c=t.statistic instanceof game.pf2e.StatisticModifier,u=c?o.system.actions?.flatMap(b=>[b,b.altUsages??[]].flat())??[]:[],a=t.viewOnly?t.statistic:c?u.find(b=>t.item?.id!==b.item.id||t?.item.name!==b.item.name?!1:t.item.isOfType("melee")&&b.item.isOfType("melee")?!0:t.item.isOfType("weapon")&&b.item.isOfType("weapon")&&t.item.isMelee===b.item.isMelee)??t.statistic:t.statistic,l=(()=>{if(o===this)return t.item??null;if(a&&"item"in a&&a.item instanceof Item&&a.item.isOfType("melee","spell","weapon"))return a.item;let b=o.items.get(t.item?.id??"");return b?.isOfType("melee","spell","weapon")?b:t.item??null})(),d=l?.getRollOptions("item")??[],y=[["attack","strike-damage","attack-spell-damage"].some(b=>t.domains.includes(b))?"attack":[],c&&l?.isOfType("weapon")&&l.baseType==="alchemical-bomb"?"manipulate":[]].flat();if(l?.isOfType("weapon","melee"))for(let b of this.synthetics.strikeAdjustments)b.adjustTraits?.(l,y);let p=y.map(b=>Vt(b,CONFIG.PF2E.actionTraits)),h=e&&n?e.distanceTo(n):null,[T,E]=typeof h=="number"?[`origin:distance:${h}`,`target:distance:${h}`]:[null,null],g=r(b=>{let C=b?.getSelfRollOptions("target")??[];if(n){C.push("target");let w=this.synthetics.targetMarks.get(n.document.uuid);w&&C.push(`target:mark:${w}`)}return C},"getTargetRollOptions"),k=g(n?.actor),x=await gt({affects:"target",origin:o,target:n?.actor??null,item:l,domains:t.domains,options:[...t.options,...d,...k]}),[O,M]=t.item?.isOfType("melee")?[t.item.reach,t.item.isMelee]:t.item?.isOfType("weapon")?[this.getReach({action:"attack",weapon:t.item}),t.item.isMelee]:[null,!1];if(e?.actor&&n?.actor&&!t.viewOnly){let b=X(e,n,{extraOptions:d,distance:h}),C=J(e,n,{perception:b,affects:"origin"});C&&j(b,"target","visibility","noff",C)&&(C=void 0),S[C]>S.concealed&&x.push(Mt(C));let w=et(e,n,{perception:b,affects:"target",options:d}),N;if(w){let ge=Be(j(b,"target","cover","ac",w)?.first());ge===0?w=void 0:ge&&(N=ge)}A[w]>A.none&&x.push(ye(w,N))}if(!!(M&&typeof O=="number"&&t.statistic instanceof game.pf2e.StatisticModifier&&n&&e?.isFlanking(n,{reach:O}))&&t.target?.token?.actor&&Nt(t.target.token.actor)){let b=game.i18n.localize("PF2E.Item.Condition.Flanked"),C=game.pf2e.ConditionManager.getCondition("flat-footed",{name:b});x.push(C.toObject())}let Q=t.viewOnly?null:(t.target?.actor??n?.actor)?.getContextualClone([...o.getSelfRollOptions("origin"),...d,...T?[T]:[]],x)??null,fe=new Set([...t.options,...i,...Q?g(Q):k,...d,"attack"]);E&&fe.add(E);let pe=l?_t(l,h):null;pe&&fe.add(`target:range-increment:${pe}`);let at={actor:o,token:e?.document??null,statistic:a,item:l,modifiers:[]},R=Q&&n&&h!==null?{actor:Q,token:n.document,distance:h,rangeIncrement:pe}:null;return{options:fe,self:at,target:R,traits:p}}r(rn,"getRollContext");function le(t,e=!1){if(!t)return;let n=t.id,i=t.isToken;return(e?game.user.targets:canvas.tokens.controlled).find(o=>i?o.actor===t:o.actor.id===n)??t.getActiveTokens().shift()??null}r(le,"getActorToken");function ee(t){return t.itemTypes.condition.some(e=>e.slug==="prone")}r(ee,"isProne");function te(t,e=!1){let n=t.itemTypes.effect.find(i=>i.sourceId===he);return e?Ge(n)?.selection.level:n}r(te,"getCoverEffect");function cn(){let t=this.system.traits.senses.value,e=ln(t),n=this.rules.filter(i=>i.key==="Sense").map(i=>i.selector.toLowerCase());return e.push(...n),this.getCondition("blinded")?Oe.BLINDED:e.includes("darkvision")||e.includes("greaterdarkvision")?Oe.DARKVISION:e.includes("lowlightvision")?Oe.LOWLIGHT:Oe.NORMAL}r(cn,"visionLevel");function an(t,e){if(!t||!e||!t.system.traits)return!1;e=e.toLowerCase();let n=t.system.traits.senses;return Array.isArray(n)?n=n.map(i=>i.type.toLowerCase()):n=ln(n.value),n.includes(e)}r(an,"hasSense");function nt(t){return an(t,"greaterdarkvision")}r(nt,"hasGreaterDarkvision");function sn(t){return an(t,"seeinvisibility")}r(sn,"seeInvisibility");function ln(t){return t.toLowerCase().replaceAll(/[ -]/g,"").split(",")}r(ln,"splitNPCSenses");var it={LOWER_BY_TWO:-2,LOWER:-1,INCREASE:1,INCREASE_BY_TWO:2,TO_CRITICAL_FAILURE:"criticalFailure",TO_FAILURE:"failure",TO_SUCCESS:"success",TO_CRITICAL_SUCCESS:"criticalSuccess"},un=["criticalFailure","failure","success","criticalSuccess"],st,dn,Ce,ot,ue,De,rt,fn,ne=class{constructor(e,n,i=null){ie(this,st);ie(this,Ce);ie(this,ue);ie(this,rt);e instanceof Roll?(this.dieResult=(e.isDeterministic?e.terms.find(s=>s instanceof NumericTerm):e.dice.find(s=>s instanceof Die&&s.faces===20))?.total??1,this.rollTotal=e.total):(this.dieResult=e.dieValue,this.rollTotal=e.dieValue+e.modifier),this.dc=typeof n=="number"?{value:n}:n,this.unadjusted=U(this,rt,fn).call(this),this.adjustment=U(this,st,dn).call(this,this.unadjusted,i),this.value=this.adjustment?U(this,Ce,ot).call(this,this.adjustment.amount,this.unadjusted):this.unadjusted}},L=ne;r(L,"DegreeOfSuccess"),st=new WeakSet,dn=r(function(e,n){if(!n)return null;for(let i of["all",...un]){let{label:s,amount:o}=n[i]??{};if(o&&s&&!(e===ne.CRITICAL_SUCCESS&&o===it.INCREASE)&&!(e===ne.CRITICAL_FAILURE&&o===it.LOWER)&&(i==="all"||un.indexOf(i)===e))return{label:s,amount:o}}return null},"#getDegreeAdjustment"),Ce=new WeakSet,ot=r(function(e,n){switch(e){case"criticalFailure":return 0;case"failure":return 1;case"success":return 2;case"criticalSuccess":return 3;default:return Math.clamped(n+e,0,3)}},"#adjustDegreeOfSuccess"),ue=new WeakSet,De=r(function(e){return this.dieResult===20?U(this,Ce,ot).call(this,it.INCREASE,e):this.dieResult===1?U(this,Ce,ot).call(this,it.LOWER,e):e},"#adjustDegreeByDieValue"),rt=new WeakSet,fn=r(function(){let e=this.dc.value;return this.rollTotal-e>=10?U(this,ue,De).call(this,ne.CRITICAL_SUCCESS):e-this.rollTotal>=10?U(this,ue,De).call(this,ne.CRITICAL_FAILURE):this.rollTotal>=e?U(this,ue,De).call(this,ne.SUCCESS):U(this,ue,De).call(this,ne.FAILURE)},"#calculateDegreeOfSuccess"),xe(L,"CRITICAL_FAILURE",0),xe(L,"FAILURE",1),xe(L,"SUCCESS",2),xe(L,"CRITICAL_SUCCESS",3);var Re=class extends B{static async openMenu(e,n){let i=await super.openMenu(e,n);return i&&e.message&&pn(e.message),i}get title(){return v("menu.validation.title",{name:this.token.name})}get template(){return Y("validation")}get selected(){let e=super.selected;return e.length?e:this.globalSelection}get globalSelection(){let e=this.token,n=e.actor.alliance;return _(e).filter(i=>i.actor.alliance!==n).map(i=>i.id)}getSavedData(e=!0){let n=super.getSavedData();return e?this._convertData(n):n}_convertData(e){let n=this.property,i=this.scene,s=this.selected,o=V[n],c=n==="cover"?q:oe;for(let u of s){let a=i.tokens.get(u),l=`${u}.${n}`,d=getProperty(e,l)??o,f=this.processValue({token:a,value:d});c.includes(f)||(f=d),d!==f&&setProperty(e,l,f)}return e}processValue(e){throw new Error(`${this.constructor.name} doesn't have a 'processValue' method defined`)}getData(e){let{covers:n,visibilities:i,i18n:s}=super.getData(e),o=this.currentData,c=this.getSavedData(!1),u=this.property,a=this.selected,l=_(this.token);l=l.map(({id:f,name:y,actor:p})=>{let h=o[f]??{},T=c[f]??{};return{id:f,name:y,alliance:p.alliance,selected:a.includes(f),...B.createPropertyData(T,h,u)}});let d=D("validation");return d==="selected"?l=l.filter(f=>f.selected):d==="changed"&&(l=l.filter(f=>f.changed)),{...this._spliIntoAlliances(l),i18n:s,property:u,options:u==="cover"?n:i,showSelected:a.length!==l.length&&d==="all",showChanges:d!=="changed"}}activateListeners(e){super.activateListeners(e),e.find("[data-action=cancel]").on("click",n=>{this.close()})}};r(Re,"ValidationMenu");var $e=class extends Re{#e;constructor(e,n={}){super(e,n),this.#e=e.value}get property(){return"cover"}processValue(){return this.#e}};r($e,"CoverValidationMenu");var de=class extends Re{#e;constructor(e,n={}){super(e,n),this.#e=e.roll}get property(){return"visibility"}get roll(){return this.#e}};r(de,"VisibilityValidationMenu");var we=class extends de{processValue({token:e,value:n}){let i=this.roll,s=e.actor.perception.dc.value,o=S[n],c=new L(i,s).value;return c>=L.SUCCESS&&o<S.hidden?"hidden":c<=L.FAILURE&&o>=S.hidden?"observed":n}};r(we,"HideValidationMenu");var Fe=class extends de{get selected(){return _(this.token).map(e=>e.id)}processValue({token:e,value:n}){return S[n]>=S.hidden?"observed":n}};r(Fe,"UnHideValidationMenu");var Pe=class extends de{#e;constructor(e,n={}){super(e,n),this.#e=e.originator}get selected(){let e=this.token,n=e.actor.alliance,i=this.#e.id,s=P(e)??{};return _(e).filter(o=>{if(o.id===i||o.actor.alliance===n)return!1;let c=getProperty(s,`${o.id}.visibility`);return S[c]>=S.undetected}).map(o=>o.id)}processValue({token:e,value:n}){return S[n]>=S.undetected?"hidden":n}};r(Pe,"PointOutValidationMenu");var ct=class extends de{getSavedData(e=!0){let n=this.token.id,i=_(this.token),s={};for(let o of i){let c=P(o,n);c&&(s[o.id]=deepClone(c))}return e?this._convertData(s):s}getData(){let e=super.getData();return e.isReversed=!0,e.options=oe.map(n=>({value:n,label:v(`visibility.reversed.${n}`)})),e}_saveData(e){let n=this.scene,i=this.token.id,s=[];for(let[o,c]of Object.entries(e)){let u={_id:o},a=n.tokens.get(o);if(a){c.visibility===V.visibility&&delete c.visibility;let l=P(a,i);if(l?.visibility===c.visibility)continue;!l.cover&&!c.visibility?u[`flags.${m}.data.-=${i}`]=!0:c.visibility?u[`flags.${m}.data.${i}.visibility`]=c.visibility:u[`flags.${m}.data.${i}.-=visibility`]=!0}else u[`flags.${m}.data.-=${i}`]=!0;s.push(u)}n.updateEmbeddedDocuments("Token",s)}};r(ct,"ReverseVisibilityValidationMenu");var Le=class extends ct{#e;constructor(e,n={}){super(e,n),this.#e=e.fromTemplate}get globalSelection(){return this.#e?[]:super.globalSelection}static async openMenu(e,n){await super.openMenu(e,n)&&K(e.token)}processValue({token:e,value:n}){let i=this.roll,s=e.actor.skills.stealth.dc.value,o=S[n],c=new L(i,s).value;return c>=L.CRITICAL_SUCCESS&&o>=S.hidden||c>=L.SUCCESS&&o===S.hidden?"observed":c>=L.SUCCESS&&o>=S.undetected?"hidden":n}};r(Le,"SeekValidationMenu");function Tt(t,e){let n=t.token;if(!n)return;let i=game.user.isGM,s=n.hasPlayerOwner,{cover:o,selected:c,skipWait:u,validated:a,pointOut:l}=Pt(t),d=t.getFlag("pf2e","context");if(o){if(i){let f=bt({property:"cover",skipWait:u,validated:a});e.find(".message-content").append(f),e.find("[data-action=validate-cover]").on("click",()=>{$e.openMenu({token:n,selected:c,value:o,message:t})})}else if(!u){let f=kt("cover",a);e.find(".message-content").append(f)}}else if(d?.pf2ePerception?.visibility){a||e.find(".message-buttons").remove();let f=e.find(".flavor-text");!i&&s&&(e.find(".message-sender").text(n.name),f.empty());let y=v(`message.flat-check.${a===void 0?"blind":a?"success":"failure"}`),p=mn(y,a);if(f.append(p),i)for(let h of["success","failure"])f.append(St({action:`${h}-message`,icon:"fa-solid fa-message",label:v("message.flat-check.button",h)})),e.find(`[data-action=${h}-message]`).on("click",()=>{ft(t,"validated",h==="success")})}else if(d?.type==="skill-check"&&d.pf2ePerception)if(i){if(d.options.includes("action:hide")){let f=bt({property:"visibility",skipWait:u,validated:a});e.find(".flavor-text").append(f),e.find("[data-action=validate-visibility]").on("click",()=>{we.openMenu({token:n,message:t,roll:t.rolls[0],selected:d.pf2ePerception.selected})})}}else s&&d.options.includes("action:hide")&&hn({token:n,message:t,html:e,validated:a});else if(d?.type==="perception-check"&&d.pf2ePerception)if(i){if(d.options.includes("action:seek")){let f=gn({skipWait:u,validated:a,smallAction:"delete-template",smallIcon:"fa-thin fa-cubes",smallSlashed:!0});e.find(".flavor-text").append(f),e.find("[data-action=validate-visibility]").on("click",()=>{Le.openMenu({token:n,message:t,roll:t.rolls[0],selected:d.pf2ePerception.selected,fromTemplate:d.pf2ePerception.fromTemplate})}),e.find("[data-action=delete-template").on("click",()=>{K(n)})}}else s&&d.options.includes("action:seek")&&hn({token:n,message:t,html:e,validated:a});else if(l){let f=n.scene.tokens.get(l);if(!f)return;if(i){let y=gn({skipWait:u,validated:a,smallAction:"ping-token",smallIcon:"fa-solid fa-signal-stream"});e.find(".message-content").append(y),e.find("[data-action=validate-visibility]").on("click",()=>{Pe.openMenu({message:t,token:f,originator:n,selected:canvas.tokens.controlled.map(p=>p.id)})}),e.find("[data-action=ping-token]").on("click",()=>{canvas.ping(f.center)})}else if(s){let y=kt("visibility",a);e.find(".message-content").append(y)}}if(i&&me.includes(d?.type)){let y=`<span style="position: absolute; right: 0px; bottom: 1px;">
    <button data-action="unhide" title="${v("message.unhide.tooltip")}" style="width: 22px; height: 22px; font-size: 10px; line-height: 1px;">
        <i class="fa-duotone fa-eye-slash" style="right: 1px;"></i>
    </button>
</span>`;e.find(".dice-result .dice-total").append(y),e.find("[data-action=unhide]").on("click",p=>{p.stopPropagation(),Fe.openMenu({token:n})})}}r(Tt,"renderChatMessage");function pn(t){F(t,"validated")||ft(t,"validated",!0)}r(pn,"validateMessage");function gn({skipWait:t,validated:e,smallIcon:n,smallAction:i,smallSlashed:s}){let o='<div style="display: grid; grid-template-columns: 1fr auto; gap: 3px">';return o+=bt({property:"visibility",skipWait:t,validated:e}),o+=St({action:i,icon:n,slashed:s,tooltip:v(`message.visibility.small-button.${i}`)}),o+="</div>",o}r(gn,"createValidateCombo");function hn({html:t,token:e,message:n,validated:i}){t.find(".message-sender").text(e.name);let s=n.getFlag("pf2e","modifierName");s+=kt("visibility",i),t.find(".flavor-text").html(s)}r(hn,"addBlindSkillCheckFlavor");function kt(t,e){let n=v(`message.${t}.player.${e?"validated":"wait"}`);return mn(n,e)}r(kt,"createWaitHint");function mn(t,e){return e===!0?t='<i class="fa-solid fa-check" style="color: green;"></i> '+t:e===!1&&(t='<i class="fa-solid fa-xmark" style="color: red;"></i> '+t),`<i style="display: block; font-size: .9em; text-align: end;">${t}</i>`}r(mn,"createHint");function bt({skipWait:t,validated:e,property:n}){let i=v(`message.${n}.gm.${t?"check":e?"validated":"validate"}`);return!t&&e&&(i+='<i class="fa-solid fa-check" style="color: green; margin-left: 0.3em;"></i>'),St({action:`validate-${n}`,icon:"fa-solid fa-list",label:i})}r(bt,"createValidateButton");function St({action:t,icon:e,label:n,tooltip:i,slashed:s=!1}){let o=`<button type="button" style="margin: 0 0 5px; padding-block: 0; position: relative;" data-action="${t}" title="${i}">`;return e&&(o+=`<i class="${e}" ${n?"":'style="margin: 0;"'}></i>`,s&&(o+='<i class="fa-solid fa-slash-forward" style="position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); font-size: 1.2em;"></i>')),n&&(o+=`${e?" ":""}${n}`),o+="</button>",o}r(St,"createChatButton");async function Ct({content:t,token:e,flags:n,secret:i}){let s={content:t,speaker:ChatMessage.getSpeaker({token:e instanceof Token?e.document:e})};return n&&setProperty(s,`flags.${m}`,n),i&&(s.type=CONST.CHAT_MESSAGE_TYPES.WHISPER,s.whisper=ChatMessage.getWhisperRecipients("gm")),ChatMessage.create(s)}r(Ct,"createTokenMessage");function vn(){let t=game.pf2e.actions.get("hide"),e=Te(t,2).constructor,n=Te(t.toActionVariant(),2).constructor,i=Te(t,1).constructor,s=Te(t.toActionVariant(),1).constructor;Hn(e,n),Bn(i,s),zn(i,s),Gn(i,s),Nn(e,n)}r(vn,"setupActions");function Nn(t,e){class n extends e{async use(o={}){let c=v("action.point-out"),u=Me(o,c);u&&jn(this,u)}}r(n,"PointOutVariant");class i extends t{constructor(){super({cost:1,name:`${m}.action.point-out`,description:`${m}.action.point-out.description`,rollOptions:["action:point-out"],slug:"point-out",traits:["auditory","manipulate","visual"]})}toActionVariant(o={}){return o.name??=this.name,new n(this,o)}}r(i,"PointOut"),game.pf2e.actions.set("point-out",new i)}r(Nn,"setupPointOut");async function jn({name:t,traits:e},n){let i=game.user.targets.filter(l=>l.actor).first(),s=i?P(i,n.id,"visibility"):void 0,o=i&&S[s]<S.undetected,c;if(o){let l=i.actor.skills.stealth.dc.value;c=v("message.point-out.short-check",{check:`@Check[type:perception|dc:${l}|traits:auditory,manipulate,visual|showDC:gm]`})}else c=v("message.point-out.short");let u=await renderTemplate(Y("point-out"),{description:c,name:t,traits:e.map(l=>({slug:l,tooltip:CONFIG.PF2E.traitsDescriptions[l],name:CONFIG.PF2E.actionTraits[l]}))}),a={pointOut:o?i.id:void 0};Ct({content:u,token:n,flags:a})}r(jn,"pointOut");function Gn(t,e){class n extends e{async use(o={}){let c=game.i18n.localize("PF2E.Actions.Seek.Title"),u=Me(o,c);if(u)return await Un(u)?(o.actors=[u.actor],super.use(o)):K(u)}}r(n,"SeekVariant");class i extends t{constructor(){super({cost:1,description:"PF2E.Actions.Seek.Description",name:"PF2E.Actions.Seek.Title",notes:[{outcome:["criticalSuccess"],text:"PF2E.Actions.Seek.Notes.criticalSuccess"},{outcome:["success"],text:"PF2E.Actions.Seek.Notes.success"}],rollOptions:["action:seek"],slug:"seek",statistic:"perception",traits:["concentrate","secret"]})}toActionVariant(o){return new n(this,o)}}r(i,"Seek"),game.pf2e.actions.set("seek",new i)}r(Gn,"setupSeek");async function Un(t){let e=game.i18n.localize("PF2E.Foot"),n='<p style="margin: 0 0.3em; text-align: center;">';return n+=`${v("dialog.seek.hint")}</p><p>`,n+=yn("create-cone","fa-thin fa-cubes",game.i18n.format("PF2E.TemplateLabel",{size:30,unit:e,shape:game.i18n.localize(CONFIG.PF2E.areaTypes.cone)})),n+=yn("create-burst","fa-thin fa-cubes",game.i18n.format("PF2E.TemplateLabel",{size:15,unit:e,shape:game.i18n.localize(CONFIG.PF2E.areaTypes.burst)})),n+="</p>",Dialog.wait({title:`${t.name} - ${game.i18n.localize("PF2E.Actions.Seek.Title")}`,content:n,buttons:{ok:{icon:'<i class="fa-solid fa-check"></i>',label:v("dialog.seek.accept"),callback:()=>!0},no:{icon:'<i class="fa-solid fa-xmark"></i>',label:v("dialog.seek.cancel"),callback:i=>!1}},close:()=>!1,render:i=>{i.filter(".dialog-content").find("[data-action=create-cone], [data-action=create-burst]").on("click",o=>{let{action:c}=o.currentTarget.dataset;K(t),Ke({type:c==="create-cone"?"cone":"burst",token:t})})}},{width:300,left:10})}r(Un,"seek");function zn(t,e){class n extends e{async use(o={}){let c=game.i18n.localize("PF2E.Actions.Sneak.Title"),u=Me(o,c);if(u)return o.actors=[u.actor],super.use(o)}}r(n,"SneakVariant");class i extends t{constructor(){super({cost:1,description:"PF2E.Actions.Sneak.Description",name:"PF2E.Actions.Sneak.Title",notes:[{outcome:["success","criticalSuccess"],text:"PF2E.Actions.Sneak.Notes.success"},{outcome:["failure"],text:"PF2E.Actions.Sneak.Notes.failure"},{outcome:["criticalFailure"],text:"PF2E.Actions.Sneak.Notes.criticalFailure"}],rollOptions:["action:sneak"],slug:"sneak",traits:["move","secret"]})}toActionVariant(o){return new n(this,o)}}r(i,"Sneak")}r(zn,"setupSneak");function Bn(t,e){class n extends e{async use(o={}){let c=game.i18n.localize("PF2E.Actions.Hide.Title"),u=Me(o,c);if(u)return o.actors=[u.actor],super.use(o)}}r(n,"HideVariant");class i extends t{constructor(){super({cost:1,description:"PF2E.Actions.Hide.Description",name:"PF2E.Actions.Hide.Title",rollOptions:["action:hide"],slug:"hide",statistic:"stealth",traits:["secret"],notes:[{outcome:["success","criticalSuccess"],text:"PF2E.Actions.Hide.Notes.success"}]})}toActionVariant(o){return new n(this,o)}}r(i,"Hide"),game.pf2e.actions.set("hide",new i)}r(Bn,"setupHide");function Hn(t,e){class n extends e{async use(o={}){let c=v("action.take-cover"),u=Me(o,c);u&&Wn(u)}}r(n,"TakeCoverVariant");class i extends t{constructor(){super({cost:1,description:"PF2E.Actions.TakeCover.Description",img:"systems/pf2e/icons/conditions-2/status_acup.webp",name:"PF2E.Actions.TakeCover.Title",slug:"take-cover"})}toActionVariant(o){return new n(this,o)}}r(i,"TakeCover"),game.pf2e.actions.set("take-cover",new i)}r(Hn,"setupCover");async function Wn(t){let e=t.actor,n=te(e),i=Z(t,game.user.targets.ids);if(n&&!i.length)return n.delete();let s=P(t)??{},o=Object.entries(s).reduce((a,[l,{cover:d}])=>(d&&(a[l]=d),a),{}),c=await renderTemplate(Y("covers-dialog"),{i18n:v,hasTargets:!!i.length,hasCovers:!isEmpty(o),hasTargetCover:i.some(a=>a in o),isProne:ee(e)}),u=new Dialog({title:`${t.name} - ${v("action.take-cover")}`,content:c,buttons:{},render:a=>{a.find("button").on("click",async l=>{let{level:d}=l.currentTarget.dataset,f=D("skip-cover"),y=r(async(p,h)=>{h=h?i:void 0;let T=p===V.cover?h?"remove":"remove-all":"take",E=await Ct({content:v(`message.cover.${T}`,{cover:v(`cover.${p}`)}),flags:{selected:h,cover:p,skipWait:f},token:t});if(f){if(p===V.cover&&!h)return Xt(t);let g=deepClone(P(t))??{};for(let k of i)setProperty(g,`${k}.cover`,p);return He(t,g)}},"process");if(d==="remove-all")y(V.cover);else if(d==="remove")y(V.cover,!0);else if(i.length)y(d,!0);else{let p=ye(d);e.createEmbeddedDocuments("Item",[p])}u.close()})}}).render(!0)}r(Wn,"takeCover");function Me(t,e){let n=t.tokens?.filter(o=>o.actor)??[];Array.isArray(n)||(n=[n]);let i=t.actors??[];if(Array.isArray(i)||(i=[i]),!n.length&&i.length===1&&(n=[le(i[0])].filter(Boolean)),n.length||(n=canvas.tokens.controlled.filter(o=>o.actor)),n.length||(n=[le(game.user.character)].filter(Boolean)),n.length>1){ui.notifications.warn(v("action.only-one",{action:e}));return}else if(!n.length){ui.notifications.warn(v("action.must-one",{action:e}));return}let s=n[0];if(!s?.actor?.isOfType("creature")){ui.notifications.warn(v("action.must-creature",{action:e}));return}return s}r(Me,"getSelectedToken");function yn(t,e,n){return`<button type="button" data-action="${t}" style="margin: 0 0 5px; padding: 0;">
    <i class="${e}"></i> ${n}</button>
</button>`}r(yn,"createButton");var kn={geometry:{clearDebug:re,getRectEdges:We,lineIntersectWall:Ee,pointToTokenIntersectWall:qe},token:{getCreatureCover:yt,getVisibility:J,clearConditionals:ae,showConditionals:vt,showAllConditionals:tt,hasStandardCover:mt,getTokenData:P,getCover:et},lighting:{getLightExposure:Ye},actor:{getActorToken:le,isProne:ee,getCoverEffect:te,hasGreaterDarkvision:nt},scene:{getValidTokens:_,validateTokens:Z,getSceneSetting:be},template:{createSeekTemplate:Ke,createDarknessTemplate:Bt,createMistTemplate:Ht,getDarknessTemplates:Qe,getMistTemplates:Xe,getSeekTemplateTokens:Ze,deleteSeekTemplate:K,createTemplate:Ae,getTemplateTokens:Se},ruleElement:{perceptionRules:X,getPerception:j,updateFromPerceptionRules:ke}};async function bn(t,...e){let n=e[1];if(!n)return t(...e);Array.isArray(n.options)&&(n.options=new Set(n.options));let{actor:i,createMessage:s="true",type:o,token:c,target:u,isReroll:a}=n,l=c??le(i),d=u?.token,f=me.includes(o),y=D("flat-check");if(a||!s||!l||!Dt.includes(o)||f&&(!d||y==="none"))return t(...e);if(f&&d.actor){let p=e[2],h=X(l,d,{extraOptions:n.options.filter(M=>M.startsWith("item:"))}),T=J(d,l,{perception:h,affects:"target"});if(!T)return t(...e);let E=Be(j(h,"target","visibility","dc",T)?.first());if(E===0)return t(...e);let g=S[T]>=S.undetected,k=p?.ctrlKey||p?.metaKey,O=(await new l.actor.perception.constructor(l.actor,{slug:"visibility-check",label:`${game.i18n.localize("PF2E.FlatCheck")}: ${game.i18n.localize(`PF2E.condition.${T}.name`)}`,check:{type:"flat-check"}}).roll({dc:E??T==="concealed"?5:11,target:d.actor,rollMode:g||k?game.user.isGM?"gmroll":"blindroll":"roll"})).degreeOfSuccess>1;if(g&&(n.options.add("secret"),n.pf2ePerception={isSuccess:O,visibility:T}),y!=="roll"&&!g&&!O)return}else if(n.options.has("action:hide"))setProperty(n,"pf2ePerception.selected",game.user.targets.ids);else if(n.options.has("action:seek")){let p=Ze(l),h=p??Array.from(game.user.targets),T=Z(l,h).filter(E=>!E.document.hidden).map(E=>E.id);setProperty(n,"pf2ePerception.selected",T),setProperty(n,"pf2ePerception.fromTemplate",!!p)}return t(...e)}r(bn,"checkRoll");function Tn(t,e){let{createMessage:n="true",type:i,token:s,target:o,isReroll:c,options:u,dc:a}=t.context,l=s,d=o?.token,f=o?.actor;if(c||!n||!l||!d||!f||!me.includes(i))return;let y=te(f),p=y?Ge(y)?.selection.level??F(y,"level"):void 0,h=t[m]?.coverOverride??p,T='<div class="roll-mode-panel">';T+=`<div class="label">${v("dice-checks.cover.label")}</div>`,T+=`<select name="overrideCover"><option value="">${v("dice-checks.cover.none")}</option>`,(ee(f)?q.slice(1):q.slice(1,-1)).forEach(g=>{let k=g===h?"selected":"",x=v(`cover.${g}`);T+=`<option value="${g}" ${k}>${x}</option>`}),T+="</select></div>",T+="<hr>",e.find(".roll-mode-panel").before(T),e.find("select[name=overrideCover]").on("change",g=>{let k=g.currentTarget.value||void 0;setProperty(t,`${m}.coverOverride`,k),h=k}),e.find("button.roll")[0].addEventListener("click",g=>{g.preventDefault(),g.stopPropagation(),g.stopImmediatePropagation();let k=!1,x=deepClone(f._source.items);if(h!==p){k=!0;let O=x.findIndex(M=>getProperty(M,"flags.core.sourceId")===he);if(O!==-1&&x.splice(O,1),h){let M=ye(h);x.push(M)}}if(k&&(o.actor=f.clone({items:x},{keepId:!0}),a?.slug)){let O=o.actor.getStatistic(a.slug)?.dc;O&&(a.value=O.value,a.statistic=O)}t.resolve(!0),t.isResolved=!0,t.close()},!0),t.setPosition()}r(Tn,"renderCheckModifiersDialog");function Sn(t,e){D("target")&&qn(e)}r(Sn,"renderCombatTracker");function qn(t){t.find("[data-control=toggleTarget]").each((e,n)=>{n.addEventListener("click",i=>{i.preventDefault(),i.stopPropagation(),i.stopImmediatePropagation();let{combatantId:s}=i.currentTarget.closest(".combatant").dataset,c=game.combats.viewed.combatants.get(s??"")?.token;if(!c)return;let u=Array.from(game.user.targets).some(a=>a.document===c);c.object.setTarget(!u,{releaseOthers:!i.shiftKey})},!0)})}r(qn,"setupToggleTarget");function Cn(t,e){let n=D("encounter");e.find(".form-group").last().after(`<div class="form-group">
    <label>${v("settings.encounter.name")}</label>
    <input type="checkbox" name="pf2e-perception.encounter" ${n?"checked":""}>
    <p class="notes">${v("settings.encounter.short")}</p>
</div>`),e.find('input[name="pf2e-perception.encounter"]').on("change",i=>{let s=i.currentTarget.checked;je("encounter",s)})}r(Cn,"renderCombatTrackerConfig");function xn(t,e,n={}){return!e.enabled||!this._canDetect(t,n.object,n)?!1:n.tests.some(i=>this._testPoint(t,e,n.object,i))}r(xn,"detectionModeTestVisibility");function On(t,e,n){let i=t.object,s=i.document;return s instanceof TokenDocument&&s.hasStatusEffect(CONFIG.specialStatusEffects.BLIND)?!1:e instanceof Token?i instanceof Token?!xt(i,e,S.hidden,n):!e.document?.hasStatusEffect(CONFIG.specialStatusEffects.INVISIBLE)&&!e.actor?.hasCondition("hidden","undetected","unnoticed"):!0}r(On,"basicSightCanDetect");function In(t,e,n){if(!game.settings.get("pf2e","automation.rulesBasedVision"))return!0;let i=t.object;return!(e instanceof Token)||!e.actor?.emitsSound||i.actor?.hasCondition("deafened")?!1:i instanceof Token?!xt(i,e,S.undetected,n):!e.actor?.hasCondition("undetected","unnoticed")}r(In,"hearingCanDetect");function En(t,e,n){if(!(e instanceof Token)||e.document.elevation>canvas.primary.background.elevation||e.actor?.isOfType("loot"))return!1;let i=t.object;return i instanceof Token?!xt(i,e,S.undetected,n):!1}r(En,"feelTremorCanDetect");function xt(t,e,n,i={}){if(!i.visibility){let s=X(t,e);i.visibility=J(e,t,{perception:s,affects:"target"})}return S[i.visibility]>=n}r(xt,"reachesThreshold");var Yn=["cover","concealed","hidden","undetected","unnoticed"],Ve=class extends FormApplication{static get defaultOptions(){return foundry.utils.mergeObject(super.defaultOptions,{template:Y("icon-path-menu"),title:v("settings.icon-path.name"),width:500})}getData(){let e=D("icon-path");return{icons:Yn.map(i=>({name:i,placeholder:Ne[i],value:e[i]??"",label:i==="cover"?v("icon-path.cover"):game.i18n.localize(CONFIG.PF2E.conditionTypes[i])})),i18n:v}}activateListeners(e){super.activateListeners(e),e.find("button[name=cancel]").on("click",n=>{n.prefentDefault(),this.close()})}async _updateObject(e,n){je("icon-path",n)}};r(Ve,"IconPathMenu");function An(){G("icon-path",Object,{},{config:!1}),game.settings.registerMenu(m,"icon-path-menu",{name:I("icon-path","name"),label:I("icon-path","label"),icon:"fa-solid fa-list",restricted:!0,type:Ve}),G("permission",String,CONST.USER_ROLES.GAMEMASTER,{choices:{1:I("permission","choices.1"),2:I("permission","choices.2"),3:I("permission","choices.3"),4:I("permission","choices.4")}}),G("npc-vision",Boolean,!1),G("target",Boolean,!0,{onChange:()=>ui.combat?.render()}),G("lesser",String,"ten",{choices:{none:I("lesser","choices.none"),cross:I("lesser","choices.cross"),zero:I("lesser","choices.zero"),ten:I("lesser","choices.ten"),twenty:I("lesser","choices.twenty")}}),G("standard",Boolean,!0),G("standard-type",String,"center",{choices:{center:I("standard-type","choices.center"),points:I("standard-type","choices.points")}}),G("skip-cover",Boolean,!0),G("validation",String,"all",{choices:{all:I("validation","choices.all"),selected:I("validation","choices.selected"),changed:I("validation","choices.changed")}}),G("flat-check",String,"cancel",{choices:{none:I("flat-check","choices.none"),roll:I("flat-check","choices.roll"),cancel:I("flat-check","choices.cancel")}}),G("encounter",Boolean,!1)}r(An,"registerSettings");function I(t,e){return`${m}.settings.${t}.${e}`}r(I,"path");function G(t,e,n,i={}){game.settings.register(m,t,{name:I(t,"name"),hint:I(t,"hint"),scope:"world",config:!0,type:e,default:n,...i})}r(G,"register");var Kn="game.pf2e.Check.roll",Qn="CONFIG.Token.documentClass.prototype.rulesBasedVision",Xn="CONFIG.MeasuredTemplate.objectClass.prototype.highlightGrid",Zn="CONFIG.Actor.documentClass.prototype.getRollContext",Jn="CONFIG.PF2E.Actor.documentClasses.npc.prototype.visionLevel",ei="DetectionMode.prototype.testVisibility",ti="CONFIG.Canvas.detectionModes.basicSight._canDetect",ni="CONFIG.Canvas.detectionModes.hearing._canDetect",ii="CONFIG.Canvas.detectionModes.feelTremor._canDetect";Hooks.once("init",()=>{An(),vn(),jt(),libWrapper.register(m,Kn,bn),libWrapper.register(m,Xn,qt,"OVERRIDE"),libWrapper.register(m,Qn,nn,"OVERRIDE"),libWrapper.register(m,Zn,rn,"OVERRIDE"),libWrapper.register(m,Jn,cn,"OVERRIDE"),libWrapper.register(m,ei,xn,"OVERRIDE"),libWrapper.register(m,ti,On,"OVERRIDE"),libWrapper.register(m,ni,In,"OVERRIDE"),libWrapper.register(m,ii,En,"OVERRIDE"),game.data.users.find(e=>e._id===game.data.userId).role>=CONST.USER_ROLES.GAMEMASTER?(Hooks.on("renderSceneConfig",Gt),Hooks.on("renderCombatTrackerConfig",Cn)):Hooks.on("renderCombatTracker",Sn)});Hooks.once("ready",()=>{game.modules.get(m).api=kn,Hooks.on("renderChatMessage",Tt);for(let t of document.querySelectorAll("#chat-log .chat-message")){let e=game.messages.get(t.dataset.messageId);e&&Tt(e,$(t))}game.user.isGM&&game.modules.get("pf2e-rules-based-npc-vision")?.active&&ui.notifications.error(`${m}.warning.npc-vision`,{permanent:!0,localize:!0})});Hooks.on("hoverToken",Jt);Hooks.on("pasteToken",Qt);Hooks.on("updateToken",Zt);Hooks.on("deleteToken",en);Hooks.on("controlToken",tn);Hooks.on("renderTokenHUD",Kt);Hooks.on("preCreateToken",on);Hooks.on("canvasPan",()=>ae());Hooks.on("renderCheckModifiersDialog",Tn);Hooks.on("preCreateMeasuredTemplate",Yt);Hooks.on("createMeasuredTemplate",Je);Hooks.on("updateMeasuredTemplate",Je);Hooks.on("deleteMeasuredTemplate",Je);})();
//# sourceMappingURL=main.js.map
