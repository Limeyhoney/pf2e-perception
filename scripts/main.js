(()=>{var Ye=Object.defineProperty;var wt=(t,e,n)=>e in t?Ye(t,e,{enumerable:!0,configurable:!0,writable:!0,value:n}):t[e]=n;var r=(t,e)=>Ye(t,"name",{value:e,configurable:!0});var oe=(t,e,n)=>(wt(t,typeof e!="symbol"?e+"":e,n),n),Vt=(t,e,n)=>{if(!e.has(t))throw TypeError("Cannot "+n)};var ie=(t,e,n)=>{if(e.has(t))throw TypeError("Cannot add the same private member more than once");e instanceof WeakSet?e.add(t):e.set(t,n)};var L=(t,e,n)=>(Vt(t,e,"access private method"),n);var B="Compendium.pf2e.other-effects.Item.I9lfZUiCwMiGogVi",ge="Compendium.pf2e.feats-srd.Item.y2XeMe1F18lIyo59",v={[void 0]:0,observed:0,concealed:1,hidden:2,undetected:3,unnoticed:4},se=["observed","concealed","hidden","undetected","unnoticed"],me=["none","lesser","standard","greater","greater-prone"],x={[void 0]:0,none:0,lesser:1,standard:2,greater:3,"greater-prone":4},D={cover:"none",visibility:"observed"},he=["attack-roll","spell-attack-roll"],Ze=[...he,"skill-check","perception-check"],ve={cover:"conditional:cover:skip"},ke={cover:"modules/pf2e-perception/images/cover.webp",concealed:"systems/pf2e/icons/conditions/concealed.webp",hidden:"systems/pf2e/icons/conditions/hidden.webp",undetected:"systems/pf2e/icons/conditions/undetected.webp",unnoticed:"systems/pf2e/icons/conditions/unnoticed.webp"};var u="pf2e-perception";function P(t){return`modules/${u}/templates/${t}.hbs`}r(P,"templatePath");function p(...t){let e=t.at(-1),n=typeof e=="object",o=n?t.slice(0,-1):t;return o.unshift(u),game.i18n[n?"format":"localize"](o.join("."),e)}r(p,"localize");function O(t,e){return t.getFlag(u,e)}r(O,"getFlag");function we(t,e,n){return t.setFlag(u,e,n)}r(we,"setFlag");function Ke(t,e){return t.unsetFlag(u,e,!0)}r(Ke,"unsetFlag");function Xe(t){return getProperty(t,`flags.${u}`)??{}}r(Xe,"getFlags");function T(t){return game.settings.get(u,t)}r(T,"getSetting");function ye(t,e){return game.settings.set(u,t,e)}r(ye,"setSetting");function qe(){return game.user.role>=T("permission")}r(qe,"hasPermission");function Je(t){let e=game.i18n.localize(`PF2E.condition.${t}.name`);return game.pf2e.ConditionManager.getCondition("flat-footed",{name:e}).toObject()}r(Je,"createFlatFootedSource");function be(t,e=!1){let n=x[t]===3?4:x[t];return{_id:"I9lfZUiCwMiGogVi",img:"systems/pf2e/icons/conditions-2/status_acup.webp",name:p("cover",t),system:{description:{gm:"",value:"<p>When you're behind an obstacle that could block weapons, guard you against explosions, and make you harder to detect, you're behind cover. Standard cover gives you a +2 circumstance bonus to AC, to Reflex saves against area effects, and to Stealth checks to Hide, Sneak, or otherwise avoid detection. You can increase this to greater cover using the Take Cover basic action, increasing the circumstance bonus to +4. If cover is especially light, typically when it's provided by a creature, you have lesser cover, which grants a +1 circumstance bonus to AC. A creature with standard cover or greater cover can attempt to use Stealth to Hide, but lesser cover isn't sufficient.</p>"},rules:[{domain:"all",key:"RollOption",option:`self:cover-bonus:${n}`},{domain:"all",key:"RollOption",option:`self:cover-level:${t}`},{key:"FlatModifier",predicate:[{or:[{and:["self:condition:prone","item:ranged"]},{not:"self:cover-level:greater-prone"}]}],selector:"ac",type:"circumstance",value:n},{key:"FlatModifier",predicate:["area-effect",{not:"self:cover-level:greater-prone"}],selector:"reflex",type:"circumstance",value:n},{key:"FlatModifier",predicate:[{or:["action:hide","action:sneak","avoid-detection"]},{not:"self:cover-level:greater-prone"}],selector:"stealth",type:"circumstance",value:n},{key:"FlatModifier",predicate:["action:avoid-notice",{not:"self:cover-level:greater-prone"}],selector:"initiative",type:"circumstance",value:n}],slug:"effect-cover"},type:"effect",flags:{core:{sourceId:B},[u]:{canSkip:e}}}}r(be,"createCoverSource");function Qe(t,e=void 0){if(t)return t.system.rules.find(n=>n.key==="ChoiceSet"&&(!e||n.flag===e))}r(Qe,"findChoiceSetRule");function et(t,e){let n="";for(let o of["standard","exposure"]){let i=G(t.object,o);n+=`<div class="form-group">
    <label>${p(`settings.${o}.name`)}</label>
    <input type="checkbox" name="flags.pf2e-perception.${o}" ${i?"checked":""}>
    <p class="notes">${p(`settings.${o}.short`)}</p>
</div>`}n+="<hr>",e.find('.tab[data-tab="basic"] hr').first().after(n),t.setPosition()}r(et,"renderSceneConfig");function A(t){if(t=t instanceof Token?t.document:t,!(t instanceof TokenDocument))return[];let e=t.scene.tokens.filter(n=>n!==t&&n.actor?.isOfType("creature"));if(T("encounter")){let n=game.combats.active;return n?e.filter(o=>{let i=o.actor,s=i.traits;return i.type==="familiar"||s.has("minion")||s.has("eidolon")||n.getCombatantByToken(o.id)}):e}return e}r(A,"getValidTokens");function N(t,e){let n=A(t).map(o=>o.id);return e.filter(o=>{let i=o instanceof Token||o instanceof TokenDocument?o.id:o;return n.includes(i)})}r(N,"validateTokens");function G(t,e){return O(t,e)??T(e)}r(G,"getSceneSetting");function J(t,e=1){let n=Object.getPrototypeOf(t);return e>1?J(n,e-1):n}r(J,"getPrototype");function Ce(t,e){return t.name.localeCompare(e.name)}r(Ce,"sortByName");var R=class extends Application{#e;#s;#t;#n;#o;constructor({token:e,resolve:n,selected:o=[]},i={}){super(i),this.#e=e,this.#s=n,this.#t=o,this.#o=(s,c)=>{let a=s.id,l=this.element.find("[data-token-id]");l.removeClass("hover"),c&&l.filter(`[data-token-id=${a}]`).addClass("hover")},Hooks.on("hoverToken",this.#o)}async close(e={}){Hooks.off("hoverToken",this.#o),this.#s?.(e.resolve??!1),super.close(e)}static get defaultOptions(){return mergeObject(super.defaultOptions,{minimizable:!1})}static async openMenu(e,n={}){if(e.token instanceof TokenDocument&&(e.token=e.token.object),!e.token){ui.notifications.error(p("menu.no-token"));return}n.id=`${u}-${e.token.document.uuid}`;let o=Object.values(ui.windows).find(i=>i.id===n.id);return o&&o.close(),new Promise(i=>{e.resolve=i,new this(e,n).render(!0)})}static createPropertyData(e,n,o){let i=D[o],s=e[o]??i,c=n[o]??i;return{original:s,current:c,changed:s!==c,custom:c!==i,originalCustom:s!==i}}get token(){return this.#e}get document(){return this.#e.document}get actor(){return this.#e.actor}get scene(){return this.#e.scene}get selected(){return this.#t.length?N(this.token,this.#t):[]}get currentData(){return deepClone(this.#i)}get#i(){return this.#n||(this.#n=this.getSavedData()),this.#n}getSavedData(){let e=S(this.document)??{};return deepClone(e)}reset(){this.#n=this.getSavedData(),this.#t=[],this.render()}isSelected(e){let n=typeof e=="object"?e.id:e;return this.#t.includes(n)}getData(e){let n=me.map(o=>({value:o,label:p(`cover.${o}`)}));return{i18n:p,covers:j(this.actor)?n:n.slice(0,-1),visibilities:se.map(o=>({value:o,label:p(`visibility.${o}`)}))}}activateListeners(e){e.find("[data-token-id]").on("mouseenter",n=>{let{tokenId:o}=n.currentTarget.dataset,i=this.scene.tokens.get(o)?.object;!i||i.controlled||i._onHoverIn(n,{hoverOutOthers:!0})}),e.find("[data-action=close]").on("click",()=>{this.close({resolve:!0})}),e.find("select[name=visibility], select[name=cover]").on("change",n=>{let o=n.currentTarget,i=o.name,s=D[i],c=o.value||s,a=o.closest(".token")?.dataset.tokenId,l=a?[a]:this.#t;for(let d of l)setProperty(this.#i,`${d}.${i}`,c);a?(o.classList.toggle("changed",c!==o.dataset.original),o.classList.toggle("custom",c!==s)):this.render()}),e.find("[data-action=accept]").on("click",n=>{this._saveData(this.#i),this.close({resolve:!0})})}_saveData(e){Te(this.document,e)}_setSelected(e){this.#t=e??this.element.find("[data-token-id].ui-selected").toArray().map(n=>n.dataset.tokenId)}_spliIntoAlliances(e){let n=[],o=[],i=[],s=this.actor.alliance,c=s==="party"?"opposition":s==="opposition"?"party":null;for(let a of e)if(c){let l=a.actor?a.actor.alliance:a.alliance;l===s?n.push(a):l===c?o.push(a):l===null&&i.push(a)}else i.push(a);return{allies:n.sort(Ce),neutral:i.sort(Ce),enemies:o.sort(Ce),hasTokens:n.length||o.length||i.length}}};r(R,"BaseMenu");var re=class extends R{get title(){return p("menu.perception.title",{name:this.token.name})}get template(){return P("perception")}getData(e){let n=this.selected,o=this.currentData,i=this.getSavedData(),s=A(this.token).map(({id:c,name:a,actor:l})=>{let d=o[c]??{},g=i[c]??{};return{id:c,name:a,alliance:l.alliance,cover:R.createPropertyData(g,d,"cover"),visibility:R.createPropertyData(g,d,"visibility"),selected:n.includes(c)}});return{...super.getData(e),...this._spliIntoAlliances(s)}}activateListeners(e){super.activateListeners(e),e.filter(".tokens").selectable({autoRefresh:!1,filter:".token",cancel:"header,select",stop:()=>this._setSelected()}),e.find("[data-action=select-all]").on("click",n=>{let o=$(n.currentTarget).closest("section"),i=(o.length?o:e).find("[data-token-id]"),s=i.filter(":not(.ui-selected)").length===0;i.toggleClass("ui-selected",!s),this._setSelected()}),e.find("[data-action=use-selection]").on("click",n=>{this._setSelected(canvas.tokens.controlled.map(o=>o.id)),this.render()}),e.find("[data-action=reset]").on("click",n=>this.reset())}};r(re,"PerceptionMenu");var Mt=[{x:0,y:0},{x:1,y:0},{x:0,y:1},{x:1,y:1}],Pt=[{x:.25,y:.25},{x:.5,y:.25},{x:.75,y:.25},{x:.25,y:.5},{x:.5,y:.5},{x:.75,y:.5},{x:.25,y:.75},{x:.5,y:.75},{x:.75,y:.75}];function tt(t,e){let n=1-e;return{top:{A:w({x:e,y:e},t),B:w({x:n,y:e},t)},right:{A:w({x:n,y:e},t),B:w({x:n,y:n},t)},bottom:{A:w({x:n,y:n},t),B:w({x:e,y:n},t)},left:{A:w({x:e,y:n},t),B:w({x:e,y:e},t)}}}r(tt,"getRectEdges");function ce(t,e,n=!1){return n&&V(t,e),CONFIG.Canvas.polygonBackends.move.testCollision(t,e,{type:"move",mode:"any"})}r(ce,"lineIntersectWall");function Se(t,e,n=!1){for(let o of Ut(e.bounds))if(ce(t,o,n))return!0;return!1}r(Se,"pointToTokenIntersectWall");function w(t,e){return{x:e.x+e.width*t.x,y:e.y+e.height*t.y}}r(w,"getRectPoint");function z(){canvas.controls.debug.clear()}r(z,"clearDebug");function V(t,e,n="blue"){let o=n==="blue"?26316:n==="red"?16711680:1483011;canvas.controls.debug.lineStyle(4,o).moveTo(t.x,t.y).lineTo(e.x,e.y)}r(V,"drawDebugLine");function*Ut(t){for(let e of Pt)yield w(e,t)}r(Ut,"rectSpread");function*nt(t){for(let e of Mt)yield w(e,t)}r(nt,"rectCorners");function xe(t,e=!1){if(t=t instanceof Token?t:t.object,t.document.hasStatusEffect(CONFIG.specialStatusEffects.INVISIBLE))return;let n=t.scene;if(n!==canvas.scene||!n.tokenVision||n.darkness<n.globalLightThreshold||!G(n,"exposure"))return;e&&z();let o=t.document.bounds,i=null;for(let s of canvas.effects.lightSources){if(!s.active)continue;let c=s.data.bright,a=s.data.dim;if(s.object===t){if(c)return"bright";a&&(i="dim");continue}let l=[];for(let d of nt(o))s.shape.contains(d.x,d.y)?l.push(d):e&&V(s,d,"red");if(l.length){if(s.ratio===1)return e&&V(s,l,"green"),"bright";if(s.ratio===0){e&&V(s,l,"blue"),i="dim";continue}for(let d of l)if(new Ray(s,d).distance<=c)if(e)V(s,d,"green"),i="bright";else return"bright";else e?(V(s,d,"blue"),i!=="bright"&&(i="dim")):i="dim"}}return i}r(xe,"getLightExposure");function ot(t,e){!qe()||!t.object.actor?.isOfType("creature")||(e.find(".col.left").append('<div class="control-icon" data-action="pf2e-perception"><i class="fa-solid fa-eye"></i></div>'),e.find("[data-action=pf2e-perception]").on("click",n=>re.openMenu({token:t.object})))}r(ot,"renderTokenHUD");function it(t,e){for(let n of e)delete n.flags?.[u]}r(it,"pasteToken");function S(t,...e){return e.unshift("data"),t=t instanceof Token?t.document:t,O(t,e.join("."))}r(S,"getTokenData");async function st(t){return t=t instanceof Token?t.document:t,Ke(t,"data")}r(st,"clearTokenData");async function Te(t,e){let n=A(t).map(i=>i.id),o={};for(let i in e){if(!n.includes(i)){o[`flags.${u}.data.-=${i}`]=!0;continue}let s=e[i],c=S(t,i)??{};if(s.visibility===D.visibility&&delete s.visibility,s.cover===D.cover&&delete s.cover,!(c.cover===s.cover&&c.visibility===s.visibility))if(!s.visibility&&!s.cover)o[`flags.${u}.data.-=${i}`]=!0;else for(let a of["cover","visibility"])c[a]!==s[a]&&(s[a]?o[`flags.${u}.data.${i}.${a}`]=s[a]:o[`flags.${u}.data.${i}.-=${a}`]=!0)}return t=t instanceof Token?t.document:t,t.update(o)}r(Te,"setTokenData");function Ie(t,e,n=!1){let o=t.scene;if(!G(o,"standard"))return!1;n&&z();let i=T("standard-type");if(i==="center")return ce(t.center,e.center,n);if(i==="points")return Se(t.center,e,n)}r(Ie,"hasStandardCover");var W={tiny:0,sm:1,med:2,lg:3,huge:4,grg:5};function Ee(t,e,n=!1){let o=T("lesser");if(o==="none")return;let i,s=t.center,c=e.center;n&&(z(),V(s,c));let a=r(f=>{let C=W[f.actor.size];return C-l>=2&&C-d>=2},"isExtraLarge"),l=W[t.actor.size],d=W[e.actor.size],g=t.scene.tokens.contents.filter(f=>f.actor).sort((f,C)=>W[C.actor.size]-W[f.actor.size]),h=l<W.huge&&d<W.huge&&g.filter(a).length,k=o==="ten"?.1:o==="twenty"?.2:0,m=r(f=>(n&&V(f.A,f.B,"red"),lineSegmentIntersects(s,c,f.A,f.B)),"intersectsEdge"),y=o==="cross"?f=>m(f.top)&&m(f.bottom)||m(f.left)&&m(f.right):f=>Object.values(f).some(C=>m(C));for(let f of g){let C=f.object;if(f.hidden||C===t||C===e)continue;let I=tt(C.bounds,k);if(y(I))return h?"standard":"lesser";a(f)&&h--}return i}r(Ee,"getCreatureCover");function Q(t,e){let n=(()=>{let l=t.actor,d=["unnoticed","undetected","hidden","concealed"];for(let g of d)if(l.hasCondition(g))return g})(),o=S(t,e.id,"visibility"),i=v[n]>v[o]?n:o,s=v[i];if(s>=v.undetected)return i;let c=xe(t),a=c==="dim"?"concealed":c===null?"hidden":void 0;return s>v[a]?i:a}r(Q,"getVisibility");function rt(t,e,n,o){let i=e.flags?.["pf2e-perception"];if(i&&(i.data||i["-=data"]!==void 0)){if(t.object.renderFlags.set({refreshVisibility:!0}),game.user.isGM)return;let s=Hooks.on("refreshToken",c=>{!t.object!==c&&(Hooks.off("refreshToken",s),game.combat?.getCombatantByToken(t.id)&&ui.combat.render())})}}r(rt,"updateToken");function ct(t,e){e?De(t):ee(t)}r(ct,"hoverToken");function at(t){ee(t),game.user.isGM||ui.combat.render()}r(at,"deleteToken");function lt(t){ee(t),Hooks.once("sightRefresh",()=>t.hover&&De(t))}r(lt,"controlToken");function ee(t){if(!t?.id)return $(".pf2e-conditionals").remove();$(`.pf2e-conditionals[data-hover-id=${t.id}]`).remove(),$(`.pf2e-conditionals[data-token-id=${t.id}]`).remove()}r(ee,"clearConditionals");function De(t){let e=A(t);for(let n of e)Ve(n,t)}r(De,"showAllConditionals");async function Ve(t,e){if(t=t instanceof Token?t:t.object,!t.visible||!t.actor?.isOfType("creature"))return;let n=S(t,e.id);if(isEmpty(n))return;if(!game.user.isGM&&!e.document.hasPlayerOwner&&v[n.visibility]>=v.hidden){if(!n.cover)return;n={cover:n.cover}}let o=t.worldTransform.a,i=canvas.clientCoordinatesFromCanvas(t.document._source),s=`<div class="pf2e-conditionals" data-hover-id="${t.id}" data-token-id="${e.id}" `;s+=`style="top: ${i.y}px; left: ${i.x+t.hitArea.width*o/2}px;">`;let c=T("icon-path");Object.entries(n).map(([a,l])=>{let d=a==="cover"?"cover":l,g=c[d]||ke[d];(g.startsWith("systems")||g.startsWith("modules"))&&(g=`../../../${g}`),s+=`<div class="conditional"><img src="${g}"></img></div>`}),s+="</div>",$(document.body).append(s)}r(Ve,"showConditionals");function dt(t,e){let n=t(e);if(e==="origin"&&canvas.ready){let o=U(this);o&&n.push(`origin:tokenid:${o.id}`)}return n}r(dt,"getSelfRollOptions");function ut(t,e,n){let o=e.find(l=>l.startsWith("origin:tokenid:"))?.slice(15);if(!o)return t(e,n);let i=U(this,!0),s=i?.scene.tokens.get(o).object;if(!s||!i)return t(e,n);let c=Pe(s,i,e);c&&n.push(be(c,!0));let a=Q(s,i);if(v[a]>v.concealed){if(v[a]===v.hidden&&Me(i.actor,ge))return t(e,n);n.push(Je(a))}return t(e,n)}r(ut,"getContextualClone");function U(t,e=!1){if(!t)return;let n=t.id,o=t.isToken;return(e?game.user.targets:canvas.tokens.controlled).find(s=>o?s.actor===t:s.actor.id===n)??t.getActiveTokens().shift()??null}r(U,"getActorToken");function j(t){return t.itemTypes.condition.some(e=>e.slug==="prone")}r(j,"isProne");function ae(t,e=!1){let n=t.itemTypes.effect.find(o=>o.sourceId===B);return e?Qe(n)?.selection.level:n}r(ae,"getCoverEffect");function Me(t,e){return t.itemTypes.feat.find(n=>n.sourceId===e)}r(Me,"getFeatWithUUID");function Pe(t,e,n,o=!1){let s=n.includes("item:ranged")?j(e.actor):!1,c=ae(e.actor,!0);if(s&&x[c]>x.lesser)return"greater-prone";!s&&c==="greater-prone"&&(c=void 0);let a=S(e,t.id,"cover");return s&&x[a]>x.lesser||(!s&&a==="greater-prone"&&(a=void 0),x[a]<x.standard&&x[c]<x.standard&&Ie(t,e,o)?a="standard":!a&&!c&&t.distanceTo(e)>5&&(a=Ee(t,e,o)),s&&x[a]>x.lesser)?"greater-prone":x[a]>x[c]?a:void 0}r(Pe,"getConditionalCover");function gt(t,e){let n=t.token;if(!n)return;let o=game.user.isGM,i=n.hasPlayerOwner,{cover:s,selected:c,skipWait:a,validated:l,blindCheck:d,pointOut:g}=Xe(t),h=t.getFlag("pf2e","context");if(d&&!o&&i)e.find(".message-sender").text(n.name),e.find(".flavor-text").html(d);else if(s){if(o){let k=Ne({property:"cover",skipWait:a,validated:l});e.find(".message-content").append(k),e.find("[data-action=validate-cover]").on("click",()=>{Y.openMenu({token:n,selected:c,value:s,message:t})})}else if(!a){let k=Ue("cover",l);e.find(".message-content").append(k)}}else if(h?.visibility){l||e.find(".message-buttons").remove();let k=e.find(".flavor-text");!o&&i&&(e.find(".message-sender").text(n.name),k.empty());let m=p(`message.flat-check.${l===void 0?"blind":l?"success":"failure"}`),y=ht(m,l);if(k.append(y),o)for(let f of["success","failure"])k.append(He({action:`${f}-message`,icon:"fa-solid fa-message",label:p("message.flat-check.button",f)})),e.find(`[data-action=${f}-message]`).on("click",()=>{we(t,"validated",f==="success")})}else if(h?.type==="skill-check")o?h.options.includes("action:hide")&&pt({token:n,html:e,message:t,skipWait:a,validated:l,selected:h.selected,ValidationMenu:Z}):i&&h.options.includes("action:hide")&&ft({token:n,message:t,html:e,validated:l});else if(h?.type==="perception-check")o?h.options.includes("action:seek")&&pt({token:n,html:e,message:t,skipWait:a,validated:l,selected:h.selected,ValidationMenu:K}):i&&h.options.includes("action:seek")&&ft({token:n,message:t,html:e,validated:l});else if(g){let k=n.scene.tokens.get(g);if(!k)return;if(o){let m='<div style="display: grid; grid-template-columns: 1fr auto; gap: 3px">';m+=Ne({property:"visibility",skipWait:a,validated:l}),m+=He({action:"ping-token",icon:"fa-solid fa-signal-stream"}),m+="</div>",e.find(".message-content").append(m),e.find("[data-action=validate-visibility]").on("click",async()=>{le.openMenu({message:t,token:k,originator:n,selected:canvas.tokens.controlled.map(y=>y.id)})}),e.find("[data-action=ping-token]").on("click",()=>{canvas.ping(k.center)})}else if(i){let m=Ue("visibility",l);e.find(".message-content").append(m)}}}r(gt,"renderChatMessage");function mt(t){O(t,"validated")||we(t,"validated",!0)}r(mt,"validateMessage");function ft({html:t,token:e,message:n,validated:o}){t.find(".message-sender").text(e.name);let i=n.getFlag("pf2e","modifierName");i+=Ue("visibility",o),t.find(".flavor-text").html(i)}r(ft,"addBlindSkillCheckFlavor");function Ue(t,e){let n=p(`message.${t}.player.${e?"validated":"wait"}`);return ht(n,e)}r(Ue,"createWaitHint");function ht(t,e){return e===!0?t='<i class="fa-solid fa-check" style="color: green;"></i> '+t:e===!1&&(t='<i class="fa-solid fa-xmark" style="color: red;"></i> '+t),`<i style="display: block; font-size: .9em; text-align: end;">${t}</i>`}r(ht,"createHint");function pt({skipWait:t,validated:e,html:n,message:o,ValidationMenu:i,token:s,selected:c}){let a=Ne({property:"visibility",skipWait:t,validated:e});n.find(".flavor-text").append(a),n.find("[data-action=validate-visibility]").on("click",async()=>{let l=o.rolls[0];i.openMenu({token:s,message:o,roll:l,selected:c})})}r(pt,"addVisibilityValidationButton");function Ne({skipWait:t,validated:e,property:n}){let o=p(`message.${n}.gm.${t?"check":e?"validated":"validate"}`);return!t&&e&&(o+='<i class="fa-solid fa-check" style="color: green; margin-left: 0.3em;"></i>'),He({action:`validate-${n}`,icon:"fa-solid fa-list",label:o})}r(Ne,"createValidateButton");function He({action:t,icon:e,label:n}){let o=`<button type="button" style="margin: 0 0 5px; padding-block: 0;" data-action="${t}">`;return e&&(o+=`<i class="${e}" ${n?"":'style="margin: 0;"'}></i>`),n&&(o+=`${e?" ":""}${n}`),o+="</button>",o}r(He,"createChatButton");async function Be({content:t,token:e,flags:n,secret:o}){let i={content:t,speaker:ChatMessage.getSpeaker({token:e instanceof Token?e.document:e})};return n&&setProperty(i,`flags.${u}`,n),o&&(i.type=CONST.CHAT_MESSAGE_TYPES.WHISPER,i.whisper=ChatMessage.getWhisperRecipients("gm")),ChatMessage.create(i)}r(Be,"createTokenMessage");var Ae={LOWER_BY_TWO:-2,LOWER:-1,INCREASE:1,INCREASE_BY_TWO:2,TO_CRITICAL_FAILURE:"criticalFailure",TO_FAILURE:"failure",TO_SUCCESS:"success",TO_CRITICAL_SUCCESS:"criticalSuccess"},vt=["criticalFailure","failure","success","criticalSuccess"],Oe,kt,te,$e,X,de,Fe,yt,H=class{constructor(e,n,o=null){ie(this,Oe);ie(this,te);ie(this,X);ie(this,Fe);e instanceof Roll?(this.dieResult=(e.isDeterministic?e.terms.find(i=>i instanceof NumericTerm):e.dice.find(i=>i instanceof Die&&i.faces===20))?.total??1,this.rollTotal=e.total):(this.dieResult=e.dieValue,this.rollTotal=e.dieValue+e.modifier),this.dc=typeof n=="number"?{value:n}:n,this.unadjusted=L(this,Fe,yt).call(this),this.adjustment=L(this,Oe,kt).call(this,this.unadjusted,o),this.value=this.adjustment?L(this,te,$e).call(this,this.adjustment.amount,this.unadjusted):this.unadjusted}},E=H;r(E,"DegreeOfSuccess"),Oe=new WeakSet,kt=r(function(e,n){if(!n)return null;for(let o of["all",...vt]){let{label:i,amount:s}=n[o]??{};if(s&&i&&!(e===H.CRITICAL_SUCCESS&&s===Ae.INCREASE)&&!(e===H.CRITICAL_FAILURE&&s===Ae.LOWER)&&(o==="all"||vt.indexOf(o)===e))return{label:i,amount:s}}return null},"#getDegreeAdjustment"),te=new WeakSet,$e=r(function(e,n){switch(e){case"criticalFailure":return 0;case"failure":return 1;case"success":return 2;case"criticalSuccess":return 3;default:return Math.clamped(n+e,0,3)}},"#adjustDegreeOfSuccess"),X=new WeakSet,de=r(function(e){return this.dieResult===20?L(this,te,$e).call(this,Ae.INCREASE,e):this.dieResult===1?L(this,te,$e).call(this,Ae.LOWER,e):e},"#adjustDegreeByDieValue"),Fe=new WeakSet,yt=r(function(){let e=this.dc.value;return this.rollTotal-e>=10?L(this,X,de).call(this,H.CRITICAL_SUCCESS):e-this.rollTotal>=10?L(this,X,de).call(this,H.CRITICAL_FAILURE):this.rollTotal>=e?L(this,X,de).call(this,H.SUCCESS):L(this,X,de).call(this,H.FAILURE)},"#calculateDegreeOfSuccess"),oe(E,"CRITICAL_FAILURE",0),oe(E,"FAILURE",1),oe(E,"SUCCESS",2),oe(E,"CRITICAL_SUCCESS",3);var Nt={burst:"circle",emanation:"circle",line:"ray",cone:"cone",rect:"rect"};function bt(t,e){Bt({type:t,token:e,distance:t==="cone"?30:15,traits:["concentrate","secret"]})}r(bt,"createSeekTemplate");function Ht(t){return t.scene.templates.find(e=>O(e,"tokenId")===t.id)}r(Ht,"getTokenTemplate");function Ct(t){if(!Tt(t))return null;let e=Ht(t);return e?Gt(e.object):null}r(Ct,"getTokenTemplateTokens");async function ue(t){let e=t.scene.templates.filter(n=>O(n,"tokenId")===t.id);for(let n of e)await n.delete()}r(ue,"deleteTokenTemplate");function Tt(t){return canvas.scene===t.scene?!0:(ui.notifications.error(p("template.scene")),!1)}r(Tt,"checkScene");function Bt({type:t,distance:e,traits:n,fillColor:o,width:i,token:s}){if(!Tt(s))return;let c={distance:e,t:Nt[t],fillColor:o||game.user.color,flags:{[u]:{tokenId:s.id}}};c.t==="ray"?c.width=i||CONFIG.MeasuredTemplate.defaults.width*(canvas.dimensions?.distance??1):c.t==="cone"&&(c.angle=CONFIG.MeasuredTemplate.defaults.angle),n&&setProperty(c,"flags.pf2e.origin.traits",n);let a=new CONFIG.MeasuredTemplate.documentClass(c,{parent:canvas.scene});new CONFIG.MeasuredTemplate.objectClass(a).drawPreview()}r(Bt,"createTemplate");function Gt(t,{collisionOrigin:e,collisionType:n="move"}={}){if(!canvas.scene)return[];let{grid:o,dimensions:i}=canvas;if(!(o&&i))return[];let s=o.getHighlightLayer(t.highlightId);if(!s||o.type!==CONST.GRID_TYPES.SQUARE)return[];let c=e??t.center,a=canvas.tokens.quadtree.getObjects(s.getLocalBounds(void 0,!0)),l=[];for(let d of a){let g=d.document,h=[];for(let k=0;k<g.height;k++){let m=d.y+k*o.size;if(h.push(`${d.x}.${m}`),g.width>1)for(let y=1;y<g.width;y++)h.push(`${d.x+y*o.size}.${m}`)}for(let k of h){if(!s.positions.has(k))continue;let[m,y]=k.split(".").map(I=>Number(I)),f={x:m+i.size*.5,y:y+i.size*.5};if(f.x<0||f.y<0)continue;if(!(canvas.ready&&n&&CONFIG.Canvas.polygonBackends[n].testCollision(c,f,{type:n,mode:"any"}))){l.push(d);break}}}return l}r(Gt,"getTokens");var fe=class extends R{static async openMenu(e,n){let o=await super.openMenu(e,n);return o&&e.message&&mt(e.message),o}get title(){return p("menu.validation.title",{name:this.token.name})}get template(){return P("validation")}get selected(){let e=super.selected;if(e.length)return e;let n=this.token,o=n.actor.alliance;return A(n).filter(i=>i.actor.alliance!==o).map(i=>i.id)}getSavedData(e=!0){let n=super.getSavedData();return e?this._convertData(n):n}_convertData(e){let n=this.property,o=this.scene,i=this.selected,s=D[n],c=n==="cover"?me:se;for(let a of i){let l=o.tokens.get(a),d=`${a}.${n}`,g=getProperty(e,d)??s,h=this.processValue({token:l,value:g});c.includes(h)||(h=g),g!==h&&setProperty(e,d,h)}return e}processValue(e){throw new Error(`${this.constructor.name} doesn't have a 'processValue' method defined`)}getData(e){let{covers:n,visibilities:o,i18n:i}=super.getData(e),s=this.currentData,c=this.getSavedData(!1),a=this.property,l=this.selected,d=A(this.token);d=d.map(({id:h,name:k,actor:m})=>{let y=s[h]??{},f=c[h]??{};return{id:h,name:k,alliance:m.alliance,selected:l.includes(h),...R.createPropertyData(f,y,a)}});let g=T("validation");return g==="selected"?d=d.filter(h=>h.selected):g==="changed"&&(d=d.filter(h=>h.changed)),{...this._spliIntoAlliances(d),i18n:i,property:a,options:a==="cover"?n:o,showSelected:g==="all",showChanges:g!=="changed"}}activateListeners(e){super.activateListeners(e),e.find("[data-action=cancel]").on("click",n=>{this.close()})}};r(fe,"ValidationMenu");var Y=class extends fe{#e;constructor(e,n={}){super(e,n),this.#e=e.value}get property(){return"cover"}processValue(){return this.#e}};r(Y,"CoverValidationMenu");var ne=class extends fe{#e;constructor(e,n={}){super(e,n),this.#e=e.roll}get property(){return"visibility"}get roll(){return this.#e}};r(ne,"VisibilityValidationMenu");var Z=class extends ne{processValue({token:e,value:n}){let o=this.roll,i=e.actor.perception.dc.value,s=v[n],c=new E(o,i).value;return c>=E.SUCCESS&&s<v.hidden?"hidden":c<=E.FAILURE&&s>=v.hidden?"observed":n}};r(Z,"HideValidationMenu");var le=class extends ne{#e;constructor(e,n={}){super(e,n),this.#e=e.originator}get selected(){let e=this.token,n=e.actor.alliance,o=this.#e.id,i=S(e)??{};return A(e).filter(s=>{if(s.id===o||s.actor.alliance===n)return!1;let c=getProperty(i,`${s.id}.visibility`);return v[c]>=v.undetected}).map(s=>s.id)}processValue({token:e,value:n}){return v[n]>=v.undetected?"hidden":n}};r(le,"PointOutValidationMenu");var _e=class extends ne{getSavedData(e=!0){let n=this.token.id,o=A(this.token),i={};for(let s of o){let c=S(s,n);c&&(i[s.id]=deepClone(c))}return e?this._convertData(i):i}getData(){let e=super.getData();return e.isReversed=!0,e.options=se.map(n=>({value:n,label:p(`visibility.reversed.${n}`)})),e}_saveData(e){let n=this.scene,o=this.token.id,i=[];for(let[s,c]of Object.entries(e)){let a={_id:s},l=n.tokens.get(s);if(l){c.visibility===D.visibility&&delete c.visibility;let d=S(l,o);if(d?.visibility===c.visibility)continue;!d.cover&&!c.visibility?a[`flags.${u}.data.-=${o}`]=!0:c.visibility?a[`flags.${u}.data.${o}.visibility`]=c.visibility:a[`flags.${u}.data.${o}.-=visibility`]=!0}else a[`flags.${u}.data.-=${o}`]=!0;i.push(a)}n.updateEmbeddedDocuments("Token",i)}};r(_e,"ReverseVisibilityValidationMenu");var K=class extends _e{static async openMenu(e,n){await super.openMenu(e,n)&&ue(e.token)}processValue({token:e,value:n}){let o=this.roll,i=e.actor.skills.stealth.dc.value,s=v[n],c=new E(o,i).value;return c>=E.CRITICAL_SUCCESS&&s>=v.hidden||c>=E.SUCCESS&&s===v.hidden?"observed":c>=E.SUCCESS&&s>=v.undetected?"hidden":n}};r(K,"SeekValidationMenu");function xt(){let t=game.pf2e.actions.get("hide"),e=J(t,2).constructor,n=J(t.toActionVariant(),2).constructor,o=J(t,1).constructor,i=J(t.toActionVariant(),1).constructor;Kt(e,n),Zt(o,i),Wt(o,i),jt(e,n)}r(xt,"setupActions");function jt(t,e){class n extends e{async use(s={}){let c=p("action.point-out"),a=Le(s,c);a&&zt(this,a)}}r(n,"PointOutVariant");class o extends t{constructor(){super({cost:1,name:`${u}.action.point-out`,description:`${u}.action.point-out.description`,rollOptions:["action:point-out"],slug:"point-out",traits:["auditory","manipulate","visual"]})}toActionVariant(s={}){return s.name??=this.name,new n(this,s)}}r(o,"PointOut"),game.pf2e.actions.set("point-out",new o)}r(jt,"setupPointOut");async function zt({name:t,traits:e},n){let o=game.user.targets.filter(d=>d.actor).first(),i=o?S(o,n.id,"visibility"):void 0,s=o&&v[i]<v.undetected,c;if(s){let d=o.actor.skills.stealth.dc.value;c=p("message.point-out.short-check",{check:`@Check[type:perception|dc:${d}|traits:auditory,manipulate,visual|showDC:gm]`})}else c=p("message.point-out.short");let a=await renderTemplate(P("point-out"),{description:c,name:t,traits:e.map(d=>({slug:d,tooltip:CONFIG.PF2E.traitsDescriptions[d],name:CONFIG.PF2E.actionTraits[d]}))}),l={pointOut:s?o.id:void 0};Be({content:a,token:n,flags:l})}r(zt,"pointOut");function Wt(t,e){class n extends e{async use(s={}){let c=game.i18n.localize("PF2E.Actions.Seek.Title"),a=Le(s,c);if(!a)return;if(!await Yt(a))return ue(a);s.actors=[a.actor];let l=await super.use(s);if(game.user.isGM){let{selected:d}=l[0].message.getFlag("pf2e","context");d&&It({token:a,result:l,ValidationMenu:K})}return l}}r(n,"SeekVariant");class o extends t{constructor(){super({cost:1,description:"PF2E.Actions.Seek.Description",name:"PF2E.Actions.Seek.Title",notes:[{outcome:["criticalSuccess"],text:"PF2E.Actions.Seek.Notes.criticalSuccess"},{outcome:["success"],text:"PF2E.Actions.Seek.Notes.success"}],rollOptions:["action:seek"],slug:"seek",statistic:"perception",traits:["concentrate","secret"]})}toActionVariant(s){return new n(this,s)}}r(o,"Seek"),game.pf2e.actions.set("seek",new o)}r(Wt,"setupSeek");async function Yt(t){let e=game.i18n.localize("PF2E.Foot"),n='<p style="margin: 0 0.3em; text-align: center;">';return n+=`${p("dialog.seek.hint")}</p><p>`,n+=St("create-cone","fa-thin fa-cubes",game.i18n.format("PF2E.TemplateLabel",{size:30,unit:e,shape:game.i18n.localize(CONFIG.PF2E.areaTypes.cone)})),n+=St("create-burst","fa-thin fa-cubes",game.i18n.format("PF2E.TemplateLabel",{size:15,unit:e,shape:game.i18n.localize(CONFIG.PF2E.areaTypes.burst)})),n+="</p>",Dialog.wait({title:`${t.name} - ${game.i18n.localize("PF2E.Actions.Seek.Title")}`,content:n,buttons:{ok:{icon:'<i class="fa-solid fa-check"></i>',label:p("dialog.seek.accept"),callback:()=>!0},no:{icon:'<i class="fa-solid fa-xmark"></i>',label:p("dialog.seek.cancel"),callback:o=>!1}},close:()=>!1,render:o=>{o.filter(".dialog-content").find("[data-action=create-cone], [data-action=create-burst]").on("click",s=>{let{action:c}=s.currentTarget.dataset;ue(t),bt(c==="create-cone"?"cone":"burst",t)})}},{width:300,left:10})}r(Yt,"seek");function Zt(t,e){class n extends e{async use(s={}){let c=game.i18n.localize("PF2E.Actions.Hide.Title"),a=Le(s,c);if(!a)return;s.actors=[a.actor];let l=await super.use(s);return game.user.isGM&&It({token:a,result:l,ValidationMenu:Z}),l}}r(n,"HideVariant");class o extends t{constructor(){super({cost:1,description:"PF2E.Actions.Hide.Description",name:"PF2E.Actions.Hide.Title",rollOptions:["action:hide"],slug:"hide",statistic:"stealth",traits:["secret"],notes:[{outcome:["success","criticalSuccess"],text:"PF2E.Actions.Hide.Notes.success"}]})}toActionVariant(s){return new n(this,s)}}r(o,"Hide"),game.pf2e.actions.set("hide",new o)}r(Zt,"setupHide");function Kt(t,e){class n extends e{async use(s={}){let c=p("action.take-cover"),a=Le(s,c);a&&Xt(a)}}r(n,"TakeCoverVariant");class o extends t{constructor(){super({cost:1,description:"PF2E.Actions.TakeCover.Description",img:"systems/pf2e/icons/conditions-2/status_acup.webp",name:"PF2E.Actions.TakeCover.Title",slug:"take-cover"})}toActionVariant(s){return new n(this,s)}}r(o,"TakeCover"),game.pf2e.actions.set("take-cover",new o)}r(Kt,"setupCover");async function Xt(t){let e=t.actor,n=ae(e),o=N(t,game.user.targets.ids);if(n&&!o.length)return n.delete();let i=S(t)??{},s=Object.entries(i).reduce((l,[d,{cover:g}])=>(g&&(l[d]=g),l),{}),c=await renderTemplate(P("covers-dialog"),{i18n:p,hasTargets:!!o.length,hasCovers:!isEmpty(s),hasTargetCover:o.some(l=>l in s),isProne:j(e)}),a=new Dialog({title:`${t.name} - ${p("action.take-cover")}`,content:c,buttons:{},render:l=>{l.find("button").on("click",async d=>{let{level:g}=d.currentTarget.dataset,h=T("skip-cover"),k=r(async(m,y)=>{y=y?o:void 0;let f=m===D.cover?y?"remove":"remove-all":"take",C=await Be({content:p(`message.cover.${f}`,{cover:p(`cover.${m}`)}),flags:{selected:y,cover:m,skipWait:h},token:t});if(h){if(m===D.cover&&!y)return st(t);let I=deepClone(S(t))??{};for(let M of o)setProperty(I,`${M}.cover`,m);return Te(t,I)}else game.user.isGM&&Y.openMenu({token:t,selected:y,value:m,message:C})},"process");if(g==="remove-all")k(D.cover);else if(g==="remove")k(D.cover,!0);else if(o.length)k(g,!0);else{let m=be(g);e.createEmbeddedDocuments("Item",[m])}a.close()})}}).render(!0)}r(Xt,"takeCover");function Le(t,e){let n=t.tokens?.filter(s=>s.actor)??[];Array.isArray(n)||(n=[n]);let o=t.actors??[];if(Array.isArray(o)||(o=[o]),!n.length&&o.length===1&&(n=[U(o[0])].filter(Boolean)),n.length||(n=canvas.tokens.controlled.filter(s=>s.actor)),n.length||(n=[U(game.user.character)].filter(Boolean)),n.length>1){ui.notifications.warn(p("action.only-one",{action:e}));return}else if(!n.length){ui.notifications.warn(p("action.must-one",{action:e}));return}let i=n[0];if(!i?.actor?.isOfType("creature")){ui.notifications.warn(p("action.must-creature",{action:e}));return}return i}r(Le,"getSelectedToken");function St(t,e,n){return`<button type="button" data-action="${t}" style="margin: 0 0 5px; padding: 0;">
    <i class="${e}"></i> ${n}</button>
</button>`}r(St,"createButton");function It({token:t,result:e,ValidationMenu:n}){let o=e[0].roll,i=e[0].message,s=i.getFlag("pf2e","context.selected");n.openMenu({token:t,roll:o,selected:s,message:i})}r(It,"openVisibilityValidationMenu");async function Et(t,...e){let n=e[1];if(!n)return t(...e);Array.isArray(n.options)&&(n.options=new Set(n.options));let{actor:o,createMessage:i="true",type:s,token:c,target:a,isReroll:l}=n,d=c??U(o),g=a?.token,h=he.includes(s),k=T("flat-check");if(l||!i||!d||!Ze.includes(s)||h&&(!g||k==="none"))return t(...e);if(h&&g.actor){let m=Q(g,d);if(!m)return t(...e);if(m==="concealed"&&d.actor?.hasLowLightVision)return t(...e);let y=Me(o,ge);if(m==="concealed"&&y)return t(...e);let f=m==="concealed"||y?5:11,C=await new Roll("1d20").evaluate({async:!0}),I=C.total,M=I>=f,_=v[m]>=v.undetected,je=M?2:1,Re=`${game.i18n.localize("PF2E.FlatCheck")}:`;Re+=`<strong> ${game.i18n.localize(`PF2E.condition.${m}.name`)}</strong>`,Re+=(await game.pf2e.Check.createResultFlavor({target:a,degree:{value:je,unadjusted:je,adjustment:null,dieResult:I,rollTotal:I,dc:{value:f}}})).outerHTML;let ze={flavor:Re,speaker:ChatMessage.getSpeaker({token:d instanceof Token?d.document:d})};if(_){n.options.add("secret"),n.isSuccess=M,n.visibility=m;let We=`${game.i18n.localize("PF2E.FlatCheck")}:`;We+=`<strong> ${game.i18n.localize("PF2E.condition.undetected.name")}</strong>`,ze.flags={[u]:{blindCheck:We}}}if(await C.toMessage(ze,{rollMode:_?game.user.isGM?"gmroll":"blindroll":"roll"}),k!=="roll"&&!_&&!M)return}else if(n.options.has("action:hide"))n.selected=game.user.targets.ids;else if(n.options.has("action:seek")){let m=Ct(d);if(m===void 0)return t(...e);let y=m??Array.from(game.user.targets);n.selected=N(d,y).filter(f=>!f.document.hidden).map(f=>f.id)}return t(...e)}r(Et,"checkRoll");function Dt(t,e){let n=e.attr("data-appid"),{createMessage:o="true",type:i,token:s,target:c,isReroll:a,options:l,dc:d}=t.context,g=s,h=c?.token,k=c?.actor;if(a||!o||!g||!h||!k||!he.includes(i))return;let m=t[u]?.originalCover??k.itemTypes.effect.find(f=>f.sourceId===B&&O(f,"canSkip"))?.toObject();if(!m)return;t[u]?.originalCover||setProperty(t,`${u}.originalCover`,m);let y=l.has(ve.cover);e.find(".roll-mode-panel").before(`<div class="pf2e-perception">
        <div class="dialog-row ${y?"":"disabled"}">
            <span class="mod">${p("dice-checks.covers")}</span>
            <label class="exclude toggle">
                <input type="checkbox" id="app-${n}-perception-covers" ${y?"checked":""} />
                <label for="app-${n}-perception-covers"></label>
            </label>
        </div>
    </div><hr>`),e.find(`#app-${n}-perception-covers`).on("change",f=>{let C=f.currentTarget.checked;C?l.add(ve.cover):l.delete(ve.cover);let I=deepClone(k._source.items),M=I.findIndex(_=>getProperty(_,"flags.core.sourceId")===B&&getProperty(_,`flags.${u}.canSkip`));if(C&&M!==-1?I.splice(M,1):!C&&M===-1&&I.push(m),c.actor=k.clone({items:I},{keepId:!0}),d?.slug){let _=c.actor.getStatistic(d.slug)?.dc;_&&(d.value=_.value,d.statistic=_)}t.render()}),t.setPosition()}r(Dt,"renderCheckModifiersDialog");function At(t,e,n){return t(e,n)?!Ge(n)||!q(n,"basicSight")&&!qt(n):!1}r(At,"basicSightCanDetect");function $t(t,e,n){return t(e,n)?game.settings.get("pf2e","automation.rulesBasedVision")?!e.object.actor?.hasCondition("deafened")&&Ge(n)&&!q(n,"hearing"):!0:!1}r($t,"hearingCanDetect");function Ot(t,e,n){return t(e,n)?Ge(n)&&!q(n,"feelTremor"):!1}r(Ot,"feelTremorCanDetect");function Ge(t){return!!(t instanceof Token&&t.actor)}r(Ge,"isValidTarget");function Ft(t,e,n){for(let o of e){let i=S(t,o.id,"visibility");if(v[i]>=n)return!0}return!1}r(Ft,"reachesThreshold");function q(t,e,n=!1){let i=(game.user.isGM?canvas.tokens.controlled:t.scene.tokens.filter(s=>s.isOwner)).filter(s=>s.detectionModes.some(c=>c.id===e));return Ft(t,i,n?v.unnoticed:v.undetected)}r(q,"isUndetected");function qt(t){let e=canvas.tokens.controlled;return!game.user.isGM&&!e.length&&(e=t.scene.tokens.filter(n=>n.isOwner),e.length!==1)?!1:Ft(t,e,v.hidden)}r(qt,"isHidden");function _t(t,e){T("target")&&Qt(e),Jt(e)}r(_t,"renderCombatTracker");function Jt(t){if(!canvas.ready)return;let e=game.combats.viewed?.combatants;e?.size&&t.find("#combat-tracker .combatant").each((n,o)=>{let{combatantId:i}=o.dataset,s=e.get(i??"")?.token;s&&q(s,"basicSight",!0)&&o.remove()})}r(Jt,"hideUndetected");function Qt(t){t.find("[data-control=toggleTarget]").each((e,n)=>{n.addEventListener("click",o=>{o.preventDefault(),o.stopPropagation(),o.stopImmediatePropagation();let{combatantId:i}=o.currentTarget.closest(".combatant").dataset,c=game.combats.viewed.combatants.get(i??"")?.token;if(!c)return;let a=Array.from(game.user.targets).some(l=>l.document===c);c.object.setTarget(!a,{releaseOthers:!o.shiftKey})},!0)})}r(Qt,"setupToggleTarget");function Lt(t,e){let n=T("encounter");e.find(".form-group").last().after(`<div class="form-group">
    <label>${p("settings.encounter.name")}</label>
    <input type="checkbox" name="pf2e-perception.encounter" ${n?"checked":""}>
    <p class="notes">${p("settings.encounter.short")}</p>
</div>`),e.find('input[name="pf2e-perception.encounter"]').on("change",o=>{let i=o.currentTarget.checked;ye("encounter",i)})}r(Lt,"renderCombatTrackerConfig");var en=["cover","concealed","hidden","undetected","unnoticed"],pe=class extends FormApplication{static get defaultOptions(){return foundry.utils.mergeObject(super.defaultOptions,{template:P("icon-path-menu"),title:p("settings.icon-path.name"),width:500})}getData(){let e=T("icon-path");return{icons:en.map(o=>({name:o,placeholder:ke[o],value:e[o]??"",label:o==="cover"?p("icon-path.cover"):game.i18n.localize(CONFIG.PF2E.conditionTypes[o])})),i18n:p}}activateListeners(e){super.activateListeners(e),e.find("button[name=cancel]").on("click",n=>{n.prefentDefault(),this.close()})}async _updateObject(e,n){ye("icon-path",n)}};r(pe,"IconPathMenu");function Rt(){F("icon-path",Object,{},{config:!1}),game.settings.registerMenu(u,"icon-path-menu",{name:b("icon-path","name"),label:b("icon-path","label"),icon:"fa-solid fa-list",restricted:!0,type:pe}),F("permission",String,CONST.USER_ROLES.GAMEMASTER,{choices:{1:b("permission","choices.1"),2:b("permission","choices.2"),3:b("permission","choices.3"),4:b("permission","choices.4")}}),F("target",Boolean,!0,{onChange:()=>ui.combat?.render()}),F("lesser",String,"ten",{choices:{none:b("lesser","choices.none"),cross:b("lesser","choices.cross"),zero:b("lesser","choices.zero"),ten:b("lesser","choices.ten"),twenty:b("lesser","choices.twenty")}}),F("standard",Boolean,!0),F("standard-type",String,"center",{choices:{center:b("standard-type","choices.center"),points:b("standard-type","choices.points")}}),F("skip-cover",Boolean,!0),F("validation",String,"all",{choices:{all:b("validation","choices.all"),selected:b("validation","choices.selected"),changed:b("validation","choices.changed")}}),F("exposure",Boolean,!0),F("flat-check",String,"cancel",{choices:{none:b("flat-check","choices.none"),roll:b("flat-check","choices.roll"),cancel:b("flat-check","choices.cancel")}}),F("encounter",Boolean,!1)}r(Rt,"registerSettings");function b(t,e){return`${u}.settings.${t}.${e}`}r(b,"path");function F(t,e,n,o={}){game.settings.register(u,t,{name:b(t,"name"),hint:b(t,"hint"),scope:"world",config:!0,type:e,default:n,...o})}r(F,"register");var tn="game.pf2e.Check.roll",nn="CONFIG.Actor.documentClass.prototype.getContextualClone",on="CONFIG.Actor.documentClass.prototype.getSelfRollOptions",sn="CONFIG.Canvas.detectionModes.basicSight._canDetect",rn="CONFIG.Canvas.detectionModes.hearing._canDetect",cn="CONFIG.Canvas.detectionModes.feelTremor._canDetect";Hooks.once("init",()=>{Rt(),xt(),libWrapper.register(u,tn,Et),libWrapper.register(u,nn,ut),libWrapper.register(u,on,dt),libWrapper.register(u,sn,At),libWrapper.register(u,rn,$t),libWrapper.register(u,cn,Ot),game.data.users.find(e=>e._id===game.data.userId).role>=CONST.USER_ROLES.GAMEMASTER?(Hooks.on("renderSceneConfig",et),Hooks.on("renderCombatTrackerConfig",Lt)):Hooks.on("renderCombatTracker",_t)});Hooks.once("ready",()=>{game.modules.get(u).api={geometry:{clearDebug:z,lineIntersectWall:ce,pointToTokenIntersectWall:Se},token:{getCreatureCover:Ee,getVisibility:Q,clearConditionals:ee,showConditionals:Ve,showAllConditionals:De,hasStandardCover:Ie,getTokenData:S},lighting:{getLightExposure:xe},actor:{getActorToken:U,isProne:j,getCoverEffect:ae,getConditionalCover:Pe},scene:{getValidTokens:A,validateTokens:N,getSceneSetting:G},detection:{isUndetected:q}}});Hooks.on("hoverToken",ct);Hooks.on("pasteToken",it);Hooks.on("updateToken",rt);Hooks.on("deleteToken",at);Hooks.on("controlToken",lt);Hooks.on("renderTokenHUD",ot);Hooks.on("canvasPan",()=>ee());Hooks.on("renderChatMessage",gt);Hooks.on("renderCheckModifiersDialog",Dt);})();
//# sourceMappingURL=main.js.map
