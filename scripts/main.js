(()=>{var vt=Object.defineProperty;var r=(t,e)=>vt(t,"name",{value:e,configurable:!0});var R="Compendium.pf2e.other-effects.Item.I9lfZUiCwMiGogVi",se="Compendium.pf2e.feats-srd.Item.y2XeMe1F18lIyo59",k={[void 0]:0,observed:0,concealed:1,hidden:2,undetected:3,unnoticed:4},Q=["observed","concealed","hidden","undetected","unnoticed"],re=["none","lesser","standard","greater","greater-prone"],x={[void 0]:0,none:0,lesser:1,standard:2,greater:3,"greater-prone":4},I={cover:"none",visibility:"observed"},ce=["attack-roll","spell-attack-roll"],we=[...ce,"skill-check","perception-check"],ae={cover:"conditional:cover:skip"};var u="pf2e-perception";function U(t){return`modules/${u}/templates/${t}.hbs`}r(U,"templatePath");function p(...t){let e=t.at(-1),n=typeof e=="object",o=n?t.slice(0,-1):t;return o.unshift(u),game.i18n[n?"format":"localize"](o.join("."),e)}r(p,"localize");function A(t,e){return t.getFlag(u,e)}r(A,"getFlag");function be(t,e,n){return t.setFlag(u,e,n)}r(be,"setFlag");function Ve(t,e){return t.unsetFlag(u,e,!0)}r(Ve,"unsetFlag");function Le(t){return getProperty(t,`flags.${u}`)??{}}r(Le,"getFlags");function D(t){return game.settings.get(u,t)}r(D,"getSetting");function Me(t,e){return game.settings.set(u,t,e)}r(Me,"setSetting");function Pe(t){let e=game.i18n.localize(`PF2E.condition.${t}.name`);return game.pf2e.ConditionManager.getCondition("flat-footed",{name:e}).toObject()}r(Pe,"createFlatFootedSource");function le(t,e=!1){let n=x[t];return{_id:"I9lfZUiCwMiGogVi",img:"systems/pf2e/icons/conditions-2/status_acup.webp",name:p("cover",t),system:{description:{gm:"",value:"<p>When you're behind an obstacle that could block weapons, guard you against explosions, and make you harder to detect, you're behind cover. Standard cover gives you a +2 circumstance bonus to AC, to Reflex saves against area effects, and to Stealth checks to Hide, Sneak, or otherwise avoid detection. You can increase this to greater cover using the Take Cover basic action, increasing the circumstance bonus to +4. If cover is especially light, typically when it's provided by a creature, you have lesser cover, which grants a +1 circumstance bonus to AC. A creature with standard cover or greater cover can attempt to use Stealth to Hide, but lesser cover isn't sufficient.</p>"},rules:[{domain:"all",key:"RollOption",option:`self:cover-bonus:${n}`},{domain:"all",key:"RollOption",option:`self:cover-level:${t}`},{key:"FlatModifier",predicate:[{or:[{and:["self:condition:prone","item:ranged"]},{not:"self:cover-level:greater-prone"}]}],selector:"ac",type:"circumstance",value:n},{key:"FlatModifier",predicate:["area-effect",{not:"self:cover-level:greater-prone"}],selector:"reflex",type:"circumstance",value:n},{key:"FlatModifier",predicate:[{or:["action:hide","action:sneak","avoid-detection"]},{not:"self:cover-level:greater-prone"}],selector:"stealth",type:"circumstance",value:n},{key:"FlatModifier",predicate:["action:avoid-notice",{not:"self:cover-level:greater-prone"}],selector:"initiative",type:"circumstance",value:n}],slug:"effect-cover"},type:"effect",flags:{core:{sourceId:R},[u]:{canSkip:e}}}}r(le,"createCoverSource");function Re(t,e=void 0){if(t)return t.system.rules.find(n=>n.key==="ChoiceSet"&&(!e||n.flag===e))}r(Re,"findChoiceSetRule");function Ue(t,e){let n="";for(let o of["standard","concealed"]){let i=B(t.object,o);n+=`<div class="form-group">
    <label>${p(`settings.${o}.name`)}</label>
    <input type="checkbox" name="flags.pf2e-perception.${o}" ${i?"checked":""}>
    <p class="notes">${p(`settings.${o}.short`)}</p>
</div>`}n+="<hr>",e.find('.tab[data-tab="basic"] hr').first().after(n),t.setPosition()}r(Ue,"renderSceneConfig");function S(t){if(t=t instanceof Token?t.document:t,!(t instanceof TokenDocument))return[];let e=t.scene.tokens.filter(n=>n!==t&&n.actor?.isOfType("creature"));if(D("encounter")){let n=game.combats.active;return n?e.filter(o=>{let i=o.actor,s=i.traits;return i.type==="familiar"||s.has("minion")||s.has("eidolon")||n.getCombatantByToken(o.id)}):e}return e}r(S,"getValidTokens");function L(t,e){let n=S(t).map(o=>o.id);return e.filter(o=>{let i=o instanceof Token||o instanceof TokenDocument?o.id:o;return n.includes(i)})}r(L,"validateTokens");function B(t,e){return A(t,e)??D(e)}r(B,"getSceneSetting");function Z(t,e=1){let n=Object.getPrototypeOf(t);return e>1?Z(n,e-1):n}r(Z,"getPrototype");function de(t,e){return t.name.localeCompare(e.name)}r(de,"sortByName");var O=class extends Application{#e;#s;#t;#n;#o;constructor({token:e,resolve:n,selected:o=[]},i={}){super(i),this.#e=e,this.#s=n,this.#t=o,this.#o=(s,c)=>{let a=s.id,l=this.element.find("[data-token-id]");l.removeClass("hover"),c&&l.filter(`[data-token-id=${a}]`).addClass("hover")},Hooks.on("hoverToken",this.#o)}async close(e={}){Hooks.off("hoverToken",this.#o),this.#s?.(e.resolve??!1),super.close(e)}static get defaultOptions(){return mergeObject(super.defaultOptions,{minimizable:!1})}static async openMenu(e,n={}){if(e.token instanceof TokenDocument&&(e.token=e.token.object),!e.token){ui.notifications.error(p("menu.no-token"));return}n.id=`${u}-${e.token.document.uuid}`;let o=Object.values(ui.windows).find(i=>i.id===n.id);return o&&o.close(),new Promise(i=>{e.resolve=i,new this(e,n).render(!0)})}static createPropertyData(e,n,o){let i=I[o],s=e[o]??i,c=n[o]??i;return{original:s,current:c,changed:s!==c,custom:c!==i,originalCustom:s!==i}}get token(){return this.#e}get document(){return this.#e.document}get actor(){return this.#e.actor}get scene(){return this.#e.scene}get selected(){return this.#t.length?L(this.token,this.#t):[]}get currentData(){return deepClone(this.#i)}get#i(){return this.#n||(this.#n=this.getSavedData()),this.#n}getSavedData(){let e=T(this.document)??{};return deepClone(e)}reset(){this.#n=this.getSavedData(),this.#t=[],this.render()}isSelected(e){let n=typeof e=="object"?e.id:e;return this.#t.includes(n)}getData(e){let n=re.map(o=>({value:o,label:p(`cover.${o}`)}));return{i18n:(...o)=>p(...o),covers:H(this.actor)?n:n.slice(0,-1),visibilities:Q.map(o=>({value:o,label:p(`visibility.${o}`)}))}}activateListeners(e){e.find("[data-token-id]").on("mouseenter",n=>{let{tokenId:o}=n.currentTarget.dataset,i=this.scene.tokens.get(o)?.object;!i||i.controlled||i._onHoverIn(n,{hoverOutOthers:!0})}),e.find("[data-action=close]").on("click",()=>{this.close({resolve:!0})}),e.find("select[name=visibility], select[name=cover]").on("change",n=>{let o=n.currentTarget,i=o.name,s=I[i],c=o.value||s,a=o.closest(".token")?.dataset.tokenId,l=a?[a]:this.#t;for(let d of l)setProperty(this.#i,`${d}.${i}`,c);a?(o.classList.toggle("changed",c!==o.dataset.original),o.classList.toggle("custom",c!==s)):this.render()}),e.find("[data-action=accept]").on("click",n=>{this._saveData(this.#i),this.close({resolve:!0})})}_saveData(e){ue(this.document,e)}_setSelected(e){this.#t=e??this.element.find("[data-token-id].ui-selected").toArray().map(n=>n.dataset.tokenId)}_spliIntoAlliances(e){let n=[],o=[],i=[],s=this.actor.alliance,c=s==="party"?"opposition":s==="opposition"?"party":null;for(let a of e)if(c){let l=a.actor?a.actor.alliance:a.alliance;l===s?n.push(a):l===c?o.push(a):l===null&&i.push(a)}else i.push(a);return{allies:n.sort(de),neutral:i.sort(de),enemies:o.sort(de),hasTokens:n.length||o.length||i.length}}};r(O,"BaseMenu");var J=class extends O{get title(){return p("menu.perception.title",{name:this.token.name})}get template(){return U("perception")}getData(e){let n=this.selected,o=this.currentData,i=this.getSavedData(),s=S(this.token).map(({id:c,name:a,actor:l})=>{let d=o[c]??{},v=i[c]??{};return{id:c,name:a,alliance:l.alliance,cover:O.createPropertyData(v,d,"cover"),visibility:O.createPropertyData(v,d,"visibility"),selected:n.includes(c)}});return{...super.getData(e),...this._spliIntoAlliances(s)}}activateListeners(e){super.activateListeners(e),e.filter(".tokens").selectable({autoRefresh:!1,filter:".token",cancel:"header,select",stop:()=>this._setSelected()}),e.find("[data-action=select-all]").on("click",n=>{let o=$(n.currentTarget).closest("section"),i=(o.length?o:e).find("[data-token-id]"),s=i.filter(":not(.ui-selected)").length===0;i.toggleClass("ui-selected",!s),this._setSelected()}),e.find("[data-action=use-selection]").on("click",n=>{this._setSelected(canvas.tokens.controlled.map(o=>o.id)),this.render()}),e.find("[data-action=reset]").on("click",n=>this.reset())}};r(J,"PerceptionMenu");var Be=[{x:0,y:0},{x:1,y:0},{x:0,y:1},{x:1,y:1}],Te=[{x:.25,y:.25},{x:.5,y:.25},{x:.75,y:.25},{x:.25,y:.5},{x:.5,y:.5},{x:.75,y:.5},{x:.25,y:.75},{x:.5,y:.75},{x:.75,y:.75}];function He(t,e){let n=1-e;return{top:{A:E({x:e,y:e},t),B:E({x:n,y:e},t)},right:{A:E({x:n,y:e},t),B:E({x:n,y:n},t)},bottom:{A:E({x:n,y:n},t),B:E({x:e,y:n},t)},left:{A:E({x:e,y:n},t),B:E({x:e,y:e},t)}}}r(He,"getRectEdges");function ee(t,e,n=!1){return n&&M(t,e),CONFIG.Canvas.polygonBackends.move.testCollision(t,e,{type:"move",mode:"any"})}r(ee,"lineIntersectWall");function fe(t,e,n=!1){let o=e.bounds;for(let i of Te){let s=E(i,o);if(ee(t,s,n))return!0}return!1}r(fe,"pointToTokenIntersectWall");function E(t,e){return{x:e.x+e.width*t.x,y:e.y+e.height*t.y}}r(E,"getRectPoint");function z(){canvas.controls.debug.clear()}r(z,"clearDebug");function M(t,e,n="blue"){let o=n==="blue"?26316:n==="red"?16711680:1483011;canvas.controls.debug.lineStyle(4,o).moveTo(t.x,t.y).lineTo(e.x,e.y)}r(M,"drawDebugLine");function pe(t){if(t=t instanceof Token?t:t.object,t.document.hasStatusEffect(CONFIG.specialStatusEffects.INVISIBLE))return!1;let e=t.scene;return e!==canvas.scene||!e.tokenVision||e.darkness<e.globalLightThreshold||!B(e,"concealed")?!1:!Ce(t)}r(pe,"isConcealed");function Ce(t,e=!1){let n=t.bounds;e&&z();for(let o of canvas.effects.lightSources)if(!(!o.active||o.data.bright===0)){if(o.object===t)return!0;if(kt(o.object.center,n,o.data.bright,e)){if(o.data.walls===!1)return!0;for(let i of Te){let{x:s,y:c}=E(i,n);if(o.shape.contains(s,c))return e&&M(o,{x:s,y:c},"green"),!0;e&&M(o,{x:s,y:c},"blue")}}}return!1}r(Ce,"inBrightLight");function kt(t,e,n,o=!1){for(let i of Be){let s=E(i,e);if(new Ray(t,s).distance<n)return!0;o&&M(t,s,"red")}return!1}r(kt,"inBrightRange");function ze(t,e){t.object.actor?.isOfType("creature")&&(e.find(".col.left").append('<div class="control-icon" data-action="pf2e-perception"><i class="fa-solid fa-eye"></i></div>'),e.find("[data-action=pf2e-perception]").on("click",n=>J.openMenu({token:t.object})))}r(ze,"renderTokenHUD");function Ge(t,e){for(let n of e)delete n.flags?.[u]}r(Ge,"pasteToken");function T(t,...e){return e.unshift("data"),t=t instanceof Token?t.document:t,A(t,e.join("."))}r(T,"getTokenData");async function Ne(t){return t=t instanceof Token?t.document:t,Ve(t,"data")}r(Ne,"clearTokenData");async function ue(t,e){let n=S(t).map(i=>i.id),o={};for(let i in e){if(!n.includes(i)){o[`flags.${u}.data.-=${i}`]=!0;continue}let s=e[i],c=T(t,i)??{};if(s.visibility===I.visibility&&delete s.visibility,s.cover===I.cover&&delete s.cover,!(c.cover===s.cover&&c.visibility===s.visibility))if(!s.visibility&&!s.cover)o[`flags.${u}.data.-=${i}`]=!0;else for(let a of["cover","visibility"])c[a]!==s[a]&&(s[a]?o[`flags.${u}.data.${i}.${a}`]=s[a]:o[`flags.${u}.data.${i}.-=${a}`]=!0)}return t=t instanceof Token?t.document:t,t.update(o)}r(ue,"setTokenData");function ge(t,e,n=!1){let o=t.scene;if(!B(o,"standard"))return!1;n&&z();let i=D("standard-type");if(i==="center")return ee(t.center,e.center,n);if(i==="points")return fe(t.center,e,n)}r(ge,"hasStandardCover");var G={tiny:0,sm:1,med:2,lg:3,huge:4,grg:5};function me(t,e,n=!1){let o=D("lesser");if(o==="none")return;let i,s=t.center,c=e.center;n&&(z(),M(s,c));let a=r(f=>{let b=G[f.actor.size];return b-l>=2&&b-d>=2},"isExtraLarge"),l=G[t.actor.size],d=G[e.actor.size],v=t.scene.tokens.contents.sort((f,b)=>G[b.actor.size]-G[f.actor.size]),h=l<G.huge&&d<G.huge&&v.filter(a).length,g=o==="ten"?.1:o==="twenty"?.2:0,m=r(f=>(n&&M(f.A,f.B,"red"),lineSegmentIntersects(s,c,f.A,f.B)),"intersectsEdge"),y=o==="cross"?f=>m(f.top)&&m(f.bottom)||m(f.left)&&m(f.right):f=>Object.values(f).some(b=>m(b));for(let f of v){let b=f.object;if(f.hidden||b===t||b===e)continue;let C=He(b.bounds,g);if(y(C))return h?"standard":"lesser";a(f)&&h--}return i}r(me,"getCreatureCover");function K(t,e,n=!1){let o=(()=>{let c=t.actor,a=["unnoticed","undetected","hidden"];n&&a.push("concealed");for(let l of a)if(c.hasCondition(l))return l})(),i=T(t,e.id,"visibility"),s=k[o]>k[i]?o:i;return n&&k[s]<k.concealed&&!e.actor.hasLowLightVision&&pe(t)?"concealed":s}r(K,"getVisibility");function je(t,e,n,o){let i=e.flags?.["pf2e-perception"];if(i&&(i.data||i["-=data"]!==void 0)){if(t.object.renderFlags.set({refreshVisibility:!0}),game.user.isGM)return;let s=Hooks.on("refreshToken",c=>{!t.object!==c&&(Hooks.off("refreshToken",s),game.combat?.getCombatantByToken(t.id)&&ui.combat.render())})}}r(je,"updateToken");function We(t,e){e?he(t):X(t)}r(We,"hoverToken");function Ye(t){X(t),game.user.isGM||ui.combat.render()}r(Ye,"deleteToken");function Ze(t){X(t),Hooks.once("sightRefresh",()=>t.hover&&he(t))}r(Ze,"controlToken");function X(t){if(!t?.id)return $(".pf2e-conditionals").remove();$(`.pf2e-conditionals[data-hover-id=${t.id}]`).remove(),$(`.pf2e-conditionals[data-token-id=${t.id}]`).remove()}r(X,"clearConditionals");function he(t){let e=S(t);for(let n of e)xe(n,t)}r(he,"showAllConditionals");async function xe(t,e){if(t=t instanceof Token?t:t.object,!t.visible||!t.actor.isOfType("creature"))return;let n=T(t,e.id);if(isEmpty(n))return;let o=t.worldTransform.a,i=canvas.clientCoordinatesFromCanvas(t.document._source),s=`<div class="pf2e-conditionals" data-hover-id="${t.id}" data-token-id="${e.id}" `;s+=`style="top: ${i.y}px; left: ${i.x+t.hitArea.width*o/2}px;">`,Object.entries(n).map(([c,a])=>{let l=c==="cover"?"modules/pf2e-perception/images/cover":`systems/pf2e/icons/conditions/${a}`;s+=`<div class="conditional"><img src="../../../${l}.webp"></img></div>`}),s+="</div>",$(document.body).append(s)}r(xe,"showConditionals");function Ke(t,e){let n=t(e);if(e==="origin"&&canvas.ready){let o=V(this);o&&n.push(`origin:tokenid:${o.id}`)}return n}r(Ke,"getSelfRollOptions");function Xe(t,e,n){let o=e.find(l=>l.startsWith("origin:tokenid:"))?.slice(15);if(!o)return t(e,n);let i=V(this,!0),s=i?.scene.tokens.get(o).object;if(!s||!i)return t(e,n);let c=Se(s,i,e);c&&n.push(le(c,!0));let a=K(s,i);if(k[a]>k.concealed){if(k[a]===k.hidden&&Ie(i.actor,se))return t(e,n);n.push(Pe(a))}return t(e,n)}r(Xe,"getContextualClone");function V(t,e=!1){return t?(e?game.user.targets:canvas.tokens.controlled).find(o=>o.actor===t)??t.getActiveTokens().shift()??null:void 0}r(V,"getActorToken");function H(t){return t.itemTypes.condition.some(e=>e.slug==="prone")}r(H,"isProne");function te(t,e=!1){let n=t.itemTypes.effect.find(o=>o.sourceId===R);return e?Re(n)?.selection.level:n}r(te,"getCoverEffect");function Ie(t,e){return t.itemTypes.feat.find(n=>n.sourceId===e)}r(Ie,"getFeatWithUUID");function Se(t,e,n,o=!1){let i=n.includes("item:ranged"),s=i?H(e.actor):!1,c=te(e.actor,!0);if(s&&x[c]>x.lesser)return"greater-prone";!s&&c==="greater-prone"&&(c=void 0);let a=T(e,t.id,"cover");if(s&&x[a]>x.lesser)return"greater-prone";!s&&a==="greater-prone"&&(a=void 0);let l=i||n.includes("item:trait:reach")||n.includes("item:type:spell");return x[a]<x.standard&&x[c]<x.standard&&ge(t,e,o)?a="standard":!a&&!c&&l&&t.distanceTo(e)>5&&(a=me(t,e,o)),s&&x[a]>x.lesser?"greater-prone":x[a]>x[c]?a:void 0}r(Se,"getConditionalCover");function Je(t,e){let n=t.token;if(!n)return;let o=game.user.isGM,i=n.hasPlayerOwner,{cover:s,selected:c,skipWait:a,validated:l,blindCheck:d,pointOut:v}=Le(t),h=t.getFlag("pf2e","context");if(d&&!o&&i)e.find(".message-header .message-sender").text(n.name),e.find(".message-header .flavor-text").html(d);else if(s){if(o){let g=$e({property:"cover",skipWait:a,validated:l});e.find(".message-content").append(g),e.find("[data-action=validate-cover]").on("click",()=>{N.openMenu({token:n,selected:c,value:s,message:t})})}else if(!a){let g=De("cover",l);e.find(".message-content").append(g)}}else if(h?.visibility){l||e.find(".message-buttons").remove();let g=e.find(".message-header .flavor-text");!o&&i&&(e.find(".message-header .message-sender").text(n.name),g.empty());let m=p(`message.flat-check.${l===void 0?"blind":l?"success":"failure"}`),y=tt(m,l);if(g.append(y),o)for(let f of["success","failure"])g.append(Ee({action:`${f}-message`,icon:"fa-solid fa-message",label:p("message.flat-check.button",f)})),e.find(`[data-action=${f}-message]`).on("click",()=>{be(t,"validated",f==="success")})}else if(h?.type==="skill-check")o?h.options.includes("action:hide")&&Qe({token:n,html:e,message:t,skipWait:a,validated:l,selected:h.selected,ValidationMenu:j}):i&&h.options.includes("action:hide")&&qe({token:n,message:t,html:e,validated:l});else if(h?.type==="perception-check"&&h.selected?.length)o?h.options.includes("action:seek")&&Qe({token:n,html:e,message:t,skipWait:a,validated:l,selected:h.selected,ValidationMenu:W}):i&&h.options.includes("action:seek")&&qe({token:n,message:t,html:e,validated:l});else if(v){let g=n.scene.tokens.get(v);if(!g)return;if(o){let m='<div style="display: grid; grid-template-columns: 1fr auto; gap: 3px">';m+=$e({property:"visibility",skipWait:a,validated:l}),m+=Ee({action:"ping-token",icon:"fa-solid fa-signal-stream"}),m+="</div>",e.find(".message-content").append(m),e.find("[data-action=validate-visibility]").on("click",async()=>{ne.openMenu({message:t,token:g,originator:n,selected:canvas.tokens.controlled.map(y=>y.id)})}),e.find("[data-action=ping-token]").on("click",()=>{canvas.ping(g.center)})}else if(i){let m=De("visibility",l);e.find(".message-content").append(m)}}}r(Je,"renderChatMessage");function et(t){A(t,"validated")||be(t,"validated",!0)}r(et,"validateMessage");function qe({html:t,token:e,message:n,validated:o}){t.find(".message-header .message-sender").text(e.name);let i=n.getFlag("pf2e","modifierName");i+=De("visibility",o),t.find(".message-header .flavor-text").html(i)}r(qe,"addBlindSkillCheckFlavor");function De(t,e){let n=p(`message.${t}.player.${e?"validated":"wait"}`);return tt(n,e)}r(De,"createWaitHint");function tt(t,e){return e===!0?t='<i class="fa-solid fa-check" style="color: green;"></i> '+t:e===!1&&(t='<i class="fa-solid fa-xmark" style="color: red;"></i> '+t),`<i style="display: block; font-size: .9em; text-align: end;">${t}</i>`}r(tt,"createHint");function Qe({skipWait:t,validated:e,html:n,message:o,ValidationMenu:i,token:s,selected:c}){let a=$e({property:"visibility",skipWait:t,validated:e});n.find(".message-header .flavor-text").append(a),n.find("[data-action=validate-visibility]").on("click",async()=>{let l=o.rolls[0].total;i.openMenu({token:s,message:o,roll:l,selected:c})})}r(Qe,"addVisibilityValidationButton");function $e({skipWait:t,validated:e,property:n}){let o=p(`message.${n}.gm.${t?"check":e?"validated":"validate"}`);return!t&&e&&(o+='<i class="fa-solid fa-check" style="color: green; margin-left: 0.3em;"></i>'),Ee({action:`validate-${n}`,icon:"fa-solid fa-list",label:o})}r($e,"createValidateButton");function Ee({action:t,icon:e,label:n}){let o=`<button type="button" style="margin: 0 0 5px; padding-block: 0;" data-action="${t}">`;return e&&(o+=`<i class="${e}" ${n?"":'style="margin: 0;"'}></i>`),n&&(o+=`${e?" ":""}${n}`),o+="</button>",o}r(Ee,"createChatButton");async function Fe({content:t,token:e,flags:n,secret:o}){let i={content:t,speaker:ChatMessage.getSpeaker({token:e instanceof Token?e.document:e})};return n&&setProperty(i,`flags.${u}`,n),o&&(i.type=CONST.CHAT_MESSAGE_TYPES.WHISPER,i.whisper=ChatMessage.getWhisperRecipients("gm")),ChatMessage.create(i)}r(Fe,"createTokenMessage");var yt={burst:"circle",emanation:"circle",line:"ray",cone:"cone",rect:"rect"};function nt(t,e){Tt({type:t,token:e,distance:t==="cone"?30:15,traits:["concentrate","secret"]})}r(nt,"createSeekTemplate");function bt(t){return t.scene.templates.find(e=>A(e,"tokenId")===t.id)}r(bt,"getTokenTemplate");function ot(t){if(!it(t))return null;let e=bt(t);return e?Ct(e.object):null}r(ot,"getTokenTemplateTokens");async function oe(t){let e=t.scene.templates.filter(n=>A(n,"tokenId")===t.id);for(let n of e)await n.delete()}r(oe,"deleteTokenTemplate");function it(t){return canvas.scene===t.scene?!0:(ui.notifications.error(p("template.scene")),!1)}r(it,"checkScene");function Tt({type:t,distance:e,traits:n,fillColor:o,width:i,token:s}){if(!it(s))return;let c={distance:e,t:yt[t],fillColor:o||game.user.color,flags:{[u]:{tokenId:s.id}}};c.t==="ray"?c.width=i||CONFIG.MeasuredTemplate.defaults.width*(canvas.dimensions?.distance??1):c.t==="cone"&&(c.angle=CONFIG.MeasuredTemplate.defaults.angle),n&&setProperty(c,"flags.pf2e.origin.traits",n);let a=new CONFIG.MeasuredTemplate.documentClass(c,{parent:canvas.scene});new CONFIG.MeasuredTemplate.objectClass(a).drawPreview()}r(Tt,"createTemplate");function Ct(t,{collisionOrigin:e,collisionType:n="move"}={}){if(!canvas.scene)return[];let{grid:o,dimensions:i}=canvas;if(!(o&&i))return[];let s=o.getHighlightLayer(t.highlightId);if(!s||o.type!==CONST.GRID_TYPES.SQUARE)return[];let c=e??t.center,a=canvas.tokens.quadtree.getObjects(s.getLocalBounds(void 0,!0)),l=[];for(let d of a){let v=d.document,h=[];for(let g=0;g<v.height;g++){let m=d.y+g*o.size;if(h.push(`${d.x}.${m}`),v.width>1)for(let y=1;y<v.width;y++)h.push(`${d.x+y*o.size}.${m}`)}for(let g of h){if(!s.positions.has(g))continue;let[m,y]=g.split(".").map(C=>Number(C)),f={x:m+i.size*.5,y:y+i.size*.5};if(f.x<0||f.y<0)continue;if(!(canvas.ready&&n&&CONFIG.Canvas.polygonBackends[n].testCollision(c,f,{type:n,mode:"any"}))){l.push(d);break}}}return l}r(Ct,"getTokens");var ie=class extends O{static async openMenu(e,n){let o=await super.openMenu(e,n);return o&&e.message&&et(e.message),o}get title(){return p("menu.validation.title",{name:this.token.name})}get template(){return U("validation")}getSavedData(e=!0){let n=super.getSavedData();return e?this._convertData(n):n}_convertData(e){let n=this.property,o=this.scene,i=this.selected,s=I[n],c=n==="cover"?re:Q;for(let a of i){let l=o.tokens.get(a),d=`${a}.${n}`,v=getProperty(e,d)??s,h=this.processValue({token:l,value:v});c.includes(h)||(h=v),v!==h&&setProperty(e,d,h)}return e}processValue(e){throw new Error(`${this.constructor.name} doesn't have a 'processValue' method defined`)}getData(e){let{covers:n,visibilities:o,i18n:i}=super.getData(e),s=this.currentData,c=this.getSavedData(!1),a=this.property,l=this.selected,d=S(this.token);d=d.map(({id:h,name:g,actor:m})=>{let y=s[h]??{},f=c[h]??{};return{id:h,name:g,alliance:m.alliance,selected:l.includes(h),...O.createPropertyData(f,y,a)}});let v=D("validation");return v==="selected"?d=d.filter(h=>h.selected):v==="changed"&&(d=d.filter(h=>h.changed)),{...this._spliIntoAlliances(d),i18n:i,property:a,options:a==="cover"?n:o,showSelected:v==="all",showChanges:v!=="changed"}}activateListeners(e){super.activateListeners(e),e.find("[data-action=cancel]").on("click",n=>{this.close()})}};r(ie,"ValidationMenu");var N=class extends ie{#e;constructor(e,n={}){super(e,n),this.#e=e.value}get property(){return"cover"}get selected(){let e=super.selected;if(e.length)return e;let n=this.token,o=n.actor.alliance;return S(n).filter(i=>i.actor.alliance!==o).map(i=>i.id)}processValue(){return this.#e}};r(N,"CoverValidationMenu");var q=class extends ie{#e;constructor(e,n={}){super(e,n),this.#e=e.roll}get property(){return"visibility"}get roll(){return this.#e}};r(q,"VisibilityValidationMenu");var j=class extends q{get selected(){let e=super.selected;if(e.length)return e;let n=this.token,o=n.actor.alliance;return S(n).filter(i=>i.actor.alliance!==o).map(i=>i.id)}processValue({token:e,value:n}){let o=this.roll,i=e.actor.perception.dc.value,s=k[n];return o>=i&&s<k.hidden?"hidden":o<i&&s>=k.hidden?"observed":n}};r(j,"HideValidationMenu");var ne=class extends q{#e;constructor(e,n={}){super(e,n),this.#e=e.originator}get selected(){let e=this.token,n=e.actor.alliance,o=this.#e.id,i=T(e)??{};return S(e).filter(s=>{if(s.id===o||s.actor.alliance===n)return!1;let c=getProperty(i,`${s.id}.visibility`);return k[c]>=k.undetected}).map(s=>s.id)}processValue({token:e,value:n}){return k[n]>=k.undetected?"hidden":n}};r(ne,"PointOutValidationMenu");var ve=class extends q{getSavedData(e=!0){let n=this.token.id,o=S(this.token),i={};for(let s of o){let c=T(s,n);c&&(i[s.id]=deepClone(c))}return e?this._convertData(i):i}getData(){let e=super.getData();return e.isReversed=!0,e.options=Q.map(n=>({value:n,label:p(`visibility.reversed.${n}`)})),e}_saveData(e){let n=this.scene,o=this.token.id,i=[];for(let[s,c]of Object.entries(e)){let a={_id:s},l=n.tokens.get(s);if(l){c.visibility===I.visibility&&delete c.visibility;let d=T(l,o);if(d?.visibility===c.visibility)continue;!d.cover&&!c.visibility?a[`flags.${u}.data.-=${o}`]=!0:c.visibility?a[`flags.${u}.data.${o}.visibility`]=c.visibility:a[`flags.${u}.data.${o}.-=visibility`]=!0}else a[`flags.${u}.data.-=${o}`]=!0;i.push(a)}n.updateEmbeddedDocuments("Token",i)}};r(ve,"ReverseVisibilityValidationMenu");var W=class extends ve{static async openMenu(e,n){await super.openMenu(e,n)&&oe(e.token)}processValue({token:e,value:n}){let o=this.roll,i=e.actor.skills.stealth.dc.value,s=k[n];return o>=i+10&&s>=k.hidden||o>=i&&s===k.hidden?"observed":o>=i&&s>=k.undetected?"hidden":n}};r(W,"SeekValidationMenu");function rt(){let t=game.pf2e.actions.get("hide"),e=Z(t,2).constructor,n=Z(t.toActionVariant(),2).constructor,o=Z(t,1).constructor,i=Z(t.toActionVariant(),1).constructor;Et(e,n),$t(o,i),St(o,i),xt(e,n)}r(rt,"setupActions");function xt(t,e){class n extends e{async use(s={}){let c=p("action.take-cover"),a=ke(s,c);a&&It(this,a)}}r(n,"PointOutVariant");class o extends t{constructor(){super({cost:1,name:`${u}.action.point-out`,description:`${u}.action.point-out.description`,rollOptions:["action:point-out"],slug:"point-out",traits:["auditory","manipulate","visual"]})}toActionVariant(s={}){return s.name??=this.name,new n(this,s)}}r(o,"PointOut"),game.pf2e.actions.set("point-out",new o)}r(xt,"setupPointOut");async function It({name:t,traits:e},n){let o=game.user.targets.first(),i=o?T(o,n.id,"visibility"):void 0,s=k[i]<k.undetected,c;if(s){let d=o.actor.skills.stealth.dc.value;c=p("message.point-out.short-check",{check:`@Check[type:perception|dc:${d}|traits:auditory,manipulate,visual|showDC:gm]`})}else c=p("message.point-out.short");let a=await renderTemplate(U("point-out"),{description:c,name:t,traits:e.map(d=>({slug:d,tooltip:CONFIG.PF2E.traitsDescriptions[d],name:CONFIG.PF2E.actionTraits[d]}))}),l={pointOut:s?o.id:void 0};Fe({content:a,token:n,flags:l})}r(It,"pointOut");function St(t,e){class n extends e{async use(s={}){let c=game.i18n.localize("PF2E.Actions.Seek.Title"),a=ke(s,c);if(!a)return;if(!await Dt(a))return oe(a);s.actors=[a.actor];let l=await super.use(s);if(game.user.isGM){let{selected:d}=l[0].message.getFlag("pf2e","context");d&&ct({token:a,result:l,ValidationMenu:W})}return l}}r(n,"SeekVariant");class o extends t{constructor(){super({cost:1,description:"PF2E.Actions.Seek.Description",name:"PF2E.Actions.Seek.Title",notes:[{outcome:["criticalSuccess"],text:"PF2E.Actions.Seek.Notes.criticalSuccess"},{outcome:["success"],text:"PF2E.Actions.Seek.Notes.success"}],rollOptions:["action:seek"],slug:"seek",statistic:"perception",traits:["concentrate","secret"]})}toActionVariant(s){return new n(this,s)}}r(o,"Seek"),game.pf2e.actions.set("seek",new o)}r(St,"setupSeek");async function Dt(t){let e=game.i18n.localize("PF2E.Foot"),n='<p style="margin: 0 0.3em; text-align: center;">';return n+=`${p("dialog.seek.hint")}</p><p>`,n+=st("create-cone","fa-thin fa-cubes",game.i18n.format("PF2E.TemplateLabel",{size:30,unit:e,shape:game.i18n.localize(CONFIG.PF2E.areaTypes.cone)})),n+=st("create-burst","fa-thin fa-cubes",game.i18n.format("PF2E.TemplateLabel",{size:15,unit:e,shape:game.i18n.localize(CONFIG.PF2E.areaTypes.burst)})),n+="</p>",Dialog.wait({title:`${t.name} - ${game.i18n.localize("PF2E.Actions.Seek.Title")}`,content:n,buttons:{ok:{icon:'<i class="fa-solid fa-check"></i>',label:p("dialog.seek.accept"),callback:()=>!0},no:{icon:'<i class="fa-solid fa-xmark"></i>',label:p("dialog.seek.cancel"),callback:o=>!1}},close:()=>!1,render:o=>{o.filter(".dialog-content").find("[data-action=create-cone], [data-action=create-burst]").on("click",s=>{let{action:c}=s.currentTarget.dataset;oe(t),nt(c==="create-cone"?"cone":"burst",t)})}},{width:300,left:10})}r(Dt,"seek");function $t(t,e){class n extends e{async use(s={}){let c=game.i18n.localize("PF2E.Actions.Hide.Title"),a=ke(s,c);if(!a)return;s.actors=[a.actor];let l=await super.use(s);return game.user.isGM&&ct({token:a,result:l,ValidationMenu:j}),l}}r(n,"HideVariant");class o extends t{constructor(){super({cost:1,description:"PF2E.Actions.Hide.Description",name:"PF2E.Actions.Hide.Title",rollOptions:["action:hide"],slug:"hide",statistic:"stealth",traits:["secret"],notes:[{outcome:["success","criticalSuccess"],text:"PF2E.Actions.Hide.Notes.success"}]})}toActionVariant(s){return new n(this,s)}}r(o,"Hide"),game.pf2e.actions.set("hide",new o)}r($t,"setupHide");function Et(t,e){class n extends e{async use(s={}){let c=p("action.take-cover"),a=ke(s,c);a&&Ft(a)}}r(n,"TakeCoverVariant");class o extends t{constructor(){super({cost:1,description:"PF2E.Actions.TakeCover.Description",img:"systems/pf2e/icons/conditions-2/status_acup.webp",name:"PF2E.Actions.TakeCover.Title",slug:"take-cover"})}toActionVariant(s){return new n(this,s)}}r(o,"TakeCover"),game.pf2e.actions.set("take-cover",new o)}r(Et,"setupCover");async function Ft(t){let e=t.actor,n=te(e),o=L(t,game.user.targets.ids);if(n&&!o.length)return n.delete();let i=T(t)??{},s=Object.entries(i).reduce((l,[d,{cover:v}])=>(v&&(l[d]=v),l),{}),c=await renderTemplate(U("covers-dialog"),{i18n:l=>p(l),hasTargets:!!o.length,hasCovers:!isEmpty(s),hasTargetCover:o.some(l=>l in s),isProne:H(e)}),a=new Dialog({title:`${t.name} - ${p("action.take-cover")}`,content:c,buttons:{},render:l=>{l.find("button").on("click",async d=>{let{level:v}=d.currentTarget.dataset,h=D("skip-cover"),g=r(async(m,y)=>{y=y?o:void 0;let f=m===I.cover?y?"remove":"remove-all":"take",b=await Fe({content:p(`message.cover.${f}`,{cover:p(`cover.${m}`)}),flags:{selected:y,cover:m,skipWait:h},token:t});if(h){if(m===I.cover&&!y)return Ne(t);let C=deepClone(T(t))??{};for(let _ of o)setProperty(C,`${_}.cover`,m);return ue(t,C)}else game.user.isGM&&N.openMenu({token:t,selected:y,value:m,message:b})},"process");if(v==="remove-all")g(I.cover);else if(v==="remove")g(I.cover,!0);else if(o.length)g(v,!0);else{let m=le(v);e.createEmbeddedDocuments("Item",[m])}a.close()})}}).render(!0)}r(Ft,"takeCover");function ke(t,e){let n=t.tokens??[];Array.isArray(n)||(n=[n]);let o=t.actors??[];if(Array.isArray(o)||(o=[o]),!n.length&&o.length===1&&(n=[V(o[0])].filter(Boolean)),n.length||(n=canvas.tokens.controlled),n.length||(n=[V(game.user.character)].filter(Boolean)),n.length>1){ui.notifications.warn(p("action.only-one",{action:e}));return}else if(!n.length){ui.notifications.warn(p("action.must-one",{action:e}));return}let i=n[0];if(!i?.actor.isOfType("creature")){ui.notifications.warn(p("action.must-creature",{action:e}));return}return i}r(ke,"getSelectedToken");function st(t,e,n){return`<button type="button" data-action="${t}" style="margin: 0 0 5px; padding: 0;">
    <i class="${e}"></i> ${n}</button>
</button>`}r(st,"createButton");function ct({token:t,result:e,ValidationMenu:n}){let o=e[0].roll.total,i=e[0].message,s=i.getFlag("pf2e","context.selected");n.openMenu({token:t,roll:o,selected:s,message:i})}r(ct,"openVisibilityValidationMenu");async function at(t,...e){let n=e[1];if(!n)return t(...e);Array.isArray(n.options)&&(n.options=new Set(n.options));let{actor:o,createMessage:i="true",type:s,token:c,target:a,isReroll:l}=n,d=c??V(o),v=a?.token,h=ce.includes(s);if(l||!i||!d||!we.includes(s)||h&&!v)return t(...e);if(h){let g=K(v,d,!0);if(!g)return t(...e);if(g==="concealed"&&d.actor.hasLowLightVision)return t(...e);let m=Ie(o,se);if(g==="concealed"&&m)return t(...e);let y=g==="concealed"||m?5:11,f=await new Roll("1d20").evaluate({async:!0}),b=f.total,C=b>=y,_=k[g]>=k.undetected,w=C?2:1,ye=`${game.i18n.localize("PF2E.FlatCheck")}:`;ye+=`<strong> ${game.i18n.localize(`PF2E.condition.${g}.name`)}</strong>`,ye+=(await game.pf2e.Check.createResultFlavor({target:a,degree:{value:w,unadjusted:w,adjustment:null,dieResult:b,rollTotal:b,dc:{value:y}}})).outerHTML;let Oe={flavor:ye,speaker:ChatMessage.getSpeaker({token:d instanceof Token?d.document:d})};if(_){n.options.add("secret"),n.isSuccess=C,n.visibility=g;let _e=`${game.i18n.localize("PF2E.FlatCheck")}:`;_e+=`<strong> ${game.i18n.localize("PF2E.condition.undetected.name")}</strong>`,Oe.flags={[u]:{blindCheck:_e}}}if(await f.toMessage(Oe,{rollMode:_?game.user.isGM?"gmroll":"blindroll":"roll"}),!_&&!C)return}else if(n.options.has("action:hide"))n.selected=game.user.targets.ids;else if(n.options.has("action:seek")){let g=d.actor.alliance,m=ot(d);if(!m)return t(...e);n.selected=L(d,m).filter(y=>{let f=y.actor.alliance;return!y.document.hidden&&(!f||f!==g)}).map(y=>y.id)}return t(...e)}r(at,"checkRoll");function lt(t,e){let n=e.attr("data-appid"),{createMessage:o="true",type:i,token:s,target:c,isReroll:a,options:l,dc:d}=t.context,v=s,h=c?.token,g=c?.actor;if(a||!o||!v||!h||!g||!ce.includes(i))return;let m=t[u]?.originalCover??g.itemTypes.effect.find(f=>f.sourceId===R&&A(f,"canSkip"))?.toObject();if(!m)return;t[u]?.originalCover||setProperty(t,`${u}.originalCover`,m);let y=l.has(ae.cover);e.find(".roll-mode-panel").before(`<div class="pf2e-perception">
        <div class="dialog-row ${y?"":"disabled"}">
            <span class="mod">${p("dice-checks.covers")}</span>
            <label class="exclude toggle">
                <input type="checkbox" id="app-${n}-perception-covers" ${y?"checked":""} />
                <label for="app-${n}-perception-covers"></label>
            </label>
        </div>
    </div><hr>`),e.find(`#app-${n}-perception-covers`).on("change",f=>{let b=f.currentTarget.checked;b?l.add(ae.cover):l.delete(ae.cover);let C=deepClone(g._source.items),_=C.findIndex(w=>getProperty(w,"flags.core.sourceId")===R&&getProperty(w,`flags.${u}.canSkip`));if(b&&_!==-1?C.splice(_,1):!b&&_===-1&&C.push(m),c.actor=g.clone({items:C},{keepId:!0}),d?.slug){let w=c.actor.getStatistic(d.slug)?.dc;w&&(d.value=w.value,d.statistic=w)}t.render()}),t.setPosition()}r(lt,"renderCheckModifiersDialog");function dt(t,e,n){return t(e,n)?!Ae(n)||!Y(n,"basicSight")&&!At(n):!1}r(dt,"basicSightCanDetect");function ut(t,e,n){return t(e,n)?game.settings.get("pf2e","automation.rulesBasedVision")?!e.object.actor?.hasCondition("deafened")&&Ae(n)&&!Y(n,"hearing"):!0:!1}r(ut,"hearingCanDetect");function ft(t,e,n){return t(e,n)?Ae(n)&&!Y(n,"feelTremor"):!1}r(ft,"feelTremorCanDetect");function Ae(t){return!!(t instanceof Token&&t.actor)}r(Ae,"isValidTarget");function pt(t,e,n){for(let o of e){let i=T(t,o.id,"visibility");if(k[i]>=n)return!0}return!1}r(pt,"reachesThreshold");function Y(t,e,n=!1){let i=(game.user.isGM?canvas.tokens.controlled:t.scene.tokens.filter(s=>s.isOwner)).filter(s=>s.detectionModes.some(c=>c.id===e));return pt(t,i,n?k.unnoticed:k.undetected)}r(Y,"isUndetected");function At(t){let e=canvas.tokens.controlled;return!game.user.isGM&&!e.length&&(e=t.scene.tokens.filter(n=>n.isOwner),e.length!==1)?!1:pt(t,e,k.hidden)}r(At,"isHidden");function gt(t,e){D("target")&&_t(e),Ot(e)}r(gt,"renderCombatTracker");function Ot(t){if(!canvas.ready)return;let e=game.combats.viewed?.combatants;e?.size&&t.find("#combat-tracker .combatant").each((n,o)=>{let{combatantId:i}=o.dataset,s=e.get(i??"")?.token;s&&Y(s,"basicSight",!0)&&o.remove()})}r(Ot,"hideUndetected");function _t(t){t.find("[data-control=toggleTarget]").each((e,n)=>{n.addEventListener("click",o=>{o.preventDefault(),o.stopPropagation(),o.stopImmediatePropagation();let{combatantId:i}=o.currentTarget.closest(".combatant").dataset,c=game.combats.viewed.combatants.get(i??"")?.token;if(!c)return;let a=Array.from(game.user.targets).some(l=>l.document===c);c.object.setTarget(!a,{releaseOthers:!o.shiftKey})},!0)})}r(_t,"setupToggleTarget");function mt(t,e){let n=D("encounter");e.find(".form-group").last().after(`<div class="form-group">
    <label>${p("settings.encounter.name")}</label>
    <input type="checkbox" name="pf2e-perception.encounter" ${n?"checked":""}>
    <p class="notes">${p("settings.encounter.short")}</p>
</div>`),e.find('input[name="pf2e-perception.encounter"]').on("change",o=>{let i=o.currentTarget.checked;Me("encounter",i)})}r(mt,"renderCombatTrackerConfig");function ht(){P("target",Boolean,!0,{onChange:()=>ui.combat?.render()}),P("lesser",String,"ten",{choices:{none:F("lesser","choices.none"),cross:F("lesser","choices.cross"),zero:F("lesser","choices.zero"),ten:F("lesser","choices.ten"),twenty:F("lesser","choices.twenty")}}),P("standard",Boolean,!0),P("standard-type",String,"center",{choices:{center:F("standard-type","choices.center"),points:F("standard-type","choices.points")}}),P("skip-cover",Boolean,!0),P("validation",String,"all",{choices:{all:F("validation","choices.all"),selected:F("validation","choices.selected"),changed:F("validation","choices.changed")}}),P("concealed",Boolean,!0),P("encounter",Boolean,!1)}r(ht,"registerSettings");function F(t,e){return`${u}.settings.${t}.${e}`}r(F,"path");function P(t,e,n,o={}){game.settings.register(u,t,{name:F(t,"name"),hint:F(t,"hint"),scope:"world",config:!0,type:e,default:n,...o})}r(P,"register");var wt="game.pf2e.Check.roll",Vt="CONFIG.Actor.documentClass.prototype.getContextualClone",Lt="CONFIG.Actor.documentClass.prototype.getSelfRollOptions",Mt="CONFIG.Canvas.detectionModes.basicSight._canDetect",Pt="CONFIG.Canvas.detectionModes.hearing._canDetect",Rt="CONFIG.Canvas.detectionModes.feelTremor._canDetect";Hooks.once("init",()=>{ht(),rt(),libWrapper.register(u,wt,at),libWrapper.register(u,Vt,Xe),libWrapper.register(u,Lt,Ke),libWrapper.register(u,Mt,dt),libWrapper.register(u,Pt,ut),libWrapper.register(u,Rt,ft),game.data.users.find(e=>e._id===game.data.userId).role>=CONST.USER_ROLES.GAMEMASTER?(Hooks.on("renderSceneConfig",Ue),Hooks.on("renderTokenHUD",ze),Hooks.on("renderCombatTrackerConfig",mt)):Hooks.on("renderCombatTracker",gt)});Hooks.once("ready",()=>{game.modules.get(u).api={geometry:{clearDebug:z,lineIntersectWall:ee,pointToTokenIntersectWall:fe},token:{getCreatureCover:me,getVisibility:K,clearConditionals:X,showConditionals:xe,showAllConditionals:he,hasStandardCover:ge,getTokenData:T},lighting:{isConcealed:pe,inBrightLight:Ce},actor:{getActorToken:V,isProne:H,getCoverEffect:te,getConditionalCover:Se},scene:{getValidTokens:S,validateTokens:L,getSceneSetting:B},detection:{isUndetected:Y}}});Hooks.on("hoverToken",We);Hooks.on("pasteToken",Ge);Hooks.on("updateToken",je);Hooks.on("deleteToken",Ye);Hooks.on("controlToken",Ze);Hooks.on("canvasPan",()=>X());Hooks.on("renderChatMessage",Je);Hooks.on("renderCheckModifiersDialog",lt);})();
//# sourceMappingURL=main.js.map
