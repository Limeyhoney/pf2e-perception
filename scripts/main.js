(()=>{var It=Object.defineProperty;var wi=(t,e,i)=>e in t?It(t,e,{enumerable:!0,configurable:!0,writable:!0,value:i}):t[e]=i;var a=(t,e)=>It(t,"name",{value:e,configurable:!0});var Oe=(t,e,i)=>(wi(t,typeof e!="symbol"?e+"":e,i),i),At=(t,e,i)=>{if(!e.has(t))throw TypeError("Cannot "+i)};var Wt=(t,e,i)=>(At(t,e,"read from private field"),i?i.call(t):e.get(t)),ue=(t,e,i)=>{if(e.has(t))throw TypeError("Cannot add the same private member more than once");e instanceof WeakSet?e.add(t):e.set(t,i)};var q=(t,e,i)=>(At(t,e,"access private method"),i);var Pe="Compendium.pf2e.other-effects.Item.I9lfZUiCwMiGogVi",P={[void 0]:0,observed:0,concealed:1,hidden:2,undetected:3,unnoticed:4},de=["observed","concealed","hidden","undetected","unnoticed"],U=["none","lesser","standard","greater","greater-prone"],x={[void 0]:0,none:0,lesser:1,standard:2,greater:3,"greater-prone":4},V={cover:"none",visibility:"observed"},ke=["attack-roll","spell-attack-roll"],Dt=[...ke,"skill-check","perception-check"],Ge={cover:"modules/pf2e-perception/images/cover.webp",concealed:"systems/pf2e/icons/conditions/concealed.webp",hidden:"systems/pf2e/icons/conditions/hidden.webp",undetected:"systems/pf2e/icons/conditions/undetected.webp",unnoticed:"systems/pf2e/icons/conditions/unnoticed.webp"};var yt="#000000",ht="#656665",wt="#809e71",$t=["darkness","dance-of-darkness","ravenous-darkness"],Mt=["obscuring-mist","stinking-cloud","noxious-vapors"];var f="pf2e-perception";function X(t){return`modules/${f}/templates/${t}.hbs`}a(X,"templatePath");function h(...t){let e=t.at(-1),i=typeof e=="object",n=i?t.slice(0,-1):t;return n.unshift(f),game.i18n[i?"format":"localize"](n.join("."),e)}a(h,"localize");function w(t,e){return t.getFlag(f,e)}a(w,"getFlag");function vt(t,e,i){return t.setFlag(f,e,i)}a(vt,"setFlag");function _t(t,e){return t.unsetFlag(f,e,!0)}a(_t,"unsetFlag");function zt(t){return getProperty(t,`flags.${f}`)??{}}a(zt,"getFlags");function O(t){return game.settings.get(f,t)}a(O,"getSetting");function Ue(t,e){return game.settings.set(f,t,e)}a(Ue,"setSetting");function Lt(){return game.user.role>=O("permission")}a(Lt,"hasPermission");function pe(t){return game.i18n.localize(`PF2E.Actions.${t}.Title`)}a(pe,"getActionName");function Vt(t){let i=game.pf2e.ConditionManager.getCondition("off-guard").toObject();return i.name+=` (${game.i18n.localize(`PF2E.condition.${t}.name`)})`,i}a(Vt,"createFlatFootedSource");function Se(t,e){return e??=x[t]===3?4:x[t],{_id:"I9lfZUiCwMiGogVi",img:"systems/pf2e/icons/conditions-2/status_acup.webp",name:h("cover",t),system:{description:{gm:"",value:"<p>When you're behind an obstacle that could block weapons, guard you against explosions, and make you harder to detect, you're behind cover. Standard cover gives you a +2 circumstance bonus to AC, to Reflex saves against area effects, and to Stealth checks to Hide, Sneak, or otherwise avoid detection. You can increase this to greater cover using the Take Cover basic action, increasing the circumstance bonus to +4. If cover is especially light, typically when it's provided by a creature, you have lesser cover, which grants a +1 circumstance bonus to AC. A creature with standard cover or greater cover can attempt to use Stealth to Hide, but lesser cover isn't sufficient.</p>"},rules:[{domain:"all",key:"RollOption",option:`self:cover-bonus:${e}`},{domain:"all",key:"RollOption",option:`self:cover-level:${t}`},{key:"FlatModifier",predicate:[{or:[{and:["self:condition:prone","item:ranged"]},{not:"self:cover-level:greater-prone"}]}],selector:"ac",type:"circumstance",value:e},{key:"FlatModifier",predicate:["area-effect",{not:"self:cover-level:greater-prone"}],selector:"reflex",type:"circumstance",value:e},{key:"FlatModifier",predicate:[{or:["action:hide","action:sneak","avoid-detection"]},{not:"self:cover-level:greater-prone"}],selector:"stealth",type:"circumstance",value:e},{key:"FlatModifier",predicate:["action:avoid-notice",{not:"self:cover-level:greater-prone"}],selector:"initiative",type:"circumstance",value:e}],slug:"effect-cover"},type:"effect",flags:{core:{sourceId:Pe},[f]:{level:t,bonus:e}}}}a(Se,"createCoverSource");function Be(t,e=void 0){if(t)return t.system.rules.find(i=>i.key==="ChoiceSet"&&(!e||i.flag===e))}a(Be,"findChoiceSetRule");function Ie(t,e=!1){if(!t)return;let i=t.id,n=t.isToken;return(e?game.user.targets:canvas.tokens.controlled).find(r=>n?r.actor===t:r.actor.id===i)??t.getActiveTokens().shift()??null}a(Ie,"getActorToken");function Z(t){return t.itemTypes.condition.some(e=>e.slug==="prone")}a(Z,"isProne");function te(t,e=!1){let i=t.itemTypes.effect.find(n=>n.sourceId===Pe);return e?Be(i)?.selection.level:i}a(te,"getCoverEffect");function jt(t,e){return!t||!e||!t.system.perception?.senses?!1:(e=e.toLowerCase(),!!t.system.perception.senses.find(({type:i})=>i===e))}a(jt,"hasSense");function He(t){return jt(t,"greater-darkvision")}a(He,"hasGreaterDarkvision");function Ke(t){return jt(t,"see-invisibility")}a(Ke,"seeInvisibility");var qe={LOWER_BY_TWO:-2,LOWER:-1,INCREASE:1,INCREASE_BY_TWO:2,TO_CRITICAL_FAILURE:"criticalFailure",TO_FAILURE:"failure",TO_SUCCESS:"success",TO_CRITICAL_SUCCESS:"criticalSuccess"},Gt=["criticalFailure","failure","success","criticalSuccess"],Qe,Ut,be,Ye,ge,Ae,Xe,Bt,ie=class{constructor(e,i,n=null){ue(this,Qe);ue(this,be);ue(this,ge);ue(this,Xe);e instanceof Roll?(this.dieResult=(e.isDeterministic?e.terms.find(o=>o instanceof NumericTerm):e.dice.find(o=>o instanceof Die&&o.faces===20))?.total??1,this.rollTotal=e.total):(this.dieResult=e.dieValue,this.rollTotal=e.dieValue+e.modifier),this.dc=typeof i=="number"?{value:i}:i,this.unadjusted=q(this,Xe,Bt).call(this),this.adjustment=q(this,Qe,Ut).call(this,this.unadjusted,n),this.value=this.adjustment?q(this,be,Ye).call(this,this.adjustment.amount,this.unadjusted):this.unadjusted}},M=ie;a(M,"DegreeOfSuccess"),Qe=new WeakSet,Ut=a(function(e,i){if(!i)return null;for(let n of["all",...Gt]){let{label:o,amount:r}=i[n]??{};if(r&&o&&!(e===ie.CRITICAL_SUCCESS&&r===qe.INCREASE)&&!(e===ie.CRITICAL_FAILURE&&r===qe.LOWER)&&(n==="all"||Gt.indexOf(n)===e))return{label:o,amount:r}}return null},"#getDegreeAdjustment"),be=new WeakSet,Ye=a(function(e,i){switch(e){case"criticalFailure":return 0;case"failure":return 1;case"success":return 2;case"criticalSuccess":return 3;default:return Math.clamped(i+e,0,3)}},"#adjustDegreeOfSuccess"),ge=new WeakSet,Ae=a(function(e){return this.dieResult===20?q(this,be,Ye).call(this,qe.INCREASE,e):this.dieResult===1?q(this,be,Ye).call(this,qe.LOWER,e):e},"#adjustDegreeByDieValue"),Xe=new WeakSet,Bt=a(function(){let e=this.dc.value;return this.rollTotal-e>=10?q(this,ge,Ae).call(this,ie.CRITICAL_SUCCESS):e-this.rollTotal>=10?q(this,ge,Ae).call(this,ie.CRITICAL_FAILURE):this.rollTotal>=e?q(this,ge,Ae).call(this,ie.SUCCESS):q(this,ge,Ae).call(this,ie.FAILURE)},"#calculateDegreeOfSuccess"),Oe(M,"CRITICAL_FAILURE",0),Oe(M,"FAILURE",1),Oe(M,"SUCCESS",2),Oe(M,"CRITICAL_SUCCESS",3);function Ht(t,e){let i="",n=["standard","npc-vision"];for(let r of n){let s=Ee(t.object,r);i+=`<div class="form-group pf2e-perception-injected">
    <label>${h(`settings.${r}.name`)}</label>
    <input type="checkbox" name="flags.pf2e-perception.${r}" ${s?"checked":""}>
    <p class="notes">${h(`settings.${r}.short`)}</p>
</div>`}i+="<hr>",e.find('.tab[data-tab="basic"] hr').first().after(i);let o=e.find(".pf2e-perception-injected").toArray().reduce((r,s)=>(r+=s.clientHeight,r),0);t.setPosition({top:t.position.top-o/2})}a(Ht,"renderSceneConfig");function j(t){if(t=t instanceof Token?t.document:t,!(t instanceof TokenDocument))return[];let e=t.scene.tokens.filter(i=>i!==t&&i.actor?.isOfType("creature"));if(O("encounter")){let i=game.combats.active;return i?e.filter(n=>{let o=n.actor,r=o.traits;return o.type==="familiar"||r.has("minion")||r.has("eidolon")||i.getCombatantByToken(n.id)}):e}return e}a(j,"getValidTokens");function ne(t,e){let i=j(t).map(n=>n.id);return e.filter(n=>{let o=n instanceof Token||n instanceof TokenDocument?n.id:n;return i.includes(o)})}a(ne,"validateTokens");function Ee(t,e){return w(t,e)??O(e)}a(Ee,"getSceneSetting");async function Pt({affects:t,origin:e,target:i,item:n,domains:o,options:r}){if(!(e&&i))return[];let[s,c]=t==="target"?[e,i]:[i,e],l=[...r,s.getRollOptions(o),c.getSelfRollOptions(t)].flat(),p=n?n.isOfType("spell")?{spell:n}:{weapon:n}:{};return(await Promise.all(o.flatMap(d=>s.synthetics.ephemeralEffects[d]?.[t]??[]).map(d=>d({test:l,resolvables:p})))).flatMap(d=>d??[])}a(Pt,"extractEphemeralEffects");function Kt(t,e){if(!t.isOfType("action","melee","weapon"))return null;let{increment:i}=t.range??{};return i&&typeof e=="number"?Math.max(Math.ceil(e/i),1):null}a(Kt,"getRangeIncrement");function qt(t,e){if(!t?.isOfType("creature"))return!1;let{flanking:i}=t.attributes;return i.flankable?typeof i.offGuardable=="number"?e.level>i.offGuardable:i.offGuardable:!1}a(qt,"isOffGuardFromFlanking");function kt(t){return typeof t=="object"&&t!==null}a(kt,"isObject");function Yt(t,e){return t.includes(e)}a(Yt,"tupleHasValue");function $i(t,e){return canvas.dimensions?canvas.grid.type!==CONST.GRID_TYPES.SQUARE?canvas.grid.measureDistance(t,e):Mi(new Ray(t,e)):NaN}a($i,"measureDistance");function Mi(t,{reach:e=null}={}){if(!canvas.dimensions)return NaN;let i=canvas.dimensions.size,n=canvas.dimensions.distance,o=Math.ceil(Math.abs(t.dx/i)),r=Math.ceil(Math.abs(t.dy/i)),s=Math.ceil(Math.abs((t.dz||0)/i)),c=[o,r,s].sort((u,g)=>u-g),l={doubleDiagonal:c[0],diagonal:c[1]-c[0],straight:c[2]-c[1]},p=l.diagonal+l.doubleDiagonal>1&&e===10?1:0;return(Math.floor(l.doubleDiagonal*1.75+l.diagonal*1.5+l.straight)-p)*n}a(Mi,"measureDistanceOnGrid");function Qt({areaType:t,object:e,colors:i,document:n,collisionType:o="move",preview:r=!1,collisionOrigin:s}){if(!e.id&&!r)return;let{grid:c,dimensions:l}=canvas;if(!(c&&l))return;let p=n.angle??0,d=n.direction??45,u=c.getHighlightLayer(e.highlightId)?.clear();if(!u)return;let[g,m]=c.getCenter(n.x,n.y),[y,k]=c.grid.getGridPositionFromPixels(g,m),R=(360+(d-p*.5)%360)%360,E=(360+(d+p*.5)%360)%360,S=canvas.grid.getSnappedPosition(n.x,n.y,e.layer.gridPrecision),F=a((W,_,D)=>(W=(360+W%360)%360,_=(360+_%360)%360,D=(360+D%360)%360,W<_?D>=W&&D<=_:D>=W||D<=_),"withinAngle"),T=(()=>{if(t!=="cone")return{x:0,y:0};let W=(d>=0?360-d:-d)%360,_=S.x%l.size!==0?Math.sign(1*Math.round(Math.cos(Math.toRadians(W))*100)/100)/2:0,D=S.y%l.size!==0?-Math.sign(1*Math.round(Math.sin(Math.toRadians(W))*100)/100)/2:0;return{x:_*l.size,y:D*l.size}})(),A=Math.clamped(n.width??0,1.5,2),b=n.distance??0,N=b*A/l.distance,G=Math.ceil(N/(l.size/c.h)),ce=Math.ceil(N/(l.size/c.w)),Ce=a(W=>{if(!(t==="emanation"&&e instanceof Token))return{x:0,y:0};if(e.w<=l.size)return{x:0,y:0};let _=(e.w-l.size)/2,D=a((v,C)=>C===v?0:C>v?_:-_,"getCoordinate");return{x:D(e.center.x,W.x),y:D(e.center.y,W.y)}},"offsetEmanationOrigin");for(let W=-ce;W<ce;W++)for(let _=-G;_<G;_++){let[D,v]=canvas.grid.grid.getPixelsFromGridPosition(y+W,k+_),C={x:D+l.size*.5,y:v+l.size*.5};if(C.x<0||C.y<0)continue;let K=Ce(C),ve={x:S.x+T.x+K.x,y:S.y+T.y+K.y};if(t==="cone"){let Ot=new Ray(ve,C),Di=(360+Ot.angle/(Math.PI/180)%360)%360;if(Ot.distance>0&&!F(R,E,Di))continue}if($i(C,ve)>b)continue;canvas.ready&&CONFIG.Canvas.polygonBackends[o].testCollision(s??ve,C,{type:o,mode:"any"})?(c.grid.highlightGridPosition(u,{x:D,y:v,border:1,color:0}),u.beginFill(0,.5).moveTo(D,v).lineTo(D+l.size,v+l.size).endFill()):c.grid.highlightGridPosition(u,{x:D,y:v,border:i.border,color:i.fill})}}a(Qt,"highlightGrid");var _i={burst:"circle",emanation:"circle",line:"ray",cone:"cone",rect:"rect",cube:"rect",square:"rect"};function Ze({type:t="burst",token:e,distance:i}){St(e)&&(i??=t==="cone"?30:15,bt({type:t,distance:i,traits:["concentrate","secret"],flags:{type:"seek",tokenId:e.id,collisionType:"sight",collisionOrigin:e.center}}))}a(Ze,"createSeekTemplate");function Xt({type:t="burst",distance:e=20,conceal:i=!1}={}){bt({type:t,distance:e,fillColor:yt,flags:{type:"darkness",conceal:i}})}a(Xt,"createDarknessTemplate");function Zt({type:t="burst",distance:e=20}={}){bt({type:t,distance:e,fillColor:ht,flags:{type:"mist"}})}a(Zt,"createMistTemplate");function Jt(t,e){return e&&!St(e)?null:canvas.scene.templates.filter(i=>w(i,"type")===t)??[]}a(Jt,"getTemplates");function Je(t){return Jt("darkness",t)}a(Je,"getDarknessTemplates");function et(t){return Jt("mist",t)}a(et,"getMistTemplates");function tt(t){if(!St(t))return null;let e=canvas.scene.templates.find(n=>w(n,"type")==="seek");if(!e)return null;let i=t instanceof Token?t.document:t;return Te(e,{collisionType:"sight",collisionOrigin:i.center})}a(tt,"getSeekTemplateTokens");async function J(t){let e=t.scene.templates.filter(i=>w(i,"type")==="seek"&&w(i,"tokenId")===t.id);for(let i of e)await i.delete()}a(J,"deleteSeekTemplate");function St(t){return canvas.scene===t.scene?!0:(ui.notifications.error(h("template.scene")),!1)}a(St,"checkScene");function bt({type:t,distance:e,traits:i,fillColor:n,width:o,flags:r}){let s=_i[t],c={distance:e,t:s,fillColor:n||game.user.color,flags:{[f]:r}};switch(s){case"ray":c.width=o||CONFIG.MeasuredTemplate.defaults.width*(canvas.dimensions?.distance??1);break;case"cone":c.angle=CONFIG.MeasuredTemplate.defaults.angle;break;case"rect":{let l=c.distance??0;c.distance=Math.hypot(l,l),c.width=l,c.direction=45;break}}i&&setProperty(c,"flags.pf2e.origin.traits",i),canvas.templates.createPreview(c)}a(bt,"createTemplate");function Te(t,{collisionOrigin:e,collisionType:i="move"}={}){let n=t instanceof MeasuredTemplateDocument?t.object:t;if(!canvas.scene)return[];let{grid:o,dimensions:r}=canvas;if(!(o&&r))return[];let s=o.getHighlightLayer(n.highlightId);if(!s||o.type!==CONST.GRID_TYPES.SQUARE)return[];let c=e??n.center,l=canvas.tokens.quadtree.getObjects(s.getLocalBounds(void 0,!0)),p=[];for(let d of l){let u=d.document,g=[];for(let m=0;m<u.height;m++){let y=d.y+m*o.size;if(g.push(`${d.x}.${y}`),u.width>1)for(let k=1;k<u.width;k++)g.push(`${d.x+k*o.size}.${y}`)}for(let m of g){if(!s.positions.has(m))continue;let[y,k]=m.split(".").map(S=>Number(S)),R={x:y+r.size*.5,y:k+r.size*.5};if(R.x<0||R.y<0)continue;if(!(canvas.ready&&i&&CONFIG.Canvas.polygonBackends[i].testCollision(c,R,{type:i,mode:"any"}))){p.push(d);break}}}return p}a(Te,"getTemplateTokens");function ei(){let t=["circle","cone"].includes(this.document.t),e=canvas.grid.type===CONST.GRID_TYPES.SQUARE;if(!t||!e)return MeasuredTemplate.prototype.highlightGrid.call(this);if(!this.isVisible){canvas.grid.getHighlightLayer(this.highlightId)?.clear();return}let i=w(this.document,"collisionType"),n=w(this.document,"collisionOrigin");this.snapForShape(),Qt({areaType:Yt(["burst","cone","emanation"],this.areaType)?this.areaType:"burst",object:this,document:this.document,colors:{border:this.borderColor,fill:this.fillColor},preview:!0,collisionType:i,collisionOrigin:n})}a(ei,"highlightTemplateGrid");function ti(t){let{type:e,slug:i,castLevel:n=0}=t.getFlag("pf2e","origin")??{};e==="spell"&&($t.includes(i)?t.updateSource({fillColor:yt,[`flags.${f}`]:{type:"darkness",conceal:n>=4}}):Mt.includes(i)?t.updateSource({fillColor:ht,[`flags.${f}`]:{type:"mist"}}):i==="cloudkill"&&t.updateSource({fillColor:wt,[`flags.${f}`]:{type:"mist"}}))}a(ti,"preCreateMeasuredTemplate");function it(t){w(t,"type")==="darkness"&&canvas.perception.update({initializeVision:!0})}a(it,"onMeasuredTemplate");function Re(t,e=1){let i=Object.getPrototypeOf(t);return e>1?Re(i,e-1):i}a(Re,"getPrototype");function nt(t,e){return t.name.localeCompare(e.name)}a(nt,"sortByName");function rt(t){return t=Number(t),isNaN(t)?void 0:t}a(rt,"asNumberOnly");var Y=class extends Application{#e;#i;#t;#n;#r;constructor({token:e,resolve:i,selected:n=[]},o={}){super(o),this.#e=e,this.#i=i,this.#t=n,this.#r=(r,s)=>{let c=r.id,l=this.element.find("[data-token-id]");l.removeClass("hover"),s&&l.filter(`[data-token-id=${c}]`).addClass("hover")},Hooks.on("hoverToken",this.#r)}async close(e={}){Hooks.off("hoverToken",this.#r),this.#i?.(e.resolve??!1),super.close(e)}static get defaultOptions(){return mergeObject(Application.defaultOptions,{minimizable:!1})}static async openMenu(e,i={}){if(e.token instanceof TokenDocument&&(e.token=e.token.object),!e.token){ui.notifications.error(h("menu.no-token"));return}i.id=`${f}-${e.token.document.uuid}`;let n=Object.values(ui.windows).find(o=>o.id===i.id);return n&&n.close(),new Promise(o=>{e.resolve=o,new this(e,i).render(!0)})}static createPropertyData(e,i,n){let o=V[n],r=e[n]??o,s=i[n]??o;return{original:r,current:s,changed:r!==s,custom:s!==o,originalCustom:r!==o}}get token(){return this.#e}get document(){return this.#e.document}get actor(){return this.#e.actor}get scene(){return this.#e.scene}get selected(){return this.#t.length?ne(this.token,this.#t):[]}get currentData(){return deepClone(this.#o)}get#o(){return this.#n||(this.#n=this.getSavedData()),this.#n}getSavedData(){let e=z(this.document)??{};return deepClone(e)}reset(){this.#n=this.getSavedData(),this.#t=[],this.render()}isSelected(e){let i=typeof e=="object"?e.id:e;return this.#t.includes(i)}getData(e){return{i18n:h,covers:U.map(i=>({value:i,label:h(`cover.${i}`)})),visibilities:de.map(i=>({value:i,label:h(`visibility.${i}`)}))}}activateListeners(e){e.find("[data-token-id]").on("mouseenter",i=>{let{tokenId:n}=i.currentTarget.dataset,o=this.scene.tokens.get(n)?.object;!o||o.controlled||o._onHoverIn(i,{hoverOutOthers:!0})}),e.find("[data-action=close]").on("click",()=>{this.close({resolve:!0})}),e.find("select[name=visibility], select[name=cover]").on("change",i=>{let n=i.currentTarget,o=n.name,r=V[o],s=n.value||r,c=n.closest(".token")?.dataset.tokenId,l=c?[c]:this.#t;for(let p of l)setProperty(this.#o,`${p}.${o}`,s);c?(n.classList.toggle("changed",s!==n.dataset.original),n.classList.toggle("custom",s!==r)):this.render()}),e.find("[data-action=accept]").on("click",i=>{this._saveData(this.#o),this.close({resolve:!0})})}_saveData(e){ot(this.document,e)}_setSelected(e){this.#t=e??this.element.find("[data-token-id].ui-selected").toArray().map(i=>i.dataset.tokenId)}_spliIntoAlliances(e){let i=[],n=[],o=[],r=this.actor.alliance,s=r==="party"?"opposition":r==="opposition"?"party":null;for(let c of e)if(s){let l=c.actor?c.actor.alliance:c.alliance;l===r?i.push(c):l===s?n.push(c):l===null&&o.push(c)}else o.push(c);return{allies:i.sort(nt),neutral:o.sort(nt),enemies:n.sort(nt),hasTokens:i.length||n.length||o.length}}};a(Y,"BaseMenu");var We=class extends Y{get title(){return h("menu.perception.title",{name:this.token.name})}get template(){return X("perception")}getData(e){let i=this.selected,n=this.currentData,o=this.getSavedData(),r=j(this.token).map(({id:s,name:c,actor:l})=>{let p=n[s]??{},d=o[s]??{};return{id:s,name:c,alliance:l.alliance,cover:Y.createPropertyData(d,p,"cover"),visibility:Y.createPropertyData(d,p,"visibility"),selected:i.includes(s)}});return{...super.getData(e),...this._spliIntoAlliances(r)}}activateListeners(e){super.activateListeners(e),e.filter(".tokens").selectable({autoRefresh:!1,filter:".token",cancel:"header,select",stop:()=>this._setSelected()}),e.find("[data-action=select-all]").on("click",i=>{let n=$(i.currentTarget).closest("section"),o=(n.length?n:e).find("[data-token-id]"),r=o.filter(":not(.ui-selected)").length===0;o.toggleClass("ui-selected",!r),this._setSelected()}),e.find("[data-action=use-selection]").on("click",i=>{this._setSelected(canvas.tokens.controlled.map(n=>n.id)),this.render()}),e.find("[data-action=reset]").on("click",i=>this.reset())}};a(We,"PerceptionMenu");var zi=[{x:.25,y:.25},{x:.5,y:.25},{x:.75,y:.25},{x:.25,y:.5},{x:.5,y:.5},{x:.75,y:.5},{x:.25,y:.75},{x:.5,y:.75},{x:.75,y:.75}];function at(t,e){let i=1-e;return{top:{A:ee({x:e,y:e},t),B:ee({x:i,y:e},t)},right:{A:ee({x:i,y:e},t),B:ee({x:i,y:i},t)},bottom:{A:ee({x:i,y:i},t),B:ee({x:e,y:i},t)},left:{A:ee({x:e,y:i},t),B:ee({x:e,y:e},t)}}}a(at,"getRectEdges");function De(t,e,i=!1){return i&&Q(t,e),CONFIG.Canvas.polygonBackends.move.testCollision(t,e,{type:"move",mode:"any"})}a(De,"lineIntersectWall");function st(t,e,i=!1){for(let n of Li(e.bounds))if(De(t,n,i))return!0;return!1}a(st,"pointToTokenIntersectWall");function ee(t,e){return{x:e.x+e.width*t.x,y:e.y+e.height*t.y}}a(ee,"getRectPoint");function me(){canvas.controls.debug.clear()}a(me,"clearDebug");function Q(t,e,i="blue"){let n=i==="blue"?26316:i==="red"?16711680:1483011;canvas.controls.debug.lineStyle(4,n).moveTo(t.x,t.y).lineTo(e.x,e.y)}a(Q,"drawDebugLine");function*Li(t){for(let e of zi)yield ee(e,t)}a(Li,"rectSpread");function ct(t,e=!1){if(t=t instanceof Token?t:t.object,t.document.hasStatusEffect(CONFIG.specialStatusEffects.INVISIBLE))return;let i=t.scene;if(i!==canvas.scene||!i.tokenVision||i.darkness<i.globalLightThreshold)return;e&&me();let n=t.document.center,o=null;for(let r of canvas.effects.lightSources){if(!r.active)continue;let s=r.data.bright,c=r.data.dim;if(r.object===t){if(s)return"bright";c&&(o="dim");continue}if(!r.shape.contains(n.x,n.y)){e&&Q(r,n,"red");continue}if(r.ratio===1)return e&&Q(r,n,"green"),"bright";if(r.ratio===0){e&&Q(r,n,"blue"),o="dim";continue}if(new Ray(r,n).distance<=s)if(e)Q(r,n,"green"),o="bright";else return"bright";else e?(Q(r,n,"blue"),o!=="bright"&&(o="dim")):o="dim"}return o}a(ct,"getLightExposure");var xe={cover:{cancel:{targets:["lesser","standard","greater","greater-prone"]},set:{targets:["none","lesser","standard","greater","greater-prone"],value:["none","lesser","standard","greater","greater-prone"]},reduce:{targets:["lesser","standard","greater","greater-prone"]},ignore:{targets:"string"},ignored:{targets:["allies","enemies"]},ac:{targets:["lesser","standard","greater","greater-prone"],value:["number"]}},visibility:{cancel:{targets:["concealed","hidden","undetected","unnoticed"]},set:{targets:["observed","concealed","hidden","undetected","unnoticed"],value:["observed","concealed","hidden","undetected","unnoticed"]},reduce:{targets:["concealed","hidden","undetected","unnoticed"]},noff:{targets:["hidden","undetected","unnoticed"]},noinvis:{},dc:{targets:["concealed","hidden"],value:["number","string"]}}},Vi={cover:Object.keys(xe.cover),visibility:Object.keys(xe.visibility),all:[...Object.keys(xe.cover),...Object.keys(xe.visibility)]};function ii(){let t=game.pf2e.RuleElements.builtin.RollOption.defineSchema(),e=t.predicate.constructor,i=t.value.constructor;class n extends game.pf2e.RuleElement{constructor(r,s){typeof r.targets=="string"&&(r.targets=[r.targets]),super({priority:CONST.ACTIVE_EFFECT_MODES.CUSTOM,...r},s);let c=Vi[r.type];if(!c)return;if(!c?.includes(r.selector)){this.failValidation(`The type "${r.type}" only accepts the following selectors: ${c.join(", ")}.`);return}let l=xe[r.type]?.[r.selector];if(!l)return;let p=a(g=>{let{name:m,uuid:y}=this.item;console.warn(`PF2e System | PF2ePerception rules element on item ${m} (${y}) simple warning: ${g}`)},"selectorWarn"),d=Array.isArray(l.targets)?[...l.targets,"all"]:l.targets,u=Array.isArray(d)?d.join(", "):null;if(!d&&r.targets?.length){p(`The selector "${r.selector}" doesn't accept any targets property.`);return}if(r.selector==="ignore"&&!r.targets?.length){let g=`The selector "${r.selector}" requires a targets property with the ids of the tokens on the scene that should not give cover.`;this.failValidation(g);return}if(u&&r.targets?.some(g=>!d.includes(g))){let g=`The targets property of selector "${r.selector}" only accepts the following: ${u}.`;this.failValidation(g);return}else if(!u&&d&&r.targets?.some(g=>typeof g!==d)){let g=`The targets property of selector "${r.selector}" needs to be of type "${d}".`;this.failValidation(g);return}if(!l.value&&r.value){p(`The selector "${r.selector}" doesn't accept any value property.`);return}if(r.selector==="set"){if(!l.value.includes(r.value)){let g=l.value.join(", "),m=`The selector "${r.selector}" only accepts the following: ${g}.`;this.failValidation(m)}}else{let g=typeof r.value;if(l.value&&!l.value.includes(g)){let m=`The selector "${r.selector}" does not accept a value property of type ${g}.`;this.failValidation(m)}}}static defineSchema(){let{fields:r}=foundry.data;return{...super.defineSchema(),type:new r.StringField({required:!0,nullable:!1,blank:!1,choices:["visibility","cover"]}),affects:new r.StringField({required:!0,nullable:!1,blank:!1,initial:"self",choices:["self","other"]}),selector:new r.StringField({required:!0,nullable:!1,blank:!1}),targets:new r.ArrayField(new r.StringField({required:!0,nullable:!1,blank:!1,initial:void 0}),{required:!0,nullable:!1,initial:["all"]}),predicate:new e({required:!1,nullable:!1}),value:new i({required:!1,initial:void 0})}}test(r,s){return s?super.test(r):!1}addToPerception(r,s,c){if(!this.test(c,!0))return;let p=`${this.affects==="self"?r:r==="origin"?"target":"origin"}.${this.type}.${this.selector}`,d=xe[this.type][this.selector];if(!d.targets){setProperty(s,p,!0);return}let u=this.targets.includes("all")?d.targets:this.targets;if(!d.value){for(let g of u){let m=`${p}.${g}`;setProperty(s,m,!0)}return}for(let g of u){let m=`${p}.${g}`,y=getProperty(s,m);y?y.add(this.value):y=new Set([this.value]),setProperty(s,m,y)}}}a(n,"PF2ePerceptionRuleElement"),game.pf2e.RuleElements.custom.PF2ePerception=n}a(ii,"setupRuleElement");function re(t,e,{distance:i,extraOptions:n=[]}={}){let o=t.actor,r=e.actor;if(!o||!r)return{};let s={origin:o.rules.filter(u=>!u.ignored&&u.key==="PF2ePerception")??[],target:r.rules.filter(u=>!u.ignored&&u.key==="PF2ePerception")??[]};if(!s.origin.length&&!s.target.length)return{};let c={origin:o.getRollOptions(),target:r.getRollOptions()},l={origin:r.getSelfRollOptions("target"),target:o.getSelfRollOptions("origin")};t=t instanceof Token?t:t.object,e=e instanceof Token?e:e.object,i??=t.distanceTo(e);let p=[`origin:distance:${i}`,`target:distance:${i}`],d={};for(let u of["origin","target"]){let g=[...n,...c[u],...l[u],...p];for(let m of s[u])m.addToPerception(u,d,g)}return d}a(re,"perceptionRules");function ni(t){let e=t.actor;return e?(e.rules.filter(n=>!n.ignored&&n.key==="PF2ePerception"&&n.type==="cover"&&n.selector==="ignored")??[]).flatMap(n=>n.targets):[]}a(ni,"getIgnoredPerception");function B(t,e,i,n,o){let r=t[e]?.[i]?.[n];return o?r?.[o]:r}a(B,"getPerception");function Fe(t,e,i,n){n===void 0&&(n=i==="cover"?"none":"observed");let o=i==="cover"?U:de;if(n&&B(t,e,i,"cancel",n))return;let r=B(t,e,i,"set",n)?.first();if(r&&o.includes(r))n=r;else if(n&&B(t,e,i,"reduce",n)){let s=o.indexOf(n);n=o[Math.max(0,s-1)]}return n===o[0]?void 0:n}a(Fe,"updateFromPerceptionRules");function ri(t,e){!Lt()||!t.object.actor?.isOfType("creature")||(e.find(".col.left").append('<div class="control-icon" data-action="pf2e-perception"><i class="fa-solid fa-eye"></i></div>'),e.find("[data-action=pf2e-perception]").on("click",i=>Et(t.object)))}a(ri,"renderTokenHUD");function Et(t){return We.openMenu({token:t})}a(Et,"openHUD");function oi(t,e){for(let i of e)delete i.flags?.[f]}a(oi,"pasteToken");function z(t,...e){return e.unshift("data"),t=t instanceof Token?t.document:t,w(t,e.join("."))}a(z,"getTokenData");async function ai(t){return t=t instanceof Token?t.document:t,_t(t,"data")}a(ai,"clearTokenData");async function ot(t,e){let i=j(t).map(o=>o.id),n={};for(let o in e){if(!i.includes(o)){n[`flags.${f}.data.-=${o}`]=!0;continue}let r=e[o],s=z(t,o)??{};if(r.visibility===V.visibility&&delete r.visibility,r.cover===V.cover&&delete r.cover,!(s.cover===r.cover&&s.visibility===r.visibility))if(!r.visibility&&!r.cover)n[`flags.${f}.data.-=${o}`]=!0;else for(let c of["cover","visibility"])s[c]!==r[c]&&(r[c]?n[`flags.${f}.data.${o}.${c}`]=r[c]:n[`flags.${f}.data.${o}.-=${c}`]=!0)}return t=t instanceof Token?t.document:t,t.update(n)}a(ot,"setTokenData");function lt(t,e,i=!1){let n=t.scene;return Ee(n,"standard")?(i&&me(),(O("standard-type")==="points"?st(t.center,e,i):De(t.center,e.center,i))?"standard":void 0):void 0}a(lt,"getWallCover");var fe={tiny:0,sm:1,med:2,lg:3,huge:4,grg:5};function dt(t,e,{perception:i={},options:n=[],affects:o="origin",debug:r=!1}={}){let s=n.includes("item:ranged")?Z(e.actor):!1,c=a(d=>Fe(i,o,"cover",d),"returnValue"),l=te(e.actor,!0);if(s&&x[l]>x.lesser)return c("greater-prone");!s&&l==="greater-prone"&&(l=void 0);let p=z(e,t.id,"cover");if(s&&x[p]>x.lesser)return c("greater-prone");if(!s&&p==="greater-prone"&&(p=void 0),x[l]<x.standard){let d=game.modules.get(f).custom??{};if(x[p]<x.standard){let u=d.getWallCover,g;if(typeof u=="function"){let m=u(t,e,r);g=U.includes(m)?m:lt(t,e,r)}else g=lt(t,e,r);x[g]>x[p]&&(p=g)}if(x[p]<x.standard&&t.distanceTo(e)>5){let u=d.getCreatureCover,g;if(typeof u=="function"){let m=u(t,e,{perception:i,debug:r});g=U.includes(m)?m:ut(t,e,{perception:i,debug:r})}else g=ut(t,e,{perception:i,debug:r});x[g]>x[p]&&(p=g)}}return s&&x[p]>x.lesser?c("greater-prone"):c(x[p]>x[l]?p:void 0)}a(dt,"getCover");function ut(t,e,{perception:i={},debug:n=!1}={}){let o=O("lesser");if(o==="none")return;t=t instanceof Token?t.document:t,e=e instanceof Token?e.document:e;let r=(()=>{let b=Object.keys(i.origin?.cover?.ignore??{}),N=Object.keys(i.target?.cover?.ignore??{});return new Set([...b,...N])})(),s,c=t.center,l=e.center,p=t.actor,d=e.actor;n&&(me(),Q(c,l));let u=a(b=>{let N=fe[b.actor.size];return N-g>=2&&N-m>=2},"isExtraLarge"),g=fe[p.size],m=fe[d.size],y=p.alliance,k=O("dead-cover"),R=O("prone-cover"),E=t.scene.tokens.contents.filter(b=>{let N=b.actor,G=ni(b);return N&&!b.hidden&&b!==t&&b!==e&&(R||!Z(N))&&(k||N.hitPoints?.value!==0)&&!r.has(b.id)&&!(G.includes("all")||G.includes(N.alliance===y?"allies":"enemies"))}).sort((b,N)=>fe[N.actor.size]-fe[b.actor.size]),S=g<fe.huge&&m<fe.huge&&E.filter(u).length,F=o==="ten"?.1:o==="twenty"?.2:0,T=a(b=>(n&&Q(b.A,b.B,"red"),lineSegmentIntersects(c,l,b.A,b.B)),"intersectsEdge"),A=o==="cross"?b=>T(b.top)&&T(b.bottom)||T(b.left)&&T(b.right):b=>Object.values(b).some(N=>T(N));for(let b of E){let N=b.object,G=at(N.bounds,F);if(A(G))return S?"standard":"lesser";u(b)&&S--}return s}a(ut,"getCreatureCover");function oe(t,e,{perception:i={},affects:n="origin",debug:o=!1}={}){t=t instanceof Token?t:t.object,e=e instanceof Token?e:e.object;let r=t.actor,s=e.actor,c=(()=>{if(!r||!s)return;let S;s.hasCondition("blinded")?S="hidden":s.hasCondition("dazzled")&&(S="concealed");for(let F of["unnoticed","undetected","hidden","concealed"])P[F]>P[S]&&r.hasCondition(F)&&(S=F);return S})(),l=a(S=>p?(P[S]<P.hidden&&(S="hidden"),(Ke(s)||B(i,n,"visibility","noinvis"))&&(S="concealed"),Fe(i,n,"visibility",S)):Fe(i,n,"visibility",S),"returnValue"),p=r?.hasCondition("invisible"),d=z(t,e.id,"visibility"),u=P[c]>P[d]?c:d;if(P[u]>=P.hidden||p)return l(u);let g=s?.hasLowLightVision,m=s?.hasDarkvision,y=s&&He(s);if(y&&u==="concealed")return l(u);let k;if(!y){let S=Je(t);if(S?.length){let F;for(let T of S){let A=Te(T);if(!A.length)continue;if(A.includes(t)||A.includes(e))k=!0;else continue;if(!m)return l("hidden");w(T,"conceal")&&(F="concealed")}if(F==="concealed"&&(u="concealed"),k&&u==="concealed")return l(u)}}if(u!=="concealed"){let S=et(t);if(S?.length)for(let F of S){let T=Te(F);if(!T.length)continue;if(T.includes(t)||T.includes(e))return l("concealed")}}if(k||y)return l(u);let R=ct(t,o),E=R==="dim"?"concealed":R===null?"hidden":void 0;return(E==="concealed"&&g||E==="hidden"&&m)&&(E=void 0),P[E]>P[u]&&(u=E),l(u)}a(oe,"getVisibility");function si(t,e,i,n){let o=e.flags?.["pf2e-perception"];if(o&&(o.data||o["-=data"]!==void 0)){if(t.object.renderFlags.set({refreshVisibility:!0}),game.user.isGM)return;let r=Hooks.on("refreshToken",s=>{!t.object!==s&&(Hooks.off("refreshToken",r),game.combat?.getCombatantByToken(t.id)&&ui.combat.render())})}}a(si,"updateToken");function ci(t,e){e?pt(t):ye(t)}a(ci,"hoverToken");function li(t){ye(t),game.user.isGM||ui.combat.render()}a(li,"deleteToken");function di(t,e){e&&(ye(),Hooks.once("sightRefresh",()=>t.hover&&pt(t)))}a(di,"controlToken");function ye(t){if(!t?.id)return $(".pf2e-conditionals").remove();$(`.pf2e-conditionals[data-hover-id=${t.id}]`).remove(),$(`.pf2e-conditionals[data-token-id=${t.id}]`).remove()}a(ye,"clearConditionals");function pt(t){let e=j(t);for(let i of e)Tt(i,t)}a(pt,"showAllConditionals");async function Tt(t,e){if(t=t instanceof Token?t:t.object,!t.visible||!t.actor?.isOfType("creature"))return;let i=z(t,e.id);if(isEmpty(i))return;if(!game.user.isGM&&!e.document.hasPlayerOwner&&P[i.visibility]>=P.hidden){if(!i.cover)return;i={cover:i.cover}}let n=t.worldTransform.a,o=canvas.clientCoordinatesFromCanvas(t.document._source),r=O("icon-size"),s=[`top: ${o.y}px`,`left: ${o.x+t.hitArea.width*n/2}px`,`--icon-size: ${r}px`].join("; "),c=`<div class="pf2e-conditionals" data-hover-id="${t.id}"`;c+=` data-token-id="${e.id}" style="${s}">`;let l=O("icon-path");Object.entries(i).map(([p,d])=>{let u=p==="cover"?"cover":d,g=l[u]||Ge[u];(g.startsWith("systems")||g.startsWith("modules"))&&(g=`../../../${g}`),c+=`<div class="conditional"><img src="${g}"></img></div>`}),c+="</div>",$(document.body).append(c)}a(Tt,"showConditionals");function pi(){return!!(this.sight.enabled&&this.actor?.isOfType("creature")&&this.scene?.rulesBasedVision)}a(pi,"rulesBasedVision");function gi(t){let e=t.actor;if(e?.isOfType("creature")&&(e.isOfType("npc")&&Ee(t.scene,"npc-vision")&&t.updateSource({"sight.enabled":!0}),game.user.isGM&&t.hidden)){let i=game.user.targets,n={};for(let o of i)n[o.id]={visibility:"unnoticed"};i.size&&t.updateSource({[`flags.${f}.data`]:n})}}a(gi,"preCreateToken");var we=class extends Y{static async openMenu(e,i){let n=await super.openMenu(e,i);return n&&e.message&&mi(e.message),n}get title(){return h("menu.validation.title",{name:this.token.name})}get template(){return X("validation")}get selected(){let e=super.selected;return e.length?e:this.globalSelection}get globalSelection(){let e=this.token,i=e.actor.alliance;return j(e).filter(n=>n.actor.alliance!==i).map(n=>n.id)}getSavedData(e=!0){let i=super.getSavedData();return e?this._convertData(i):i}_convertData(e){let i=this.property,n=this.scene,o=this.selected,r=V[i],s=i==="cover"?U:de;for(let c of o){let l=n.tokens.get(c),p=`${c}.${i}`,d=getProperty(e,p)??r,u=this.processValue({token:l,value:d});s.includes(u)||(u=d),d!==u&&setProperty(e,p,u)}return e}processValue(e){throw new Error(`${this.constructor.name} doesn't have a 'processValue' method defined`)}getData(e){let{covers:i,visibilities:n,i18n:o}=super.getData(e),r=this.currentData,s=this.getSavedData(!1),c=this.property,l=this.selected,p=j(this.token);p=p.map(({id:u,name:g,actor:m})=>{let y=r[u]??{},k=s[u]??{};return{id:u,name:g,alliance:m.alliance,selected:l.includes(u),...Y.createPropertyData(k,y,c)}});let d=O("validation");return d==="selected"?p=p.filter(u=>u.selected):d==="changed"&&(p=p.filter(u=>u.changed)),{...this._spliIntoAlliances(p),i18n:o,property:c,options:c==="cover"?i:n,showSelected:l.length!==p.length&&d==="all",showChanges:d!=="changed"}}activateListeners(e){super.activateListeners(e),e.find("[data-action=cancel]").on("click",i=>{this.close()})}};a(we,"ValidationMenu");var $e=class extends we{#e;constructor(e,i={}){super(e,i),this.#e=e.value}get property(){return"cover"}processValue(){return this.#e}};a($e,"CoverValidationMenu");var ae=class extends we{#e;constructor(e,i={}){super(e,i),this.#e=e.roll}get property(){return"visibility"}get roll(){return this.#e}};a(ae,"VisibilityValidationMenu");var Me=class extends ae{processValue({token:e,value:i}){let n=this.roll,o=e.actor.perception.dc.value,r=P[i],s=new M(n,o).value;return s>=M.SUCCESS&&r<P.hidden?"hidden":s<=M.FAILURE&&r>=P.hidden?"observed":i}};a(Me,"HideValidationMenu");var _e=class extends ae{processValue({token:e,value:i}){let n=this.roll,o=e.actor.perception.dc.value,r=P[i];return new M(n,o).value>=M.SUCCESS&&r<P.hidden?"hidden":i}};a(_e,"CreateADiversionMenu");var ze=class extends ae{get selected(){return j(this.token).map(e=>e.id)}processValue({token:e,value:i}){return P[i]>=P.hidden?"observed":i}};a(ze,"UnHideValidationMenu");var Le=class extends ae{#e;constructor(e,i={}){super(e,i),this.#e=e.originator}get selected(){let e=this.token,i=e.actor.alliance,n=this.#e.id,o=z(e)??{};return j(e).filter(r=>{if(r.id===n||r.actor.alliance===i)return!1;let s=getProperty(o,`${r.id}.visibility`);return P[s]>=P.undetected}).map(r=>r.id)}processValue({token:e,value:i}){return P[i]>=P.undetected?"hidden":i}};a(Le,"PointOutValidationMenu");var gt=class extends ae{getSavedData(e=!0){let i=this.token.id,n=j(this.token),o={};for(let r of n){let s=z(r,i);s&&(o[r.id]=deepClone(s))}return e?this._convertData(o):o}getData(){let e=super.getData();return e.isReversed=!0,e.options=de.map(i=>({value:i,label:h(`visibility.reversed.${i}`)})),e}_saveData(e){let i=this.scene,n=this.token.id,o=[];for(let[r,s]of Object.entries(e)){let c={_id:r},l=i.tokens.get(r);if(l){s.visibility===V.visibility&&delete s.visibility;let p=z(l,n)??{};if(p?.visibility===s.visibility)continue;!p.cover&&!s.visibility?c[`flags.${f}.data.-=${n}`]=!0:s.visibility?c[`flags.${f}.data.${n}.visibility`]=s.visibility:c[`flags.${f}.data.${n}.-=visibility`]=!0}else c[`flags.${f}.data.-=${n}`]=!0;o.push(c)}i.updateEmbeddedDocuments("Token",o)}};a(gt,"ReverseVisibilityValidationMenu");var Ve=class extends gt{#e;constructor(e,i={}){super(e,i),this.#e=e.fromTemplate}get globalSelection(){return[]}static async openMenu(e,i){await super.openMenu(e,i)&&J(e.token)}processValue({token:e,value:i}){let n=this.roll,o=e.actor.skills.stealth.dc.value,r=P[i],s=new M(n,o).value;return s>=M.CRITICAL_SUCCESS&&r>=P.hidden||s>=M.SUCCESS&&r===P.hidden?"observed":s>=M.SUCCESS&&r>=P.undetected?"hidden":i}};a(Ve,"SeekValidationMenu");function xt(t,e){let i=t.token;if(!i)return;let n=game.user.isGM,o=i.hasPlayerOwner,{cover:r,selected:s,skipWait:c,validated:l,pointOut:p}=zt(t),d=t.getFlag("pf2e","context");if(r){if(n){let u=mt({property:"cover",skipWait:c,validated:l});e.find(".message-content").append(u),e.find("[data-action=validate-cover]").on("click",()=>{$e.openMenu({token:i,selected:s,value:r,message:t})})}else if(!c){let u=Rt("cover",l);e.find(".message-content").append(u)}}else if(d?.pf2ePerception?.visibility){l||e.find(".message-buttons").remove();let u=e.find(".flavor-text");!n&&o&&(e.find(".message-sender").text(i.name),u.empty());let g=h(`message.flat-check.${l===void 0?"blind":l?"success":"failure"}`),m=vi(g,l);if(u.append(m),n)for(let y of["success","failure"])u.append(Ft({action:`${y}-message`,icon:"fa-solid fa-message",label:h("message.flat-check.button",y)})),e.find(`[data-action=${y}-message]`).on("click",()=>{vt(t,"validated",y==="success")})}else if(d?.type==="skill-check"&&d.pf2ePerception)if(n){if(d.options.includes("action:hide")){let u=mt({property:"visibility",skipWait:c,validated:l});e.find(".flavor-text").append(u),e.find("[data-action=validate-visibility]").on("click",()=>{Me.openMenu({token:i,message:t,roll:t.rolls[0],selected:d.pf2ePerception.selected})})}else if(d.options.includes("action:create-a-diversion")){let u=mt({property:"visibility",skipWait:c,validated:l});e.find(".flavor-text").append(u),e.find("[data-action=validate-visibility]").on("click",()=>{_e.openMenu({token:i,message:t,roll:t.rolls[0],selected:d.pf2ePerception.selected})})}}else o&&(d.options.includes("action:hide")?yi({token:i,message:t,html:e,validated:l,action:"Hide"}):d.options.includes("action:create-a-diversion")&&hi(e,l));else if(d?.type==="perception-check"&&d.pf2ePerception)if(n){if(d.options.includes("action:seek")){let u=fi({skipWait:c,validated:l,smallAction:"delete-template",smallIcon:"fa-thin fa-cubes",smallSlashed:!0});e.find(".flavor-text").append(u),e.find("[data-action=validate-visibility]").on("click",()=>{Ve.openMenu({token:i,message:t,roll:t.rolls[0],selected:d.pf2ePerception.selected,fromTemplate:d.pf2ePerception.fromTemplate})}),e.find("[data-action=delete-template").on("click",()=>{J(i)})}}else o&&d.options.includes("action:seek")&&yi({token:i,message:t,html:e,validated:l,action:"Seek"});else if(p){let u=i.scene.tokens.get(p);if(!u)return;if(n){let g=fi({skipWait:c,validated:l,smallAction:"ping-token",smallIcon:"fa-solid fa-signal-stream"});e.find(".message-content").append(g),e.find("[data-action=validate-visibility]").on("click",()=>{Le.openMenu({message:t,token:u,originator:i,selected:canvas.tokens.controlled.map(m=>m.id)})}),e.find("[data-action=ping-token]").on("click",()=>{canvas.ping(u.center)})}else if(o){let g=Rt("visibility",l);e.find(".message-content").append(g)}}if(n&&ke.includes(d?.type)){let g=`<span class="pf2e-perception-unhide">
    <button data-action="unhide" title="${h("message.unhide.tooltip")}">
        <i class="fa-duotone fa-eye-slash"></i>
    </button>
</span>`;e.find(".dice-result .dice-total").append(g),e.find("[data-action=unhide]").on("click",m=>{m.stopPropagation(),ze.openMenu({token:i})})}}a(xt,"renderChatMessage");function mi(t){w(t,"validated")||vt(t,"validated",!0)}a(mi,"validateMessage");function fi({skipWait:t,validated:e,smallIcon:i,smallAction:n,smallSlashed:o}){let r='<div class="pf2e-perception-chat-combo">';return r+=mt({property:"visibility",skipWait:t,validated:e}),r+=Ft({action:n,icon:i,slashed:o,tooltip:h(`message.visibility.small-button.${n}`)}),r+="</div>",r}a(fi,"createValidateCombo");function ji(t,e){let i=game.i18n.localize(e==="perception"?"PF2E.PerceptionLabel":`PF2E.Skill${e.capitalize()}`),n=h("message.check");return`<h4 class="action">
    <strong>${pe(t)}</strong>
    <span class="action-glyph">1</span>
    <span class="subtitle">(${i} ${n})</span>
</h4>`}a(ji,"actionTitle");function hi(t,e){let i=Rt("visibility",e);t.find(".flavor-text").append(i)}a(hi,"addSkillCheckFlavor");function yi({html:t,token:e,message:i,validated:n,action:o}){let r=i.getFlag("pf2e","modifierName"),s=ji(o,r);t.find(".message-sender").text(e.name),t.find(".flavor-text").html(s),hi(t,n)}a(yi,"addBlindSkillCheckFlavor");function Rt(t,e){let i=h(`message.${t}.player.${e?"validated":"wait"}`);return vi(i,e)}a(Rt,"createWaitHint");function vi(t,e){return`<i class="pf2e-perception-hint">${e===!0?`<i class="fa-solid fa-check validated"></i> ${t}`:e===!1?`<i class="fa-solid fa-xmark canceled"></i> ${t}`:t}</i>`}a(vi,"createHint");function mt({skipWait:t,validated:e,property:i}){let n=h(`message.${i}.gm.${t?"check":e?"validated":"validate"}`);return!t&&e&&(n+='<i class="fa-solid fa-check validated"></i>'),Ft({action:`validate-${i}`,icon:"fa-solid fa-list",label:n})}a(mt,"createValidateButton");function Ft({action:t,icon:e,label:i,tooltip:n,slashed:o=!1}){let r=`<button type="button" class="pf2e-perception-chat-button" data-action="${t}" title="${n}">`;return e&&(r+=`<i class="${e} ${i?"":"no-label"}"></i>`,o&&(r+='<i class="fa-solid fa-slash-forward slashed"></i>')),i&&(r+=`${e?" ":""}${i}`),r+="</button>",r}a(Ft,"createChatButton");async function Nt({content:t,token:e,flags:i,secret:n}){let o={content:t,speaker:ChatMessage.getSpeaker({token:e instanceof Token?e.document:e})};return i&&setProperty(o,`flags.${f}`,i),n&&(o.type=CONST.CHAT_MESSAGE_TYPES.WHISPER,o.whisper=ChatMessage.getWhisperRecipients("gm")),ChatMessage.create(o)}a(Nt,"createTokenMessage");function ki(){let t=game.pf2e.actions.get("hide"),e=Re(t,2).constructor,i=Re(t.toActionVariant(),2).constructor,n=Re(t,1).constructor,o=Re(t.toActionVariant(),1).constructor;Qi(e,i),Yi(n,o),qi(n,o),Ki(n,o),Bi(n,o),Gi(e,i)}a(ki,"setupActions");function Gi(t,e){class i extends e{async use(r={}){let s=h("action.point-out"),c=Ne(r,s);c&&Ui(this,c)}}a(i,"PointOutVariant");class n extends t{constructor(){super({cost:1,name:`${f}.action.point-out`,description:`${f}.action.point-out.description`,rollOptions:["action:point-out"],slug:"point-out",traits:["auditory","manipulate","visual"]})}toActionVariant(r={}){return r.name??=this.name,new i(this,r)}}a(n,"PointOut"),game.pf2e.actions.set("point-out",new n)}a(Gi,"setupPointOut");async function Ui({name:t,traits:e},i){let n=game.user.targets.filter(p=>p.actor).first(),o=n?z(n,i.id,"visibility"):void 0,r=n&&P[o]<P.undetected,s;if(r){let p=n.actor.skills.stealth.dc.value;s=h("message.point-out.short-check",{check:`@Check[type:perception|dc:${p}|traits:auditory,manipulate,visual|showDC:gm]`})}else s=h("message.point-out.short");let c=await renderTemplate(X("point-out"),{description:s,name:t,traits:e.map(p=>({slug:p,tooltip:CONFIG.PF2E.traitsDescriptions[p],name:CONFIG.PF2E.actionTraits[p]}))}),l={pointOut:r?n.id:void 0};Nt({content:c,token:i,flags:l})}a(Ui,"pointOut");function Bi(t,e){class i extends e{async use(r={}){let s=pe("Seek"),c=Ne(r,s);if(c)return O("seek-template")&&!await Hi(c)?J(c):(r.actors=[c.actor],super.use(r))}}a(i,"SeekVariant");class n extends t{constructor(){super({cost:1,description:"PF2E.Actions.Seek.Description",name:"PF2E.Actions.Seek.Title",notes:[{outcome:["criticalSuccess"],text:"PF2E.Actions.Seek.Notes.criticalSuccess"},{outcome:["success"],text:"PF2E.Actions.Seek.Notes.success"}],rollOptions:["action:seek"],slug:"seek",statistic:"perception",traits:["concentrate","secret"]})}toActionVariant(r){return new i(this,r)}}a(n,"Seek"),game.pf2e.actions.set("seek",new n)}a(Bi,"setupSeek");async function Hi(t){let e=game.i18n.localize("PF2E.Foot"),i='<p style="margin: 0 0.3em; text-align: center;">';return i+=`${h("dialog.seek.hint")}</p><p>`,i+=Pi("create-cone","fa-thin fa-cubes",game.i18n.format("PF2E.TemplateLabel",{size:30,unit:e,shape:game.i18n.localize(CONFIG.PF2E.areaTypes.cone)})),i+=Pi("create-burst","fa-thin fa-cubes",game.i18n.format("PF2E.TemplateLabel",{size:15,unit:e,shape:game.i18n.localize(CONFIG.PF2E.areaTypes.burst)})),i+="</p>",Dialog.wait({title:`${t.name} - ${game.i18n.localize("PF2E.Actions.Seek.Title")}`,content:i,buttons:{ok:{icon:'<i class="fa-solid fa-check"></i>',label:h("dialog.seek.accept"),callback:()=>!0},no:{icon:'<i class="fa-solid fa-xmark"></i>',label:h("dialog.seek.cancel"),callback:n=>!1}},close:()=>!1,render:n=>{n.filter(".dialog-content").find("[data-action=create-cone], [data-action=create-burst]").on("click",r=>{let{action:s}=r.currentTarget.dataset;J(t),Ze({type:s==="create-cone"?"cone":"burst",token:t})})}},{width:300,left:10})}a(Hi,"seek");function Ki(t,e){class i extends e{async use(r={}){let s=pe("Sneak"),c=Ne(r,s);if(c)return r.actors=[c.actor],super.use(r)}}a(i,"SneakVariant");class n extends t{constructor(){super({cost:1,description:"PF2E.Actions.Sneak.Description",name:"PF2E.Actions.Sneak.Title",notes:[{outcome:["success","criticalSuccess"],text:"PF2E.Actions.Sneak.Notes.success"},{outcome:["failure"],text:"PF2E.Actions.Sneak.Notes.failure"},{outcome:["criticalFailure"],text:"PF2E.Actions.Sneak.Notes.criticalFailure"}],rollOptions:["action:sneak"],slug:"sneak",traits:["move","secret"]})}toActionVariant(r){return new i(this,r)}}a(n,"Sneak")}a(Ki,"setupSneak");function qi(t,e){class i extends e{async use(r={}){let s=pe("CreateADiversion"),c=Ne(r,s);if(c)return r.actors=[c.actor],super.use(r)}}a(i,"CreateADiversionVariant");class n extends t{constructor(){super({cost:1,description:"PF2E.Actions.CreateADiversion.Description",name:"PF2E.Actions.CreateADiversion.Title",notes:[{outcome:["criticalSuccess","success"],text:"PF2E.Actions.CreateADiversion.Notes.success"},{outcome:["criticalFailure","failure"],text:"PF2E.Actions.CreateADiversion.Notes.failure"}],section:"skill",slug:"create-a-diversion",statistic:"deception",traits:["mental"],variants:[{name:"PF2E.Actions.CreateADiversion.DistractingWords.Title",rollOptions:["action:create-a-diversion","action:create-a-diversion:distracting-words"],slug:"distracting-words",traits:["auditory","linguistic","mental"]},{name:"PF2E.Actions.CreateADiversion.Gesture.Title",rollOptions:["action:create-a-diversion","action:create-a-diversion:gesture"],slug:"gesture",traits:["manipulate","mental"]},{name:"PF2E.Actions.CreateADiversion.Trick.Title",rollOptions:["action:create-a-diversion","action:create-a-diversion:trick"],slug:"trick",traits:["manipulate","mental"]}]})}toActionVariant(r){return new i(this,r)}}a(n,"CreateADiversion"),game.pf2e.actions.set("create-a-diversion",new n)}a(qi,"setupCreateADiversion");function Yi(t,e){class i extends e{async use(r={}){let s=pe("Hide"),c=Ne(r,s);if(c)return r.actors=[c.actor],super.use(r)}}a(i,"HideVariant");class n extends t{constructor(){super({cost:1,description:"PF2E.Actions.Hide.Description",name:"PF2E.Actions.Hide.Title",rollOptions:["action:hide"],slug:"hide",statistic:"stealth",traits:["secret"],notes:[{outcome:["success","criticalSuccess"],text:"PF2E.Actions.Hide.Notes.success"}]})}toActionVariant(r){return new i(this,r)}}a(n,"Hide"),game.pf2e.actions.set("hide",new n)}a(Yi,"setupHide");function Qi(t,e){class i extends e{async use(r={}){let s=h("action.take-cover"),c=Ne(r,s);c&&Xi(c)}}a(i,"TakeCoverVariant");class n extends t{constructor(){super({cost:1,description:"PF2E.Actions.TakeCover.Description",img:"systems/pf2e/icons/conditions-2/status_acup.webp",name:"PF2E.Actions.TakeCover.Title",slug:"take-cover"})}toActionVariant(r){return new i(this,r)}}a(n,"TakeCover"),game.pf2e.actions.set("take-cover",new n)}a(Qi,"setupCover");async function Xi(t){let e=t.actor,i=te(e),n=ne(t,game.user.targets.ids);if(i&&!n.length)return i.delete();let o=z(t)??{},r=Object.entries(o).reduce((l,[p,{cover:d}])=>(d&&(l[p]=d),l),{}),s=await renderTemplate(X("covers-dialog"),{i18n:h,hasTargets:!!n.length,hasCovers:!isEmpty(r),hasTargetCover:n.some(l=>l in r),isProne:Z(e)}),c=new Dialog({title:`${t.name} - ${h("action.take-cover")}`,content:s,buttons:{},render:l=>{l.find("button").on("click",async p=>{let{level:d}=p.currentTarget.dataset,u=O("skip-cover"),g=a(async(m,y)=>{let k=y?n:void 0,R=m===V.cover?k?"remove":"remove-all":"take";if(await Nt({content:h(`message.cover.${R}`,{cover:h(`cover.${m}`)}),flags:{selected:k,cover:m,skipWait:u},token:t}),u){if(m===V.cover&&!k)return ai(t);let E=deepClone(z(t))??{};for(let S of n)setProperty(E,`${S}.cover`,m);return ot(t,E)}},"process");if(d==="remove-all")g(V.cover);else if(d==="remove")g(V.cover,!0);else if(n.length)g(d,!0);else{let m=Se(d);e.createEmbeddedDocuments("Item",[m])}c.close()})}}).render(!0)}a(Xi,"takeCover");function Ne(t,e){let i=t.tokens?.filter(r=>r.actor)??[];Array.isArray(i)||(i=[i]);let n=t.actors??[];if(Array.isArray(n)||(n=[n]),!i.length&&n.length===1&&(i=[Ie(n[0])].filter(Boolean)),i.length||(i=canvas.tokens.controlled.filter(r=>r.actor)),i.length||(i=[Ie(game.user.character)].filter(Boolean)),i.length>1){ui.notifications.warn(h("action.only-one",{action:e}));return}if(!i.length){ui.notifications.warn(h("action.must-one",{action:e}));return}let o=i[0];if(!o?.actor?.isOfType("creature")){ui.notifications.warn(h("action.must-creature",{action:e}));return}return o}a(Ne,"getSelectedToken");function Pi(t,e,i){return`<button type="button" data-action="${t}" style="margin: 0 0 5px; padding: 0;">
    <i class="${e}"></i> ${i}</button>
</button>`}a(Pi,"createButton");var Si={geometry:{clearDebug:me,getRectEdges:at,lineIntersectWall:De,pointToTokenIntersectWall:st},token:{getCreatureCover:ut,getWallCover:lt,getVisibility:oe,clearConditionals:ye,showConditionals:Tt,showAllConditionals:pt,getTokenData:z,getCover:dt,openHUD:Et},lighting:{getLightExposure:ct},actor:{isProne:Z,getCoverEffect:te,seeInvisibility:Ke,hasGreaterDarkvision:He},scene:{getValidTokens:j,validateTokens:ne,getSceneSetting:Ee},template:{createSeekTemplate:Ze,createDarknessTemplate:Xt,createMistTemplate:Zt,getDarknessTemplates:Je,getMistTemplates:et,getSeekTemplateTokens:tt,deleteSeekTemplate:J,getTemplateTokens:Te},ruleElement:{perceptionRules:re,getPerception:B,updateFromPerceptionRules:Fe}};async function bi(t,...e){let i=e[1];if(!i)return t(...e);Array.isArray(i.options)&&(i.options=new Set(i.options));let{actor:n,createMessage:o="true",type:r,token:s,target:c,isReroll:l}=i,p=s??Ie(n),d=c?.token,u=ke.includes(r),g=O("flat-check");if(l||!o||!p||n.isOfType("hazard")||!Dt.includes(r)||u&&(!d||g==="none"))return t(...e);if(u&&d.actor){let m=e[2],y=re(p,d,{extraOptions:i.options.filter(A=>A.startsWith("item:"))}),k=oe(d,p,{perception:y,affects:"target"});if(!k)return t(...e);let R=(()=>{let A=B(y,"target","visibility","dc",k)?.first(),b=rt(A);if(!b)return b;let N=A[0];return["-","+"].includes(N)?(k==="concealed"?5:11)+b:b})();if(R===0)return t(...e);let E=P[k]>=P.undetected,S=m?.ctrlKey||m?.metaKey,T=(await new p.actor.saves.reflex.constructor(p.actor,{slug:"visibility-check",label:`${game.i18n.localize("PF2E.FlatCheck")}: ${game.i18n.localize(`PF2E.condition.${k}.name`)}`,check:{type:"flat-check"}}).roll({dc:{value:R??(k==="concealed"?5:11)},target:d.actor,rollMode:E||S?game.user.isGM?"gmroll":"blindroll":"roll"})).degreeOfSuccess>1;if(E&&(i.options.add("secret"),i.pf2ePerception={isSuccess:T,visibility:k}),g!=="roll"&&!E&&!T)return}else if(i.options.has("action:hide"))setProperty(i,"pf2ePerception.selected",game.user.targets.ids);else if(i.options.has("action:create-a-diversion"))setProperty(i,"pf2ePerception.selected",game.user.targets.ids);else if(i.options.has("action:seek")){let m=tt(p),y=m??Array.from(game.user.targets),k=ne(p,y).filter(R=>!R.document.hidden).map(R=>R.id);setProperty(i,"pf2ePerception.selected",k),setProperty(i,"pf2ePerception.fromTemplate",!!m)}return t(...e)}a(bi,"checkRoll");function Ei(t,e){let{createMessage:i="true",type:n,token:o,target:r,isReroll:s,options:c,dc:l}=t.context,p=o,d=r?.token,u=r?.actor;if(s||!i||!p||!d||!u||!ke.includes(n))return;let g=te(u),m=g?Be(g)?.selection.level??w(g,"level"):void 0,y=t[f]?.coverOverride??m,k='<div class="roll-mode-panel">';k+=`<div class="label">${h("dice-checks.cover.label")}</div>`,k+=`<select name="overrideCover"><option value="">${h("dice-checks.cover.none")}</option>`;let R=Z(u)?U.slice(1):U.slice(1,-1);for(let E of R){let S=E===y?"selected":"",F=h(`cover.${E}`);k+=`<option value="${E}" ${S}>${F}</option>`}k+="</select></div>",k+="<hr>",e.find(".roll-mode-panel").before(k),e.find("select[name=overrideCover]").on("change",E=>{let S=E.currentTarget.value||void 0;setProperty(t,`${f}.coverOverride`,S),y=S}),e.find("button.roll")[0].addEventListener("click",E=>{E.preventDefault(),E.stopPropagation(),E.stopImmediatePropagation();let S=!1,F=deepClone(u._source.items);if(y!==m){S=!0;let T=F.findIndex(A=>getProperty(A,"flags.core.sourceId")===Pe);if(T!==-1&&F.splice(T,1),y){let A=Se(y);F.push(A)}}if(S&&(r.actor=u.clone({items:F},{keepId:!0}),l?.slug)){let T=r.actor.getStatistic(l.slug)?.dc;T&&(l.value=T.value,l.statistic=T)}t.resolve(!0),t.isResolved=!0,t.close()},!0),t.setPosition()}a(Ei,"renderCheckModifiersDialog");function Ti(t,e){O("target")&&Zi(e)}a(Ti,"renderCombatTracker");function Zi(t){t.find("[data-control=toggleTarget]").each((e,i)=>{i.addEventListener("click",n=>{n.preventDefault(),n.stopPropagation(),n.stopImmediatePropagation();let{combatantId:o}=n.currentTarget.closest(".combatant").dataset,s=game.combats.viewed.combatants.get(o??"")?.token;if(!s)return;let c=Array.from(game.user.targets).some(l=>l.document===s);s.object.setTarget(!c,{releaseOthers:!n.shiftKey})},!0)})}a(Zi,"setupToggleTarget");function Ri(t,e){let i=O("encounter");e.find(".form-group").last().after(`<div class="form-group">
    <label>${h("settings.encounter.name")}</label>
    <input type="checkbox" name="pf2e-perception.encounter" ${i?"checked":""}>
    <p class="notes">${h("settings.encounter.short")}</p>
</div>`),e.find('input[name="pf2e-perception.encounter"]').on("change",n=>{let o=n.currentTarget.checked;Ue("encounter",o)})}a(Ri,"renderCombatTrackerConfig");function xi(t,e,i={}){return!e.enabled||!this._canDetect(t,i.object,i)?!1:i.tests.some(n=>this._testPoint(t,e,i.object,n))}a(xi,"detectionModeTestVisibility");function Fi(t,e,i){if(e instanceof PlaceableObject&&e.document.hidden)return!1;if(!(e instanceof Token))return!0;let n=t.object,o=n.document;return o instanceof TokenDocument&&o.hasStatusEffect(CONFIG.specialStatusEffects.BLIND)?!1:n instanceof Token?!Ct(n,e,P.hidden,i):!e.document?.hasStatusEffect(CONFIG.specialStatusEffects.INVISIBLE)&&!e.actor?.hasCondition("hidden","undetected","unnoticed")}a(Fi,"basicSightCanDetect");function Ni(t,e,i){if(e.document.hidden||!(e instanceof Token)||!e.actor?.emitsSound)return!1;if(!game.settings.get("pf2e","automation.rulesBasedVision"))return!0;let n=t.object;return n.actor?.hasCondition("deafened")?!1:n instanceof Token?!Ct(n,e,P.undetected,i):!e.actor?.hasCondition("undetected","unnoticed")}a(Ni,"hearingCanDetect");function Ci(t,e,i){if(e.document.hidden||!(e instanceof Token)||e.document.elevation>canvas.primary.background.elevation||e.actor?.isOfType("loot"))return!1;let n=t.object;return n instanceof Token?!Ct(n,e,P.undetected,i):!e.actor?.hasCondition("undetected","unnoticed")}a(Ci,"feelTremorCanDetect");function Ct(t,e,i,n={}){if(!n.visibility){let o=re(t,e);n.visibility=oe(e,t,{perception:o,affects:"target"})}return P[n.visibility]>=i}a(Ct,"reachesThreshold");function Ji(t,e,i){let n=t.length-e.length,o=Array.from(e);if(n===0)return t(...o);if(n===1){let r=a(s=>t(s,...o),"ret");return(i||t.lazy)&&(r.lazy=i||t.lazy,r.lazyArgs=e),r}throw new Error("Wrong number of arguments")}a(Ji,"purry");function en(t,e,i){let n=[];for(let o=0;o<t.length;o++){let r=t[o],s=i?e(r,o,t):e(r);s.hasMany===!0?n.push(...s.next):s.hasNext&&n.push(s.next)}return n}a(en,"_reduceLazy");function Oi(){let t=new Set;return e=>t.has(e)?{done:!1,hasNext:!1}:(t.add(e),{done:!1,hasNext:!0,next:e})}a(Oi,"uniqLazy");function tn(t){return en(t,Oi())}a(tn,"_uniq");var se={compact:t=>t.filter(Boolean),uniq:function(){return Ji(tn,arguments,Oi)}};var H=class extends Array{constructor(...e){super(...Array.isArray(e[0])?e[0]:e),this.isValid=H.isValid(this)}static isValid(e){return this.isArray(e)}static isArray(e){return super.isArray(e)&&e.every(i=>he.isStatement(i))}static test(e=[],i){return e instanceof H?e.test(i):new H(...e).test(i)}test(e){if(this.length===0)return!0;if(!this.isValid)return console.warn("PF2e System | The provided predicate set is malformed."),!1;let i=e instanceof Set?e:new Set(e);return this.every(n=>this.#e(n,i))}toObject(){return deepClone([...this])}clone(){return new H(this.toObject())}#e(e,i){return typeof e=="string"&&i.has(e)||he.isBinaryOp(e)&&this.#i(e,i)||he.isCompound(e)&&this.#t(e,i)}#i(e,i){if("eq"in e)return i.has(`${e.eq[0]}:${e.eq[1]}`);{let n=Object.keys(e)[0],[o,r]=Object.values(e)[0],s=Array.from(i),c=a(d=>{let u=Number(d);if(!Number.isNaN(u))return[u];let g=new RegExp(String.raw`^${d}:([^:]+)$`),m=s.map(y=>Number(g.exec(y)?.[1]||NaN)).filter(y=>!Number.isNaN(y));return m.length>0?m:[NaN]},"getValues"),l=c(o),p=c(r);switch(n){case"gt":return l.some(d=>p.every(u=>d>u));case"gte":return l.some(d=>p.every(u=>d>=u));case"lt":return l.some(d=>p.every(u=>d<u));case"lte":return l.some(d=>p.every(u=>d<=u));default:return console.warn("PF2e System | Malformed binary operation encountered"),!1}}}#t(e,i){return"and"in e&&e.and.every(n=>this.#e(n,i))||"nand"in e&&!e.nand.every(n=>this.#e(n,i))||"or"in e&&e.or.some(n=>this.#e(n,i))||"xor"in e&&e.xor.filter(n=>this.#e(n,i)).length===1||"nor"in e&&!e.nor.some(n=>this.#e(n,i))||"not"in e&&!this.#e(e.not,i)||"if"in e&&!(this.#e(e.if,i)&&!this.#e(e.then,i))}};a(H,"PredicatePF2e");var ft,he=class{static isStatement(e){return e instanceof Object?this.isCompound(e)||this.isBinaryOp(e):typeof e=="string"?this.isAtomic(e):!1}static isAtomic(e){return typeof e=="string"&&e.length>0||this.isBinaryOp(e)}static isBinaryOp(e){if(!kt(e))return!1;let i=Object.entries(e);if(i.length>1)return!1;let[n,o]=i[0];return Wt(this,ft).has(n)&&Array.isArray(o)&&o.length===2&&typeof o[0]=="string"&&["string","number"].includes(typeof o[1])}static isCompound(e){return kt(e)&&(this.isAnd(e)||this.isOr(e)||this.isNand(e)||this.isXor(e)||this.isNor(e)||this.isNot(e)||this.isIf(e))}static isAnd(e){return Object.keys(e).length===1&&Array.isArray(e.and)&&e.and.every(i=>this.isStatement(i))}static isNand(e){return Object.keys(e).length===1&&Array.isArray(e.nand)&&e.nand.every(i=>this.isStatement(i))}static isOr(e){return Object.keys(e).length===1&&Array.isArray(e.or)&&e.or.every(i=>this.isStatement(i))}static isXor(e){return Object.keys(e).length===1&&Array.isArray(e.xor)&&e.xor.every(i=>this.isStatement(i))}static isNor(e){return Object.keys(e).length===1&&Array.isArray(e.nor)&&e.nor.every(i=>this.isStatement(i))}static isNot(e){return Object.keys(e).length===1&&!!e.not&&this.isStatement(e.not)}static isIf(e){return Object.keys(e).length===2&&this.isStatement(e.if)&&this.isStatement(e.then)}};a(he,"StatementValidator"),ft=new WeakMap,ue(he,ft,new Set(["eq","gt","gte","lt","lte"]));var nn={ancestralEchoing:{level:15,name:"PF2E.WeaponPropertyRune.ancestralEchoing.Name",price:9500,rarity:"rare",slug:"ancestralEchoing",traits:["dwarf","magical","saggorak"]},anchoring:{damage:{notes:[{outcome:["criticalSuccess"],title:"PF2E.WeaponPropertyRune.anchoring.Name",text:"PF2E.WeaponPropertyRune.anchoring.Note.criticalSuccess"}]},level:10,name:"PF2E.WeaponPropertyRune.anchoring.Name",price:900,rarity:"uncommon",slug:"anchoring",traits:["magical"]},ashen:{damage:{dice:[{damageType:"fire",category:"persistent",diceNumber:1,dieSize:"d4"}],notes:[{outcome:["success"],title:"PF2E.WeaponPropertyRune.ashen.Name",text:"PF2E.WeaponPropertyRune.ashen.Note.success"}]},level:9,name:"PF2E.WeaponPropertyRune.ashen.Name",price:700,rarity:"common",slug:"ashen",traits:["magical"]},astral:{level:8,name:"PF2E.WeaponPropertyRune.astral.Name",price:450,rarity:"common",slug:"astral",traits:["magical","spirit"],damage:{dice:[{damageType:"spirit",diceNumber:1,dieSize:"d6"}]}},authorized:{level:3,name:"PF2E.WeaponPropertyRune.authorized.Name",price:50,rarity:"common",slug:"authorized",traits:["magical"]},bane:{level:4,name:"PF2E.WeaponPropertyRune.bane.Name",price:100,rarity:"uncommon",slug:"bane",traits:["magical"]},bloodbane:{level:8,name:"PF2E.WeaponPropertyRune.bloodbane.Name",price:475,rarity:"uncommon",slug:"bloodbane",traits:["dwarf","magical"]},bloodthirsty:{damage:{notes:[{outcome:["criticalSuccess"],title:"PF2E.WeaponPropertyRune.bloodbane.Name",text:"PF2E.WeaponPropertyRune.bloodthirsty.Note.criticalSuccess"}]},level:16,name:"PF2E.WeaponPropertyRune.bloodthirsty.Name",price:8500,rarity:"uncommon",slug:"bloodthirsty",traits:["magical"]},brilliant:{damage:{dice:[{damageType:"fire",diceNumber:1,dieSize:"d4"},{damageType:"spirit",diceNumber:1,dieSize:"d4",predicate:["target:trait:fiend"]},{damageType:"vitality",diceNumber:1,dieSize:"d4",predicate:["target:negative-healing"]}],notes:[{outcome:["criticalSuccess"],title:"PF2E.WeaponPropertyRune.brilliant.Name",text:"PF2E.WeaponPropertyRune.brilliant.Note.criticalSuccess"}]},level:12,name:"PF2E.WeaponPropertyRune.brilliant.Name",price:2e3,rarity:"common",slug:"brilliant",traits:["magical"]},called:{level:7,name:"PF2E.WeaponPropertyRune.called.Name",price:350,rarity:"common",slug:"called",traits:["magical"]},coating:{level:9,name:"PF2E.WeaponPropertyRune.coating.Name",price:700,rarity:"common",slug:"coating",traits:["extradimensional","magical"]},conducting:{level:7,name:"PF2E.WeaponPropertyRune.conducting.Name",price:300,rarity:"common",slug:"conducting",traits:["magical"]},corrosive:{damage:{dice:[{damageType:"acid",diceNumber:1,dieSize:"d6"}],notes:[{outcome:["criticalSuccess"],title:"PF2E.WeaponPropertyRune.corrosive.Name",text:"PF2E.WeaponPropertyRune.corrosive.Note.criticalSuccess"}]},level:8,name:"PF2E.WeaponPropertyRune.corrosive.Name",price:500,rarity:"common",slug:"corrosive",traits:["acid","magical"]},crushing:{damage:{notes:[{outcome:["criticalSuccess"],title:"PF2E.WeaponPropertyRune.crushing.Name",text:"PF2E.WeaponPropertyRune.crushing.Note.criticalSuccess"}]},level:3,name:"PF2E.WeaponPropertyRune.crushing.Name",price:50,rarity:"uncommon",slug:"crushing",traits:["magical"]},cunning:{level:5,name:"PF2E.WeaponPropertyRune.cunning.Name",price:140,rarity:"common",slug:"cunning",traits:["magical"]},dancing:{level:13,name:"PF2E.WeaponPropertyRune.dancing.Name",price:2700,rarity:"uncommon",slug:"dancing",traits:["magical"]},decaying:{damage:{dice:[{slug:"decaying",damageType:"void",diceNumber:1,dieSize:"d4"},{slug:"decaying-persistent",category:"persistent",damageType:"void",diceNumber:2,dieSize:"d4",critical:!0}]},level:8,name:"PF2E.WeaponPropertyRune.decaying.Name",price:500,rarity:"common",slug:"decaying",traits:["acid","magical","void"]},deathdrinking:{damage:{dice:[{slug:"deathdrinking-negative",damageType:"void",diceNumber:1,dieSize:"d6",critical:!0,predicate:["target:mode:living",{not:"target:negative-healing"}]},{slug:"deathdrinking-positive",damageType:"vitality",diceNumber:1,dieSize:"d6",critical:!0,predicate:["target:negative-healing"]}]},level:7,name:"PF2E.WeaponPropertyRune.deathdrinking.Name",price:360,rarity:"rare",slug:"deathdrinking",traits:["magical"]},demolishing:{damage:{dice:[{damageType:"force",category:"persistent",diceNumber:1,dieSize:"d6",predicate:["target:trait:construct"]}]},level:6,name:"PF2E.WeaponPropertyRune.demolishing.Name",price:225,rarity:"rare",slug:"demolishing",traits:["magical"]},disrupting:{damage:{dice:[{category:"persistent",damageType:"vitality",diceNumber:1,dieSize:"d6",predicate:["target:negative-healing"]}],notes:[{outcome:["criticalSuccess"],title:"PF2E.WeaponPropertyRune.disrupting.Name",text:"PF2E.WeaponPropertyRune.disrupting.Note.criticalSuccess",predicate:["target:negative-healing"]}]},level:5,name:"PF2E.WeaponPropertyRune.disrupting.Name",price:150,rarity:"common",slug:"disrupting",traits:["magical"]},earthbinding:{level:5,name:"PF2E.WeaponPropertyRune.earthbinding.Name",price:125,rarity:"common",slug:"earthbinding",traits:["magical"]},energizing:{level:6,name:"PF2E.WeaponPropertyRune.energizing.Name",price:250,rarity:"uncommon",slug:"energizing",traits:["magical"]},extending:{level:7,name:"PF2E.WeaponPropertyRune.extending.Name",price:700,rarity:"common",slug:"extending",traits:["magical"]},fanged:{level:2,name:"PF2E.WeaponPropertyRune.fanged.Name",price:30,rarity:"uncommon",slug:"fanged",traits:["magical"]},fearsome:{damage:{notes:[{outcome:["criticalSuccess"],title:"PF2E.WeaponPropertyRune.fearsome.Name",text:"PF2E.WeaponPropertyRune.fearsome.Note.criticalSuccess"}]},level:5,name:"PF2E.WeaponPropertyRune.fearsome.Name",price:160,rarity:"common",slug:"fearsome",traits:["emotion","fear","magical","mental"]},flaming:{damage:{dice:[{damageType:"fire",diceNumber:1,dieSize:"d6"},{damageType:"fire",category:"persistent",diceNumber:1,dieSize:"d10",critical:!0}]},level:8,name:"PF2E.WeaponPropertyRune.flaming.Name",price:500,rarity:"common",slug:"flaming",traits:["fire","magical"]},flurrying:{level:7,name:"PF2E.WeaponPropertyRune.flurrying.Name",price:360,rarity:"common",slug:"flurrying",traits:["magical"]},frost:{damage:{dice:[{damageType:"cold",diceNumber:1,dieSize:"d6"}],notes:[{outcome:["criticalSuccess"],title:"PF2E.WeaponPropertyRune.frost.Name",text:"PF2E.WeaponPropertyRune.frost.Note.criticalSuccess"}]},level:8,name:"PF2E.WeaponPropertyRune.frost.Name",price:500,rarity:"common",slug:"frost",traits:["cold","magical"]},ghostTouch:{level:4,name:"PF2E.WeaponPropertyRune.ghostTouch.Name",price:75,rarity:"common",slug:"ghostTouch",traits:["magical"]},giantKilling:{damage:{dice:[{slug:"giantKilling",damageType:"mental",diceNumber:1,dieSize:"d6",predicate:["target:trait:giant"]}],notes:[{outcome:["criticalSuccess"],predicate:["target:trait:giant"],title:"PF2E.WeaponPropertyRune.giantKilling.Name",text:"PF2E.WeaponPropertyRune.giantKilling.Note.criticalSuccess"}]},level:8,name:"PF2E.WeaponPropertyRune.giantKilling.Name",price:450,rarity:"rare",slug:"giantKilling",traits:["magical"]},greaterAnchoring:{damage:{notes:[{outcome:["criticalSuccess"],title:"PF2E.WeaponPropertyRune.greaterAnchoring.Name",text:"PF2E.WeaponPropertyRune.greaterAnchoring.Note.criticalSuccess"},{outcome:["success"],title:"PF2E.WeaponPropertyRune.greaterAnchoring.Name",text:"PF2E.WeaponPropertyRune.greaterAnchoring.Note.success"}]},level:18,name:"PF2E.WeaponPropertyRune.greaterAnchoring.Name",price:22e3,rarity:"uncommon",slug:"greaterAnchoring",traits:["magical"]},greaterAshen:{damage:{dice:[{damageType:"fire",category:"persistent",diceNumber:1,dieSize:"d8"}],notes:[{outcome:["success"],title:"PF2E.WeaponPropertyRune.greaterAshen.Name",text:"PF2E.WeaponPropertyRune.greaterAshen.Note.success"}]},level:16,name:"PF2E.WeaponPropertyRune.greaterAshen.Name",price:9e3,rarity:"common",slug:"greaterAshen",traits:["magical"]},greaterAstral:{level:15,name:"PF2E.WeaponPropertyRune.greaterAstral.Name",price:6e3,rarity:"common",slug:"greaterAstral",traits:["magical","spirit"],damage:{dice:[{damageType:"spirit",diceNumber:1,dieSize:"d6"}],ignoredResistances:[{type:"spirit",max:null}]}},greaterBloodbane:{level:13,name:"PF2E.WeaponPropertyRune.greaterBloodbane.Name",price:2800,rarity:"uncommon",slug:"greaterBloodbane",traits:["dwarf","magical"]},greaterBrilliant:{damage:{dice:[{damageType:"fire",diceNumber:1,dieSize:"d4"},{damageType:"spirit",diceNumber:1,dieSize:"d4",predicate:["target:trait:fiend"]},{damageType:"vitality",diceNumber:1,dieSize:"d4",predicate:["target:negative-healing"]}],notes:[{outcome:["criticalSuccess"],title:"PF2E.WeaponPropertyRune.greaterBrilliant.Name",text:"PF2E.WeaponPropertyRune.greaterBrilliant.Note.criticalSuccess"},{outcome:["success"],title:"PF2E.WeaponPropertyRune.greaterBrilliant.Name",text:"PF2E.WeaponPropertyRune.greaterBrilliant.Note.success"}],ignoredResistances:[{type:"fire",max:null},{type:"spirit",max:null},{type:"vitality",max:null}]},level:18,name:"PF2E.WeaponPropertyRune.greaterBrilliant.Name",price:24e3,rarity:"common",slug:"greaterBrilliant",traits:["magical"]},greaterCorrosive:{damage:{dice:[{damageType:"acid",diceNumber:1,dieSize:"d6"}],notes:[{outcome:["criticalSuccess"],title:"PF2E.WeaponPropertyRune.greaterCorrosive.Name",text:"PF2E.WeaponPropertyRune.greaterCorrosive.Note.criticalSuccess"},{outcome:["success"],title:"PF2E.WeaponPropertyRune.greaterCorrosive.Name",text:"PF2E.WeaponPropertyRune.greaterCorrosive.Note.success"}],ignoredResistances:[{type:"acid",max:null}]},level:15,name:"PF2E.WeaponPropertyRune.greaterCorrosive.Name",price:6500,rarity:"common",slug:"greaterCorrosive",traits:["acid","magical"]},greaterCrushing:{damage:{notes:[{outcome:["criticalSuccess"],title:"PF2E.WeaponPropertyRune.greaterCrushing.Name",text:"PF2E.WeaponPropertyRune.greaterCrushing.Note.criticalSuccess"}]},level:9,name:"PF2E.WeaponPropertyRune.greaterCrushing.Name",price:650,rarity:"uncommon",slug:"greaterCrushing",traits:["magical"]},greaterDecaying:{damage:{dice:[{slug:"decaying",damageType:"void",diceNumber:1,dieSize:"d4"},{slug:"decaying-persistent",category:"persistent",damageType:"void",diceNumber:4,dieSize:"d4",critical:!0}],ignoredResistances:[{type:"void",max:null}]},level:15,name:"PF2E.WeaponPropertyRune.greaterDecaying.Name",price:6500,rarity:"common",slug:"greaterDecaying",traits:["acid","magical","void"]},greaterDisrupting:{damage:{dice:[{category:"persistent",damageType:"vitality",diceNumber:2,dieSize:"d6",predicate:["target:negative-healing"]}],notes:[{outcome:["criticalSuccess"],title:"PF2E.WeaponPropertyRune.greaterDisrupting.Name",text:"PF2E.WeaponPropertyRune.greaterDisrupting.Note.criticalSuccess",predicate:["target:negative-healing"]}]},level:14,name:"PF2E.WeaponPropertyRune.greaterDisrupting.Name",price:4300,rarity:"uncommon",slug:"greaterDisrupting",traits:["magical"]},greaterExtending:{level:13,name:"PF2E.WeaponPropertyRune.greaterExtending.Name",price:3e3,rarity:"common",slug:"greaterExtending",traits:["magical"]},greaterFanged:{level:8,name:"PF2E.WeaponPropertyRune.greaterFanged.Name",price:425,rarity:"uncommon",slug:"greaterFanged",traits:["magical"]},greaterFearsome:{damage:{notes:[{outcome:["criticalSuccess"],title:"PF2E.WeaponPropertyRune.greaterFearsome.Name",text:"PF2E.WeaponPropertyRune.greaterFearsome.Note.criticalSuccess"}]},level:12,name:"PF2E.WeaponPropertyRune.greaterFearsome.Name",price:2e3,rarity:"common",slug:"greaterFearsome",traits:["emotion","fear","magical","mental"]},greaterFlaming:{damage:{dice:[{damageType:"fire",diceNumber:1,dieSize:"d6"},{damageType:"fire",category:"persistent",diceNumber:2,dieSize:"d10",critical:!0}],notes:[{outcome:["criticalSuccess"],title:"PF2E.WeaponPropertyRune.greaterFlaming.Name",text:"PF2E.WeaponPropertyRune.greaterFlaming.Note.criticalSuccess"},{outcome:["success"],title:"PF2E.WeaponPropertyRune.greaterFlaming.Name",text:"PF2E.WeaponPropertyRune.greaterFlaming.Note.success"}],ignoredResistances:[{type:"fire",max:null}]},level:15,name:"PF2E.WeaponPropertyRune.greaterFlaming.Name",price:6500,rarity:"common",slug:"greaterFlaming",traits:["fire","magical"]},greaterFrost:{damage:{dice:[{damageType:"cold",diceNumber:1,dieSize:"d6"}],notes:[{outcome:["criticalSuccess"],title:"PF2E.WeaponPropertyRune.greaterFrost.Name",text:"PF2E.WeaponPropertyRune.greaterFrost.Note.criticalSuccess"},{outcome:["success"],title:"PF2E.WeaponPropertyRune.greaterFrost.Name",text:"PF2E.WeaponPropertyRune.greaterFrost.Note.success"}],ignoredResistances:[{type:"cold",max:null}]},level:15,name:"PF2E.WeaponPropertyRune.greaterFrost.Name",price:6500,rarity:"common",slug:"greaterFrost",traits:["cold","magical"]},greaterGiantKilling:{damage:{dice:[{slug:"greaterGiantKilling",damageType:"mental",diceNumber:2,dieSize:"d6",predicate:["target:trait:giant"]}],ignoredResistances:[{type:"mental",max:null}],notes:[{outcome:["criticalSuccess"],predicate:["target:trait:giant"],title:"PF2E.WeaponPropertyRune.greaterGiantKilling.Name",text:"PF2E.WeaponPropertyRune.greaterGiantKilling.Note.criticalSuccess"}]},level:15,name:"PF2E.WeaponPropertyRune.greaterGiantKilling.Name",price:6e3,rarity:"rare",slug:"greaterGiantKilling",traits:["magical"]},greaterHauling:{level:11,name:"PF2E.WeaponPropertyRune.greaterHauling.Name",price:1300,rarity:"uncommon",slug:"greaterHauling",traits:["magical"]},greaterImpactful:{damage:{dice:[{damageType:"force",diceNumber:1,dieSize:"d6"}],notes:[{outcome:["criticalSuccess"],title:"PF2E.WeaponPropertyRune.greaterImpactful.Name",text:"PF2E.WeaponPropertyRune.greaterImpactful.Note.criticalSuccess"}]},level:17,name:"PF2E.WeaponPropertyRune.greaterImpactful.Name",price:15e3,rarity:"common",slug:"greaterImpactful",traits:["force","magical"]},greaterRooting:{level:11,name:"PF2E.WeaponPropertyRune.greaterRooting.Name",price:1400,rarity:"common",slug:"greaterRooting",traits:["plant","magical","wood"],damage:{notes:[{outcome:["criticalSuccess"],title:"PF2E.WeaponPropertyRune.greaterRooting.Name",text:"PF2E.WeaponPropertyRune.greaterRooting.Note.criticalSuccess"},{outcome:["success"],title:"PF2E.WeaponPropertyRune.greaterRooting.Name",text:"PF2E.WeaponPropertyRune.greaterRooting.Note.success"}]}},greaterShock:{damage:{dice:[{damageType:"electricity",diceNumber:1,dieSize:"d6"}],notes:[{outcome:["criticalSuccess"],title:"PF2E.WeaponPropertyRune.greaterShock.Name",text:"PF2E.WeaponPropertyRune.greaterShock.Note.criticalSuccess"},{outcome:["success"],title:"PF2E.WeaponPropertyRune.greaterShock.Name",text:"PF2E.WeaponPropertyRune.greaterShock.Note.success"}],ignoredResistances:[{type:"electricity",max:null}]},level:15,name:"PF2E.WeaponPropertyRune.greaterShock.Name",price:6500,rarity:"common",slug:"greaterShock",traits:["electricity","magical"]},greaterThundering:{damage:{dice:[{damageType:"sonic",diceNumber:1,dieSize:"d6"}],notes:[{outcome:["criticalSuccess"],title:"PF2E.WeaponPropertyRune.greaterThundering.Name",text:"PF2E.WeaponPropertyRune.greaterThundering.Note.criticalSuccess"},{outcome:["success"],title:"PF2E.WeaponPropertyRune.greaterThundering.Name",text:"PF2E.WeaponPropertyRune.greaterThundering.Note.success"}],ignoredResistances:[{type:"sonic",max:null}]},level:15,name:"PF2E.WeaponPropertyRune.greaterThundering.Name",price:6500,rarity:"common",slug:"greaterThundering",traits:["magical","sonic"]},grievous:{damage:{dice:[{damageType:"bleed",diceNumber:1,dieSize:"d6",critical:!0,predicate:["critical-specialization","item:group:dart"]}],notes:[{outcome:["criticalSuccess"],predicate:["item:group:axe"],title:"PF2E.WeaponPropertyRune.grievous.Name",text:"PF2E.WeaponPropertyRune.grievous.Note.Axe"},{outcome:["criticalSuccess"],predicate:["item:group:brawling"],title:"PF2E.WeaponPropertyRune.grievous.Name",text:"PF2E.WeaponPropertyRune.grievous.Note.Brawling"},{outcome:["criticalSuccess"],predicate:["item:group:club"],title:"PF2E.WeaponPropertyRune.grievous.Name",text:"PF2E.WeaponPropertyRune.grievous.Note.Club"},{outcome:["criticalSuccess"],predicate:["item:group:flail"],title:"PF2E.WeaponPropertyRune.grievous.Name",text:"PF2E.WeaponPropertyRune.grievous.Note.Flail"},{outcome:["criticalSuccess"],predicate:["item:group:hammer"],title:"PF2E.WeaponPropertyRune.grievous.Name",text:"PF2E.WeaponPropertyRune.grievous.Note.Hammer"},{outcome:["criticalSuccess"],predicate:["item:group:knife"],title:"PF2E.WeaponPropertyRune.grievous.Name",text:"PF2E.WeaponPropertyRune.grievous.Note.Knife"},{outcome:["criticalSuccess"],predicate:["item:group:polearm"],title:"PF2E.WeaponPropertyRune.grievous.Name",text:"PF2E.WeaponPropertyRune.grievous.Note.Polearm"},{outcome:["criticalSuccess"],predicate:["item:group:shield"],title:"PF2E.WeaponPropertyRune.grievous.Name",text:"PF2E.WeaponPropertyRune.grievous.Note.Shield"},{outcome:["criticalSuccess"],predicate:["item:group:sling"],title:"PF2E.WeaponPropertyRune.grievous.Name",text:"PF2E.WeaponPropertyRune.grievous.Note.Sling"},{outcome:["criticalSuccess"],predicate:["item:group:spear"],title:"PF2E.WeaponPropertyRune.grievous.Name",text:"PF2E.WeaponPropertyRune.grievous.Note.Spear"},{outcome:["criticalSuccess"],predicate:["item:group:sword"],title:"PF2E.WeaponPropertyRune.grievous.Name",text:"PF2E.WeaponPropertyRune.grievous.Note.Sword"}],adjustments:[{slug:"critical-specialization",test:t=>new H("item:group:pick").test(t),getNewValue:t=>t*2}]},level:9,name:"PF2E.WeaponPropertyRune.grievous.Name",price:700,rarity:"common",slug:"grievous",traits:["magical"]},hauling:{level:6,name:"PF2E.WeaponPropertyRune.hauling.Name",price:225,rarity:"uncommon",slug:"hauling",traits:["magical"]},holy:{level:11,name:"PF2E.WeaponPropertyRune.holy.Name",price:1400,rarity:"common",slug:"holy",traits:["holy","magical"],damage:{dice:[{damageType:"spirit",diceNumber:1,dieSize:"d4",predicate:[{not:"target:trait:unholy"}]},{damageType:"spirit",diceNumber:2,dieSize:"d4",predicate:["target:trait:unholy"]}]},strikeAdjustments:[{adjustTraits:(t,e)=>{e.includes("holy")||e.push("holy")}}]},hopeful:{attack:{notes:[{outcome:["criticalSuccess"],title:"PF2E.WeaponPropertyRune.hopeful.Name",text:"PF2E.WeaponPropertyRune.hopeful.Note.criticalSuccess"}]},level:11,name:"PF2E.WeaponPropertyRune.hopeful.Name",price:1200,rarity:"uncommon",slug:"hopeful",traits:["magical"]},hooked:{level:5,name:"PF2E.WeaponPropertyRune.hooked.Name",price:140,rarity:"rare",slug:"hooked",traits:["magical"],strikeAdjustments:[{adjustWeapon:t=>{t.system.traits.value.includes("trip")||t.system.traits.value.push("trip")}}]},impactful:{damage:{dice:[{damageType:"force",diceNumber:1,dieSize:"d6"}],notes:[{outcome:["criticalSuccess"],title:"PF2E.WeaponPropertyRune.impactful.Name",text:"PF2E.WeaponPropertyRune.impactful.Note.criticalSuccess"}]},level:10,name:"PF2E.WeaponPropertyRune.impactful.Name",price:1e3,rarity:"common",slug:"impactful",traits:["force","magical"]},impossible:{level:20,name:"PF2E.WeaponPropertyRune.impossible.Name",price:7e4,rarity:"common",slug:"impossible",traits:["magical"],strikeAdjustments:[{adjustWeapon:t=>{if(t.isOfType("weapon")&&t.system.range&&t._source.system.range){let e=t._source.system.range,i=t.system.range;t.system.range=e*2+Math.abs(i-e)}}}]},keen:{attack:{dosAdjustments:[{adjustments:{success:{label:"PF2E.WeaponPropertyRune.keen.Name",amount:"criticalSuccess"}},predicate:new H(["check:total:natural:19",{or:["item:damage:type:slashing","item:damage:type:piercing"]}])}]},level:13,name:"PF2E.WeaponPropertyRune.keen.Name",price:3e3,rarity:"uncommon",slug:"keen",traits:["magical"]},kinWarding:{level:3,name:"PF2E.WeaponPropertyRune.kinWarding.Name",price:52,rarity:"uncommon",slug:"kinWarding",traits:["dwarf","magical"]},majorFanged:{level:15,name:"PF2E.WeaponPropertyRune.majorFanged.Name",price:6e3,rarity:"uncommon",slug:"majorFanged",traits:["magical"]},majorRooting:{level:15,name:"PF2E.WeaponPropertyRune.majorRooting.Name",price:6500,rarity:"common",slug:"majorRooting",traits:["plant","magical","wood"],damage:{notes:[{outcome:["criticalSuccess"],title:"PF2E.WeaponPropertyRune.majorRooting.Name",text:"PF2E.WeaponPropertyRune.majorRooting.Note.criticalSuccess"}]}},merciful:{strikeAdjustments:[{adjustWeapon:t=>{t.system.traits.value.includes("nonlethal")||t.system.traits.value.push("nonlethal")}}],level:4,name:"PF2E.WeaponPropertyRune.merciful.Name",price:70,rarity:"common",slug:"merciful",traits:["magical","mental"]},pacifying:{level:5,name:"PF2E.WeaponPropertyRune.pacifying.Name",price:150,rarity:"uncommon",slug:"pacifying",traits:["magical"]},returning:{attack:{notes:[{title:"PF2E.WeaponPropertyRune.returning.Name",text:"PF2E.WeaponPropertyRune.returning.Note"}]},level:3,name:"PF2E.WeaponPropertyRune.returning.Name",price:55,rarity:"common",slug:"returning",traits:["magical"]},rooting:{level:7,name:"PF2E.WeaponPropertyRune.rooting.Name",price:360,rarity:"common",slug:"rooting",traits:["plant","magical","wood"],damage:{notes:[{outcome:["criticalSuccess"],title:"PF2E.WeaponPropertyRune.rooting.Name",text:"PF2E.WeaponPropertyRune.rooting.Note.criticalSuccess"}]}},serrating:{damage:{dice:[{damageType:"slashing",diceNumber:1,dieSize:"d4"}]},level:10,name:"PF2E.WeaponPropertyRune.serrating.Name",price:1e3,rarity:"uncommon",slug:"serrating",traits:["magical"]},shifting:{level:6,name:"PF2E.WeaponPropertyRune.shifting.Name",price:225,rarity:"common",slug:"shifting",traits:["magical"]},shock:{damage:{dice:[{damageType:"electricity",diceNumber:1,dieSize:"d6"}],notes:[{outcome:["criticalSuccess"],title:"PF2E.WeaponPropertyRune.shock.Name",text:"PF2E.WeaponPropertyRune.shock.Note.criticalSuccess"}]},level:8,name:"PF2E.WeaponPropertyRune.shock.Name",price:500,rarity:"common",slug:"shock",traits:["electricity","magical"]},speed:{level:16,name:"PF2E.Actor.Speed.Label",price:1e4,rarity:"rare",slug:"speed",traits:["magical"]},spellStoring:{level:13,name:"PF2E.WeaponPropertyRune.spellStoring.Name",price:2700,rarity:"uncommon",slug:"spellStoring",traits:["magical"]},swarming:{level:9,name:"PF2E.WeaponPropertyRune.swarming.Name",price:700,rarity:"common",slug:"swarming",traits:["magical"]},thundering:{damage:{dice:[{damageType:"sonic",diceNumber:1,dieSize:"d6"}],notes:[{outcome:["criticalSuccess"],title:"PF2E.WeaponPropertyRune.thundering.Name",text:"PF2E.WeaponPropertyRune.thundering.Note.criticalSuccess"}]},level:8,name:"PF2E.WeaponPropertyRune.thundering.Name",price:500,rarity:"common",slug:"thundering",traits:["magical","sonic"]},trueRooting:{level:19,name:"PF2E.WeaponPropertyRune.trueRooting.Name",price:4e4,rarity:"common",slug:"trueRooting",traits:["plant","magical","wood"],damage:{notes:[{outcome:["criticalSuccess"],title:"PF2E.WeaponPropertyRune.trueRooting.Name",text:"PF2E.WeaponPropertyRune.trueRooting.Note.criticalSuccess"}]}},underwater:{level:3,name:"PF2E.WeaponPropertyRune.underwater.Name",price:50,rarity:"common",slug:"underwater",traits:["magical","water"]},unholy:{level:11,name:"PF2E.WeaponPropertyRune.unholy.Name",price:1400,rarity:"common",slug:"unholy",traits:["unholy","magical"],damage:{dice:[{damageType:"spirit",diceNumber:1,dieSize:"d4",predicate:[{not:"target:trait:holy"}]},{damageType:"spirit",diceNumber:2,dieSize:"d4",predicate:["target:trait:holy"]}]},strikeAdjustments:[{adjustTraits:(t,e)=>{e.includes("unholy")||e.push("unholy")}}]},vorpal:{level:17,name:"PF2E.WeaponPropertyRune.vorpal.Name",price:15e3,rarity:"rare",slug:"vorpal",traits:["magical"]},wounding:{damage:{dice:[{damageType:"bleed",diceNumber:1,dieSize:"d6"}]},level:7,name:"PF2E.WeaponPropertyRune.wounding.Name",price:340,rarity:"common",slug:"wounding",traits:["magical"]}};function Ii(t){return t.flatMap(e=>nn[e].strikeAdjustments??[])}a(Ii,"getPropertyRuneStrikeAdjustments");async function Ai(t){let[e,i]=canvas.ready&&!t.viewOnly?[canvas.tokens.controlled.find(v=>v.actor===this)??this.getActiveTokens().shift()??null,t.target?.token??t.target?.actor?.getActiveTokens().shift()??null]:[null,null],n=["attack","attack-roll","attack-damage"].some(v=>t.domains.includes(v)),o=!!(t.melee||t.item?.isOfType("weapon","melee")&&t.item.isMelee),r=o&&t.item?.isOfType("action","weapon","melee")?this.getReach({action:"attack",weapon:t.item}):this.getReach({action:"attack"}),s=!!(n&&o&&typeof r=="number"&&i?.actor&&e?.isFlanking(i,{reach:r})),c=await Pt({affects:"origin",origin:this,target:t.target?.actor??i?.actor??null,item:t.item??null,domains:t.domains,options:[...t.options,...t.item?.getRollOptions("item")??[]]}),l=(()=>{let v=i?this.synthetics.tokenMarks.get(i.document.uuid):null;return v?`target:mark:${v}`:null})(),p=t.traits?.map(v=>`self:action:trait:${v}`)??[],d=t.viewOnly||!i?.actor?this:this.getContextualClone(se.compact([...Array.from(t.options),...i.actor.getSelfRollOptions("target"),l,...p,s?"self:flanking":null]),c),u=t.statistic instanceof game.pf2e.StatisticModifier,g=u?d.system.actions?.flatMap(v=>[v,v.altUsages??[]].flat())??[]:[],m=t.viewOnly?t.statistic:u?g.find(v=>t.item?.id!==v.item.id||t?.item.name!==v.item.name?!1:t.item.isOfType("melee")&&v.item.isOfType("melee")?!0:t.item.isOfType("weapon")&&v.item.isOfType("weapon")&&t.item.isMelee===v.item.isMelee)??t.statistic:t.statistic,y=(()=>{if(d===this)return t.item??null;if(m&&"item"in m&&m.item instanceof Item&&m.item.isOfType("action","melee","spell","weapon"))return m.item;let v=d.items.get(t.item?.id??"");return v?.isOfType("melee","weapon")?v:t.item??null})(),k=y?.getRollOptions("item")??[],R=(()=>{let v=se.compact([t.traits].flat());if(y?.isOfType("weapon","melee")){let C=[d.synthetics.strikeAdjustments,Ii(y.system.runes.property)].flat();for(let K of C)K.adjustTraits?.(y,v)}return se.uniq(v).sort()})(),E=e&&i?e.distanceTo(i):null,[S,F]=typeof E=="number"?[`origin:distance:${E}`,`target:distance:${E}`]:[null,null],T=(()=>{let v=e?i?.actor?.synthetics.tokenMarks.get(e.document.uuid):null;return v?`origin:mark:${v}`:null})(),A=e&&i?se.compact(se.uniq([...d.getSelfRollOptions("origin"),...R.map(v=>`origin:action:trait${v}`),...S?[S]:[],T])):[],b=a(v=>{let C=v?.getSelfRollOptions("target")??[];return i&&(C.push("target"),l&&C.push(l)),C.sort()},"getTargetRollOptions"),N=b(i?.actor),G=await Pt({affects:"target",origin:d,target:i?.actor??null,item:y,domains:t.domains,options:[...t.options,...k,...N]});if(e?.actor&&i?.actor&&!t.viewOnly){let v=re(e,i,{extraOptions:k,distance:E}),C=oe(e,i,{perception:v,affects:"origin"});C&&B(v,"target","visibility","noff",C)&&(C=void 0),P[C]>P.concealed&&G.push(Vt(C));let K=dt(e,i,{perception:v,affects:"target",options:k}),ve;if(K){let le=B(v,"target","cover","ac",K)?.first();le!=null&&(le=Math.clamped(rt(le),0,4)),le===0?K=void 0:le&&(ve=le)}x[K]>x.none&&G.push(Se(K,ve))}if(s&&qt(i.actor,d,A)){let v=game.i18n.localize("PF2E.Item.Condition.Flanked"),C=game.pf2e.ConditionManager.getCondition("off-guard",{name:v});G.push(C.toObject())}let ce=t.viewOnly?null:(t.target?.actor??i?.actor)?.getContextualClone(se.compact([...t.options,...k,...A]),G)??null,Ce=new Set(se.compact([...t.options,...d.getRollOptions(t.domains),...ce?b(ce):N,...R.map(v=>`self:action:trait:${v}`),...k,n?"attack":null]).sort());F&&Ce.add(F);let W=y?Kt(y,E):null;W&&Ce.add(`target:range-increment:${W}`);let _={actor:d,token:e?.document??null,statistic:m,item:y,modifiers:[]},D=ce&&i&&E!==null?{actor:ce,token:i.document,distance:E,rangeIncrement:W}:null;return{options:Ce,self:_,target:D,traits:R}}a(Ai,"getRollContext");var rn=["cover","concealed","hidden","undetected","unnoticed"],je=class extends FormApplication{static get defaultOptions(){return foundry.utils.mergeObject(super.defaultOptions,{template:X("icon-path-menu"),title:h("settings.icon-path.name"),width:500})}getData(){let e=O("icon-path");return{icons:rn.map(n=>({name:n,placeholder:Ge[n],value:e[n]??"",label:n==="cover"?h("icon-path.cover"):game.i18n.localize(CONFIG.PF2E.conditionTypes[n])})),i18n:h}}activateListeners(e){super.activateListeners(e),e.find("button[name=cancel]").on("click",i=>{i.prefentDefault(),this.close()})}async _updateObject(e,i){Ue("icon-path",i)}};a(je,"IconPathMenu");function Wi(){L("icon-path",Object,{},{config:!1}),game.settings.registerMenu(f,"icon-path-menu",{name:I("icon-path","name"),label:I("icon-path","label"),icon:"fa-solid fa-list",restricted:!0,type:je}),L("permission",String,CONST.USER_ROLES.GAMEMASTER,{choices:{1:I("permission","choices.1"),2:I("permission","choices.2"),3:I("permission","choices.3"),4:I("permission","choices.4")}}),L("npc-vision",Boolean,!1),L("target",Boolean,!0,{onChange:()=>ui.combat?.render()}),L("lesser",String,"ten",{choices:{none:I("lesser","choices.none"),cross:I("lesser","choices.cross"),zero:I("lesser","choices.zero"),ten:I("lesser","choices.ten"),twenty:I("lesser","choices.twenty")}}),L("standard",Boolean,!0),L("dead-cover",Boolean,!0),L("prone-cover",Boolean,!0),L("standard-type",String,"center",{choices:{center:I("standard-type","choices.center"),points:I("standard-type","choices.points")}}),L("skip-cover",Boolean,!0),L("validation",String,"all",{choices:{all:I("validation","choices.all"),selected:I("validation","choices.selected"),changed:I("validation","choices.changed")}}),L("flat-check",String,"roll",{choices:{none:I("flat-check","choices.none"),roll:I("flat-check","choices.roll"),cancel:I("flat-check","choices.cancel")}}),L("encounter",Boolean,!1),L("icon-size",Number,26,{scope:"client",range:{min:26,max:52}}),L("seek-template",Boolean,!0,{scope:"client"})}a(Wi,"registerSettings");function I(t,e){return`${f}.settings.${t}.${e}`}a(I,"path");function L(t,e,i,n={}){game.settings.register(f,t,{name:I(t,"name"),hint:I(t,"hint"),scope:"world",config:!0,type:e,default:i,...n})}a(L,"register");var on="game.pf2e.Check.roll",an="CONFIG.Token.documentClass.prototype.rulesBasedVision",sn="CONFIG.MeasuredTemplate.objectClass.prototype.highlightGrid",cn="CONFIG.Actor.documentClass.prototype.getRollContext",ln="DetectionMode.prototype.testVisibility",un="CONFIG.Canvas.detectionModes.basicSight._canDetect",dn="CONFIG.Canvas.detectionModes.hearing._canDetect",pn="CONFIG.Canvas.detectionModes.feelTremor._canDetect";Hooks.once("init",()=>{Wi(),ki(),ii(),libWrapper.register(f,on,bi),libWrapper.register(f,sn,ei,"OVERRIDE"),libWrapper.register(f,an,pi,"OVERRIDE"),libWrapper.register(f,cn,Ai,"OVERRIDE"),libWrapper.register(f,ln,xi,"OVERRIDE"),libWrapper.register(f,un,Fi,"OVERRIDE"),libWrapper.register(f,dn,Ni,"OVERRIDE"),libWrapper.register(f,pn,Ci,"OVERRIDE"),game.data.users.find(e=>e._id===game.data.userId).role>=CONST.USER_ROLES.GAMEMASTER?(Hooks.on("renderSceneConfig",Ht),Hooks.on("renderCombatTrackerConfig",Ri)):Hooks.on("renderCombatTracker",Ti),game.modules.get(f).custom={getWallCover:void 0,getCreatureCover:void 0}});Hooks.once("ready",()=>{game.modules.get(f).api=Si,Hooks.on("renderChatMessage",xt);for(let t of document.querySelectorAll("#chat-log .chat-message")){let e=game.messages.get(t.dataset.messageId);e&&xt(e,$(t))}game.user.isGM&&game.modules.get("pf2e-rules-based-npc-vision")?.active&&ui.notifications.error(`${f}.warning.npc-vision`,{permanent:!0,localize:!0})});Hooks.on("hoverToken",ci);Hooks.on("pasteToken",oi);Hooks.on("updateToken",si);Hooks.on("deleteToken",li);Hooks.on("controlToken",di);Hooks.on("renderTokenHUD",ri);Hooks.on("preCreateToken",gi);Hooks.on("canvasPan",()=>ye());Hooks.on("renderCheckModifiersDialog",Ei);Hooks.on("preCreateMeasuredTemplate",ti);Hooks.on("createMeasuredTemplate",it);Hooks.on("updateMeasuredTemplate",it);Hooks.on("deleteMeasuredTemplate",it);})();
//# sourceMappingURL=main.js.map
