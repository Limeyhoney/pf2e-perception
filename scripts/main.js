(()=>{var xt=Object.defineProperty;var En=(t,e,n)=>e in t?xt(t,e,{enumerable:!0,configurable:!0,writable:!0,value:n}):t[e]=n;var r=(t,e)=>xt(t,"name",{value:e,configurable:!0});var Se=(t,e,n)=>(En(t,typeof e!="symbol"?e+"":e,n),n),On=(t,e,n)=>{if(!e.has(t))throw TypeError("Cannot "+n)};var Ce=(t,e,n)=>{if(e.has(t))throw TypeError("Cannot add the same private member more than once");e instanceof WeakSet?e.add(t):e.set(t,n)};var W=(t,e,n)=>(On(t,e,"access private method"),n);var fe="Compendium.pf2e.other-effects.Item.I9lfZUiCwMiGogVi",b={[void 0]:0,observed:0,concealed:1,hidden:2,undetected:3,unnoticed:4},se=["observed","concealed","hidden","undetected","unnoticed"],B=["none","lesser","standard","greater","greater-prone"],P={[void 0]:0,none:0,lesser:1,standard:2,greater:3,"greater-prone":4},N={cover:"none",visibility:"observed"},pe=["attack-roll","spell-attack-roll"],It=[...pe,"skill-check","perception-check"],_e={cover:"modules/pf2e-perception/images/cover.webp",concealed:"systems/pf2e/icons/conditions/concealed.webp",hidden:"systems/pf2e/icons/conditions/hidden.webp",undetected:"systems/pf2e/icons/conditions/undetected.webp",unnoticed:"systems/pf2e/icons/conditions/unnoticed.webp"},xe={BLINDED:0,NORMAL:1,LOWLIGHT:2,DARKVISION:3},ct="#000000",at="#656665",Et="#809e71",Ot=["darkness","dance-of-darkness","ravenous-darkness"],Dt=["obscuring-mist","stinking-cloud","noxious-vapors"];var m="pf2e-perception";function K(t){return`modules/${m}/templates/${t}.hbs`}r(K,"templatePath");function v(...t){let e=t.at(-1),n=typeof e=="object",o=n?t.slice(0,-1):t;return o.unshift(m),game.i18n[n?"format":"localize"](o.join("."),e)}r(v,"localize");function L(t,e){return t.getFlag(m,e)}r(L,"getFlag");function lt(t,e,n){return t.setFlag(m,e,n)}r(lt,"setFlag");function Rt(t,e){return t.unsetFlag(m,e,!0)}r(Rt,"unsetFlag");function At(t){return getProperty(t,`flags.${m}`)??{}}r(At,"getFlags");function F(t){return game.settings.get(m,t)}r(F,"getSetting");function Ve(t,e){return game.settings.set(m,t,e)}r(Ve,"setSetting");function Pt(){return game.user.role>=F("permission")}r(Pt,"hasPermission");function $t(t){let n=game.pf2e.ConditionManager.getCondition("off-guard").toObject();return n.name+=` (${game.i18n.localize(`PF2E.condition.${t}.name`)})`,n}r($t,"createFlatFootedSource");function ge(t,e){return e??=P[t]===3?4:P[t],{_id:"I9lfZUiCwMiGogVi",img:"systems/pf2e/icons/conditions-2/status_acup.webp",name:v("cover",t),system:{description:{gm:"",value:"<p>When you're behind an obstacle that could block weapons, guard you against explosions, and make you harder to detect, you're behind cover. Standard cover gives you a +2 circumstance bonus to AC, to Reflex saves against area effects, and to Stealth checks to Hide, Sneak, or otherwise avoid detection. You can increase this to greater cover using the Take Cover basic action, increasing the circumstance bonus to +4. If cover is especially light, typically when it's provided by a creature, you have lesser cover, which grants a +1 circumstance bonus to AC. A creature with standard cover or greater cover can attempt to use Stealth to Hide, but lesser cover isn't sufficient.</p>"},rules:[{domain:"all",key:"RollOption",option:`self:cover-bonus:${e}`},{domain:"all",key:"RollOption",option:`self:cover-level:${t}`},{key:"FlatModifier",predicate:[{or:[{and:["self:condition:prone","item:ranged"]},{not:"self:cover-level:greater-prone"}]}],selector:"ac",type:"circumstance",value:e},{key:"FlatModifier",predicate:["area-effect",{not:"self:cover-level:greater-prone"}],selector:"reflex",type:"circumstance",value:e},{key:"FlatModifier",predicate:[{or:["action:hide","action:sneak","avoid-detection"]},{not:"self:cover-level:greater-prone"}],selector:"stealth",type:"circumstance",value:e},{key:"FlatModifier",predicate:["action:avoid-notice",{not:"self:cover-level:greater-prone"}],selector:"initiative",type:"circumstance",value:e}],slug:"effect-cover"},type:"effect",flags:{core:{sourceId:fe},[m]:{level:t,bonus:e}}}}r(ge,"createCoverSource");function Ne(t,e=void 0){if(t)return t.system.rules.find(n=>n.key==="ChoiceSet"&&(!e||n.flag===e))}r(Ne,"findChoiceSetRule");async function dt({affects:t,origin:e,target:n,item:o,domains:s,options:i}){if(!(e&&n))return[];let[c,l]=t==="target"?[e,n]:[n,e],a=[...i,...l.getSelfRollOptions(t)],u=o?o.isOfType("spell")?{spell:o}:{weapon:o}:{};return(await Promise.all(s.flatMap(f=>c.synthetics.ephemeralEffects[f]?.[t]??[]).map(f=>f({test:a,resolvables:u})))).flatMap(f=>f??[])}r(dt,"extractEphemeralEffects");function Ft(t,e){let n={name:t,label:game.i18n.localize(e[t]??t)};return Dn(CONFIG.PF2E.traitsDescriptions,t)&&(n.description=CONFIG.PF2E.traitsDescriptions[t]),n}r(Ft,"traitSlugToObject");function Dn(t,e){return(typeof e=="string"||typeof e=="number")&&e in t}r(Dn,"objectHasKey");function wt(t,e){if(!t.isOfType("action","melee","weapon"))return null;let{increment:n}=t.range??{};return n&&typeof e=="number"?Math.max(Math.ceil(e/n),1):null}r(wt,"getRangeIncrement");function Lt(t,e){if(!t?.isOfType("creature"))return!1;let{flanking:n}=t.attributes;return n.flankable?typeof n.offGuardable=="number"?e.level>n.offGuardable:n.offGuardable:!1}r(Lt,"isOffGuardFromFlanking");var me={cover:{cancel:{targets:["lesser","standard","greater","greater-prone"]},set:{targets:["none","lesser","standard","greater","greater-prone"],value:["none","lesser","standard","greater","greater-prone"]},reduce:{targets:["lesser","standard","greater","greater-prone"]},ignore:{targets:"string"},ignored:{targets:["allies","enemies"]},ac:{targets:["lesser","standard","greater","greater-prone"],value:["number"]}},visibility:{cancel:{targets:["concealed","hidden","undetected","unnoticed"]},set:{targets:["observed","concealed","hidden","undetected","unnoticed"],value:["observed","concealed","hidden","undetected","unnoticed"]},reduce:{targets:["concealed","hidden","undetected","unnoticed"]},noff:{targets:["hidden","undetected","unnoticed"]},noinvis:{},dc:{targets:["concealed","hidden"],value:["number","string"]}}},Rn={cover:Object.keys(me.cover),visibility:Object.keys(me.visibility),all:[...Object.keys(me.cover),...Object.keys(me.visibility)]};function Mt(){let t=game.pf2e.RuleElements.builtin.RollOption.defineSchema(),e=t.predicate.constructor,n=t.value.constructor;class o extends game.pf2e.RuleElement{constructor(i,c){typeof i.targets=="string"&&(i.targets=[i.targets]),super({priority:CONST.ACTIVE_EFFECT_MODES.CUSTOM,...i},c);let l=Rn[i.type];if(!l)return;if(!l?.includes(i.selector)){this.failValidation(`The type "${i.type}" only accepts the following selectors: ${l.join(", ")}.`);return}let a=me[i.type]?.[i.selector];if(!a)return;let u=r(p=>{let{name:S,uuid:I}=this.item;console.warn(`PF2e System | PF2ePerception rules element on item ${S} (${I}) simple warning: ${p}`)},"selectorWarn"),f=Array.isArray(a.targets)?[...a.targets,"all"]:a.targets,d=Array.isArray(f)?f.join(", "):null;if(!f&&i.targets?.length){u(`The selector "${i.selector}" doesn't accept any targets property.`);return}if(i.selector==="ignore"&&!i.targets?.length){let p=`The selector "${i.selector}" requires a targets property with the ids of the tokens on the scene that should not give cover.`;this.failValidation(p);return}if(d&&i.targets?.some(p=>!f.includes(p))){let p=`The targets property of selector "${i.selector}" only accepts the following: ${d}.`;this.failValidation(p);return}else if(!d&&f&&i.targets?.some(p=>typeof p!==f)){let p=`The targets property of selector "${i.selector}" needs to be of type "${f}".`;this.failValidation(p);return}let g=a.value;if(!g&&a.value){u(`The selector "${i.selector}" doesn't accept any value property.`);return}let h=typeof i.value;if(g&&!g.includes(h)){let p=`The selector "${i.selector}" does not accept a value property of type ${h}.`;this.failValidation(p)}}static defineSchema(){let{fields:i}=foundry.data;return{...super.defineSchema(),type:new i.StringField({required:!0,nullable:!1,blank:!1,choices:["visibility","cover"]}),affects:new i.StringField({required:!0,nullable:!1,blank:!1,initial:"self",choices:["self","other"]}),selector:new i.StringField({required:!0,nullable:!1,blank:!1}),targets:new i.ArrayField(new i.StringField({required:!0,nullable:!1,blank:!1,initial:void 0}),{required:!0,nullable:!1,initial:["all"]}),predicate:new e({required:!1,nullable:!1}),value:new n({required:!1,initial:void 0})}}test(i,c){return c?super.test(i):!1}addToPerception(i,c,l){if(!this.test(l,!0))return;let u=`${this.affects==="self"?i:i==="origin"?"target":"origin"}.${this.type}.${this.selector}`,f=me[this.type][this.selector];if(!f.targets){setProperty(c,u,!0);return}let d=this.targets.includes("all")?f.targets:this.targets;if(!f.value){for(let g of d){let h=`${u}.${g}`;setProperty(c,h,!0)}return}for(let g of d){let h=`${u}.${g}`,p=getProperty(c,h);p?p.add(this.value):p=new Set([this.value]),setProperty(c,h,p)}}}r(o,"PF2ePerceptionRuleElement"),game.pf2e.RuleElements.custom.PF2ePerception=o}r(Mt,"setupRuleElement");function X(t,e,{distance:n,extraOptions:o=[]}={}){let s=t.actor,i=e.actor;if(!s||!i)return{};let c={origin:s.rules.filter(d=>!d.ignored&&d.key==="PF2ePerception")??[],target:i.rules.filter(d=>!d.ignored&&d.key==="PF2ePerception")??[]};if(!c.origin.length&&!c.target.length)return{};let l={origin:s.getRollOptions(),target:i.getRollOptions()},a={origin:i.getSelfRollOptions("target"),target:s.getSelfRollOptions("origin")};t=t instanceof Token?t:t.object,e=e instanceof Token?e:e.object,n??=t.distanceTo(e);let u=[`origin:distance:${n}`,`target:distance:${n}`],f={};for(let d of["origin","target"]){let g=[...o,...l[d],...a[d],...u];for(let h of c[d])h.addToPerception(d,f,g)}return f}r(X,"perceptionRules");function _t(t){let e=t.actor;return e?(e.rules.filter(o=>!o.ignored&&o.key==="PF2ePerception"&&o.type==="cover"&&o.selector==="ignored")??[]).flatMap(o=>o.targets):[]}r(_t,"getIgnoredPerception");function z(t,e,n,o,s){let i=t[e]?.[n]?.[o];return s?i?.[s]:i}r(z,"getPerception");function he(t,e,n,o){let s=n==="cover"?B:se;if(o&&z(t,e,n,"cancel",o))return;let i=z(t,e,n,"set",o)?.first();if(i&&s.includes(i))o=i;else if(o&&z(t,e,n,"reduce",o)){let c=s.indexOf(o);o=s[Math.max(0,c-1)]}return o===s[0]?void 0:o}r(he,"updateFromPerceptionRules");function Vt(t,e){let n="",o=["standard","npc-vision"];for(let i of o){let c=ve(t.object,i);n+=`<div class="form-group pf2e-perception-injected">
    <label>${v(`settings.${i}.name`)}</label>
    <input type="checkbox" name="flags.pf2e-perception.${i}" ${c?"checked":""}>
    <p class="notes">${v(`settings.${i}.short`)}</p>
</div>`}n+="<hr>",e.find('.tab[data-tab="basic"] hr').first().after(n);let s=e.find(".pf2e-perception-injected").toArray().reduce((i,c)=>(i+=c.clientHeight,i),0);t.setPosition({top:t.position.top-s/2})}r(Vt,"renderSceneConfig");function G(t){if(t=t instanceof Token?t.document:t,!(t instanceof TokenDocument))return[];let e=t.scene.tokens.filter(n=>n!==t&&n.actor?.isOfType("creature"));if(F("encounter")){let n=game.combats.active;return n?e.filter(o=>{let s=o.actor,i=s.traits;return s.type==="familiar"||i.has("minion")||i.has("eidolon")||n.getCombatantByToken(o.id)}):e}return e}r(G,"getValidTokens");function ee(t,e){let n=G(t).map(o=>o.id);return e.filter(o=>{let s=o instanceof Token||o instanceof TokenDocument?o.id:o;return n.includes(s)})}r(ee,"validateTokens");function ve(t,e){return L(t,e)??F(e)}r(ve,"getSceneSetting");function ye(t,e=1){let n=Object.getPrototypeOf(t);return e>1?ye(n,e-1):n}r(ye,"getPrototype");function Ge(t,e){return t.name.localeCompare(e.name)}r(Ge,"sortByName");function Ue(t){return t=Number(t),isNaN(t)?void 0:t}r(Ue,"asNumberOnly");var ut={compact:t=>t.filter(Boolean)};var Y=class extends Application{#e;#s;#t;#n;#o;constructor({token:e,resolve:n,selected:o=[]},s={}){super(s),this.#e=e,this.#s=n,this.#t=o,this.#o=(i,c)=>{let l=i.id,a=this.element.find("[data-token-id]");a.removeClass("hover"),c&&a.filter(`[data-token-id=${l}]`).addClass("hover")},Hooks.on("hoverToken",this.#o)}async close(e={}){Hooks.off("hoverToken",this.#o),this.#s?.(e.resolve??!1),super.close(e)}static get defaultOptions(){return mergeObject(super.defaultOptions,{minimizable:!1})}static async openMenu(e,n={}){if(e.token instanceof TokenDocument&&(e.token=e.token.object),!e.token){ui.notifications.error(v("menu.no-token"));return}n.id=`${m}-${e.token.document.uuid}`;let o=Object.values(ui.windows).find(s=>s.id===n.id);return o&&o.close(),new Promise(s=>{e.resolve=s,new this(e,n).render(!0)})}static createPropertyData(e,n,o){let s=N[o],i=e[o]??s,c=n[o]??s;return{original:i,current:c,changed:i!==c,custom:c!==s,originalCustom:i!==s}}get token(){return this.#e}get document(){return this.#e.document}get actor(){return this.#e.actor}get scene(){return this.#e.scene}get selected(){return this.#t.length?ee(this.token,this.#t):[]}get currentData(){return deepClone(this.#i)}get#i(){return this.#n||(this.#n=this.getSavedData()),this.#n}getSavedData(){let e=_(this.document)??{};return deepClone(e)}reset(){this.#n=this.getSavedData(),this.#t=[],this.render()}isSelected(e){let n=typeof e=="object"?e.id:e;return this.#t.includes(n)}getData(e){return{i18n:v,covers:B.map(n=>({value:n,label:v(`cover.${n}`)})),visibilities:se.map(n=>({value:n,label:v(`visibility.${n}`)}))}}activateListeners(e){e.find("[data-token-id]").on("mouseenter",n=>{let{tokenId:o}=n.currentTarget.dataset,s=this.scene.tokens.get(o)?.object;!s||s.controlled||s._onHoverIn(n,{hoverOutOthers:!0})}),e.find("[data-action=close]").on("click",()=>{this.close({resolve:!0})}),e.find("select[name=visibility], select[name=cover]").on("change",n=>{let o=n.currentTarget,s=o.name,i=N[s],c=o.value||i,l=o.closest(".token")?.dataset.tokenId,a=l?[l]:this.#t;for(let u of a)setProperty(this.#i,`${u}.${s}`,c);l?(o.classList.toggle("changed",c!==o.dataset.original),o.classList.toggle("custom",c!==i)):this.render()}),e.find("[data-action=accept]").on("click",n=>{this._saveData(this.#i),this.close({resolve:!0})})}_saveData(e){ze(this.document,e)}_setSelected(e){this.#t=e??this.element.find("[data-token-id].ui-selected").toArray().map(n=>n.dataset.tokenId)}_spliIntoAlliances(e){let n=[],o=[],s=[],i=this.actor.alliance,c=i==="party"?"opposition":i==="opposition"?"party":null;for(let l of e)if(c){let a=l.actor?l.actor.alliance:l.alliance;a===i?n.push(l):a===c?o.push(l):a===null&&s.push(l)}else s.push(l);return{allies:n.sort(Ge),neutral:s.sort(Ge),enemies:o.sort(Ge),hasTokens:n.length||o.length||s.length}}};r(Y,"BaseMenu");var Ie=class extends Y{get title(){return v("menu.perception.title",{name:this.token.name})}get template(){return K("perception")}getData(e){let n=this.selected,o=this.currentData,s=this.getSavedData(),i=G(this.token).map(({id:c,name:l,actor:a})=>{let u=o[c]??{},f=s[c]??{};return{id:c,name:l,alliance:a.alliance,cover:Y.createPropertyData(f,u,"cover"),visibility:Y.createPropertyData(f,u,"visibility"),selected:n.includes(c)}});return{...super.getData(e),...this._spliIntoAlliances(i)}}activateListeners(e){super.activateListeners(e),e.filter(".tokens").selectable({autoRefresh:!1,filter:".token",cancel:"header,select",stop:()=>this._setSelected()}),e.find("[data-action=select-all]").on("click",n=>{let o=$(n.currentTarget).closest("section"),s=(o.length?o:e).find("[data-token-id]"),i=s.filter(":not(.ui-selected)").length===0;s.toggleClass("ui-selected",!i),this._setSelected()}),e.find("[data-action=use-selection]").on("click",n=>{this._setSelected(canvas.tokens.controlled.map(o=>o.id)),this.render()}),e.find("[data-action=reset]").on("click",n=>this.reset())}};r(Ie,"PerceptionMenu");var An=[{x:.25,y:.25},{x:.5,y:.25},{x:.75,y:.25},{x:.25,y:.5},{x:.5,y:.5},{x:.75,y:.5},{x:.25,y:.75},{x:.5,y:.75},{x:.75,y:.75}];function je(t,e){let n=1-e;return{top:{A:Q({x:e,y:e},t),B:Q({x:n,y:e},t)},right:{A:Q({x:n,y:e},t),B:Q({x:n,y:n},t)},bottom:{A:Q({x:n,y:n},t),B:Q({x:e,y:n},t)},left:{A:Q({x:e,y:n},t),B:Q({x:e,y:e},t)}}}r(je,"getRectEdges");function Ee(t,e,n=!1){return n&&q(t,e),CONFIG.Canvas.polygonBackends.move.testCollision(t,e,{type:"move",mode:"any"})}r(Ee,"lineIntersectWall");function Be(t,e,n=!1){for(let o of Pn(e.bounds))if(Ee(t,o,n))return!0;return!1}r(Be,"pointToTokenIntersectWall");function Q(t,e){return{x:e.x+e.width*t.x,y:e.y+e.height*t.y}}r(Q,"getRectPoint");function re(){canvas.controls.debug.clear()}r(re,"clearDebug");function q(t,e,n="blue"){let o=n==="blue"?26316:n==="red"?16711680:1483011;canvas.controls.debug.lineStyle(4,o).moveTo(t.x,t.y).lineTo(e.x,e.y)}r(q,"drawDebugLine");function*Pn(t){for(let e of An)yield Q(e,t)}r(Pn,"rectSpread");function He(t,e=!1){if(t=t instanceof Token?t:t.object,t.document.hasStatusEffect(CONFIG.specialStatusEffects.INVISIBLE))return;let n=t.scene;if(n!==canvas.scene||!n.tokenVision||n.darkness<n.globalLightThreshold)return;e&&re();let o=t.document.center,s=null;for(let i of canvas.effects.lightSources){if(!i.active)continue;let c=i.data.bright,l=i.data.dim;if(i.object===t){if(c)return"bright";l&&(s="dim");continue}if(!i.shape.contains(o.x,o.y)){e&&q(i,o,"red");continue}if(i.ratio===1)return e&&q(i,o,"green"),"bright";if(i.ratio===0){e&&q(i,o,"blue"),s="dim";continue}if(new Ray(i,o).distance<=c)if(e)q(i,o,"green"),s="bright";else return"bright";else e?(q(i,o,"blue"),s!=="bright"&&(s="dim")):s="dim"}return s}r(He,"getLightExposure");function $n(t,e){return canvas.dimensions?canvas.grid.type!==CONST.GRID_TYPES.SQUARE?canvas.grid.measureDistance(t,e):Fn(new Ray(t,e)):NaN}r($n,"measureDistance");function Fn(t,{reach:e=null}={}){if(!canvas.dimensions)return NaN;let n=canvas.dimensions.size,o=canvas.dimensions.distance,s=Math.ceil(Math.abs(t.dx/n)),i=Math.ceil(Math.abs(t.dy/n)),c=Math.ceil(Math.abs((t.dz||0)/n)),l=[s,i,c].sort((d,g)=>d-g),a={doubleDiagonal:l[0],diagonal:l[1]-l[0],straight:l[2]-l[1]},u=a.diagonal+a.doubleDiagonal>1&&e===10?1:0;return(Math.floor(a.doubleDiagonal*1.75+a.diagonal*1.5+a.straight)-u)*o}r(Fn,"measureDistanceOnGrid");function Nt({areaType:t,object:e,colors:n,document:o,collisionType:s="move",preview:i=!1,collisionOrigin:c}){if(!e.id&&!i)return;let{grid:l,dimensions:a}=canvas;if(!(l&&a))return;let u=o.angle??0,f=o.direction??45,d=l.getHighlightLayer(e.highlightId)?.clear();if(!d)return;let[g,h]=l.getCenter(o.x,o.y),[p,S]=l.grid.getGridPositionFromPixels(g,h),I=(360+(f-u*.5)%360)%360,C=(360+(f+u*.5)%360)%360,T=canvas.grid.getSnappedPosition(o.x,o.y,e.layer.gridPrecision),R=r((y,E,O)=>(y=(360+y%360)%360,E=(360+E%360)%360,O=(360+O%360)%360,y<E?O>=y&&O<=E:O>=y||O<=E),"withinAngle"),x=(()=>{if(t!=="cone")return{x:0,y:0};let y=(f>=0?360-f:-f)%360,E=T.x%a.size!==0?Math.sign(1*Math.round(Math.cos(Math.toRadians(y))*100)/100)/2:0,O=T.y%a.size!==0?-Math.sign(1*Math.round(Math.sin(Math.toRadians(y))*100)/100)/2:0;return{x:E*a.size,y:O*a.size}})(),A=Math.clamped(o.width??0,1.5,2),k=o.distance??0,D=k*A/a.distance,H=Math.ceil(D/(a.size/l.h)),ie=Math.ceil(D/(a.size/l.w)),Te=r(y=>{if(!(t==="emanation"&&e instanceof Token))return{x:0,y:0};if(e.w<=a.size)return{x:0,y:0};let E=(e.w-a.size)/2,O=r((j,M)=>M===j?0:M>j?E:-E,"getCoordinate");return{x:O(e.center.x,y.x),y:O(e.center.y,y.y)}},"offsetEmanationOrigin");for(let y=-ie;y<ie;y++)for(let E=-H;E<H;E++){let[O,j]=canvas.grid.grid.getPixelsFromGridPosition(p+y,S+E),M={x:O+a.size*.5,y:j+a.size*.5};if(M.x<0||M.y<0)continue;let St=Te(M),rt={x:T.x+x.x+St.x,y:T.y+x.y+St.y};if(t==="cone"){let Ct=new Ray(rt,M),In=(360+Ct.angle/(Math.PI/180)%360)%360;if(Ct.distance>0&&!R(I,C,In))continue}if($n(M,rt)>k)continue;canvas.ready&&CONFIG.Canvas.polygonBackends[s].testCollision(c??rt,M,{type:s,mode:"any"})?(l.grid.highlightGridPosition(d,{x:O,y:j,border:1,color:0}),d.beginFill(0,.5).moveTo(O,j).lineTo(O+a.size,j+a.size).endFill()):l.grid.highlightGridPosition(d,{x:O,y:j,border:n.border,color:n.fill})}}r(Nt,"highlightGrid");var wn={burst:"circle",emanation:"circle",line:"ray",cone:"cone",rect:"rect"};function We({type:t,token:e,distance:n}){ft(e)&&(n??=t==="cone"?30:15,Oe({type:t,distance:n,traits:["concentrate","secret"],flags:{type:"seek",tokenId:e.id,collisionType:"sight",collisionOrigin:e.center}}))}r(We,"createSeekTemplate");function Gt({type:t="burst",distance:e=20,conceal:n=!1}={}){Oe({type:t,distance:e,fillColor:ct,flags:{type:"darkness",conceal:n}})}r(Gt,"createDarknessTemplate");function Ut({type:t="burst",distance:e=20}={}){Oe({type:t,distance:e,fillColor:at,flags:{type:"mist"}})}r(Ut,"createMistTemplate");function zt(t,e){return e&&!ft(e)?null:canvas.scene.templates.filter(n=>L(n,"type")===t)??[]}r(zt,"getTemplates");function Ye(t){return zt("darkness",t)}r(Ye,"getDarknessTemplates");function qe(t){return zt("mist",t)}r(qe,"getMistTemplates");function Ke(t){if(!ft(t))return null;let e=canvas.scene.templates.find(n=>L(n,"type")==="seek");return e?(t=t instanceof Token?t.document:t,ke(e,{collisionType:"sight",collisionOrigin:t.center})):null}r(Ke,"getSeekTemplateTokens");async function Z(t){let e=t.scene.templates.filter(n=>L(n,"type")==="seek"&&L(n,"tokenId")===t.id);for(let n of e)await n.delete()}r(Z,"deleteSeekTemplate");function ft(t){return canvas.scene===t.scene?!0:(ui.notifications.error(v("template.scene")),!1)}r(ft,"checkScene");function Oe({type:t,distance:e,traits:n,fillColor:o,width:s,flags:i}){let c={distance:e,t:wn[t],fillColor:o||game.user.color,flags:{[m]:i}};c.t==="ray"?c.width=s||CONFIG.MeasuredTemplate.defaults.width*(canvas.dimensions?.distance??1):c.t==="cone"&&(c.angle=CONFIG.MeasuredTemplate.defaults.angle),n&&setProperty(c,"flags.pf2e.origin.traits",n);let l=new CONFIG.MeasuredTemplate.documentClass(c,{parent:canvas.scene});new CONFIG.MeasuredTemplate.objectClass(l).drawPreview()}r(Oe,"createTemplate");function ke(t,{collisionOrigin:e,collisionType:n="move"}={}){if(t=t instanceof MeasuredTemplateDocument?t.object:t,!canvas.scene)return[];let{grid:o,dimensions:s}=canvas;if(!(o&&s))return[];let i=o.getHighlightLayer(t.highlightId);if(!i||o.type!==CONST.GRID_TYPES.SQUARE)return[];let c=e??t.center,l=canvas.tokens.quadtree.getObjects(i.getLocalBounds(void 0,!0)),a=[];for(let u of l){let f=u.document,d=[];for(let g=0;g<f.height;g++){let h=u.y+g*o.size;if(d.push(`${u.x}.${h}`),f.width>1)for(let p=1;p<f.width;p++)d.push(`${u.x+p*o.size}.${h}`)}for(let g of d){if(!i.positions.has(g))continue;let[h,p]=g.split(".").map(C=>Number(C)),S={x:h+s.size*.5,y:p+s.size*.5};if(S.x<0||S.y<0)continue;if(!(canvas.ready&&n&&CONFIG.Canvas.polygonBackends[n].testCollision(c,S,{type:n,mode:"any"}))){a.push(u);break}}}return a}r(ke,"getTemplateTokens");function jt(){if(!["circle","cone"].includes(this.type)||canvas.grid.type!==CONST.GRID_TYPES.SQUARE)return MeasuredTemplate.prototype.highlightGrid.call(this);if(!this.isVisible){canvas.grid.getHighlightLayer(this.highlightId)?.clear();return}let t=L(this.document,"collisionType"),e=L(this.document,"collisionOrigin");Nt({areaType:this.type==="circle"?"burst":"cone",object:this,document:this.document,colors:{border:this.borderColor,fill:this.fillColor},preview:!0,collisionType:t,collisionOrigin:e})}r(jt,"highlightTemplateGrid");function Bt(t){let{type:e,slug:n,castLevel:o=0}=t.getFlag("pf2e","origin")??{};e==="spell"&&(Ot.includes(n)?t.updateSource({fillColor:ct,[`flags.${m}`]:{type:"darkness",conceal:o>=4}}):Dt.includes(n)?t.updateSource({fillColor:at,[`flags.${m}`]:{type:"mist"}}):n==="cloudkill"&&t.updateSource({fillColor:Et,[`flags.${m}`]:{type:"mist"}}))}r(Bt,"preCreateMeasuredTemplate");function Qe(t){L(t,"type")==="darkness"&&canvas.perception.update({initializeVision:!0})}r(Qe,"onMeasuredTemplate");function Ht(t,e){!Pt()||!t.object.actor?.isOfType("creature")||(e.find(".col.left").append('<div class="control-icon" data-action="pf2e-perception"><i class="fa-solid fa-eye"></i></div>'),e.find("[data-action=pf2e-perception]").on("click",n=>pt(t.object)))}r(Ht,"renderTokenHUD");function pt(t){return Ie.openMenu({token:t})}r(pt,"openHUD");function Wt(t,e){for(let n of e)delete n.flags?.[m]}r(Wt,"pasteToken");function _(t,...e){return e.unshift("data"),t=t instanceof Token?t.document:t,L(t,e.join("."))}r(_,"getTokenData");async function Yt(t){return t=t instanceof Token?t.document:t,Rt(t,"data")}r(Yt,"clearTokenData");async function ze(t,e){let n=G(t).map(s=>s.id),o={};for(let s in e){if(!n.includes(s)){o[`flags.${m}.data.-=${s}`]=!0;continue}let i=e[s],c=_(t,s)??{};if(i.visibility===N.visibility&&delete i.visibility,i.cover===N.cover&&delete i.cover,!(c.cover===i.cover&&c.visibility===i.visibility))if(!i.visibility&&!i.cover)o[`flags.${m}.data.-=${s}`]=!0;else for(let l of["cover","visibility"])c[l]!==i[l]&&(i[l]?o[`flags.${m}.data.${s}.${l}`]=i[l]:o[`flags.${m}.data.${s}.-=${l}`]=!0)}return t=t instanceof Token?t.document:t,t.update(o)}r(ze,"setTokenData");function Ze(t,e,n=!1){let o=t.scene;return ve(o,"standard")?(n&&re(),(F("standard-type")==="points"?Be(t.center,e,n):Ee(t.center,e.center,n))?"standard":void 0):!1}r(Ze,"getWallCover");var ce={tiny:0,sm:1,med:2,lg:3,huge:4,grg:5};function Je(t,e,{perception:n={},options:o=[],affects:s="origin",debug:i=!1}={}){let c=o.includes("item:ranged")?J(e.actor):!1,l=r(f=>he(n,s,"cover",f),"returnValue"),a=ne(e.actor,!0);if(c&&P[a]>P.lesser)return l("greater-prone");!c&&a==="greater-prone"&&(a=void 0);let u=_(e,t.id,"cover");if(c&&P[u]>P.lesser)return l("greater-prone");if(!c&&u==="greater-prone"&&(u=void 0),P[a]<P.standard){if(P[u]<P.standard){let f=game.modules.get(m).custom?.getWallCover;if(typeof f=="function"){let d=f(t,e,i);B.includes(d)?u=d:u=Ze(t,e,i)}else u=Ze(t,e,i)}P[u]<P.standard&&t.distanceTo(e)>5&&(u=gt(t,e,{perception:n,debug:i}))}return c&&P[u]>P.lesser?l("greater-prone"):l(P[u]>P[a]?u:void 0)}r(Je,"getCover");function gt(t,e,{perception:n={},debug:o=!1}={}){let s=F("lesser");if(s==="none")return;t=t instanceof Token?t.document:t,e=e instanceof Token?e.document:e;let i=(()=>{let k=Object.keys(n.origin?.cover?.ignore??{}),D=Object.keys(n.target?.cover?.ignore??{});return new Set([...k,...D])})(),c,l=t.center,a=e.center,u=t.actor,f=e.actor;o&&(re(),q(l,a));let d=r(k=>{let D=ce[k.actor.size];return D-g>=2&&D-h>=2},"isExtraLarge"),g=ce[u.size],h=ce[f.size],p=u.alliance,S=F("dead-cover"),I=F("prone-cover"),C=t.scene.tokens.contents.filter(k=>{let D=k.actor,H=D.alliance,ie=_t(k),Te=D.hitPoints?.value;return D&&!k.hidden&&k!==t&&k!==e&&(I||!J(D))&&(S||Te!==0)&&!i.has(k.id)&&!(ie.includes("all")||ie.includes(H===p?"allies":"enemies"))}).sort((k,D)=>ce[D.actor.size]-ce[k.actor.size]),T=g<ce.huge&&h<ce.huge&&C.filter(d).length,R=s==="ten"?.1:s==="twenty"?.2:0,x=r(k=>(o&&q(k.A,k.B,"red"),lineSegmentIntersects(l,a,k.A,k.B)),"intersectsEdge"),A=s==="cross"?k=>x(k.top)&&x(k.bottom)||x(k.left)&&x(k.right):k=>Object.values(k).some(D=>x(D));for(let k of C){let D=k.object,H=je(D.bounds,R);if(A(H))return T?"standard":"lesser";d(k)&&T--}return c}r(gt,"getCreatureCover");function te(t,e,{perception:n={},affects:o="origin",debug:s=!1}={}){t=t instanceof Token?t:t.object,e=e instanceof Token?e:e.object;let i=t.actor,c=e.actor,l=(()=>{if(!i)return;let T;c.hasCondition("blinded")?T="hidden":c.hasCondition("dazzled")&&(T="concealed");for(let R of["unnoticed","undetected","hidden","concealed"])b[R]>b[T]&&i.hasCondition(R)&&(T=R);return T})(),a=r(T=>u?(b[T]<b.hidden&&(T="hidden"),(en(c)||z(n,o,"visibility","noinvis"))&&(T="concealed"),he(n,o,"visibility",T)):he(n,o,"visibility",T),"returnValue"),u=i?.hasCondition("invisible"),f=_(t,e.id,"visibility"),d=b[l]>b[f]?l:f;if(b[d]>=b.hidden||u)return a(d);let g=c?.hasLowLightVision,h=c?.hasDarkvision,p=c&&et(c);if(p&&d==="concealed")return a(d);let S;if(!p){let T=Ye(t);if(T?.length){let R;for(let x of T){let A=ke(x);if(!A.length)continue;if(A.includes(t)||A.includes(e))S=!0;else continue;if(!h)return a("hidden");L(x,"conceal")&&(R="concealed")}if(R==="concealed"&&(d="concealed"),S&&d==="concealed")return a(d)}}if(d!=="concealed"){let T=qe(t);if(T?.length)for(let R of T){let x=ke(R);if(!x.length)continue;if(x.includes(t)||x.includes(e))return a("concealed")}}if(S||p)return a(d);let I=He(t,s),C=I==="dim"?"concealed":I===null?"hidden":void 0;return(C==="concealed"&&g||C==="hidden"&&h)&&(C=void 0),b[C]>b[d]&&(d=C),a(d)}r(te,"getVisibility");function qt(t,e,n,o){let s=e.flags?.["pf2e-perception"];if(s&&(s.data||s["-=data"]!==void 0)){if(t.object.renderFlags.set({refreshVisibility:!0}),game.user.isGM)return;let i=Hooks.on("refreshToken",c=>{!t.object!==c&&(Hooks.off("refreshToken",i),game.combat?.getCombatantByToken(t.id)&&ui.combat.render())})}}r(qt,"updateToken");function Kt(t,e){e?Xe(t):ae(t)}r(Kt,"hoverToken");function Qt(t){ae(t),game.user.isGM||ui.combat.render()}r(Qt,"deleteToken");function Zt(t,e){e&&(ae(),Hooks.once("sightRefresh",()=>t.hover&&Xe(t)))}r(Zt,"controlToken");function ae(t){if(!t?.id)return $(".pf2e-conditionals").remove();$(`.pf2e-conditionals[data-hover-id=${t.id}]`).remove(),$(`.pf2e-conditionals[data-token-id=${t.id}]`).remove()}r(ae,"clearConditionals");function Xe(t){let e=G(t);for(let n of e)mt(n,t)}r(Xe,"showAllConditionals");async function mt(t,e){if(t=t instanceof Token?t:t.object,!t.visible||!t.actor?.isOfType("creature"))return;let n=_(t,e.id);if(isEmpty(n))return;if(!game.user.isGM&&!e.document.hasPlayerOwner&&b[n.visibility]>=b.hidden){if(!n.cover)return;n={cover:n.cover}}let o=t.worldTransform.a,s=canvas.clientCoordinatesFromCanvas(t.document._source),i=`<div class="pf2e-conditionals" data-hover-id="${t.id}" data-token-id="${e.id}" `;i+=`style="top: ${s.y}px; left: ${s.x+t.hitArea.width*o/2}px;">`;let c=F("icon-path");Object.entries(n).map(([l,a])=>{let u=l==="cover"?"cover":a,f=c[u]||_e[u];(f.startsWith("systems")||f.startsWith("modules"))&&(f=`../../../${f}`),i+=`<div class="conditional"><img src="${f}"></img></div>`}),i+="</div>",$(document.body).append(i)}r(mt,"showConditionals");function Jt(){return!!(this.sight.enabled&&this.actor?.isOfType("creature")&&this.scene?.rulesBasedVision)}r(Jt,"rulesBasedVision");function Xt(t){ve(t.scene,"npc-vision")&&t.actor?.isOfType("npc")&&t.updateSource({"sight.enabled":!0})}r(Xt,"preCreateToken");async function tn(t){let[e,n]=canvas.ready&&!t.viewOnly?[canvas.tokens.controlled.find(y=>y.actor===this)??this.getActiveTokens().shift()??null,t.target?.token??t.target?.actor?.getActiveTokens().shift()??null]:[null,null],o=["attack","attack-roll","attack-damage"].some(y=>t.domains.includes(y)),s=!!(t.melee||t.item?.isOfType("weapon","melee")&&t.item.isMelee),i=s&&t.item?.isOfType("action","weapon","melee")?this.getReach({action:"attack",weapon:t.item}):this.getReach({action:"attack"}),c=!!(o&&s&&typeof i=="number"&&n?.actor&&e?.isFlanking(n,{reach:i})),l=await dt({affects:"origin",origin:this,target:t.target?.actor??n?.actor??null,item:t.item??null,domains:t.domains,options:[...t.options,...t.item?.getRollOptions("item")??[]]}),a=t.viewOnly||!n?.actor?this:this.getContextualClone(ut.compact([Array.from(t.options),n.actor.getSelfRollOptions("target"),c?"self:flanking":null].flat()),l),u=t.statistic instanceof game.pf2e.StatisticModifier,f=u?a.system.actions?.flatMap(y=>[y,y.altUsages??[]].flat())??[]:[],d=t.viewOnly?t.statistic:u?f.find(y=>t.item?.id!==y.item.id||t?.item.name!==y.item.name?!1:t.item.isOfType("melee")&&y.item.isOfType("melee")?!0:t.item.isOfType("weapon")&&y.item.isOfType("weapon")&&t.item.isMelee===y.item.isMelee)??t.statistic:t.statistic,g=(()=>{if(a===this)return t.item??null;if(d&&"item"in d&&d.item instanceof Item&&d.item.isOfType("action","melee","spell","weapon"))return d.item;let y=a.items.get(t.item?.id??"");return y?.isOfType("melee","spell","weapon")?y:t.item??null})(),h=g?.getRollOptions("item")??[],p=[o?"attack":[],u&&g?.isOfType("weapon")&&g.baseType==="alchemical-bomb"?"manipulate":[]].flat();if(g?.isOfType("weapon","melee"))for(let y of this.synthetics.strikeAdjustments)y.adjustTraits?.(g,p);let S=p.map(y=>Ft(y,CONFIG.PF2E.actionTraits)),I=e&&n?e.distanceTo(n):null,[C,T]=typeof I=="number"?[`origin:distance:${I}`,`target:distance:${I}`]:[null,null],R=r(y=>{let E=y?.getSelfRollOptions("target")??[];if(n){E.push("target");let O=this.synthetics.targetMarks.get(n.document.uuid);O&&E.push(`target:mark:${O}`)}return E.sort()},"getTargetRollOptions"),x=R(n?.actor),A=await dt({affects:"target",origin:a,target:n?.actor??null,item:g,domains:t.domains,options:[...t.options,...h,...x]});if(e?.actor&&n?.actor&&!t.viewOnly){let y=X(e,n,{extraOptions:h,distance:I}),E=te(e,n,{perception:y,affects:"origin"});E&&z(y,"target","visibility","noff",E)&&(E=void 0),b[E]>b.concealed&&A.push($t(E));let O=Je(e,n,{perception:y,affects:"target",options:h}),j;if(O){let M=z(y,"target","cover","ac",O)?.first();M!=null&&(M=Math.clamped(Ue(M),0,4)),M===0?O=void 0:M&&(j=M)}P[O]>P.none&&A.push(ge(O,j))}if(c&&Lt(n.actor,a)){let y=game.i18n.localize("PF2E.Item.Condition.Flanked"),E=game.pf2e.ConditionManager.getCondition("off-guard",{name:y});A.push(E.toObject())}let k=t.viewOnly?null:(t.target?.actor??n?.actor)?.getContextualClone([...a.getSelfRollOptions("origin"),...t.options,...h,...C?[C]:[]],A)??null,D=new Set(ut.compact([...t.options,...a.getRollOptions(t.domains),...k?R(k):x,...h,o?"attack":null]).sort());T&&D.add(T);let H=g?wt(g,I):null;H&&D.add(`target:range-increment:${H}`);let ie={actor:a,token:e?.document??null,statistic:d,item:g,modifiers:[]},Te=k&&n&&I!==null?{actor:k,token:n.document,distance:I,rangeIncrement:H}:null;return{options:D,self:ie,target:Te,traits:S}}r(tn,"getRollContext");function le(t,e=!1){if(!t)return;let n=t.id,o=t.isToken;return(e?game.user.targets:canvas.tokens.controlled).find(i=>o?i.actor===t:i.actor.id===n)??t.getActiveTokens().shift()??null}r(le,"getActorToken");function J(t){return t.itemTypes.condition.some(e=>e.slug==="prone")}r(J,"isProne");function ne(t,e=!1){let n=t.itemTypes.effect.find(o=>o.sourceId===fe);return e?Ne(n)?.selection.level:n}r(ne,"getCoverEffect");function nn(){let t=this.system.traits.senses.value,e=sn(t),n=this.rules.filter(o=>o.key==="Sense").map(o=>o.selector.toLowerCase());return e.push(...n),this.getCondition("blinded")?xe.BLINDED:e.includes("darkvision")||e.includes("greaterdarkvision")?xe.DARKVISION:e.includes("lowlightvision")?xe.LOWLIGHT:xe.NORMAL}r(nn,"visionLevel");function on(t,e){if(!t||!e||!t.system.traits?.senses)return!1;e=e.toLowerCase();let n=t.system.traits.senses;return Array.isArray(n)?n=n.map(o=>o.type.toLowerCase()):n=sn(n.value),n.includes(e)}r(on,"hasSense");function et(t){return on(t,"greaterdarkvision")}r(et,"hasGreaterDarkvision");function en(t){return on(t,"seeinvisibility")}r(en,"seeInvisibility");function sn(t){return t.toLowerCase().replaceAll(/[ -]/g,"").split(",")}r(sn,"splitNPCSenses");var tt={LOWER_BY_TWO:-2,LOWER:-1,INCREASE:1,INCREASE_BY_TWO:2,TO_CRITICAL_FAILURE:"criticalFailure",TO_FAILURE:"failure",TO_SUCCESS:"success",TO_CRITICAL_SUCCESS:"criticalSuccess"},rn=["criticalFailure","failure","success","criticalSuccess"],ot,cn,be,nt,de,De,it,an,oe=class{constructor(e,n,o=null){Ce(this,ot);Ce(this,be);Ce(this,de);Ce(this,it);e instanceof Roll?(this.dieResult=(e.isDeterministic?e.terms.find(s=>s instanceof NumericTerm):e.dice.find(s=>s instanceof Die&&s.faces===20))?.total??1,this.rollTotal=e.total):(this.dieResult=e.dieValue,this.rollTotal=e.dieValue+e.modifier),this.dc=typeof n=="number"?{value:n}:n,this.unadjusted=W(this,it,an).call(this),this.adjustment=W(this,ot,cn).call(this,this.unadjusted,o),this.value=this.adjustment?W(this,be,nt).call(this,this.adjustment.amount,this.unadjusted):this.unadjusted}},V=oe;r(V,"DegreeOfSuccess"),ot=new WeakSet,cn=r(function(e,n){if(!n)return null;for(let o of["all",...rn]){let{label:s,amount:i}=n[o]??{};if(i&&s&&!(e===oe.CRITICAL_SUCCESS&&i===tt.INCREASE)&&!(e===oe.CRITICAL_FAILURE&&i===tt.LOWER)&&(o==="all"||rn.indexOf(o)===e))return{label:s,amount:i}}return null},"#getDegreeAdjustment"),be=new WeakSet,nt=r(function(e,n){switch(e){case"criticalFailure":return 0;case"failure":return 1;case"success":return 2;case"criticalSuccess":return 3;default:return Math.clamped(n+e,0,3)}},"#adjustDegreeOfSuccess"),de=new WeakSet,De=r(function(e){return this.dieResult===20?W(this,be,nt).call(this,tt.INCREASE,e):this.dieResult===1?W(this,be,nt).call(this,tt.LOWER,e):e},"#adjustDegreeByDieValue"),it=new WeakSet,an=r(function(){let e=this.dc.value;return this.rollTotal-e>=10?W(this,de,De).call(this,oe.CRITICAL_SUCCESS):e-this.rollTotal>=10?W(this,de,De).call(this,oe.CRITICAL_FAILURE):this.rollTotal>=e?W(this,de,De).call(this,oe.SUCCESS):W(this,de,De).call(this,oe.FAILURE)},"#calculateDegreeOfSuccess"),Se(V,"CRITICAL_FAILURE",0),Se(V,"FAILURE",1),Se(V,"SUCCESS",2),Se(V,"CRITICAL_SUCCESS",3);var Re=class extends Y{static async openMenu(e,n){let o=await super.openMenu(e,n);return o&&e.message&&ln(e.message),o}get title(){return v("menu.validation.title",{name:this.token.name})}get template(){return K("validation")}get selected(){let e=super.selected;return e.length?e:this.globalSelection}get globalSelection(){let e=this.token,n=e.actor.alliance;return G(e).filter(o=>o.actor.alliance!==n).map(o=>o.id)}getSavedData(e=!0){let n=super.getSavedData();return e?this._convertData(n):n}_convertData(e){let n=this.property,o=this.scene,s=this.selected,i=N[n],c=n==="cover"?B:se;for(let l of s){let a=o.tokens.get(l),u=`${l}.${n}`,f=getProperty(e,u)??i,d=this.processValue({token:a,value:f});c.includes(d)||(d=f),f!==d&&setProperty(e,u,d)}return e}processValue(e){throw new Error(`${this.constructor.name} doesn't have a 'processValue' method defined`)}getData(e){let{covers:n,visibilities:o,i18n:s}=super.getData(e),i=this.currentData,c=this.getSavedData(!1),l=this.property,a=this.selected,u=G(this.token);u=u.map(({id:d,name:g,actor:h})=>{let p=i[d]??{},S=c[d]??{};return{id:d,name:g,alliance:h.alliance,selected:a.includes(d),...Y.createPropertyData(S,p,l)}});let f=F("validation");return f==="selected"?u=u.filter(d=>d.selected):f==="changed"&&(u=u.filter(d=>d.changed)),{...this._spliIntoAlliances(u),i18n:s,property:l,options:l==="cover"?n:o,showSelected:a.length!==u.length&&f==="all",showChanges:f!=="changed"}}activateListeners(e){super.activateListeners(e),e.find("[data-action=cancel]").on("click",n=>{this.close()})}};r(Re,"ValidationMenu");var Ae=class extends Re{#e;constructor(e,n={}){super(e,n),this.#e=e.value}get property(){return"cover"}processValue(){return this.#e}};r(Ae,"CoverValidationMenu");var ue=class extends Re{#e;constructor(e,n={}){super(e,n),this.#e=e.roll}get property(){return"visibility"}get roll(){return this.#e}};r(ue,"VisibilityValidationMenu");var Pe=class extends ue{processValue({token:e,value:n}){let o=this.roll,s=e.actor.perception.dc.value,i=b[n],c=new V(o,s).value;return c>=V.SUCCESS&&i<b.hidden?"hidden":c<=V.FAILURE&&i>=b.hidden?"observed":n}};r(Pe,"HideValidationMenu");var $e=class extends ue{get selected(){return G(this.token).map(e=>e.id)}processValue({token:e,value:n}){return b[n]>=b.hidden?"observed":n}};r($e,"UnHideValidationMenu");var Fe=class extends ue{#e;constructor(e,n={}){super(e,n),this.#e=e.originator}get selected(){let e=this.token,n=e.actor.alliance,o=this.#e.id,s=_(e)??{};return G(e).filter(i=>{if(i.id===o||i.actor.alliance===n)return!1;let c=getProperty(s,`${i.id}.visibility`);return b[c]>=b.undetected}).map(i=>i.id)}processValue({token:e,value:n}){return b[n]>=b.undetected?"hidden":n}};r(Fe,"PointOutValidationMenu");var st=class extends ue{getSavedData(e=!0){let n=this.token.id,o=G(this.token),s={};for(let i of o){let c=_(i,n);c&&(s[i.id]=deepClone(c))}return e?this._convertData(s):s}getData(){let e=super.getData();return e.isReversed=!0,e.options=se.map(n=>({value:n,label:v(`visibility.reversed.${n}`)})),e}_saveData(e){let n=this.scene,o=this.token.id,s=[];for(let[i,c]of Object.entries(e)){let l={_id:i},a=n.tokens.get(i);if(a){c.visibility===N.visibility&&delete c.visibility;let u=_(a,o)??{};if(u?.visibility===c.visibility)continue;!u.cover&&!c.visibility?l[`flags.${m}.data.-=${o}`]=!0:c.visibility?l[`flags.${m}.data.${o}.visibility`]=c.visibility:l[`flags.${m}.data.${o}.-=visibility`]=!0}else l[`flags.${m}.data.-=${o}`]=!0;s.push(l)}n.updateEmbeddedDocuments("Token",s)}};r(st,"ReverseVisibilityValidationMenu");var we=class extends st{#e;constructor(e,n={}){super(e,n),this.#e=e.fromTemplate}get globalSelection(){return this.#e?[]:super.globalSelection}static async openMenu(e,n){await super.openMenu(e,n)&&Z(e.token)}processValue({token:e,value:n}){let o=this.roll,s=e.actor.skills.stealth.dc.value,i=b[n],c=new V(o,s).value;return c>=V.CRITICAL_SUCCESS&&i>=b.hidden||c>=V.SUCCESS&&i===b.hidden?"observed":c>=V.SUCCESS&&i>=b.undetected?"hidden":n}};r(we,"SeekValidationMenu");function yt(t,e){let n=t.token;if(!n)return;let o=game.user.isGM,s=n.hasPlayerOwner,{cover:i,selected:c,skipWait:l,validated:a,pointOut:u}=At(t),f=t.getFlag("pf2e","context");if(i){if(o){let d=vt({property:"cover",skipWait:l,validated:a});e.find(".message-content").append(d),e.find("[data-action=validate-cover]").on("click",()=>{Ae.openMenu({token:n,selected:c,value:i,message:t})})}else if(!l){let d=ht("cover",a);e.find(".message-content").append(d)}}else if(f?.pf2ePerception?.visibility){a||e.find(".message-buttons").remove();let d=e.find(".flavor-text");!o&&s&&(e.find(".message-sender").text(n.name),d.empty());let g=v(`message.flat-check.${a===void 0?"blind":a?"success":"failure"}`),h=fn(g,a);if(d.append(h),o)for(let p of["success","failure"])d.append(kt({action:`${p}-message`,icon:"fa-solid fa-message",label:v("message.flat-check.button",p)})),e.find(`[data-action=${p}-message]`).on("click",()=>{lt(t,"validated",p==="success")})}else if(f?.type==="skill-check"&&f.pf2ePerception)if(o){if(f.options.includes("action:hide")){let d=vt({property:"visibility",skipWait:l,validated:a});e.find(".flavor-text").append(d),e.find("[data-action=validate-visibility]").on("click",()=>{Pe.openMenu({token:n,message:t,roll:t.rolls[0],selected:f.pf2ePerception.selected})})}}else s&&f.options.includes("action:hide")&&un({token:n,message:t,html:e,validated:a});else if(f?.type==="perception-check"&&f.pf2ePerception)if(o){if(f.options.includes("action:seek")){let d=dn({skipWait:l,validated:a,smallAction:"delete-template",smallIcon:"fa-thin fa-cubes",smallSlashed:!0});e.find(".flavor-text").append(d),e.find("[data-action=validate-visibility]").on("click",()=>{we.openMenu({token:n,message:t,roll:t.rolls[0],selected:f.pf2ePerception.selected,fromTemplate:f.pf2ePerception.fromTemplate})}),e.find("[data-action=delete-template").on("click",()=>{Z(n)})}}else s&&f.options.includes("action:seek")&&un({token:n,message:t,html:e,validated:a});else if(u){let d=n.scene.tokens.get(u);if(!d)return;if(o){let g=dn({skipWait:l,validated:a,smallAction:"ping-token",smallIcon:"fa-solid fa-signal-stream"});e.find(".message-content").append(g),e.find("[data-action=validate-visibility]").on("click",()=>{Fe.openMenu({message:t,token:d,originator:n,selected:canvas.tokens.controlled.map(h=>h.id)})}),e.find("[data-action=ping-token]").on("click",()=>{canvas.ping(d.center)})}else if(s){let g=ht("visibility",a);e.find(".message-content").append(g)}}if(o&&pe.includes(f?.type)){let g=`<span style="position: absolute; right: 0px; bottom: 1px;">
    <button data-action="unhide" title="${v("message.unhide.tooltip")}" style="width: 22px; height: 22px; font-size: 10px; line-height: 1px;">
        <i class="fa-duotone fa-eye-slash" style="right: 1px;"></i>
    </button>
</span>`;e.find(".dice-result .dice-total").append(g),e.find("[data-action=unhide]").on("click",h=>{h.stopPropagation(),$e.openMenu({token:n})})}}r(yt,"renderChatMessage");function ln(t){L(t,"validated")||lt(t,"validated",!0)}r(ln,"validateMessage");function dn({skipWait:t,validated:e,smallIcon:n,smallAction:o,smallSlashed:s}){let i='<div style="display: grid; grid-template-columns: 1fr auto; gap: 3px">';return i+=vt({property:"visibility",skipWait:t,validated:e}),i+=kt({action:o,icon:n,slashed:s,tooltip:v(`message.visibility.small-button.${o}`)}),i+="</div>",i}r(dn,"createValidateCombo");function un({html:t,token:e,message:n,validated:o}){t.find(".message-sender").text(e.name);let s=n.getFlag("pf2e","modifierName");s+=ht("visibility",o),t.find(".flavor-text").html(s)}r(un,"addBlindSkillCheckFlavor");function ht(t,e){let n=v(`message.${t}.player.${e?"validated":"wait"}`);return fn(n,e)}r(ht,"createWaitHint");function fn(t,e){return e===!0?t='<i class="fa-solid fa-check" style="color: green;"></i> '+t:e===!1&&(t='<i class="fa-solid fa-xmark" style="color: red;"></i> '+t),`<i style="display: block; font-size: .9em; text-align: end;">${t}</i>`}r(fn,"createHint");function vt({skipWait:t,validated:e,property:n}){let o=v(`message.${n}.gm.${t?"check":e?"validated":"validate"}`);return!t&&e&&(o+='<i class="fa-solid fa-check" style="color: green; margin-left: 0.3em;"></i>'),kt({action:`validate-${n}`,icon:"fa-solid fa-list",label:o})}r(vt,"createValidateButton");function kt({action:t,icon:e,label:n,tooltip:o,slashed:s=!1}){let i=`<button type="button" style="margin: 0 0 5px; padding-block: 0; position: relative;" data-action="${t}" title="${o}">`;return e&&(i+=`<i class="${e}" ${n?"":'style="margin: 0;"'}></i>`,s&&(i+='<i class="fa-solid fa-slash-forward" style="position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); font-size: 1.2em;"></i>')),n&&(i+=`${e?" ":""}${n}`),i+="</button>",i}r(kt,"createChatButton");async function bt({content:t,token:e,flags:n,secret:o}){let s={content:t,speaker:ChatMessage.getSpeaker({token:e instanceof Token?e.document:e})};return n&&setProperty(s,`flags.${m}`,n),o&&(s.type=CONST.CHAT_MESSAGE_TYPES.WHISPER,s.whisper=ChatMessage.getWhisperRecipients("gm")),ChatMessage.create(s)}r(bt,"createTokenMessage");function gn(){let t=game.pf2e.actions.get("hide"),e=ye(t,2).constructor,n=ye(t.toActionVariant(),2).constructor,o=ye(t,1).constructor,s=ye(t.toActionVariant(),1).constructor;Un(e,n),Gn(o,s),Nn(o,s),_n(o,s),Ln(e,n)}r(gn,"setupActions");function Ln(t,e){class n extends e{async use(i={}){let c=v("action.point-out"),l=Le(i,c);l&&Mn(this,l)}}r(n,"PointOutVariant");class o extends t{constructor(){super({cost:1,name:`${m}.action.point-out`,description:`${m}.action.point-out.description`,rollOptions:["action:point-out"],slug:"point-out",traits:["auditory","manipulate","visual"]})}toActionVariant(i={}){return i.name??=this.name,new n(this,i)}}r(o,"PointOut"),game.pf2e.actions.set("point-out",new o)}r(Ln,"setupPointOut");async function Mn({name:t,traits:e},n){let o=game.user.targets.filter(u=>u.actor).first(),s=o?_(o,n.id,"visibility"):void 0,i=o&&b[s]<b.undetected,c;if(i){let u=o.actor.skills.stealth.dc.value;c=v("message.point-out.short-check",{check:`@Check[type:perception|dc:${u}|traits:auditory,manipulate,visual|showDC:gm]`})}else c=v("message.point-out.short");let l=await renderTemplate(K("point-out"),{description:c,name:t,traits:e.map(u=>({slug:u,tooltip:CONFIG.PF2E.traitsDescriptions[u],name:CONFIG.PF2E.actionTraits[u]}))}),a={pointOut:i?o.id:void 0};bt({content:l,token:n,flags:a})}r(Mn,"pointOut");function _n(t,e){class n extends e{async use(i={}){let c=game.i18n.localize("PF2E.Actions.Seek.Title"),l=Le(i,c);if(l)return await Vn(l)?(i.actors=[l.actor],super.use(i)):Z(l)}}r(n,"SeekVariant");class o extends t{constructor(){super({cost:1,description:"PF2E.Actions.Seek.Description",name:"PF2E.Actions.Seek.Title",notes:[{outcome:["criticalSuccess"],text:"PF2E.Actions.Seek.Notes.criticalSuccess"},{outcome:["success"],text:"PF2E.Actions.Seek.Notes.success"}],rollOptions:["action:seek"],slug:"seek",statistic:"perception",traits:["concentrate","secret"]})}toActionVariant(i){return new n(this,i)}}r(o,"Seek"),game.pf2e.actions.set("seek",new o)}r(_n,"setupSeek");async function Vn(t){let e=game.i18n.localize("PF2E.Foot"),n='<p style="margin: 0 0.3em; text-align: center;">';return n+=`${v("dialog.seek.hint")}</p><p>`,n+=pn("create-cone","fa-thin fa-cubes",game.i18n.format("PF2E.TemplateLabel",{size:30,unit:e,shape:game.i18n.localize(CONFIG.PF2E.areaTypes.cone)})),n+=pn("create-burst","fa-thin fa-cubes",game.i18n.format("PF2E.TemplateLabel",{size:15,unit:e,shape:game.i18n.localize(CONFIG.PF2E.areaTypes.burst)})),n+="</p>",Dialog.wait({title:`${t.name} - ${game.i18n.localize("PF2E.Actions.Seek.Title")}`,content:n,buttons:{ok:{icon:'<i class="fa-solid fa-check"></i>',label:v("dialog.seek.accept"),callback:()=>!0},no:{icon:'<i class="fa-solid fa-xmark"></i>',label:v("dialog.seek.cancel"),callback:o=>!1}},close:()=>!1,render:o=>{o.filter(".dialog-content").find("[data-action=create-cone], [data-action=create-burst]").on("click",i=>{let{action:c}=i.currentTarget.dataset;Z(t),We({type:c==="create-cone"?"cone":"burst",token:t})})}},{width:300,left:10})}r(Vn,"seek");function Nn(t,e){class n extends e{async use(i={}){let c=game.i18n.localize("PF2E.Actions.Sneak.Title"),l=Le(i,c);if(l)return i.actors=[l.actor],super.use(i)}}r(n,"SneakVariant");class o extends t{constructor(){super({cost:1,description:"PF2E.Actions.Sneak.Description",name:"PF2E.Actions.Sneak.Title",notes:[{outcome:["success","criticalSuccess"],text:"PF2E.Actions.Sneak.Notes.success"},{outcome:["failure"],text:"PF2E.Actions.Sneak.Notes.failure"},{outcome:["criticalFailure"],text:"PF2E.Actions.Sneak.Notes.criticalFailure"}],rollOptions:["action:sneak"],slug:"sneak",traits:["move","secret"]})}toActionVariant(i){return new n(this,i)}}r(o,"Sneak")}r(Nn,"setupSneak");function Gn(t,e){class n extends e{async use(i={}){let c=game.i18n.localize("PF2E.Actions.Hide.Title"),l=Le(i,c);if(l)return i.actors=[l.actor],super.use(i)}}r(n,"HideVariant");class o extends t{constructor(){super({cost:1,description:"PF2E.Actions.Hide.Description",name:"PF2E.Actions.Hide.Title",rollOptions:["action:hide"],slug:"hide",statistic:"stealth",traits:["secret"],notes:[{outcome:["success","criticalSuccess"],text:"PF2E.Actions.Hide.Notes.success"}]})}toActionVariant(i){return new n(this,i)}}r(o,"Hide"),game.pf2e.actions.set("hide",new o)}r(Gn,"setupHide");function Un(t,e){class n extends e{async use(i={}){let c=v("action.take-cover"),l=Le(i,c);l&&zn(l)}}r(n,"TakeCoverVariant");class o extends t{constructor(){super({cost:1,description:"PF2E.Actions.TakeCover.Description",img:"systems/pf2e/icons/conditions-2/status_acup.webp",name:"PF2E.Actions.TakeCover.Title",slug:"take-cover"})}toActionVariant(i){return new n(this,i)}}r(o,"TakeCover"),game.pf2e.actions.set("take-cover",new o)}r(Un,"setupCover");async function zn(t){let e=t.actor,n=ne(e),o=ee(t,game.user.targets.ids);if(n&&!o.length)return n.delete();let s=_(t)??{},i=Object.entries(s).reduce((a,[u,{cover:f}])=>(f&&(a[u]=f),a),{}),c=await renderTemplate(K("covers-dialog"),{i18n:v,hasTargets:!!o.length,hasCovers:!isEmpty(i),hasTargetCover:o.some(a=>a in i),isProne:J(e)}),l=new Dialog({title:`${t.name} - ${v("action.take-cover")}`,content:c,buttons:{},render:a=>{a.find("button").on("click",async u=>{let{level:f}=u.currentTarget.dataset,d=F("skip-cover"),g=r(async(h,p)=>{p=p?o:void 0;let S=h===N.cover?p?"remove":"remove-all":"take",I=await bt({content:v(`message.cover.${S}`,{cover:v(`cover.${h}`)}),flags:{selected:p,cover:h,skipWait:d},token:t});if(d){if(h===N.cover&&!p)return Yt(t);let C=deepClone(_(t))??{};for(let T of o)setProperty(C,`${T}.cover`,h);return ze(t,C)}},"process");if(f==="remove-all")g(N.cover);else if(f==="remove")g(N.cover,!0);else if(o.length)g(f,!0);else{let h=ge(f);e.createEmbeddedDocuments("Item",[h])}l.close()})}}).render(!0)}r(zn,"takeCover");function Le(t,e){let n=t.tokens?.filter(i=>i.actor)??[];Array.isArray(n)||(n=[n]);let o=t.actors??[];if(Array.isArray(o)||(o=[o]),!n.length&&o.length===1&&(n=[le(o[0])].filter(Boolean)),n.length||(n=canvas.tokens.controlled.filter(i=>i.actor)),n.length||(n=[le(game.user.character)].filter(Boolean)),n.length>1){ui.notifications.warn(v("action.only-one",{action:e}));return}else if(!n.length){ui.notifications.warn(v("action.must-one",{action:e}));return}let s=n[0];if(!s?.actor?.isOfType("creature")){ui.notifications.warn(v("action.must-creature",{action:e}));return}return s}r(Le,"getSelectedToken");function pn(t,e,n){return`<button type="button" data-action="${t}" style="margin: 0 0 5px; padding: 0;">
    <i class="${e}"></i> ${n}</button>
</button>`}r(pn,"createButton");var mn={geometry:{clearDebug:re,getRectEdges:je,lineIntersectWall:Ee,pointToTokenIntersectWall:Be},token:{getCreatureCover:gt,getWallCover:Ze,getVisibility:te,clearConditionals:ae,showConditionals:mt,showAllConditionals:Xe,getTokenData:_,getCover:Je,openHUD:pt},lighting:{getLightExposure:He},actor:{getActorToken:le,isProne:J,getCoverEffect:ne,hasGreaterDarkvision:et},scene:{getValidTokens:G,validateTokens:ee,getSceneSetting:ve},template:{createSeekTemplate:We,createDarknessTemplate:Gt,createMistTemplate:Ut,getDarknessTemplates:Ye,getMistTemplates:qe,getSeekTemplateTokens:Ke,deleteSeekTemplate:Z,createTemplate:Oe,getTemplateTokens:ke},ruleElement:{perceptionRules:X,getPerception:z,updateFromPerceptionRules:he}};async function hn(t,...e){let n=e[1];if(!n)return t(...e);Array.isArray(n.options)&&(n.options=new Set(n.options));let{actor:o,createMessage:s="true",type:i,token:c,target:l,isReroll:a}=n,u=c??le(o),f=l?.token,d=pe.includes(i),g=F("flat-check");if(a||!s||!u||!It.includes(i)||d&&(!f||g==="none"))return t(...e);if(d&&f.actor){let h=e[2],p=X(u,f,{extraOptions:n.options.filter(A=>A.startsWith("item:"))}),S=te(f,u,{perception:p,affects:"target"});if(!S)return t(...e);let I=(()=>{let A=z(p,"target","visibility","dc",S)?.first(),k=Ue(A);if(!k)return k;let D=A[0];return["-","+"].includes(D)?(S==="concealed"?5:11)+k:k})();if(I===0)return t(...e);let C=b[S]>=b.undetected,T=h?.ctrlKey||h?.metaKey,x=(await new u.actor.perception.constructor(u.actor,{slug:"visibility-check",label:`${game.i18n.localize("PF2E.FlatCheck")}: ${game.i18n.localize(`PF2E.condition.${S}.name`)}`,check:{type:"flat-check"}}).roll({dc:{value:I??(S==="concealed"?5:11)},target:f.actor,rollMode:C||T?game.user.isGM?"gmroll":"blindroll":"roll"})).degreeOfSuccess>1;if(C&&(n.options.add("secret"),n.pf2ePerception={isSuccess:x,visibility:S}),g!=="roll"&&!C&&!x)return}else if(n.options.has("action:hide"))setProperty(n,"pf2ePerception.selected",game.user.targets.ids);else if(n.options.has("action:seek")){let h=Ke(u),p=h??Array.from(game.user.targets),S=ee(u,p).filter(I=>!I.document.hidden).map(I=>I.id);setProperty(n,"pf2ePerception.selected",S),setProperty(n,"pf2ePerception.fromTemplate",!!h)}return t(...e)}r(hn,"checkRoll");function vn(t,e){let{createMessage:n="true",type:o,token:s,target:i,isReroll:c,options:l,dc:a}=t.context,u=s,f=i?.token,d=i?.actor;if(c||!n||!u||!f||!d||!pe.includes(o))return;let g=ne(d),h=g?Ne(g)?.selection.level??L(g,"level"):void 0,p=t[m]?.coverOverride??h,S='<div class="roll-mode-panel">';S+=`<div class="label">${v("dice-checks.cover.label")}</div>`,S+=`<select name="overrideCover"><option value="">${v("dice-checks.cover.none")}</option>`,(J(d)?B.slice(1):B.slice(1,-1)).forEach(C=>{let T=C===p?"selected":"",R=v(`cover.${C}`);S+=`<option value="${C}" ${T}>${R}</option>`}),S+="</select></div>",S+="<hr>",e.find(".roll-mode-panel").before(S),e.find("select[name=overrideCover]").on("change",C=>{let T=C.currentTarget.value||void 0;setProperty(t,`${m}.coverOverride`,T),p=T}),e.find("button.roll")[0].addEventListener("click",C=>{C.preventDefault(),C.stopPropagation(),C.stopImmediatePropagation();let T=!1,R=deepClone(d._source.items);if(p!==h){T=!0;let x=R.findIndex(A=>getProperty(A,"flags.core.sourceId")===fe);if(x!==-1&&R.splice(x,1),p){let A=ge(p);R.push(A)}}if(T&&(i.actor=d.clone({items:R},{keepId:!0}),a?.slug)){let x=i.actor.getStatistic(a.slug)?.dc;x&&(a.value=x.value,a.statistic=x)}t.resolve(!0),t.isResolved=!0,t.close()},!0),t.setPosition()}r(vn,"renderCheckModifiersDialog");function yn(t,e){F("target")&&jn(e)}r(yn,"renderCombatTracker");function jn(t){t.find("[data-control=toggleTarget]").each((e,n)=>{n.addEventListener("click",o=>{o.preventDefault(),o.stopPropagation(),o.stopImmediatePropagation();let{combatantId:s}=o.currentTarget.closest(".combatant").dataset,c=game.combats.viewed.combatants.get(s??"")?.token;if(!c)return;let l=Array.from(game.user.targets).some(a=>a.document===c);c.object.setTarget(!l,{releaseOthers:!o.shiftKey})},!0)})}r(jn,"setupToggleTarget");function kn(t,e){let n=F("encounter");e.find(".form-group").last().after(`<div class="form-group">
    <label>${v("settings.encounter.name")}</label>
    <input type="checkbox" name="pf2e-perception.encounter" ${n?"checked":""}>
    <p class="notes">${v("settings.encounter.short")}</p>
</div>`),e.find('input[name="pf2e-perception.encounter"]').on("change",o=>{let s=o.currentTarget.checked;Ve("encounter",s)})}r(kn,"renderCombatTrackerConfig");function bn(t,e,n={}){return!e.enabled||!this._canDetect(t,n.object,n)?!1:n.tests.some(o=>this._testPoint(t,e,n.object,o))}r(bn,"detectionModeTestVisibility");function Tn(t,e,n){if(e instanceof PlaceableObject&&e.document.hidden)return!1;if(!(e instanceof Token))return!0;let o=t.object,s=o.document;return s instanceof TokenDocument&&s.hasStatusEffect(CONFIG.specialStatusEffects.BLIND)?!1:o instanceof Token?!Tt(o,e,b.hidden,n):!e.document?.hasStatusEffect(CONFIG.specialStatusEffects.INVISIBLE)&&!e.actor?.hasCondition("hidden","undetected","unnoticed")}r(Tn,"basicSightCanDetect");function Sn(t,e,n){if(e.document.hidden||!(e instanceof Token)||!e.actor?.emitsSound)return!1;if(!game.settings.get("pf2e","automation.rulesBasedVision"))return!0;let o=t.object;return o.actor?.hasCondition("deafened")?!1:o instanceof Token?!Tt(o,e,b.undetected,n):!e.actor?.hasCondition("undetected","unnoticed")}r(Sn,"hearingCanDetect");function Cn(t,e,n){if(e.document.hidden||!(e instanceof Token)||e.document.elevation>canvas.primary.background.elevation||e.actor?.isOfType("loot"))return!1;let o=t.object;return o instanceof Token?!Tt(o,e,b.undetected,n):!e.actor?.hasCondition("undetected","unnoticed")}r(Cn,"feelTremorCanDetect");function Tt(t,e,n,o={}){if(!o.visibility){let s=X(t,e);o.visibility=te(e,t,{perception:s,affects:"target"})}return b[o.visibility]>=n}r(Tt,"reachesThreshold");var Bn=["cover","concealed","hidden","undetected","unnoticed"],Me=class extends FormApplication{static get defaultOptions(){return foundry.utils.mergeObject(super.defaultOptions,{template:K("icon-path-menu"),title:v("settings.icon-path.name"),width:500})}getData(){let e=F("icon-path");return{icons:Bn.map(o=>({name:o,placeholder:_e[o],value:e[o]??"",label:o==="cover"?v("icon-path.cover"):game.i18n.localize(CONFIG.PF2E.conditionTypes[o])})),i18n:v}}activateListeners(e){super.activateListeners(e),e.find("button[name=cancel]").on("click",n=>{n.prefentDefault(),this.close()})}async _updateObject(e,n){Ve("icon-path",n)}};r(Me,"IconPathMenu");function xn(){U("icon-path",Object,{},{config:!1}),game.settings.registerMenu(m,"icon-path-menu",{name:w("icon-path","name"),label:w("icon-path","label"),icon:"fa-solid fa-list",restricted:!0,type:Me}),U("permission",String,CONST.USER_ROLES.GAMEMASTER,{choices:{1:w("permission","choices.1"),2:w("permission","choices.2"),3:w("permission","choices.3"),4:w("permission","choices.4")}}),U("npc-vision",Boolean,!1),U("target",Boolean,!0,{onChange:()=>ui.combat?.render()}),U("lesser",String,"ten",{choices:{none:w("lesser","choices.none"),cross:w("lesser","choices.cross"),zero:w("lesser","choices.zero"),ten:w("lesser","choices.ten"),twenty:w("lesser","choices.twenty")}}),U("standard",Boolean,!0),U("dead-cover",Boolean,!0),U("prone-cover",Boolean,!0),U("standard-type",String,"center",{choices:{center:w("standard-type","choices.center"),points:w("standard-type","choices.points")}}),U("skip-cover",Boolean,!0),U("validation",String,"all",{choices:{all:w("validation","choices.all"),selected:w("validation","choices.selected"),changed:w("validation","choices.changed")}}),U("flat-check",String,"roll",{choices:{none:w("flat-check","choices.none"),roll:w("flat-check","choices.roll"),cancel:w("flat-check","choices.cancel")}}),U("encounter",Boolean,!1)}r(xn,"registerSettings");function w(t,e){return`${m}.settings.${t}.${e}`}r(w,"path");function U(t,e,n,o={}){game.settings.register(m,t,{name:w(t,"name"),hint:w(t,"hint"),scope:"world",config:!0,type:e,default:n,...o})}r(U,"register");var Hn="game.pf2e.Check.roll",Wn="CONFIG.Token.documentClass.prototype.rulesBasedVision",Yn="CONFIG.MeasuredTemplate.objectClass.prototype.highlightGrid",qn="CONFIG.Actor.documentClass.prototype.getRollContext",Kn="CONFIG.PF2E.Actor.documentClasses.npc.prototype.visionLevel",Qn="DetectionMode.prototype.testVisibility",Zn="CONFIG.Canvas.detectionModes.basicSight._canDetect",Jn="CONFIG.Canvas.detectionModes.hearing._canDetect",Xn="CONFIG.Canvas.detectionModes.feelTremor._canDetect";Hooks.once("init",()=>{xn(),gn(),Mt(),libWrapper.register(m,Hn,hn),libWrapper.register(m,Yn,jt,"OVERRIDE"),libWrapper.register(m,Wn,Jt,"OVERRIDE"),libWrapper.register(m,qn,tn,"OVERRIDE"),libWrapper.register(m,Kn,nn,"OVERRIDE"),libWrapper.register(m,Qn,bn,"OVERRIDE"),libWrapper.register(m,Zn,Tn,"OVERRIDE"),libWrapper.register(m,Jn,Sn,"OVERRIDE"),libWrapper.register(m,Xn,Cn,"OVERRIDE"),game.data.users.find(e=>e._id===game.data.userId).role>=CONST.USER_ROLES.GAMEMASTER?(Hooks.on("renderSceneConfig",Vt),Hooks.on("renderCombatTrackerConfig",kn)):Hooks.on("renderCombatTracker",yn),game.modules.get(m).custom={getWallCover:void 0}});Hooks.once("ready",()=>{game.modules.get(m).api=mn,Hooks.on("renderChatMessage",yt);for(let t of document.querySelectorAll("#chat-log .chat-message")){let e=game.messages.get(t.dataset.messageId);e&&yt(e,$(t))}game.user.isGM&&game.modules.get("pf2e-rules-based-npc-vision")?.active&&ui.notifications.error(`${m}.warning.npc-vision`,{permanent:!0,localize:!0})});Hooks.on("hoverToken",Kt);Hooks.on("pasteToken",Wt);Hooks.on("updateToken",qt);Hooks.on("deleteToken",Qt);Hooks.on("controlToken",Zt);Hooks.on("renderTokenHUD",Ht);Hooks.on("preCreateToken",Xt);Hooks.on("canvasPan",()=>ae());Hooks.on("renderCheckModifiersDialog",vn);Hooks.on("preCreateMeasuredTemplate",Bt);Hooks.on("createMeasuredTemplate",Qe);Hooks.on("updateMeasuredTemplate",Qe);Hooks.on("deleteMeasuredTemplate",Qe);})();
//# sourceMappingURL=main.js.map
