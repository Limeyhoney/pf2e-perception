(()=>{var at=Object.defineProperty;var on=(t,e,n)=>e in t?at(t,e,{enumerable:!0,configurable:!0,writable:!0,value:n}):t[e]=n;var r=(t,e)=>at(t,"name",{value:e,configurable:!0});var ye=(t,e,n)=>(on(t,typeof e!="symbol"?e+"":e,n),n),lt=(t,e,n)=>{if(!e.has(t))throw TypeError("Cannot "+n)};var ut=(t,e,n)=>(lt(t,e,"read from private field"),n?n.call(t):e.get(t)),X=(t,e,n)=>{if(e.has(t))throw TypeError("Cannot add the same private member more than once");e instanceof WeakSet?e.add(t):e.set(t,n)};var M=(t,e,n)=>(lt(t,e,"access private method"),n);var ue="Compendium.pf2e.other-effects.Item.I9lfZUiCwMiGogVi",k={[void 0]:0,observed:0,concealed:1,hidden:2,undetected:3,unnoticed:4},Z=["observed","concealed","hidden","undetected","unnoticed"],B=["none","lesser","standard","greater","greater-prone"],x={[void 0]:0,none:0,lesser:1,standard:2,greater:3,"greater-prone":4},R={cover:"none",visibility:"observed"},de=["attack-roll","spell-attack-roll"],dt=[...de,"skill-check","perception-check"],$e={cover:"modules/pf2e-perception/images/cover.webp",concealed:"systems/pf2e/icons/conditions/concealed.webp",hidden:"systems/pf2e/icons/conditions/hidden.webp",undetected:"systems/pf2e/icons/conditions/undetected.webp",unnoticed:"systems/pf2e/icons/conditions/unnoticed.webp"},ke={BLINDED:0,NORMAL:1,LOWLIGHT:2,DARKVISION:3};var g="pf2e-perception";function G(t){return`modules/${g}/templates/${t}.hbs`}r(G,"templatePath");function p(...t){let e=t.at(-1),n=typeof e=="object",o=n?t.slice(0,-1):t;return o.unshift(g),game.i18n[n?"format":"localize"](o.join("."),e)}r(p,"localize");function V(t,e){return t.getFlag(g,e)}r(V,"getFlag");function Ke(t,e,n){return t.setFlag(g,e,n)}r(Ke,"setFlag");function ft(t,e){return t.unsetFlag(g,e,!0)}r(ft,"unsetFlag");function pt(t){return getProperty(t,`flags.${g}`)??{}}r(pt,"getFlags");function I(t){return game.settings.get(g,t)}r(I,"getSetting");function we(t,e){return game.settings.set(g,t,e)}r(we,"setSetting");function gt(){return game.user.role>=I("permission")}r(gt,"hasPermission");function mt(t){let e=game.i18n.localize(`PF2E.condition.${t}.name`);return game.pf2e.ConditionManager.getCondition("flat-footed",{name:e}).toObject()}r(mt,"createFlatFootedSource");function fe(t,e){return e??=x[t]===3?4:x[t],{_id:"I9lfZUiCwMiGogVi",img:"systems/pf2e/icons/conditions-2/status_acup.webp",name:p("cover",t),system:{description:{gm:"",value:"<p>When you're behind an obstacle that could block weapons, guard you against explosions, and make you harder to detect, you're behind cover. Standard cover gives you a +2 circumstance bonus to AC, to Reflex saves against area effects, and to Stealth checks to Hide, Sneak, or otherwise avoid detection. You can increase this to greater cover using the Take Cover basic action, increasing the circumstance bonus to +4. If cover is especially light, typically when it's provided by a creature, you have lesser cover, which grants a +1 circumstance bonus to AC. A creature with standard cover or greater cover can attempt to use Stealth to Hide, but lesser cover isn't sufficient.</p>"},rules:[{domain:"all",key:"RollOption",option:`self:cover-bonus:${e}`},{domain:"all",key:"RollOption",option:`self:cover-level:${t}`},{key:"FlatModifier",predicate:[{or:[{and:["self:condition:prone","item:ranged"]},{not:"self:cover-level:greater-prone"}]}],selector:"ac",type:"circumstance",value:e},{key:"FlatModifier",predicate:["area-effect",{not:"self:cover-level:greater-prone"}],selector:"reflex",type:"circumstance",value:e},{key:"FlatModifier",predicate:[{or:["action:hide","action:sneak","avoid-detection"]},{not:"self:cover-level:greater-prone"}],selector:"stealth",type:"circumstance",value:e},{key:"FlatModifier",predicate:["action:avoid-notice",{not:"self:cover-level:greater-prone"}],selector:"initiative",type:"circumstance",value:e}],slug:"effect-cover"},type:"effect",flags:{core:{sourceId:ue},[g]:{level:t,bonus:e}}}}r(fe,"createCoverSource");function Fe(t,e=void 0){if(t)return t.system.rules.find(n=>n.key==="ChoiceSet"&&(!e||n.flag===e))}r(Fe,"findChoiceSetRule");function J(t,e="origin"){let n={};return t.forEach(o=>{let i=o.split(":");if(i.at(1)!=="pf2perception")return;let s=i.at(0)==="self"?e:i.at(0),c=i.at(-1),a=[s,...i.slice(2,-1)].join("."),l=getProperty(n,a);l?l.push(c):l=[c],setProperty(n,a,l)}),n}r(J,"optionsToObject");function Le(t,e,n,o){let i=r(a=>a?["all",t].some(l=>a.includes(l)):!1,"test"),s=i(e.origin?.[n]?.[o]),c=i(e.target?.[n]?.[`${o}-self`]);return s||c}r(Le,"testOption");function be(t,...e){let n=getProperty(t.origin,e.join("."))??[],o=getProperty(t.target,[...e.slice(0,-1),e.at(-1)+"-self"].join("."))??[];return[...n,...o]}r(be,"getOption");function Ce(t,e,n){let o=n==="cover"?B:Z;if(e=Array.isArray(e)?J(e):e,t&&Le(t,e,n,"cancel"))return;let i=be(e,n,"set")?.[0];if(i&&o.includes(i))return i===o[0]?void 0:i;if(t&&Le(t,e,n,"reduce")){let s=o.indexOf(t);return o[Math.max(0,s-1)]}return t}r(Ce,"updateFromOptions");var _=class extends Array{constructor(...e){super(...Array.isArray(e[0])?e[0]:e),this.isValid=_.isValid(this)}static isValid(e){return this.isArray(e)}static isArray(e){return super.isArray(e)&&e.every(n=>Q.isStatement(n))}static test(e=[],n){return e instanceof _?e.test(n):new _(...e).test(n)}test(e){if(this.length===0)return!0;if(!this.isValid)return console.warn("PF2e System | The provided predicate set is malformed."),!1;let n=e instanceof Set?e:new Set(e);return this.every(o=>this.#e(o,n))}toObject(){return deepClone([...this])}clone(){return new _(this.toObject())}#e(e,n){return typeof e=="string"&&n.has(e)||Q.isBinaryOp(e)&&this.#n(e,n)||Q.isCompound(e)&&this.#t(e,n)}#n(e,n){if("eq"in e)return n.has(`${e.eq[0]}:${e.eq[1]}`);{let o=Object.keys(e)[0],[i,s]=Object.values(e)[0],c=Array.from(n),a=r(d=>{let f=Number(d);if(!Number.isNaN(f))return[f];let y=new RegExp(String.raw`^${d}:([^:]+)$`);return c.map(h=>Number(y.exec(h)?.[1]||NaN)).filter(h=>!Number.isNaN(h))},"getValues"),l=a(i),u=a(s);switch(o){case"gt":return l.some(d=>u.every(f=>d>f));case"gte":return l.some(d=>u.every(f=>d>=f));case"lt":return l.some(d=>u.every(f=>d<f));case"lte":return l.some(d=>u.every(f=>d<=f));default:return console.warn("PF2e System | Malformed binary operation encountered"),!1}}}#t(e,n){return"and"in e&&e.and.every(o=>this.#e(o,n))||"nand"in e&&!e.nand.every(o=>this.#e(o,n))||"or"in e&&e.or.some(o=>this.#e(o,n))||"xor"in e&&e.xor.filter(o=>this.#e(o,n)).length===1||"nor"in e&&!e.nor.some(o=>this.#e(o,n))||"not"in e&&!this.#e(e.not,n)||"if"in e&&!(this.#e(e.if,n)&&!this.#e(e.then,n))}};r(_,"PredicatePF2e");var Ve,Q=class{static isStatement(e){return e instanceof Object?this.isCompound(e)||this.isBinaryOp(e):typeof e=="string"?this.isAtomic(e):!1}static isAtomic(e){return typeof e=="string"&&e.length>0||this.isBinaryOp(e)}static isBinaryOp(e){if(!Xe(e))return!1;let n=Object.entries(e);if(n.length>1)return!1;let[o,i]=n[0];return ut(this,Ve).has(o)&&Array.isArray(i)&&i.length===2&&typeof i[0]=="string"&&["string","number"].includes(typeof i[1])}static isCompound(e){return Xe(e)&&(this.isAnd(e)||this.isOr(e)||this.isNand(e)||this.isXor(e)||this.isNor(e)||this.isNot(e)||this.isIf(e))}static isAnd(e){return Object.keys(e).length===1&&Array.isArray(e.and)&&e.and.every(n=>this.isStatement(n))}static isNand(e){return Object.keys(e).length===1&&Array.isArray(e.nand)&&e.nand.every(n=>this.isStatement(n))}static isOr(e){return Object.keys(e).length===1&&Array.isArray(e.or)&&e.or.every(n=>this.isStatement(n))}static isXor(e){return Object.keys(e).length===1&&Array.isArray(e.xor)&&e.xor.every(n=>this.isStatement(n))}static isNor(e){return Object.keys(e).length===1&&Array.isArray(e.nor)&&e.nor.every(n=>this.isStatement(n))}static isNot(e){return Object.keys(e).length===1&&!!e.not&&this.isStatement(e.not)}static isIf(e){return Object.keys(e).length===2&&this.isStatement(e.if)&&this.isStatement(e.then)}};r(Q,"StatementValidator"),Ve=new WeakMap,X(Q,Ve,new Set(["eq","gt","gte","lt","lte"]));async function Ze({affects:t,origin:e,target:n,item:o,domains:i,options:s}){if(!(e&&n))return[];let[c,a]=t==="target"?[e,n]:[n,e],l=[...s,...a.getSelfRollOptions(t)],u=o?o.isOfType("spell")?{spell:o}:{weapon:o}:{};return(await Promise.all(i.flatMap(d=>c.synthetics.ephemeralEffects[d]?.[t]??[]).map(d=>d({test:l,resolvables:u})))).flatMap(d=>d??[])}r(Ze,"extractEphemeralEffects");function ht(t,e){let n={name:t,label:game.i18n.localize(e[t]??t)};return sn(CONFIG.PF2E.traitsDescriptions,t)&&(n.description=CONFIG.PF2E.traitsDescriptions[t]),n}r(ht,"traitSlugToObject");function sn(t,e){return(typeof e=="string"||typeof e=="number")&&e in t}r(sn,"objectHasKey");function vt(t,e){return t.isOfType("spell")?null:t.rangeIncrement&&typeof e=="number"?Math.max(Math.ceil(e/t.rangeIncrement),1):null}r(vt,"getRangeIncrement");function yt(t){if(!t.isOfType("creature"))return!1;let{flanking:e}=t.attributes;if(!e.flankable)return!1;let n=t.getRollOptions();return typeof e.flatFootable=="number"?!_.test([{lte:["origin:level",e.flatFootable]}],n):e.flatFootable}r(yt,"isOffGuardFromFlanking");function Xe(t){return typeof t=="object"&&t!==null}r(Xe,"isObject");function kt(t,e){let n="",o=["standard","exposure","npc-vision"];for(let s of o){let c=W(t.object,s);n+=`<div class="form-group pf2e-perception-injected">
    <label>${p(`settings.${s}.name`)}</label>
    <input type="checkbox" name="flags.pf2e-perception.${s}" ${c?"checked":""}>
    <p class="notes">${p(`settings.${s}.short`)}</p>
</div>`}n+="<hr>",e.find('.tab[data-tab="basic"] hr').first().after(n);let i=e.find(".pf2e-perception-injected").toArray().reduce((s,c)=>(s+=c.clientHeight,s),0);t.setPosition({top:t.position.top-i/2})}r(kt,"renderSceneConfig");function w(t){if(t=t instanceof Token?t.document:t,!(t instanceof TokenDocument))return[];let e=t.scene.tokens.filter(n=>n!==t&&n.actor?.isOfType("creature"));if(I("encounter")){let n=game.combats.active;return n?e.filter(o=>{let i=o.actor,s=i.traits;return i.type==="familiar"||s.has("minion")||s.has("eidolon")||n.getCombatantByToken(o.id)}):e}return e}r(w,"getValidTokens");function z(t,e){let n=w(t).map(o=>o.id);return e.filter(o=>{let i=o instanceof Token||o instanceof TokenDocument?o.id:o;return n.includes(i)})}r(z,"validateTokens");function W(t,e){return V(t,e)??I(e)}r(W,"getSceneSetting");function pe(t,e=1){let n=Object.getPrototypeOf(t);return e>1?pe(n,e-1):n}r(pe,"getPrototype");function Me(t,e){return t.name.localeCompare(e.name)}r(Me,"sortByName");var P=class extends Application{#e;#n;#t;#o;#i;constructor({token:e,resolve:n,selected:o=[]},i={}){super(i),this.#e=e,this.#n=n,this.#t=o,this.#i=(s,c)=>{let a=s.id,l=this.element.find("[data-token-id]");l.removeClass("hover"),c&&l.filter(`[data-token-id=${a}]`).addClass("hover")},Hooks.on("hoverToken",this.#i)}async close(e={}){Hooks.off("hoverToken",this.#i),this.#n?.(e.resolve??!1),super.close(e)}static get defaultOptions(){return mergeObject(super.defaultOptions,{minimizable:!1})}static async openMenu(e,n={}){if(e.token instanceof TokenDocument&&(e.token=e.token.object),!e.token){ui.notifications.error(p("menu.no-token"));return}n.id=`${g}-${e.token.document.uuid}`;let o=Object.values(ui.windows).find(i=>i.id===n.id);return o&&o.close(),new Promise(i=>{e.resolve=i,new this(e,n).render(!0)})}static createPropertyData(e,n,o){let i=R[o],s=e[o]??i,c=n[o]??i;return{original:s,current:c,changed:s!==c,custom:c!==i,originalCustom:s!==i}}get token(){return this.#e}get document(){return this.#e.document}get actor(){return this.#e.actor}get scene(){return this.#e.scene}get selected(){return this.#t.length?z(this.token,this.#t):[]}get currentData(){return deepClone(this.#s)}get#s(){return this.#o||(this.#o=this.getSavedData()),this.#o}getSavedData(){let e=O(this.document)??{};return deepClone(e)}reset(){this.#o=this.getSavedData(),this.#t=[],this.render()}isSelected(e){let n=typeof e=="object"?e.id:e;return this.#t.includes(n)}getData(e){let n=B.map(o=>({value:o,label:p(`cover.${o}`)}));return{i18n:p,covers:N(this.actor)?n:n.slice(0,-1),visibilities:Z.map(o=>({value:o,label:p(`visibility.${o}`)}))}}activateListeners(e){e.find("[data-token-id]").on("mouseenter",n=>{let{tokenId:o}=n.currentTarget.dataset,i=this.scene.tokens.get(o)?.object;!i||i.controlled||i._onHoverIn(n,{hoverOutOthers:!0})}),e.find("[data-action=close]").on("click",()=>{this.close({resolve:!0})}),e.find("select[name=visibility], select[name=cover]").on("change",n=>{let o=n.currentTarget,i=o.name,s=R[i],c=o.value||s,a=o.closest(".token")?.dataset.tokenId,l=a?[a]:this.#t;for(let u of l)setProperty(this.#s,`${u}.${i}`,c);a?(o.classList.toggle("changed",c!==o.dataset.original),o.classList.toggle("custom",c!==s)):this.render()}),e.find("[data-action=accept]").on("click",n=>{this._saveData(this.#s),this.close({resolve:!0})})}_saveData(e){_e(this.document,e)}_setSelected(e){this.#t=e??this.element.find("[data-token-id].ui-selected").toArray().map(n=>n.dataset.tokenId)}_spliIntoAlliances(e){let n=[],o=[],i=[],s=this.actor.alliance,c=s==="party"?"opposition":s==="opposition"?"party":null;for(let a of e)if(c){let l=a.actor?a.actor.alliance:a.alliance;l===s?n.push(a):l===c?o.push(a):l===null&&i.push(a)}else i.push(a);return{allies:n.sort(Me),neutral:i.sort(Me),enemies:o.sort(Me),hasTokens:n.length||o.length||i.length}}};r(P,"BaseMenu");var Te=class extends P{get title(){return p("menu.perception.title",{name:this.token.name})}get template(){return G("perception")}getData(e){let n=this.selected,o=this.currentData,i=this.getSavedData(),s=w(this.token).map(({id:c,name:a,actor:l})=>{let u=o[c]??{},d=i[c]??{};return{id:c,name:a,alliance:l.alliance,cover:P.createPropertyData(d,u,"cover"),visibility:P.createPropertyData(d,u,"visibility"),selected:n.includes(c)}});return{...super.getData(e),...this._spliIntoAlliances(s)}}activateListeners(e){super.activateListeners(e),e.filter(".tokens").selectable({autoRefresh:!1,filter:".token",cancel:"header,select",stop:()=>this._setSelected()}),e.find("[data-action=select-all]").on("click",n=>{let o=$(n.currentTarget).closest("section"),i=(o.length?o:e).find("[data-token-id]"),s=i.filter(":not(.ui-selected)").length===0;i.toggleClass("ui-selected",!s),this._setSelected()}),e.find("[data-action=use-selection]").on("click",n=>{this._setSelected(canvas.tokens.controlled.map(o=>o.id)),this.render()}),e.find("[data-action=reset]").on("click",n=>this.reset())}};r(Te,"PerceptionMenu");var rn=[{x:0,y:0},{x:1,y:0},{x:0,y:1},{x:1,y:1}],cn=[{x:.25,y:.25},{x:.5,y:.25},{x:.75,y:.25},{x:.25,y:.5},{x:.5,y:.5},{x:.75,y:.5},{x:.25,y:.75},{x:.5,y:.75},{x:.75,y:.75}];function bt(t,e){let n=1-e;return{top:{A:j({x:e,y:e},t),B:j({x:n,y:e},t)},right:{A:j({x:n,y:e},t),B:j({x:n,y:n},t)},bottom:{A:j({x:n,y:n},t),B:j({x:e,y:n},t)},left:{A:j({x:e,y:n},t),B:j({x:e,y:e},t)}}}r(bt,"getRectEdges");function Se(t,e,n=!1){return n&&U(t,e),CONFIG.Canvas.polygonBackends.move.testCollision(t,e,{type:"move",mode:"any"})}r(Se,"lineIntersectWall");function Pe(t,e,n=!1){for(let o of an(e.bounds))if(Se(t,o,n))return!0;return!1}r(Pe,"pointToTokenIntersectWall");function j(t,e){return{x:e.x+e.width*t.x,y:e.y+e.height*t.y}}r(j,"getRectPoint");function ee(){canvas.controls.debug.clear()}r(ee,"clearDebug");function U(t,e,n="blue"){let o=n==="blue"?26316:n==="red"?16711680:1483011;canvas.controls.debug.lineStyle(4,o).moveTo(t.x,t.y).lineTo(e.x,e.y)}r(U,"drawDebugLine");function*an(t){for(let e of cn)yield j(e,t)}r(an,"rectSpread");function*Ct(t){for(let e of rn)yield j(e,t)}r(Ct,"rectCorners");function Ne(t,e=!1){if(t=t instanceof Token?t:t.object,t.document.hasStatusEffect(CONFIG.specialStatusEffects.INVISIBLE))return;let n=t.scene;if(n!==canvas.scene||!n.tokenVision||n.darkness<n.globalLightThreshold||!W(n,"exposure"))return;e&&ee();let o=t.document.bounds,i=null;for(let s of canvas.effects.lightSources){if(!s.active)continue;let c=s.data.bright,a=s.data.dim;if(s.object===t){if(c)return"bright";a&&(i="dim");continue}let l=[];for(let u of Ct(o))s.shape.contains(u.x,u.y)?l.push(u):e&&U(s,u,"red");if(l.length){if(s.ratio===1)return e&&U(s,l,"green"),"bright";if(s.ratio===0){e&&U(s,l,"blue"),i="dim";continue}for(let u of l)if(new Ray(s,u).distance<=c)if(e)U(s,u,"green"),i="bright";else return"bright";else e?(U(s,u,"blue"),i!=="bright"&&(i="dim")):i="dim"}}return i}r(Ne,"getLightExposure");function Tt(t,e){!gt()||!t.object.actor?.isOfType("creature")||(e.find(".col.left").append('<div class="control-icon" data-action="pf2e-perception"><i class="fa-solid fa-eye"></i></div>'),e.find("[data-action=pf2e-perception]").on("click",n=>Te.openMenu({token:t.object})))}r(Tt,"renderTokenHUD");function St(t,e){for(let n of e)delete n.flags?.[g]}r(St,"pasteToken");function O(t,...e){return e.unshift("data"),t=t instanceof Token?t.document:t,V(t,e.join("."))}r(O,"getTokenData");async function xt(t){return t=t instanceof Token?t.document:t,ft(t,"data")}r(xt,"clearTokenData");async function _e(t,e){let n=w(t).map(i=>i.id),o={};for(let i in e){if(!n.includes(i)){o[`flags.${g}.data.-=${i}`]=!0;continue}let s=e[i],c=O(t,i)??{};if(s.visibility===R.visibility&&delete s.visibility,s.cover===R.cover&&delete s.cover,!(c.cover===s.cover&&c.visibility===s.visibility))if(!s.visibility&&!s.cover)o[`flags.${g}.data.-=${i}`]=!0;else for(let a of["cover","visibility"])c[a]!==s[a]&&(s[a]?o[`flags.${g}.data.${i}.${a}`]=s[a]:o[`flags.${g}.data.${i}.-=${a}`]=!0)}return t=t instanceof Token?t.document:t,t.update(o)}r(_e,"setTokenData");function Je(t,e,n=!1){let o=t.scene;if(!W(o,"standard"))return!1;n&&ee();let i=I("standard-type");if(i==="center")return Se(t.center,e.center,n);if(i==="points")return Pe(t.center,e,n)}r(Je,"hasStandardCover");var te={tiny:0,sm:1,med:2,lg:3,huge:4,grg:5};function Qe(t,e,n=[],o=!1){let i=I("lesser");if(i==="none")return;n=J(n);let s=[...n.target?.cover?.ignore??[],...n.origin?.cover?.ignore??[]],c,a=t.center,l=e.center;o&&(ee(),U(a,l));let u=r(v=>{let C=te[v.actor.size];return C-d>=2&&C-f>=2},"isExtraLarge"),d=te[t.actor.size],f=te[e.actor.size],y=t.scene.tokens.contents.filter(v=>v.actor&&!s.includes(v.id)).sort((v,C)=>te[C.actor.size]-te[v.actor.size]),h=d<te.huge&&f<te.huge&&y.filter(u).length,m=i==="ten"?.1:i==="twenty"?.2:0,b=r(v=>(o&&U(v.A,v.B,"red"),lineSegmentIntersects(a,l,v.A,v.B)),"intersectsEdge"),A=i==="cross"?v=>b(v.top)&&b(v.bottom)||b(v.left)&&b(v.right):v=>Object.values(v).some(C=>b(C));for(let v of y){let C=v.object;if(v.hidden||C===t||C===e)continue;let E=bt(C.bounds,m);if(A(E))return h?"standard":"lesser";u(v)&&h--}return c}r(Qe,"getCreatureCover");function ge(t,e){let n=(()=>{let l=t.actor,u=["unnoticed","undetected","hidden","concealed"];for(let d of u)if(l.hasCondition(d))return d})(),o=O(t,e.id,"visibility"),i=k[n]>k[o]?n:o,s=k[i];if(s>=k.undetected)return i;let c=Ne(t),a=c==="dim"?"concealed":c===null?"hidden":void 0;return s>k[a]?i:a}r(ge,"getVisibility");function It(t,e,n,o){let i=e.flags?.["pf2e-perception"];if(i&&(i.data||i["-=data"]!==void 0)){if(t.object.renderFlags.set({refreshVisibility:!0}),game.user.isGM)return;let s=Hooks.on("refreshToken",c=>{!t.object!==c&&(Hooks.off("refreshToken",s),game.combat?.getCombatantByToken(t.id)&&ui.combat.render())})}}r(It,"updateToken");function Ot(t,e){e?je(t):me(t)}r(Ot,"hoverToken");function Et(t){me(t),game.user.isGM||ui.combat.render()}r(Et,"deleteToken");function At(t){me(t),Hooks.once("sightRefresh",()=>t.hover&&je(t))}r(At,"controlToken");function me(t){if(!t?.id)return $(".pf2e-conditionals").remove();$(`.pf2e-conditionals[data-hover-id=${t.id}]`).remove(),$(`.pf2e-conditionals[data-token-id=${t.id}]`).remove()}r(me,"clearConditionals");function je(t){let e=w(t);for(let n of e)et(n,t)}r(je,"showAllConditionals");async function et(t,e){if(t=t instanceof Token?t:t.object,!t.visible||!t.actor?.isOfType("creature"))return;let n=O(t,e.id);if(isEmpty(n))return;if(!game.user.isGM&&!e.document.hasPlayerOwner&&k[n.visibility]>=k.hidden){if(!n.cover)return;n={cover:n.cover}}let o=t.worldTransform.a,i=canvas.clientCoordinatesFromCanvas(t.document._source),s=`<div class="pf2e-conditionals" data-hover-id="${t.id}" data-token-id="${e.id}" `;s+=`style="top: ${i.y}px; left: ${i.x+t.hitArea.width*o/2}px;">`;let c=I("icon-path");Object.entries(n).map(([a,l])=>{let u=a==="cover"?"cover":l,d=c[u]||$e[u];(d.startsWith("systems")||d.startsWith("modules"))&&(d=`../../../${d}`),s+=`<div class="conditional"><img src="${d}"></img></div>`}),s+="</div>",$(document.body).append(s)}r(et,"showConditionals");function Ue(t,e,n,o=!1){let s=n.includes("item:ranged")?N(e.actor):!1,c=Y(e.actor,!0);if(s&&x[c]>x.lesser)return"greater-prone";!s&&c==="greater-prone"&&(c=void 0);let a=O(e,t.id,"cover");return s&&x[a]>x.lesser||(!s&&a==="greater-prone"&&(a=void 0),x[a]<x.standard&&x[c]<x.standard&&Je(t,e,o)?a="standard":!a&&!c&&t.distanceTo(e)>5&&(a=Qe(t,e,n,o)),s&&x[a]>x.lesser)?"greater-prone":x[a]>x[c]?a:void 0}r(Ue,"getConditionalCover");function Dt(){return!!(this.sight.enabled&&this.actor?.isOfType("creature")&&this.scene?.rulesBasedVision)}r(Dt,"rulesBasedVision");function Rt(t){W(t.scene,"npc-vision")&&t.actor?.isOfType("npc")&&t.updateSource({"sight.enabled":!0})}r(Rt,"preCreateToken");async function $t(t){let[e,n]=canvas.ready&&!t.viewOnly?[canvas.tokens.controlled.find(T=>T.actor===this)??this.getActiveTokens().shift()??null,t.target?.token??t.target?.actor?.getActiveTokens().shift()??null]:[null,null],o=this.getRollOptions(t.domains??[]),i=await Ze({affects:"origin",origin:this,target:t.target?.actor??n?.actor??null,item:t.item??null,domains:t.domains,options:[...t.options,...t.item?.getRollOptions("item")??[]]}),s=t.viewOnly||!n?.actor?this:this.getContextualClone([...o,...n.actor.getSelfRollOptions("target")],i),c=t.statistic instanceof game.pf2e.StatisticModifier,a=c?s.system.actions?.flatMap(T=>[T,T.altUsages??[]].flat())??[]:[],l=t.viewOnly?t.statistic:c?a.find(T=>t.item?.id!==T.item.id||t?.item.name!==T.item.name?!1:t.item.isOfType("melee")&&T.item.isOfType("melee")?!0:t.item.isOfType("weapon")&&T.item.isOfType("weapon")&&t.item.isMelee===T.item.isMelee)??t.statistic:t.statistic,u=(()=>{if(s===this)return t.item??null;if(l&&"item"in l&&l.item instanceof Item&&l.item.isOfType("melee","spell","weapon"))return l.item;let T=s.items.get(t.item?.id??"");return T?.isOfType("melee","spell","weapon")?T:t.item??null})(),d=u?.getRollOptions("item")??[],y=[["attack","strike-damage","attack-spell-damage"].some(T=>t.domains.includes(T))?"attack":[],c&&u?.isOfType("weapon")&&u.baseType==="alchemical-bomb"?"manipulate":[]].flat();if(u?.isOfType("weapon","melee"))for(let T of this.synthetics.strikeAdjustments)T.adjustTraits?.(u,y);let h=y.map(T=>ht(T,CONFIG.PF2E.actionTraits)),m=e&&n?e.distanceTo(n):null,[b,A]=typeof m=="number"?[`origin:distance:${m}`,`target:distance:${m}`]:[null,null],v=r(T=>{let ve=T?.getSelfRollOptions("target")??[];if(n){ve.push("target");let ct=this.synthetics.targetMarks.get(n.document.uuid);ct&&ve.push(`target:mark:${ct}`)}return ve},"getTargetRollOptions"),C=v(n?.actor),E=await Ze({affects:"target",origin:s,target:n?.actor??null,item:u,domains:t.domains,options:[...t.options,...d,...C]}),[F,H]=t.item?.isOfType("melee")?[t.item.reach,t.item.isMelee]:t.item?.isOfType("weapon")?[this.getReach({action:"attack",weapon:t.item}),t.item.isMelee]:[null,!1];if(e&&n&&ln({selfToken:e,targetToken:n,ephemeralEffects:E,options:[...t.options,...s.getSelfRollOptions("origin"),...d,...C]}),!!(H&&typeof F=="number"&&t.statistic instanceof game.pf2e.StatisticModifier&&n&&e?.isFlanking(n,{reach:F}))&&t.target?.token?.actor&&yt(t.target.token.actor)){let T=game.i18n.localize("PF2E.Item.Condition.Flanked"),ve=game.pf2e.ConditionManager.getCondition("flat-footed",{name:T});E.push(ve.toObject())}let K=t.viewOnly?null:(t.target?.actor??n?.actor)?.getContextualClone([...s.getSelfRollOptions("origin"),...d,...b?[b]:[]],E)??null,le=new Set([...t.options,...o,...K?v(K):C,...d,"attack"]);A&&le.add(A);let qe=u?vt(u,m):null;qe&&le.add(`target:range-increment:${qe}`);let tn={actor:s,token:e?.document??null,statistic:l,item:u,modifiers:[]},nn=K&&n&&m!==null?{actor:K,token:n.document,distance:m,rangeIncrement:qe}:null;return{options:le,self:tn,target:nn,traits:h}}r($t,"getRollContext");function ln({ephemeralEffects:t,selfToken:e,targetToken:n,options:o}){let i=Ue(e,n,o),s=ge(e,n);o=J(o),i=Ce(i,o,"cover"),s=Ce(s,o,"visibility");let c;if(i){let a=be(o,i,"ac")?.[0];a==0?i=void 0:a&&(c=a)}s&&Le(s,o,"visibility","noff")&&(s=void 0),x[i]>x.none&&t.push(fe(i,c)),k[s]>k.concealed&&t.push(mt(s))}r(ln,"addConditionals");function ne(t,e=!1){if(!t)return;let n=t.id,o=t.isToken;return(e?game.user.targets:canvas.tokens.controlled).find(s=>o?s.actor===t:s.actor.id===n)??t.getActiveTokens().shift()??null}r(ne,"getActorToken");function N(t){return t.itemTypes.condition.some(e=>e.slug==="prone")}r(N,"isProne");function Y(t,e=!1){let n=t.itemTypes.effect.find(o=>o.sourceId===ue);return e?Fe(n)?.selection.level:n}r(Y,"getCoverEffect");function wt(){let e=this.system.traits.senses.value.toLowerCase().replaceAll(/[ -]/g,"").split(","),n=this.rules.filter(o=>o.key==="Sense").map(o=>o.selector.toLowerCase());return e.push(...n),this.getCondition("blinded")?ke.BLINDED:e.includes("darkvision")||e.includes("greaterdarkvision")?ke.DARKVISION:e.includes("lowlightvision")?ke.LOWLIGHT:ke.NORMAL}r(wt,"visionLevel");function it(t,e){let n=t.token;if(!n)return;let o=game.user.isGM,i=n.hasPlayerOwner,{cover:s,selected:c,skipWait:a,validated:l,blindCheck:u,pointOut:d}=pt(t),f=t.getFlag("pf2e","context");if(u&&!o&&i)e.find(".message-sender").text(n.name),e.find(".flavor-text").html(u);else if(s){if(o){let y=nt({property:"cover",skipWait:a,validated:l});e.find(".message-content").append(y),e.find("[data-action=validate-cover]").on("click",()=>{oe.openMenu({token:n,selected:c,value:s,message:t})})}else if(!a){let y=tt("cover",l);e.find(".message-content").append(y)}}else if(f?.pf2ePerception?.visibility){l||e.find(".message-buttons").remove();let y=e.find(".flavor-text");!o&&i&&(e.find(".message-sender").text(n.name),y.empty());let h=p(`message.flat-check.${l===void 0?"blind":l?"success":"failure"}`),m=Mt(h,l);if(y.append(m),o)for(let b of["success","failure"])y.append(ot({action:`${b}-message`,icon:"fa-solid fa-message",label:p("message.flat-check.button",b)})),e.find(`[data-action=${b}-message]`).on("click",()=>{Ke(t,"validated",b==="success")})}else if(f?.type==="skill-check")o?f.options.includes("action:hide")&&Lt({token:n,html:e,message:t,skipWait:a,validated:l,selected:f.pf2ePerception.selected,ValidationMenu:ie}):i&&f.options.includes("action:hide")&&Ft({token:n,message:t,html:e,validated:l});else if(f?.type==="perception-check")o?f.options.includes("action:seek")&&Lt({token:n,html:e,message:t,skipWait:a,validated:l,selected:f.pf2ePerception.selected,ValidationMenu:se}):i&&f.options.includes("action:seek")&&Ft({token:n,message:t,html:e,validated:l});else if(d){let y=n.scene.tokens.get(d);if(!y)return;if(o){let h='<div style="display: grid; grid-template-columns: 1fr auto; gap: 3px">';h+=nt({property:"visibility",skipWait:a,validated:l}),h+=ot({action:"ping-token",icon:"fa-solid fa-signal-stream"}),h+="</div>",e.find(".message-content").append(h),e.find("[data-action=validate-visibility]").on("click",async()=>{Ie.openMenu({message:t,token:y,originator:n,selected:canvas.tokens.controlled.map(m=>m.id)})}),e.find("[data-action=ping-token]").on("click",()=>{canvas.ping(y.center)})}else if(i){let h=tt("visibility",l);e.find(".message-content").append(h)}}if(o&&de.includes(f?.type)){let h=`<span style="position: absolute; right: 0px; bottom: 1px;">
    <button data-action="unhide" title="${p("message.unhide.tooltip")}" style="width: 22px; height: 22px; font-size: 10px; line-height: 1px;">
        <i class="fa-duotone fa-eye-slash" style="right: 1px;"></i>
    </button>
</span>`;e.find(".dice-result .dice-total").append(h),e.find("[data-action=unhide]").on("click",m=>{m.stopPropagation(),xe.openMenu({token:n})})}}r(it,"renderChatMessage");function Vt(t){V(t,"validated")||Ke(t,"validated",!0)}r(Vt,"validateMessage");function Ft({html:t,token:e,message:n,validated:o}){t.find(".message-sender").text(e.name);let i=n.getFlag("pf2e","modifierName");i+=tt("visibility",o),t.find(".flavor-text").html(i)}r(Ft,"addBlindSkillCheckFlavor");function tt(t,e){let n=p(`message.${t}.player.${e?"validated":"wait"}`);return Mt(n,e)}r(tt,"createWaitHint");function Mt(t,e){return e===!0?t='<i class="fa-solid fa-check" style="color: green;"></i> '+t:e===!1&&(t='<i class="fa-solid fa-xmark" style="color: red;"></i> '+t),`<i style="display: block; font-size: .9em; text-align: end;">${t}</i>`}r(Mt,"createHint");function Lt({skipWait:t,validated:e,html:n,message:o,ValidationMenu:i,token:s,selected:c}){let a=nt({property:"visibility",skipWait:t,validated:e});n.find(".flavor-text").append(a),n.find("[data-action=validate-visibility]").on("click",async()=>{let l=o.rolls[0];i.openMenu({token:s,message:o,roll:l,selected:c})})}r(Lt,"addVisibilityValidationButton");function nt({skipWait:t,validated:e,property:n}){let o=p(`message.${n}.gm.${t?"check":e?"validated":"validate"}`);return!t&&e&&(o+='<i class="fa-solid fa-check" style="color: green; margin-left: 0.3em;"></i>'),ot({action:`validate-${n}`,icon:"fa-solid fa-list",label:o})}r(nt,"createValidateButton");function ot({action:t,icon:e,label:n}){let o=`<button type="button" style="margin: 0 0 5px; padding-block: 0;" data-action="${t}">`;return e&&(o+=`<i class="${e}" ${n?"":'style="margin: 0;"'}></i>`),n&&(o+=`${e?" ":""}${n}`),o+="</button>",o}r(ot,"createChatButton");async function st({content:t,token:e,flags:n,secret:o}){let i={content:t,speaker:ChatMessage.getSpeaker({token:e instanceof Token?e.document:e})};return n&&setProperty(i,`flags.${g}`,n),o&&(i.type=CONST.CHAT_MESSAGE_TYPES.WHISPER,i.whisper=ChatMessage.getWhisperRecipients("gm")),ChatMessage.create(i)}r(st,"createTokenMessage");var Be={LOWER_BY_TWO:-2,LOWER:-1,INCREASE:1,INCREASE_BY_TWO:2,TO_CRITICAL_FAILURE:"criticalFailure",TO_FAILURE:"failure",TO_SUCCESS:"success",TO_CRITICAL_SUCCESS:"criticalSuccess"},_t=["criticalFailure","failure","success","criticalSuccess"],He,Pt,he,Ge,re,Oe,ze,Nt,q=class{constructor(e,n,o=null){X(this,He);X(this,he);X(this,re);X(this,ze);e instanceof Roll?(this.dieResult=(e.isDeterministic?e.terms.find(i=>i instanceof NumericTerm):e.dice.find(i=>i instanceof Die&&i.faces===20))?.total??1,this.rollTotal=e.total):(this.dieResult=e.dieValue,this.rollTotal=e.dieValue+e.modifier),this.dc=typeof n=="number"?{value:n}:n,this.unadjusted=M(this,ze,Nt).call(this),this.adjustment=M(this,He,Pt).call(this,this.unadjusted,o),this.value=this.adjustment?M(this,he,Ge).call(this,this.adjustment.amount,this.unadjusted):this.unadjusted}},D=q;r(D,"DegreeOfSuccess"),He=new WeakSet,Pt=r(function(e,n){if(!n)return null;for(let o of["all",..._t]){let{label:i,amount:s}=n[o]??{};if(s&&i&&!(e===q.CRITICAL_SUCCESS&&s===Be.INCREASE)&&!(e===q.CRITICAL_FAILURE&&s===Be.LOWER)&&(o==="all"||_t.indexOf(o)===e))return{label:i,amount:s}}return null},"#getDegreeAdjustment"),he=new WeakSet,Ge=r(function(e,n){switch(e){case"criticalFailure":return 0;case"failure":return 1;case"success":return 2;case"criticalSuccess":return 3;default:return Math.clamped(n+e,0,3)}},"#adjustDegreeOfSuccess"),re=new WeakSet,Oe=r(function(e){return this.dieResult===20?M(this,he,Ge).call(this,Be.INCREASE,e):this.dieResult===1?M(this,he,Ge).call(this,Be.LOWER,e):e},"#adjustDegreeByDieValue"),ze=new WeakSet,Nt=r(function(){let e=this.dc.value;return this.rollTotal-e>=10?M(this,re,Oe).call(this,q.CRITICAL_SUCCESS):e-this.rollTotal>=10?M(this,re,Oe).call(this,q.CRITICAL_FAILURE):this.rollTotal>=e?M(this,re,Oe).call(this,q.SUCCESS):M(this,re,Oe).call(this,q.FAILURE)},"#calculateDegreeOfSuccess"),ye(D,"CRITICAL_FAILURE",0),ye(D,"FAILURE",1),ye(D,"SUCCESS",2),ye(D,"CRITICAL_SUCCESS",3);var un={burst:"circle",emanation:"circle",line:"ray",cone:"cone",rect:"rect"};function jt(t,e){fn({type:t,token:e,distance:t==="cone"?30:15,traits:["concentrate","secret"]})}r(jt,"createSeekTemplate");function dn(t){return t.scene.templates.find(e=>V(e,"tokenId")===t.id)}r(dn,"getTokenTemplate");function Ut(t){if(!Bt(t))return null;let e=dn(t);return e?pn(e.object):null}r(Ut,"getTokenTemplateTokens");async function Ee(t){let e=t.scene.templates.filter(n=>V(n,"tokenId")===t.id);for(let n of e)await n.delete()}r(Ee,"deleteTokenTemplate");function Bt(t){return canvas.scene===t.scene?!0:(ui.notifications.error(p("template.scene")),!1)}r(Bt,"checkScene");function fn({type:t,distance:e,traits:n,fillColor:o,width:i,token:s}){if(!Bt(s))return;let c={distance:e,t:un[t],fillColor:o||game.user.color,flags:{[g]:{tokenId:s.id}}};c.t==="ray"?c.width=i||CONFIG.MeasuredTemplate.defaults.width*(canvas.dimensions?.distance??1):c.t==="cone"&&(c.angle=CONFIG.MeasuredTemplate.defaults.angle),n&&setProperty(c,"flags.pf2e.origin.traits",n);let a=new CONFIG.MeasuredTemplate.documentClass(c,{parent:canvas.scene});new CONFIG.MeasuredTemplate.objectClass(a).drawPreview()}r(fn,"createTemplate");function pn(t,{collisionOrigin:e,collisionType:n="move"}={}){if(!canvas.scene)return[];let{grid:o,dimensions:i}=canvas;if(!(o&&i))return[];let s=o.getHighlightLayer(t.highlightId);if(!s||o.type!==CONST.GRID_TYPES.SQUARE)return[];let c=e??t.center,a=canvas.tokens.quadtree.getObjects(s.getLocalBounds(void 0,!0)),l=[];for(let u of a){let d=u.document,f=[];for(let y=0;y<d.height;y++){let h=u.y+y*o.size;if(f.push(`${u.x}.${h}`),d.width>1)for(let m=1;m<d.width;m++)f.push(`${u.x+m*o.size}.${h}`)}for(let y of f){if(!s.positions.has(y))continue;let[h,m]=y.split(".").map(v=>Number(v)),b={x:h+i.size*.5,y:m+i.size*.5};if(b.x<0||b.y<0)continue;if(!(canvas.ready&&n&&CONFIG.Canvas.polygonBackends[n].testCollision(c,b,{type:n,mode:"any"}))){l.push(u);break}}}return l}r(pn,"getTokens");var Ae=class extends P{static async openMenu(e,n){let o=await super.openMenu(e,n);return o&&e.message&&Vt(e.message),o}get title(){return p("menu.validation.title",{name:this.token.name})}get template(){return G("validation")}get selected(){let e=super.selected;if(e.length)return e;let n=this.token,o=n.actor.alliance;return w(n).filter(i=>i.actor.alliance!==o).map(i=>i.id)}getSavedData(e=!0){let n=super.getSavedData();return e?this._convertData(n):n}_convertData(e){let n=this.property,o=this.scene,i=this.selected,s=R[n],c=n==="cover"?B:Z;for(let a of i){let l=o.tokens.get(a),u=`${a}.${n}`,d=getProperty(e,u)??s,f=this.processValue({token:l,value:d});c.includes(f)||(f=d),d!==f&&setProperty(e,u,f)}return e}processValue(e){throw new Error(`${this.constructor.name} doesn't have a 'processValue' method defined`)}getData(e){let{covers:n,visibilities:o,i18n:i}=super.getData(e),s=this.currentData,c=this.getSavedData(!1),a=this.property,l=this.selected,u=w(this.token);u=u.map(({id:f,name:y,actor:h})=>{let m=s[f]??{},b=c[f]??{};return{id:f,name:y,alliance:h.alliance,selected:l.includes(f),...P.createPropertyData(b,m,a)}});let d=I("validation");return d==="selected"?u=u.filter(f=>f.selected):d==="changed"&&(u=u.filter(f=>f.changed)),{...this._spliIntoAlliances(u),i18n:i,property:a,options:a==="cover"?n:o,showSelected:l.length!==u.length&&d==="all",showChanges:d!=="changed"}}activateListeners(e){super.activateListeners(e),e.find("[data-action=cancel]").on("click",n=>{this.close()})}};r(Ae,"ValidationMenu");var oe=class extends Ae{#e;constructor(e,n={}){super(e,n),this.#e=e.value}get property(){return"cover"}processValue(){return this.#e}};r(oe,"CoverValidationMenu");var ce=class extends Ae{#e;constructor(e,n={}){super(e,n),this.#e=e.roll}get property(){return"visibility"}get roll(){return this.#e}};r(ce,"VisibilityValidationMenu");var ie=class extends ce{processValue({token:e,value:n}){let o=this.roll,i=e.actor.perception.dc.value,s=k[n],c=new D(o,i).value;return c>=D.SUCCESS&&s<k.hidden?"hidden":c<=D.FAILURE&&s>=k.hidden?"observed":n}};r(ie,"HideValidationMenu");var xe=class extends ce{get selected(){return w(this.token).map(e=>e.id)}processValue({token:e,value:n}){return k[n]>=k.hidden?"observed":n}};r(xe,"UnHideValidationMenu");var Ie=class extends ce{#e;constructor(e,n={}){super(e,n),this.#e=e.originator}get selected(){let e=this.token,n=e.actor.alliance,o=this.#e.id,i=O(e)??{};return w(e).filter(s=>{if(s.id===o||s.actor.alliance===n)return!1;let c=getProperty(i,`${s.id}.visibility`);return k[c]>=k.undetected}).map(s=>s.id)}processValue({token:e,value:n}){return k[n]>=k.undetected?"hidden":n}};r(Ie,"PointOutValidationMenu");var We=class extends ce{getSavedData(e=!0){let n=this.token.id,o=w(this.token),i={};for(let s of o){let c=O(s,n);c&&(i[s.id]=deepClone(c))}return e?this._convertData(i):i}getData(){let e=super.getData();return e.isReversed=!0,e.options=Z.map(n=>({value:n,label:p(`visibility.reversed.${n}`)})),e}_saveData(e){let n=this.scene,o=this.token.id,i=[];for(let[s,c]of Object.entries(e)){let a={_id:s},l=n.tokens.get(s);if(l){c.visibility===R.visibility&&delete c.visibility;let u=O(l,o);if(u?.visibility===c.visibility)continue;!u.cover&&!c.visibility?a[`flags.${g}.data.-=${o}`]=!0:c.visibility?a[`flags.${g}.data.${o}.visibility`]=c.visibility:a[`flags.${g}.data.${o}.-=visibility`]=!0}else a[`flags.${g}.data.-=${o}`]=!0;i.push(a)}n.updateEmbeddedDocuments("Token",i)}};r(We,"ReverseVisibilityValidationMenu");var se=class extends We{static async openMenu(e,n){await super.openMenu(e,n)&&Ee(e.token)}processValue({token:e,value:n}){let o=this.roll,i=e.actor.skills.stealth.dc.value,s=k[n],c=new D(o,i).value;return c>=D.CRITICAL_SUCCESS&&s>=k.hidden||c>=D.SUCCESS&&s===k.hidden?"observed":c>=D.SUCCESS&&s>=k.undetected?"hidden":n}};r(se,"SeekValidationMenu");function Ht(){let t=game.pf2e.actions.get("hide"),e=pe(t,2).constructor,n=pe(t.toActionVariant(),2).constructor,o=pe(t,1).constructor,i=pe(t.toActionVariant(),1).constructor;kn(e,n),yn(o,i),hn(o,i),gn(e,n)}r(Ht,"setupActions");function gn(t,e){class n extends e{async use(s={}){let c=p("action.point-out"),a=Ye(s,c);a&&mn(this,a)}}r(n,"PointOutVariant");class o extends t{constructor(){super({cost:1,name:`${g}.action.point-out`,description:`${g}.action.point-out.description`,rollOptions:["action:point-out"],slug:"point-out",traits:["auditory","manipulate","visual"]})}toActionVariant(s={}){return s.name??=this.name,new n(this,s)}}r(o,"PointOut"),game.pf2e.actions.set("point-out",new o)}r(gn,"setupPointOut");async function mn({name:t,traits:e},n){let o=game.user.targets.filter(u=>u.actor).first(),i=o?O(o,n.id,"visibility"):void 0,s=o&&k[i]<k.undetected,c;if(s){let u=o.actor.skills.stealth.dc.value;c=p("message.point-out.short-check",{check:`@Check[type:perception|dc:${u}|traits:auditory,manipulate,visual|showDC:gm]`})}else c=p("message.point-out.short");let a=await renderTemplate(G("point-out"),{description:c,name:t,traits:e.map(u=>({slug:u,tooltip:CONFIG.PF2E.traitsDescriptions[u],name:CONFIG.PF2E.actionTraits[u]}))}),l={pointOut:s?o.id:void 0};st({content:a,token:n,flags:l})}r(mn,"pointOut");function hn(t,e){class n extends e{async use(s={}){let c=game.i18n.localize("PF2E.Actions.Seek.Title"),a=Ye(s,c);if(!a)return;if(!await vn(a))return Ee(a);s.actors=[a.actor];let l=await super.use(s);if(game.user.isGM){let{selected:u}=l[0].message.getFlag("pf2e","context.pf2ePerception");u&&zt({token:a,result:l,ValidationMenu:se})}return l}}r(n,"SeekVariant");class o extends t{constructor(){super({cost:1,description:"PF2E.Actions.Seek.Description",name:"PF2E.Actions.Seek.Title",notes:[{outcome:["criticalSuccess"],text:"PF2E.Actions.Seek.Notes.criticalSuccess"},{outcome:["success"],text:"PF2E.Actions.Seek.Notes.success"}],rollOptions:["action:seek"],slug:"seek",statistic:"perception",traits:["concentrate","secret"]})}toActionVariant(s){return new n(this,s)}}r(o,"Seek"),game.pf2e.actions.set("seek",new o)}r(hn,"setupSeek");async function vn(t){let e=game.i18n.localize("PF2E.Foot"),n='<p style="margin: 0 0.3em; text-align: center;">';return n+=`${p("dialog.seek.hint")}</p><p>`,n+=Gt("create-cone","fa-thin fa-cubes",game.i18n.format("PF2E.TemplateLabel",{size:30,unit:e,shape:game.i18n.localize(CONFIG.PF2E.areaTypes.cone)})),n+=Gt("create-burst","fa-thin fa-cubes",game.i18n.format("PF2E.TemplateLabel",{size:15,unit:e,shape:game.i18n.localize(CONFIG.PF2E.areaTypes.burst)})),n+="</p>",Dialog.wait({title:`${t.name} - ${game.i18n.localize("PF2E.Actions.Seek.Title")}`,content:n,buttons:{ok:{icon:'<i class="fa-solid fa-check"></i>',label:p("dialog.seek.accept"),callback:()=>!0},no:{icon:'<i class="fa-solid fa-xmark"></i>',label:p("dialog.seek.cancel"),callback:o=>!1}},close:()=>!1,render:o=>{o.filter(".dialog-content").find("[data-action=create-cone], [data-action=create-burst]").on("click",s=>{let{action:c}=s.currentTarget.dataset;Ee(t),jt(c==="create-cone"?"cone":"burst",t)})}},{width:300,left:10})}r(vn,"seek");function yn(t,e){class n extends e{async use(s={}){let c=game.i18n.localize("PF2E.Actions.Hide.Title"),a=Ye(s,c);if(!a)return;s.actors=[a.actor];let l=await super.use(s);return game.user.isGM&&zt({token:a,result:l,ValidationMenu:ie}),l}}r(n,"HideVariant");class o extends t{constructor(){super({cost:1,description:"PF2E.Actions.Hide.Description",name:"PF2E.Actions.Hide.Title",rollOptions:["action:hide"],slug:"hide",statistic:"stealth",traits:["secret"],notes:[{outcome:["success","criticalSuccess"],text:"PF2E.Actions.Hide.Notes.success"}]})}toActionVariant(s){return new n(this,s)}}r(o,"Hide"),game.pf2e.actions.set("hide",new o)}r(yn,"setupHide");function kn(t,e){class n extends e{async use(s={}){let c=p("action.take-cover"),a=Ye(s,c);a&&bn(a)}}r(n,"TakeCoverVariant");class o extends t{constructor(){super({cost:1,description:"PF2E.Actions.TakeCover.Description",img:"systems/pf2e/icons/conditions-2/status_acup.webp",name:"PF2E.Actions.TakeCover.Title",slug:"take-cover"})}toActionVariant(s){return new n(this,s)}}r(o,"TakeCover"),game.pf2e.actions.set("take-cover",new o)}r(kn,"setupCover");async function bn(t){let e=t.actor,n=Y(e),o=z(t,game.user.targets.ids);if(n&&!o.length)return n.delete();let i=O(t)??{},s=Object.entries(i).reduce((l,[u,{cover:d}])=>(d&&(l[u]=d),l),{}),c=await renderTemplate(G("covers-dialog"),{i18n:p,hasTargets:!!o.length,hasCovers:!isEmpty(s),hasTargetCover:o.some(l=>l in s),isProne:N(e)}),a=new Dialog({title:`${t.name} - ${p("action.take-cover")}`,content:c,buttons:{},render:l=>{l.find("button").on("click",async u=>{let{level:d}=u.currentTarget.dataset,f=I("skip-cover"),y=r(async(h,m)=>{m=m?o:void 0;let b=h===R.cover?m?"remove":"remove-all":"take",A=await st({content:p(`message.cover.${b}`,{cover:p(`cover.${h}`)}),flags:{selected:m,cover:h,skipWait:f},token:t});if(f){if(h===R.cover&&!m)return xt(t);let v=deepClone(O(t))??{};for(let C of o)setProperty(v,`${C}.cover`,h);return _e(t,v)}else game.user.isGM&&oe.openMenu({token:t,selected:m,value:h,message:A})},"process");if(d==="remove-all")y(R.cover);else if(d==="remove")y(R.cover,!0);else if(o.length)y(d,!0);else{let h=fe(d);e.createEmbeddedDocuments("Item",[h])}a.close()})}}).render(!0)}r(bn,"takeCover");function Ye(t,e){let n=t.tokens?.filter(s=>s.actor)??[];Array.isArray(n)||(n=[n]);let o=t.actors??[];if(Array.isArray(o)||(o=[o]),!n.length&&o.length===1&&(n=[ne(o[0])].filter(Boolean)),n.length||(n=canvas.tokens.controlled.filter(s=>s.actor)),n.length||(n=[ne(game.user.character)].filter(Boolean)),n.length>1){ui.notifications.warn(p("action.only-one",{action:e}));return}else if(!n.length){ui.notifications.warn(p("action.must-one",{action:e}));return}let i=n[0];if(!i?.actor?.isOfType("creature")){ui.notifications.warn(p("action.must-creature",{action:e}));return}return i}r(Ye,"getSelectedToken");function Gt(t,e,n){return`<button type="button" data-action="${t}" style="margin: 0 0 5px; padding: 0;">
    <i class="${e}"></i> ${n}</button>
</button>`}r(Gt,"createButton");function zt({token:t,result:e,ValidationMenu:n}){let o=e[0].roll,i=e[0].message,{selected:s}=i.getFlag("pf2e","context.pf2ePerception");n.openMenu({token:t,roll:o,selected:s,message:i})}r(zt,"openVisibilityValidationMenu");async function Wt(t,...e){let n=e[1];if(!n)return t(...e);Array.isArray(n.options)&&(n.options=new Set(n.options));let{actor:o,createMessage:i="true",type:s,token:c,target:a,isReroll:l}=n,u=c??ne(o),d=a?.token,f=de.includes(s),y=I("flat-check");if(l||!i||!u||!dt.includes(s)||f&&(!d||y==="none"))return t(...e);if(f&&d.actor){let h=J(n.options),m=Ce(ge(d,u),h,"visibility");if(!m)return t(...e);if(m==="concealed"&&u.actor?.hasLowLightVision)return t(...e);if(m==="hidden"&&u.actor?.hasDarkvision)return t(...e);let b=be(h,m==="concealed"?"concealed":"hidden","dc")?.[0];if(b==0)return t(...e);let A=b??(m==="concealed"?5:11),v=await new Roll("1d20").evaluate({async:!0}),C=v.total,E=C>=A,F=k[m]>=k.undetected,H=E?2:1,Re=`${game.i18n.localize("PF2E.FlatCheck")}:`;Re+=`<strong> ${game.i18n.localize(`PF2E.condition.${m}.name`)}</strong>`,Re+=(await game.pf2e.Check.createResultFlavor({target:a,degree:{value:H,unadjusted:H,adjustment:null,dieResult:C,rollTotal:C,dc:{value:A}}})).outerHTML;let K={flavor:Re,speaker:ChatMessage.getSpeaker({token:u instanceof Token?u.document:u})};if(F){n.options.add("secret"),n.pf2ePerception={isSuccess:E,visibility:m};let le=`${game.i18n.localize("PF2E.FlatCheck")}:`;le+=`<strong> ${game.i18n.localize("PF2E.condition.undetected.name")}</strong>`,K.flags={[g]:{blindCheck:le}}}if(await v.toMessage(K,{rollMode:F?game.user.isGM?"gmroll":"blindroll":"roll"}),y!=="roll"&&!F&&!E)return}else if(n.options.has("action:hide"))setProperty(n,"pf2ePerception.selected",game.user.targets.ids);else if(n.options.has("action:seek")){let h=Ut(u);if(h===void 0)return t(...e);let m=h??Array.from(game.user.targets),b=z(u,m).filter(A=>!A.document.hidden).map(A=>A.id);setProperty(n,"pf2ePerception.selected",b)}return t(...e)}r(Wt,"checkRoll");function Yt(t,e){let{createMessage:n="true",type:o,token:i,target:s,isReroll:c,options:a,dc:l}=t.context,u=i,d=s?.token,f=s?.actor;if(c||!n||!u||!d||!f||!de.includes(o))return;let y=Y(f),h=y?Fe(y)?.selection.level??V(y,"level"):void 0,m=t[g]?.coverOverride??h,b='<div class="roll-mode-panel">';b+=`<div class="label">${p("dice-checks.cover.label")}</div>`,b+=`<select name="overrideCover"><option value="">${p("dice-checks.cover.none")}</option>`,(N(f)?B.slice(1):B.slice(1,-1)).forEach(v=>{let C=v===m?"selected":"",E=p(`cover.${v}`);b+=`<option value="${v}" ${C}>${E}</option>`}),b+="</select></div>",b+="<hr>",e.find(".roll-mode-panel").before(b),e.find("select[name=overrideCover]").on("change",v=>{let C=v.currentTarget.value||void 0;setProperty(t,`${g}.coverOverride`,C),m=C}),e.find("button.roll")[0].addEventListener("click",v=>{v.preventDefault(),v.stopPropagation(),v.stopImmediatePropagation();let C=!1,E=deepClone(f._source.items);if(m!==h){C=!0;let F=E.findIndex(H=>getProperty(H,"flags.core.sourceId")===ue);if(F!==-1&&E.splice(F,1),m){let H=fe(m);E.push(H)}}if(C&&(s.actor=f.clone({items:E},{keepId:!0}),l?.slug)){let F=s.actor.getStatistic(l.slug)?.dc;F&&(l.value=F.value,l.statistic=F)}t.resolve(!0),t.isResolved=!0,t.close()},!0),t.setPosition()}r(Yt,"renderCheckModifiersDialog");function qt(t,e,n){return t(e,n)?!rt(n)||!ae(n,"basicSight")&&!Cn(n):!1}r(qt,"basicSightCanDetect");function Kt(t,e,n){return t(e,n)?game.settings.get("pf2e","automation.rulesBasedVision")?!e.object.actor?.hasCondition("deafened")&&rt(n)&&!ae(n,"hearing"):!0:!1}r(Kt,"hearingCanDetect");function Xt(t,e,n){return t(e,n)?rt(n)&&!ae(n,"feelTremor"):!1}r(Xt,"feelTremorCanDetect");function rt(t){return!!(t instanceof Token&&t.actor)}r(rt,"isValidTarget");function Zt(t,e,n){for(let o of e){let i=O(t,o.id,"visibility");if(k[i]>=n)return!0}return!1}r(Zt,"reachesThreshold");function ae(t,e,n=!1){let i=(game.user.isGM?canvas.tokens.controlled:t.scene.tokens.filter(s=>s.isOwner)).filter(s=>s.detectionModes.some(c=>c.id===e));return Zt(t,i,n?k.unnoticed:k.undetected)}r(ae,"isUndetected");function Cn(t){let e=canvas.tokens.controlled;return!game.user.isGM&&!e.length&&(e=t.scene.tokens.filter(n=>n.isOwner),e.length!==1)?!1:Zt(t,e,k.hidden)}r(Cn,"isHidden");function Jt(t,e){I("target")&&Sn(e),Tn(e)}r(Jt,"renderCombatTracker");function Tn(t){if(!canvas.ready)return;let e=game.combats.viewed?.combatants;e?.size&&t.find("#combat-tracker .combatant").each((n,o)=>{let{combatantId:i}=o.dataset,s=e.get(i??"")?.token;s&&ae(s,"basicSight",!0)&&o.remove()})}r(Tn,"hideUndetected");function Sn(t){t.find("[data-control=toggleTarget]").each((e,n)=>{n.addEventListener("click",o=>{o.preventDefault(),o.stopPropagation(),o.stopImmediatePropagation();let{combatantId:i}=o.currentTarget.closest(".combatant").dataset,c=game.combats.viewed.combatants.get(i??"")?.token;if(!c)return;let a=Array.from(game.user.targets).some(l=>l.document===c);c.object.setTarget(!a,{releaseOthers:!o.shiftKey})},!0)})}r(Sn,"setupToggleTarget");function Qt(t,e){let n=I("encounter");e.find(".form-group").last().after(`<div class="form-group">
    <label>${p("settings.encounter.name")}</label>
    <input type="checkbox" name="pf2e-perception.encounter" ${n?"checked":""}>
    <p class="notes">${p("settings.encounter.short")}</p>
</div>`),e.find('input[name="pf2e-perception.encounter"]').on("change",o=>{let i=o.currentTarget.checked;we("encounter",i)})}r(Qt,"renderCombatTrackerConfig");var xn=["cover","concealed","hidden","undetected","unnoticed"],De=class extends FormApplication{static get defaultOptions(){return foundry.utils.mergeObject(super.defaultOptions,{template:G("icon-path-menu"),title:p("settings.icon-path.name"),width:500})}getData(){let e=I("icon-path");return{icons:xn.map(o=>({name:o,placeholder:$e[o],value:e[o]??"",label:o==="cover"?p("icon-path.cover"):game.i18n.localize(CONFIG.PF2E.conditionTypes[o])})),i18n:p}}activateListeners(e){super.activateListeners(e),e.find("button[name=cancel]").on("click",n=>{n.prefentDefault(),this.close()})}async _updateObject(e,n){we("icon-path",n)}};r(De,"IconPathMenu");function en(){L("icon-path",Object,{},{config:!1}),game.settings.registerMenu(g,"icon-path-menu",{name:S("icon-path","name"),label:S("icon-path","label"),icon:"fa-solid fa-list",restricted:!0,type:De}),L("permission",String,CONST.USER_ROLES.GAMEMASTER,{choices:{1:S("permission","choices.1"),2:S("permission","choices.2"),3:S("permission","choices.3"),4:S("permission","choices.4")}}),L("npc-vision",Boolean,!1),L("target",Boolean,!0,{onChange:()=>ui.combat?.render()}),L("lesser",String,"ten",{choices:{none:S("lesser","choices.none"),cross:S("lesser","choices.cross"),zero:S("lesser","choices.zero"),ten:S("lesser","choices.ten"),twenty:S("lesser","choices.twenty")}}),L("standard",Boolean,!0),L("standard-type",String,"center",{choices:{center:S("standard-type","choices.center"),points:S("standard-type","choices.points")}}),L("skip-cover",Boolean,!0),L("validation",String,"all",{choices:{all:S("validation","choices.all"),selected:S("validation","choices.selected"),changed:S("validation","choices.changed")}}),L("exposure",Boolean,!0),L("flat-check",String,"cancel",{choices:{none:S("flat-check","choices.none"),roll:S("flat-check","choices.roll"),cancel:S("flat-check","choices.cancel")}}),L("encounter",Boolean,!1)}r(en,"registerSettings");function S(t,e){return`${g}.settings.${t}.${e}`}r(S,"path");function L(t,e,n,o={}){game.settings.register(g,t,{name:S(t,"name"),hint:S(t,"hint"),scope:"world",config:!0,type:e,default:n,...o})}r(L,"register");var In="game.pf2e.Check.roll",On="CONFIG.Token.documentClass.prototype.rulesBasedVision",En="CONFIG.Actor.documentClass.prototype.getRollContext",An="CONFIG.PF2E.Actor.documentClasses.npc.prototype.visionLevel",Dn="CONFIG.Canvas.detectionModes.basicSight._canDetect",Rn="CONFIG.Canvas.detectionModes.hearing._canDetect",$n="CONFIG.Canvas.detectionModes.feelTremor._canDetect";Hooks.once("init",()=>{en(),Ht(),libWrapper.register(g,In,Wt),libWrapper.register(g,On,Dt,"OVERRIDE"),libWrapper.register(g,En,$t,"OVERRIDE"),libWrapper.register(g,An,wt,"OVERRIDE"),libWrapper.register(g,Dn,qt),libWrapper.register(g,Rn,Kt),libWrapper.register(g,$n,Xt),game.data.users.find(e=>e._id===game.data.userId).role>=CONST.USER_ROLES.GAMEMASTER?(Hooks.on("renderSceneConfig",kt),Hooks.on("renderCombatTrackerConfig",Qt)):Hooks.on("renderCombatTracker",Jt)});Hooks.once("ready",()=>{game.modules.get(g).api={geometry:{clearDebug:ee,lineIntersectWall:Se,pointToTokenIntersectWall:Pe},token:{getCreatureCover:Qe,getVisibility:ge,clearConditionals:me,showConditionals:et,showAllConditionals:je,hasStandardCover:Je,getTokenData:O},lighting:{getLightExposure:Ne},actor:{getActorToken:ne,isProne:N,getCoverEffect:Y,getConditionalCover:Ue},scene:{getValidTokens:w,validateTokens:z,getSceneSetting:W},detection:{isUndetected:ae}},Hooks.on("renderChatMessage",it);for(let t of document.querySelectorAll("#chat-log .chat-message")){let e=game.messages.get(t.dataset.messageId);e&&it(e,$(t))}game.user.isGM&&game.modules.get("pf2e-rules-based-npc-vision")?.active&&ui.notifications.error(`${g}.warning.npc-vision`,{permanent:!0,localize:!0})});Hooks.on("hoverToken",Ot);Hooks.on("pasteToken",St);Hooks.on("updateToken",It);Hooks.on("deleteToken",Et);Hooks.on("controlToken",At);Hooks.on("renderTokenHUD",Tt);Hooks.on("preCreateToken",Rt);Hooks.on("canvasPan",()=>me());Hooks.on("renderCheckModifiersDialog",Yt);})();
//# sourceMappingURL=main.js.map
