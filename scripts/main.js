(()=>{var Rt=Object.defineProperty;var Fn=(t,e,n)=>e in t?Rt(t,e,{enumerable:!0,configurable:!0,writable:!0,value:n}):t[e]=n;var a=(t,e)=>Rt(t,"name",{value:e,configurable:!0});var Se=(t,e,n)=>(Fn(t,typeof e!="symbol"?e+"":e,n),n),Nn=(t,e,n)=>{if(!e.has(t))throw TypeError("Cannot "+n)};var be=(t,e,n)=>{if(e.has(t))throw TypeError("Cannot add the same private member more than once");e instanceof WeakSet?e.add(t):e.set(t,n)};var H=(t,e,n)=>(Nn(t,e,"access private method"),n);var pe="Compendium.pf2e.other-effects.Item.I9lfZUiCwMiGogVi",P={[void 0]:0,observed:0,concealed:1,hidden:2,undetected:3,unnoticed:4},re=["observed","concealed","hidden","undetected","unnoticed"],B=["none","lesser","standard","greater","greater-prone"],N={[void 0]:0,none:0,lesser:1,standard:2,greater:3,"greater-prone":4},M={cover:"none",visibility:"observed"},me=["attack-roll","spell-attack-roll"],xt=[...me,"skill-check","perception-check"],Le={cover:"modules/pf2e-perception/images/cover.webp",concealed:"systems/pf2e/icons/conditions/concealed.webp",hidden:"systems/pf2e/icons/conditions/hidden.webp",undetected:"systems/pf2e/icons/conditions/undetected.webp",unnoticed:"systems/pf2e/icons/conditions/unnoticed.webp"},Te={BLINDED:0,NORMAL:1,LOWLIGHT:2,DARKVISION:3},lt="#000000",ut="#656665",Ft="#809e71",Nt=["darkness","dance-of-darkness","ravenous-darkness"],Ct=["obscuring-mist","stinking-cloud","noxious-vapors"];var y="pf2e-perception";function Q(t){return`modules/${y}/templates/${t}.hbs`}a(Q,"templatePath");function h(...t){let e=t.at(-1),n=typeof e=="object",i=n?t.slice(0,-1):t;return i.unshift(y),game.i18n[n?"format":"localize"](i.join("."),e)}a(h,"localize");function D(t,e){return t.getFlag(y,e)}a(D,"getFlag");function dt(t,e,n){return t.setFlag(y,e,n)}a(dt,"setFlag");function It(t,e){return t.unsetFlag(y,e,!0)}a(It,"unsetFlag");function Ot(t){return getProperty(t,`flags.${y}`)??{}}a(Ot,"getFlags");function O(t){return game.settings.get(y,t)}a(O,"getSetting");function _e(t,e){return game.settings.set(y,t,e)}a(_e,"setSetting");function Wt(){return game.user.role>=O("permission")}a(Wt,"hasPermission");function At(t){let n=game.pf2e.ConditionManager.getCondition("off-guard").toObject();return n.name+=` (${game.i18n.localize(`PF2E.condition.${t}.name`)})`,n}a(At,"createFlatFootedSource");function ge(t,e){return e??=N[t]===3?4:N[t],{_id:"I9lfZUiCwMiGogVi",img:"systems/pf2e/icons/conditions-2/status_acup.webp",name:h("cover",t),system:{description:{gm:"",value:"<p>When you're behind an obstacle that could block weapons, guard you against explosions, and make you harder to detect, you're behind cover. Standard cover gives you a +2 circumstance bonus to AC, to Reflex saves against area effects, and to Stealth checks to Hide, Sneak, or otherwise avoid detection. You can increase this to greater cover using the Take Cover basic action, increasing the circumstance bonus to +4. If cover is especially light, typically when it's provided by a creature, you have lesser cover, which grants a +1 circumstance bonus to AC. A creature with standard cover or greater cover can attempt to use Stealth to Hide, but lesser cover isn't sufficient.</p>"},rules:[{domain:"all",key:"RollOption",option:`self:cover-bonus:${e}`},{domain:"all",key:"RollOption",option:`self:cover-level:${t}`},{key:"FlatModifier",predicate:[{or:[{and:["self:condition:prone","item:ranged"]},{not:"self:cover-level:greater-prone"}]}],selector:"ac",type:"circumstance",value:e},{key:"FlatModifier",predicate:["area-effect",{not:"self:cover-level:greater-prone"}],selector:"reflex",type:"circumstance",value:e},{key:"FlatModifier",predicate:[{or:["action:hide","action:sneak","avoid-detection"]},{not:"self:cover-level:greater-prone"}],selector:"stealth",type:"circumstance",value:e},{key:"FlatModifier",predicate:["action:avoid-notice",{not:"self:cover-level:greater-prone"}],selector:"initiative",type:"circumstance",value:e}],slug:"effect-cover"},type:"effect",flags:{core:{sourceId:pe},[y]:{level:t,bonus:e}}}}a(ge,"createCoverSource");function Me(t,e=void 0){if(t)return t.system.rules.find(n=>n.key==="ChoiceSet"&&(!e||n.flag===e))}a(Me,"findChoiceSetRule");function Re(t,e=!1){if(!t)return;let n=t.id,i=t.isToken;return(e?game.user.targets:canvas.tokens.controlled).find(o=>i?o.actor===t:o.actor.id===n)??t.getActiveTokens().shift()??null}a(Re,"getActorToken");function Z(t){return t.itemTypes.condition.some(e=>e.slug==="prone")}a(Z,"isProne");function ee(t,e=!1){let n=t.itemTypes.effect.find(i=>i.sourceId===pe);return e?Me(n)?.selection.level:n}a(ee,"getCoverEffect");function Dt(){let t=this.system.traits.senses.value,e=$t(t),n=this.rules.filter(i=>i.key==="Sense").map(i=>i.selector.toLowerCase());return e.push(...n),this.getCondition("blinded")?Te.BLINDED:e.includes("darkvision")||e.includes("greaterdarkvision")?Te.DARKVISION:e.includes("lowlightvision")?Te.LOWLIGHT:Te.NORMAL}a(Dt,"visionLevel");function wt(t,e){if(!t||!e||!t.system.traits?.senses)return!1;e=e.toLowerCase();let n=t.system.traits.senses;return Array.isArray(n)?n=n.map(i=>i.type.toLowerCase()):n=$t(n.value),n.includes(e)}a(wt,"hasSense");function Ve(t){return wt(t,"greaterdarkvision")}a(Ve,"hasGreaterDarkvision");function ze(t){return wt(t,"seeinvisibility")}a(ze,"seeInvisibility");function $t(t){return t.toLowerCase().replaceAll(/[ -]/g,"").split(",")}a($t,"splitNPCSenses");var je={LOWER_BY_TWO:-2,LOWER:-1,INCREASE:1,INCREASE_BY_TWO:2,TO_CRITICAL_FAILURE:"criticalFailure",TO_FAILURE:"failure",TO_SUCCESS:"success",TO_CRITICAL_SUCCESS:"criticalSuccess"},Lt=["criticalFailure","failure","success","criticalSuccess"],Ue,_t,fe,Ge,ae,xe,Be,Mt,te=class{constructor(e,n,i=null){be(this,Ue);be(this,fe);be(this,ae);be(this,Be);e instanceof Roll?(this.dieResult=(e.isDeterministic?e.terms.find(r=>r instanceof NumericTerm):e.dice.find(r=>r instanceof Die&&r.faces===20))?.total??1,this.rollTotal=e.total):(this.dieResult=e.dieValue,this.rollTotal=e.dieValue+e.modifier),this.dc=typeof n=="number"?{value:n}:n,this.unadjusted=H(this,Be,Mt).call(this),this.adjustment=H(this,Ue,_t).call(this,this.unadjusted,i),this.value=this.adjustment?H(this,fe,Ge).call(this,this.adjustment.amount,this.unadjusted):this.unadjusted}},_=te;a(_,"DegreeOfSuccess"),Ue=new WeakSet,_t=a(function(e,n){if(!n)return null;for(let i of["all",...Lt]){let{label:r,amount:o}=n[i]??{};if(o&&r&&!(e===te.CRITICAL_SUCCESS&&o===je.INCREASE)&&!(e===te.CRITICAL_FAILURE&&o===je.LOWER)&&(i==="all"||Lt.indexOf(i)===e))return{label:r,amount:o}}return null},"#getDegreeAdjustment"),fe=new WeakSet,Ge=a(function(e,n){switch(e){case"criticalFailure":return 0;case"failure":return 1;case"success":return 2;case"criticalSuccess":return 3;default:return Math.clamped(n+e,0,3)}},"#adjustDegreeOfSuccess"),ae=new WeakSet,xe=a(function(e){return this.dieResult===20?H(this,fe,Ge).call(this,je.INCREASE,e):this.dieResult===1?H(this,fe,Ge).call(this,je.LOWER,e):e},"#adjustDegreeByDieValue"),Be=new WeakSet,Mt=a(function(){let e=this.dc.value;return this.rollTotal-e>=10?H(this,ae,xe).call(this,te.CRITICAL_SUCCESS):e-this.rollTotal>=10?H(this,ae,xe).call(this,te.CRITICAL_FAILURE):this.rollTotal>=e?H(this,ae,xe).call(this,te.SUCCESS):H(this,ae,xe).call(this,te.FAILURE)},"#calculateDegreeOfSuccess"),Se(_,"CRITICAL_FAILURE",0),Se(_,"FAILURE",1),Se(_,"SUCCESS",2),Se(_,"CRITICAL_SUCCESS",3);function Vt(t,e){let n="",i=["standard","npc-vision"];for(let o of i){let s=ye(t.object,o);n+=`<div class="form-group pf2e-perception-injected">
    <label>${h(`settings.${o}.name`)}</label>
    <input type="checkbox" name="flags.pf2e-perception.${o}" ${s?"checked":""}>
    <p class="notes">${h(`settings.${o}.short`)}</p>
</div>`}n+="<hr>",e.find('.tab[data-tab="basic"] hr').first().after(n);let r=e.find(".pf2e-perception-injected").toArray().reduce((o,s)=>(o+=s.clientHeight,o),0);t.setPosition({top:t.position.top-r/2})}a(Vt,"renderSceneConfig");function V(t){if(t=t instanceof Token?t.document:t,!(t instanceof TokenDocument))return[];let e=t.scene.tokens.filter(n=>n!==t&&n.actor?.isOfType("creature"));if(O("encounter")){let n=game.combats.active;return n?e.filter(i=>{let r=i.actor,o=r.traits;return r.type==="familiar"||o.has("minion")||o.has("eidolon")||n.getCombatantByToken(i.id)}):e}return e}a(V,"getValidTokens");function ne(t,e){let n=V(t).map(i=>i.id);return e.filter(i=>{let r=i instanceof Token||i instanceof TokenDocument?i.id:i;return n.includes(r)})}a(ne,"validateTokens");function ye(t,e){return D(t,e)??O(e)}a(ye,"getSceneSetting");function Cn(t,e){return canvas.dimensions?canvas.grid.type!==CONST.GRID_TYPES.SQUARE?canvas.grid.measureDistance(t,e):In(new Ray(t,e)):NaN}a(Cn,"measureDistance");function In(t,{reach:e=null}={}){if(!canvas.dimensions)return NaN;let n=canvas.dimensions.size,i=canvas.dimensions.distance,r=Math.ceil(Math.abs(t.dx/n)),o=Math.ceil(Math.abs(t.dy/n)),s=Math.ceil(Math.abs((t.dz||0)/n)),c=[r,o,s].sort((p,g)=>p-g),l={doubleDiagonal:c[0],diagonal:c[1]-c[0],straight:c[2]-c[1]},u=l.diagonal+l.doubleDiagonal>1&&e===10?1:0;return(Math.floor(l.doubleDiagonal*1.75+l.diagonal*1.5+l.straight)-u)*i}a(In,"measureDistanceOnGrid");function zt({areaType:t,object:e,colors:n,document:i,collisionType:r="move",preview:o=!1,collisionOrigin:s}){if(!e.id&&!o)return;let{grid:c,dimensions:l}=canvas;if(!(c&&l))return;let u=i.angle??0,d=i.direction??45,p=c.getHighlightLayer(e.highlightId)?.clear();if(!p)return;let[g,f]=c.getCenter(i.x,i.y),[m,S]=c.grid.getGridPositionFromPixels(g,f),x=(360+(d-u*.5)%360)%360,b=(360+(d+u*.5)%360)%360,k=canvas.grid.getSnappedPosition(i.x,i.y,e.layer.gridPrecision),C=a((A,v,T)=>(A=(360+A%360)%360,v=(360+v%360)%360,T=(360+T%360)%360,A<v?T>=A&&T<=v:T>=A||T<=v),"withinAngle"),R=(()=>{if(t!=="cone")return{x:0,y:0};let A=(d>=0?360-d:-d)%360,v=k.x%l.size!==0?Math.sign(1*Math.round(Math.cos(Math.toRadians(A))*100)/100)/2:0,T=k.y%l.size!==0?-Math.sign(1*Math.round(Math.sin(Math.toRadians(A))*100)/100)/2:0;return{x:v*l.size,y:T*l.size}})(),I=Math.clamped(i.width??0,1.5,2),E=i.distance??0,F=E*I/l.distance,U=Math.ceil(F/(l.size/c.h)),de=Math.ceil(F/(l.size/c.w)),st=a(A=>{if(!(t==="emanation"&&e instanceof Token))return{x:0,y:0};if(e.w<=l.size)return{x:0,y:0};let v=(e.w-l.size)/2,T=a((w,j)=>j===w?0:j>w?v:-v,"getCoordinate");return{x:T(e.center.x,A.x),y:T(e.center.y,A.y)}},"offsetEmanationOrigin");for(let A=-de;A<de;A++)for(let v=-U;v<U;v++){let[T,w]=canvas.grid.grid.getPixelsFromGridPosition(m+A,S+v),j={x:T+l.size*.5,y:w+l.size*.5};if(j.x<0||j.y<0)continue;let q=st(j),ct={x:k.x+R.x+q.x,y:k.y+R.y+q.y};if(t==="cone"){let Tt=new Ray(ct,j),xn=(360+Tt.angle/(Math.PI/180)%360)%360;if(Tt.distance>0&&!C(x,b,xn))continue}if(Cn(j,ct)>E)continue;canvas.ready&&CONFIG.Canvas.polygonBackends[r].testCollision(s??ct,j,{type:r,mode:"any"})?(c.grid.highlightGridPosition(p,{x:T,y:w,border:1,color:0}),p.beginFill(0,.5).moveTo(T,w).lineTo(T+l.size,w+l.size).endFill()):c.grid.highlightGridPosition(p,{x:T,y:w,border:n.border,color:n.fill})}}a(zt,"highlightGrid");var On={burst:"circle",emanation:"circle",line:"ray",cone:"cone",rect:"rect"};function He({type:t="burst",token:e,distance:n}){pt(e)&&(n??=t==="cone"?30:15,mt({type:t,distance:n,traits:["concentrate","secret"],flags:{type:"seek",tokenId:e.id,collisionType:"sight",collisionOrigin:e.center}}))}a(He,"createSeekTemplate");function jt({type:t="burst",distance:e=20,conceal:n=!1}={}){mt({type:t,distance:e,fillColor:lt,flags:{type:"darkness",conceal:n}})}a(jt,"createDarknessTemplate");function Gt({type:t="burst",distance:e=20}={}){mt({type:t,distance:e,fillColor:ut,flags:{type:"mist"}})}a(Gt,"createMistTemplate");function Ut(t,e){return e&&!pt(e)?null:canvas.scene.templates.filter(n=>D(n,"type")===t)??[]}a(Ut,"getTemplates");function Ke(t){return Ut("darkness",t)}a(Ke,"getDarknessTemplates");function Ye(t){return Ut("mist",t)}a(Ye,"getMistTemplates");function qe(t){if(!pt(t))return null;let e=canvas.scene.templates.find(n=>D(n,"type")==="seek");return e?(t=t instanceof Token?t.document:t,he(e,{collisionType:"sight",collisionOrigin:t.center})):null}a(qe,"getSeekTemplateTokens");async function J(t){let e=t.scene.templates.filter(n=>D(n,"type")==="seek"&&D(n,"tokenId")===t.id);for(let n of e)await n.delete()}a(J,"deleteSeekTemplate");function pt(t){return canvas.scene===t.scene?!0:(ui.notifications.error(h("template.scene")),!1)}a(pt,"checkScene");function mt({type:t,distance:e,traits:n,fillColor:i,width:r,flags:o}){let s={distance:e,t:On[t],fillColor:i||game.user.color,flags:{[y]:o}};s.t==="ray"?s.width=r||CONFIG.MeasuredTemplate.defaults.width*(canvas.dimensions?.distance??1):s.t==="cone"&&(s.angle=CONFIG.MeasuredTemplate.defaults.angle),n&&setProperty(s,"flags.pf2e.origin.traits",n);let c=new CONFIG.MeasuredTemplate.documentClass(s,{parent:canvas.scene});new CONFIG.MeasuredTemplate.objectClass(c).drawPreview()}a(mt,"createTemplate");function he(t,{collisionOrigin:e,collisionType:n="move"}={}){if(t=t instanceof MeasuredTemplateDocument?t.object:t,!canvas.scene)return[];let{grid:i,dimensions:r}=canvas;if(!(i&&r))return[];let o=i.getHighlightLayer(t.highlightId);if(!o||i.type!==CONST.GRID_TYPES.SQUARE)return[];let s=e??t.center,c=canvas.tokens.quadtree.getObjects(o.getLocalBounds(void 0,!0)),l=[];for(let u of c){let d=u.document,p=[];for(let g=0;g<d.height;g++){let f=u.y+g*i.size;if(p.push(`${u.x}.${f}`),d.width>1)for(let m=1;m<d.width;m++)p.push(`${u.x+m*i.size}.${f}`)}for(let g of p){if(!o.positions.has(g))continue;let[f,m]=g.split(".").map(b=>Number(b)),S={x:f+r.size*.5,y:m+r.size*.5};if(S.x<0||S.y<0)continue;if(!(canvas.ready&&n&&CONFIG.Canvas.polygonBackends[n].testCollision(s,S,{type:n,mode:"any"}))){l.push(u);break}}}return l}a(he,"getTemplateTokens");function Bt(){if(!["circle","cone"].includes(this.type)||canvas.grid.type!==CONST.GRID_TYPES.SQUARE)return MeasuredTemplate.prototype.highlightGrid.call(this);if(!this.isVisible){canvas.grid.getHighlightLayer(this.highlightId)?.clear();return}let t=D(this.document,"collisionType"),e=D(this.document,"collisionOrigin");zt({areaType:this.type==="circle"?"burst":"cone",object:this,document:this.document,colors:{border:this.borderColor,fill:this.fillColor},preview:!0,collisionType:t,collisionOrigin:e})}a(Bt,"highlightTemplateGrid");function Ht(t){let{type:e,slug:n,castLevel:i=0}=t.getFlag("pf2e","origin")??{};e==="spell"&&(Nt.includes(n)?t.updateSource({fillColor:lt,[`flags.${y}`]:{type:"darkness",conceal:i>=4}}):Ct.includes(n)?t.updateSource({fillColor:ut,[`flags.${y}`]:{type:"mist"}}):n==="cloudkill"&&t.updateSource({fillColor:Ft,[`flags.${y}`]:{type:"mist"}}))}a(Ht,"preCreateMeasuredTemplate");function Qe(t){D(t,"type")==="darkness"&&canvas.perception.update({initializeVision:!0})}a(Qe,"onMeasuredTemplate");function ve(t,e=1){let n=Object.getPrototypeOf(t);return e>1?ve(n,e-1):n}a(ve,"getPrototype");function Ze(t,e){return t.name.localeCompare(e.name)}a(Ze,"sortByName");function Je(t){return t=Number(t),isNaN(t)?void 0:t}a(Je,"asNumberOnly");var K=class extends Application{#e;#r;#t;#n;#i;constructor({token:e,resolve:n,selected:i=[]},r={}){super(r),this.#e=e,this.#r=n,this.#t=i,this.#i=(o,s)=>{let c=o.id,l=this.element.find("[data-token-id]");l.removeClass("hover"),s&&l.filter(`[data-token-id=${c}]`).addClass("hover")},Hooks.on("hoverToken",this.#i)}async close(e={}){Hooks.off("hoverToken",this.#i),this.#r?.(e.resolve??!1),super.close(e)}static get defaultOptions(){return mergeObject(super.defaultOptions,{minimizable:!1})}static async openMenu(e,n={}){if(e.token instanceof TokenDocument&&(e.token=e.token.object),!e.token){ui.notifications.error(h("menu.no-token"));return}n.id=`${y}-${e.token.document.uuid}`;let i=Object.values(ui.windows).find(r=>r.id===n.id);return i&&i.close(),new Promise(r=>{e.resolve=r,new this(e,n).render(!0)})}static createPropertyData(e,n,i){let r=M[i],o=e[i]??r,s=n[i]??r;return{original:o,current:s,changed:o!==s,custom:s!==r,originalCustom:o!==r}}get token(){return this.#e}get document(){return this.#e.document}get actor(){return this.#e.actor}get scene(){return this.#e.scene}get selected(){return this.#t.length?ne(this.token,this.#t):[]}get currentData(){return deepClone(this.#o)}get#o(){return this.#n||(this.#n=this.getSavedData()),this.#n}getSavedData(){let e=L(this.document)??{};return deepClone(e)}reset(){this.#n=this.getSavedData(),this.#t=[],this.render()}isSelected(e){let n=typeof e=="object"?e.id:e;return this.#t.includes(n)}getData(e){return{i18n:h,covers:B.map(n=>({value:n,label:h(`cover.${n}`)})),visibilities:re.map(n=>({value:n,label:h(`visibility.${n}`)}))}}activateListeners(e){e.find("[data-token-id]").on("mouseenter",n=>{let{tokenId:i}=n.currentTarget.dataset,r=this.scene.tokens.get(i)?.object;!r||r.controlled||r._onHoverIn(n,{hoverOutOthers:!0})}),e.find("[data-action=close]").on("click",()=>{this.close({resolve:!0})}),e.find("select[name=visibility], select[name=cover]").on("change",n=>{let i=n.currentTarget,r=i.name,o=M[r],s=i.value||o,c=i.closest(".token")?.dataset.tokenId,l=c?[c]:this.#t;for(let u of l)setProperty(this.#o,`${u}.${r}`,s);c?(i.classList.toggle("changed",s!==i.dataset.original),i.classList.toggle("custom",s!==o)):this.render()}),e.find("[data-action=accept]").on("click",n=>{this._saveData(this.#o),this.close({resolve:!0})})}_saveData(e){Xe(this.document,e)}_setSelected(e){this.#t=e??this.element.find("[data-token-id].ui-selected").toArray().map(n=>n.dataset.tokenId)}_spliIntoAlliances(e){let n=[],i=[],r=[],o=this.actor.alliance,s=o==="party"?"opposition":o==="opposition"?"party":null;for(let c of e)if(s){let l=c.actor?c.actor.alliance:c.alliance;l===o?n.push(c):l===s?i.push(c):l===null&&r.push(c)}else r.push(c);return{allies:n.sort(Ze),neutral:r.sort(Ze),enemies:i.sort(Ze),hasTokens:n.length||i.length||r.length}}};a(K,"BaseMenu");var Fe=class extends K{get title(){return h("menu.perception.title",{name:this.token.name})}get template(){return Q("perception")}getData(e){let n=this.selected,i=this.currentData,r=this.getSavedData(),o=V(this.token).map(({id:s,name:c,actor:l})=>{let u=i[s]??{},d=r[s]??{};return{id:s,name:c,alliance:l.alliance,cover:K.createPropertyData(d,u,"cover"),visibility:K.createPropertyData(d,u,"visibility"),selected:n.includes(s)}});return{...super.getData(e),...this._spliIntoAlliances(o)}}activateListeners(e){super.activateListeners(e),e.filter(".tokens").selectable({autoRefresh:!1,filter:".token",cancel:"header,select",stop:()=>this._setSelected()}),e.find("[data-action=select-all]").on("click",n=>{let i=$(n.currentTarget).closest("section"),r=(i.length?i:e).find("[data-token-id]"),o=r.filter(":not(.ui-selected)").length===0;r.toggleClass("ui-selected",!o),this._setSelected()}),e.find("[data-action=use-selection]").on("click",n=>{this._setSelected(canvas.tokens.controlled.map(i=>i.id)),this.render()}),e.find("[data-action=reset]").on("click",n=>this.reset())}};a(Fe,"PerceptionMenu");var Wn=[{x:.25,y:.25},{x:.5,y:.25},{x:.75,y:.25},{x:.25,y:.5},{x:.5,y:.5},{x:.75,y:.5},{x:.25,y:.75},{x:.5,y:.75},{x:.75,y:.75}];function et(t,e){let n=1-e;return{top:{A:X({x:e,y:e},t),B:X({x:n,y:e},t)},right:{A:X({x:n,y:e},t),B:X({x:n,y:n},t)},bottom:{A:X({x:n,y:n},t),B:X({x:e,y:n},t)},left:{A:X({x:e,y:n},t),B:X({x:e,y:e},t)}}}a(et,"getRectEdges");function Ne(t,e,n=!1){return n&&Y(t,e),CONFIG.Canvas.polygonBackends.move.testCollision(t,e,{type:"move",mode:"any"})}a(Ne,"lineIntersectWall");function tt(t,e,n=!1){for(let i of An(e.bounds))if(Ne(t,i,n))return!0;return!1}a(tt,"pointToTokenIntersectWall");function X(t,e){return{x:e.x+e.width*t.x,y:e.y+e.height*t.y}}a(X,"getRectPoint");function se(){canvas.controls.debug.clear()}a(se,"clearDebug");function Y(t,e,n="blue"){let i=n==="blue"?26316:n==="red"?16711680:1483011;canvas.controls.debug.lineStyle(4,i).moveTo(t.x,t.y).lineTo(e.x,e.y)}a(Y,"drawDebugLine");function*An(t){for(let e of Wn)yield X(e,t)}a(An,"rectSpread");function nt(t,e=!1){if(t=t instanceof Token?t:t.object,t.document.hasStatusEffect(CONFIG.specialStatusEffects.INVISIBLE))return;let n=t.scene;if(n!==canvas.scene||!n.tokenVision||n.darkness<n.globalLightThreshold)return;e&&se();let i=t.document.center,r=null;for(let o of canvas.effects.lightSources){if(!o.active)continue;let s=o.data.bright,c=o.data.dim;if(o.object===t){if(s)return"bright";c&&(r="dim");continue}if(!o.shape.contains(i.x,i.y)){e&&Y(o,i,"red");continue}if(o.ratio===1)return e&&Y(o,i,"green"),"bright";if(o.ratio===0){e&&Y(o,i,"blue"),r="dim";continue}if(new Ray(o,i).distance<=s)if(e)Y(o,i,"green"),r="bright";else return"bright";else e?(Y(o,i,"blue"),r!=="bright"&&(r="dim")):r="dim"}return r}a(nt,"getLightExposure");var Pe={cover:{cancel:{targets:["lesser","standard","greater","greater-prone"]},set:{targets:["none","lesser","standard","greater","greater-prone"],value:["none","lesser","standard","greater","greater-prone"]},reduce:{targets:["lesser","standard","greater","greater-prone"]},ignore:{targets:"string"},ignored:{targets:["allies","enemies"]},ac:{targets:["lesser","standard","greater","greater-prone"],value:["number"]}},visibility:{cancel:{targets:["concealed","hidden","undetected","unnoticed"]},set:{targets:["observed","concealed","hidden","undetected","unnoticed"],value:["observed","concealed","hidden","undetected","unnoticed"]},reduce:{targets:["concealed","hidden","undetected","unnoticed"]},noff:{targets:["hidden","undetected","unnoticed"]},noinvis:{},dc:{targets:["concealed","hidden"],value:["number","string"]}}},Dn={cover:Object.keys(Pe.cover),visibility:Object.keys(Pe.visibility),all:[...Object.keys(Pe.cover),...Object.keys(Pe.visibility)]};function Kt(){let t=game.pf2e.RuleElements.builtin.RollOption.defineSchema(),e=t.predicate.constructor,n=t.value.constructor;class i extends game.pf2e.RuleElement{constructor(o,s){typeof o.targets=="string"&&(o.targets=[o.targets]),super({priority:CONST.ACTIVE_EFFECT_MODES.CUSTOM,...o},s);let c=Dn[o.type];if(!c)return;if(!c?.includes(o.selector)){this.failValidation(`The type "${o.type}" only accepts the following selectors: ${c.join(", ")}.`);return}let l=Pe[o.type]?.[o.selector];if(!l)return;let u=a(m=>{let{name:S,uuid:x}=this.item;console.warn(`PF2e System | PF2ePerception rules element on item ${S} (${x}) simple warning: ${m}`)},"selectorWarn"),d=Array.isArray(l.targets)?[...l.targets,"all"]:l.targets,p=Array.isArray(d)?d.join(", "):null;if(!d&&o.targets?.length){u(`The selector "${o.selector}" doesn't accept any targets property.`);return}if(o.selector==="ignore"&&!o.targets?.length){let m=`The selector "${o.selector}" requires a targets property with the ids of the tokens on the scene that should not give cover.`;this.failValidation(m);return}if(p&&o.targets?.some(m=>!d.includes(m))){let m=`The targets property of selector "${o.selector}" only accepts the following: ${p}.`;this.failValidation(m);return}else if(!p&&d&&o.targets?.some(m=>typeof m!==d)){let m=`The targets property of selector "${o.selector}" needs to be of type "${d}".`;this.failValidation(m);return}let g=l.value;if(!g&&l.value){u(`The selector "${o.selector}" doesn't accept any value property.`);return}let f=typeof o.value;if(g&&!g.includes(f)){let m=`The selector "${o.selector}" does not accept a value property of type ${f}.`;this.failValidation(m)}}static defineSchema(){let{fields:o}=foundry.data;return{...super.defineSchema(),type:new o.StringField({required:!0,nullable:!1,blank:!1,choices:["visibility","cover"]}),affects:new o.StringField({required:!0,nullable:!1,blank:!1,initial:"self",choices:["self","other"]}),selector:new o.StringField({required:!0,nullable:!1,blank:!1}),targets:new o.ArrayField(new o.StringField({required:!0,nullable:!1,blank:!1,initial:void 0}),{required:!0,nullable:!1,initial:["all"]}),predicate:new e({required:!1,nullable:!1}),value:new n({required:!1,initial:void 0})}}test(o,s){return s?super.test(o):!1}addToPerception(o,s,c){if(!this.test(c,!0))return;let u=`${this.affects==="self"?o:o==="origin"?"target":"origin"}.${this.type}.${this.selector}`,d=Pe[this.type][this.selector];if(!d.targets){setProperty(s,u,!0);return}let p=this.targets.includes("all")?d.targets:this.targets;if(!d.value){for(let g of p){let f=`${u}.${g}`;setProperty(s,f,!0)}return}for(let g of p){let f=`${u}.${g}`,m=getProperty(s,f);m?m.add(this.value):m=new Set([this.value]),setProperty(s,f,m)}}}a(i,"PF2ePerceptionRuleElement"),game.pf2e.RuleElements.custom.PF2ePerception=i}a(Kt,"setupRuleElement");function ie(t,e,{distance:n,extraOptions:i=[]}={}){let r=t.actor,o=e.actor;if(!r||!o)return{};let s={origin:r.rules.filter(p=>!p.ignored&&p.key==="PF2ePerception")??[],target:o.rules.filter(p=>!p.ignored&&p.key==="PF2ePerception")??[]};if(!s.origin.length&&!s.target.length)return{};let c={origin:r.getRollOptions(),target:o.getRollOptions()},l={origin:o.getSelfRollOptions("target"),target:r.getSelfRollOptions("origin")};t=t instanceof Token?t:t.object,e=e instanceof Token?e:e.object,n??=t.distanceTo(e);let u=[`origin:distance:${n}`,`target:distance:${n}`],d={};for(let p of["origin","target"]){let g=[...i,...c[p],...l[p],...u];for(let f of s[p])f.addToPerception(p,d,g)}return d}a(ie,"perceptionRules");function Yt(t){let e=t.actor;return e?(e.rules.filter(i=>!i.ignored&&i.key==="PF2ePerception"&&i.type==="cover"&&i.selector==="ignored")??[]).flatMap(i=>i.targets):[]}a(Yt,"getIgnoredPerception");function G(t,e,n,i,r){let o=t[e]?.[n]?.[i];return r?o?.[r]:o}a(G,"getPerception");function ke(t,e,n,i){let r=n==="cover"?B:re;if(i&&G(t,e,n,"cancel",i))return;let o=G(t,e,n,"set",i)?.first();if(o&&r.includes(o))i=o;else if(i&&G(t,e,n,"reduce",i)){let s=r.indexOf(i);i=r[Math.max(0,s-1)]}return i===r[0]?void 0:i}a(ke,"updateFromPerceptionRules");function qt(t,e){!Wt()||!t.object.actor?.isOfType("creature")||(e.find(".col.left").append('<div class="control-icon" data-action="pf2e-perception"><i class="fa-solid fa-eye"></i></div>'),e.find("[data-action=pf2e-perception]").on("click",n=>gt(t.object)))}a(qt,"renderTokenHUD");function gt(t){return Fe.openMenu({token:t})}a(gt,"openHUD");function Qt(t,e){for(let n of e)delete n.flags?.[y]}a(Qt,"pasteToken");function L(t,...e){return e.unshift("data"),t=t instanceof Token?t.document:t,D(t,e.join("."))}a(L,"getTokenData");async function Zt(t){return t=t instanceof Token?t.document:t,It(t,"data")}a(Zt,"clearTokenData");async function Xe(t,e){let n=V(t).map(r=>r.id),i={};for(let r in e){if(!n.includes(r)){i[`flags.${y}.data.-=${r}`]=!0;continue}let o=e[r],s=L(t,r)??{};if(o.visibility===M.visibility&&delete o.visibility,o.cover===M.cover&&delete o.cover,!(s.cover===o.cover&&s.visibility===o.visibility))if(!o.visibility&&!o.cover)i[`flags.${y}.data.-=${r}`]=!0;else for(let c of["cover","visibility"])s[c]!==o[c]&&(o[c]?i[`flags.${y}.data.${r}.${c}`]=o[c]:i[`flags.${y}.data.${r}.-=${c}`]=!0)}return t=t instanceof Token?t.document:t,t.update(i)}a(Xe,"setTokenData");function it(t,e,n=!1){let i=t.scene;return ye(i,"standard")?(n&&se(),(O("standard-type")==="points"?tt(t.center,e,n):Ne(t.center,e.center,n))?"standard":void 0):void 0}a(it,"getWallCover");var ce={tiny:0,sm:1,med:2,lg:3,huge:4,grg:5};function ot(t,e,{perception:n={},options:i=[],affects:r="origin",debug:o=!1}={}){let s=i.includes("item:ranged")?Z(e.actor):!1,c=a(d=>ke(n,r,"cover",d),"returnValue"),l=ee(e.actor,!0);if(s&&N[l]>N.lesser)return c("greater-prone");!s&&l==="greater-prone"&&(l=void 0);let u=L(e,t.id,"cover");if(s&&N[u]>N.lesser)return c("greater-prone");if(!s&&u==="greater-prone"&&(u=void 0),N[l]<N.standard){if(N[u]<N.standard){let d=game.modules.get(y).custom?.getWallCover,p;if(typeof d=="function"){let g=d(t,e,o);p=B.includes(g)?g:it(t,e,o)}else p=it(t,e,o);N[p]>N[u]&&(u=p)}if(N[u]<N.standard&&t.distanceTo(e)>5){let d=ft(t,e,{perception:n,debug:o});N[d]>N[u]&&(u=d)}}return s&&N[u]>N.lesser?c("greater-prone"):c(N[u]>N[l]?u:void 0)}a(ot,"getCover");function ft(t,e,{perception:n={},debug:i=!1}={}){let r=O("lesser");if(r==="none")return;t=t instanceof Token?t.document:t,e=e instanceof Token?e.document:e;let o=(()=>{let E=Object.keys(n.origin?.cover?.ignore??{}),F=Object.keys(n.target?.cover?.ignore??{});return new Set([...E,...F])})(),s,c=t.center,l=e.center,u=t.actor,d=e.actor;i&&(se(),Y(c,l));let p=a(E=>{let F=ce[E.actor.size];return F-g>=2&&F-f>=2},"isExtraLarge"),g=ce[u.size],f=ce[d.size],m=u.alliance,S=O("dead-cover"),x=O("prone-cover"),b=t.scene.tokens.contents.filter(E=>{let F=E.actor,U=Yt(E);return F&&!E.hidden&&E!==t&&E!==e&&(x||!Z(F))&&(S||F.hitPoints?.value!==0)&&!o.has(E.id)&&!(U.includes("all")||U.includes(F.alliance===m?"allies":"enemies"))}).sort((E,F)=>ce[F.actor.size]-ce[E.actor.size]),k=g<ce.huge&&f<ce.huge&&b.filter(p).length,C=r==="ten"?.1:r==="twenty"?.2:0,R=a(E=>(i&&Y(E.A,E.B,"red"),lineSegmentIntersects(c,l,E.A,E.B)),"intersectsEdge"),I=r==="cross"?E=>R(E.top)&&R(E.bottom)||R(E.left)&&R(E.right):E=>Object.values(E).some(F=>R(F));for(let E of b){let F=E.object,U=et(F.bounds,C);if(I(U))return k?"standard":"lesser";p(E)&&k--}return s}a(ft,"getCreatureCover");function oe(t,e,{perception:n={},affects:i="origin",debug:r=!1}={}){t=t instanceof Token?t:t.object,e=e instanceof Token?e:e.object;let o=t.actor,s=e.actor,c=(()=>{if(!o||!s)return;let k;s.hasCondition("blinded")?k="hidden":s.hasCondition("dazzled")&&(k="concealed");for(let C of["unnoticed","undetected","hidden","concealed"])P[C]>P[k]&&o.hasCondition(C)&&(k=C);return k})(),l=a(k=>u?(P[k]<P.hidden&&(k="hidden"),(ze(s)||G(n,i,"visibility","noinvis"))&&(k="concealed"),ke(n,i,"visibility",k)):ke(n,i,"visibility",k),"returnValue"),u=o?.hasCondition("invisible"),d=L(t,e.id,"visibility"),p=P[c]>P[d]?c:d;if(P[p]>=P.hidden||u)return l(p);let g=s?.hasLowLightVision,f=s?.hasDarkvision,m=s&&Ve(s);if(m&&p==="concealed")return l(p);let S;if(!m){let k=Ke(t);if(k?.length){let C;for(let R of k){let I=he(R);if(!I.length)continue;if(I.includes(t)||I.includes(e))S=!0;else continue;if(!f)return l("hidden");D(R,"conceal")&&(C="concealed")}if(C==="concealed"&&(p="concealed"),S&&p==="concealed")return l(p)}}if(p!=="concealed"){let k=Ye(t);if(k?.length)for(let C of k){let R=he(C);if(!R.length)continue;if(R.includes(t)||R.includes(e))return l("concealed")}}if(S||m)return l(p);let x=nt(t,r),b=x==="dim"?"concealed":x===null?"hidden":void 0;return(b==="concealed"&&g||b==="hidden"&&f)&&(b=void 0),P[b]>P[p]&&(p=b),l(p)}a(oe,"getVisibility");function Jt(t,e,n,i){let r=e.flags?.["pf2e-perception"];if(r&&(r.data||r["-=data"]!==void 0)){if(t.object.renderFlags.set({refreshVisibility:!0}),game.user.isGM)return;let o=Hooks.on("refreshToken",s=>{!t.object!==s&&(Hooks.off("refreshToken",o),game.combat?.getCombatantByToken(t.id)&&ui.combat.render())})}}a(Jt,"updateToken");function Xt(t,e){e?rt(t):le(t)}a(Xt,"hoverToken");function en(t){le(t),game.user.isGM||ui.combat.render()}a(en,"deleteToken");function tn(t,e){e&&(le(),Hooks.once("sightRefresh",()=>t.hover&&rt(t)))}a(tn,"controlToken");function le(t){if(!t?.id)return $(".pf2e-conditionals").remove();$(`.pf2e-conditionals[data-hover-id=${t.id}]`).remove(),$(`.pf2e-conditionals[data-token-id=${t.id}]`).remove()}a(le,"clearConditionals");function rt(t){let e=V(t);for(let n of e)yt(n,t)}a(rt,"showAllConditionals");async function yt(t,e){if(t=t instanceof Token?t:t.object,!t.visible||!t.actor?.isOfType("creature"))return;let n=L(t,e.id);if(isEmpty(n))return;if(!game.user.isGM&&!e.document.hasPlayerOwner&&P[n.visibility]>=P.hidden){if(!n.cover)return;n={cover:n.cover}}let i=t.worldTransform.a,r=canvas.clientCoordinatesFromCanvas(t.document._source),o=`<div class="pf2e-conditionals" data-hover-id="${t.id}" data-token-id="${e.id}" `;o+=`style="top: ${r.y}px; left: ${r.x+t.hitArea.width*i/2}px;">`;let s=O("icon-path");Object.entries(n).map(([c,l])=>{let u=c==="cover"?"cover":l,d=s[u]||Le[u];(d.startsWith("systems")||d.startsWith("modules"))&&(d=`../../../${d}`),o+=`<div class="conditional"><img src="${d}"></img></div>`}),o+="</div>",$(document.body).append(o)}a(yt,"showConditionals");function nn(){return!!(this.sight.enabled&&this.actor?.isOfType("creature")&&this.scene?.rulesBasedVision)}a(nn,"rulesBasedVision");function on(t){let e=t.actor;if(e?.isOfType("creature")&&(e.isOfType("npc")&&ye(t.scene,"npc-vision")&&t.updateSource({"sight.enabled":!0}),game.user.isGM&&t.hidden)){let n=game.user.targets,i={};for(let r of n)i[r.id]={visibility:"unnoticed"};n.size&&t.updateSource({[`flags.${y}.data`]:i})}}a(on,"preCreateToken");var Ce=class extends K{static async openMenu(e,n){let i=await super.openMenu(e,n);return i&&e.message&&rn(e.message),i}get title(){return h("menu.validation.title",{name:this.token.name})}get template(){return Q("validation")}get selected(){let e=super.selected;return e.length?e:this.globalSelection}get globalSelection(){let e=this.token,n=e.actor.alliance;return V(e).filter(i=>i.actor.alliance!==n).map(i=>i.id)}getSavedData(e=!0){let n=super.getSavedData();return e?this._convertData(n):n}_convertData(e){let n=this.property,i=this.scene,r=this.selected,o=M[n],s=n==="cover"?B:re;for(let c of r){let l=i.tokens.get(c),u=`${c}.${n}`,d=getProperty(e,u)??o,p=this.processValue({token:l,value:d});s.includes(p)||(p=d),d!==p&&setProperty(e,u,p)}return e}processValue(e){throw new Error(`${this.constructor.name} doesn't have a 'processValue' method defined`)}getData(e){let{covers:n,visibilities:i,i18n:r}=super.getData(e),o=this.currentData,s=this.getSavedData(!1),c=this.property,l=this.selected,u=V(this.token);u=u.map(({id:p,name:g,actor:f})=>{let m=o[p]??{},S=s[p]??{};return{id:p,name:g,alliance:f.alliance,selected:l.includes(p),...K.createPropertyData(S,m,c)}});let d=O("validation");return d==="selected"?u=u.filter(p=>p.selected):d==="changed"&&(u=u.filter(p=>p.changed)),{...this._spliIntoAlliances(u),i18n:r,property:c,options:c==="cover"?n:i,showSelected:l.length!==u.length&&d==="all",showChanges:d!=="changed"}}activateListeners(e){super.activateListeners(e),e.find("[data-action=cancel]").on("click",n=>{this.close()})}};a(Ce,"ValidationMenu");var Ie=class extends Ce{#e;constructor(e,n={}){super(e,n),this.#e=e.value}get property(){return"cover"}processValue(){return this.#e}};a(Ie,"CoverValidationMenu");var ue=class extends Ce{#e;constructor(e,n={}){super(e,n),this.#e=e.roll}get property(){return"visibility"}get roll(){return this.#e}};a(ue,"VisibilityValidationMenu");var Oe=class extends ue{processValue({token:e,value:n}){let i=this.roll,r=e.actor.perception.dc.value,o=P[n],s=new _(i,r).value;return s>=_.SUCCESS&&o<P.hidden?"hidden":s<=_.FAILURE&&o>=P.hidden?"observed":n}};a(Oe,"HideValidationMenu");var We=class extends ue{get selected(){return V(this.token).map(e=>e.id)}processValue({token:e,value:n}){return P[n]>=P.hidden?"observed":n}};a(We,"UnHideValidationMenu");var Ae=class extends ue{#e;constructor(e,n={}){super(e,n),this.#e=e.originator}get selected(){let e=this.token,n=e.actor.alliance,i=this.#e.id,r=L(e)??{};return V(e).filter(o=>{if(o.id===i||o.actor.alliance===n)return!1;let s=getProperty(r,`${o.id}.visibility`);return P[s]>=P.undetected}).map(o=>o.id)}processValue({token:e,value:n}){return P[n]>=P.undetected?"hidden":n}};a(Ae,"PointOutValidationMenu");var at=class extends ue{getSavedData(e=!0){let n=this.token.id,i=V(this.token),r={};for(let o of i){let s=L(o,n);s&&(r[o.id]=deepClone(s))}return e?this._convertData(r):r}getData(){let e=super.getData();return e.isReversed=!0,e.options=re.map(n=>({value:n,label:h(`visibility.reversed.${n}`)})),e}_saveData(e){let n=this.scene,i=this.token.id,r=[];for(let[o,s]of Object.entries(e)){let c={_id:o},l=n.tokens.get(o);if(l){s.visibility===M.visibility&&delete s.visibility;let u=L(l,i)??{};if(u?.visibility===s.visibility)continue;!u.cover&&!s.visibility?c[`flags.${y}.data.-=${i}`]=!0:s.visibility?c[`flags.${y}.data.${i}.visibility`]=s.visibility:c[`flags.${y}.data.${i}.-=visibility`]=!0}else c[`flags.${y}.data.-=${i}`]=!0;r.push(c)}n.updateEmbeddedDocuments("Token",r)}};a(at,"ReverseVisibilityValidationMenu");var De=class extends at{#e;constructor(e,n={}){super(e,n),this.#e=e.fromTemplate}get globalSelection(){return this.#e?[]:super.globalSelection}static async openMenu(e,n){await super.openMenu(e,n)&&J(e.token)}processValue({token:e,value:n}){let i=this.roll,r=e.actor.skills.stealth.dc.value,o=P[n],s=new _(i,r).value;return s>=_.CRITICAL_SUCCESS&&o>=P.hidden||s>=_.SUCCESS&&o===P.hidden?"observed":s>=_.SUCCESS&&o>=P.undetected?"hidden":n}};a(De,"SeekValidationMenu");function Pt(t,e){let n=t.token;if(!n)return;let i=game.user.isGM,r=n.hasPlayerOwner,{cover:o,selected:s,skipWait:c,validated:l,pointOut:u}=Ot(t),d=t.getFlag("pf2e","context");if(o){if(i){let p=vt({property:"cover",skipWait:c,validated:l});e.find(".message-content").append(p),e.find("[data-action=validate-cover]").on("click",()=>{Ie.openMenu({token:n,selected:s,value:o,message:t})})}else if(!c){let p=ht("cover",l);e.find(".message-content").append(p)}}else if(d?.pf2ePerception?.visibility){l||e.find(".message-buttons").remove();let p=e.find(".flavor-text");!i&&r&&(e.find(".message-sender").text(n.name),p.empty());let g=h(`message.flat-check.${l===void 0?"blind":l?"success":"failure"}`),f=cn(g,l);if(p.append(f),i)for(let m of["success","failure"])p.append(kt({action:`${m}-message`,icon:"fa-solid fa-message",label:h("message.flat-check.button",m)})),e.find(`[data-action=${m}-message]`).on("click",()=>{dt(t,"validated",m==="success")})}else if(d?.type==="skill-check"&&d.pf2ePerception)if(i){if(d.options.includes("action:hide")){let p=vt({property:"visibility",skipWait:c,validated:l});e.find(".flavor-text").append(p),e.find("[data-action=validate-visibility]").on("click",()=>{Oe.openMenu({token:n,message:t,roll:t.rolls[0],selected:d.pf2ePerception.selected})})}}else r&&d.options.includes("action:hide")&&sn({token:n,message:t,html:e,validated:l});else if(d?.type==="perception-check"&&d.pf2ePerception)if(i){if(d.options.includes("action:seek")){let p=an({skipWait:c,validated:l,smallAction:"delete-template",smallIcon:"fa-thin fa-cubes",smallSlashed:!0});e.find(".flavor-text").append(p),e.find("[data-action=validate-visibility]").on("click",()=>{De.openMenu({token:n,message:t,roll:t.rolls[0],selected:d.pf2ePerception.selected,fromTemplate:d.pf2ePerception.fromTemplate})}),e.find("[data-action=delete-template").on("click",()=>{J(n)})}}else r&&d.options.includes("action:seek")&&sn({token:n,message:t,html:e,validated:l});else if(u){let p=n.scene.tokens.get(u);if(!p)return;if(i){let g=an({skipWait:c,validated:l,smallAction:"ping-token",smallIcon:"fa-solid fa-signal-stream"});e.find(".message-content").append(g),e.find("[data-action=validate-visibility]").on("click",()=>{Ae.openMenu({message:t,token:p,originator:n,selected:canvas.tokens.controlled.map(f=>f.id)})}),e.find("[data-action=ping-token]").on("click",()=>{canvas.ping(p.center)})}else if(r){let g=ht("visibility",l);e.find(".message-content").append(g)}}if(i&&me.includes(d?.type)){let g=`<span class="pf2e-perception-unhide">
    <button data-action="unhide" title="${h("message.unhide.tooltip")}">
        <i class="fa-duotone fa-eye-slash"></i>
    </button>
</span>`;e.find(".dice-result .dice-total").append(g),e.find("[data-action=unhide]").on("click",f=>{f.stopPropagation(),We.openMenu({token:n})})}}a(Pt,"renderChatMessage");function rn(t){D(t,"validated")||dt(t,"validated",!0)}a(rn,"validateMessage");function an({skipWait:t,validated:e,smallIcon:n,smallAction:i,smallSlashed:r}){let o='<div class="pf2e-perception-chat-combo">';return o+=vt({property:"visibility",skipWait:t,validated:e}),o+=kt({action:i,icon:n,slashed:r,tooltip:h(`message.visibility.small-button.${i}`)}),o+="</div>",o}a(an,"createValidateCombo");function sn({html:t,token:e,message:n,validated:i}){t.find(".message-sender").text(e.name);let r=n.getFlag("pf2e","modifierName");r+=ht("visibility",i),t.find(".flavor-text").html(r)}a(sn,"addBlindSkillCheckFlavor");function ht(t,e){let n=h(`message.${t}.player.${e?"validated":"wait"}`);return cn(n,e)}a(ht,"createWaitHint");function cn(t,e){return e===!0?t='<i class="fa-solid fa-check validated"></i> '+t:e===!1&&(t='<i class="fa-solid fa-xmark canceled"></i> '+t),`<i class="pf2e-perception-hint">${t}</i>`}a(cn,"createHint");function vt({skipWait:t,validated:e,property:n}){let i=h(`message.${n}.gm.${t?"check":e?"validated":"validate"}`);return!t&&e&&(i+='<i class="fa-solid fa-check validated"></i>'),kt({action:`validate-${n}`,icon:"fa-solid fa-list",label:i})}a(vt,"createValidateButton");function kt({action:t,icon:e,label:n,tooltip:i,slashed:r=!1}){let o=`<button type="button" class="pf2e-perception-chat-button" data-action="${t}" title="${i}">`;return e&&(o+=`<i class="${e} ${n?"":"no-label"}"></i>`,r&&(o+='<i class="fa-solid fa-slash-forward slashed"></i>')),n&&(o+=`${e?" ":""}${n}`),o+="</button>",o}a(kt,"createChatButton");async function Et({content:t,token:e,flags:n,secret:i}){let r={content:t,speaker:ChatMessage.getSpeaker({token:e instanceof Token?e.document:e})};return n&&setProperty(r,`flags.${y}`,n),i&&(r.type=CONST.CHAT_MESSAGE_TYPES.WHISPER,r.whisper=ChatMessage.getWhisperRecipients("gm")),ChatMessage.create(r)}a(Et,"createTokenMessage");function un(){let t=game.pf2e.actions.get("hide"),e=ve(t,2).constructor,n=ve(t.toActionVariant(),2).constructor,i=ve(t,1).constructor,r=ve(t.toActionVariant(),1).constructor;zn(e,n),Vn(i,r),Mn(i,r),Ln(i,r),wn(e,n)}a(un,"setupActions");function wn(t,e){class n extends e{async use(o={}){let s=h("action.point-out"),c=we(o,s);c&&$n(this,c)}}a(n,"PointOutVariant");class i extends t{constructor(){super({cost:1,name:`${y}.action.point-out`,description:`${y}.action.point-out.description`,rollOptions:["action:point-out"],slug:"point-out",traits:["auditory","manipulate","visual"]})}toActionVariant(o={}){return o.name??=this.name,new n(this,o)}}a(i,"PointOut"),game.pf2e.actions.set("point-out",new i)}a(wn,"setupPointOut");async function $n({name:t,traits:e},n){let i=game.user.targets.filter(u=>u.actor).first(),r=i?L(i,n.id,"visibility"):void 0,o=i&&P[r]<P.undetected,s;if(o){let u=i.actor.skills.stealth.dc.value;s=h("message.point-out.short-check",{check:`@Check[type:perception|dc:${u}|traits:auditory,manipulate,visual|showDC:gm]`})}else s=h("message.point-out.short");let c=await renderTemplate(Q("point-out"),{description:s,name:t,traits:e.map(u=>({slug:u,tooltip:CONFIG.PF2E.traitsDescriptions[u],name:CONFIG.PF2E.actionTraits[u]}))}),l={pointOut:o?i.id:void 0};Et({content:c,token:n,flags:l})}a($n,"pointOut");function Ln(t,e){class n extends e{async use(o={}){let s=game.i18n.localize("PF2E.Actions.Seek.Title"),c=we(o,s);if(c)return await _n(c)?(o.actors=[c.actor],super.use(o)):J(c)}}a(n,"SeekVariant");class i extends t{constructor(){super({cost:1,description:"PF2E.Actions.Seek.Description",name:"PF2E.Actions.Seek.Title",notes:[{outcome:["criticalSuccess"],text:"PF2E.Actions.Seek.Notes.criticalSuccess"},{outcome:["success"],text:"PF2E.Actions.Seek.Notes.success"}],rollOptions:["action:seek"],slug:"seek",statistic:"perception",traits:["concentrate","secret"]})}toActionVariant(o){return new n(this,o)}}a(i,"Seek"),game.pf2e.actions.set("seek",new i)}a(Ln,"setupSeek");async function _n(t){let e=game.i18n.localize("PF2E.Foot"),n='<p style="margin: 0 0.3em; text-align: center;">';return n+=`${h("dialog.seek.hint")}</p><p>`,n+=ln("create-cone","fa-thin fa-cubes",game.i18n.format("PF2E.TemplateLabel",{size:30,unit:e,shape:game.i18n.localize(CONFIG.PF2E.areaTypes.cone)})),n+=ln("create-burst","fa-thin fa-cubes",game.i18n.format("PF2E.TemplateLabel",{size:15,unit:e,shape:game.i18n.localize(CONFIG.PF2E.areaTypes.burst)})),n+="</p>",Dialog.wait({title:`${t.name} - ${game.i18n.localize("PF2E.Actions.Seek.Title")}`,content:n,buttons:{ok:{icon:'<i class="fa-solid fa-check"></i>',label:h("dialog.seek.accept"),callback:()=>!0},no:{icon:'<i class="fa-solid fa-xmark"></i>',label:h("dialog.seek.cancel"),callback:i=>!1}},close:()=>!1,render:i=>{i.filter(".dialog-content").find("[data-action=create-cone], [data-action=create-burst]").on("click",o=>{let{action:s}=o.currentTarget.dataset;J(t),He({type:s==="create-cone"?"cone":"burst",token:t})})}},{width:300,left:10})}a(_n,"seek");function Mn(t,e){class n extends e{async use(o={}){let s=game.i18n.localize("PF2E.Actions.Sneak.Title"),c=we(o,s);if(c)return o.actors=[c.actor],super.use(o)}}a(n,"SneakVariant");class i extends t{constructor(){super({cost:1,description:"PF2E.Actions.Sneak.Description",name:"PF2E.Actions.Sneak.Title",notes:[{outcome:["success","criticalSuccess"],text:"PF2E.Actions.Sneak.Notes.success"},{outcome:["failure"],text:"PF2E.Actions.Sneak.Notes.failure"},{outcome:["criticalFailure"],text:"PF2E.Actions.Sneak.Notes.criticalFailure"}],rollOptions:["action:sneak"],slug:"sneak",traits:["move","secret"]})}toActionVariant(o){return new n(this,o)}}a(i,"Sneak")}a(Mn,"setupSneak");function Vn(t,e){class n extends e{async use(o={}){let s=game.i18n.localize("PF2E.Actions.Hide.Title"),c=we(o,s);if(c)return o.actors=[c.actor],super.use(o)}}a(n,"HideVariant");class i extends t{constructor(){super({cost:1,description:"PF2E.Actions.Hide.Description",name:"PF2E.Actions.Hide.Title",rollOptions:["action:hide"],slug:"hide",statistic:"stealth",traits:["secret"],notes:[{outcome:["success","criticalSuccess"],text:"PF2E.Actions.Hide.Notes.success"}]})}toActionVariant(o){return new n(this,o)}}a(i,"Hide"),game.pf2e.actions.set("hide",new i)}a(Vn,"setupHide");function zn(t,e){class n extends e{async use(o={}){let s=h("action.take-cover"),c=we(o,s);c&&jn(c)}}a(n,"TakeCoverVariant");class i extends t{constructor(){super({cost:1,description:"PF2E.Actions.TakeCover.Description",img:"systems/pf2e/icons/conditions-2/status_acup.webp",name:"PF2E.Actions.TakeCover.Title",slug:"take-cover"})}toActionVariant(o){return new n(this,o)}}a(i,"TakeCover"),game.pf2e.actions.set("take-cover",new i)}a(zn,"setupCover");async function jn(t){let e=t.actor,n=ee(e),i=ne(t,game.user.targets.ids);if(n&&!i.length)return n.delete();let r=L(t)??{},o=Object.entries(r).reduce((l,[u,{cover:d}])=>(d&&(l[u]=d),l),{}),s=await renderTemplate(Q("covers-dialog"),{i18n:h,hasTargets:!!i.length,hasCovers:!isEmpty(o),hasTargetCover:i.some(l=>l in o),isProne:Z(e)}),c=new Dialog({title:`${t.name} - ${h("action.take-cover")}`,content:s,buttons:{},render:l=>{l.find("button").on("click",async u=>{let{level:d}=u.currentTarget.dataset,p=O("skip-cover"),g=a(async(f,m)=>{m=m?i:void 0;let S=f===M.cover?m?"remove":"remove-all":"take",x=await Et({content:h(`message.cover.${S}`,{cover:h(`cover.${f}`)}),flags:{selected:m,cover:f,skipWait:p},token:t});if(p){if(f===M.cover&&!m)return Zt(t);let b=deepClone(L(t))??{};for(let k of i)setProperty(b,`${k}.cover`,f);return Xe(t,b)}},"process");if(d==="remove-all")g(M.cover);else if(d==="remove")g(M.cover,!0);else if(i.length)g(d,!0);else{let f=ge(d);e.createEmbeddedDocuments("Item",[f])}c.close()})}}).render(!0)}a(jn,"takeCover");function we(t,e){let n=t.tokens?.filter(o=>o.actor)??[];Array.isArray(n)||(n=[n]);let i=t.actors??[];if(Array.isArray(i)||(i=[i]),!n.length&&i.length===1&&(n=[Re(i[0])].filter(Boolean)),n.length||(n=canvas.tokens.controlled.filter(o=>o.actor)),n.length||(n=[Re(game.user.character)].filter(Boolean)),n.length>1){ui.notifications.warn(h("action.only-one",{action:e}));return}else if(!n.length){ui.notifications.warn(h("action.must-one",{action:e}));return}let r=n[0];if(!r?.actor?.isOfType("creature")){ui.notifications.warn(h("action.must-creature",{action:e}));return}return r}a(we,"getSelectedToken");function ln(t,e,n){return`<button type="button" data-action="${t}" style="margin: 0 0 5px; padding: 0;">
    <i class="${e}"></i> ${n}</button>
</button>`}a(ln,"createButton");var dn={geometry:{clearDebug:se,getRectEdges:et,lineIntersectWall:Ne,pointToTokenIntersectWall:tt},token:{getCreatureCover:ft,getWallCover:it,getVisibility:oe,clearConditionals:le,showConditionals:yt,showAllConditionals:rt,getTokenData:L,getCover:ot,openHUD:gt},lighting:{getLightExposure:nt},actor:{isProne:Z,getCoverEffect:ee,seeInvisibility:ze,hasGreaterDarkvision:Ve},scene:{getValidTokens:V,validateTokens:ne,getSceneSetting:ye},template:{createSeekTemplate:He,createDarknessTemplate:jt,createMistTemplate:Gt,getDarknessTemplates:Ke,getMistTemplates:Ye,getSeekTemplateTokens:qe,deleteSeekTemplate:J,getTemplateTokens:he},ruleElement:{perceptionRules:ie,getPerception:G,updateFromPerceptionRules:ke}};async function pn(t,...e){let n=e[1];if(!n)return t(...e);Array.isArray(n.options)&&(n.options=new Set(n.options));let{actor:i,createMessage:r="true",type:o,token:s,target:c,isReroll:l}=n,u=s??Re(i),d=c?.token,p=me.includes(o),g=O("flat-check");if(l||!r||!u||!xt.includes(o)||p&&(!d||g==="none"))return t(...e);if(p&&d.actor){let f=e[2],m=ie(u,d,{extraOptions:n.options.filter(I=>I.startsWith("item:"))}),S=oe(d,u,{perception:m,affects:"target"});if(!S)return t(...e);let x=(()=>{let I=G(m,"target","visibility","dc",S)?.first(),E=Je(I);if(!E)return E;let F=I[0];return["-","+"].includes(F)?(S==="concealed"?5:11)+E:E})();if(x===0)return t(...e);let b=P[S]>=P.undetected,k=f?.ctrlKey||f?.metaKey,R=(await new u.actor.perception.constructor(u.actor,{slug:"visibility-check",label:`${game.i18n.localize("PF2E.FlatCheck")}: ${game.i18n.localize(`PF2E.condition.${S}.name`)}`,check:{type:"flat-check"}}).roll({dc:{value:x??(S==="concealed"?5:11)},target:d.actor,rollMode:b||k?game.user.isGM?"gmroll":"blindroll":"roll"})).degreeOfSuccess>1;if(b&&(n.options.add("secret"),n.pf2ePerception={isSuccess:R,visibility:S}),g!=="roll"&&!b&&!R)return}else if(n.options.has("action:hide"))setProperty(n,"pf2ePerception.selected",game.user.targets.ids);else if(n.options.has("action:seek")){let f=qe(u),m=f??Array.from(game.user.targets),S=ne(u,m).filter(x=>!x.document.hidden).map(x=>x.id);setProperty(n,"pf2ePerception.selected",S),setProperty(n,"pf2ePerception.fromTemplate",!!f)}return t(...e)}a(pn,"checkRoll");function mn(t,e){let{createMessage:n="true",type:i,token:r,target:o,isReroll:s,options:c,dc:l}=t.context,u=r,d=o?.token,p=o?.actor;if(s||!n||!u||!d||!p||!me.includes(i))return;let g=ee(p),f=g?Me(g)?.selection.level??D(g,"level"):void 0,m=t[y]?.coverOverride??f,S='<div class="roll-mode-panel">';S+=`<div class="label">${h("dice-checks.cover.label")}</div>`,S+=`<select name="overrideCover"><option value="">${h("dice-checks.cover.none")}</option>`,(Z(p)?B.slice(1):B.slice(1,-1)).forEach(b=>{let k=b===m?"selected":"",C=h(`cover.${b}`);S+=`<option value="${b}" ${k}>${C}</option>`}),S+="</select></div>",S+="<hr>",e.find(".roll-mode-panel").before(S),e.find("select[name=overrideCover]").on("change",b=>{let k=b.currentTarget.value||void 0;setProperty(t,`${y}.coverOverride`,k),m=k}),e.find("button.roll")[0].addEventListener("click",b=>{b.preventDefault(),b.stopPropagation(),b.stopImmediatePropagation();let k=!1,C=deepClone(p._source.items);if(m!==f){k=!0;let R=C.findIndex(I=>getProperty(I,"flags.core.sourceId")===pe);if(R!==-1&&C.splice(R,1),m){let I=ge(m);C.push(I)}}if(k&&(o.actor=p.clone({items:C},{keepId:!0}),l?.slug)){let R=o.actor.getStatistic(l.slug)?.dc;R&&(l.value=R.value,l.statistic=R)}t.resolve(!0),t.isResolved=!0,t.close()},!0),t.setPosition()}a(mn,"renderCheckModifiersDialog");function gn(t,e){O("target")&&Gn(e)}a(gn,"renderCombatTracker");function Gn(t){t.find("[data-control=toggleTarget]").each((e,n)=>{n.addEventListener("click",i=>{i.preventDefault(),i.stopPropagation(),i.stopImmediatePropagation();let{combatantId:r}=i.currentTarget.closest(".combatant").dataset,s=game.combats.viewed.combatants.get(r??"")?.token;if(!s)return;let c=Array.from(game.user.targets).some(l=>l.document===s);s.object.setTarget(!c,{releaseOthers:!i.shiftKey})},!0)})}a(Gn,"setupToggleTarget");function fn(t,e){let n=O("encounter");e.find(".form-group").last().after(`<div class="form-group">
    <label>${h("settings.encounter.name")}</label>
    <input type="checkbox" name="pf2e-perception.encounter" ${n?"checked":""}>
    <p class="notes">${h("settings.encounter.short")}</p>
</div>`),e.find('input[name="pf2e-perception.encounter"]').on("change",i=>{let r=i.currentTarget.checked;_e("encounter",r)})}a(fn,"renderCombatTrackerConfig");function yn(t,e,n={}){return!e.enabled||!this._canDetect(t,n.object,n)?!1:n.tests.some(i=>this._testPoint(t,e,n.object,i))}a(yn,"detectionModeTestVisibility");function hn(t,e,n){if(e instanceof PlaceableObject&&e.document.hidden)return!1;if(!(e instanceof Token))return!0;let i=t.object,r=i.document;return r instanceof TokenDocument&&r.hasStatusEffect(CONFIG.specialStatusEffects.BLIND)?!1:i instanceof Token?!St(i,e,P.hidden,n):!e.document?.hasStatusEffect(CONFIG.specialStatusEffects.INVISIBLE)&&!e.actor?.hasCondition("hidden","undetected","unnoticed")}a(hn,"basicSightCanDetect");function vn(t,e,n){if(e.document.hidden||!(e instanceof Token)||!e.actor?.emitsSound)return!1;if(!game.settings.get("pf2e","automation.rulesBasedVision"))return!0;let i=t.object;return i.actor?.hasCondition("deafened")?!1:i instanceof Token?!St(i,e,P.undetected,n):!e.actor?.hasCondition("undetected","unnoticed")}a(vn,"hearingCanDetect");function Pn(t,e,n){if(e.document.hidden||!(e instanceof Token)||e.document.elevation>canvas.primary.background.elevation||e.actor?.isOfType("loot"))return!1;let i=t.object;return i instanceof Token?!St(i,e,P.undetected,n):!e.actor?.hasCondition("undetected","unnoticed")}a(Pn,"feelTremorCanDetect");function St(t,e,n,i={}){if(!i.visibility){let r=ie(t,e);i.visibility=oe(e,t,{perception:r,affects:"target"})}return P[i.visibility]>=n}a(St,"reachesThreshold");function Un(t,e,n){let i=t.length-e.length,r=Array.from(e);if(i===0)return t(...r);if(i===1){let o=a(s=>t(s,...r),"ret");return(n||t.lazy)&&(o.lazy=n||t.lazy,o.lazyArgs=e),o}throw new Error("Wrong number of arguments")}a(Un,"purry");function Bn(t,e,n){let i=[];for(let r=0;r<t.length;r++){let o=t[r],s=n?e(o,r,t):e(o);s.hasMany===!0?i.push(...s.next):s.hasNext&&i.push(s.next)}return i}a(Bn,"_reduceLazy");function kn(){let t=new Set;return e=>t.has(e)?{done:!1,hasNext:!1}:(t.add(e),{done:!1,hasNext:!0,next:e})}a(kn,"uniqLazy");function Hn(t){return Bn(t,kn())}a(Hn,"_uniq");var Ee={compact:t=>t.filter(Boolean),uniq:function(){return Un(Hn,arguments,kn)}};async function bt({affects:t,origin:e,target:n,item:i,domains:r,options:o}){if(!(e&&n))return[];let[s,c]=t==="target"?[e,n]:[n,e],l=[...o,s.getRollOptions(r),c.getSelfRollOptions(t)].flat(),u=i?i.isOfType("spell")?{spell:i}:{weapon:i}:{};return(await Promise.all(r.flatMap(d=>s.synthetics.ephemeralEffects[d]?.[t]??[]).map(d=>d({test:l,resolvables:u})))).flatMap(d=>d??[])}a(bt,"extractEphemeralEffects");function En(t,e){if(!t.isOfType("action","melee","weapon"))return null;let{increment:n}=t.range??{};return n&&typeof e=="number"?Math.max(Math.ceil(e/n),1):null}a(En,"getRangeIncrement");function Sn(t,e){if(!t?.isOfType("creature"))return!1;let{flanking:n}=t.attributes;return n.flankable?typeof n.offGuardable=="number"?e.level>n.offGuardable:n.offGuardable:!1}a(Sn,"isOffGuardFromFlanking");var Kn={ancestralEchoing:{level:15,name:"PF2E.WeaponPropertyRune.ancestralEchoing.Name",price:9500,rarity:"rare",slug:"ancestralEchoing",traits:["dwarf","magical","saggorak"]},anchoring:{damage:{notes:[{outcome:["criticalSuccess"],title:"PF2E.WeaponPropertyRune.anchoring.Name",text:"PF2E.WeaponPropertyRune.anchoring.Note.criticalSuccess"}]},level:10,name:"PF2E.WeaponPropertyRune.anchoring.Name",price:900,rarity:"uncommon",slug:"anchoring",traits:["magical"]},ashen:{damage:{dice:[{damageType:"fire",category:"persistent",diceNumber:1,dieSize:"d4"}],notes:[{outcome:["success"],title:"PF2E.WeaponPropertyRune.ashen.Name",text:"PF2E.WeaponPropertyRune.ashen.Note.success"}]},level:9,name:"PF2E.WeaponPropertyRune.ashen.Name",price:700,rarity:"common",slug:"ashen",traits:["magical"]},authorized:{level:3,name:"PF2E.WeaponPropertyRune.authorized.Name",price:50,rarity:"common",slug:"authorized",traits:["magical"]},bane:{level:4,name:"PF2E.WeaponPropertyRune.bane.Name",price:100,rarity:"uncommon",slug:"bane",traits:["magical"]},bloodbane:{level:8,name:"PF2E.WeaponPropertyRune.bloodbane.Name",price:475,rarity:"uncommon",slug:"bloodbane",traits:["dwarf","magical"]},bloodthirsty:{damage:{notes:[{outcome:["criticalSuccess"],title:"PF2E.WeaponPropertyRune.bloodbane.Name",text:"PF2E.WeaponPropertyRune.bloodthirsty.Note.criticalSuccess"}]},level:16,name:"PF2E.WeaponPropertyRune.bloodthirsty.Name",price:8500,rarity:"uncommon",slug:"bloodthirsty",traits:["magical"]},brilliant:{damage:{dice:[{damageType:"fire",diceNumber:1,dieSize:"d4"},{damageType:"spirit",diceNumber:1,dieSize:"d4",predicate:["target:trait:fiend"]},{damageType:"vitality",diceNumber:1,dieSize:"d4",predicate:["target:mode:undead"]}],notes:[{outcome:["criticalSuccess"],title:"PF2E.WeaponPropertyRune.brilliant.Name",text:"PF2E.WeaponPropertyRune.brilliant.Note.criticalSuccess"}]},level:12,name:"PF2E.WeaponPropertyRune.brilliant.Name",price:2e3,rarity:"common",slug:"brilliant",traits:["magical"]},called:{level:7,name:"PF2E.WeaponPropertyRune.called.Name",price:350,rarity:"common",slug:"called",traits:["magical"]},coating:{level:9,name:"PF2E.WeaponPropertyRune.coating.Name",price:700,rarity:"common",slug:"coating",traits:["extradimensional","magical"]},conducting:{level:7,name:"PF2E.WeaponPropertyRune.conducting.Name",price:300,rarity:"common",slug:"conducting",traits:["magical"]},corrosive:{damage:{dice:[{damageType:"acid",diceNumber:1,dieSize:"d6"}],notes:[{outcome:["criticalSuccess"],title:"PF2E.WeaponPropertyRune.corrosive.Name",text:"PF2E.WeaponPropertyRune.corrosive.Note.criticalSuccess"}]},level:8,name:"PF2E.WeaponPropertyRune.corrosive.Name",price:500,rarity:"common",slug:"corrosive",traits:["acid","magical"]},crushing:{damage:{notes:[{outcome:["criticalSuccess"],title:"PF2E.WeaponPropertyRune.crushing.Name",text:"PF2E.WeaponPropertyRune.crushing.Note.criticalSuccess"}]},level:3,name:"PF2E.WeaponPropertyRune.crushing.Name",price:50,rarity:"uncommon",slug:"crushing",traits:["magical"]},cunning:{level:5,name:"PF2E.WeaponPropertyRune.cunning.Name",price:140,rarity:"common",slug:"cunning",traits:["magical"]},dancing:{level:13,name:"PF2E.WeaponPropertyRune.dancing.Name",price:2700,rarity:"uncommon",slug:"dancing",traits:["magical"]},deathdrinking:{damage:{dice:[{slug:"deathdrinking-negative",damageType:"void",diceNumber:1,dieSize:"d6",critical:!0,predicate:["target:mode:living",{not:"target:negative-healing"}]},{slug:"deathdrinking-positive",damageType:"vitality",diceNumber:1,dieSize:"d6",critical:!0,predicate:["target:negative-healing"]}]},level:7,name:"PF2E.WeaponPropertyRune.deathdrinking.Name",price:360,rarity:"rare",slug:"deathdrinking",traits:["magical"]},demolishing:{damage:{dice:[{damageType:"force",category:"persistent",diceNumber:1,dieSize:"d6",predicate:["target:trait:construct"]}]},level:6,name:"PF2E.WeaponPropertyRune.demolishing.Name",price:225,rarity:"rare",slug:"demolishing",traits:["magical"]},disrupting:{damage:{dice:[{damageType:"vitality",diceNumber:1,dieSize:"d6",predicate:["target:mode:undead"]}],notes:[{outcome:["criticalSuccess"],title:"PF2E.WeaponPropertyRune.disrupting.Name",text:"PF2E.WeaponPropertyRune.disrupting.Note.criticalSuccess",predicate:["target:mode:undead"]}]},level:5,name:"PF2E.WeaponPropertyRune.disrupting.Name",price:150,rarity:"common",slug:"disrupting",traits:["magical"]},earthbinding:{level:5,name:"PF2E.WeaponPropertyRune.earthbinding.Name",price:125,rarity:"common",slug:"earthbinding",traits:["magical"]},energizing:{level:6,name:"PF2E.WeaponPropertyRune.energizing.Name",price:250,rarity:"uncommon",slug:"energizing",traits:["magical"]},extending:{level:7,name:"PF2E.WeaponPropertyRune.extending.Name",price:700,rarity:"common",slug:"extending",traits:["magical"]},fanged:{level:2,name:"PF2E.WeaponPropertyRune.fanged.Name",price:30,rarity:"uncommon",slug:"fanged",traits:["magical"]},fearsome:{damage:{notes:[{outcome:["criticalSuccess"],title:"PF2E.WeaponPropertyRune.fearsome.Name",text:"PF2E.WeaponPropertyRune.fearsome.Note.criticalSuccess"}]},level:5,name:"PF2E.WeaponPropertyRune.fearsome.Name",price:160,rarity:"common",slug:"fearsome",traits:["emotion","fear","magical","mental"]},flaming:{damage:{dice:[{damageType:"fire",diceNumber:1,dieSize:"d6"},{damageType:"fire",category:"persistent",diceNumber:1,dieSize:"d10",critical:!0}]},level:8,name:"PF2E.WeaponPropertyRune.flaming.Name",price:500,rarity:"common",slug:"flaming",traits:["fire","magical"]},flurrying:{level:7,name:"PF2E.WeaponPropertyRune.flurrying.Name",price:360,rarity:"common",slug:"flurrying",traits:["magical"]},frost:{damage:{dice:[{damageType:"cold",diceNumber:1,dieSize:"d6"}],notes:[{outcome:["criticalSuccess"],title:"PF2E.WeaponPropertyRune.frost.Name",text:"PF2E.WeaponPropertyRune.frost.Note.criticalSuccess"}]},level:8,name:"PF2E.WeaponPropertyRune.frost.Name",price:500,rarity:"common",slug:"frost",traits:["cold","magical"]},ghostTouch:{level:4,name:"PF2E.WeaponPropertyRune.ghostTouch.Name",price:75,rarity:"common",slug:"ghostTouch",traits:["magical"]},giantKilling:{damage:{dice:[{slug:"giantKilling",damageType:"mental",diceNumber:1,dieSize:"d6",predicate:["target:trait:giant"]}],notes:[{outcome:["criticalSuccess"],predicate:["target:trait:giant"],title:"PF2E.WeaponPropertyRune.giantKilling.Name",text:"PF2E.WeaponPropertyRune.giantKilling.Note.criticalSuccess"}]},level:8,name:"PF2E.WeaponPropertyRune.giantKilling.Name",price:450,rarity:"rare",slug:"giantKilling",traits:["magical"]},greaterAnchoring:{damage:{notes:[{outcome:["criticalSuccess"],title:"PF2E.WeaponPropertyRune.greaterAnchoring.Name",text:"PF2E.WeaponPropertyRune.greaterAnchoring.Note.criticalSuccess"},{outcome:["success"],title:"PF2E.WeaponPropertyRune.greaterAnchoring.Name",text:"PF2E.WeaponPropertyRune.greaterAnchoring.Note.success"}]},level:18,name:"PF2E.WeaponPropertyRune.greaterAnchoring.Name",price:22e3,rarity:"uncommon",slug:"greaterAnchoring",traits:["magical"]},greaterAshen:{damage:{dice:[{damageType:"fire",category:"persistent",diceNumber:1,dieSize:"d8"}],notes:[{outcome:["success"],title:"PF2E.WeaponPropertyRune.greaterAshen.Name",text:"PF2E.WeaponPropertyRune.greaterAshen.Note.success"}]},level:16,name:"PF2E.WeaponPropertyRune.greaterAshen.Name",price:9e3,rarity:"common",slug:"greaterAshen",traits:["magical"]},greaterBloodbane:{level:13,name:"PF2E.WeaponPropertyRune.greaterBloodbane.Name",price:2800,rarity:"uncommon",slug:"greaterBloodbane",traits:["dwarf","magical"]},greaterBrilliant:{damage:{dice:[{damageType:"fire",diceNumber:1,dieSize:"d4"},{diceNumber:1,dieSize:"d4",predicate:["target:trait:fiend"]},{damageType:"vitality",diceNumber:1,dieSize:"d4",predicate:["target:mode:undead"]}],notes:[{outcome:["criticalSuccess"],title:"PF2E.WeaponPropertyRune.greaterBrilliant.Name",text:"PF2E.WeaponPropertyRune.greaterBrilliant.Note.criticalSuccess"},{outcome:["success"],title:"PF2E.WeaponPropertyRune.greaterBrilliant.Name",text:"PF2E.WeaponPropertyRune.greaterBrilliant.Note.success"}],ignoredResistances:[{type:"fire",max:null},{type:"good",max:null},{type:"vitality",max:null}]},level:18,name:"PF2E.WeaponPropertyRune.greaterBrilliant.Name",price:24e3,rarity:"common",slug:"greaterBrilliant",traits:["magical"]},greaterCorrosive:{damage:{dice:[{damageType:"acid",diceNumber:1,dieSize:"d6"}],notes:[{outcome:["criticalSuccess"],title:"PF2E.WeaponPropertyRune.greaterCorrosive.Name",text:"PF2E.WeaponPropertyRune.greaterCorrosive.Note.criticalSuccess"},{outcome:["success"],title:"PF2E.WeaponPropertyRune.greaterCorrosive.Name",text:"PF2E.WeaponPropertyRune.greaterCorrosive.Note.success"}]},level:15,name:"PF2E.WeaponPropertyRune.greaterCorrosive.Name",price:6500,rarity:"common",slug:"greaterCorrosive",traits:["acid","magical"]},greaterCrushing:{damage:{notes:[{outcome:["criticalSuccess"],title:"PF2E.WeaponPropertyRune.greaterCrushing.Name",text:"PF2E.WeaponPropertyRune.greaterCrushing.Note.criticalSuccess"}]},level:9,name:"PF2E.WeaponPropertyRune.greaterCrushing.Name",price:650,rarity:"uncommon",slug:"greaterCrushing",traits:["magical"]},greaterDisrupting:{damage:{dice:[{damageType:"vitality",diceNumber:2,dieSize:"d6",predicate:["target:mode:undead"]}],notes:[{outcome:["criticalSuccess"],title:"PF2E.WeaponPropertyRune.greaterDisrupting.Name",text:"PF2E.WeaponPropertyRune.greaterDisrupting.Note.criticalSuccess",predicate:["target:mode:undead"]}]},level:14,name:"PF2E.WeaponPropertyRune.greaterDisrupting.Name",price:4300,rarity:"uncommon",slug:"greaterDisrupting",traits:["magical"]},greaterExtending:{level:13,name:"PF2E.WeaponPropertyRune.greaterExtending.Name",price:3e3,rarity:"common",slug:"greaterExtending",traits:["magical"]},greaterFanged:{level:8,name:"PF2E.WeaponPropertyRune.greaterFanged.Name",price:425,rarity:"uncommon",slug:"greaterFanged",traits:["magical"]},greaterFearsome:{damage:{notes:[{outcome:["criticalSuccess"],title:"PF2E.WeaponPropertyRune.greaterFearsome.Name",text:"PF2E.WeaponPropertyRune.greaterFearsome.Note.criticalSuccess"}]},level:12,name:"PF2E.WeaponPropertyRune.greaterFearsome.Name",price:2e3,rarity:"common",slug:"greaterFearsome",traits:["emotion","fear","magical","mental"]},greaterFlaming:{damage:{dice:[{damageType:"fire",diceNumber:1,dieSize:"d6"},{damageType:"fire",category:"persistent",diceNumber:2,dieSize:"d10",critical:!0}],notes:[{outcome:["criticalSuccess"],title:"PF2E.WeaponPropertyRune.greaterFlaming.Name",text:"PF2E.WeaponPropertyRune.greaterFlaming.Note.criticalSuccess"},{outcome:["success"],title:"PF2E.WeaponPropertyRune.greaterFlaming.Name",text:"PF2E.WeaponPropertyRune.greaterFlaming.Note.success"}],ignoredResistances:[{type:"fire",max:null}]},level:15,name:"PF2E.WeaponPropertyRune.greaterFlaming.Name",price:6500,rarity:"common",slug:"greaterFlaming",traits:["fire","magical"]},greaterFrost:{damage:{dice:[{damageType:"cold",diceNumber:1,dieSize:"d6"}],notes:[{outcome:["criticalSuccess"],title:"PF2E.WeaponPropertyRune.greaterFrost.Name",text:"PF2E.WeaponPropertyRune.greaterFrost.Note.criticalSuccess"},{outcome:["success"],title:"PF2E.WeaponPropertyRune.greaterFrost.Name",text:"PF2E.WeaponPropertyRune.greaterFrost.Note.success"}],ignoredResistances:[{type:"cold",max:null}]},level:15,name:"PF2E.WeaponPropertyRune.greaterFrost.Name",price:6500,rarity:"common",slug:"greaterFrost",traits:["cold","magical"]},greaterGiantKilling:{damage:{dice:[{slug:"greaterGiantKilling",damageType:"mental",diceNumber:2,dieSize:"d6",predicate:["target:trait:giant"]}],ignoredResistances:[{type:"mental",max:null}],notes:[{outcome:["criticalSuccess"],predicate:["target:trait:giant"],title:"PF2E.WeaponPropertyRune.greaterGiantKilling.Name",text:"PF2E.WeaponPropertyRune.greaterGiantKilling.Note.criticalSuccess"}]},level:15,name:"PF2E.WeaponPropertyRune.greaterGiantKilling.Name",price:6e3,rarity:"rare",slug:"greaterGiantKilling",traits:["magical"]},greaterHauling:{level:11,name:"PF2E.WeaponPropertyRune.greaterHauling.Name",price:1300,rarity:"uncommon",slug:"greaterHauling",traits:["magical"]},greaterImpactful:{damage:{dice:[{damageType:"force",diceNumber:1,dieSize:"d6"}],notes:[{outcome:["criticalSuccess"],title:"PF2E.WeaponPropertyRune.greaterImpactful.Name",text:"PF2E.WeaponPropertyRune.greaterImpactful.Note.criticalSuccess"}]},level:17,name:"PF2E.WeaponPropertyRune.greaterImpactful.Name",price:15e3,rarity:"common",slug:"greaterImpactful",traits:["force","magical"]},greaterRooting:{level:11,name:"PF2E.WeaponPropertyRune.greaterRooting.Name",price:1400,rarity:"common",slug:"greaterRooting",traits:["plant","magical","wood"],damage:{notes:[{outcome:["criticalSuccess"],title:"PF2E.WeaponPropertyRune.greaterRooting.Name",text:"PF2E.WeaponPropertyRune.greaterRooting.Note.criticalSuccess"},{outcome:["success"],title:"PF2E.WeaponPropertyRune.greaterRooting.Name",text:"PF2E.WeaponPropertyRune.greaterRooting.Note.success"}]}},greaterShock:{damage:{dice:[{damageType:"electricity",diceNumber:1,dieSize:"d6"}],notes:[{outcome:["criticalSuccess"],title:"PF2E.WeaponPropertyRune.greaterShock.Name",text:"PF2E.WeaponPropertyRune.greaterShock.Note.criticalSuccess"},{outcome:["success"],title:"PF2E.WeaponPropertyRune.greaterShock.Name",text:"PF2E.WeaponPropertyRune.greaterShock.Note.success"}],ignoredResistances:[{type:"electricity",max:null}]},level:15,name:"PF2E.WeaponPropertyRune.greaterShock.Name",price:6500,rarity:"common",slug:"greaterShock",traits:["electricity","magical"]},greaterThundering:{damage:{dice:[{damageType:"sonic",diceNumber:1,dieSize:"d6"}],notes:[{outcome:["criticalSuccess"],title:"PF2E.WeaponPropertyRune.greaterThundering.Name",text:"PF2E.WeaponPropertyRune.greaterThundering.Note.criticalSuccess"},{outcome:["success"],title:"PF2E.WeaponPropertyRune.greaterThundering.Name",text:"PF2E.WeaponPropertyRune.greaterThundering.Note.success"}],ignoredResistances:[{type:"sonic",max:null}]},level:15,name:"PF2E.WeaponPropertyRune.greaterThundering.Name",price:6500,rarity:"common",slug:"greaterThundering",traits:["magical","sonic"]},grievous:{damage:{dice:[{damageType:"bleed",diceNumber:1,dieSize:"d6",critical:!0,predicate:["critical-specialization","item:group:dart"]}],notes:[{outcome:["criticalSuccess"],predicate:["item:group:axe"],title:"PF2E.WeaponPropertyRune.grievous.Name",text:"PF2E.WeaponPropertyRune.grievous.Note.Axe"},{outcome:["criticalSuccess"],predicate:["item:group:brawling"],title:"PF2E.WeaponPropertyRune.grievous.Name",text:"PF2E.WeaponPropertyRune.grievous.Note.Brawling"},{outcome:["criticalSuccess"],predicate:["item:group:club"],title:"PF2E.WeaponPropertyRune.grievous.Name",text:"PF2E.WeaponPropertyRune.grievous.Note.Club"},{outcome:["criticalSuccess"],predicate:["item:group:flail"],title:"PF2E.WeaponPropertyRune.grievous.Name",text:"PF2E.WeaponPropertyRune.grievous.Note.Flail"},{outcome:["criticalSuccess"],predicate:["item:group:hammer"],title:"PF2E.WeaponPropertyRune.grievous.Name",text:"PF2E.WeaponPropertyRune.grievous.Note.Hammer"},{outcome:["criticalSuccess"],predicate:["item:group:knife"],title:"PF2E.WeaponPropertyRune.grievous.Name",text:"PF2E.WeaponPropertyRune.grievous.Note.Knife"},{outcome:["criticalSuccess"],predicate:["item:group:polearm"],title:"PF2E.WeaponPropertyRune.grievous.Name",text:"PF2E.WeaponPropertyRune.grievous.Note.Polearm"},{outcome:["criticalSuccess"],predicate:["item:group:shield"],title:"PF2E.WeaponPropertyRune.grievous.Name",text:"PF2E.WeaponPropertyRune.grievous.Note.Shield"},{outcome:["criticalSuccess"],predicate:["item:group:sling"],title:"PF2E.WeaponPropertyRune.grievous.Name",text:"PF2E.WeaponPropertyRune.grievous.Note.Sling"},{outcome:["criticalSuccess"],predicate:["item:group:spear"],title:"PF2E.WeaponPropertyRune.grievous.Name",text:"PF2E.WeaponPropertyRune.grievous.Note.Spear"},{outcome:["criticalSuccess"],predicate:["item:group:sword"],title:"PF2E.WeaponPropertyRune.grievous.Name",text:"PF2E.WeaponPropertyRune.grievous.Note.Sword"}],adjustments:[{slug:"critical-specialization",test:t=>new PredicatePF2e("item:group:pick").test(t),getNewValue:t=>t*2}]},level:9,name:"PF2E.WeaponPropertyRune.grievous.Name",price:700,rarity:"common",slug:"grievous",traits:["magical"]},hauling:{level:6,name:"PF2E.WeaponPropertyRune.hauling.Name",price:225,rarity:"uncommon",slug:"hauling",traits:["magical"]},holy:{level:11,name:"PF2E.WeaponPropertyRune.holy.Name",price:1400,rarity:"common",slug:"holy",traits:["holy","magical"],damage:{dice:[{damageType:"spirit",diceNumber:1,dieSize:"d4",predicate:[{not:"target:trait:unholy"}]},{damageType:"spirit",diceNumber:2,dieSize:"d4",predicate:["target:trait:unholy"]}]},strikeAdjustments:[{adjustTraits:(t,e)=>{e.includes("holy")||e.push("holy")}}]},hopeful:{attack:{notes:[{outcome:["criticalSuccess"],title:"PF2E.WeaponPropertyRune.hopeful.Name",text:"PF2E.WeaponPropertyRune.hopeful.Note.criticalSuccess"}]},level:11,name:"PF2E.WeaponPropertyRune.hopeful.Name",price:1200,rarity:"uncommon",slug:"hopeful",traits:["magical"]},hooked:{level:5,name:"PF2E.WeaponPropertyRune.hooked.Name",price:140,rarity:"rare",slug:"hooked",traits:["magical"],strikeAdjustments:[{adjustWeapon:t=>{t.system.traits.value.includes("trip")||t.system.traits.value.push("trip")}}]},impactful:{damage:{dice:[{damageType:"force",diceNumber:1,dieSize:"d6"}],notes:[{outcome:["criticalSuccess"],title:"PF2E.WeaponPropertyRune.impactful.Name",text:"PF2E.WeaponPropertyRune.impactful.Note.criticalSuccess"}]},level:10,name:"PF2E.WeaponPropertyRune.impactful.Name",price:1e3,rarity:"common",slug:"impactful",traits:["force","magical"]},impossible:{level:20,name:"PF2E.WeaponPropertyRune.impossible.Name",price:7e4,rarity:"common",slug:"impossible",traits:["magical"],strikeAdjustments:[{adjustWeapon:t=>{if(t.isOfType("weapon")&&t.system.range&&t._source.system.range){let e=t._source.system.range,n=t.system.range;t.system.range=e*2+Math.abs(n-e)}}}]},keen:{attack:{},level:13,name:"PF2E.WeaponPropertyRune.keen.Name",price:3e3,rarity:"uncommon",slug:"keen",traits:["magical"]},kinWarding:{level:3,name:"PF2E.WeaponPropertyRune.kinWarding.Name",price:52,rarity:"uncommon",slug:"kinWarding",traits:["dwarf","magical"]},majorFanged:{level:15,name:"PF2E.WeaponPropertyRune.majorFanged.Name",price:6e3,rarity:"uncommon",slug:"majorFanged",traits:["magical"]},majorRooting:{level:15,name:"PF2E.WeaponPropertyRune.majorRooting.Name",price:6500,rarity:"common",slug:"majorRooting",traits:["plant","magical","wood"],damage:{notes:[{outcome:["criticalSuccess"],title:"PF2E.WeaponPropertyRune.majorRooting.Name",text:"PF2E.WeaponPropertyRune.majorRooting.Note.criticalSuccess"}]}},merciful:{strikeAdjustments:[{adjustWeapon:t=>{t.system.traits.value.includes("nonlethal")||t.system.traits.value.push("nonlethal")}}],level:4,name:"PF2E.WeaponPropertyRune.merciful.Name",price:70,rarity:"common",slug:"merciful",traits:["magical","mental"]},pacifying:{level:5,name:"PF2E.WeaponPropertyRune.pacifying.Name",price:150,rarity:"uncommon",slug:"pacifying",traits:["magical"]},returning:{attack:{notes:[{title:"PF2E.WeaponPropertyRune.returning.Name",text:"PF2E.WeaponPropertyRune.returning.Note"}]},level:3,name:"PF2E.WeaponPropertyRune.returning.Name",price:55,rarity:"common",slug:"returning",traits:["magical"]},rooting:{level:7,name:"PF2E.WeaponPropertyRune.rooting.Name",price:360,rarity:"common",slug:"rooting",traits:["plant","magical","wood"],damage:{notes:[{outcome:["criticalSuccess"],title:"PF2E.WeaponPropertyRune.rooting.Name",text:"PF2E.WeaponPropertyRune.rooting.Note.criticalSuccess"}]}},serrating:{damage:{dice:[{damageType:"slashing",diceNumber:1,dieSize:"d4"}]},level:10,name:"PF2E.WeaponPropertyRune.serrating.Name",price:1e3,rarity:"uncommon",slug:"serrating",traits:["magical"]},shifting:{level:6,name:"PF2E.WeaponPropertyRune.shifting.Name",price:225,rarity:"common",slug:"shifting",traits:["magical"]},shock:{damage:{dice:[{damageType:"electricity",diceNumber:1,dieSize:"d6"}],notes:[{outcome:["criticalSuccess"],title:"PF2E.WeaponPropertyRune.shock.Name",text:"PF2E.WeaponPropertyRune.shock.Note.criticalSuccess"}]},level:8,name:"PF2E.WeaponPropertyRune.shock.Name",price:500,rarity:"common",slug:"shock",traits:["electricity","magical"]},speed:{level:16,name:"PF2E.WeaponPropertyRune.speed.Name",price:1e4,rarity:"rare",slug:"speed",traits:["magical"]},spellStoring:{level:13,name:"PF2E.WeaponPropertyRune.spellStoring.Name",price:2700,rarity:"uncommon",slug:"spellStoring",traits:["magical"]},swarming:{level:9,name:"PF2E.WeaponPropertyRune.swarming.Name",price:700,rarity:"common",slug:"swarming",traits:["magical"]},thundering:{damage:{dice:[{damageType:"sonic",diceNumber:1,dieSize:"d6"}],notes:[{outcome:["criticalSuccess"],title:"PF2E.WeaponPropertyRune.thundering.Name",text:"PF2E.WeaponPropertyRune.thundering.Note.criticalSuccess"}]},level:8,name:"PF2E.WeaponPropertyRune.thundering.Name",price:500,rarity:"common",slug:"thundering",traits:["magical","sonic"]},trueRooting:{level:19,name:"PF2E.WeaponPropertyRune.trueRooting.Name",price:4e4,rarity:"common",slug:"trueRooting",traits:["plant","magical","wood"],damage:{notes:[{outcome:["criticalSuccess"],title:"PF2E.WeaponPropertyRune.trueRooting.Name",text:"PF2E.WeaponPropertyRune.trueRooting.Note.criticalSuccess"}]}},underwater:{level:3,name:"PF2E.WeaponPropertyRune.underwater.Name",price:50,rarity:"common",slug:"underwater",traits:["magical","water"]},unholy:{level:11,name:"PF2E.WeaponPropertyRune.unholy.Name",price:1400,rarity:"common",slug:"unholy",traits:["unholy","magical"],damage:{dice:[{damageType:"spirit",diceNumber:1,dieSize:"d4",predicate:[{not:"target:trait:holy"}]},{damageType:"spirit",diceNumber:2,dieSize:"d4",predicate:["target:trait:holy"]}]},strikeAdjustments:[{adjustTraits:(t,e)=>{e.includes("unholy")||e.push("unholy")}}]},vorpal:{level:17,name:"PF2E.WeaponPropertyRune.vorpal.Name",price:15e3,rarity:"rare",slug:"vorpal",traits:["magical"]},wounding:{damage:{dice:[{damageType:"bleed",diceNumber:1,dieSize:"d6"}]},level:7,name:"PF2E.WeaponPropertyRune.wounding.Name",price:340,rarity:"common",slug:"wounding",traits:["magical"]}};function bn(t){return t.flatMap(e=>Kn[e].strikeAdjustments??[])}a(bn,"getPropertyRuneStrikeAdjustments");async function Tn(t){let[e,n]=canvas.ready&&!t.viewOnly?[canvas.tokens.controlled.find(v=>v.actor===this)??this.getActiveTokens().shift()??null,t.target?.token??t.target?.actor?.getActiveTokens().shift()??null]:[null,null],i=["attack","attack-roll","attack-damage"].some(v=>t.domains.includes(v)),r=!!(t.melee||t.item?.isOfType("weapon","melee")&&t.item.isMelee),o=r&&t.item?.isOfType("action","weapon","melee")?this.getReach({action:"attack",weapon:t.item}):this.getReach({action:"attack"}),s=!!(i&&r&&typeof o=="number"&&n?.actor&&e?.isFlanking(n,{reach:o})),c=await bt({affects:"origin",origin:this,target:t.target?.actor??n?.actor??null,item:t.item??null,domains:t.domains,options:[...t.options,...t.item?.getRollOptions("item")??[]]}),l=(()=>{let v=n?this.synthetics.tokenMarks.get(n.document.uuid):null;return v?`target:mark:${v}`:null})(),u=t.viewOnly||!n?.actor?this:this.getContextualClone(Ee.compact([...Array.from(t.options),...n.actor.getSelfRollOptions("target"),l,s?"self:flanking":null]),c),d=t.statistic instanceof game.pf2e.StatisticModifier,p=d?u.system.actions?.flatMap(v=>[v,v.altUsages??[]].flat())??[]:[],g=t.viewOnly?t.statistic:d?p.find(v=>t.item?.id!==v.item.id||t?.item.name!==v.item.name?!1:t.item.isOfType("melee")&&v.item.isOfType("melee")?!0:t.item.isOfType("weapon")&&v.item.isOfType("weapon")&&t.item.isMelee===v.item.isMelee)??t.statistic:t.statistic,f=(()=>{if(u===this)return t.item??null;if(g&&"item"in g&&g.item instanceof Item&&g.item.isOfType("action","melee","spell","weapon"))return g.item;let v=u.items.get(t.item?.id??"");return v?.isOfType("melee","spell","weapon")?v:t.item??null})(),m=f?.getRollOptions("item")??[],S=(()=>{let v=Ee.compact([t.traits].flat());if(f?.isOfType("weapon","melee")){let T=[u.synthetics.strikeAdjustments,bn(f.system.runes.property)].flat();for(let w of T)w.adjustTraits?.(f,v)}return Ee.uniq(v).sort()})(),x=e&&n?e.distanceTo(n):null,[b,k]=typeof x=="number"?[`origin:distance:${x}`,`target:distance:${x}`]:[null,null],C=a(v=>{let T=v?.getSelfRollOptions("target")??[];return n&&(T.push("target"),l&&T.push(l)),T.sort()},"getTargetRollOptions"),R=C(n?.actor),I=await bt({affects:"target",origin:u,target:n?.actor??null,item:f,domains:t.domains,options:[...t.options,...m,...R]});if(e?.actor&&n?.actor&&!t.viewOnly){let v=ie(e,n,{extraOptions:m,distance:x}),T=oe(e,n,{perception:v,affects:"origin"});T&&G(v,"target","visibility","noff",T)&&(T=void 0),P[T]>P.concealed&&I.push(At(T));let w=ot(e,n,{perception:v,affects:"target",options:m}),j;if(w){let q=G(v,"target","cover","ac",w)?.first();q!=null&&(q=Math.clamped(Je(q),0,4)),q===0?w=void 0:q&&(j=q)}N[w]>N.none&&I.push(ge(w,j))}if(s&&Sn(n.actor,u)){let v=game.i18n.localize("PF2E.Item.Condition.Flanked"),T=game.pf2e.ConditionManager.getCondition("off-guard",{name:v});I.push(T.toObject())}let E=(()=>{let v=e?n?.actor?.synthetics.tokenMarks.get(e.document.uuid):null;return v?`origin:mark:${v}`:null})(),F=t.viewOnly?null:(t.target?.actor??n?.actor)?.getContextualClone(Ee.compact([...u.getSelfRollOptions("origin"),...t.options,...m,...b?[b]:[],E]),I)??null,U=new Set(Ee.compact([...t.options,...u.getRollOptions(t.domains),...F?C(F):R,...m,i?"attack":null]).sort());k&&U.add(k);let de=f?En(f,x):null;de&&U.add(`target:range-increment:${de}`);let st={actor:u,token:e?.document??null,statistic:g,item:f,modifiers:[]},A=F&&n&&x!==null?{actor:F,token:n.document,distance:x,rangeIncrement:de}:null;return{options:U,self:st,target:A,traits:S}}a(Tn,"getRollContext");var Yn=["cover","concealed","hidden","undetected","unnoticed"],$e=class extends FormApplication{static get defaultOptions(){return foundry.utils.mergeObject(super.defaultOptions,{template:Q("icon-path-menu"),title:h("settings.icon-path.name"),width:500})}getData(){let e=O("icon-path");return{icons:Yn.map(i=>({name:i,placeholder:Le[i],value:e[i]??"",label:i==="cover"?h("icon-path.cover"):game.i18n.localize(CONFIG.PF2E.conditionTypes[i])})),i18n:h}}activateListeners(e){super.activateListeners(e),e.find("button[name=cancel]").on("click",n=>{n.prefentDefault(),this.close()})}async _updateObject(e,n){_e("icon-path",n)}};a($e,"IconPathMenu");function Rn(){z("icon-path",Object,{},{config:!1}),game.settings.registerMenu(y,"icon-path-menu",{name:W("icon-path","name"),label:W("icon-path","label"),icon:"fa-solid fa-list",restricted:!0,type:$e}),z("permission",String,CONST.USER_ROLES.GAMEMASTER,{choices:{1:W("permission","choices.1"),2:W("permission","choices.2"),3:W("permission","choices.3"),4:W("permission","choices.4")}}),z("npc-vision",Boolean,!1),z("target",Boolean,!0,{onChange:()=>ui.combat?.render()}),z("lesser",String,"ten",{choices:{none:W("lesser","choices.none"),cross:W("lesser","choices.cross"),zero:W("lesser","choices.zero"),ten:W("lesser","choices.ten"),twenty:W("lesser","choices.twenty")}}),z("standard",Boolean,!0),z("dead-cover",Boolean,!0),z("prone-cover",Boolean,!0),z("standard-type",String,"center",{choices:{center:W("standard-type","choices.center"),points:W("standard-type","choices.points")}}),z("skip-cover",Boolean,!0),z("validation",String,"all",{choices:{all:W("validation","choices.all"),selected:W("validation","choices.selected"),changed:W("validation","choices.changed")}}),z("flat-check",String,"roll",{choices:{none:W("flat-check","choices.none"),roll:W("flat-check","choices.roll"),cancel:W("flat-check","choices.cancel")}}),z("encounter",Boolean,!1)}a(Rn,"registerSettings");function W(t,e){return`${y}.settings.${t}.${e}`}a(W,"path");function z(t,e,n,i={}){game.settings.register(y,t,{name:W(t,"name"),hint:W(t,"hint"),scope:"world",config:!0,type:e,default:n,...i})}a(z,"register");var qn="game.pf2e.Check.roll",Qn="CONFIG.Token.documentClass.prototype.rulesBasedVision",Zn="CONFIG.MeasuredTemplate.objectClass.prototype.highlightGrid",Jn="CONFIG.Actor.documentClass.prototype.getRollContext",Xn="CONFIG.PF2E.Actor.documentClasses.npc.prototype.visionLevel",ei="DetectionMode.prototype.testVisibility",ti="CONFIG.Canvas.detectionModes.basicSight._canDetect",ni="CONFIG.Canvas.detectionModes.hearing._canDetect",ii="CONFIG.Canvas.detectionModes.feelTremor._canDetect";Hooks.once("init",()=>{Rn(),un(),Kt(),libWrapper.register(y,qn,pn),libWrapper.register(y,Zn,Bt,"OVERRIDE"),libWrapper.register(y,Qn,nn,"OVERRIDE"),libWrapper.register(y,Jn,Tn,"OVERRIDE"),libWrapper.register(y,Xn,Dt,"OVERRIDE"),libWrapper.register(y,ei,yn,"OVERRIDE"),libWrapper.register(y,ti,hn,"OVERRIDE"),libWrapper.register(y,ni,vn,"OVERRIDE"),libWrapper.register(y,ii,Pn,"OVERRIDE"),game.data.users.find(e=>e._id===game.data.userId).role>=CONST.USER_ROLES.GAMEMASTER?(Hooks.on("renderSceneConfig",Vt),Hooks.on("renderCombatTrackerConfig",fn)):Hooks.on("renderCombatTracker",gn),game.modules.get(y).custom={getWallCover:void 0}});Hooks.once("ready",()=>{game.modules.get(y).api=dn,Hooks.on("renderChatMessage",Pt);for(let t of document.querySelectorAll("#chat-log .chat-message")){let e=game.messages.get(t.dataset.messageId);e&&Pt(e,$(t))}game.user.isGM&&game.modules.get("pf2e-rules-based-npc-vision")?.active&&ui.notifications.error(`${y}.warning.npc-vision`,{permanent:!0,localize:!0})});Hooks.on("hoverToken",Xt);Hooks.on("pasteToken",Qt);Hooks.on("updateToken",Jt);Hooks.on("deleteToken",en);Hooks.on("controlToken",tn);Hooks.on("renderTokenHUD",qt);Hooks.on("preCreateToken",on);Hooks.on("canvasPan",()=>le());Hooks.on("renderCheckModifiersDialog",mn);Hooks.on("preCreateMeasuredTemplate",Ht);Hooks.on("createMeasuredTemplate",Qe);Hooks.on("updateMeasuredTemplate",Qe);Hooks.on("deleteMeasuredTemplate",Qe);})();
//# sourceMappingURL=main.js.map
