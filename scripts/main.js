(()=>{var xt=Object.defineProperty;var Nn=(t,e,n)=>e in t?xt(t,e,{enumerable:!0,configurable:!0,writable:!0,value:n}):t[e]=n;var a=(t,e)=>xt(t,"name",{value:e,configurable:!0});var Re=(t,e,n)=>(Nn(t,typeof e!="symbol"?e+"":e,n),n),Cn=(t,e,n)=>{if(!e.has(t))throw TypeError("Cannot "+n)};var xe=(t,e,n)=>{if(e.has(t))throw TypeError("Cannot add the same private member more than once");e instanceof WeakSet?e.add(t):e.set(t,n)};var K=(t,e,n)=>(Cn(t,e,"access private method"),n);var fe="Compendium.pf2e.other-effects.Item.I9lfZUiCwMiGogVi",P={[void 0]:0,observed:0,concealed:1,hidden:2,undetected:3,unnoticed:4},ce=["observed","concealed","hidden","undetected","unnoticed"],B=["none","lesser","standard","greater","greater-prone"],R={[void 0]:0,none:0,lesser:1,standard:2,greater:3,"greater-prone":4},V={cover:"none",visibility:"observed"},ye=["attack-roll","spell-attack-roll"],Ft=[...ye,"skill-check","perception-check"],Ve={cover:"modules/pf2e-perception/images/cover.webp",concealed:"systems/pf2e/icons/conditions/concealed.webp",hidden:"systems/pf2e/icons/conditions/hidden.webp",undetected:"systems/pf2e/icons/conditions/undetected.webp",unnoticed:"systems/pf2e/icons/conditions/unnoticed.webp"},Fe={BLINDED:0,NORMAL:1,LOWLIGHT:2,DARKVISION:3},ut="#000000",dt="#656665",Nt="#809e71",Ct=["darkness","dance-of-darkness","ravenous-darkness"],It=["obscuring-mist","stinking-cloud","noxious-vapors"];var f="pf2e-perception";function Q(t){return`modules/${f}/templates/${t}.hbs`}a(Q,"templatePath");function h(...t){let e=t.at(-1),n=typeof e=="object",i=n?t.slice(0,-1):t;return i.unshift(f),game.i18n[n?"format":"localize"](i.join("."),e)}a(h,"localize");function w(t,e){return t.getFlag(f,e)}a(w,"getFlag");function pt(t,e,n){return t.setFlag(f,e,n)}a(pt,"setFlag");function Ot(t,e){return t.unsetFlag(f,e,!0)}a(Ot,"unsetFlag");function Wt(t){return getProperty(t,`flags.${f}`)??{}}a(Wt,"getFlags");function C(t){return game.settings.get(f,t)}a(C,"getSetting");function ze(t,e){return game.settings.set(f,t,e)}a(ze,"setSetting");function At(){return game.user.role>=C("permission")}a(At,"hasPermission");function Dt(t){let n=game.pf2e.ConditionManager.getCondition("off-guard").toObject();return n.name+=` (${game.i18n.localize(`PF2E.condition.${t}.name`)})`,n}a(Dt,"createFlatFootedSource");function he(t,e){return e??=R[t]===3?4:R[t],{_id:"I9lfZUiCwMiGogVi",img:"systems/pf2e/icons/conditions-2/status_acup.webp",name:h("cover",t),system:{description:{gm:"",value:"<p>When you're behind an obstacle that could block weapons, guard you against explosions, and make you harder to detect, you're behind cover. Standard cover gives you a +2 circumstance bonus to AC, to Reflex saves against area effects, and to Stealth checks to Hide, Sneak, or otherwise avoid detection. You can increase this to greater cover using the Take Cover basic action, increasing the circumstance bonus to +4. If cover is especially light, typically when it's provided by a creature, you have lesser cover, which grants a +1 circumstance bonus to AC. A creature with standard cover or greater cover can attempt to use Stealth to Hide, but lesser cover isn't sufficient.</p>"},rules:[{domain:"all",key:"RollOption",option:`self:cover-bonus:${e}`},{domain:"all",key:"RollOption",option:`self:cover-level:${t}`},{key:"FlatModifier",predicate:[{or:[{and:["self:condition:prone","item:ranged"]},{not:"self:cover-level:greater-prone"}]}],selector:"ac",type:"circumstance",value:e},{key:"FlatModifier",predicate:["area-effect",{not:"self:cover-level:greater-prone"}],selector:"reflex",type:"circumstance",value:e},{key:"FlatModifier",predicate:[{or:["action:hide","action:sneak","avoid-detection"]},{not:"self:cover-level:greater-prone"}],selector:"stealth",type:"circumstance",value:e},{key:"FlatModifier",predicate:["action:avoid-notice",{not:"self:cover-level:greater-prone"}],selector:"initiative",type:"circumstance",value:e}],slug:"effect-cover"},type:"effect",flags:{core:{sourceId:fe},[f]:{level:t,bonus:e}}}}a(he,"createCoverSource");function je(t,e=void 0){if(t)return t.system.rules.find(n=>n.key==="ChoiceSet"&&(!e||n.flag===e))}a(je,"findChoiceSetRule");function Ne(t,e=!1){if(!t)return;let n=t.id,i=t.isToken;return(e?game.user.targets:canvas.tokens.controlled).find(o=>i?o.actor===t:o.actor.id===n)??t.getActiveTokens().shift()??null}a(Ne,"getActorToken");function Z(t){return t.itemTypes.condition.some(e=>e.slug==="prone")}a(Z,"isProne");function ee(t,e=!1){let n=t.itemTypes.effect.find(i=>i.sourceId===fe);return e?je(n)?.selection.level:n}a(ee,"getCoverEffect");function wt(){let t=this.system.perception.senses.map(n=>n.type),e=this.rules.filter(n=>n.key==="Sense").map(n=>n.selector.toLowerCase());return t.push(...e),this.getCondition("blinded")?Fe.BLINDED:t.includes("darkvision")||t.includes("greaterdarkvision")?Fe.DARKVISION:t.includes("lowlightvision")?Fe.LOWLIGHT:Fe.NORMAL}a(wt,"npcVisionLevel");function $t(t,e){return!t||!e||!t.system.perception?.senses?!1:(e=e.toLowerCase(),!!t.system.perception.senses.find(({type:n})=>n===e))}a($t,"hasSense");function Ge(t){return $t(t,"greaterdarkvision")}a(Ge,"hasGreaterDarkvision");function Ue(t){return $t(t,"seeinvisibility")}a(Ue,"seeInvisibility");var Be={LOWER_BY_TWO:-2,LOWER:-1,INCREASE:1,INCREASE_BY_TWO:2,TO_CRITICAL_FAILURE:"criticalFailure",TO_FAILURE:"failure",TO_SUCCESS:"success",TO_CRITICAL_SUCCESS:"criticalSuccess"},_t=["criticalFailure","failure","success","criticalSuccess"],Ke,Lt,ve,He,le,Ce,qe,Mt,te=class{constructor(e,n,i=null){xe(this,Ke);xe(this,ve);xe(this,le);xe(this,qe);e instanceof Roll?(this.dieResult=(e.isDeterministic?e.terms.find(r=>r instanceof NumericTerm):e.dice.find(r=>r instanceof Die&&r.faces===20))?.total??1,this.rollTotal=e.total):(this.dieResult=e.dieValue,this.rollTotal=e.dieValue+e.modifier),this.dc=typeof n=="number"?{value:n}:n,this.unadjusted=K(this,qe,Mt).call(this),this.adjustment=K(this,Ke,Lt).call(this,this.unadjusted,i),this.value=this.adjustment?K(this,ve,He).call(this,this.adjustment.amount,this.unadjusted):this.unadjusted}},M=te;a(M,"DegreeOfSuccess"),Ke=new WeakSet,Lt=a(function(e,n){if(!n)return null;for(let i of["all",..._t]){let{label:r,amount:o}=n[i]??{};if(o&&r&&!(e===te.CRITICAL_SUCCESS&&o===Be.INCREASE)&&!(e===te.CRITICAL_FAILURE&&o===Be.LOWER)&&(i==="all"||_t.indexOf(i)===e))return{label:r,amount:o}}return null},"#getDegreeAdjustment"),ve=new WeakSet,He=a(function(e,n){switch(e){case"criticalFailure":return 0;case"failure":return 1;case"success":return 2;case"criticalSuccess":return 3;default:return Math.clamped(n+e,0,3)}},"#adjustDegreeOfSuccess"),le=new WeakSet,Ce=a(function(e){return this.dieResult===20?K(this,ve,He).call(this,Be.INCREASE,e):this.dieResult===1?K(this,ve,He).call(this,Be.LOWER,e):e},"#adjustDegreeByDieValue"),qe=new WeakSet,Mt=a(function(){let e=this.dc.value;return this.rollTotal-e>=10?K(this,le,Ce).call(this,te.CRITICAL_SUCCESS):e-this.rollTotal>=10?K(this,le,Ce).call(this,te.CRITICAL_FAILURE):this.rollTotal>=e?K(this,le,Ce).call(this,te.SUCCESS):K(this,le,Ce).call(this,te.FAILURE)},"#calculateDegreeOfSuccess"),Re(M,"CRITICAL_FAILURE",0),Re(M,"FAILURE",1),Re(M,"SUCCESS",2),Re(M,"CRITICAL_SUCCESS",3);function Vt(t,e){let n="",i=["standard","npc-vision"];for(let o of i){let s=Pe(t.object,o);n+=`<div class="form-group pf2e-perception-injected">
    <label>${h(`settings.${o}.name`)}</label>
    <input type="checkbox" name="flags.pf2e-perception.${o}" ${s?"checked":""}>
    <p class="notes">${h(`settings.${o}.short`)}</p>
</div>`}n+="<hr>",e.find('.tab[data-tab="basic"] hr').first().after(n);let r=e.find(".pf2e-perception-injected").toArray().reduce((o,s)=>(o+=s.clientHeight,o),0);t.setPosition({top:t.position.top-r/2})}a(Vt,"renderSceneConfig");function z(t){if(t=t instanceof Token?t.document:t,!(t instanceof TokenDocument))return[];let e=t.scene.tokens.filter(n=>n!==t&&n.actor?.isOfType("creature"));if(C("encounter")){let n=game.combats.active;return n?e.filter(i=>{let r=i.actor,o=r.traits;return r.type==="familiar"||o.has("minion")||o.has("eidolon")||n.getCombatantByToken(i.id)}):e}return e}a(z,"getValidTokens");function ne(t,e){let n=z(t).map(i=>i.id);return e.filter(i=>{let r=i instanceof Token||i instanceof TokenDocument?i.id:i;return n.includes(r)})}a(ne,"validateTokens");function Pe(t,e){return w(t,e)??C(e)}a(Pe,"getSceneSetting");async function mt({affects:t,origin:e,target:n,item:i,domains:r,options:o}){if(!(e&&n))return[];let[s,c]=t==="target"?[e,n]:[n,e],l=[...o,s.getRollOptions(r),c.getSelfRollOptions(t)].flat(),p=i?i.isOfType("spell")?{spell:i}:{weapon:i}:{};return(await Promise.all(r.flatMap(u=>s.synthetics.ephemeralEffects[u]?.[t]??[]).map(u=>u({test:l,resolvables:p})))).flatMap(u=>u??[])}a(mt,"extractEphemeralEffects");function zt(t,e){if(!t.isOfType("action","melee","weapon"))return null;let{increment:n}=t.range??{};return n&&typeof e=="number"?Math.max(Math.ceil(e/n),1):null}a(zt,"getRangeIncrement");function jt(t,e){if(!t?.isOfType("creature"))return!1;let{flanking:n}=t.attributes;return n.flankable?typeof n.offGuardable=="number"?e.level>n.offGuardable:n.offGuardable:!1}a(jt,"isOffGuardFromFlanking");function Gt(t,e){return t.includes(e)}a(Gt,"tupleHasValue");function In(t,e){return canvas.dimensions?canvas.grid.type!==CONST.GRID_TYPES.SQUARE?canvas.grid.measureDistance(t,e):On(new Ray(t,e)):NaN}a(In,"measureDistance");function On(t,{reach:e=null}={}){if(!canvas.dimensions)return NaN;let n=canvas.dimensions.size,i=canvas.dimensions.distance,r=Math.ceil(Math.abs(t.dx/n)),o=Math.ceil(Math.abs(t.dy/n)),s=Math.ceil(Math.abs((t.dz||0)/n)),c=[r,o,s].sort((d,m)=>d-m),l={doubleDiagonal:c[0],diagonal:c[1]-c[0],straight:c[2]-c[1]},p=l.diagonal+l.doubleDiagonal>1&&e===10?1:0;return(Math.floor(l.doubleDiagonal*1.75+l.diagonal*1.5+l.straight)-p)*i}a(On,"measureDistanceOnGrid");function Ut({areaType:t,object:e,colors:n,document:i,collisionType:r="move",preview:o=!1,collisionOrigin:s}){if(!e.id&&!o)return;let{grid:c,dimensions:l}=canvas;if(!(c&&l))return;let p=i.angle??0,u=i.direction??45,d=c.getHighlightLayer(e.highlightId)?.clear();if(!d)return;let[m,g]=c.getCenter(i.x,i.y),[y,S]=c.grid.getGridPositionFromPixels(m,g),O=(360+(u-p*.5)%360)%360,b=(360+(u+p*.5)%360)%360,k=canvas.grid.getSnappedPosition(i.x,i.y,e.layer.gridPrecision),x=a((A,_,D)=>(A=(360+A%360)%360,_=(360+_%360)%360,D=(360+D%360)%360,A<_?D>=A&&D<=_:D>=A||D<=_),"withinAngle"),T=(()=>{if(t!=="cone")return{x:0,y:0};let A=(u>=0?360-u:-u)%360,_=k.x%l.size!==0?Math.sign(1*Math.round(Math.cos(Math.toRadians(A))*100)/100)/2:0,D=k.y%l.size!==0?-Math.sign(1*Math.round(Math.sin(Math.toRadians(A))*100)/100)/2:0;return{x:_*l.size,y:D*l.size}})(),W=Math.clamped(i.width??0,1.5,2),E=i.distance??0,F=E*W/l.distance,G=Math.ceil(F/(l.size/c.h)),ae=Math.ceil(F/(l.size/c.w)),Te=a(A=>{if(!(t==="emanation"&&e instanceof Token))return{x:0,y:0};if(e.w<=l.size)return{x:0,y:0};let _=(e.w-l.size)/2,D=a((v,N)=>N===v?0:N>v?_:-_,"getCoordinate");return{x:D(e.center.x,A.x),y:D(e.center.y,A.y)}},"offsetEmanationOrigin");for(let A=-ae;A<ae;A++)for(let _=-G;_<G;_++){let[D,v]=canvas.grid.grid.getPixelsFromGridPosition(y+A,S+_),N={x:D+l.size*.5,y:v+l.size*.5};if(N.x<0||N.y<0)continue;let H=Te(N),ge={x:k.x+T.x+H.x,y:k.y+T.y+H.y};if(t==="cone"){let Rt=new Ray(ge,N),Fn=(360+Rt.angle/(Math.PI/180)%360)%360;if(Rt.distance>0&&!x(O,b,Fn))continue}if(In(N,ge)>E)continue;canvas.ready&&CONFIG.Canvas.polygonBackends[r].testCollision(s??ge,N,{type:r,mode:"any"})?(c.grid.highlightGridPosition(d,{x:D,y:v,border:1,color:0}),d.beginFill(0,.5).moveTo(D,v).lineTo(D+l.size,v+l.size).endFill()):c.grid.highlightGridPosition(d,{x:D,y:v,border:n.border,color:n.fill})}}a(Ut,"highlightGrid");var Wn={burst:"circle",emanation:"circle",line:"ray",cone:"cone",rect:"rect",cube:"rect",square:"rect"};function Ye({type:t="burst",token:e,distance:n}){gt(e)&&(n??=t==="cone"?30:15,ft({type:t,distance:n,traits:["concentrate","secret"],flags:{type:"seek",tokenId:e.id,collisionType:"sight",collisionOrigin:e.center}}))}a(Ye,"createSeekTemplate");function Bt({type:t="burst",distance:e=20,conceal:n=!1}={}){ft({type:t,distance:e,fillColor:ut,flags:{type:"darkness",conceal:n}})}a(Bt,"createDarknessTemplate");function Ht({type:t="burst",distance:e=20}={}){ft({type:t,distance:e,fillColor:dt,flags:{type:"mist"}})}a(Ht,"createMistTemplate");function Kt(t,e){return e&&!gt(e)?null:canvas.scene.templates.filter(n=>w(n,"type")===t)??[]}a(Kt,"getTemplates");function Qe(t){return Kt("darkness",t)}a(Qe,"getDarknessTemplates");function Ze(t){return Kt("mist",t)}a(Ze,"getMistTemplates");function Je(t){if(!gt(t))return null;let e=canvas.scene.templates.find(n=>w(n,"type")==="seek");return e?(t=t instanceof Token?t.document:t,ke(e,{collisionType:"sight",collisionOrigin:t.center})):null}a(Je,"getSeekTemplateTokens");async function J(t){let e=t.scene.templates.filter(n=>w(n,"type")==="seek"&&w(n,"tokenId")===t.id);for(let n of e)await n.delete()}a(J,"deleteSeekTemplate");function gt(t){return canvas.scene===t.scene?!0:(ui.notifications.error(h("template.scene")),!1)}a(gt,"checkScene");function ft({type:t,distance:e,traits:n,fillColor:i,width:r,flags:o}){let s=Wn[t],c={distance:e,t:s,fillColor:i||game.user.color,flags:{[f]:o}};switch(s){case"ray":c.width=r||CONFIG.MeasuredTemplate.defaults.width*(canvas.dimensions?.distance??1);break;case"cone":c.angle=CONFIG.MeasuredTemplate.defaults.angle;break;case"rect":{let l=c.distance??0;c.distance=Math.hypot(l,l),c.width=l,c.direction=45;break}}n&&setProperty(c,"flags.pf2e.origin.traits",n),canvas.templates.createPreview(c)}a(ft,"createTemplate");function ke(t,{collisionOrigin:e,collisionType:n="move"}={}){if(t=t instanceof MeasuredTemplateDocument?t.object:t,!canvas.scene)return[];let{grid:i,dimensions:r}=canvas;if(!(i&&r))return[];let o=i.getHighlightLayer(t.highlightId);if(!o||i.type!==CONST.GRID_TYPES.SQUARE)return[];let s=e??t.center,c=canvas.tokens.quadtree.getObjects(o.getLocalBounds(void 0,!0)),l=[];for(let p of c){let u=p.document,d=[];for(let m=0;m<u.height;m++){let g=p.y+m*i.size;if(d.push(`${p.x}.${g}`),u.width>1)for(let y=1;y<u.width;y++)d.push(`${p.x+y*i.size}.${g}`)}for(let m of d){if(!o.positions.has(m))continue;let[g,y]=m.split(".").map(b=>Number(b)),S={x:g+r.size*.5,y:y+r.size*.5};if(S.x<0||S.y<0)continue;if(!(canvas.ready&&n&&CONFIG.Canvas.polygonBackends[n].testCollision(s,S,{type:n,mode:"any"}))){l.push(p);break}}}return l}a(ke,"getTemplateTokens");function qt(){let t=["circle","cone"].includes(this.document.t),e=canvas.grid.type===CONST.GRID_TYPES.SQUARE;if(!t||!e)return MeasuredTemplate.prototype.highlightGrid.call(this);if(!this.isVisible){canvas.grid.getHighlightLayer(this.highlightId)?.clear();return}let n=w(this.document,"collisionType"),i=w(this.document,"collisionOrigin");this.snapForShape(),Ut({areaType:Gt(["burst","cone","emanation"],this.areaType)?this.areaType:"burst",object:this,document:this.document,colors:{border:this.borderColor,fill:this.fillColor},preview:!0,collisionType:n,collisionOrigin:i})}a(qt,"highlightTemplateGrid");function Yt(t){let{type:e,slug:n,castLevel:i=0}=t.getFlag("pf2e","origin")??{};e==="spell"&&(Ct.includes(n)?t.updateSource({fillColor:ut,[`flags.${f}`]:{type:"darkness",conceal:i>=4}}):It.includes(n)?t.updateSource({fillColor:dt,[`flags.${f}`]:{type:"mist"}}):n==="cloudkill"&&t.updateSource({fillColor:Nt,[`flags.${f}`]:{type:"mist"}}))}a(Yt,"preCreateMeasuredTemplate");function Xe(t){w(t,"type")==="darkness"&&canvas.perception.update({initializeVision:!0})}a(Xe,"onMeasuredTemplate");function Ee(t,e=1){let n=Object.getPrototypeOf(t);return e>1?Ee(n,e-1):n}a(Ee,"getPrototype");function et(t,e){return t.name.localeCompare(e.name)}a(et,"sortByName");function tt(t){return t=Number(t),isNaN(t)?void 0:t}a(tt,"asNumberOnly");var q=class extends Application{#e;#r;#t;#n;#i;constructor({token:e,resolve:n,selected:i=[]},r={}){super(r),this.#e=e,this.#r=n,this.#t=i,this.#i=(o,s)=>{let c=o.id,l=this.element.find("[data-token-id]");l.removeClass("hover"),s&&l.filter(`[data-token-id=${c}]`).addClass("hover")},Hooks.on("hoverToken",this.#i)}async close(e={}){Hooks.off("hoverToken",this.#i),this.#r?.(e.resolve??!1),super.close(e)}static get defaultOptions(){return mergeObject(super.defaultOptions,{minimizable:!1})}static async openMenu(e,n={}){if(e.token instanceof TokenDocument&&(e.token=e.token.object),!e.token){ui.notifications.error(h("menu.no-token"));return}n.id=`${f}-${e.token.document.uuid}`;let i=Object.values(ui.windows).find(r=>r.id===n.id);return i&&i.close(),new Promise(r=>{e.resolve=r,new this(e,n).render(!0)})}static createPropertyData(e,n,i){let r=V[i],o=e[i]??r,s=n[i]??r;return{original:o,current:s,changed:o!==s,custom:s!==r,originalCustom:o!==r}}get token(){return this.#e}get document(){return this.#e.document}get actor(){return this.#e.actor}get scene(){return this.#e.scene}get selected(){return this.#t.length?ne(this.token,this.#t):[]}get currentData(){return deepClone(this.#o)}get#o(){return this.#n||(this.#n=this.getSavedData()),this.#n}getSavedData(){let e=L(this.document)??{};return deepClone(e)}reset(){this.#n=this.getSavedData(),this.#t=[],this.render()}isSelected(e){let n=typeof e=="object"?e.id:e;return this.#t.includes(n)}getData(e){return{i18n:h,covers:B.map(n=>({value:n,label:h(`cover.${n}`)})),visibilities:ce.map(n=>({value:n,label:h(`visibility.${n}`)}))}}activateListeners(e){e.find("[data-token-id]").on("mouseenter",n=>{let{tokenId:i}=n.currentTarget.dataset,r=this.scene.tokens.get(i)?.object;!r||r.controlled||r._onHoverIn(n,{hoverOutOthers:!0})}),e.find("[data-action=close]").on("click",()=>{this.close({resolve:!0})}),e.find("select[name=visibility], select[name=cover]").on("change",n=>{let i=n.currentTarget,r=i.name,o=V[r],s=i.value||o,c=i.closest(".token")?.dataset.tokenId,l=c?[c]:this.#t;for(let p of l)setProperty(this.#o,`${p}.${r}`,s);c?(i.classList.toggle("changed",s!==i.dataset.original),i.classList.toggle("custom",s!==o)):this.render()}),e.find("[data-action=accept]").on("click",n=>{this._saveData(this.#o),this.close({resolve:!0})})}_saveData(e){nt(this.document,e)}_setSelected(e){this.#t=e??this.element.find("[data-token-id].ui-selected").toArray().map(n=>n.dataset.tokenId)}_spliIntoAlliances(e){let n=[],i=[],r=[],o=this.actor.alliance,s=o==="party"?"opposition":o==="opposition"?"party":null;for(let c of e)if(s){let l=c.actor?c.actor.alliance:c.alliance;l===o?n.push(c):l===s?i.push(c):l===null&&r.push(c)}else r.push(c);return{allies:n.sort(et),neutral:r.sort(et),enemies:i.sort(et),hasTokens:n.length||i.length||r.length}}};a(q,"BaseMenu");var Ie=class extends q{get title(){return h("menu.perception.title",{name:this.token.name})}get template(){return Q("perception")}getData(e){let n=this.selected,i=this.currentData,r=this.getSavedData(),o=z(this.token).map(({id:s,name:c,actor:l})=>{let p=i[s]??{},u=r[s]??{};return{id:s,name:c,alliance:l.alliance,cover:q.createPropertyData(u,p,"cover"),visibility:q.createPropertyData(u,p,"visibility"),selected:n.includes(s)}});return{...super.getData(e),...this._spliIntoAlliances(o)}}activateListeners(e){super.activateListeners(e),e.filter(".tokens").selectable({autoRefresh:!1,filter:".token",cancel:"header,select",stop:()=>this._setSelected()}),e.find("[data-action=select-all]").on("click",n=>{let i=$(n.currentTarget).closest("section"),r=(i.length?i:e).find("[data-token-id]"),o=r.filter(":not(.ui-selected)").length===0;r.toggleClass("ui-selected",!o),this._setSelected()}),e.find("[data-action=use-selection]").on("click",n=>{this._setSelected(canvas.tokens.controlled.map(i=>i.id)),this.render()}),e.find("[data-action=reset]").on("click",n=>this.reset())}};a(Ie,"PerceptionMenu");var An=[{x:.25,y:.25},{x:.5,y:.25},{x:.75,y:.25},{x:.25,y:.5},{x:.5,y:.5},{x:.75,y:.5},{x:.25,y:.75},{x:.5,y:.75},{x:.75,y:.75}];function it(t,e){let n=1-e;return{top:{A:X({x:e,y:e},t),B:X({x:n,y:e},t)},right:{A:X({x:n,y:e},t),B:X({x:n,y:n},t)},bottom:{A:X({x:n,y:n},t),B:X({x:e,y:n},t)},left:{A:X({x:e,y:n},t),B:X({x:e,y:e},t)}}}a(it,"getRectEdges");function Oe(t,e,n=!1){return n&&Y(t,e),CONFIG.Canvas.polygonBackends.move.testCollision(t,e,{type:"move",mode:"any"})}a(Oe,"lineIntersectWall");function ot(t,e,n=!1){for(let i of Dn(e.bounds))if(Oe(t,i,n))return!0;return!1}a(ot,"pointToTokenIntersectWall");function X(t,e){return{x:e.x+e.width*t.x,y:e.y+e.height*t.y}}a(X,"getRectPoint");function ue(){canvas.controls.debug.clear()}a(ue,"clearDebug");function Y(t,e,n="blue"){let i=n==="blue"?26316:n==="red"?16711680:1483011;canvas.controls.debug.lineStyle(4,i).moveTo(t.x,t.y).lineTo(e.x,e.y)}a(Y,"drawDebugLine");function*Dn(t){for(let e of An)yield X(e,t)}a(Dn,"rectSpread");function rt(t,e=!1){if(t=t instanceof Token?t:t.object,t.document.hasStatusEffect(CONFIG.specialStatusEffects.INVISIBLE))return;let n=t.scene;if(n!==canvas.scene||!n.tokenVision||n.darkness<n.globalLightThreshold)return;e&&ue();let i=t.document.center,r=null;for(let o of canvas.effects.lightSources){if(!o.active)continue;let s=o.data.bright,c=o.data.dim;if(o.object===t){if(s)return"bright";c&&(r="dim");continue}if(!o.shape.contains(i.x,i.y)){e&&Y(o,i,"red");continue}if(o.ratio===1)return e&&Y(o,i,"green"),"bright";if(o.ratio===0){e&&Y(o,i,"blue"),r="dim";continue}if(new Ray(o,i).distance<=s)if(e)Y(o,i,"green"),r="bright";else return"bright";else e?(Y(o,i,"blue"),r!=="bright"&&(r="dim")):r="dim"}return r}a(rt,"getLightExposure");var Se={cover:{cancel:{targets:["lesser","standard","greater","greater-prone"]},set:{targets:["none","lesser","standard","greater","greater-prone"],value:["none","lesser","standard","greater","greater-prone"]},reduce:{targets:["lesser","standard","greater","greater-prone"]},ignore:{targets:"string"},ignored:{targets:["allies","enemies"]},ac:{targets:["lesser","standard","greater","greater-prone"],value:["number"]}},visibility:{cancel:{targets:["concealed","hidden","undetected","unnoticed"]},set:{targets:["observed","concealed","hidden","undetected","unnoticed"],value:["observed","concealed","hidden","undetected","unnoticed"]},reduce:{targets:["concealed","hidden","undetected","unnoticed"]},noff:{targets:["hidden","undetected","unnoticed"]},noinvis:{},dc:{targets:["concealed","hidden"],value:["number","string"]}}},wn={cover:Object.keys(Se.cover),visibility:Object.keys(Se.visibility),all:[...Object.keys(Se.cover),...Object.keys(Se.visibility)]};function Qt(){let t=game.pf2e.RuleElements.builtin.RollOption.defineSchema(),e=t.predicate.constructor,n=t.value.constructor;class i extends game.pf2e.RuleElement{constructor(o,s){typeof o.targets=="string"&&(o.targets=[o.targets]),super({priority:CONST.ACTIVE_EFFECT_MODES.CUSTOM,...o},s);let c=wn[o.type];if(!c)return;if(!c?.includes(o.selector)){this.failValidation(`The type "${o.type}" only accepts the following selectors: ${c.join(", ")}.`);return}let l=Se[o.type]?.[o.selector];if(!l)return;let p=a(m=>{let{name:g,uuid:y}=this.item;console.warn(`PF2e System | PF2ePerception rules element on item ${g} (${y}) simple warning: ${m}`)},"selectorWarn"),u=Array.isArray(l.targets)?[...l.targets,"all"]:l.targets,d=Array.isArray(u)?u.join(", "):null;if(!u&&o.targets?.length){p(`The selector "${o.selector}" doesn't accept any targets property.`);return}if(o.selector==="ignore"&&!o.targets?.length){let m=`The selector "${o.selector}" requires a targets property with the ids of the tokens on the scene that should not give cover.`;this.failValidation(m);return}if(d&&o.targets?.some(m=>!u.includes(m))){let m=`The targets property of selector "${o.selector}" only accepts the following: ${d}.`;this.failValidation(m);return}else if(!d&&u&&o.targets?.some(m=>typeof m!==u)){let m=`The targets property of selector "${o.selector}" needs to be of type "${u}".`;this.failValidation(m);return}if(!l.value&&o.value){p(`The selector "${o.selector}" doesn't accept any value property.`);return}if(o.selector==="set"){if(!l.value.includes(o.value)){let m=l.value.join(", "),g=`The selector "${o.selector}" only accepts the following: ${m}.`;this.failValidation(g)}}else{let m=typeof o.value;if(l.value&&!l.value.includes(m)){let g=`The selector "${o.selector}" does not accept a value property of type ${m}.`;this.failValidation(g)}}}static defineSchema(){let{fields:o}=foundry.data;return{...super.defineSchema(),type:new o.StringField({required:!0,nullable:!1,blank:!1,choices:["visibility","cover"]}),affects:new o.StringField({required:!0,nullable:!1,blank:!1,initial:"self",choices:["self","other"]}),selector:new o.StringField({required:!0,nullable:!1,blank:!1}),targets:new o.ArrayField(new o.StringField({required:!0,nullable:!1,blank:!1,initial:void 0}),{required:!0,nullable:!1,initial:["all"]}),predicate:new e({required:!1,nullable:!1}),value:new n({required:!1,initial:void 0})}}test(o,s){return s?super.test(o):!1}addToPerception(o,s,c){if(!this.test(c,!0))return;let p=`${this.affects==="self"?o:o==="origin"?"target":"origin"}.${this.type}.${this.selector}`,u=Se[this.type][this.selector];if(!u.targets){setProperty(s,p,!0);return}let d=this.targets.includes("all")?u.targets:this.targets;if(!u.value){for(let m of d){let g=`${p}.${m}`;setProperty(s,g,!0)}return}for(let m of d){let g=`${p}.${m}`,y=getProperty(s,g);y?y.add(this.value):y=new Set([this.value]),setProperty(s,g,y)}}}a(i,"PF2ePerceptionRuleElement"),game.pf2e.RuleElements.custom.PF2ePerception=i}a(Qt,"setupRuleElement");function ie(t,e,{distance:n,extraOptions:i=[]}={}){let r=t.actor,o=e.actor;if(!r||!o)return{};let s={origin:r.rules.filter(d=>!d.ignored&&d.key==="PF2ePerception")??[],target:o.rules.filter(d=>!d.ignored&&d.key==="PF2ePerception")??[]};if(!s.origin.length&&!s.target.length)return{};let c={origin:r.getRollOptions(),target:o.getRollOptions()},l={origin:o.getSelfRollOptions("target"),target:r.getSelfRollOptions("origin")};t=t instanceof Token?t:t.object,e=e instanceof Token?e:e.object,n??=t.distanceTo(e);let p=[`origin:distance:${n}`,`target:distance:${n}`],u={};for(let d of["origin","target"]){let m=[...i,...c[d],...l[d],...p];for(let g of s[d])g.addToPerception(d,u,m)}return u}a(ie,"perceptionRules");function Zt(t){let e=t.actor;return e?(e.rules.filter(i=>!i.ignored&&i.key==="PF2ePerception"&&i.type==="cover"&&i.selector==="ignored")??[]).flatMap(i=>i.targets):[]}a(Zt,"getIgnoredPerception");function U(t,e,n,i,r){let o=t[e]?.[n]?.[i];return r?o?.[r]:o}a(U,"getPerception");function be(t,e,n,i){i===void 0&&(i=n==="cover"?"none":"observed");let r=n==="cover"?B:ce;if(i&&U(t,e,n,"cancel",i))return;let o=U(t,e,n,"set",i)?.first();if(o&&r.includes(o))i=o;else if(i&&U(t,e,n,"reduce",i)){let s=r.indexOf(i);i=r[Math.max(0,s-1)]}return i===r[0]?void 0:i}a(be,"updateFromPerceptionRules");function Jt(t,e){!At()||!t.object.actor?.isOfType("creature")||(e.find(".col.left").append('<div class="control-icon" data-action="pf2e-perception"><i class="fa-solid fa-eye"></i></div>'),e.find("[data-action=pf2e-perception]").on("click",n=>yt(t.object)))}a(Jt,"renderTokenHUD");function yt(t){return Ie.openMenu({token:t})}a(yt,"openHUD");function Xt(t,e){for(let n of e)delete n.flags?.[f]}a(Xt,"pasteToken");function L(t,...e){return e.unshift("data"),t=t instanceof Token?t.document:t,w(t,e.join("."))}a(L,"getTokenData");async function en(t){return t=t instanceof Token?t.document:t,Ot(t,"data")}a(en,"clearTokenData");async function nt(t,e){let n=z(t).map(r=>r.id),i={};for(let r in e){if(!n.includes(r)){i[`flags.${f}.data.-=${r}`]=!0;continue}let o=e[r],s=L(t,r)??{};if(o.visibility===V.visibility&&delete o.visibility,o.cover===V.cover&&delete o.cover,!(s.cover===o.cover&&s.visibility===o.visibility))if(!o.visibility&&!o.cover)i[`flags.${f}.data.-=${r}`]=!0;else for(let c of["cover","visibility"])s[c]!==o[c]&&(o[c]?i[`flags.${f}.data.${r}.${c}`]=o[c]:i[`flags.${f}.data.${r}.-=${c}`]=!0)}return t=t instanceof Token?t.document:t,t.update(i)}a(nt,"setTokenData");function at(t,e,n=!1){let i=t.scene;return Pe(i,"standard")?(n&&ue(),(C("standard-type")==="points"?ot(t.center,e,n):Oe(t.center,e.center,n))?"standard":void 0):void 0}a(at,"getWallCover");var de={tiny:0,sm:1,med:2,lg:3,huge:4,grg:5};function st(t,e,{perception:n={},options:i=[],affects:r="origin",debug:o=!1}={}){let s=i.includes("item:ranged")?Z(e.actor):!1,c=a(u=>be(n,r,"cover",u),"returnValue"),l=ee(e.actor,!0);if(s&&R[l]>R.lesser)return c("greater-prone");!s&&l==="greater-prone"&&(l=void 0);let p=L(e,t.id,"cover");if(s&&R[p]>R.lesser)return c("greater-prone");if(!s&&p==="greater-prone"&&(p=void 0),R[l]<R.standard){if(R[p]<R.standard){let u=game.modules.get(f).custom?.getWallCover,d;if(typeof u=="function"){let m=u(t,e,o);d=B.includes(m)?m:at(t,e,o)}else d=at(t,e,o);R[d]>R[p]&&(p=d)}if(R[p]<R.standard&&t.distanceTo(e)>5){let u=ht(t,e,{perception:n,debug:o});R[u]>R[p]&&(p=u)}}return s&&R[p]>R.lesser?c("greater-prone"):c(R[p]>R[l]?p:void 0)}a(st,"getCover");function ht(t,e,{perception:n={},debug:i=!1}={}){let r=C("lesser");if(r==="none")return;t=t instanceof Token?t.document:t,e=e instanceof Token?e.document:e;let o=(()=>{let E=Object.keys(n.origin?.cover?.ignore??{}),F=Object.keys(n.target?.cover?.ignore??{});return new Set([...E,...F])})(),s,c=t.center,l=e.center,p=t.actor,u=e.actor;i&&(ue(),Y(c,l));let d=a(E=>{let F=de[E.actor.size];return F-m>=2&&F-g>=2},"isExtraLarge"),m=de[p.size],g=de[u.size],y=p.alliance,S=C("dead-cover"),O=C("prone-cover"),b=t.scene.tokens.contents.filter(E=>{let F=E.actor,G=Zt(E);return F&&!E.hidden&&E!==t&&E!==e&&(O||!Z(F))&&(S||F.hitPoints?.value!==0)&&!o.has(E.id)&&!(G.includes("all")||G.includes(F.alliance===y?"allies":"enemies"))}).sort((E,F)=>de[F.actor.size]-de[E.actor.size]),k=m<de.huge&&g<de.huge&&b.filter(d).length,x=r==="ten"?.1:r==="twenty"?.2:0,T=a(E=>(i&&Y(E.A,E.B,"red"),lineSegmentIntersects(c,l,E.A,E.B)),"intersectsEdge"),W=r==="cross"?E=>T(E.top)&&T(E.bottom)||T(E.left)&&T(E.right):E=>Object.values(E).some(F=>T(F));for(let E of b){let F=E.object,G=it(F.bounds,x);if(W(G))return k?"standard":"lesser";d(E)&&k--}return s}a(ht,"getCreatureCover");function oe(t,e,{perception:n={},affects:i="origin",debug:r=!1}={}){t=t instanceof Token?t:t.object,e=e instanceof Token?e:e.object;let o=t.actor,s=e.actor,c=(()=>{if(!o||!s)return;let k;s.hasCondition("blinded")?k="hidden":s.hasCondition("dazzled")&&(k="concealed");for(let x of["unnoticed","undetected","hidden","concealed"])P[x]>P[k]&&o.hasCondition(x)&&(k=x);return k})(),l=a(k=>p?(P[k]<P.hidden&&(k="hidden"),(Ue(s)||U(n,i,"visibility","noinvis"))&&(k="concealed"),be(n,i,"visibility",k)):be(n,i,"visibility",k),"returnValue"),p=o?.hasCondition("invisible"),u=L(t,e.id,"visibility"),d=P[c]>P[u]?c:u;if(P[d]>=P.hidden||p)return l(d);let m=s?.hasLowLightVision,g=s?.hasDarkvision,y=s&&Ge(s);if(y&&d==="concealed")return l(d);let S;if(!y){let k=Qe(t);if(k?.length){let x;for(let T of k){let W=ke(T);if(!W.length)continue;if(W.includes(t)||W.includes(e))S=!0;else continue;if(!g)return l("hidden");w(T,"conceal")&&(x="concealed")}if(x==="concealed"&&(d="concealed"),S&&d==="concealed")return l(d)}}if(d!=="concealed"){let k=Ze(t);if(k?.length)for(let x of k){let T=ke(x);if(!T.length)continue;if(T.includes(t)||T.includes(e))return l("concealed")}}if(S||y)return l(d);let O=rt(t,r),b=O==="dim"?"concealed":O===null?"hidden":void 0;return(b==="concealed"&&m||b==="hidden"&&g)&&(b=void 0),P[b]>P[d]&&(d=b),l(d)}a(oe,"getVisibility");function tn(t,e,n,i){let r=e.flags?.["pf2e-perception"];if(r&&(r.data||r["-=data"]!==void 0)){if(t.object.renderFlags.set({refreshVisibility:!0}),game.user.isGM)return;let o=Hooks.on("refreshToken",s=>{!t.object!==s&&(Hooks.off("refreshToken",o),game.combat?.getCombatantByToken(t.id)&&ui.combat.render())})}}a(tn,"updateToken");function nn(t,e){e?ct(t):pe(t)}a(nn,"hoverToken");function on(t){pe(t),game.user.isGM||ui.combat.render()}a(on,"deleteToken");function rn(t,e){e&&(pe(),Hooks.once("sightRefresh",()=>t.hover&&ct(t)))}a(rn,"controlToken");function pe(t){if(!t?.id)return $(".pf2e-conditionals").remove();$(`.pf2e-conditionals[data-hover-id=${t.id}]`).remove(),$(`.pf2e-conditionals[data-token-id=${t.id}]`).remove()}a(pe,"clearConditionals");function ct(t){let e=z(t);for(let n of e)vt(n,t)}a(ct,"showAllConditionals");async function vt(t,e){if(t=t instanceof Token?t:t.object,!t.visible||!t.actor?.isOfType("creature"))return;let n=L(t,e.id);if(isEmpty(n))return;if(!game.user.isGM&&!e.document.hasPlayerOwner&&P[n.visibility]>=P.hidden){if(!n.cover)return;n={cover:n.cover}}let i=t.worldTransform.a,r=canvas.clientCoordinatesFromCanvas(t.document._source),o=`<div class="pf2e-conditionals" data-hover-id="${t.id}" data-token-id="${e.id}" `;o+=`style="top: ${r.y}px; left: ${r.x+t.hitArea.width*i/2}px;">`;let s=C("icon-path");Object.entries(n).map(([c,l])=>{let p=c==="cover"?"cover":l,u=s[p]||Ve[p];(u.startsWith("systems")||u.startsWith("modules"))&&(u=`../../../${u}`),o+=`<div class="conditional"><img src="${u}"></img></div>`}),o+="</div>",$(document.body).append(o)}a(vt,"showConditionals");function an(){return!!(this.sight.enabled&&this.actor?.isOfType("creature")&&this.scene?.rulesBasedVision)}a(an,"rulesBasedVision");function sn(t){let e=t.actor;if(e?.isOfType("creature")&&(e.isOfType("npc")&&Pe(t.scene,"npc-vision")&&t.updateSource({"sight.enabled":!0}),game.user.isGM&&t.hidden)){let n=game.user.targets,i={};for(let r of n)i[r.id]={visibility:"unnoticed"};n.size&&t.updateSource({[`flags.${f}.data`]:i})}}a(sn,"preCreateToken");var We=class extends q{static async openMenu(e,n){let i=await super.openMenu(e,n);return i&&e.message&&cn(e.message),i}get title(){return h("menu.validation.title",{name:this.token.name})}get template(){return Q("validation")}get selected(){let e=super.selected;return e.length?e:this.globalSelection}get globalSelection(){let e=this.token,n=e.actor.alliance;return z(e).filter(i=>i.actor.alliance!==n).map(i=>i.id)}getSavedData(e=!0){let n=super.getSavedData();return e?this._convertData(n):n}_convertData(e){let n=this.property,i=this.scene,r=this.selected,o=V[n],s=n==="cover"?B:ce;for(let c of r){let l=i.tokens.get(c),p=`${c}.${n}`,u=getProperty(e,p)??o,d=this.processValue({token:l,value:u});s.includes(d)||(d=u),u!==d&&setProperty(e,p,d)}return e}processValue(e){throw new Error(`${this.constructor.name} doesn't have a 'processValue' method defined`)}getData(e){let{covers:n,visibilities:i,i18n:r}=super.getData(e),o=this.currentData,s=this.getSavedData(!1),c=this.property,l=this.selected,p=z(this.token);p=p.map(({id:d,name:m,actor:g})=>{let y=o[d]??{},S=s[d]??{};return{id:d,name:m,alliance:g.alliance,selected:l.includes(d),...q.createPropertyData(S,y,c)}});let u=C("validation");return u==="selected"?p=p.filter(d=>d.selected):u==="changed"&&(p=p.filter(d=>d.changed)),{...this._spliIntoAlliances(p),i18n:r,property:c,options:c==="cover"?n:i,showSelected:l.length!==p.length&&u==="all",showChanges:u!=="changed"}}activateListeners(e){super.activateListeners(e),e.find("[data-action=cancel]").on("click",n=>{this.close()})}};a(We,"ValidationMenu");var Ae=class extends We{#e;constructor(e,n={}){super(e,n),this.#e=e.value}get property(){return"cover"}processValue(){return this.#e}};a(Ae,"CoverValidationMenu");var me=class extends We{#e;constructor(e,n={}){super(e,n),this.#e=e.roll}get property(){return"visibility"}get roll(){return this.#e}};a(me,"VisibilityValidationMenu");var De=class extends me{processValue({token:e,value:n}){let i=this.roll,r=e.actor.perception.dc.value,o=P[n],s=new M(i,r).value;return s>=M.SUCCESS&&o<P.hidden?"hidden":s<=M.FAILURE&&o>=P.hidden?"observed":n}};a(De,"HideValidationMenu");var we=class extends me{get selected(){return z(this.token).map(e=>e.id)}processValue({token:e,value:n}){return P[n]>=P.hidden?"observed":n}};a(we,"UnHideValidationMenu");var $e=class extends me{#e;constructor(e,n={}){super(e,n),this.#e=e.originator}get selected(){let e=this.token,n=e.actor.alliance,i=this.#e.id,r=L(e)??{};return z(e).filter(o=>{if(o.id===i||o.actor.alliance===n)return!1;let s=getProperty(r,`${o.id}.visibility`);return P[s]>=P.undetected}).map(o=>o.id)}processValue({token:e,value:n}){return P[n]>=P.undetected?"hidden":n}};a($e,"PointOutValidationMenu");var lt=class extends me{getSavedData(e=!0){let n=this.token.id,i=z(this.token),r={};for(let o of i){let s=L(o,n);s&&(r[o.id]=deepClone(s))}return e?this._convertData(r):r}getData(){let e=super.getData();return e.isReversed=!0,e.options=ce.map(n=>({value:n,label:h(`visibility.reversed.${n}`)})),e}_saveData(e){let n=this.scene,i=this.token.id,r=[];for(let[o,s]of Object.entries(e)){let c={_id:o},l=n.tokens.get(o);if(l){s.visibility===V.visibility&&delete s.visibility;let p=L(l,i)??{};if(p?.visibility===s.visibility)continue;!p.cover&&!s.visibility?c[`flags.${f}.data.-=${i}`]=!0:s.visibility?c[`flags.${f}.data.${i}.visibility`]=s.visibility:c[`flags.${f}.data.${i}.-=visibility`]=!0}else c[`flags.${f}.data.-=${i}`]=!0;r.push(c)}n.updateEmbeddedDocuments("Token",r)}};a(lt,"ReverseVisibilityValidationMenu");var _e=class extends lt{#e;constructor(e,n={}){super(e,n),this.#e=e.fromTemplate}get globalSelection(){return this.#e?[]:super.globalSelection}static async openMenu(e,n){await super.openMenu(e,n)&&J(e.token)}processValue({token:e,value:n}){let i=this.roll,r=e.actor.skills.stealth.dc.value,o=P[n],s=new M(i,r).value;return s>=M.CRITICAL_SUCCESS&&o>=P.hidden||s>=M.SUCCESS&&o===P.hidden?"observed":s>=M.SUCCESS&&o>=P.undetected?"hidden":n}};a(_e,"SeekValidationMenu");function Et(t,e){let n=t.token;if(!n)return;let i=game.user.isGM,r=n.hasPlayerOwner,{cover:o,selected:s,skipWait:c,validated:l,pointOut:p}=Wt(t),u=t.getFlag("pf2e","context");if(o){if(i){let d=kt({property:"cover",skipWait:c,validated:l});e.find(".message-content").append(d),e.find("[data-action=validate-cover]").on("click",()=>{Ae.openMenu({token:n,selected:s,value:o,message:t})})}else if(!c){let d=Pt("cover",l);e.find(".message-content").append(d)}}else if(u?.pf2ePerception?.visibility){l||e.find(".message-buttons").remove();let d=e.find(".flavor-text");!i&&r&&(e.find(".message-sender").text(n.name),d.empty());let m=h(`message.flat-check.${l===void 0?"blind":l?"success":"failure"}`),g=dn(m,l);if(d.append(g),i)for(let y of["success","failure"])d.append(St({action:`${y}-message`,icon:"fa-solid fa-message",label:h("message.flat-check.button",y)})),e.find(`[data-action=${y}-message]`).on("click",()=>{pt(t,"validated",y==="success")})}else if(u?.type==="skill-check"&&u.pf2ePerception)if(i){if(u.options.includes("action:hide")){let d=kt({property:"visibility",skipWait:c,validated:l});e.find(".flavor-text").append(d),e.find("[data-action=validate-visibility]").on("click",()=>{De.openMenu({token:n,message:t,roll:t.rolls[0],selected:u.pf2ePerception.selected})})}}else r&&u.options.includes("action:hide")&&un({token:n,message:t,html:e,validated:l});else if(u?.type==="perception-check"&&u.pf2ePerception)if(i){if(u.options.includes("action:seek")){let d=ln({skipWait:c,validated:l,smallAction:"delete-template",smallIcon:"fa-thin fa-cubes",smallSlashed:!0});e.find(".flavor-text").append(d),e.find("[data-action=validate-visibility]").on("click",()=>{_e.openMenu({token:n,message:t,roll:t.rolls[0],selected:u.pf2ePerception.selected,fromTemplate:u.pf2ePerception.fromTemplate})}),e.find("[data-action=delete-template").on("click",()=>{J(n)})}}else r&&u.options.includes("action:seek")&&un({token:n,message:t,html:e,validated:l});else if(p){let d=n.scene.tokens.get(p);if(!d)return;if(i){let m=ln({skipWait:c,validated:l,smallAction:"ping-token",smallIcon:"fa-solid fa-signal-stream"});e.find(".message-content").append(m),e.find("[data-action=validate-visibility]").on("click",()=>{$e.openMenu({message:t,token:d,originator:n,selected:canvas.tokens.controlled.map(g=>g.id)})}),e.find("[data-action=ping-token]").on("click",()=>{canvas.ping(d.center)})}else if(r){let m=Pt("visibility",l);e.find(".message-content").append(m)}}if(i&&ye.includes(u?.type)){let m=`<span class="pf2e-perception-unhide">
    <button data-action="unhide" title="${h("message.unhide.tooltip")}">
        <i class="fa-duotone fa-eye-slash"></i>
    </button>
</span>`;e.find(".dice-result .dice-total").append(m),e.find("[data-action=unhide]").on("click",g=>{g.stopPropagation(),we.openMenu({token:n})})}}a(Et,"renderChatMessage");function cn(t){w(t,"validated")||pt(t,"validated",!0)}a(cn,"validateMessage");function ln({skipWait:t,validated:e,smallIcon:n,smallAction:i,smallSlashed:r}){let o='<div class="pf2e-perception-chat-combo">';return o+=kt({property:"visibility",skipWait:t,validated:e}),o+=St({action:i,icon:n,slashed:r,tooltip:h(`message.visibility.small-button.${i}`)}),o+="</div>",o}a(ln,"createValidateCombo");function un({html:t,token:e,message:n,validated:i}){t.find(".message-sender").text(e.name);let r=n.getFlag("pf2e","modifierName");r+=Pt("visibility",i),t.find(".flavor-text").html(r)}a(un,"addBlindSkillCheckFlavor");function Pt(t,e){let n=h(`message.${t}.player.${e?"validated":"wait"}`);return dn(n,e)}a(Pt,"createWaitHint");function dn(t,e){return e===!0?t='<i class="fa-solid fa-check validated"></i> '+t:e===!1&&(t='<i class="fa-solid fa-xmark canceled"></i> '+t),`<i class="pf2e-perception-hint">${t}</i>`}a(dn,"createHint");function kt({skipWait:t,validated:e,property:n}){let i=h(`message.${n}.gm.${t?"check":e?"validated":"validate"}`);return!t&&e&&(i+='<i class="fa-solid fa-check validated"></i>'),St({action:`validate-${n}`,icon:"fa-solid fa-list",label:i})}a(kt,"createValidateButton");function St({action:t,icon:e,label:n,tooltip:i,slashed:r=!1}){let o=`<button type="button" class="pf2e-perception-chat-button" data-action="${t}" title="${i}">`;return e&&(o+=`<i class="${e} ${n?"":"no-label"}"></i>`,r&&(o+='<i class="fa-solid fa-slash-forward slashed"></i>')),n&&(o+=`${e?" ":""}${n}`),o+="</button>",o}a(St,"createChatButton");async function bt({content:t,token:e,flags:n,secret:i}){let r={content:t,speaker:ChatMessage.getSpeaker({token:e instanceof Token?e.document:e})};return n&&setProperty(r,`flags.${f}`,n),i&&(r.type=CONST.CHAT_MESSAGE_TYPES.WHISPER,r.whisper=ChatMessage.getWhisperRecipients("gm")),ChatMessage.create(r)}a(bt,"createTokenMessage");function mn(){let t=game.pf2e.actions.get("hide"),e=Ee(t,2).constructor,n=Ee(t.toActionVariant(),2).constructor,i=Ee(t,1).constructor,r=Ee(t.toActionVariant(),1).constructor;jn(e,n),zn(i,r),Vn(i,r),Ln(i,r),$n(e,n)}a(mn,"setupActions");function $n(t,e){class n extends e{async use(o={}){let s=h("action.point-out"),c=Le(o,s);c&&_n(this,c)}}a(n,"PointOutVariant");class i extends t{constructor(){super({cost:1,name:`${f}.action.point-out`,description:`${f}.action.point-out.description`,rollOptions:["action:point-out"],slug:"point-out",traits:["auditory","manipulate","visual"]})}toActionVariant(o={}){return o.name??=this.name,new n(this,o)}}a(i,"PointOut"),game.pf2e.actions.set("point-out",new i)}a($n,"setupPointOut");async function _n({name:t,traits:e},n){let i=game.user.targets.filter(p=>p.actor).first(),r=i?L(i,n.id,"visibility"):void 0,o=i&&P[r]<P.undetected,s;if(o){let p=i.actor.skills.stealth.dc.value;s=h("message.point-out.short-check",{check:`@Check[type:perception|dc:${p}|traits:auditory,manipulate,visual|showDC:gm]`})}else s=h("message.point-out.short");let c=await renderTemplate(Q("point-out"),{description:s,name:t,traits:e.map(p=>({slug:p,tooltip:CONFIG.PF2E.traitsDescriptions[p],name:CONFIG.PF2E.actionTraits[p]}))}),l={pointOut:o?i.id:void 0};bt({content:c,token:n,flags:l})}a(_n,"pointOut");function Ln(t,e){class n extends e{async use(o={}){let s=game.i18n.localize("PF2E.Actions.Seek.Title"),c=Le(o,s);if(c)return await Mn(c)?(o.actors=[c.actor],super.use(o)):J(c)}}a(n,"SeekVariant");class i extends t{constructor(){super({cost:1,description:"PF2E.Actions.Seek.Description",name:"PF2E.Actions.Seek.Title",notes:[{outcome:["criticalSuccess"],text:"PF2E.Actions.Seek.Notes.criticalSuccess"},{outcome:["success"],text:"PF2E.Actions.Seek.Notes.success"}],rollOptions:["action:seek"],slug:"seek",statistic:"perception",traits:["concentrate","secret"]})}toActionVariant(o){return new n(this,o)}}a(i,"Seek"),game.pf2e.actions.set("seek",new i)}a(Ln,"setupSeek");async function Mn(t){let e=game.i18n.localize("PF2E.Foot"),n='<p style="margin: 0 0.3em; text-align: center;">';return n+=`${h("dialog.seek.hint")}</p><p>`,n+=pn("create-cone","fa-thin fa-cubes",game.i18n.format("PF2E.TemplateLabel",{size:30,unit:e,shape:game.i18n.localize(CONFIG.PF2E.areaTypes.cone)})),n+=pn("create-burst","fa-thin fa-cubes",game.i18n.format("PF2E.TemplateLabel",{size:15,unit:e,shape:game.i18n.localize(CONFIG.PF2E.areaTypes.burst)})),n+="</p>",Dialog.wait({title:`${t.name} - ${game.i18n.localize("PF2E.Actions.Seek.Title")}`,content:n,buttons:{ok:{icon:'<i class="fa-solid fa-check"></i>',label:h("dialog.seek.accept"),callback:()=>!0},no:{icon:'<i class="fa-solid fa-xmark"></i>',label:h("dialog.seek.cancel"),callback:i=>!1}},close:()=>!1,render:i=>{i.filter(".dialog-content").find("[data-action=create-cone], [data-action=create-burst]").on("click",o=>{let{action:s}=o.currentTarget.dataset;J(t),Ye({type:s==="create-cone"?"cone":"burst",token:t})})}},{width:300,left:10})}a(Mn,"seek");function Vn(t,e){class n extends e{async use(o={}){let s=game.i18n.localize("PF2E.Actions.Sneak.Title"),c=Le(o,s);if(c)return o.actors=[c.actor],super.use(o)}}a(n,"SneakVariant");class i extends t{constructor(){super({cost:1,description:"PF2E.Actions.Sneak.Description",name:"PF2E.Actions.Sneak.Title",notes:[{outcome:["success","criticalSuccess"],text:"PF2E.Actions.Sneak.Notes.success"},{outcome:["failure"],text:"PF2E.Actions.Sneak.Notes.failure"},{outcome:["criticalFailure"],text:"PF2E.Actions.Sneak.Notes.criticalFailure"}],rollOptions:["action:sneak"],slug:"sneak",traits:["move","secret"]})}toActionVariant(o){return new n(this,o)}}a(i,"Sneak")}a(Vn,"setupSneak");function zn(t,e){class n extends e{async use(o={}){let s=game.i18n.localize("PF2E.Actions.Hide.Title"),c=Le(o,s);if(c)return o.actors=[c.actor],super.use(o)}}a(n,"HideVariant");class i extends t{constructor(){super({cost:1,description:"PF2E.Actions.Hide.Description",name:"PF2E.Actions.Hide.Title",rollOptions:["action:hide"],slug:"hide",statistic:"stealth",traits:["secret"],notes:[{outcome:["success","criticalSuccess"],text:"PF2E.Actions.Hide.Notes.success"}]})}toActionVariant(o){return new n(this,o)}}a(i,"Hide"),game.pf2e.actions.set("hide",new i)}a(zn,"setupHide");function jn(t,e){class n extends e{async use(o={}){let s=h("action.take-cover"),c=Le(o,s);c&&Gn(c)}}a(n,"TakeCoverVariant");class i extends t{constructor(){super({cost:1,description:"PF2E.Actions.TakeCover.Description",img:"systems/pf2e/icons/conditions-2/status_acup.webp",name:"PF2E.Actions.TakeCover.Title",slug:"take-cover"})}toActionVariant(o){return new n(this,o)}}a(i,"TakeCover"),game.pf2e.actions.set("take-cover",new i)}a(jn,"setupCover");async function Gn(t){let e=t.actor,n=ee(e),i=ne(t,game.user.targets.ids);if(n&&!i.length)return n.delete();let r=L(t)??{},o=Object.entries(r).reduce((l,[p,{cover:u}])=>(u&&(l[p]=u),l),{}),s=await renderTemplate(Q("covers-dialog"),{i18n:h,hasTargets:!!i.length,hasCovers:!isEmpty(o),hasTargetCover:i.some(l=>l in o),isProne:Z(e)}),c=new Dialog({title:`${t.name} - ${h("action.take-cover")}`,content:s,buttons:{},render:l=>{l.find("button").on("click",async p=>{let{level:u}=p.currentTarget.dataset,d=C("skip-cover"),m=a(async(g,y)=>{y=y?i:void 0;let S=g===V.cover?y?"remove":"remove-all":"take",O=await bt({content:h(`message.cover.${S}`,{cover:h(`cover.${g}`)}),flags:{selected:y,cover:g,skipWait:d},token:t});if(d){if(g===V.cover&&!y)return en(t);let b=deepClone(L(t))??{};for(let k of i)setProperty(b,`${k}.cover`,g);return nt(t,b)}},"process");if(u==="remove-all")m(V.cover);else if(u==="remove")m(V.cover,!0);else if(i.length)m(u,!0);else{let g=he(u);e.createEmbeddedDocuments("Item",[g])}c.close()})}}).render(!0)}a(Gn,"takeCover");function Le(t,e){let n=t.tokens?.filter(o=>o.actor)??[];Array.isArray(n)||(n=[n]);let i=t.actors??[];if(Array.isArray(i)||(i=[i]),!n.length&&i.length===1&&(n=[Ne(i[0])].filter(Boolean)),n.length||(n=canvas.tokens.controlled.filter(o=>o.actor)),n.length||(n=[Ne(game.user.character)].filter(Boolean)),n.length>1){ui.notifications.warn(h("action.only-one",{action:e}));return}else if(!n.length){ui.notifications.warn(h("action.must-one",{action:e}));return}let r=n[0];if(!r?.actor?.isOfType("creature")){ui.notifications.warn(h("action.must-creature",{action:e}));return}return r}a(Le,"getSelectedToken");function pn(t,e,n){return`<button type="button" data-action="${t}" style="margin: 0 0 5px; padding: 0;">
    <i class="${e}"></i> ${n}</button>
</button>`}a(pn,"createButton");var gn={geometry:{clearDebug:ue,getRectEdges:it,lineIntersectWall:Oe,pointToTokenIntersectWall:ot},token:{getCreatureCover:ht,getWallCover:at,getVisibility:oe,clearConditionals:pe,showConditionals:vt,showAllConditionals:ct,getTokenData:L,getCover:st,openHUD:yt},lighting:{getLightExposure:rt},actor:{isProne:Z,getCoverEffect:ee,seeInvisibility:Ue,hasGreaterDarkvision:Ge},scene:{getValidTokens:z,validateTokens:ne,getSceneSetting:Pe},template:{createSeekTemplate:Ye,createDarknessTemplate:Bt,createMistTemplate:Ht,getDarknessTemplates:Qe,getMistTemplates:Ze,getSeekTemplateTokens:Je,deleteSeekTemplate:J,getTemplateTokens:ke},ruleElement:{perceptionRules:ie,getPerception:U,updateFromPerceptionRules:be}};async function fn(t,...e){let n=e[1];if(!n)return t(...e);Array.isArray(n.options)&&(n.options=new Set(n.options));let{actor:i,createMessage:r="true",type:o,token:s,target:c,isReroll:l}=n,p=s??Ne(i),u=c?.token,d=ye.includes(o),m=C("flat-check");if(l||!r||!p||!Ft.includes(o)||d&&(!u||m==="none"))return t(...e);if(d&&u.actor){let g=e[2],y=ie(p,u,{extraOptions:n.options.filter(W=>W.startsWith("item:"))}),S=oe(u,p,{perception:y,affects:"target"});if(!S)return t(...e);let O=(()=>{let W=U(y,"target","visibility","dc",S)?.first(),E=tt(W);if(!E)return E;let F=W[0];return["-","+"].includes(F)?(S==="concealed"?5:11)+E:E})();if(O===0)return t(...e);let b=P[S]>=P.undetected,k=g?.ctrlKey||g?.metaKey,T=(await new p.actor.saves.reflex.constructor(p.actor,{slug:"visibility-check",label:`${game.i18n.localize("PF2E.FlatCheck")}: ${game.i18n.localize(`PF2E.condition.${S}.name`)}`,check:{type:"flat-check"}}).roll({dc:{value:O??(S==="concealed"?5:11)},target:u.actor,rollMode:b||k?game.user.isGM?"gmroll":"blindroll":"roll"})).degreeOfSuccess>1;if(b&&(n.options.add("secret"),n.pf2ePerception={isSuccess:T,visibility:S}),m!=="roll"&&!b&&!T)return}else if(n.options.has("action:hide"))setProperty(n,"pf2ePerception.selected",game.user.targets.ids);else if(n.options.has("action:seek")){let g=Je(p),y=g??Array.from(game.user.targets),S=ne(p,y).filter(O=>!O.document.hidden).map(O=>O.id);setProperty(n,"pf2ePerception.selected",S),setProperty(n,"pf2ePerception.fromTemplate",!!g)}return t(...e)}a(fn,"checkRoll");function yn(t,e){let{createMessage:n="true",type:i,token:r,target:o,isReroll:s,options:c,dc:l}=t.context,p=r,u=o?.token,d=o?.actor;if(s||!n||!p||!u||!d||!ye.includes(i))return;let m=ee(d),g=m?je(m)?.selection.level??w(m,"level"):void 0,y=t[f]?.coverOverride??g,S='<div class="roll-mode-panel">';S+=`<div class="label">${h("dice-checks.cover.label")}</div>`,S+=`<select name="overrideCover"><option value="">${h("dice-checks.cover.none")}</option>`,(Z(d)?B.slice(1):B.slice(1,-1)).forEach(b=>{let k=b===y?"selected":"",x=h(`cover.${b}`);S+=`<option value="${b}" ${k}>${x}</option>`}),S+="</select></div>",S+="<hr>",e.find(".roll-mode-panel").before(S),e.find("select[name=overrideCover]").on("change",b=>{let k=b.currentTarget.value||void 0;setProperty(t,`${f}.coverOverride`,k),y=k}),e.find("button.roll")[0].addEventListener("click",b=>{b.preventDefault(),b.stopPropagation(),b.stopImmediatePropagation();let k=!1,x=deepClone(d._source.items);if(y!==g){k=!0;let T=x.findIndex(W=>getProperty(W,"flags.core.sourceId")===fe);if(T!==-1&&x.splice(T,1),y){let W=he(y);x.push(W)}}if(k&&(o.actor=d.clone({items:x},{keepId:!0}),l?.slug)){let T=o.actor.getStatistic(l.slug)?.dc;T&&(l.value=T.value,l.statistic=T)}t.resolve(!0),t.isResolved=!0,t.close()},!0),t.setPosition()}a(yn,"renderCheckModifiersDialog");function hn(t,e){C("target")&&Un(e)}a(hn,"renderCombatTracker");function Un(t){t.find("[data-control=toggleTarget]").each((e,n)=>{n.addEventListener("click",i=>{i.preventDefault(),i.stopPropagation(),i.stopImmediatePropagation();let{combatantId:r}=i.currentTarget.closest(".combatant").dataset,s=game.combats.viewed.combatants.get(r??"")?.token;if(!s)return;let c=Array.from(game.user.targets).some(l=>l.document===s);s.object.setTarget(!c,{releaseOthers:!i.shiftKey})},!0)})}a(Un,"setupToggleTarget");function vn(t,e){let n=C("encounter");e.find(".form-group").last().after(`<div class="form-group">
    <label>${h("settings.encounter.name")}</label>
    <input type="checkbox" name="pf2e-perception.encounter" ${n?"checked":""}>
    <p class="notes">${h("settings.encounter.short")}</p>
</div>`),e.find('input[name="pf2e-perception.encounter"]').on("change",i=>{let r=i.currentTarget.checked;ze("encounter",r)})}a(vn,"renderCombatTrackerConfig");function Pn(t,e,n={}){return!e.enabled||!this._canDetect(t,n.object,n)?!1:n.tests.some(i=>this._testPoint(t,e,n.object,i))}a(Pn,"detectionModeTestVisibility");function kn(t,e,n){if(e instanceof PlaceableObject&&e.document.hidden)return!1;if(!(e instanceof Token))return!0;let i=t.object,r=i.document;return r instanceof TokenDocument&&r.hasStatusEffect(CONFIG.specialStatusEffects.BLIND)?!1:i instanceof Token?!Tt(i,e,P.hidden,n):!e.document?.hasStatusEffect(CONFIG.specialStatusEffects.INVISIBLE)&&!e.actor?.hasCondition("hidden","undetected","unnoticed")}a(kn,"basicSightCanDetect");function En(t,e,n){if(e.document.hidden||!(e instanceof Token)||!e.actor?.emitsSound)return!1;if(!game.settings.get("pf2e","automation.rulesBasedVision"))return!0;let i=t.object;return i.actor?.hasCondition("deafened")?!1:i instanceof Token?!Tt(i,e,P.undetected,n):!e.actor?.hasCondition("undetected","unnoticed")}a(En,"hearingCanDetect");function Sn(t,e,n){if(e.document.hidden||!(e instanceof Token)||e.document.elevation>canvas.primary.background.elevation||e.actor?.isOfType("loot"))return!1;let i=t.object;return i instanceof Token?!Tt(i,e,P.undetected,n):!e.actor?.hasCondition("undetected","unnoticed")}a(Sn,"feelTremorCanDetect");function Tt(t,e,n,i={}){if(!i.visibility){let r=ie(t,e);i.visibility=oe(e,t,{perception:r,affects:"target"})}return P[i.visibility]>=n}a(Tt,"reachesThreshold");function Bn(t,e,n){let i=t.length-e.length,r=Array.from(e);if(i===0)return t(...r);if(i===1){let o=a(s=>t(s,...r),"ret");return(n||t.lazy)&&(o.lazy=n||t.lazy,o.lazyArgs=e),o}throw new Error("Wrong number of arguments")}a(Bn,"purry");function Hn(t,e,n){let i=[];for(let r=0;r<t.length;r++){let o=t[r],s=n?e(o,r,t):e(o);s.hasMany===!0?i.push(...s.next):s.hasNext&&i.push(s.next)}return i}a(Hn,"_reduceLazy");function bn(){let t=new Set;return e=>t.has(e)?{done:!1,hasNext:!1}:(t.add(e),{done:!1,hasNext:!0,next:e})}a(bn,"uniqLazy");function Kn(t){return Hn(t,bn())}a(Kn,"_uniq");var re={compact:t=>t.filter(Boolean),uniq:function(){return Bn(Kn,arguments,bn)}};var qn={ancestralEchoing:{level:15,name:"PF2E.WeaponPropertyRune.ancestralEchoing.Name",price:9500,rarity:"rare",slug:"ancestralEchoing",traits:["dwarf","magical","saggorak"]},anchoring:{damage:{notes:[{outcome:["criticalSuccess"],title:"PF2E.WeaponPropertyRune.anchoring.Name",text:"PF2E.WeaponPropertyRune.anchoring.Note.criticalSuccess"}]},level:10,name:"PF2E.WeaponPropertyRune.anchoring.Name",price:900,rarity:"uncommon",slug:"anchoring",traits:["magical"]},ashen:{damage:{dice:[{damageType:"fire",category:"persistent",diceNumber:1,dieSize:"d4"}],notes:[{outcome:["success"],title:"PF2E.WeaponPropertyRune.ashen.Name",text:"PF2E.WeaponPropertyRune.ashen.Note.success"}]},level:9,name:"PF2E.WeaponPropertyRune.ashen.Name",price:700,rarity:"common",slug:"ashen",traits:["magical"]},authorized:{level:3,name:"PF2E.WeaponPropertyRune.authorized.Name",price:50,rarity:"common",slug:"authorized",traits:["magical"]},bane:{level:4,name:"PF2E.WeaponPropertyRune.bane.Name",price:100,rarity:"uncommon",slug:"bane",traits:["magical"]},bloodbane:{level:8,name:"PF2E.WeaponPropertyRune.bloodbane.Name",price:475,rarity:"uncommon",slug:"bloodbane",traits:["dwarf","magical"]},bloodthirsty:{damage:{notes:[{outcome:["criticalSuccess"],title:"PF2E.WeaponPropertyRune.bloodbane.Name",text:"PF2E.WeaponPropertyRune.bloodthirsty.Note.criticalSuccess"}]},level:16,name:"PF2E.WeaponPropertyRune.bloodthirsty.Name",price:8500,rarity:"uncommon",slug:"bloodthirsty",traits:["magical"]},brilliant:{damage:{dice:[{damageType:"fire",diceNumber:1,dieSize:"d4"},{damageType:"spirit",diceNumber:1,dieSize:"d4",predicate:["target:trait:fiend"]},{damageType:"vitality",diceNumber:1,dieSize:"d4",predicate:["target:mode:undead"]}],notes:[{outcome:["criticalSuccess"],title:"PF2E.WeaponPropertyRune.brilliant.Name",text:"PF2E.WeaponPropertyRune.brilliant.Note.criticalSuccess"}]},level:12,name:"PF2E.WeaponPropertyRune.brilliant.Name",price:2e3,rarity:"common",slug:"brilliant",traits:["magical"]},called:{level:7,name:"PF2E.WeaponPropertyRune.called.Name",price:350,rarity:"common",slug:"called",traits:["magical"]},coating:{level:9,name:"PF2E.WeaponPropertyRune.coating.Name",price:700,rarity:"common",slug:"coating",traits:["extradimensional","magical"]},conducting:{level:7,name:"PF2E.WeaponPropertyRune.conducting.Name",price:300,rarity:"common",slug:"conducting",traits:["magical"]},corrosive:{damage:{dice:[{damageType:"acid",diceNumber:1,dieSize:"d6"}],notes:[{outcome:["criticalSuccess"],title:"PF2E.WeaponPropertyRune.corrosive.Name",text:"PF2E.WeaponPropertyRune.corrosive.Note.criticalSuccess"}]},level:8,name:"PF2E.WeaponPropertyRune.corrosive.Name",price:500,rarity:"common",slug:"corrosive",traits:["acid","magical"]},crushing:{damage:{notes:[{outcome:["criticalSuccess"],title:"PF2E.WeaponPropertyRune.crushing.Name",text:"PF2E.WeaponPropertyRune.crushing.Note.criticalSuccess"}]},level:3,name:"PF2E.WeaponPropertyRune.crushing.Name",price:50,rarity:"uncommon",slug:"crushing",traits:["magical"]},cunning:{level:5,name:"PF2E.WeaponPropertyRune.cunning.Name",price:140,rarity:"common",slug:"cunning",traits:["magical"]},dancing:{level:13,name:"PF2E.WeaponPropertyRune.dancing.Name",price:2700,rarity:"uncommon",slug:"dancing",traits:["magical"]},deathdrinking:{damage:{dice:[{slug:"deathdrinking-negative",damageType:"void",diceNumber:1,dieSize:"d6",critical:!0,predicate:["target:mode:living",{not:"target:negative-healing"}]},{slug:"deathdrinking-positive",damageType:"vitality",diceNumber:1,dieSize:"d6",critical:!0,predicate:["target:negative-healing"]}]},level:7,name:"PF2E.WeaponPropertyRune.deathdrinking.Name",price:360,rarity:"rare",slug:"deathdrinking",traits:["magical"]},demolishing:{damage:{dice:[{damageType:"force",category:"persistent",diceNumber:1,dieSize:"d6",predicate:["target:trait:construct"]}]},level:6,name:"PF2E.WeaponPropertyRune.demolishing.Name",price:225,rarity:"rare",slug:"demolishing",traits:["magical"]},disrupting:{damage:{dice:[{damageType:"vitality",diceNumber:1,dieSize:"d6",predicate:["target:mode:undead"]}],notes:[{outcome:["criticalSuccess"],title:"PF2E.WeaponPropertyRune.disrupting.Name",text:"PF2E.WeaponPropertyRune.disrupting.Note.criticalSuccess",predicate:["target:mode:undead"]}]},level:5,name:"PF2E.WeaponPropertyRune.disrupting.Name",price:150,rarity:"common",slug:"disrupting",traits:["magical"]},earthbinding:{level:5,name:"PF2E.WeaponPropertyRune.earthbinding.Name",price:125,rarity:"common",slug:"earthbinding",traits:["magical"]},energizing:{level:6,name:"PF2E.WeaponPropertyRune.energizing.Name",price:250,rarity:"uncommon",slug:"energizing",traits:["magical"]},extending:{level:7,name:"PF2E.WeaponPropertyRune.extending.Name",price:700,rarity:"common",slug:"extending",traits:["magical"]},fanged:{level:2,name:"PF2E.WeaponPropertyRune.fanged.Name",price:30,rarity:"uncommon",slug:"fanged",traits:["magical"]},fearsome:{damage:{notes:[{outcome:["criticalSuccess"],title:"PF2E.WeaponPropertyRune.fearsome.Name",text:"PF2E.WeaponPropertyRune.fearsome.Note.criticalSuccess"}]},level:5,name:"PF2E.WeaponPropertyRune.fearsome.Name",price:160,rarity:"common",slug:"fearsome",traits:["emotion","fear","magical","mental"]},flaming:{damage:{dice:[{damageType:"fire",diceNumber:1,dieSize:"d6"},{damageType:"fire",category:"persistent",diceNumber:1,dieSize:"d10",critical:!0}]},level:8,name:"PF2E.WeaponPropertyRune.flaming.Name",price:500,rarity:"common",slug:"flaming",traits:["fire","magical"]},flurrying:{level:7,name:"PF2E.WeaponPropertyRune.flurrying.Name",price:360,rarity:"common",slug:"flurrying",traits:["magical"]},frost:{damage:{dice:[{damageType:"cold",diceNumber:1,dieSize:"d6"}],notes:[{outcome:["criticalSuccess"],title:"PF2E.WeaponPropertyRune.frost.Name",text:"PF2E.WeaponPropertyRune.frost.Note.criticalSuccess"}]},level:8,name:"PF2E.WeaponPropertyRune.frost.Name",price:500,rarity:"common",slug:"frost",traits:["cold","magical"]},ghostTouch:{level:4,name:"PF2E.WeaponPropertyRune.ghostTouch.Name",price:75,rarity:"common",slug:"ghostTouch",traits:["magical"]},giantKilling:{damage:{dice:[{slug:"giantKilling",damageType:"mental",diceNumber:1,dieSize:"d6",predicate:["target:trait:giant"]}],notes:[{outcome:["criticalSuccess"],predicate:["target:trait:giant"],title:"PF2E.WeaponPropertyRune.giantKilling.Name",text:"PF2E.WeaponPropertyRune.giantKilling.Note.criticalSuccess"}]},level:8,name:"PF2E.WeaponPropertyRune.giantKilling.Name",price:450,rarity:"rare",slug:"giantKilling",traits:["magical"]},greaterAnchoring:{damage:{notes:[{outcome:["criticalSuccess"],title:"PF2E.WeaponPropertyRune.greaterAnchoring.Name",text:"PF2E.WeaponPropertyRune.greaterAnchoring.Note.criticalSuccess"},{outcome:["success"],title:"PF2E.WeaponPropertyRune.greaterAnchoring.Name",text:"PF2E.WeaponPropertyRune.greaterAnchoring.Note.success"}]},level:18,name:"PF2E.WeaponPropertyRune.greaterAnchoring.Name",price:22e3,rarity:"uncommon",slug:"greaterAnchoring",traits:["magical"]},greaterAshen:{damage:{dice:[{damageType:"fire",category:"persistent",diceNumber:1,dieSize:"d8"}],notes:[{outcome:["success"],title:"PF2E.WeaponPropertyRune.greaterAshen.Name",text:"PF2E.WeaponPropertyRune.greaterAshen.Note.success"}]},level:16,name:"PF2E.WeaponPropertyRune.greaterAshen.Name",price:9e3,rarity:"common",slug:"greaterAshen",traits:["magical"]},greaterBloodbane:{level:13,name:"PF2E.WeaponPropertyRune.greaterBloodbane.Name",price:2800,rarity:"uncommon",slug:"greaterBloodbane",traits:["dwarf","magical"]},greaterBrilliant:{damage:{dice:[{damageType:"fire",diceNumber:1,dieSize:"d4"},{diceNumber:1,dieSize:"d4",predicate:["target:trait:fiend"]},{damageType:"vitality",diceNumber:1,dieSize:"d4",predicate:["target:mode:undead"]}],notes:[{outcome:["criticalSuccess"],title:"PF2E.WeaponPropertyRune.greaterBrilliant.Name",text:"PF2E.WeaponPropertyRune.greaterBrilliant.Note.criticalSuccess"},{outcome:["success"],title:"PF2E.WeaponPropertyRune.greaterBrilliant.Name",text:"PF2E.WeaponPropertyRune.greaterBrilliant.Note.success"}],ignoredResistances:[{type:"fire",max:null},{type:"good",max:null},{type:"vitality",max:null}]},level:18,name:"PF2E.WeaponPropertyRune.greaterBrilliant.Name",price:24e3,rarity:"common",slug:"greaterBrilliant",traits:["magical"]},greaterCorrosive:{damage:{dice:[{damageType:"acid",diceNumber:1,dieSize:"d6"}],notes:[{outcome:["criticalSuccess"],title:"PF2E.WeaponPropertyRune.greaterCorrosive.Name",text:"PF2E.WeaponPropertyRune.greaterCorrosive.Note.criticalSuccess"},{outcome:["success"],title:"PF2E.WeaponPropertyRune.greaterCorrosive.Name",text:"PF2E.WeaponPropertyRune.greaterCorrosive.Note.success"}]},level:15,name:"PF2E.WeaponPropertyRune.greaterCorrosive.Name",price:6500,rarity:"common",slug:"greaterCorrosive",traits:["acid","magical"]},greaterCrushing:{damage:{notes:[{outcome:["criticalSuccess"],title:"PF2E.WeaponPropertyRune.greaterCrushing.Name",text:"PF2E.WeaponPropertyRune.greaterCrushing.Note.criticalSuccess"}]},level:9,name:"PF2E.WeaponPropertyRune.greaterCrushing.Name",price:650,rarity:"uncommon",slug:"greaterCrushing",traits:["magical"]},greaterDisrupting:{damage:{dice:[{damageType:"vitality",diceNumber:2,dieSize:"d6",predicate:["target:mode:undead"]}],notes:[{outcome:["criticalSuccess"],title:"PF2E.WeaponPropertyRune.greaterDisrupting.Name",text:"PF2E.WeaponPropertyRune.greaterDisrupting.Note.criticalSuccess",predicate:["target:mode:undead"]}]},level:14,name:"PF2E.WeaponPropertyRune.greaterDisrupting.Name",price:4300,rarity:"uncommon",slug:"greaterDisrupting",traits:["magical"]},greaterExtending:{level:13,name:"PF2E.WeaponPropertyRune.greaterExtending.Name",price:3e3,rarity:"common",slug:"greaterExtending",traits:["magical"]},greaterFanged:{level:8,name:"PF2E.WeaponPropertyRune.greaterFanged.Name",price:425,rarity:"uncommon",slug:"greaterFanged",traits:["magical"]},greaterFearsome:{damage:{notes:[{outcome:["criticalSuccess"],title:"PF2E.WeaponPropertyRune.greaterFearsome.Name",text:"PF2E.WeaponPropertyRune.greaterFearsome.Note.criticalSuccess"}]},level:12,name:"PF2E.WeaponPropertyRune.greaterFearsome.Name",price:2e3,rarity:"common",slug:"greaterFearsome",traits:["emotion","fear","magical","mental"]},greaterFlaming:{damage:{dice:[{damageType:"fire",diceNumber:1,dieSize:"d6"},{damageType:"fire",category:"persistent",diceNumber:2,dieSize:"d10",critical:!0}],notes:[{outcome:["criticalSuccess"],title:"PF2E.WeaponPropertyRune.greaterFlaming.Name",text:"PF2E.WeaponPropertyRune.greaterFlaming.Note.criticalSuccess"},{outcome:["success"],title:"PF2E.WeaponPropertyRune.greaterFlaming.Name",text:"PF2E.WeaponPropertyRune.greaterFlaming.Note.success"}],ignoredResistances:[{type:"fire",max:null}]},level:15,name:"PF2E.WeaponPropertyRune.greaterFlaming.Name",price:6500,rarity:"common",slug:"greaterFlaming",traits:["fire","magical"]},greaterFrost:{damage:{dice:[{damageType:"cold",diceNumber:1,dieSize:"d6"}],notes:[{outcome:["criticalSuccess"],title:"PF2E.WeaponPropertyRune.greaterFrost.Name",text:"PF2E.WeaponPropertyRune.greaterFrost.Note.criticalSuccess"},{outcome:["success"],title:"PF2E.WeaponPropertyRune.greaterFrost.Name",text:"PF2E.WeaponPropertyRune.greaterFrost.Note.success"}],ignoredResistances:[{type:"cold",max:null}]},level:15,name:"PF2E.WeaponPropertyRune.greaterFrost.Name",price:6500,rarity:"common",slug:"greaterFrost",traits:["cold","magical"]},greaterGiantKilling:{damage:{dice:[{slug:"greaterGiantKilling",damageType:"mental",diceNumber:2,dieSize:"d6",predicate:["target:trait:giant"]}],ignoredResistances:[{type:"mental",max:null}],notes:[{outcome:["criticalSuccess"],predicate:["target:trait:giant"],title:"PF2E.WeaponPropertyRune.greaterGiantKilling.Name",text:"PF2E.WeaponPropertyRune.greaterGiantKilling.Note.criticalSuccess"}]},level:15,name:"PF2E.WeaponPropertyRune.greaterGiantKilling.Name",price:6e3,rarity:"rare",slug:"greaterGiantKilling",traits:["magical"]},greaterHauling:{level:11,name:"PF2E.WeaponPropertyRune.greaterHauling.Name",price:1300,rarity:"uncommon",slug:"greaterHauling",traits:["magical"]},greaterImpactful:{damage:{dice:[{damageType:"force",diceNumber:1,dieSize:"d6"}],notes:[{outcome:["criticalSuccess"],title:"PF2E.WeaponPropertyRune.greaterImpactful.Name",text:"PF2E.WeaponPropertyRune.greaterImpactful.Note.criticalSuccess"}]},level:17,name:"PF2E.WeaponPropertyRune.greaterImpactful.Name",price:15e3,rarity:"common",slug:"greaterImpactful",traits:["force","magical"]},greaterRooting:{level:11,name:"PF2E.WeaponPropertyRune.greaterRooting.Name",price:1400,rarity:"common",slug:"greaterRooting",traits:["plant","magical","wood"],damage:{notes:[{outcome:["criticalSuccess"],title:"PF2E.WeaponPropertyRune.greaterRooting.Name",text:"PF2E.WeaponPropertyRune.greaterRooting.Note.criticalSuccess"},{outcome:["success"],title:"PF2E.WeaponPropertyRune.greaterRooting.Name",text:"PF2E.WeaponPropertyRune.greaterRooting.Note.success"}]}},greaterShock:{damage:{dice:[{damageType:"electricity",diceNumber:1,dieSize:"d6"}],notes:[{outcome:["criticalSuccess"],title:"PF2E.WeaponPropertyRune.greaterShock.Name",text:"PF2E.WeaponPropertyRune.greaterShock.Note.criticalSuccess"},{outcome:["success"],title:"PF2E.WeaponPropertyRune.greaterShock.Name",text:"PF2E.WeaponPropertyRune.greaterShock.Note.success"}],ignoredResistances:[{type:"electricity",max:null}]},level:15,name:"PF2E.WeaponPropertyRune.greaterShock.Name",price:6500,rarity:"common",slug:"greaterShock",traits:["electricity","magical"]},greaterThundering:{damage:{dice:[{damageType:"sonic",diceNumber:1,dieSize:"d6"}],notes:[{outcome:["criticalSuccess"],title:"PF2E.WeaponPropertyRune.greaterThundering.Name",text:"PF2E.WeaponPropertyRune.greaterThundering.Note.criticalSuccess"},{outcome:["success"],title:"PF2E.WeaponPropertyRune.greaterThundering.Name",text:"PF2E.WeaponPropertyRune.greaterThundering.Note.success"}],ignoredResistances:[{type:"sonic",max:null}]},level:15,name:"PF2E.WeaponPropertyRune.greaterThundering.Name",price:6500,rarity:"common",slug:"greaterThundering",traits:["magical","sonic"]},grievous:{damage:{dice:[{damageType:"bleed",diceNumber:1,dieSize:"d6",critical:!0,predicate:["critical-specialization","item:group:dart"]}],notes:[{outcome:["criticalSuccess"],predicate:["item:group:axe"],title:"PF2E.WeaponPropertyRune.grievous.Name",text:"PF2E.WeaponPropertyRune.grievous.Note.Axe"},{outcome:["criticalSuccess"],predicate:["item:group:brawling"],title:"PF2E.WeaponPropertyRune.grievous.Name",text:"PF2E.WeaponPropertyRune.grievous.Note.Brawling"},{outcome:["criticalSuccess"],predicate:["item:group:club"],title:"PF2E.WeaponPropertyRune.grievous.Name",text:"PF2E.WeaponPropertyRune.grievous.Note.Club"},{outcome:["criticalSuccess"],predicate:["item:group:flail"],title:"PF2E.WeaponPropertyRune.grievous.Name",text:"PF2E.WeaponPropertyRune.grievous.Note.Flail"},{outcome:["criticalSuccess"],predicate:["item:group:hammer"],title:"PF2E.WeaponPropertyRune.grievous.Name",text:"PF2E.WeaponPropertyRune.grievous.Note.Hammer"},{outcome:["criticalSuccess"],predicate:["item:group:knife"],title:"PF2E.WeaponPropertyRune.grievous.Name",text:"PF2E.WeaponPropertyRune.grievous.Note.Knife"},{outcome:["criticalSuccess"],predicate:["item:group:polearm"],title:"PF2E.WeaponPropertyRune.grievous.Name",text:"PF2E.WeaponPropertyRune.grievous.Note.Polearm"},{outcome:["criticalSuccess"],predicate:["item:group:shield"],title:"PF2E.WeaponPropertyRune.grievous.Name",text:"PF2E.WeaponPropertyRune.grievous.Note.Shield"},{outcome:["criticalSuccess"],predicate:["item:group:sling"],title:"PF2E.WeaponPropertyRune.grievous.Name",text:"PF2E.WeaponPropertyRune.grievous.Note.Sling"},{outcome:["criticalSuccess"],predicate:["item:group:spear"],title:"PF2E.WeaponPropertyRune.grievous.Name",text:"PF2E.WeaponPropertyRune.grievous.Note.Spear"},{outcome:["criticalSuccess"],predicate:["item:group:sword"],title:"PF2E.WeaponPropertyRune.grievous.Name",text:"PF2E.WeaponPropertyRune.grievous.Note.Sword"}],adjustments:[{slug:"critical-specialization",test:t=>new PredicatePF2e("item:group:pick").test(t),getNewValue:t=>t*2}]},level:9,name:"PF2E.WeaponPropertyRune.grievous.Name",price:700,rarity:"common",slug:"grievous",traits:["magical"]},hauling:{level:6,name:"PF2E.WeaponPropertyRune.hauling.Name",price:225,rarity:"uncommon",slug:"hauling",traits:["magical"]},holy:{level:11,name:"PF2E.WeaponPropertyRune.holy.Name",price:1400,rarity:"common",slug:"holy",traits:["holy","magical"],damage:{dice:[{damageType:"spirit",diceNumber:1,dieSize:"d4",predicate:[{not:"target:trait:unholy"}]},{damageType:"spirit",diceNumber:2,dieSize:"d4",predicate:["target:trait:unholy"]}]},strikeAdjustments:[{adjustTraits:(t,e)=>{e.includes("holy")||e.push("holy")}}]},hopeful:{attack:{notes:[{outcome:["criticalSuccess"],title:"PF2E.WeaponPropertyRune.hopeful.Name",text:"PF2E.WeaponPropertyRune.hopeful.Note.criticalSuccess"}]},level:11,name:"PF2E.WeaponPropertyRune.hopeful.Name",price:1200,rarity:"uncommon",slug:"hopeful",traits:["magical"]},hooked:{level:5,name:"PF2E.WeaponPropertyRune.hooked.Name",price:140,rarity:"rare",slug:"hooked",traits:["magical"],strikeAdjustments:[{adjustWeapon:t=>{t.system.traits.value.includes("trip")||t.system.traits.value.push("trip")}}]},impactful:{damage:{dice:[{damageType:"force",diceNumber:1,dieSize:"d6"}],notes:[{outcome:["criticalSuccess"],title:"PF2E.WeaponPropertyRune.impactful.Name",text:"PF2E.WeaponPropertyRune.impactful.Note.criticalSuccess"}]},level:10,name:"PF2E.WeaponPropertyRune.impactful.Name",price:1e3,rarity:"common",slug:"impactful",traits:["force","magical"]},impossible:{level:20,name:"PF2E.WeaponPropertyRune.impossible.Name",price:7e4,rarity:"common",slug:"impossible",traits:["magical"],strikeAdjustments:[{adjustWeapon:t=>{if(t.isOfType("weapon")&&t.system.range&&t._source.system.range){let e=t._source.system.range,n=t.system.range;t.system.range=e*2+Math.abs(n-e)}}}]},keen:{attack:{},level:13,name:"PF2E.WeaponPropertyRune.keen.Name",price:3e3,rarity:"uncommon",slug:"keen",traits:["magical"]},kinWarding:{level:3,name:"PF2E.WeaponPropertyRune.kinWarding.Name",price:52,rarity:"uncommon",slug:"kinWarding",traits:["dwarf","magical"]},majorFanged:{level:15,name:"PF2E.WeaponPropertyRune.majorFanged.Name",price:6e3,rarity:"uncommon",slug:"majorFanged",traits:["magical"]},majorRooting:{level:15,name:"PF2E.WeaponPropertyRune.majorRooting.Name",price:6500,rarity:"common",slug:"majorRooting",traits:["plant","magical","wood"],damage:{notes:[{outcome:["criticalSuccess"],title:"PF2E.WeaponPropertyRune.majorRooting.Name",text:"PF2E.WeaponPropertyRune.majorRooting.Note.criticalSuccess"}]}},merciful:{strikeAdjustments:[{adjustWeapon:t=>{t.system.traits.value.includes("nonlethal")||t.system.traits.value.push("nonlethal")}}],level:4,name:"PF2E.WeaponPropertyRune.merciful.Name",price:70,rarity:"common",slug:"merciful",traits:["magical","mental"]},pacifying:{level:5,name:"PF2E.WeaponPropertyRune.pacifying.Name",price:150,rarity:"uncommon",slug:"pacifying",traits:["magical"]},returning:{attack:{notes:[{title:"PF2E.WeaponPropertyRune.returning.Name",text:"PF2E.WeaponPropertyRune.returning.Note"}]},level:3,name:"PF2E.WeaponPropertyRune.returning.Name",price:55,rarity:"common",slug:"returning",traits:["magical"]},rooting:{level:7,name:"PF2E.WeaponPropertyRune.rooting.Name",price:360,rarity:"common",slug:"rooting",traits:["plant","magical","wood"],damage:{notes:[{outcome:["criticalSuccess"],title:"PF2E.WeaponPropertyRune.rooting.Name",text:"PF2E.WeaponPropertyRune.rooting.Note.criticalSuccess"}]}},serrating:{damage:{dice:[{damageType:"slashing",diceNumber:1,dieSize:"d4"}]},level:10,name:"PF2E.WeaponPropertyRune.serrating.Name",price:1e3,rarity:"uncommon",slug:"serrating",traits:["magical"]},shifting:{level:6,name:"PF2E.WeaponPropertyRune.shifting.Name",price:225,rarity:"common",slug:"shifting",traits:["magical"]},shock:{damage:{dice:[{damageType:"electricity",diceNumber:1,dieSize:"d6"}],notes:[{outcome:["criticalSuccess"],title:"PF2E.WeaponPropertyRune.shock.Name",text:"PF2E.WeaponPropertyRune.shock.Note.criticalSuccess"}]},level:8,name:"PF2E.WeaponPropertyRune.shock.Name",price:500,rarity:"common",slug:"shock",traits:["electricity","magical"]},speed:{level:16,name:"PF2E.WeaponPropertyRune.speed.Name",price:1e4,rarity:"rare",slug:"speed",traits:["magical"]},spellStoring:{level:13,name:"PF2E.WeaponPropertyRune.spellStoring.Name",price:2700,rarity:"uncommon",slug:"spellStoring",traits:["magical"]},swarming:{level:9,name:"PF2E.WeaponPropertyRune.swarming.Name",price:700,rarity:"common",slug:"swarming",traits:["magical"]},thundering:{damage:{dice:[{damageType:"sonic",diceNumber:1,dieSize:"d6"}],notes:[{outcome:["criticalSuccess"],title:"PF2E.WeaponPropertyRune.thundering.Name",text:"PF2E.WeaponPropertyRune.thundering.Note.criticalSuccess"}]},level:8,name:"PF2E.WeaponPropertyRune.thundering.Name",price:500,rarity:"common",slug:"thundering",traits:["magical","sonic"]},trueRooting:{level:19,name:"PF2E.WeaponPropertyRune.trueRooting.Name",price:4e4,rarity:"common",slug:"trueRooting",traits:["plant","magical","wood"],damage:{notes:[{outcome:["criticalSuccess"],title:"PF2E.WeaponPropertyRune.trueRooting.Name",text:"PF2E.WeaponPropertyRune.trueRooting.Note.criticalSuccess"}]}},underwater:{level:3,name:"PF2E.WeaponPropertyRune.underwater.Name",price:50,rarity:"common",slug:"underwater",traits:["magical","water"]},unholy:{level:11,name:"PF2E.WeaponPropertyRune.unholy.Name",price:1400,rarity:"common",slug:"unholy",traits:["unholy","magical"],damage:{dice:[{damageType:"spirit",diceNumber:1,dieSize:"d4",predicate:[{not:"target:trait:holy"}]},{damageType:"spirit",diceNumber:2,dieSize:"d4",predicate:["target:trait:holy"]}]},strikeAdjustments:[{adjustTraits:(t,e)=>{e.includes("unholy")||e.push("unholy")}}]},vorpal:{level:17,name:"PF2E.WeaponPropertyRune.vorpal.Name",price:15e3,rarity:"rare",slug:"vorpal",traits:["magical"]},wounding:{damage:{dice:[{damageType:"bleed",diceNumber:1,dieSize:"d6"}]},level:7,name:"PF2E.WeaponPropertyRune.wounding.Name",price:340,rarity:"common",slug:"wounding",traits:["magical"]}};function Tn(t){return t.flatMap(e=>qn[e].strikeAdjustments??[])}a(Tn,"getPropertyRuneStrikeAdjustments");async function Rn(t){let[e,n]=canvas.ready&&!t.viewOnly?[canvas.tokens.controlled.find(v=>v.actor===this)??this.getActiveTokens().shift()??null,t.target?.token??t.target?.actor?.getActiveTokens().shift()??null]:[null,null],i=["attack","attack-roll","attack-damage"].some(v=>t.domains.includes(v)),r=!!(t.melee||t.item?.isOfType("weapon","melee")&&t.item.isMelee),o=r&&t.item?.isOfType("action","weapon","melee")?this.getReach({action:"attack",weapon:t.item}):this.getReach({action:"attack"}),s=!!(i&&r&&typeof o=="number"&&n?.actor&&e?.isFlanking(n,{reach:o})),c=await mt({affects:"origin",origin:this,target:t.target?.actor??n?.actor??null,item:t.item??null,domains:t.domains,options:[...t.options,...t.item?.getRollOptions("item")??[]]}),l=(()=>{let v=n?this.synthetics.tokenMarks.get(n.document.uuid):null;return v?`target:mark:${v}`:null})(),p=t.traits?.map(v=>`self:action:trait:${v}`)??[],u=t.viewOnly||!n?.actor?this:this.getContextualClone(re.compact([...Array.from(t.options),...n.actor.getSelfRollOptions("target"),l,...p,s?"self:flanking":null]),c),d=t.statistic instanceof game.pf2e.StatisticModifier,m=d?u.system.actions?.flatMap(v=>[v,v.altUsages??[]].flat())??[]:[],g=t.viewOnly?t.statistic:d?m.find(v=>t.item?.id!==v.item.id||t?.item.name!==v.item.name?!1:t.item.isOfType("melee")&&v.item.isOfType("melee")?!0:t.item.isOfType("weapon")&&v.item.isOfType("weapon")&&t.item.isMelee===v.item.isMelee)??t.statistic:t.statistic,y=(()=>{if(u===this)return t.item??null;if(g&&"item"in g&&g.item instanceof Item&&g.item.isOfType("action","melee","spell","weapon"))return g.item;let v=u.items.get(t.item?.id??"");return v?.isOfType("melee","weapon")?v:t.item??null})(),S=y?.getRollOptions("item")??[],O=(()=>{let v=re.compact([t.traits].flat());if(y?.isOfType("weapon","melee")){let N=[u.synthetics.strikeAdjustments,Tn(y.system.runes.property)].flat();for(let H of N)H.adjustTraits?.(y,v)}return re.uniq(v).sort()})(),b=e&&n?e.distanceTo(n):null,[k,x]=typeof b=="number"?[`origin:distance:${b}`,`target:distance:${b}`]:[null,null],T=(()=>{let v=e?n?.actor?.synthetics.tokenMarks.get(e.document.uuid):null;return v?`origin:mark:${v}`:null})(),W=e&&n?re.compact(re.uniq([...u.getSelfRollOptions("origin"),...O.map(v=>`origin:action:trait${v}`),...k?[k]:[],T])):[],E=a(v=>{let N=v?.getSelfRollOptions("target")??[];return n&&(N.push("target"),l&&N.push(l)),N.sort()},"getTargetRollOptions"),F=E(n?.actor),G=await mt({affects:"target",origin:u,target:n?.actor??null,item:y,domains:t.domains,options:[...t.options,...S,...F]});if(e?.actor&&n?.actor&&!t.viewOnly){let v=ie(e,n,{extraOptions:S,distance:b}),N=oe(e,n,{perception:v,affects:"origin"});N&&U(v,"target","visibility","noff",N)&&(N=void 0),P[N]>P.concealed&&G.push(Dt(N));let H=st(e,n,{perception:v,affects:"target",options:S}),ge;if(H){let se=U(v,"target","cover","ac",H)?.first();se!=null&&(se=Math.clamped(tt(se),0,4)),se===0?H=void 0:se&&(ge=se)}R[H]>R.none&&G.push(he(H,ge))}if(s&&jt(n.actor,u,W)){let v=game.i18n.localize("PF2E.Item.Condition.Flanked"),N=game.pf2e.ConditionManager.getCondition("off-guard",{name:v});G.push(N.toObject())}let ae=t.viewOnly?null:(t.target?.actor??n?.actor)?.getContextualClone(re.compact([...t.options,...S,...W]),G)??null,Te=new Set(re.compact([...t.options,...u.getRollOptions(t.domains),...ae?E(ae):F,...O.map(v=>`self:action:trait:${v}`),...S,i?"attack":null]).sort());x&&Te.add(x);let A=y?zt(y,b):null;A&&Te.add(`target:range-increment:${A}`);let _={actor:u,token:e?.document??null,statistic:g,item:y,modifiers:[]},D=ae&&n&&b!==null?{actor:ae,token:n.document,distance:b,rangeIncrement:A}:null;return{options:Te,self:_,target:D,traits:O}}a(Rn,"getRollContext");var Yn=["cover","concealed","hidden","undetected","unnoticed"],Me=class extends FormApplication{static get defaultOptions(){return foundry.utils.mergeObject(super.defaultOptions,{template:Q("icon-path-menu"),title:h("settings.icon-path.name"),width:500})}getData(){let e=C("icon-path");return{icons:Yn.map(i=>({name:i,placeholder:Ve[i],value:e[i]??"",label:i==="cover"?h("icon-path.cover"):game.i18n.localize(CONFIG.PF2E.conditionTypes[i])})),i18n:h}}activateListeners(e){super.activateListeners(e),e.find("button[name=cancel]").on("click",n=>{n.prefentDefault(),this.close()})}async _updateObject(e,n){ze("icon-path",n)}};a(Me,"IconPathMenu");function xn(){j("icon-path",Object,{},{config:!1}),game.settings.registerMenu(f,"icon-path-menu",{name:I("icon-path","name"),label:I("icon-path","label"),icon:"fa-solid fa-list",restricted:!0,type:Me}),j("permission",String,CONST.USER_ROLES.GAMEMASTER,{choices:{1:I("permission","choices.1"),2:I("permission","choices.2"),3:I("permission","choices.3"),4:I("permission","choices.4")}}),j("npc-vision",Boolean,!1),j("target",Boolean,!0,{onChange:()=>ui.combat?.render()}),j("lesser",String,"ten",{choices:{none:I("lesser","choices.none"),cross:I("lesser","choices.cross"),zero:I("lesser","choices.zero"),ten:I("lesser","choices.ten"),twenty:I("lesser","choices.twenty")}}),j("standard",Boolean,!0),j("dead-cover",Boolean,!0),j("prone-cover",Boolean,!0),j("standard-type",String,"center",{choices:{center:I("standard-type","choices.center"),points:I("standard-type","choices.points")}}),j("skip-cover",Boolean,!0),j("validation",String,"all",{choices:{all:I("validation","choices.all"),selected:I("validation","choices.selected"),changed:I("validation","choices.changed")}}),j("flat-check",String,"roll",{choices:{none:I("flat-check","choices.none"),roll:I("flat-check","choices.roll"),cancel:I("flat-check","choices.cancel")}}),j("encounter",Boolean,!1)}a(xn,"registerSettings");function I(t,e){return`${f}.settings.${t}.${e}`}a(I,"path");function j(t,e,n,i={}){game.settings.register(f,t,{name:I(t,"name"),hint:I(t,"hint"),scope:"world",config:!0,type:e,default:n,...i})}a(j,"register");var Qn="game.pf2e.Check.roll",Zn="CONFIG.Token.documentClass.prototype.rulesBasedVision",Jn="CONFIG.MeasuredTemplate.objectClass.prototype.highlightGrid",Xn="CONFIG.Actor.documentClass.prototype.getRollContext",ei="CONFIG.PF2E.Actor.documentClasses.npc.prototype.visionLevel",ti="DetectionMode.prototype.testVisibility",ni="CONFIG.Canvas.detectionModes.basicSight._canDetect",ii="CONFIG.Canvas.detectionModes.hearing._canDetect",oi="CONFIG.Canvas.detectionModes.feelTremor._canDetect";Hooks.once("init",()=>{xn(),mn(),Qt(),libWrapper.register(f,Qn,fn),libWrapper.register(f,Jn,qt,"OVERRIDE"),libWrapper.register(f,Zn,an,"OVERRIDE"),libWrapper.register(f,Xn,Rn,"OVERRIDE"),libWrapper.register(f,ei,wt,"OVERRIDE"),libWrapper.register(f,ti,Pn,"OVERRIDE"),libWrapper.register(f,ni,kn,"OVERRIDE"),libWrapper.register(f,ii,En,"OVERRIDE"),libWrapper.register(f,oi,Sn,"OVERRIDE"),game.data.users.find(e=>e._id===game.data.userId).role>=CONST.USER_ROLES.GAMEMASTER?(Hooks.on("renderSceneConfig",Vt),Hooks.on("renderCombatTrackerConfig",vn)):Hooks.on("renderCombatTracker",hn),game.modules.get(f).custom={getWallCover:void 0}});Hooks.once("ready",()=>{game.modules.get(f).api=gn,Hooks.on("renderChatMessage",Et);for(let t of document.querySelectorAll("#chat-log .chat-message")){let e=game.messages.get(t.dataset.messageId);e&&Et(e,$(t))}game.user.isGM&&game.modules.get("pf2e-rules-based-npc-vision")?.active&&ui.notifications.error(`${f}.warning.npc-vision`,{permanent:!0,localize:!0})});Hooks.on("hoverToken",nn);Hooks.on("pasteToken",Xt);Hooks.on("updateToken",tn);Hooks.on("deleteToken",on);Hooks.on("controlToken",rn);Hooks.on("renderTokenHUD",Jt);Hooks.on("preCreateToken",sn);Hooks.on("canvasPan",()=>pe());Hooks.on("renderCheckModifiersDialog",yn);Hooks.on("preCreateMeasuredTemplate",Yt);Hooks.on("createMeasuredTemplate",Xe);Hooks.on("updateMeasuredTemplate",Xe);Hooks.on("deleteMeasuredTemplate",Xe);})();
//# sourceMappingURL=main.js.map
