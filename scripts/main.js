(()=>{var Ct=Object.defineProperty;var Wi=(t,e,i)=>e in t?Ct(t,e,{enumerable:!0,configurable:!0,writable:!0,value:i}):t[e]=i;var a=(t,e)=>Ct(t,"name",{value:e,configurable:!0});var Ne=(t,e,i)=>(Wi(t,typeof e!="symbol"?e+"":e,i),i),Ot=(t,e,i)=>{if(!e.has(t))throw TypeError("Cannot "+i)};var It=(t,e,i)=>(Ot(t,e,"read from private field"),i?i.call(t):e.get(t)),le=(t,e,i)=>{if(e.has(t))throw TypeError("Cannot add the same private member more than once");e instanceof WeakSet?e.add(t):e.set(t,i)};var q=(t,e,i)=>(Ot(t,e,"access private method"),i);var ve="Compendium.pf2e.other-effects.Item.I9lfZUiCwMiGogVi",P={[void 0]:0,observed:0,concealed:1,hidden:2,undetected:3,unnoticed:4},ue=["observed","concealed","hidden","undetected","unnoticed"],B=["none","lesser","standard","greater","greater-prone"],R={[void 0]:0,none:0,lesser:1,standard:2,greater:3,"greater-prone":4},V={cover:"none",visibility:"observed"},Pe=["attack-roll","spell-attack-roll"],Wt=[...Pe,"skill-check","perception-check"],ze={cover:"modules/pf2e-perception/images/cover.webp",concealed:"systems/pf2e/icons/conditions/concealed.webp",hidden:"systems/pf2e/icons/conditions/hidden.webp",undetected:"systems/pf2e/icons/conditions/undetected.webp",unnoticed:"systems/pf2e/icons/conditions/unnoticed.webp"};var pt="#000000",gt="#656665",At="#809e71",Dt=["darkness","dance-of-darkness","ravenous-darkness"],wt=["obscuring-mist","stinking-cloud","noxious-vapors"];var y="pf2e-perception";function X(t){return`modules/${y}/templates/${t}.hbs`}a(X,"templatePath");function h(...t){let e=t.at(-1),i=typeof e=="object",n=i?t.slice(0,-1):t;return n.unshift(y),game.i18n[i?"format":"localize"](n.join("."),e)}a(h,"localize");function w(t,e){return t.getFlag(y,e)}a(w,"getFlag");function mt(t,e,i){return t.setFlag(y,e,i)}a(mt,"setFlag");function $t(t,e){return t.unsetFlag(y,e,!0)}a($t,"unsetFlag");function Mt(t){return getProperty(t,`flags.${y}`)??{}}a(Mt,"getFlags");function C(t){return game.settings.get(y,t)}a(C,"getSetting");function je(t,e){return game.settings.set(y,t,e)}a(je,"setSetting");function _t(){return game.user.role>=C("permission")}a(_t,"hasPermission");function Lt(t){let i=game.pf2e.ConditionManager.getCondition("off-guard").toObject();return i.name+=` (${game.i18n.localize(`PF2E.condition.${t}.name`)})`,i}a(Lt,"createFlatFootedSource");function ke(t,e){return e??=R[t]===3?4:R[t],{_id:"I9lfZUiCwMiGogVi",img:"systems/pf2e/icons/conditions-2/status_acup.webp",name:h("cover",t),system:{description:{gm:"",value:"<p>When you're behind an obstacle that could block weapons, guard you against explosions, and make you harder to detect, you're behind cover. Standard cover gives you a +2 circumstance bonus to AC, to Reflex saves against area effects, and to Stealth checks to Hide, Sneak, or otherwise avoid detection. You can increase this to greater cover using the Take Cover basic action, increasing the circumstance bonus to +4. If cover is especially light, typically when it's provided by a creature, you have lesser cover, which grants a +1 circumstance bonus to AC. A creature with standard cover or greater cover can attempt to use Stealth to Hide, but lesser cover isn't sufficient.</p>"},rules:[{domain:"all",key:"RollOption",option:`self:cover-bonus:${e}`},{domain:"all",key:"RollOption",option:`self:cover-level:${t}`},{key:"FlatModifier",predicate:[{or:[{and:["self:condition:prone","item:ranged"]},{not:"self:cover-level:greater-prone"}]}],selector:"ac",type:"circumstance",value:e},{key:"FlatModifier",predicate:["area-effect",{not:"self:cover-level:greater-prone"}],selector:"reflex",type:"circumstance",value:e},{key:"FlatModifier",predicate:[{or:["action:hide","action:sneak","avoid-detection"]},{not:"self:cover-level:greater-prone"}],selector:"stealth",type:"circumstance",value:e},{key:"FlatModifier",predicate:["action:avoid-notice",{not:"self:cover-level:greater-prone"}],selector:"initiative",type:"circumstance",value:e}],slug:"effect-cover"},type:"effect",flags:{core:{sourceId:ve},[y]:{level:t,bonus:e}}}}a(ke,"createCoverSource");function Ge(t,e=void 0){if(t)return t.system.rules.find(i=>i.key==="ChoiceSet"&&(!e||i.flag===e))}a(Ge,"findChoiceSetRule");function Ce(t,e=!1){if(!t)return;let i=t.id,n=t.isToken;return(e?game.user.targets:canvas.tokens.controlled).find(r=>n?r.actor===t:r.actor.id===i)??t.getActiveTokens().shift()??null}a(Ce,"getActorToken");function Z(t){return t.itemTypes.condition.some(e=>e.slug==="prone")}a(Z,"isProne");function te(t,e=!1){let i=t.itemTypes.effect.find(n=>n.sourceId===ve);return e?Ge(i)?.selection.level:i}a(te,"getCoverEffect");function Vt(t,e){return!t||!e||!t.system.perception?.senses?!1:(e=e.toLowerCase(),!!t.system.perception.senses.find(({type:i})=>i===e))}a(Vt,"hasSense");function Ue(t){return Vt(t,"greater-darkvision")}a(Ue,"hasGreaterDarkvision");function Be(t){return Vt(t,"see-invisibility")}a(Be,"seeInvisibility");var He={LOWER_BY_TWO:-2,LOWER:-1,INCREASE:1,INCREASE_BY_TWO:2,TO_CRITICAL_FAILURE:"criticalFailure",TO_FAILURE:"failure",TO_SUCCESS:"success",TO_CRITICAL_SUCCESS:"criticalSuccess"},zt=["criticalFailure","failure","success","criticalSuccess"],qe,jt,be,Ke,de,Oe,Ye,Gt,ie=class{constructor(e,i,n=null){le(this,qe);le(this,be);le(this,de);le(this,Ye);e instanceof Roll?(this.dieResult=(e.isDeterministic?e.terms.find(o=>o instanceof NumericTerm):e.dice.find(o=>o instanceof Die&&o.faces===20))?.total??1,this.rollTotal=e.total):(this.dieResult=e.dieValue,this.rollTotal=e.dieValue+e.modifier),this.dc=typeof i=="number"?{value:i}:i,this.unadjusted=q(this,Ye,Gt).call(this),this.adjustment=q(this,qe,jt).call(this,this.unadjusted,n),this.value=this.adjustment?q(this,be,Ke).call(this,this.adjustment.amount,this.unadjusted):this.unadjusted}},L=ie;a(L,"DegreeOfSuccess"),qe=new WeakSet,jt=a(function(e,i){if(!i)return null;for(let n of["all",...zt]){let{label:o,amount:r}=i[n]??{};if(r&&o&&!(e===ie.CRITICAL_SUCCESS&&r===He.INCREASE)&&!(e===ie.CRITICAL_FAILURE&&r===He.LOWER)&&(n==="all"||zt.indexOf(n)===e))return{label:o,amount:r}}return null},"#getDegreeAdjustment"),be=new WeakSet,Ke=a(function(e,i){switch(e){case"criticalFailure":return 0;case"failure":return 1;case"success":return 2;case"criticalSuccess":return 3;default:return Math.clamped(i+e,0,3)}},"#adjustDegreeOfSuccess"),de=new WeakSet,Oe=a(function(e){return this.dieResult===20?q(this,be,Ke).call(this,He.INCREASE,e):this.dieResult===1?q(this,be,Ke).call(this,He.LOWER,e):e},"#adjustDegreeByDieValue"),Ye=new WeakSet,Gt=a(function(){let e=this.dc.value;return this.rollTotal-e>=10?q(this,de,Oe).call(this,ie.CRITICAL_SUCCESS):e-this.rollTotal>=10?q(this,de,Oe).call(this,ie.CRITICAL_FAILURE):this.rollTotal>=e?q(this,de,Oe).call(this,ie.SUCCESS):q(this,de,Oe).call(this,ie.FAILURE)},"#calculateDegreeOfSuccess"),Ne(L,"CRITICAL_FAILURE",0),Ne(L,"FAILURE",1),Ne(L,"SUCCESS",2),Ne(L,"CRITICAL_SUCCESS",3);function Ut(t,e){let i="",n=["standard","npc-vision"];for(let r of n){let s=Se(t.object,r);i+=`<div class="form-group pf2e-perception-injected">
    <label>${h(`settings.${r}.name`)}</label>
    <input type="checkbox" name="flags.pf2e-perception.${r}" ${s?"checked":""}>
    <p class="notes">${h(`settings.${r}.short`)}</p>
</div>`}i+="<hr>",e.find('.tab[data-tab="basic"] hr').first().after(i);let o=e.find(".pf2e-perception-injected").toArray().reduce((r,s)=>(r+=s.clientHeight,r),0);t.setPosition({top:t.position.top-o/2})}a(Ut,"renderSceneConfig");function z(t){if(t=t instanceof Token?t.document:t,!(t instanceof TokenDocument))return[];let e=t.scene.tokens.filter(i=>i!==t&&i.actor?.isOfType("creature"));if(C("encounter")){let i=game.combats.active;return i?e.filter(n=>{let o=n.actor,r=o.traits;return o.type==="familiar"||r.has("minion")||r.has("eidolon")||i.getCombatantByToken(n.id)}):e}return e}a(z,"getValidTokens");function ne(t,e){let i=z(t).map(n=>n.id);return e.filter(n=>{let o=n instanceof Token||n instanceof TokenDocument?n.id:n;return i.includes(o)})}a(ne,"validateTokens");function Se(t,e){return w(t,e)??C(e)}a(Se,"getSceneSetting");async function ft({affects:t,origin:e,target:i,item:n,domains:o,options:r}){if(!(e&&i))return[];let[s,c]=t==="target"?[e,i]:[i,e],l=[...r,s.getRollOptions(o),c.getSelfRollOptions(t)].flat(),p=n?n.isOfType("spell")?{spell:n}:{weapon:n}:{};return(await Promise.all(o.flatMap(u=>s.synthetics.ephemeralEffects[u]?.[t]??[]).map(u=>u({test:l,resolvables:p})))).flatMap(u=>u??[])}a(ft,"extractEphemeralEffects");function Bt(t,e){if(!t.isOfType("action","melee","weapon"))return null;let{increment:i}=t.range??{};return i&&typeof e=="number"?Math.max(Math.ceil(e/i),1):null}a(Bt,"getRangeIncrement");function Ht(t,e){if(!t?.isOfType("creature"))return!1;let{flanking:i}=t.attributes;return i.flankable?typeof i.offGuardable=="number"?e.level>i.offGuardable:i.offGuardable:!1}a(Ht,"isOffGuardFromFlanking");function yt(t){return typeof t=="object"&&t!==null}a(yt,"isObject");function Kt(t,e){return t.includes(e)}a(Kt,"tupleHasValue");function Ai(t,e){return canvas.dimensions?canvas.grid.type!==CONST.GRID_TYPES.SQUARE?canvas.grid.measureDistance(t,e):Di(new Ray(t,e)):NaN}a(Ai,"measureDistance");function Di(t,{reach:e=null}={}){if(!canvas.dimensions)return NaN;let i=canvas.dimensions.size,n=canvas.dimensions.distance,o=Math.ceil(Math.abs(t.dx/i)),r=Math.ceil(Math.abs(t.dy/i)),s=Math.ceil(Math.abs((t.dz||0)/i)),c=[o,r,s].sort((d,g)=>d-g),l={doubleDiagonal:c[0],diagonal:c[1]-c[0],straight:c[2]-c[1]},p=l.diagonal+l.doubleDiagonal>1&&e===10?1:0;return(Math.floor(l.doubleDiagonal*1.75+l.diagonal*1.5+l.straight)-p)*n}a(Di,"measureDistanceOnGrid");function qt({areaType:t,object:e,colors:i,document:n,collisionType:o="move",preview:r=!1,collisionOrigin:s}){if(!e.id&&!r)return;let{grid:c,dimensions:l}=canvas;if(!(c&&l))return;let p=n.angle??0,u=n.direction??45,d=c.getHighlightLayer(e.highlightId)?.clear();if(!d)return;let[g,m]=c.getCenter(n.x,n.y),[f,S]=c.grid.getGridPositionFromPixels(g,m),I=(360+(u-p*.5)%360)%360,E=(360+(u+p*.5)%360)%360,k=canvas.grid.getSnappedPosition(n.x,n.y,e.layer.gridPrecision),x=a((A,M,D)=>(A=(360+A%360)%360,M=(360+M%360)%360,D=(360+D%360)%360,A<M?D>=A&&D<=M:D>=A||D<=M),"withinAngle"),T=(()=>{if(t!=="cone")return{x:0,y:0};let A=(u>=0?360-u:-u)%360,M=k.x%l.size!==0?Math.sign(1*Math.round(Math.cos(Math.toRadians(A))*100)/100)/2:0,D=k.y%l.size!==0?-Math.sign(1*Math.round(Math.sin(Math.toRadians(A))*100)/100)/2:0;return{x:M*l.size,y:D*l.size}})(),W=Math.clamped(n.width??0,1.5,2),b=n.distance??0,F=b*W/l.distance,G=Math.ceil(F/(l.size/c.h)),se=Math.ceil(F/(l.size/c.w)),Fe=a(A=>{if(!(t==="emanation"&&e instanceof Token))return{x:0,y:0};if(e.w<=l.size)return{x:0,y:0};let M=(e.w-l.size)/2,D=a((v,N)=>N===v?0:N>v?M:-M,"getCoordinate");return{x:D(e.center.x,A.x),y:D(e.center.y,A.y)}},"offsetEmanationOrigin");for(let A=-se;A<se;A++)for(let M=-G;M<G;M++){let[D,v]=canvas.grid.grid.getPixelsFromGridPosition(f+A,S+M),N={x:D+l.size*.5,y:v+l.size*.5};if(N.x<0||N.y<0)continue;let K=Fe(N),he={x:k.x+T.x+K.x,y:k.y+T.y+K.y};if(t==="cone"){let Nt=new Ray(he,N),Ii=(360+Nt.angle/(Math.PI/180)%360)%360;if(Nt.distance>0&&!x(I,E,Ii))continue}if(Ai(N,he)>b)continue;canvas.ready&&CONFIG.Canvas.polygonBackends[o].testCollision(s??he,N,{type:o,mode:"any"})?(c.grid.highlightGridPosition(d,{x:D,y:v,border:1,color:0}),d.beginFill(0,.5).moveTo(D,v).lineTo(D+l.size,v+l.size).endFill()):c.grid.highlightGridPosition(d,{x:D,y:v,border:i.border,color:i.fill})}}a(qt,"highlightGrid");var wi={burst:"circle",emanation:"circle",line:"ray",cone:"cone",rect:"rect",cube:"rect",square:"rect"};function Qe({type:t="burst",token:e,distance:i}){ht(e)&&(i??=t==="cone"?30:15,vt({type:t,distance:i,traits:["concentrate","secret"],flags:{type:"seek",tokenId:e.id,collisionType:"sight",collisionOrigin:e.center}}))}a(Qe,"createSeekTemplate");function Yt({type:t="burst",distance:e=20,conceal:i=!1}={}){vt({type:t,distance:e,fillColor:pt,flags:{type:"darkness",conceal:i}})}a(Yt,"createDarknessTemplate");function Qt({type:t="burst",distance:e=20}={}){vt({type:t,distance:e,fillColor:gt,flags:{type:"mist"}})}a(Qt,"createMistTemplate");function Xt(t,e){return e&&!ht(e)?null:canvas.scene.templates.filter(i=>w(i,"type")===t)??[]}a(Xt,"getTemplates");function Xe(t){return Xt("darkness",t)}a(Xe,"getDarknessTemplates");function Ze(t){return Xt("mist",t)}a(Ze,"getMistTemplates");function Je(t){if(!ht(t))return null;let e=canvas.scene.templates.find(i=>w(i,"type")==="seek");return e?(t=t instanceof Token?t.document:t,Ee(e,{collisionType:"sight",collisionOrigin:t.center})):null}a(Je,"getSeekTemplateTokens");async function J(t){let e=t.scene.templates.filter(i=>w(i,"type")==="seek"&&w(i,"tokenId")===t.id);for(let i of e)await i.delete()}a(J,"deleteSeekTemplate");function ht(t){return canvas.scene===t.scene?!0:(ui.notifications.error(h("template.scene")),!1)}a(ht,"checkScene");function vt({type:t,distance:e,traits:i,fillColor:n,width:o,flags:r}){let s=wi[t],c={distance:e,t:s,fillColor:n||game.user.color,flags:{[y]:r}};switch(s){case"ray":c.width=o||CONFIG.MeasuredTemplate.defaults.width*(canvas.dimensions?.distance??1);break;case"cone":c.angle=CONFIG.MeasuredTemplate.defaults.angle;break;case"rect":{let l=c.distance??0;c.distance=Math.hypot(l,l),c.width=l,c.direction=45;break}}i&&setProperty(c,"flags.pf2e.origin.traits",i),canvas.templates.createPreview(c)}a(vt,"createTemplate");function Ee(t,{collisionOrigin:e,collisionType:i="move"}={}){if(t=t instanceof MeasuredTemplateDocument?t.object:t,!canvas.scene)return[];let{grid:n,dimensions:o}=canvas;if(!(n&&o))return[];let r=n.getHighlightLayer(t.highlightId);if(!r||n.type!==CONST.GRID_TYPES.SQUARE)return[];let s=e??t.center,c=canvas.tokens.quadtree.getObjects(r.getLocalBounds(void 0,!0)),l=[];for(let p of c){let u=p.document,d=[];for(let g=0;g<u.height;g++){let m=p.y+g*n.size;if(d.push(`${p.x}.${m}`),u.width>1)for(let f=1;f<u.width;f++)d.push(`${p.x+f*n.size}.${m}`)}for(let g of d){if(!r.positions.has(g))continue;let[m,f]=g.split(".").map(E=>Number(E)),S={x:m+o.size*.5,y:f+o.size*.5};if(S.x<0||S.y<0)continue;if(!(canvas.ready&&i&&CONFIG.Canvas.polygonBackends[i].testCollision(s,S,{type:i,mode:"any"}))){l.push(p);break}}}return l}a(Ee,"getTemplateTokens");function Zt(){let t=["circle","cone"].includes(this.document.t),e=canvas.grid.type===CONST.GRID_TYPES.SQUARE;if(!t||!e)return MeasuredTemplate.prototype.highlightGrid.call(this);if(!this.isVisible){canvas.grid.getHighlightLayer(this.highlightId)?.clear();return}let i=w(this.document,"collisionType"),n=w(this.document,"collisionOrigin");this.snapForShape(),qt({areaType:Kt(["burst","cone","emanation"],this.areaType)?this.areaType:"burst",object:this,document:this.document,colors:{border:this.borderColor,fill:this.fillColor},preview:!0,collisionType:i,collisionOrigin:n})}a(Zt,"highlightTemplateGrid");function Jt(t){let{type:e,slug:i,castLevel:n=0}=t.getFlag("pf2e","origin")??{};e==="spell"&&(Dt.includes(i)?t.updateSource({fillColor:pt,[`flags.${y}`]:{type:"darkness",conceal:n>=4}}):wt.includes(i)?t.updateSource({fillColor:gt,[`flags.${y}`]:{type:"mist"}}):i==="cloudkill"&&t.updateSource({fillColor:At,[`flags.${y}`]:{type:"mist"}}))}a(Jt,"preCreateMeasuredTemplate");function et(t){w(t,"type")==="darkness"&&canvas.perception.update({initializeVision:!0})}a(et,"onMeasuredTemplate");function Te(t,e=1){let i=Object.getPrototypeOf(t);return e>1?Te(i,e-1):i}a(Te,"getPrototype");function tt(t,e){return t.name.localeCompare(e.name)}a(tt,"sortByName");function it(t){return t=Number(t),isNaN(t)?void 0:t}a(it,"asNumberOnly");var Y=class extends Application{#e;#i;#t;#n;#r;constructor({token:e,resolve:i,selected:n=[]},o={}){super(o),this.#e=e,this.#i=i,this.#t=n,this.#r=(r,s)=>{let c=r.id,l=this.element.find("[data-token-id]");l.removeClass("hover"),s&&l.filter(`[data-token-id=${c}]`).addClass("hover")},Hooks.on("hoverToken",this.#r)}async close(e={}){Hooks.off("hoverToken",this.#r),this.#i?.(e.resolve??!1),super.close(e)}static get defaultOptions(){return mergeObject(super.defaultOptions,{minimizable:!1})}static async openMenu(e,i={}){if(e.token instanceof TokenDocument&&(e.token=e.token.object),!e.token){ui.notifications.error(h("menu.no-token"));return}i.id=`${y}-${e.token.document.uuid}`;let n=Object.values(ui.windows).find(o=>o.id===i.id);return n&&n.close(),new Promise(o=>{e.resolve=o,new this(e,i).render(!0)})}static createPropertyData(e,i,n){let o=V[n],r=e[n]??o,s=i[n]??o;return{original:r,current:s,changed:r!==s,custom:s!==o,originalCustom:r!==o}}get token(){return this.#e}get document(){return this.#e.document}get actor(){return this.#e.actor}get scene(){return this.#e.scene}get selected(){return this.#t.length?ne(this.token,this.#t):[]}get currentData(){return deepClone(this.#o)}get#o(){return this.#n||(this.#n=this.getSavedData()),this.#n}getSavedData(){let e=_(this.document)??{};return deepClone(e)}reset(){this.#n=this.getSavedData(),this.#t=[],this.render()}isSelected(e){let i=typeof e=="object"?e.id:e;return this.#t.includes(i)}getData(e){return{i18n:h,covers:B.map(i=>({value:i,label:h(`cover.${i}`)})),visibilities:ue.map(i=>({value:i,label:h(`visibility.${i}`)}))}}activateListeners(e){e.find("[data-token-id]").on("mouseenter",i=>{let{tokenId:n}=i.currentTarget.dataset,o=this.scene.tokens.get(n)?.object;!o||o.controlled||o._onHoverIn(i,{hoverOutOthers:!0})}),e.find("[data-action=close]").on("click",()=>{this.close({resolve:!0})}),e.find("select[name=visibility], select[name=cover]").on("change",i=>{let n=i.currentTarget,o=n.name,r=V[o],s=n.value||r,c=n.closest(".token")?.dataset.tokenId,l=c?[c]:this.#t;for(let p of l)setProperty(this.#o,`${p}.${o}`,s);c?(n.classList.toggle("changed",s!==n.dataset.original),n.classList.toggle("custom",s!==r)):this.render()}),e.find("[data-action=accept]").on("click",i=>{this._saveData(this.#o),this.close({resolve:!0})})}_saveData(e){nt(this.document,e)}_setSelected(e){this.#t=e??this.element.find("[data-token-id].ui-selected").toArray().map(i=>i.dataset.tokenId)}_spliIntoAlliances(e){let i=[],n=[],o=[],r=this.actor.alliance,s=r==="party"?"opposition":r==="opposition"?"party":null;for(let c of e)if(s){let l=c.actor?c.actor.alliance:c.alliance;l===r?i.push(c):l===s?n.push(c):l===null&&o.push(c)}else o.push(c);return{allies:i.sort(tt),neutral:o.sort(tt),enemies:n.sort(tt),hasTokens:i.length||n.length||o.length}}};a(Y,"BaseMenu");var Ie=class extends Y{get title(){return h("menu.perception.title",{name:this.token.name})}get template(){return X("perception")}getData(e){let i=this.selected,n=this.currentData,o=this.getSavedData(),r=z(this.token).map(({id:s,name:c,actor:l})=>{let p=n[s]??{},u=o[s]??{};return{id:s,name:c,alliance:l.alliance,cover:Y.createPropertyData(u,p,"cover"),visibility:Y.createPropertyData(u,p,"visibility"),selected:i.includes(s)}});return{...super.getData(e),...this._spliIntoAlliances(r)}}activateListeners(e){super.activateListeners(e),e.filter(".tokens").selectable({autoRefresh:!1,filter:".token",cancel:"header,select",stop:()=>this._setSelected()}),e.find("[data-action=select-all]").on("click",i=>{let n=$(i.currentTarget).closest("section"),o=(n.length?n:e).find("[data-token-id]"),r=o.filter(":not(.ui-selected)").length===0;o.toggleClass("ui-selected",!r),this._setSelected()}),e.find("[data-action=use-selection]").on("click",i=>{this._setSelected(canvas.tokens.controlled.map(n=>n.id)),this.render()}),e.find("[data-action=reset]").on("click",i=>this.reset())}};a(Ie,"PerceptionMenu");var $i=[{x:.25,y:.25},{x:.5,y:.25},{x:.75,y:.25},{x:.25,y:.5},{x:.5,y:.5},{x:.75,y:.5},{x:.25,y:.75},{x:.5,y:.75},{x:.75,y:.75}];function rt(t,e){let i=1-e;return{top:{A:ee({x:e,y:e},t),B:ee({x:i,y:e},t)},right:{A:ee({x:i,y:e},t),B:ee({x:i,y:i},t)},bottom:{A:ee({x:i,y:i},t),B:ee({x:e,y:i},t)},left:{A:ee({x:e,y:i},t),B:ee({x:e,y:e},t)}}}a(rt,"getRectEdges");function We(t,e,i=!1){return i&&Q(t,e),CONFIG.Canvas.polygonBackends.move.testCollision(t,e,{type:"move",mode:"any"})}a(We,"lineIntersectWall");function ot(t,e,i=!1){for(let n of Mi(e.bounds))if(We(t,n,i))return!0;return!1}a(ot,"pointToTokenIntersectWall");function ee(t,e){return{x:e.x+e.width*t.x,y:e.y+e.height*t.y}}a(ee,"getRectPoint");function pe(){canvas.controls.debug.clear()}a(pe,"clearDebug");function Q(t,e,i="blue"){let n=i==="blue"?26316:i==="red"?16711680:1483011;canvas.controls.debug.lineStyle(4,n).moveTo(t.x,t.y).lineTo(e.x,e.y)}a(Q,"drawDebugLine");function*Mi(t){for(let e of $i)yield ee(e,t)}a(Mi,"rectSpread");function at(t,e=!1){if(t=t instanceof Token?t:t.object,t.document.hasStatusEffect(CONFIG.specialStatusEffects.INVISIBLE))return;let i=t.scene;if(i!==canvas.scene||!i.tokenVision||i.darkness<i.globalLightThreshold)return;e&&pe();let n=t.document.center,o=null;for(let r of canvas.effects.lightSources){if(!r.active)continue;let s=r.data.bright,c=r.data.dim;if(r.object===t){if(s)return"bright";c&&(o="dim");continue}if(!r.shape.contains(n.x,n.y)){e&&Q(r,n,"red");continue}if(r.ratio===1)return e&&Q(r,n,"green"),"bright";if(r.ratio===0){e&&Q(r,n,"blue"),o="dim";continue}if(new Ray(r,n).distance<=s)if(e)Q(r,n,"green"),o="bright";else return"bright";else e?(Q(r,n,"blue"),o!=="bright"&&(o="dim")):o="dim"}return o}a(at,"getLightExposure");var Re={cover:{cancel:{targets:["lesser","standard","greater","greater-prone"]},set:{targets:["none","lesser","standard","greater","greater-prone"],value:["none","lesser","standard","greater","greater-prone"]},reduce:{targets:["lesser","standard","greater","greater-prone"]},ignore:{targets:"string"},ignored:{targets:["allies","enemies"]},ac:{targets:["lesser","standard","greater","greater-prone"],value:["number"]}},visibility:{cancel:{targets:["concealed","hidden","undetected","unnoticed"]},set:{targets:["observed","concealed","hidden","undetected","unnoticed"],value:["observed","concealed","hidden","undetected","unnoticed"]},reduce:{targets:["concealed","hidden","undetected","unnoticed"]},noff:{targets:["hidden","undetected","unnoticed"]},noinvis:{},dc:{targets:["concealed","hidden"],value:["number","string"]}}},_i={cover:Object.keys(Re.cover),visibility:Object.keys(Re.visibility),all:[...Object.keys(Re.cover),...Object.keys(Re.visibility)]};function ei(){let t=game.pf2e.RuleElements.builtin.RollOption.defineSchema(),e=t.predicate.constructor,i=t.value.constructor;class n extends game.pf2e.RuleElement{constructor(r,s){typeof r.targets=="string"&&(r.targets=[r.targets]),super({priority:CONST.ACTIVE_EFFECT_MODES.CUSTOM,...r},s);let c=_i[r.type];if(!c)return;if(!c?.includes(r.selector)){this.failValidation(`The type "${r.type}" only accepts the following selectors: ${c.join(", ")}.`);return}let l=Re[r.type]?.[r.selector];if(!l)return;let p=a(g=>{let{name:m,uuid:f}=this.item;console.warn(`PF2e System | PF2ePerception rules element on item ${m} (${f}) simple warning: ${g}`)},"selectorWarn"),u=Array.isArray(l.targets)?[...l.targets,"all"]:l.targets,d=Array.isArray(u)?u.join(", "):null;if(!u&&r.targets?.length){p(`The selector "${r.selector}" doesn't accept any targets property.`);return}if(r.selector==="ignore"&&!r.targets?.length){let g=`The selector "${r.selector}" requires a targets property with the ids of the tokens on the scene that should not give cover.`;this.failValidation(g);return}if(d&&r.targets?.some(g=>!u.includes(g))){let g=`The targets property of selector "${r.selector}" only accepts the following: ${d}.`;this.failValidation(g);return}else if(!d&&u&&r.targets?.some(g=>typeof g!==u)){let g=`The targets property of selector "${r.selector}" needs to be of type "${u}".`;this.failValidation(g);return}if(!l.value&&r.value){p(`The selector "${r.selector}" doesn't accept any value property.`);return}if(r.selector==="set"){if(!l.value.includes(r.value)){let g=l.value.join(", "),m=`The selector "${r.selector}" only accepts the following: ${g}.`;this.failValidation(m)}}else{let g=typeof r.value;if(l.value&&!l.value.includes(g)){let m=`The selector "${r.selector}" does not accept a value property of type ${g}.`;this.failValidation(m)}}}static defineSchema(){let{fields:r}=foundry.data;return{...super.defineSchema(),type:new r.StringField({required:!0,nullable:!1,blank:!1,choices:["visibility","cover"]}),affects:new r.StringField({required:!0,nullable:!1,blank:!1,initial:"self",choices:["self","other"]}),selector:new r.StringField({required:!0,nullable:!1,blank:!1}),targets:new r.ArrayField(new r.StringField({required:!0,nullable:!1,blank:!1,initial:void 0}),{required:!0,nullable:!1,initial:["all"]}),predicate:new e({required:!1,nullable:!1}),value:new i({required:!1,initial:void 0})}}test(r,s){return s?super.test(r):!1}addToPerception(r,s,c){if(!this.test(c,!0))return;let p=`${this.affects==="self"?r:r==="origin"?"target":"origin"}.${this.type}.${this.selector}`,u=Re[this.type][this.selector];if(!u.targets){setProperty(s,p,!0);return}let d=this.targets.includes("all")?u.targets:this.targets;if(!u.value){for(let g of d){let m=`${p}.${g}`;setProperty(s,m,!0)}return}for(let g of d){let m=`${p}.${g}`,f=getProperty(s,m);f?f.add(this.value):f=new Set([this.value]),setProperty(s,m,f)}}}a(n,"PF2ePerceptionRuleElement"),game.pf2e.RuleElements.custom.PF2ePerception=n}a(ei,"setupRuleElement");function re(t,e,{distance:i,extraOptions:n=[]}={}){let o=t.actor,r=e.actor;if(!o||!r)return{};let s={origin:o.rules.filter(d=>!d.ignored&&d.key==="PF2ePerception")??[],target:r.rules.filter(d=>!d.ignored&&d.key==="PF2ePerception")??[]};if(!s.origin.length&&!s.target.length)return{};let c={origin:o.getRollOptions(),target:r.getRollOptions()},l={origin:r.getSelfRollOptions("target"),target:o.getSelfRollOptions("origin")};t=t instanceof Token?t:t.object,e=e instanceof Token?e:e.object,i??=t.distanceTo(e);let p=[`origin:distance:${i}`,`target:distance:${i}`],u={};for(let d of["origin","target"]){let g=[...n,...c[d],...l[d],...p];for(let m of s[d])m.addToPerception(d,u,g)}return u}a(re,"perceptionRules");function ti(t){let e=t.actor;return e?(e.rules.filter(n=>!n.ignored&&n.key==="PF2ePerception"&&n.type==="cover"&&n.selector==="ignored")??[]).flatMap(n=>n.targets):[]}a(ti,"getIgnoredPerception");function U(t,e,i,n,o){let r=t[e]?.[i]?.[n];return o?r?.[o]:r}a(U,"getPerception");function xe(t,e,i,n){n===void 0&&(n=i==="cover"?"none":"observed");let o=i==="cover"?B:ue;if(n&&U(t,e,i,"cancel",n))return;let r=U(t,e,i,"set",n)?.first();if(r&&o.includes(r))n=r;else if(n&&U(t,e,i,"reduce",n)){let s=o.indexOf(n);n=o[Math.max(0,s-1)]}return n===o[0]?void 0:n}a(xe,"updateFromPerceptionRules");function ii(t,e){!_t()||!t.object.actor?.isOfType("creature")||(e.find(".col.left").append('<div class="control-icon" data-action="pf2e-perception"><i class="fa-solid fa-eye"></i></div>'),e.find("[data-action=pf2e-perception]").on("click",i=>Pt(t.object)))}a(ii,"renderTokenHUD");function Pt(t){return Ie.openMenu({token:t})}a(Pt,"openHUD");function ni(t,e){for(let i of e)delete i.flags?.[y]}a(ni,"pasteToken");function _(t,...e){return e.unshift("data"),t=t instanceof Token?t.document:t,w(t,e.join("."))}a(_,"getTokenData");async function ri(t){return t=t instanceof Token?t.document:t,$t(t,"data")}a(ri,"clearTokenData");async function nt(t,e){let i=z(t).map(o=>o.id),n={};for(let o in e){if(!i.includes(o)){n[`flags.${y}.data.-=${o}`]=!0;continue}let r=e[o],s=_(t,o)??{};if(r.visibility===V.visibility&&delete r.visibility,r.cover===V.cover&&delete r.cover,!(s.cover===r.cover&&s.visibility===r.visibility))if(!r.visibility&&!r.cover)n[`flags.${y}.data.-=${o}`]=!0;else for(let c of["cover","visibility"])s[c]!==r[c]&&(r[c]?n[`flags.${y}.data.${o}.${c}`]=r[c]:n[`flags.${y}.data.${o}.-=${c}`]=!0)}return t=t instanceof Token?t.document:t,t.update(n)}a(nt,"setTokenData");function st(t,e,i=!1){let n=t.scene;return Se(n,"standard")?(i&&pe(),(C("standard-type")==="points"?ot(t.center,e,i):We(t.center,e.center,i))?"standard":void 0):void 0}a(st,"getWallCover");var ge={tiny:0,sm:1,med:2,lg:3,huge:4,grg:5};function ct(t,e,{perception:i={},options:n=[],affects:o="origin",debug:r=!1}={}){let s=n.includes("item:ranged")?Z(e.actor):!1,c=a(u=>xe(i,o,"cover",u),"returnValue"),l=te(e.actor,!0);if(s&&R[l]>R.lesser)return c("greater-prone");!s&&l==="greater-prone"&&(l=void 0);let p=_(e,t.id,"cover");if(s&&R[p]>R.lesser)return c("greater-prone");if(!s&&p==="greater-prone"&&(p=void 0),R[l]<R.standard){if(R[p]<R.standard){let u=game.modules.get(y).custom?.getWallCover,d;if(typeof u=="function"){let g=u(t,e,r);d=B.includes(g)?g:st(t,e,r)}else d=st(t,e,r);R[d]>R[p]&&(p=d)}if(R[p]<R.standard&&t.distanceTo(e)>5){let u=kt(t,e,{perception:i,debug:r});R[u]>R[p]&&(p=u)}}return s&&R[p]>R.lesser?c("greater-prone"):c(R[p]>R[l]?p:void 0)}a(ct,"getCover");function kt(t,e,{perception:i={},debug:n=!1}={}){let o=C("lesser");if(o==="none")return;t=t instanceof Token?t.document:t,e=e instanceof Token?e.document:e;let r=(()=>{let b=Object.keys(i.origin?.cover?.ignore??{}),F=Object.keys(i.target?.cover?.ignore??{});return new Set([...b,...F])})(),s,c=t.center,l=e.center,p=t.actor,u=e.actor;n&&(pe(),Q(c,l));let d=a(b=>{let F=ge[b.actor.size];return F-g>=2&&F-m>=2},"isExtraLarge"),g=ge[p.size],m=ge[u.size],f=p.alliance,S=C("dead-cover"),I=C("prone-cover"),E=t.scene.tokens.contents.filter(b=>{let F=b.actor,G=ti(b);return F&&!b.hidden&&b!==t&&b!==e&&(I||!Z(F))&&(S||F.hitPoints?.value!==0)&&!r.has(b.id)&&!(G.includes("all")||G.includes(F.alliance===f?"allies":"enemies"))}).sort((b,F)=>ge[F.actor.size]-ge[b.actor.size]),k=g<ge.huge&&m<ge.huge&&E.filter(d).length,x=o==="ten"?.1:o==="twenty"?.2:0,T=a(b=>(n&&Q(b.A,b.B,"red"),lineSegmentIntersects(c,l,b.A,b.B)),"intersectsEdge"),W=o==="cross"?b=>T(b.top)&&T(b.bottom)||T(b.left)&&T(b.right):b=>Object.values(b).some(F=>T(F));for(let b of E){let F=b.object,G=rt(F.bounds,x);if(W(G))return k?"standard":"lesser";d(b)&&k--}return s}a(kt,"getCreatureCover");function oe(t,e,{perception:i={},affects:n="origin",debug:o=!1}={}){t=t instanceof Token?t:t.object,e=e instanceof Token?e:e.object;let r=t.actor,s=e.actor,c=(()=>{if(!r||!s)return;let k;s.hasCondition("blinded")?k="hidden":s.hasCondition("dazzled")&&(k="concealed");for(let x of["unnoticed","undetected","hidden","concealed"])P[x]>P[k]&&r.hasCondition(x)&&(k=x);return k})(),l=a(k=>p?(P[k]<P.hidden&&(k="hidden"),(Be(s)||U(i,n,"visibility","noinvis"))&&(k="concealed"),xe(i,n,"visibility",k)):xe(i,n,"visibility",k),"returnValue"),p=r?.hasCondition("invisible"),u=_(t,e.id,"visibility"),d=P[c]>P[u]?c:u;if(P[d]>=P.hidden||p)return l(d);let g=s?.hasLowLightVision,m=s?.hasDarkvision,f=s&&Ue(s);if(f&&d==="concealed")return l(d);let S;if(!f){let k=Xe(t);if(k?.length){let x;for(let T of k){let W=Ee(T);if(!W.length)continue;if(W.includes(t)||W.includes(e))S=!0;else continue;if(!m)return l("hidden");w(T,"conceal")&&(x="concealed")}if(x==="concealed"&&(d="concealed"),S&&d==="concealed")return l(d)}}if(d!=="concealed"){let k=Ze(t);if(k?.length)for(let x of k){let T=Ee(x);if(!T.length)continue;if(T.includes(t)||T.includes(e))return l("concealed")}}if(S||f)return l(d);let I=at(t,o),E=I==="dim"?"concealed":I===null?"hidden":void 0;return(E==="concealed"&&g||E==="hidden"&&m)&&(E=void 0),P[E]>P[d]&&(d=E),l(d)}a(oe,"getVisibility");function oi(t,e,i,n){let o=e.flags?.["pf2e-perception"];if(o&&(o.data||o["-=data"]!==void 0)){if(t.object.renderFlags.set({refreshVisibility:!0}),game.user.isGM)return;let r=Hooks.on("refreshToken",s=>{!t.object!==s&&(Hooks.off("refreshToken",r),game.combat?.getCombatantByToken(t.id)&&ui.combat.render())})}}a(oi,"updateToken");function ai(t,e){e?lt(t):me(t)}a(ai,"hoverToken");function si(t){me(t),game.user.isGM||ui.combat.render()}a(si,"deleteToken");function ci(t,e){e&&(me(),Hooks.once("sightRefresh",()=>t.hover&&lt(t)))}a(ci,"controlToken");function me(t){if(!t?.id)return $(".pf2e-conditionals").remove();$(`.pf2e-conditionals[data-hover-id=${t.id}]`).remove(),$(`.pf2e-conditionals[data-token-id=${t.id}]`).remove()}a(me,"clearConditionals");function lt(t){let e=z(t);for(let i of e)bt(i,t)}a(lt,"showAllConditionals");async function bt(t,e){if(t=t instanceof Token?t:t.object,!t.visible||!t.actor?.isOfType("creature"))return;let i=_(t,e.id);if(isEmpty(i))return;if(!game.user.isGM&&!e.document.hasPlayerOwner&&P[i.visibility]>=P.hidden){if(!i.cover)return;i={cover:i.cover}}let n=t.worldTransform.a,o=canvas.clientCoordinatesFromCanvas(t.document._source),r=`<div class="pf2e-conditionals" data-hover-id="${t.id}" data-token-id="${e.id}" `;r+=`style="top: ${o.y}px; left: ${o.x+t.hitArea.width*n/2}px;">`;let s=C("icon-path");Object.entries(i).map(([c,l])=>{let p=c==="cover"?"cover":l,u=s[p]||ze[p];(u.startsWith("systems")||u.startsWith("modules"))&&(u=`../../../${u}`),r+=`<div class="conditional"><img src="${u}"></img></div>`}),r+="</div>",$(document.body).append(r)}a(bt,"showConditionals");function li(){return!!(this.sight.enabled&&this.actor?.isOfType("creature")&&this.scene?.rulesBasedVision)}a(li,"rulesBasedVision");function di(t){let e=t.actor;if(e?.isOfType("creature")&&(e.isOfType("npc")&&Se(t.scene,"npc-vision")&&t.updateSource({"sight.enabled":!0}),game.user.isGM&&t.hidden)){let i=game.user.targets,n={};for(let o of i)n[o.id]={visibility:"unnoticed"};i.size&&t.updateSource({[`flags.${y}.data`]:n})}}a(di,"preCreateToken");var Ae=class extends Y{static async openMenu(e,i){let n=await super.openMenu(e,i);return n&&e.message&&pi(e.message),n}get title(){return h("menu.validation.title",{name:this.token.name})}get template(){return X("validation")}get selected(){let e=super.selected;return e.length?e:this.globalSelection}get globalSelection(){let e=this.token,i=e.actor.alliance;return z(e).filter(n=>n.actor.alliance!==i).map(n=>n.id)}getSavedData(e=!0){let i=super.getSavedData();return e?this._convertData(i):i}_convertData(e){let i=this.property,n=this.scene,o=this.selected,r=V[i],s=i==="cover"?B:ue;for(let c of o){let l=n.tokens.get(c),p=`${c}.${i}`,u=getProperty(e,p)??r,d=this.processValue({token:l,value:u});s.includes(d)||(d=u),u!==d&&setProperty(e,p,d)}return e}processValue(e){throw new Error(`${this.constructor.name} doesn't have a 'processValue' method defined`)}getData(e){let{covers:i,visibilities:n,i18n:o}=super.getData(e),r=this.currentData,s=this.getSavedData(!1),c=this.property,l=this.selected,p=z(this.token);p=p.map(({id:d,name:g,actor:m})=>{let f=r[d]??{},S=s[d]??{};return{id:d,name:g,alliance:m.alliance,selected:l.includes(d),...Y.createPropertyData(S,f,c)}});let u=C("validation");return u==="selected"?p=p.filter(d=>d.selected):u==="changed"&&(p=p.filter(d=>d.changed)),{...this._spliIntoAlliances(p),i18n:o,property:c,options:c==="cover"?i:n,showSelected:l.length!==p.length&&u==="all",showChanges:u!=="changed"}}activateListeners(e){super.activateListeners(e),e.find("[data-action=cancel]").on("click",i=>{this.close()})}};a(Ae,"ValidationMenu");var De=class extends Ae{#e;constructor(e,i={}){super(e,i),this.#e=e.value}get property(){return"cover"}processValue(){return this.#e}};a(De,"CoverValidationMenu");var fe=class extends Ae{#e;constructor(e,i={}){super(e,i),this.#e=e.roll}get property(){return"visibility"}get roll(){return this.#e}};a(fe,"VisibilityValidationMenu");var we=class extends fe{processValue({token:e,value:i}){let n=this.roll,o=e.actor.perception.dc.value,r=P[i],s=new L(n,o).value;return s>=L.SUCCESS&&r<P.hidden?"hidden":s<=L.FAILURE&&r>=P.hidden?"observed":i}};a(we,"HideValidationMenu");var $e=class extends fe{get selected(){return z(this.token).map(e=>e.id)}processValue({token:e,value:i}){return P[i]>=P.hidden?"observed":i}};a($e,"UnHideValidationMenu");var Me=class extends fe{#e;constructor(e,i={}){super(e,i),this.#e=e.originator}get selected(){let e=this.token,i=e.actor.alliance,n=this.#e.id,o=_(e)??{};return z(e).filter(r=>{if(r.id===n||r.actor.alliance===i)return!1;let s=getProperty(o,`${r.id}.visibility`);return P[s]>=P.undetected}).map(r=>r.id)}processValue({token:e,value:i}){return P[i]>=P.undetected?"hidden":i}};a(Me,"PointOutValidationMenu");var ut=class extends fe{getSavedData(e=!0){let i=this.token.id,n=z(this.token),o={};for(let r of n){let s=_(r,i);s&&(o[r.id]=deepClone(s))}return e?this._convertData(o):o}getData(){let e=super.getData();return e.isReversed=!0,e.options=ue.map(i=>({value:i,label:h(`visibility.reversed.${i}`)})),e}_saveData(e){let i=this.scene,n=this.token.id,o=[];for(let[r,s]of Object.entries(e)){let c={_id:r},l=i.tokens.get(r);if(l){s.visibility===V.visibility&&delete s.visibility;let p=_(l,n)??{};if(p?.visibility===s.visibility)continue;!p.cover&&!s.visibility?c[`flags.${y}.data.-=${n}`]=!0:s.visibility?c[`flags.${y}.data.${n}.visibility`]=s.visibility:c[`flags.${y}.data.${n}.-=visibility`]=!0}else c[`flags.${y}.data.-=${n}`]=!0;o.push(c)}i.updateEmbeddedDocuments("Token",o)}};a(ut,"ReverseVisibilityValidationMenu");var _e=class extends ut{#e;constructor(e,i={}){super(e,i),this.#e=e.fromTemplate}get globalSelection(){return this.#e?[]:super.globalSelection}static async openMenu(e,i){await super.openMenu(e,i)&&J(e.token)}processValue({token:e,value:i}){let n=this.roll,o=e.actor.skills.stealth.dc.value,r=P[i],s=new L(n,o).value;return s>=L.CRITICAL_SUCCESS&&r>=P.hidden||s>=L.SUCCESS&&r===P.hidden?"observed":s>=L.SUCCESS&&r>=P.undetected?"hidden":i}};a(_e,"SeekValidationMenu");function Tt(t,e){let i=t.token;if(!i)return;let n=game.user.isGM,o=i.hasPlayerOwner,{cover:r,selected:s,skipWait:c,validated:l,pointOut:p}=Mt(t),u=t.getFlag("pf2e","context");if(r){if(n){let d=Et({property:"cover",skipWait:c,validated:l});e.find(".message-content").append(d),e.find("[data-action=validate-cover]").on("click",()=>{De.openMenu({token:i,selected:s,value:r,message:t})})}else if(!c){let d=St("cover",l);e.find(".message-content").append(d)}}else if(u?.pf2ePerception?.visibility){l||e.find(".message-buttons").remove();let d=e.find(".flavor-text");!n&&o&&(e.find(".message-sender").text(i.name),d.empty());let g=h(`message.flat-check.${l===void 0?"blind":l?"success":"failure"}`),m=fi(g,l);if(d.append(m),n)for(let f of["success","failure"])d.append(Rt({action:`${f}-message`,icon:"fa-solid fa-message",label:h("message.flat-check.button",f)})),e.find(`[data-action=${f}-message]`).on("click",()=>{mt(t,"validated",f==="success")})}else if(u?.type==="skill-check"&&u.pf2ePerception)if(n){if(u.options.includes("action:hide")){let d=Et({property:"visibility",skipWait:c,validated:l});e.find(".flavor-text").append(d),e.find("[data-action=validate-visibility]").on("click",()=>{we.openMenu({token:i,message:t,roll:t.rolls[0],selected:u.pf2ePerception.selected})})}}else o&&u.options.includes("action:hide")&&mi({token:i,message:t,html:e,validated:l});else if(u?.type==="perception-check"&&u.pf2ePerception)if(n){if(u.options.includes("action:seek")){let d=gi({skipWait:c,validated:l,smallAction:"delete-template",smallIcon:"fa-thin fa-cubes",smallSlashed:!0});e.find(".flavor-text").append(d),e.find("[data-action=validate-visibility]").on("click",()=>{_e.openMenu({token:i,message:t,roll:t.rolls[0],selected:u.pf2ePerception.selected,fromTemplate:u.pf2ePerception.fromTemplate})}),e.find("[data-action=delete-template").on("click",()=>{J(i)})}}else o&&u.options.includes("action:seek")&&mi({token:i,message:t,html:e,validated:l});else if(p){let d=i.scene.tokens.get(p);if(!d)return;if(n){let g=gi({skipWait:c,validated:l,smallAction:"ping-token",smallIcon:"fa-solid fa-signal-stream"});e.find(".message-content").append(g),e.find("[data-action=validate-visibility]").on("click",()=>{Me.openMenu({message:t,token:d,originator:i,selected:canvas.tokens.controlled.map(m=>m.id)})}),e.find("[data-action=ping-token]").on("click",()=>{canvas.ping(d.center)})}else if(o){let g=St("visibility",l);e.find(".message-content").append(g)}}if(n&&Pe.includes(u?.type)){let g=`<span class="pf2e-perception-unhide">
    <button data-action="unhide" title="${h("message.unhide.tooltip")}">
        <i class="fa-duotone fa-eye-slash"></i>
    </button>
</span>`;e.find(".dice-result .dice-total").append(g),e.find("[data-action=unhide]").on("click",m=>{m.stopPropagation(),$e.openMenu({token:i})})}}a(Tt,"renderChatMessage");function pi(t){w(t,"validated")||mt(t,"validated",!0)}a(pi,"validateMessage");function gi({skipWait:t,validated:e,smallIcon:i,smallAction:n,smallSlashed:o}){let r='<div class="pf2e-perception-chat-combo">';return r+=Et({property:"visibility",skipWait:t,validated:e}),r+=Rt({action:n,icon:i,slashed:o,tooltip:h(`message.visibility.small-button.${n}`)}),r+="</div>",r}a(gi,"createValidateCombo");function mi({html:t,token:e,message:i,validated:n}){t.find(".message-sender").text(e.name);let o=i.getFlag("pf2e","modifierName");o+=St("visibility",n),t.find(".flavor-text").html(o)}a(mi,"addBlindSkillCheckFlavor");function St(t,e){let i=h(`message.${t}.player.${e?"validated":"wait"}`);return fi(i,e)}a(St,"createWaitHint");function fi(t,e){return e===!0?t='<i class="fa-solid fa-check validated"></i> '+t:e===!1&&(t='<i class="fa-solid fa-xmark canceled"></i> '+t),`<i class="pf2e-perception-hint">${t}</i>`}a(fi,"createHint");function Et({skipWait:t,validated:e,property:i}){let n=h(`message.${i}.gm.${t?"check":e?"validated":"validate"}`);return!t&&e&&(n+='<i class="fa-solid fa-check validated"></i>'),Rt({action:`validate-${i}`,icon:"fa-solid fa-list",label:n})}a(Et,"createValidateButton");function Rt({action:t,icon:e,label:i,tooltip:n,slashed:o=!1}){let r=`<button type="button" class="pf2e-perception-chat-button" data-action="${t}" title="${n}">`;return e&&(r+=`<i class="${e} ${i?"":"no-label"}"></i>`,o&&(r+='<i class="fa-solid fa-slash-forward slashed"></i>')),i&&(r+=`${e?" ":""}${i}`),r+="</button>",r}a(Rt,"createChatButton");async function xt({content:t,token:e,flags:i,secret:n}){let o={content:t,speaker:ChatMessage.getSpeaker({token:e instanceof Token?e.document:e})};return i&&setProperty(o,`flags.${y}`,i),n&&(o.type=CONST.CHAT_MESSAGE_TYPES.WHISPER,o.whisper=ChatMessage.getWhisperRecipients("gm")),ChatMessage.create(o)}a(xt,"createTokenMessage");function hi(){let t=game.pf2e.actions.get("hide"),e=Te(t,2).constructor,i=Te(t.toActionVariant(),2).constructor,n=Te(t,1).constructor,o=Te(t.toActionVariant(),1).constructor;Bi(e,i),Ui(n,o),Gi(n,o),zi(n,o),Li(e,i)}a(hi,"setupActions");function Li(t,e){class i extends e{async use(r={}){let s=h("action.point-out"),c=Le(r,s);c&&Vi(this,c)}}a(i,"PointOutVariant");class n extends t{constructor(){super({cost:1,name:`${y}.action.point-out`,description:`${y}.action.point-out.description`,rollOptions:["action:point-out"],slug:"point-out",traits:["auditory","manipulate","visual"]})}toActionVariant(r={}){return r.name??=this.name,new i(this,r)}}a(n,"PointOut"),game.pf2e.actions.set("point-out",new n)}a(Li,"setupPointOut");async function Vi({name:t,traits:e},i){let n=game.user.targets.filter(p=>p.actor).first(),o=n?_(n,i.id,"visibility"):void 0,r=n&&P[o]<P.undetected,s;if(r){let p=n.actor.skills.stealth.dc.value;s=h("message.point-out.short-check",{check:`@Check[type:perception|dc:${p}|traits:auditory,manipulate,visual|showDC:gm]`})}else s=h("message.point-out.short");let c=await renderTemplate(X("point-out"),{description:s,name:t,traits:e.map(p=>({slug:p,tooltip:CONFIG.PF2E.traitsDescriptions[p],name:CONFIG.PF2E.actionTraits[p]}))}),l={pointOut:r?n.id:void 0};xt({content:c,token:i,flags:l})}a(Vi,"pointOut");function zi(t,e){class i extends e{async use(r={}){let s=game.i18n.localize("PF2E.Actions.Seek.Title"),c=Le(r,s);if(c)return await ji(c)?(r.actors=[c.actor],super.use(r)):J(c)}}a(i,"SeekVariant");class n extends t{constructor(){super({cost:1,description:"PF2E.Actions.Seek.Description",name:"PF2E.Actions.Seek.Title",notes:[{outcome:["criticalSuccess"],text:"PF2E.Actions.Seek.Notes.criticalSuccess"},{outcome:["success"],text:"PF2E.Actions.Seek.Notes.success"}],rollOptions:["action:seek"],slug:"seek",statistic:"perception",traits:["concentrate","secret"]})}toActionVariant(r){return new i(this,r)}}a(n,"Seek"),game.pf2e.actions.set("seek",new n)}a(zi,"setupSeek");async function ji(t){let e=game.i18n.localize("PF2E.Foot"),i='<p style="margin: 0 0.3em; text-align: center;">';return i+=`${h("dialog.seek.hint")}</p><p>`,i+=yi("create-cone","fa-thin fa-cubes",game.i18n.format("PF2E.TemplateLabel",{size:30,unit:e,shape:game.i18n.localize(CONFIG.PF2E.areaTypes.cone)})),i+=yi("create-burst","fa-thin fa-cubes",game.i18n.format("PF2E.TemplateLabel",{size:15,unit:e,shape:game.i18n.localize(CONFIG.PF2E.areaTypes.burst)})),i+="</p>",Dialog.wait({title:`${t.name} - ${game.i18n.localize("PF2E.Actions.Seek.Title")}`,content:i,buttons:{ok:{icon:'<i class="fa-solid fa-check"></i>',label:h("dialog.seek.accept"),callback:()=>!0},no:{icon:'<i class="fa-solid fa-xmark"></i>',label:h("dialog.seek.cancel"),callback:n=>!1}},close:()=>!1,render:n=>{n.filter(".dialog-content").find("[data-action=create-cone], [data-action=create-burst]").on("click",r=>{let{action:s}=r.currentTarget.dataset;J(t),Qe({type:s==="create-cone"?"cone":"burst",token:t})})}},{width:300,left:10})}a(ji,"seek");function Gi(t,e){class i extends e{async use(r={}){let s=game.i18n.localize("PF2E.Actions.Sneak.Title"),c=Le(r,s);if(c)return r.actors=[c.actor],super.use(r)}}a(i,"SneakVariant");class n extends t{constructor(){super({cost:1,description:"PF2E.Actions.Sneak.Description",name:"PF2E.Actions.Sneak.Title",notes:[{outcome:["success","criticalSuccess"],text:"PF2E.Actions.Sneak.Notes.success"},{outcome:["failure"],text:"PF2E.Actions.Sneak.Notes.failure"},{outcome:["criticalFailure"],text:"PF2E.Actions.Sneak.Notes.criticalFailure"}],rollOptions:["action:sneak"],slug:"sneak",traits:["move","secret"]})}toActionVariant(r){return new i(this,r)}}a(n,"Sneak")}a(Gi,"setupSneak");function Ui(t,e){class i extends e{async use(r={}){let s=game.i18n.localize("PF2E.Actions.Hide.Title"),c=Le(r,s);if(c)return r.actors=[c.actor],super.use(r)}}a(i,"HideVariant");class n extends t{constructor(){super({cost:1,description:"PF2E.Actions.Hide.Description",name:"PF2E.Actions.Hide.Title",rollOptions:["action:hide"],slug:"hide",statistic:"stealth",traits:["secret"],notes:[{outcome:["success","criticalSuccess"],text:"PF2E.Actions.Hide.Notes.success"}]})}toActionVariant(r){return new i(this,r)}}a(n,"Hide"),game.pf2e.actions.set("hide",new n)}a(Ui,"setupHide");function Bi(t,e){class i extends e{async use(r={}){let s=h("action.take-cover"),c=Le(r,s);c&&Hi(c)}}a(i,"TakeCoverVariant");class n extends t{constructor(){super({cost:1,description:"PF2E.Actions.TakeCover.Description",img:"systems/pf2e/icons/conditions-2/status_acup.webp",name:"PF2E.Actions.TakeCover.Title",slug:"take-cover"})}toActionVariant(r){return new i(this,r)}}a(n,"TakeCover"),game.pf2e.actions.set("take-cover",new n)}a(Bi,"setupCover");async function Hi(t){let e=t.actor,i=te(e),n=ne(t,game.user.targets.ids);if(i&&!n.length)return i.delete();let o=_(t)??{},r=Object.entries(o).reduce((l,[p,{cover:u}])=>(u&&(l[p]=u),l),{}),s=await renderTemplate(X("covers-dialog"),{i18n:h,hasTargets:!!n.length,hasCovers:!isEmpty(r),hasTargetCover:n.some(l=>l in r),isProne:Z(e)}),c=new Dialog({title:`${t.name} - ${h("action.take-cover")}`,content:s,buttons:{},render:l=>{l.find("button").on("click",async p=>{let{level:u}=p.currentTarget.dataset,d=C("skip-cover"),g=a(async(m,f)=>{f=f?n:void 0;let S=m===V.cover?f?"remove":"remove-all":"take",I=await xt({content:h(`message.cover.${S}`,{cover:h(`cover.${m}`)}),flags:{selected:f,cover:m,skipWait:d},token:t});if(d){if(m===V.cover&&!f)return ri(t);let E=deepClone(_(t))??{};for(let k of n)setProperty(E,`${k}.cover`,m);return nt(t,E)}},"process");if(u==="remove-all")g(V.cover);else if(u==="remove")g(V.cover,!0);else if(n.length)g(u,!0);else{let m=ke(u);e.createEmbeddedDocuments("Item",[m])}c.close()})}}).render(!0)}a(Hi,"takeCover");function Le(t,e){let i=t.tokens?.filter(r=>r.actor)??[];Array.isArray(i)||(i=[i]);let n=t.actors??[];if(Array.isArray(n)||(n=[n]),!i.length&&n.length===1&&(i=[Ce(n[0])].filter(Boolean)),i.length||(i=canvas.tokens.controlled.filter(r=>r.actor)),i.length||(i=[Ce(game.user.character)].filter(Boolean)),i.length>1){ui.notifications.warn(h("action.only-one",{action:e}));return}else if(!i.length){ui.notifications.warn(h("action.must-one",{action:e}));return}let o=i[0];if(!o?.actor?.isOfType("creature")){ui.notifications.warn(h("action.must-creature",{action:e}));return}return o}a(Le,"getSelectedToken");function yi(t,e,i){return`<button type="button" data-action="${t}" style="margin: 0 0 5px; padding: 0;">
    <i class="${e}"></i> ${i}</button>
</button>`}a(yi,"createButton");var vi={geometry:{clearDebug:pe,getRectEdges:rt,lineIntersectWall:We,pointToTokenIntersectWall:ot},token:{getCreatureCover:kt,getWallCover:st,getVisibility:oe,clearConditionals:me,showConditionals:bt,showAllConditionals:lt,getTokenData:_,getCover:ct,openHUD:Pt},lighting:{getLightExposure:at},actor:{isProne:Z,getCoverEffect:te,seeInvisibility:Be,hasGreaterDarkvision:Ue},scene:{getValidTokens:z,validateTokens:ne,getSceneSetting:Se},template:{createSeekTemplate:Qe,createDarknessTemplate:Yt,createMistTemplate:Qt,getDarknessTemplates:Xe,getMistTemplates:Ze,getSeekTemplateTokens:Je,deleteSeekTemplate:J,getTemplateTokens:Ee},ruleElement:{perceptionRules:re,getPerception:U,updateFromPerceptionRules:xe}};async function Pi(t,...e){let i=e[1];if(!i)return t(...e);Array.isArray(i.options)&&(i.options=new Set(i.options));let{actor:n,createMessage:o="true",type:r,token:s,target:c,isReroll:l}=i,p=s??Ce(n),u=c?.token,d=Pe.includes(r),g=C("flat-check");if(l||!o||!p||!Wt.includes(r)||d&&(!u||g==="none"))return t(...e);if(d&&u.actor){let m=e[2],f=re(p,u,{extraOptions:i.options.filter(W=>W.startsWith("item:"))}),S=oe(u,p,{perception:f,affects:"target"});if(!S)return t(...e);let I=(()=>{let W=U(f,"target","visibility","dc",S)?.first(),b=it(W);if(!b)return b;let F=W[0];return["-","+"].includes(F)?(S==="concealed"?5:11)+b:b})();if(I===0)return t(...e);let E=P[S]>=P.undetected,k=m?.ctrlKey||m?.metaKey,T=(await new p.actor.saves.reflex.constructor(p.actor,{slug:"visibility-check",label:`${game.i18n.localize("PF2E.FlatCheck")}: ${game.i18n.localize(`PF2E.condition.${S}.name`)}`,check:{type:"flat-check"}}).roll({dc:{value:I??(S==="concealed"?5:11)},target:u.actor,rollMode:E||k?game.user.isGM?"gmroll":"blindroll":"roll"})).degreeOfSuccess>1;if(E&&(i.options.add("secret"),i.pf2ePerception={isSuccess:T,visibility:S}),g!=="roll"&&!E&&!T)return}else if(i.options.has("action:hide"))setProperty(i,"pf2ePerception.selected",game.user.targets.ids);else if(i.options.has("action:seek")){let m=Je(p),f=m??Array.from(game.user.targets),S=ne(p,f).filter(I=>!I.document.hidden).map(I=>I.id);setProperty(i,"pf2ePerception.selected",S),setProperty(i,"pf2ePerception.fromTemplate",!!m)}return t(...e)}a(Pi,"checkRoll");function ki(t,e){let{createMessage:i="true",type:n,token:o,target:r,isReroll:s,options:c,dc:l}=t.context,p=o,u=r?.token,d=r?.actor;if(s||!i||!p||!u||!d||!Pe.includes(n))return;let g=te(d),m=g?Ge(g)?.selection.level??w(g,"level"):void 0,f=t[y]?.coverOverride??m,S='<div class="roll-mode-panel">';S+=`<div class="label">${h("dice-checks.cover.label")}</div>`,S+=`<select name="overrideCover"><option value="">${h("dice-checks.cover.none")}</option>`,(Z(d)?B.slice(1):B.slice(1,-1)).forEach(E=>{let k=E===f?"selected":"",x=h(`cover.${E}`);S+=`<option value="${E}" ${k}>${x}</option>`}),S+="</select></div>",S+="<hr>",e.find(".roll-mode-panel").before(S),e.find("select[name=overrideCover]").on("change",E=>{let k=E.currentTarget.value||void 0;setProperty(t,`${y}.coverOverride`,k),f=k}),e.find("button.roll")[0].addEventListener("click",E=>{E.preventDefault(),E.stopPropagation(),E.stopImmediatePropagation();let k=!1,x=deepClone(d._source.items);if(f!==m){k=!0;let T=x.findIndex(W=>getProperty(W,"flags.core.sourceId")===ve);if(T!==-1&&x.splice(T,1),f){let W=ke(f);x.push(W)}}if(k&&(r.actor=d.clone({items:x},{keepId:!0}),l?.slug)){let T=r.actor.getStatistic(l.slug)?.dc;T&&(l.value=T.value,l.statistic=T)}t.resolve(!0),t.isResolved=!0,t.close()},!0),t.setPosition()}a(ki,"renderCheckModifiersDialog");function bi(t,e){C("target")&&Ki(e)}a(bi,"renderCombatTracker");function Ki(t){t.find("[data-control=toggleTarget]").each((e,i)=>{i.addEventListener("click",n=>{n.preventDefault(),n.stopPropagation(),n.stopImmediatePropagation();let{combatantId:o}=n.currentTarget.closest(".combatant").dataset,s=game.combats.viewed.combatants.get(o??"")?.token;if(!s)return;let c=Array.from(game.user.targets).some(l=>l.document===s);s.object.setTarget(!c,{releaseOthers:!n.shiftKey})},!0)})}a(Ki,"setupToggleTarget");function Si(t,e){let i=C("encounter");e.find(".form-group").last().after(`<div class="form-group">
    <label>${h("settings.encounter.name")}</label>
    <input type="checkbox" name="pf2e-perception.encounter" ${i?"checked":""}>
    <p class="notes">${h("settings.encounter.short")}</p>
</div>`),e.find('input[name="pf2e-perception.encounter"]').on("change",n=>{let o=n.currentTarget.checked;je("encounter",o)})}a(Si,"renderCombatTrackerConfig");function Ei(t,e,i={}){return!e.enabled||!this._canDetect(t,i.object,i)?!1:i.tests.some(n=>this._testPoint(t,e,i.object,n))}a(Ei,"detectionModeTestVisibility");function Ti(t,e,i){if(e instanceof PlaceableObject&&e.document.hidden)return!1;if(!(e instanceof Token))return!0;let n=t.object,o=n.document;return o instanceof TokenDocument&&o.hasStatusEffect(CONFIG.specialStatusEffects.BLIND)?!1:n instanceof Token?!Ft(n,e,P.hidden,i):!e.document?.hasStatusEffect(CONFIG.specialStatusEffects.INVISIBLE)&&!e.actor?.hasCondition("hidden","undetected","unnoticed")}a(Ti,"basicSightCanDetect");function Ri(t,e,i){if(e.document.hidden||!(e instanceof Token)||!e.actor?.emitsSound)return!1;if(!game.settings.get("pf2e","automation.rulesBasedVision"))return!0;let n=t.object;return n.actor?.hasCondition("deafened")?!1:n instanceof Token?!Ft(n,e,P.undetected,i):!e.actor?.hasCondition("undetected","unnoticed")}a(Ri,"hearingCanDetect");function xi(t,e,i){if(e.document.hidden||!(e instanceof Token)||e.document.elevation>canvas.primary.background.elevation||e.actor?.isOfType("loot"))return!1;let n=t.object;return n instanceof Token?!Ft(n,e,P.undetected,i):!e.actor?.hasCondition("undetected","unnoticed")}a(xi,"feelTremorCanDetect");function Ft(t,e,i,n={}){if(!n.visibility){let o=re(t,e);n.visibility=oe(e,t,{perception:o,affects:"target"})}return P[n.visibility]>=i}a(Ft,"reachesThreshold");function qi(t,e,i){let n=t.length-e.length,o=Array.from(e);if(n===0)return t(...o);if(n===1){let r=a(s=>t(s,...o),"ret");return(i||t.lazy)&&(r.lazy=i||t.lazy,r.lazyArgs=e),r}throw new Error("Wrong number of arguments")}a(qi,"purry");function Yi(t,e,i){let n=[];for(let o=0;o<t.length;o++){let r=t[o],s=i?e(r,o,t):e(r);s.hasMany===!0?n.push(...s.next):s.hasNext&&n.push(s.next)}return n}a(Yi,"_reduceLazy");function Fi(){let t=new Set;return e=>t.has(e)?{done:!1,hasNext:!1}:(t.add(e),{done:!1,hasNext:!0,next:e})}a(Fi,"uniqLazy");function Qi(t){return Yi(t,Fi())}a(Qi,"_uniq");var ae={compact:t=>t.filter(Boolean),uniq:function(){return qi(Qi,arguments,Fi)}};var H=class extends Array{constructor(...e){super(...Array.isArray(e[0])?e[0]:e),this.isValid=H.isValid(this)}static isValid(e){return this.isArray(e)}static isArray(e){return super.isArray(e)&&e.every(i=>ye.isStatement(i))}static test(e=[],i){return e instanceof H?e.test(i):new H(...e).test(i)}test(e){if(this.length===0)return!0;if(!this.isValid)return console.warn("PF2e System | The provided predicate set is malformed."),!1;let i=e instanceof Set?e:new Set(e);return this.every(n=>this.#e(n,i))}toObject(){return deepClone([...this])}clone(){return new H(this.toObject())}#e(e,i){return typeof e=="string"&&i.has(e)||ye.isBinaryOp(e)&&this.#i(e,i)||ye.isCompound(e)&&this.#t(e,i)}#i(e,i){if("eq"in e)return i.has(`${e.eq[0]}:${e.eq[1]}`);{let n=Object.keys(e)[0],[o,r]=Object.values(e)[0],s=Array.from(i),c=a(u=>{let d=Number(u);if(!Number.isNaN(d))return[d];let g=new RegExp(String.raw`^${u}:([^:]+)$`),m=s.map(f=>Number(g.exec(f)?.[1]||NaN)).filter(f=>!Number.isNaN(f));return m.length>0?m:[NaN]},"getValues"),l=c(o),p=c(r);switch(n){case"gt":return l.some(u=>p.every(d=>u>d));case"gte":return l.some(u=>p.every(d=>u>=d));case"lt":return l.some(u=>p.every(d=>u<d));case"lte":return l.some(u=>p.every(d=>u<=d));default:return console.warn("PF2e System | Malformed binary operation encountered"),!1}}}#t(e,i){return"and"in e&&e.and.every(n=>this.#e(n,i))||"nand"in e&&!e.nand.every(n=>this.#e(n,i))||"or"in e&&e.or.some(n=>this.#e(n,i))||"xor"in e&&e.xor.filter(n=>this.#e(n,i)).length===1||"nor"in e&&!e.nor.some(n=>this.#e(n,i))||"not"in e&&!this.#e(e.not,i)||"if"in e&&!(this.#e(e.if,i)&&!this.#e(e.then,i))}};a(H,"PredicatePF2e");var dt,ye=class{static isStatement(e){return e instanceof Object?this.isCompound(e)||this.isBinaryOp(e):typeof e=="string"?this.isAtomic(e):!1}static isAtomic(e){return typeof e=="string"&&e.length>0||this.isBinaryOp(e)}static isBinaryOp(e){if(!yt(e))return!1;let i=Object.entries(e);if(i.length>1)return!1;let[n,o]=i[0];return It(this,dt).has(n)&&Array.isArray(o)&&o.length===2&&typeof o[0]=="string"&&["string","number"].includes(typeof o[1])}static isCompound(e){return yt(e)&&(this.isAnd(e)||this.isOr(e)||this.isNand(e)||this.isXor(e)||this.isNor(e)||this.isNot(e)||this.isIf(e))}static isAnd(e){return Object.keys(e).length===1&&Array.isArray(e.and)&&e.and.every(i=>this.isStatement(i))}static isNand(e){return Object.keys(e).length===1&&Array.isArray(e.nand)&&e.nand.every(i=>this.isStatement(i))}static isOr(e){return Object.keys(e).length===1&&Array.isArray(e.or)&&e.or.every(i=>this.isStatement(i))}static isXor(e){return Object.keys(e).length===1&&Array.isArray(e.xor)&&e.xor.every(i=>this.isStatement(i))}static isNor(e){return Object.keys(e).length===1&&Array.isArray(e.nor)&&e.nor.every(i=>this.isStatement(i))}static isNot(e){return Object.keys(e).length===1&&!!e.not&&this.isStatement(e.not)}static isIf(e){return Object.keys(e).length===2&&this.isStatement(e.if)&&this.isStatement(e.then)}};a(ye,"StatementValidator"),dt=new WeakMap,le(ye,dt,new Set(["eq","gt","gte","lt","lte"]));var Xi={ancestralEchoing:{level:15,name:"PF2E.WeaponPropertyRune.ancestralEchoing.Name",price:9500,rarity:"rare",slug:"ancestralEchoing",traits:["dwarf","magical","saggorak"]},anchoring:{damage:{notes:[{outcome:["criticalSuccess"],title:"PF2E.WeaponPropertyRune.anchoring.Name",text:"PF2E.WeaponPropertyRune.anchoring.Note.criticalSuccess"}]},level:10,name:"PF2E.WeaponPropertyRune.anchoring.Name",price:900,rarity:"uncommon",slug:"anchoring",traits:["magical"]},ashen:{damage:{dice:[{damageType:"fire",category:"persistent",diceNumber:1,dieSize:"d4"}],notes:[{outcome:["success"],title:"PF2E.WeaponPropertyRune.ashen.Name",text:"PF2E.WeaponPropertyRune.ashen.Note.success"}]},level:9,name:"PF2E.WeaponPropertyRune.ashen.Name",price:700,rarity:"common",slug:"ashen",traits:["magical"]},astral:{level:8,name:"PF2E.WeaponPropertyRune.astral.Name",price:450,rarity:"common",slug:"astral",traits:["magical","spirit"],damage:{dice:[{damageType:"spirit",diceNumber:1,dieSize:"d6"}]}},authorized:{level:3,name:"PF2E.WeaponPropertyRune.authorized.Name",price:50,rarity:"common",slug:"authorized",traits:["magical"]},bane:{level:4,name:"PF2E.WeaponPropertyRune.bane.Name",price:100,rarity:"uncommon",slug:"bane",traits:["magical"]},bloodbane:{level:8,name:"PF2E.WeaponPropertyRune.bloodbane.Name",price:475,rarity:"uncommon",slug:"bloodbane",traits:["dwarf","magical"]},bloodthirsty:{damage:{notes:[{outcome:["criticalSuccess"],title:"PF2E.WeaponPropertyRune.bloodbane.Name",text:"PF2E.WeaponPropertyRune.bloodthirsty.Note.criticalSuccess"}]},level:16,name:"PF2E.WeaponPropertyRune.bloodthirsty.Name",price:8500,rarity:"uncommon",slug:"bloodthirsty",traits:["magical"]},brilliant:{damage:{dice:[{damageType:"fire",diceNumber:1,dieSize:"d4"},{damageType:"spirit",diceNumber:1,dieSize:"d4",predicate:["target:trait:fiend"]},{damageType:"vitality",diceNumber:1,dieSize:"d4",predicate:["target:negative-healing"]}],notes:[{outcome:["criticalSuccess"],title:"PF2E.WeaponPropertyRune.brilliant.Name",text:"PF2E.WeaponPropertyRune.brilliant.Note.criticalSuccess"}]},level:12,name:"PF2E.WeaponPropertyRune.brilliant.Name",price:2e3,rarity:"common",slug:"brilliant",traits:["magical"]},called:{level:7,name:"PF2E.WeaponPropertyRune.called.Name",price:350,rarity:"common",slug:"called",traits:["magical"]},coating:{level:9,name:"PF2E.WeaponPropertyRune.coating.Name",price:700,rarity:"common",slug:"coating",traits:["extradimensional","magical"]},conducting:{level:7,name:"PF2E.WeaponPropertyRune.conducting.Name",price:300,rarity:"common",slug:"conducting",traits:["magical"]},corrosive:{damage:{dice:[{damageType:"acid",diceNumber:1,dieSize:"d6"}],notes:[{outcome:["criticalSuccess"],title:"PF2E.WeaponPropertyRune.corrosive.Name",text:"PF2E.WeaponPropertyRune.corrosive.Note.criticalSuccess"}]},level:8,name:"PF2E.WeaponPropertyRune.corrosive.Name",price:500,rarity:"common",slug:"corrosive",traits:["acid","magical"]},crushing:{damage:{notes:[{outcome:["criticalSuccess"],title:"PF2E.WeaponPropertyRune.crushing.Name",text:"PF2E.WeaponPropertyRune.crushing.Note.criticalSuccess"}]},level:3,name:"PF2E.WeaponPropertyRune.crushing.Name",price:50,rarity:"uncommon",slug:"crushing",traits:["magical"]},cunning:{level:5,name:"PF2E.WeaponPropertyRune.cunning.Name",price:140,rarity:"common",slug:"cunning",traits:["magical"]},dancing:{level:13,name:"PF2E.WeaponPropertyRune.dancing.Name",price:2700,rarity:"uncommon",slug:"dancing",traits:["magical"]},decaying:{damage:{dice:[{slug:"decaying",damageType:"void",diceNumber:1,dieSize:"d4"},{slug:"decaying-persistent",category:"persistent",damageType:"void",diceNumber:2,dieSize:"d4",critical:!0}]},level:8,name:"PF2E.WeaponPropertyRune.decaying.Name",price:500,rarity:"common",slug:"decaying",traits:["acid","magical","void"]},deathdrinking:{damage:{dice:[{slug:"deathdrinking-negative",damageType:"void",diceNumber:1,dieSize:"d6",critical:!0,predicate:["target:mode:living",{not:"target:negative-healing"}]},{slug:"deathdrinking-positive",damageType:"vitality",diceNumber:1,dieSize:"d6",critical:!0,predicate:["target:negative-healing"]}]},level:7,name:"PF2E.WeaponPropertyRune.deathdrinking.Name",price:360,rarity:"rare",slug:"deathdrinking",traits:["magical"]},demolishing:{damage:{dice:[{damageType:"force",category:"persistent",diceNumber:1,dieSize:"d6",predicate:["target:trait:construct"]}]},level:6,name:"PF2E.WeaponPropertyRune.demolishing.Name",price:225,rarity:"rare",slug:"demolishing",traits:["magical"]},disrupting:{damage:{dice:[{category:"persistent",damageType:"vitality",diceNumber:1,dieSize:"d6",predicate:["target:negative-healing"]}],notes:[{outcome:["criticalSuccess"],title:"PF2E.WeaponPropertyRune.disrupting.Name",text:"PF2E.WeaponPropertyRune.disrupting.Note.criticalSuccess",predicate:["target:negative-healing"]}]},level:5,name:"PF2E.WeaponPropertyRune.disrupting.Name",price:150,rarity:"common",slug:"disrupting",traits:["magical"]},earthbinding:{level:5,name:"PF2E.WeaponPropertyRune.earthbinding.Name",price:125,rarity:"common",slug:"earthbinding",traits:["magical"]},energizing:{level:6,name:"PF2E.WeaponPropertyRune.energizing.Name",price:250,rarity:"uncommon",slug:"energizing",traits:["magical"]},extending:{level:7,name:"PF2E.WeaponPropertyRune.extending.Name",price:700,rarity:"common",slug:"extending",traits:["magical"]},fanged:{level:2,name:"PF2E.WeaponPropertyRune.fanged.Name",price:30,rarity:"uncommon",slug:"fanged",traits:["magical"]},fearsome:{damage:{notes:[{outcome:["criticalSuccess"],title:"PF2E.WeaponPropertyRune.fearsome.Name",text:"PF2E.WeaponPropertyRune.fearsome.Note.criticalSuccess"}]},level:5,name:"PF2E.WeaponPropertyRune.fearsome.Name",price:160,rarity:"common",slug:"fearsome",traits:["emotion","fear","magical","mental"]},flaming:{damage:{dice:[{damageType:"fire",diceNumber:1,dieSize:"d6"},{damageType:"fire",category:"persistent",diceNumber:1,dieSize:"d10",critical:!0}]},level:8,name:"PF2E.WeaponPropertyRune.flaming.Name",price:500,rarity:"common",slug:"flaming",traits:["fire","magical"]},flurrying:{level:7,name:"PF2E.WeaponPropertyRune.flurrying.Name",price:360,rarity:"common",slug:"flurrying",traits:["magical"]},frost:{damage:{dice:[{damageType:"cold",diceNumber:1,dieSize:"d6"}],notes:[{outcome:["criticalSuccess"],title:"PF2E.WeaponPropertyRune.frost.Name",text:"PF2E.WeaponPropertyRune.frost.Note.criticalSuccess"}]},level:8,name:"PF2E.WeaponPropertyRune.frost.Name",price:500,rarity:"common",slug:"frost",traits:["cold","magical"]},ghostTouch:{level:4,name:"PF2E.WeaponPropertyRune.ghostTouch.Name",price:75,rarity:"common",slug:"ghostTouch",traits:["magical"]},giantKilling:{damage:{dice:[{slug:"giantKilling",damageType:"mental",diceNumber:1,dieSize:"d6",predicate:["target:trait:giant"]}],notes:[{outcome:["criticalSuccess"],predicate:["target:trait:giant"],title:"PF2E.WeaponPropertyRune.giantKilling.Name",text:"PF2E.WeaponPropertyRune.giantKilling.Note.criticalSuccess"}]},level:8,name:"PF2E.WeaponPropertyRune.giantKilling.Name",price:450,rarity:"rare",slug:"giantKilling",traits:["magical"]},greaterAnchoring:{damage:{notes:[{outcome:["criticalSuccess"],title:"PF2E.WeaponPropertyRune.greaterAnchoring.Name",text:"PF2E.WeaponPropertyRune.greaterAnchoring.Note.criticalSuccess"},{outcome:["success"],title:"PF2E.WeaponPropertyRune.greaterAnchoring.Name",text:"PF2E.WeaponPropertyRune.greaterAnchoring.Note.success"}]},level:18,name:"PF2E.WeaponPropertyRune.greaterAnchoring.Name",price:22e3,rarity:"uncommon",slug:"greaterAnchoring",traits:["magical"]},greaterAshen:{damage:{dice:[{damageType:"fire",category:"persistent",diceNumber:1,dieSize:"d8"}],notes:[{outcome:["success"],title:"PF2E.WeaponPropertyRune.greaterAshen.Name",text:"PF2E.WeaponPropertyRune.greaterAshen.Note.success"}]},level:16,name:"PF2E.WeaponPropertyRune.greaterAshen.Name",price:9e3,rarity:"common",slug:"greaterAshen",traits:["magical"]},greaterAstral:{level:15,name:"PF2E.WeaponPropertyRune.greaterAstral.Name",price:6e3,rarity:"common",slug:"greaterAstral",traits:["magical","spirit"],damage:{dice:[{damageType:"spirit",diceNumber:1,dieSize:"d6"}],ignoredResistances:[{type:"spirit",max:null}]}},greaterBloodbane:{level:13,name:"PF2E.WeaponPropertyRune.greaterBloodbane.Name",price:2800,rarity:"uncommon",slug:"greaterBloodbane",traits:["dwarf","magical"]},greaterBrilliant:{damage:{dice:[{damageType:"fire",diceNumber:1,dieSize:"d4"},{damageType:"spirit",diceNumber:1,dieSize:"d4",predicate:["target:trait:fiend"]},{damageType:"vitality",diceNumber:1,dieSize:"d4",predicate:["target:negative-healing"]}],notes:[{outcome:["criticalSuccess"],title:"PF2E.WeaponPropertyRune.greaterBrilliant.Name",text:"PF2E.WeaponPropertyRune.greaterBrilliant.Note.criticalSuccess"},{outcome:["success"],title:"PF2E.WeaponPropertyRune.greaterBrilliant.Name",text:"PF2E.WeaponPropertyRune.greaterBrilliant.Note.success"}],ignoredResistances:[{type:"fire",max:null},{type:"spirit",max:null},{type:"vitality",max:null}]},level:18,name:"PF2E.WeaponPropertyRune.greaterBrilliant.Name",price:24e3,rarity:"common",slug:"greaterBrilliant",traits:["magical"]},greaterCorrosive:{damage:{dice:[{damageType:"acid",diceNumber:1,dieSize:"d6"}],notes:[{outcome:["criticalSuccess"],title:"PF2E.WeaponPropertyRune.greaterCorrosive.Name",text:"PF2E.WeaponPropertyRune.greaterCorrosive.Note.criticalSuccess"},{outcome:["success"],title:"PF2E.WeaponPropertyRune.greaterCorrosive.Name",text:"PF2E.WeaponPropertyRune.greaterCorrosive.Note.success"}],ignoredResistances:[{type:"acid",max:null}]},level:15,name:"PF2E.WeaponPropertyRune.greaterCorrosive.Name",price:6500,rarity:"common",slug:"greaterCorrosive",traits:["acid","magical"]},greaterCrushing:{damage:{notes:[{outcome:["criticalSuccess"],title:"PF2E.WeaponPropertyRune.greaterCrushing.Name",text:"PF2E.WeaponPropertyRune.greaterCrushing.Note.criticalSuccess"}]},level:9,name:"PF2E.WeaponPropertyRune.greaterCrushing.Name",price:650,rarity:"uncommon",slug:"greaterCrushing",traits:["magical"]},greaterDecaying:{damage:{dice:[{slug:"decaying",damageType:"void",diceNumber:1,dieSize:"d4"},{slug:"decaying-persistent",category:"persistent",damageType:"void",diceNumber:4,dieSize:"d4",critical:!0}],ignoredResistances:[{type:"void",max:null}]},level:15,name:"PF2E.WeaponPropertyRune.greaterDecaying.Name",price:6500,rarity:"common",slug:"greaterDecaying",traits:["acid","magical","void"]},greaterDisrupting:{damage:{dice:[{category:"persistent",damageType:"vitality",diceNumber:2,dieSize:"d6",predicate:["target:negative-healing"]}],notes:[{outcome:["criticalSuccess"],title:"PF2E.WeaponPropertyRune.greaterDisrupting.Name",text:"PF2E.WeaponPropertyRune.greaterDisrupting.Note.criticalSuccess",predicate:["target:negative-healing"]}]},level:14,name:"PF2E.WeaponPropertyRune.greaterDisrupting.Name",price:4300,rarity:"uncommon",slug:"greaterDisrupting",traits:["magical"]},greaterExtending:{level:13,name:"PF2E.WeaponPropertyRune.greaterExtending.Name",price:3e3,rarity:"common",slug:"greaterExtending",traits:["magical"]},greaterFanged:{level:8,name:"PF2E.WeaponPropertyRune.greaterFanged.Name",price:425,rarity:"uncommon",slug:"greaterFanged",traits:["magical"]},greaterFearsome:{damage:{notes:[{outcome:["criticalSuccess"],title:"PF2E.WeaponPropertyRune.greaterFearsome.Name",text:"PF2E.WeaponPropertyRune.greaterFearsome.Note.criticalSuccess"}]},level:12,name:"PF2E.WeaponPropertyRune.greaterFearsome.Name",price:2e3,rarity:"common",slug:"greaterFearsome",traits:["emotion","fear","magical","mental"]},greaterFlaming:{damage:{dice:[{damageType:"fire",diceNumber:1,dieSize:"d6"},{damageType:"fire",category:"persistent",diceNumber:2,dieSize:"d10",critical:!0}],notes:[{outcome:["criticalSuccess"],title:"PF2E.WeaponPropertyRune.greaterFlaming.Name",text:"PF2E.WeaponPropertyRune.greaterFlaming.Note.criticalSuccess"},{outcome:["success"],title:"PF2E.WeaponPropertyRune.greaterFlaming.Name",text:"PF2E.WeaponPropertyRune.greaterFlaming.Note.success"}],ignoredResistances:[{type:"fire",max:null}]},level:15,name:"PF2E.WeaponPropertyRune.greaterFlaming.Name",price:6500,rarity:"common",slug:"greaterFlaming",traits:["fire","magical"]},greaterFrost:{damage:{dice:[{damageType:"cold",diceNumber:1,dieSize:"d6"}],notes:[{outcome:["criticalSuccess"],title:"PF2E.WeaponPropertyRune.greaterFrost.Name",text:"PF2E.WeaponPropertyRune.greaterFrost.Note.criticalSuccess"},{outcome:["success"],title:"PF2E.WeaponPropertyRune.greaterFrost.Name",text:"PF2E.WeaponPropertyRune.greaterFrost.Note.success"}],ignoredResistances:[{type:"cold",max:null}]},level:15,name:"PF2E.WeaponPropertyRune.greaterFrost.Name",price:6500,rarity:"common",slug:"greaterFrost",traits:["cold","magical"]},greaterGiantKilling:{damage:{dice:[{slug:"greaterGiantKilling",damageType:"mental",diceNumber:2,dieSize:"d6",predicate:["target:trait:giant"]}],ignoredResistances:[{type:"mental",max:null}],notes:[{outcome:["criticalSuccess"],predicate:["target:trait:giant"],title:"PF2E.WeaponPropertyRune.greaterGiantKilling.Name",text:"PF2E.WeaponPropertyRune.greaterGiantKilling.Note.criticalSuccess"}]},level:15,name:"PF2E.WeaponPropertyRune.greaterGiantKilling.Name",price:6e3,rarity:"rare",slug:"greaterGiantKilling",traits:["magical"]},greaterHauling:{level:11,name:"PF2E.WeaponPropertyRune.greaterHauling.Name",price:1300,rarity:"uncommon",slug:"greaterHauling",traits:["magical"]},greaterImpactful:{damage:{dice:[{damageType:"force",diceNumber:1,dieSize:"d6"}],notes:[{outcome:["criticalSuccess"],title:"PF2E.WeaponPropertyRune.greaterImpactful.Name",text:"PF2E.WeaponPropertyRune.greaterImpactful.Note.criticalSuccess"}]},level:17,name:"PF2E.WeaponPropertyRune.greaterImpactful.Name",price:15e3,rarity:"common",slug:"greaterImpactful",traits:["force","magical"]},greaterRooting:{level:11,name:"PF2E.WeaponPropertyRune.greaterRooting.Name",price:1400,rarity:"common",slug:"greaterRooting",traits:["plant","magical","wood"],damage:{notes:[{outcome:["criticalSuccess"],title:"PF2E.WeaponPropertyRune.greaterRooting.Name",text:"PF2E.WeaponPropertyRune.greaterRooting.Note.criticalSuccess"},{outcome:["success"],title:"PF2E.WeaponPropertyRune.greaterRooting.Name",text:"PF2E.WeaponPropertyRune.greaterRooting.Note.success"}]}},greaterShock:{damage:{dice:[{damageType:"electricity",diceNumber:1,dieSize:"d6"}],notes:[{outcome:["criticalSuccess"],title:"PF2E.WeaponPropertyRune.greaterShock.Name",text:"PF2E.WeaponPropertyRune.greaterShock.Note.criticalSuccess"},{outcome:["success"],title:"PF2E.WeaponPropertyRune.greaterShock.Name",text:"PF2E.WeaponPropertyRune.greaterShock.Note.success"}],ignoredResistances:[{type:"electricity",max:null}]},level:15,name:"PF2E.WeaponPropertyRune.greaterShock.Name",price:6500,rarity:"common",slug:"greaterShock",traits:["electricity","magical"]},greaterThundering:{damage:{dice:[{damageType:"sonic",diceNumber:1,dieSize:"d6"}],notes:[{outcome:["criticalSuccess"],title:"PF2E.WeaponPropertyRune.greaterThundering.Name",text:"PF2E.WeaponPropertyRune.greaterThundering.Note.criticalSuccess"},{outcome:["success"],title:"PF2E.WeaponPropertyRune.greaterThundering.Name",text:"PF2E.WeaponPropertyRune.greaterThundering.Note.success"}],ignoredResistances:[{type:"sonic",max:null}]},level:15,name:"PF2E.WeaponPropertyRune.greaterThundering.Name",price:6500,rarity:"common",slug:"greaterThundering",traits:["magical","sonic"]},grievous:{damage:{dice:[{damageType:"bleed",diceNumber:1,dieSize:"d6",critical:!0,predicate:["critical-specialization","item:group:dart"]}],notes:[{outcome:["criticalSuccess"],predicate:["item:group:axe"],title:"PF2E.WeaponPropertyRune.grievous.Name",text:"PF2E.WeaponPropertyRune.grievous.Note.Axe"},{outcome:["criticalSuccess"],predicate:["item:group:brawling"],title:"PF2E.WeaponPropertyRune.grievous.Name",text:"PF2E.WeaponPropertyRune.grievous.Note.Brawling"},{outcome:["criticalSuccess"],predicate:["item:group:club"],title:"PF2E.WeaponPropertyRune.grievous.Name",text:"PF2E.WeaponPropertyRune.grievous.Note.Club"},{outcome:["criticalSuccess"],predicate:["item:group:flail"],title:"PF2E.WeaponPropertyRune.grievous.Name",text:"PF2E.WeaponPropertyRune.grievous.Note.Flail"},{outcome:["criticalSuccess"],predicate:["item:group:hammer"],title:"PF2E.WeaponPropertyRune.grievous.Name",text:"PF2E.WeaponPropertyRune.grievous.Note.Hammer"},{outcome:["criticalSuccess"],predicate:["item:group:knife"],title:"PF2E.WeaponPropertyRune.grievous.Name",text:"PF2E.WeaponPropertyRune.grievous.Note.Knife"},{outcome:["criticalSuccess"],predicate:["item:group:polearm"],title:"PF2E.WeaponPropertyRune.grievous.Name",text:"PF2E.WeaponPropertyRune.grievous.Note.Polearm"},{outcome:["criticalSuccess"],predicate:["item:group:shield"],title:"PF2E.WeaponPropertyRune.grievous.Name",text:"PF2E.WeaponPropertyRune.grievous.Note.Shield"},{outcome:["criticalSuccess"],predicate:["item:group:sling"],title:"PF2E.WeaponPropertyRune.grievous.Name",text:"PF2E.WeaponPropertyRune.grievous.Note.Sling"},{outcome:["criticalSuccess"],predicate:["item:group:spear"],title:"PF2E.WeaponPropertyRune.grievous.Name",text:"PF2E.WeaponPropertyRune.grievous.Note.Spear"},{outcome:["criticalSuccess"],predicate:["item:group:sword"],title:"PF2E.WeaponPropertyRune.grievous.Name",text:"PF2E.WeaponPropertyRune.grievous.Note.Sword"}],adjustments:[{slug:"critical-specialization",test:t=>new H("item:group:pick").test(t),getNewValue:t=>t*2}]},level:9,name:"PF2E.WeaponPropertyRune.grievous.Name",price:700,rarity:"common",slug:"grievous",traits:["magical"]},hauling:{level:6,name:"PF2E.WeaponPropertyRune.hauling.Name",price:225,rarity:"uncommon",slug:"hauling",traits:["magical"]},holy:{level:11,name:"PF2E.WeaponPropertyRune.holy.Name",price:1400,rarity:"common",slug:"holy",traits:["holy","magical"],damage:{dice:[{damageType:"spirit",diceNumber:1,dieSize:"d4",predicate:[{not:"target:trait:unholy"}]},{damageType:"spirit",diceNumber:2,dieSize:"d4",predicate:["target:trait:unholy"]}]},strikeAdjustments:[{adjustTraits:(t,e)=>{e.includes("holy")||e.push("holy")}}]},hopeful:{attack:{notes:[{outcome:["criticalSuccess"],title:"PF2E.WeaponPropertyRune.hopeful.Name",text:"PF2E.WeaponPropertyRune.hopeful.Note.criticalSuccess"}]},level:11,name:"PF2E.WeaponPropertyRune.hopeful.Name",price:1200,rarity:"uncommon",slug:"hopeful",traits:["magical"]},hooked:{level:5,name:"PF2E.WeaponPropertyRune.hooked.Name",price:140,rarity:"rare",slug:"hooked",traits:["magical"],strikeAdjustments:[{adjustWeapon:t=>{t.system.traits.value.includes("trip")||t.system.traits.value.push("trip")}}]},impactful:{damage:{dice:[{damageType:"force",diceNumber:1,dieSize:"d6"}],notes:[{outcome:["criticalSuccess"],title:"PF2E.WeaponPropertyRune.impactful.Name",text:"PF2E.WeaponPropertyRune.impactful.Note.criticalSuccess"}]},level:10,name:"PF2E.WeaponPropertyRune.impactful.Name",price:1e3,rarity:"common",slug:"impactful",traits:["force","magical"]},impossible:{level:20,name:"PF2E.WeaponPropertyRune.impossible.Name",price:7e4,rarity:"common",slug:"impossible",traits:["magical"],strikeAdjustments:[{adjustWeapon:t=>{if(t.isOfType("weapon")&&t.system.range&&t._source.system.range){let e=t._source.system.range,i=t.system.range;t.system.range=e*2+Math.abs(i-e)}}}]},keen:{attack:{dosAdjustments:[{adjustments:{success:{label:"PF2E.WeaponPropertyRune.keen.Name",amount:"criticalSuccess"}},predicate:new H(["check:total:natural:19",{or:["item:damage:type:slashing","item:damage:type:piercing"]}])}]},level:13,name:"PF2E.WeaponPropertyRune.keen.Name",price:3e3,rarity:"uncommon",slug:"keen",traits:["magical"]},kinWarding:{level:3,name:"PF2E.WeaponPropertyRune.kinWarding.Name",price:52,rarity:"uncommon",slug:"kinWarding",traits:["dwarf","magical"]},majorFanged:{level:15,name:"PF2E.WeaponPropertyRune.majorFanged.Name",price:6e3,rarity:"uncommon",slug:"majorFanged",traits:["magical"]},majorRooting:{level:15,name:"PF2E.WeaponPropertyRune.majorRooting.Name",price:6500,rarity:"common",slug:"majorRooting",traits:["plant","magical","wood"],damage:{notes:[{outcome:["criticalSuccess"],title:"PF2E.WeaponPropertyRune.majorRooting.Name",text:"PF2E.WeaponPropertyRune.majorRooting.Note.criticalSuccess"}]}},merciful:{strikeAdjustments:[{adjustWeapon:t=>{t.system.traits.value.includes("nonlethal")||t.system.traits.value.push("nonlethal")}}],level:4,name:"PF2E.WeaponPropertyRune.merciful.Name",price:70,rarity:"common",slug:"merciful",traits:["magical","mental"]},pacifying:{level:5,name:"PF2E.WeaponPropertyRune.pacifying.Name",price:150,rarity:"uncommon",slug:"pacifying",traits:["magical"]},returning:{attack:{notes:[{title:"PF2E.WeaponPropertyRune.returning.Name",text:"PF2E.WeaponPropertyRune.returning.Note"}]},level:3,name:"PF2E.WeaponPropertyRune.returning.Name",price:55,rarity:"common",slug:"returning",traits:["magical"]},rooting:{level:7,name:"PF2E.WeaponPropertyRune.rooting.Name",price:360,rarity:"common",slug:"rooting",traits:["plant","magical","wood"],damage:{notes:[{outcome:["criticalSuccess"],title:"PF2E.WeaponPropertyRune.rooting.Name",text:"PF2E.WeaponPropertyRune.rooting.Note.criticalSuccess"}]}},serrating:{damage:{dice:[{damageType:"slashing",diceNumber:1,dieSize:"d4"}]},level:10,name:"PF2E.WeaponPropertyRune.serrating.Name",price:1e3,rarity:"uncommon",slug:"serrating",traits:["magical"]},shifting:{level:6,name:"PF2E.WeaponPropertyRune.shifting.Name",price:225,rarity:"common",slug:"shifting",traits:["magical"]},shock:{damage:{dice:[{damageType:"electricity",diceNumber:1,dieSize:"d6"}],notes:[{outcome:["criticalSuccess"],title:"PF2E.WeaponPropertyRune.shock.Name",text:"PF2E.WeaponPropertyRune.shock.Note.criticalSuccess"}]},level:8,name:"PF2E.WeaponPropertyRune.shock.Name",price:500,rarity:"common",slug:"shock",traits:["electricity","magical"]},speed:{level:16,name:"PF2E.Actor.Speed.Label",price:1e4,rarity:"rare",slug:"speed",traits:["magical"]},spellStoring:{level:13,name:"PF2E.WeaponPropertyRune.spellStoring.Name",price:2700,rarity:"uncommon",slug:"spellStoring",traits:["magical"]},swarming:{level:9,name:"PF2E.WeaponPropertyRune.swarming.Name",price:700,rarity:"common",slug:"swarming",traits:["magical"]},thundering:{damage:{dice:[{damageType:"sonic",diceNumber:1,dieSize:"d6"}],notes:[{outcome:["criticalSuccess"],title:"PF2E.WeaponPropertyRune.thundering.Name",text:"PF2E.WeaponPropertyRune.thundering.Note.criticalSuccess"}]},level:8,name:"PF2E.WeaponPropertyRune.thundering.Name",price:500,rarity:"common",slug:"thundering",traits:["magical","sonic"]},trueRooting:{level:19,name:"PF2E.WeaponPropertyRune.trueRooting.Name",price:4e4,rarity:"common",slug:"trueRooting",traits:["plant","magical","wood"],damage:{notes:[{outcome:["criticalSuccess"],title:"PF2E.WeaponPropertyRune.trueRooting.Name",text:"PF2E.WeaponPropertyRune.trueRooting.Note.criticalSuccess"}]}},underwater:{level:3,name:"PF2E.WeaponPropertyRune.underwater.Name",price:50,rarity:"common",slug:"underwater",traits:["magical","water"]},unholy:{level:11,name:"PF2E.WeaponPropertyRune.unholy.Name",price:1400,rarity:"common",slug:"unholy",traits:["unholy","magical"],damage:{dice:[{damageType:"spirit",diceNumber:1,dieSize:"d4",predicate:[{not:"target:trait:holy"}]},{damageType:"spirit",diceNumber:2,dieSize:"d4",predicate:["target:trait:holy"]}]},strikeAdjustments:[{adjustTraits:(t,e)=>{e.includes("unholy")||e.push("unholy")}}]},vorpal:{level:17,name:"PF2E.WeaponPropertyRune.vorpal.Name",price:15e3,rarity:"rare",slug:"vorpal",traits:["magical"]},wounding:{damage:{dice:[{damageType:"bleed",diceNumber:1,dieSize:"d6"}]},level:7,name:"PF2E.WeaponPropertyRune.wounding.Name",price:340,rarity:"common",slug:"wounding",traits:["magical"]}};function Ni(t){return t.flatMap(e=>Xi[e].strikeAdjustments??[])}a(Ni,"getPropertyRuneStrikeAdjustments");async function Ci(t){let[e,i]=canvas.ready&&!t.viewOnly?[canvas.tokens.controlled.find(v=>v.actor===this)??this.getActiveTokens().shift()??null,t.target?.token??t.target?.actor?.getActiveTokens().shift()??null]:[null,null],n=["attack","attack-roll","attack-damage"].some(v=>t.domains.includes(v)),o=!!(t.melee||t.item?.isOfType("weapon","melee")&&t.item.isMelee),r=o&&t.item?.isOfType("action","weapon","melee")?this.getReach({action:"attack",weapon:t.item}):this.getReach({action:"attack"}),s=!!(n&&o&&typeof r=="number"&&i?.actor&&e?.isFlanking(i,{reach:r})),c=await ft({affects:"origin",origin:this,target:t.target?.actor??i?.actor??null,item:t.item??null,domains:t.domains,options:[...t.options,...t.item?.getRollOptions("item")??[]]}),l=(()=>{let v=i?this.synthetics.tokenMarks.get(i.document.uuid):null;return v?`target:mark:${v}`:null})(),p=t.traits?.map(v=>`self:action:trait:${v}`)??[],u=t.viewOnly||!i?.actor?this:this.getContextualClone(ae.compact([...Array.from(t.options),...i.actor.getSelfRollOptions("target"),l,...p,s?"self:flanking":null]),c),d=t.statistic instanceof game.pf2e.StatisticModifier,g=d?u.system.actions?.flatMap(v=>[v,v.altUsages??[]].flat())??[]:[],m=t.viewOnly?t.statistic:d?g.find(v=>t.item?.id!==v.item.id||t?.item.name!==v.item.name?!1:t.item.isOfType("melee")&&v.item.isOfType("melee")?!0:t.item.isOfType("weapon")&&v.item.isOfType("weapon")&&t.item.isMelee===v.item.isMelee)??t.statistic:t.statistic,f=(()=>{if(u===this)return t.item??null;if(m&&"item"in m&&m.item instanceof Item&&m.item.isOfType("action","melee","spell","weapon"))return m.item;let v=u.items.get(t.item?.id??"");return v?.isOfType("melee","weapon")?v:t.item??null})(),S=f?.getRollOptions("item")??[],I=(()=>{let v=ae.compact([t.traits].flat());if(f?.isOfType("weapon","melee")){let N=[u.synthetics.strikeAdjustments,Ni(f.system.runes.property)].flat();for(let K of N)K.adjustTraits?.(f,v)}return ae.uniq(v).sort()})(),E=e&&i?e.distanceTo(i):null,[k,x]=typeof E=="number"?[`origin:distance:${E}`,`target:distance:${E}`]:[null,null],T=(()=>{let v=e?i?.actor?.synthetics.tokenMarks.get(e.document.uuid):null;return v?`origin:mark:${v}`:null})(),W=e&&i?ae.compact(ae.uniq([...u.getSelfRollOptions("origin"),...I.map(v=>`origin:action:trait${v}`),...k?[k]:[],T])):[],b=a(v=>{let N=v?.getSelfRollOptions("target")??[];return i&&(N.push("target"),l&&N.push(l)),N.sort()},"getTargetRollOptions"),F=b(i?.actor),G=await ft({affects:"target",origin:u,target:i?.actor??null,item:f,domains:t.domains,options:[...t.options,...S,...F]});if(e?.actor&&i?.actor&&!t.viewOnly){let v=re(e,i,{extraOptions:S,distance:E}),N=oe(e,i,{perception:v,affects:"origin"});N&&U(v,"target","visibility","noff",N)&&(N=void 0),P[N]>P.concealed&&G.push(Lt(N));let K=ct(e,i,{perception:v,affects:"target",options:S}),he;if(K){let ce=U(v,"target","cover","ac",K)?.first();ce!=null&&(ce=Math.clamped(it(ce),0,4)),ce===0?K=void 0:ce&&(he=ce)}R[K]>R.none&&G.push(ke(K,he))}if(s&&Ht(i.actor,u,W)){let v=game.i18n.localize("PF2E.Item.Condition.Flanked"),N=game.pf2e.ConditionManager.getCondition("off-guard",{name:v});G.push(N.toObject())}let se=t.viewOnly?null:(t.target?.actor??i?.actor)?.getContextualClone(ae.compact([...t.options,...S,...W]),G)??null,Fe=new Set(ae.compact([...t.options,...u.getRollOptions(t.domains),...se?b(se):F,...I.map(v=>`self:action:trait:${v}`),...S,n?"attack":null]).sort());x&&Fe.add(x);let A=f?Bt(f,E):null;A&&Fe.add(`target:range-increment:${A}`);let M={actor:u,token:e?.document??null,statistic:m,item:f,modifiers:[]},D=se&&i&&E!==null?{actor:se,token:i.document,distance:E,rangeIncrement:A}:null;return{options:Fe,self:M,target:D,traits:I}}a(Ci,"getRollContext");var Zi=["cover","concealed","hidden","undetected","unnoticed"],Ve=class extends FormApplication{static get defaultOptions(){return foundry.utils.mergeObject(super.defaultOptions,{template:X("icon-path-menu"),title:h("settings.icon-path.name"),width:500})}getData(){let e=C("icon-path");return{icons:Zi.map(n=>({name:n,placeholder:ze[n],value:e[n]??"",label:n==="cover"?h("icon-path.cover"):game.i18n.localize(CONFIG.PF2E.conditionTypes[n])})),i18n:h}}activateListeners(e){super.activateListeners(e),e.find("button[name=cancel]").on("click",i=>{i.prefentDefault(),this.close()})}async _updateObject(e,i){je("icon-path",i)}};a(Ve,"IconPathMenu");function Oi(){j("icon-path",Object,{},{config:!1}),game.settings.registerMenu(y,"icon-path-menu",{name:O("icon-path","name"),label:O("icon-path","label"),icon:"fa-solid fa-list",restricted:!0,type:Ve}),j("permission",String,CONST.USER_ROLES.GAMEMASTER,{choices:{1:O("permission","choices.1"),2:O("permission","choices.2"),3:O("permission","choices.3"),4:O("permission","choices.4")}}),j("npc-vision",Boolean,!1),j("target",Boolean,!0,{onChange:()=>ui.combat?.render()}),j("lesser",String,"ten",{choices:{none:O("lesser","choices.none"),cross:O("lesser","choices.cross"),zero:O("lesser","choices.zero"),ten:O("lesser","choices.ten"),twenty:O("lesser","choices.twenty")}}),j("standard",Boolean,!0),j("dead-cover",Boolean,!0),j("prone-cover",Boolean,!0),j("standard-type",String,"center",{choices:{center:O("standard-type","choices.center"),points:O("standard-type","choices.points")}}),j("skip-cover",Boolean,!0),j("validation",String,"all",{choices:{all:O("validation","choices.all"),selected:O("validation","choices.selected"),changed:O("validation","choices.changed")}}),j("flat-check",String,"roll",{choices:{none:O("flat-check","choices.none"),roll:O("flat-check","choices.roll"),cancel:O("flat-check","choices.cancel")}}),j("encounter",Boolean,!1)}a(Oi,"registerSettings");function O(t,e){return`${y}.settings.${t}.${e}`}a(O,"path");function j(t,e,i,n={}){game.settings.register(y,t,{name:O(t,"name"),hint:O(t,"hint"),scope:"world",config:!0,type:e,default:i,...n})}a(j,"register");var Ji="game.pf2e.Check.roll",en="CONFIG.Token.documentClass.prototype.rulesBasedVision",tn="CONFIG.MeasuredTemplate.objectClass.prototype.highlightGrid",nn="CONFIG.Actor.documentClass.prototype.getRollContext",rn="DetectionMode.prototype.testVisibility",on="CONFIG.Canvas.detectionModes.basicSight._canDetect",an="CONFIG.Canvas.detectionModes.hearing._canDetect",sn="CONFIG.Canvas.detectionModes.feelTremor._canDetect";Hooks.once("init",()=>{Oi(),hi(),ei(),libWrapper.register(y,Ji,Pi),libWrapper.register(y,tn,Zt,"OVERRIDE"),libWrapper.register(y,en,li,"OVERRIDE"),libWrapper.register(y,nn,Ci,"OVERRIDE"),libWrapper.register(y,rn,Ei,"OVERRIDE"),libWrapper.register(y,on,Ti,"OVERRIDE"),libWrapper.register(y,an,Ri,"OVERRIDE"),libWrapper.register(y,sn,xi,"OVERRIDE"),game.data.users.find(e=>e._id===game.data.userId).role>=CONST.USER_ROLES.GAMEMASTER?(Hooks.on("renderSceneConfig",Ut),Hooks.on("renderCombatTrackerConfig",Si)):Hooks.on("renderCombatTracker",bi),game.modules.get(y).custom={getWallCover:void 0}});Hooks.once("ready",()=>{game.modules.get(y).api=vi,Hooks.on("renderChatMessage",Tt);for(let t of document.querySelectorAll("#chat-log .chat-message")){let e=game.messages.get(t.dataset.messageId);e&&Tt(e,$(t))}game.user.isGM&&game.modules.get("pf2e-rules-based-npc-vision")?.active&&ui.notifications.error(`${y}.warning.npc-vision`,{permanent:!0,localize:!0})});Hooks.on("hoverToken",ai);Hooks.on("pasteToken",ni);Hooks.on("updateToken",oi);Hooks.on("deleteToken",si);Hooks.on("controlToken",ci);Hooks.on("renderTokenHUD",ii);Hooks.on("preCreateToken",di);Hooks.on("canvasPan",()=>me());Hooks.on("renderCheckModifiersDialog",ki);Hooks.on("preCreateMeasuredTemplate",Jt);Hooks.on("createMeasuredTemplate",et);Hooks.on("updateMeasuredTemplate",et);Hooks.on("deleteMeasuredTemplate",et);})();
//# sourceMappingURL=main.js.map
