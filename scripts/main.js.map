{
  "version": 3,
  "sources": ["../src/constants.js", "../src/module.js", "../src/effect.js", "../src/pf2e/helpers.js", "../src/rule-element.js", "../src/scene.js", "../src/utils.js", "../src/apps/base-menu.js", "../src/apps/perception.js", "../src/geometry.js", "../src/lighting.js", "../src/pf2e/highlight.js", "../src/template.js", "../src/token.js", "../src/actor.js", "../src/pf2e/success.js", "../src/apps/validation.js", "../src/chat.js", "../src/action.js", "../src/api.js", "../src/check.js", "../src/combat.js", "../src/detection.js", "../src/apps/icon-path-menu.js", "../src/settings.js", "../src/main.js"],
  "sourcesContent": ["export const COVER_UUID = 'Compendium.pf2e.other-effects.Item.I9lfZUiCwMiGogVi'\r\n\r\nexport const VISIBILITY_VALUES = {\r\n    [undefined]: 0,\r\n    observed: 0,\r\n    concealed: 1,\r\n    hidden: 2,\r\n    undetected: 3,\r\n    unnoticed: 4,\r\n}\r\n\r\nexport const VISIBILITIES = ['observed', 'concealed', 'hidden', 'undetected', 'unnoticed']\r\n\r\nexport const COVERS = ['none', 'lesser', 'standard', 'greater', 'greater-prone']\r\n\r\nexport const COVER_VALUES = {\r\n    [undefined]: 0,\r\n    none: 0,\r\n    lesser: 1,\r\n    standard: 2,\r\n    greater: 3,\r\n    'greater-prone': 4,\r\n}\r\n\r\nexport const defaultValues = {\r\n    cover: 'none',\r\n    visibility: 'observed',\r\n}\r\n\r\nexport const attackCheckRoll = ['attack-roll', 'spell-attack-roll']\r\n\r\nexport const validCheckRoll = [...attackCheckRoll, 'skill-check', 'perception-check']\r\n\r\nexport const ICONS_PATHS = {\r\n    cover: 'modules/pf2e-perception/images/cover.webp',\r\n    concealed: 'systems/pf2e/icons/conditions/concealed.webp',\r\n    hidden: 'systems/pf2e/icons/conditions/hidden.webp',\r\n    undetected: 'systems/pf2e/icons/conditions/undetected.webp',\r\n    unnoticed: 'systems/pf2e/icons/conditions/unnoticed.webp',\r\n}\r\n\r\nexport const VISION_LEVELS = {\r\n    BLINDED: 0,\r\n    NORMAL: 1,\r\n    LOWLIGHT: 2,\r\n    DARKVISION: 3,\r\n}\r\n\r\nexport const DARKNESS_COLOR = '#000000'\r\nexport const MIST_COLOR = '#656665'\r\nexport const POISON_GREEN = '#809e71'\r\n\r\nexport const DARKNESS_SLUGS = ['darkness', 'dance-of-darkness', 'ravenous-darkness']\r\nexport const MIST_SLUGS = ['obscuring-mist', 'stinking-cloud']\r\n", "export const MODULE_ID = 'pf2e-perception'\r\n\r\nexport function templatePath(template) {\r\n    return `modules/${MODULE_ID}/templates/${template}.hbs`\r\n}\r\n\r\nexport function localize(...args) {\r\n    const data = args.at(-1)\r\n    const useFormat = typeof data === 'object'\r\n\r\n    const keys = useFormat ? args.slice(0, -1) : args\r\n    keys.unshift(MODULE_ID)\r\n\r\n    return game.i18n[useFormat ? 'format' : 'localize'](keys.join('.'), data)\r\n}\r\n\r\nexport function getFlag(doc, flag) {\r\n    return doc.getFlag(MODULE_ID, flag)\r\n}\r\n\r\nexport function setFlag(doc, flag, value) {\r\n    return doc.setFlag(MODULE_ID, flag, value)\r\n}\r\n\r\nexport function unsetFlag(doc, flag) {\r\n    return doc.unsetFlag(MODULE_ID, flag, true)\r\n}\r\n\r\nexport function getFlags(doc) {\r\n    return getProperty(doc, `flags.${MODULE_ID}`) ?? {}\r\n}\r\n\r\nexport function getSetting(setting) {\r\n    return game.settings.get(MODULE_ID, setting)\r\n}\r\n\r\nexport function setSetting(setting, value) {\r\n    return game.settings.set(MODULE_ID, setting, value)\r\n}\r\n\r\nexport function hasPermission() {\r\n    return game.user.role >= getSetting('permission')\r\n}\r\n", "import { COVER_UUID, COVER_VALUES } from './constants.js'\r\nimport { MODULE_ID, localize } from './module.js'\r\n\r\nexport function createFlatFootedSource(visibility) {\r\n    const condition = game.pf2e.ConditionManager.getCondition('off-guard')\r\n    const source = condition.toObject()\r\n    source.name += ` (${game.i18n.localize(`PF2E.condition.${visibility}.name`)})`\r\n    return source\r\n}\r\n\r\nexport function createCoverSource(level, bonus) {\r\n    bonus ??= COVER_VALUES[level] === 3 ? 4 : COVER_VALUES[level]\r\n\r\n    return {\r\n        _id: 'I9lfZUiCwMiGogVi',\r\n        img: 'systems/pf2e/icons/conditions-2/status_acup.webp',\r\n        name: localize('cover', level),\r\n        system: {\r\n            description: {\r\n                gm: '',\r\n                value: \"<p>When you're behind an obstacle that could block weapons, guard you against explosions, and make you harder to detect, you're behind cover. Standard cover gives you a +2 circumstance bonus to AC, to Reflex saves against area effects, and to Stealth checks to Hide, Sneak, or otherwise avoid detection. You can increase this to greater cover using the Take Cover basic action, increasing the circumstance bonus to +4. If cover is especially light, typically when it's provided by a creature, you have lesser cover, which grants a +1 circumstance bonus to AC. A creature with standard cover or greater cover can attempt to use Stealth to Hide, but lesser cover isn't sufficient.</p>\",\r\n            },\r\n            rules: [\r\n                { domain: 'all', key: 'RollOption', option: `self:cover-bonus:${bonus}` },\r\n                { domain: 'all', key: 'RollOption', option: `self:cover-level:${level}` },\r\n                {\r\n                    key: 'FlatModifier',\r\n                    predicate: [\r\n                        { or: [{ and: ['self:condition:prone', 'item:ranged'] }, { not: 'self:cover-level:greater-prone' }] },\r\n                    ],\r\n                    selector: 'ac',\r\n                    type: 'circumstance',\r\n                    value: bonus,\r\n                },\r\n                {\r\n                    key: 'FlatModifier',\r\n                    predicate: ['area-effect', { not: 'self:cover-level:greater-prone' }],\r\n                    selector: 'reflex',\r\n                    type: 'circumstance',\r\n                    value: bonus,\r\n                },\r\n                {\r\n                    key: 'FlatModifier',\r\n                    predicate: [\r\n                        { or: ['action:hide', 'action:sneak', 'avoid-detection'] },\r\n                        { not: 'self:cover-level:greater-prone' },\r\n                    ],\r\n                    selector: 'stealth',\r\n                    type: 'circumstance',\r\n                    value: bonus,\r\n                },\r\n                {\r\n                    key: 'FlatModifier',\r\n                    predicate: ['action:avoid-notice', { not: 'self:cover-level:greater-prone' }],\r\n                    selector: 'initiative',\r\n                    type: 'circumstance',\r\n                    value: bonus,\r\n                },\r\n            ],\r\n            slug: 'effect-cover',\r\n        },\r\n        type: 'effect',\r\n        flags: {\r\n            core: { sourceId: COVER_UUID },\r\n            [MODULE_ID]: {\r\n                level,\r\n                bonus,\r\n            },\r\n        },\r\n    }\r\n}\r\n\r\nexport function findChoiceSetRule(item, flag = undefined) {\r\n    if (!item) return undefined\r\n    return item.system.rules.find(rule => rule.key === 'ChoiceSet' && (!flag || rule.flag === flag))\r\n}\r\n", "export async function extractEphemeralEffects({ affects, origin, target, item, domains, options }) {\r\n    if (!(origin && target)) return []\r\n\r\n    const [effectsFrom, effectsTo] = affects === 'target' ? [origin, target] : [target, origin]\r\n    const fullOptions = [...options, ...effectsTo.getSelfRollOptions(affects)]\r\n    const resolvables = item ? (item.isOfType('spell') ? { spell: item } : { weapon: item }) : {}\r\n    return (\r\n        await Promise.all(\r\n            domains\r\n                .flatMap(s => effectsFrom.synthetics.ephemeralEffects[s]?.[affects] ?? [])\r\n                .map(d => d({ test: fullOptions, resolvables }))\r\n        )\r\n    ).flatMap(e => e ?? [])\r\n}\r\n\r\nexport function traitSlugToObject(trait, dictionary) {\r\n    // Look up trait labels from `npcAttackTraits` instead of `weaponTraits` in case a battle form attack is\r\n    // in use, which can include what are normally NPC-only traits\r\n    const traitObject = {\r\n        name: trait,\r\n        label: game.i18n.localize(dictionary[trait] ?? trait),\r\n    }\r\n    if (objectHasKey(CONFIG.PF2E.traitsDescriptions, trait)) {\r\n        traitObject.description = CONFIG.PF2E.traitsDescriptions[trait]\r\n    }\r\n\r\n    return traitObject\r\n}\r\n\r\nexport function objectHasKey(obj, key) {\r\n    return (typeof key === 'string' || typeof key === 'number') && key in obj\r\n}\r\n\r\nexport function getRangeIncrement(attackItem, distance) {\r\n    if (attackItem.isOfType('spell')) return null\r\n\r\n    return attackItem.rangeIncrement && typeof distance === 'number'\r\n        ? Math.max(Math.ceil(distance / attackItem.rangeIncrement), 1)\r\n        : null\r\n}\r\n\r\nexport function isOffGuardFromFlanking(target, origin) {\r\n    if (!target?.isOfType('creature')) return false\r\n\r\n    const { flanking } = target.attributes\r\n    return !flanking.flankable\r\n        ? false\r\n        : typeof flanking.offGuardable === 'number'\r\n        ? origin.level > flanking.offGuardable\r\n        : flanking.offGuardable\r\n}\r\n\r\nexport function isObject(value) {\r\n    return typeof value === 'object' && value !== null\r\n}\r\n", "import { COVERS, VISIBILITIES, defaultValues } from './constants.js'\r\n\r\nconst DATA = {\r\n    cover: {\r\n        cancel: { targets: ['lesser', 'standard', 'greater', 'greater-prone'] },\r\n        set: {\r\n            targets: ['none', 'lesser', 'standard', 'greater', 'greater-prone'],\r\n            value: ['none', 'lesser', 'standard', 'greater', 'greater-prone'],\r\n        },\r\n        reduce: { targets: ['lesser', 'standard', 'greater', 'greater-prone'] },\r\n        ignore: { targets: 'string' },\r\n        ac: { targets: ['lesser', 'standard', 'greater', 'greater-prone'], value: 'number' },\r\n    },\r\n    visibility: {\r\n        cancel: { targets: ['concealed', 'hidden', 'undetected', 'unnoticed'] },\r\n        set: {\r\n            targets: ['observed', 'concealed', 'hidden', 'undetected', 'unnoticed'],\r\n            value: ['observed', 'concealed', 'hidden', 'undetected', 'unnoticed'],\r\n        },\r\n        reduce: { targets: ['concealed', 'hidden', 'undetected', 'unnoticed'] },\r\n        noff: { targets: ['hidden', 'undetected', 'unnoticed'] },\r\n        noinvis: {},\r\n        dc: { targets: ['concealed', 'hidden'], value: 'number' },\r\n    },\r\n}\r\n\r\nconst SELECTORS = {\r\n    cover: Object.keys(DATA.cover),\r\n    visibility: Object.keys(DATA.visibility),\r\n    all: [...Object.keys(DATA.cover), ...Object.keys(DATA.visibility)],\r\n}\r\n\r\nexport function setupRuleElement() {\r\n    const rollOptionSchema = game.pf2e.RuleElements.builtin.RollOption.defineSchema()\r\n    const PredicateField = rollOptionSchema.predicate.constructor\r\n    const ResolvableValueField = rollOptionSchema.value.constructor\r\n\r\n    class PF2ePerceptionRuleElement extends game.pf2e.RuleElement {\r\n        constructor(source, options) {\r\n            if (typeof source.targets === 'string') source.targets = [source.targets]\r\n\r\n            super({ priority: CONST.ACTIVE_EFFECT_MODES.CUSTOM, ...source }, options)\r\n\r\n            const selectorType = SELECTORS[source.type]\r\n            if (!selectorType) return\r\n\r\n            if (!selectorType?.includes(source.selector)) {\r\n                this.failValidation(`The type \"${source.type}\" only accepts the following selectors: ${selectorType.join(', ')}.`)\r\n                return\r\n            }\r\n\r\n            const selector = DATA[source.type]?.[source.selector]\r\n            if (!selector) return\r\n\r\n            const selectorWarn = msg => {\r\n                const { name, uuid } = this.item\r\n                console.warn(`PF2e System | PF2ePerception rules element on item ${name} (${uuid}) simple warning: ${msg}`)\r\n            }\r\n\r\n            const targetsType = Array.isArray(selector.targets) ? [...selector.targets, 'all'] : selector.targets\r\n            const joinedTargets = Array.isArray(targetsType) ? targetsType.join(', ') : null\r\n\r\n            if (!targetsType && source.targets?.length) {\r\n                selectorWarn(`The selector \"${source.selector}\" doesn't accept any targets property.`)\r\n                return\r\n            }\r\n\r\n            if (source.selector === 'ignore' && !source.targets?.length) {\r\n                const msg = `The selector \"${source.selector}\" requires a targets property with the ids of the tokens on the scene that should not give cover.`\r\n                this.failValidation(msg)\r\n                return\r\n            }\r\n\r\n            if (joinedTargets && source.targets?.some(t => !targetsType.includes(t))) {\r\n                const msg = `The targets property of selector \"${source.selector}\" only accepts the following: ${joinedTargets}.`\r\n                this.failValidation(msg)\r\n                return\r\n            } else if (!joinedTargets && targetsType && source.targets?.some(t => typeof t !== targetsType)) {\r\n                const msg = `The targets property of selector \"${source.selector}\" needs to be of type \"${targetsType}\".`\r\n                this.failValidation(msg)\r\n                return\r\n            }\r\n\r\n            const valueType = selector.value\r\n            if (!valueType && selector.value) {\r\n                selectorWarn(`The selector \"${source.selector}\" doesn't accept any value property.`)\r\n                return\r\n            }\r\n\r\n            if (valueType && typeof source.value !== valueType) {\r\n                this.failValidation(`The selector \"${source.selector}\" only accept a value property of type ${valueType}.`)\r\n            }\r\n        }\r\n\r\n        static defineSchema() {\r\n            const { fields } = foundry.data\r\n\r\n            return {\r\n                ...super.defineSchema(),\r\n\r\n                type: new fields.StringField({\r\n                    required: true,\r\n                    nullable: false,\r\n                    blank: false,\r\n                    choices: ['visibility', 'cover'],\r\n                }),\r\n\r\n                affects: new fields.StringField({\r\n                    required: true,\r\n                    nullable: false,\r\n                    blank: false,\r\n                    initial: 'self',\r\n                    choices: ['self', 'other'],\r\n                }),\r\n\r\n                selector: new fields.StringField({\r\n                    required: true,\r\n                    nullable: false,\r\n                    blank: false,\r\n                }),\r\n\r\n                targets: new fields.ArrayField(\r\n                    new fields.StringField({\r\n                        required: true,\r\n                        nullable: false,\r\n                        blank: false,\r\n                        initial: undefined,\r\n                    }),\r\n                    {\r\n                        required: true,\r\n                        nullable: false,\r\n                        initial: ['all'],\r\n                    }\r\n                ),\r\n\r\n                predicate: new PredicateField({\r\n                    required: false,\r\n                    nullable: false,\r\n                }),\r\n\r\n                value: new ResolvableValueField({\r\n                    required: false,\r\n                    initial: undefined,\r\n                }),\r\n            }\r\n        }\r\n\r\n        test(rollOptions, password) {\r\n            if (!password) return false\r\n            return super.test(rollOptions)\r\n        }\r\n\r\n        addToPerception(affects, perception, options) {\r\n            if (!this.test(options, true)) return\r\n\r\n            const prefix = this.affects === 'self' ? affects : affects === 'origin' ? 'target' : 'origin'\r\n            const root = `${prefix}.${this.type}.${this.selector}`\r\n            const verificator = DATA[this.type][this.selector]\r\n\r\n            if (!verificator.targets) {\r\n                setProperty(perception, root, true)\r\n                return\r\n            }\r\n\r\n            const targets = this.targets.includes('all') ? verificator.targets : this.targets\r\n\r\n            if (!verificator.value) {\r\n                for (const target of targets) {\r\n                    const path = `${root}.${target}`\r\n                    setProperty(perception, path, true)\r\n                }\r\n                return\r\n            }\r\n\r\n            for (const target of targets) {\r\n                const path = `${root}.${target}`\r\n\r\n                let value = getProperty(perception, path)\r\n                if (value) value.add(this.value)\r\n                else value = new Set([this.value])\r\n\r\n                setProperty(perception, path, value)\r\n            }\r\n        }\r\n    }\r\n\r\n    game.pf2e.RuleElements.custom.PF2ePerception = PF2ePerceptionRuleElement\r\n}\r\n\r\nexport function perceptionRules(origin, target, { distance, extraOptions = [] } = {}) {\r\n    if (!origin.actor || !target.actor) return {}\r\n\r\n    const rules = {\r\n        origin: origin.actor?.rules.filter(r => !r.ignored && r.key === 'PF2ePerception') ?? [],\r\n        target: target.actor?.rules.filter(r => !r.ignored && r.key === 'PF2ePerception') ?? [],\r\n    }\r\n    if (!rules.origin.length && !rules.target.length) return {}\r\n\r\n    const selfOptions = {\r\n        origin: origin.actor.getRollOptions(),\r\n        target: target.actor.getRollOptions(),\r\n    }\r\n\r\n    const otherOptions = {\r\n        origin: target.actor.getSelfRollOptions('target'),\r\n        target: origin.actor.getSelfRollOptions('origin'),\r\n    }\r\n\r\n    origin = origin instanceof Token ? origin : origin.object\r\n    target = target instanceof Token ? target : target.object\r\n\r\n    distance ??= origin.distanceTo(target)\r\n    const distances = [`origin:distance:${distance}`, `target:distance:${distance}`]\r\n\r\n    const perception = {}\r\n\r\n    for (const prefix of ['origin', 'target']) {\r\n        const testOptions = [...extraOptions, ...selfOptions[prefix], ...otherOptions[prefix], ...distances]\r\n        for (const rule of rules[prefix]) {\r\n            rule.addToPerception(prefix, perception, testOptions)\r\n        }\r\n    }\r\n\r\n    return perception\r\n}\r\n\r\nexport function getPerception(perception, affects, type, selector, targets) {\r\n    let cursor = perception[affects]?.[type]?.[selector]\r\n    return targets ? cursor?.[targets] : cursor\r\n}\r\n\r\nexport function updateFromPerceptionRules(perception, affects, type, value) {\r\n    const list = type === 'cover' ? COVERS : VISIBILITIES\r\n\r\n    if (value && getPerception(perception, affects, type, 'cancel', value)) return undefined\r\n\r\n    const setValue = getPerception(perception, affects, type, 'set', value)?.first()\r\n    if (setValue && list.includes(setValue)) value = setValue\r\n    else if (value && getPerception(perception, affects, type, 'reduce', value)) {\r\n        const index = list.indexOf(value)\r\n        value = list[Math.max(0, index - 1)]\r\n    }\r\n\r\n    return value === list[0] ? undefined : value\r\n}\r\n", "import { getFlag, getSetting, localize } from './module.js'\r\n\r\nexport function renderSceneConfig(config, html) {\r\n    let settings = ''\r\n\r\n    const list = ['standard', 'npc-vision']\r\n    for (const setting of list) {\r\n        const checked = getSceneSetting(config.object, setting)\r\n\r\n        settings += `<div class=\"form-group pf2e-perception-injected\">\r\n    <label>${localize(`settings.${setting}.name`)}</label>\r\n    <input type=\"checkbox\" name=\"flags.pf2e-perception.${setting}\" ${checked ? 'checked' : ''}>\r\n    <p class=\"notes\">${localize(`settings.${setting}.short`)}</p>\r\n</div>`\r\n    }\r\n\r\n    settings += '<hr>'\r\n\r\n    html.find('.tab[data-tab=\"basic\"] hr').first().after(settings)\r\n\r\n    const addedHeight = html\r\n        .find('.pf2e-perception-injected')\r\n        .toArray()\r\n        .reduce((height, el) => ((height += el.clientHeight), height), 0)\r\n\r\n    config.setPosition({ top: config.position.top - addedHeight / 2 })\r\n}\r\n\r\nexport function getValidTokens(token) {\r\n    token = token instanceof Token ? token.document : token\r\n    if (!(token instanceof TokenDocument)) return []\r\n\r\n    let tokens = token.scene.tokens.filter(t => t !== token && t.actor?.isOfType('creature'))\r\n\r\n    if (getSetting('encounter')) {\r\n        const combat = game.combats.active\r\n        if (!combat) return tokens\r\n\r\n        return tokens.filter(t => {\r\n            const actor = t.actor\r\n            const traits = actor.traits\r\n            return actor.type === 'familiar' || traits.has('minion') || traits.has('eidolon') || combat.getCombatantByToken(t.id)\r\n        })\r\n    }\r\n\r\n    return tokens\r\n}\r\n\r\nexport function validateTokens(token, tokens) {\r\n    const validToken = getValidTokens(token).map(t => t.id)\r\n    return tokens.filter(t => {\r\n        const id = t instanceof Token || t instanceof TokenDocument ? t.id : t\r\n        return validToken.includes(id)\r\n    })\r\n}\r\n\r\nexport function getSceneSetting(scene, setting) {\r\n    return getFlag(scene, setting) ?? getSetting(setting)\r\n}\r\n", "export function modifier(value) {\r\n    return value >= 0 ? `+${value}` : value\r\n}\r\n\r\nexport function omit(object, names) {\r\n    const set = new Set(names)\r\n    return Object.entries(object).reduce((acc, [name, value]) => {\r\n        if (!set.has(name)) acc[name] = value\r\n        return acc\r\n    }, {})\r\n}\r\n\r\nexport function getPrototype(obj, depth = 1) {\r\n    const prototype = Object.getPrototypeOf(obj)\r\n    if (depth > 1) return getPrototype(prototype, depth - 1)\r\n    return prototype\r\n}\r\n\r\nexport function sortByName(a, b) {\r\n    return a.name.localeCompare(b.name)\r\n}\r\n\r\nexport function asNumberOnly(value) {\r\n    value = Number(value)\r\n    return isNaN(value) ? undefined : value\r\n}\r\n", "import { COVERS, VISIBILITIES, defaultValues } from '../constants.js'\r\nimport { MODULE_ID, localize } from '../module.js'\r\nimport { validateTokens } from '../scene.js'\r\nimport { getTokenData, setTokenData } from '../token.js'\r\nimport { sortByName } from '../utils.js'\r\n\r\nexport class BaseMenu extends Application {\r\n    #token\r\n    #resolve\r\n    #selected\r\n    #_currentData\r\n    #hoverTokenListener\r\n\r\n    constructor({ token, resolve, selected = [] }, options = {}) {\r\n        super(options)\r\n\r\n        this.#token = token\r\n        this.#resolve = resolve\r\n        this.#selected = selected\r\n\r\n        this.#hoverTokenListener = (token, hover) => {\r\n            const tokenId = token.id\r\n            const tokens = this.element.find('[data-token-id]')\r\n            tokens.removeClass('hover')\r\n            if (hover) tokens.filter(`[data-token-id=${tokenId}]`).addClass('hover')\r\n        }\r\n\r\n        Hooks.on('hoverToken', this.#hoverTokenListener)\r\n    }\r\n\r\n    async close(options = {}) {\r\n        Hooks.off('hoverToken', this.#hoverTokenListener)\r\n        this.#resolve?.(options.resolve ?? false)\r\n        super.close(options)\r\n    }\r\n\r\n    static get defaultOptions() {\r\n        return mergeObject(super.defaultOptions, {\r\n            minimizable: false,\r\n        })\r\n    }\r\n\r\n    static async openMenu(params, options = {}) {\r\n        if (params.token instanceof TokenDocument) params.token = params.token.object\r\n        if (!params.token) {\r\n            ui.notifications.error(localize('menu.no-token'))\r\n            return\r\n        }\r\n\r\n        options.id = `${MODULE_ID}-${params.token.document.uuid}`\r\n\r\n        const win = Object.values(ui.windows).find(x => x.id === options.id)\r\n        if (win) win.close()\r\n\r\n        return new Promise(resolve => {\r\n            params.resolve = resolve\r\n            new this(params, options).render(true)\r\n        })\r\n    }\r\n\r\n    static createPropertyData(original, current, property) {\r\n        const defaultValue = defaultValues[property]\r\n        const originalValue = original[property] ?? defaultValue\r\n        const currentValue = current[property] ?? defaultValue\r\n        return {\r\n            original: originalValue,\r\n            current: currentValue,\r\n            changed: originalValue !== currentValue,\r\n            custom: currentValue !== defaultValue,\r\n            originalCustom: originalValue !== defaultValue,\r\n        }\r\n    }\r\n\r\n    get token() {\r\n        return this.#token\r\n    }\r\n\r\n    get document() {\r\n        return this.#token.document\r\n    }\r\n\r\n    get actor() {\r\n        return this.#token.actor\r\n    }\r\n\r\n    get scene() {\r\n        return this.#token.scene\r\n    }\r\n\r\n    get selected() {\r\n        return this.#selected.length ? validateTokens(this.token, this.#selected) : []\r\n    }\r\n\r\n    get currentData() {\r\n        return deepClone(this.#currentData)\r\n    }\r\n\r\n    get #currentData() {\r\n        if (!this.#_currentData) this.#_currentData = this.getSavedData()\r\n        return this.#_currentData\r\n    }\r\n\r\n    getSavedData() {\r\n        const data = getTokenData(this.document) ?? {}\r\n        return deepClone(data)\r\n    }\r\n\r\n    reset() {\r\n        this.#_currentData = this.getSavedData()\r\n        this.#selected = []\r\n        this.render()\r\n    }\r\n\r\n    isSelected(token) {\r\n        const id = typeof token === 'object' ? token.id : token\r\n        return this.#selected.includes(id)\r\n    }\r\n\r\n    getData(options) {\r\n        return {\r\n            i18n: localize,\r\n            covers: COVERS.map(value => ({ value, label: localize(`cover.${value}`) })),\r\n            visibilities: VISIBILITIES.map(value => ({ value, label: localize(`visibility.${value}`) })),\r\n        }\r\n    }\r\n\r\n    activateListeners(html) {\r\n        html.find('[data-token-id]').on('mouseenter', event => {\r\n            const { tokenId } = event.currentTarget.dataset\r\n            const token = this.scene.tokens.get(tokenId)?.object\r\n            if (!token || token.controlled) return\r\n            token._onHoverIn(event, { hoverOutOthers: true })\r\n        })\r\n\r\n        html.find('[data-action=close]').on('click', () => {\r\n            this.close({ resolve: true })\r\n        })\r\n\r\n        html.find('select[name=visibility], select[name=cover]').on('change', event => {\r\n            const target = event.currentTarget\r\n            const property = target.name\r\n            const defaultValue = defaultValues[property]\r\n            const value = target.value || defaultValue\r\n            const tokenId = target.closest('.token')?.dataset.tokenId\r\n            const tokenIds = tokenId ? [tokenId] : this.#selected\r\n\r\n            for (const tokenId of tokenIds) {\r\n                setProperty(this.#currentData, `${tokenId}.${property}`, value)\r\n            }\r\n\r\n            if (tokenId) {\r\n                target.classList.toggle('changed', value !== target.dataset.original)\r\n                target.classList.toggle('custom', value !== defaultValue)\r\n            } else this.render()\r\n        })\r\n\r\n        html.find('[data-action=accept]').on('click', event => {\r\n            this._saveData(this.#currentData)\r\n            this.close({ resolve: true })\r\n        })\r\n    }\r\n\r\n    _saveData(currentData) {\r\n        setTokenData(this.document, currentData)\r\n    }\r\n\r\n    _setSelected(selected) {\r\n        this.#selected =\r\n            selected ??\r\n            this.element\r\n                .find('[data-token-id].ui-selected')\r\n                .toArray()\r\n                .map(el => el.dataset.tokenId)\r\n    }\r\n\r\n    _spliIntoAlliances(tokens) {\r\n        const allies = []\r\n        const enemies = []\r\n        const neutral = []\r\n\r\n        const alliance = this.actor.alliance\r\n        const opposition = alliance === 'party' ? 'opposition' : alliance === 'opposition' ? 'party' : null\r\n\r\n        for (const token of tokens) {\r\n            if (opposition) {\r\n                const actorAlliance = token.actor ? token.actor.alliance : token.alliance\r\n                if (actorAlliance === alliance) allies.push(token)\r\n                else if (actorAlliance === opposition) enemies.push(token)\r\n                else if (actorAlliance === null) neutral.push(token)\r\n            } else neutral.push(token)\r\n        }\r\n\r\n        return {\r\n            allies: allies.sort(sortByName),\r\n            neutral: neutral.sort(sortByName),\r\n            enemies: enemies.sort(sortByName),\r\n            hasTokens: allies.length || enemies.length || neutral.length,\r\n        }\r\n    }\r\n}\r\n", "import { localize, templatePath } from '../module.js'\r\nimport { getValidTokens } from '../scene.js'\r\nimport { setTokenData } from '../token.js'\r\nimport { BaseMenu } from './base-menu.js'\r\n\r\nexport class PerceptionMenu extends BaseMenu {\r\n    get title() {\r\n        return localize('menu.perception.title', { name: this.token.name })\r\n    }\r\n\r\n    get template() {\r\n        return templatePath('perception')\r\n    }\r\n\r\n    getData(options) {\r\n        const selected = this.selected\r\n        const currentData = this.currentData\r\n        const originalData = this.getSavedData()\r\n\r\n        const tokens = getValidTokens(this.token).map(({ id, name, actor }) => {\r\n            const current = currentData[id] ?? {}\r\n            const original = originalData[id] ?? {}\r\n\r\n            return {\r\n                id,\r\n                name,\r\n                alliance: actor.alliance,\r\n                cover: BaseMenu.createPropertyData(original, current, 'cover'),\r\n                visibility: BaseMenu.createPropertyData(original, current, 'visibility'),\r\n                selected: selected.includes(id),\r\n            }\r\n        })\r\n\r\n        return {\r\n            ...super.getData(options),\r\n            ...this._spliIntoAlliances(tokens),\r\n        }\r\n    }\r\n\r\n    activateListeners(html) {\r\n        super.activateListeners(html)\r\n\r\n        html.filter('.tokens').selectable({\r\n            autoRefresh: false,\r\n            filter: '.token',\r\n            cancel: 'header,select',\r\n            stop: () => this._setSelected(),\r\n        })\r\n\r\n        html.find('[data-action=select-all]').on('click', event => {\r\n            const section = $(event.currentTarget).closest('section')\r\n            const tokens = (section.length ? section : html).find('[data-token-id]')\r\n            const allSelected = tokens.filter(':not(.ui-selected)').length === 0\r\n            tokens.toggleClass('ui-selected', !allSelected)\r\n            this._setSelected()\r\n        })\r\n\r\n        html.find('[data-action=use-selection]').on('click', event => {\r\n            this._setSelected(canvas.tokens.controlled.map(t => t.id))\r\n            this.render()\r\n        })\r\n\r\n        html.find('[data-action=reset]').on('click', event => this.reset())\r\n    }\r\n}\r\n", "export const RECT_CORNERS = [\r\n    { x: 0, y: 0 },\r\n    { x: 1, y: 0 },\r\n    { x: 0, y: 1 },\r\n    { x: 1, y: 1 },\r\n]\r\n\r\nexport const RECT_SPREAD = [\r\n    { x: 0.25, y: 0.25 },\r\n    { x: 0.5, y: 0.25 },\r\n    { x: 0.75, y: 0.25 },\r\n    { x: 0.25, y: 0.5 },\r\n    { x: 0.5, y: 0.5 },\r\n    { x: 0.75, y: 0.5 },\r\n    { x: 0.25, y: 0.75 },\r\n    { x: 0.5, y: 0.75 },\r\n    { x: 0.75, y: 0.75 },\r\n]\r\n\r\nexport function getRectEdges(rect, margin) {\r\n    const opposite = 1 - margin\r\n    return {\r\n        top: { A: getRectPoint({ x: margin, y: margin }, rect), B: getRectPoint({ x: opposite, y: margin }, rect) },\r\n        right: { A: getRectPoint({ x: opposite, y: margin }, rect), B: getRectPoint({ x: opposite, y: opposite }, rect) },\r\n        bottom: { A: getRectPoint({ x: opposite, y: opposite }, rect), B: getRectPoint({ x: margin, y: opposite }, rect) },\r\n        left: { A: getRectPoint({ x: margin, y: opposite }, rect), B: getRectPoint({ x: margin, y: margin }, rect) },\r\n    }\r\n}\r\n\r\nexport function lineIntersectWall(origin, target, debug = false) {\r\n    if (debug) drawDebugLine(origin, target)\r\n    return CONFIG.Canvas.polygonBackends.move.testCollision(origin, target, { type: 'move', mode: 'any' })\r\n}\r\n\r\nexport function pointToTokenIntersectWall(origin, token, debug = false) {\r\n    for (const point of rectSpread(token.bounds)) {\r\n        if (lineIntersectWall(origin, point, debug)) return true\r\n    }\r\n    return false\r\n}\r\n\r\nexport function getRectPoint(point, rect) {\r\n    return { x: rect.x + rect.width * point.x, y: rect.y + rect.height * point.y }\r\n}\r\n\r\nexport function clearDebug() {\r\n    canvas.controls.debug.clear()\r\n}\r\n\r\nexport function drawDebugLine(origin, target, color = 'blue') {\r\n    const hex = color === 'blue' ? 0x0066cc : color === 'red' ? 0xff0000 : 0x16a103\r\n    canvas.controls.debug.lineStyle(4, hex).moveTo(origin.x, origin.y).lineTo(target.x, target.y)\r\n}\r\n\r\nexport function* rectSpread(rect) {\r\n    for (const point of RECT_SPREAD) {\r\n        yield getRectPoint(point, rect)\r\n    }\r\n}\r\n\r\nexport function* rectCorners(rect) {\r\n    for (const point of RECT_CORNERS) {\r\n        yield getRectPoint(point, rect)\r\n    }\r\n}\r\n", "import { clearDebug, drawDebugLine, rectCorners } from './geometry.js'\r\n\r\nexport function getLightExposure(token, debug = false) {\r\n    token = token instanceof Token ? token : token.object\r\n\r\n    if (token.document.hasStatusEffect(CONFIG.specialStatusEffects.INVISIBLE)) return undefined\r\n\r\n    const scene = token.scene\r\n    if (scene !== canvas.scene || !scene.tokenVision || scene.darkness < scene.globalLightThreshold) return undefined\r\n\r\n    if (debug) clearDebug()\r\n\r\n    const center = token.document.center\r\n    let exposure = null\r\n\r\n    for (const light of canvas.effects.lightSources) {\r\n        if (!light.active) continue\r\n\r\n        const bright = light.data.bright\r\n        const dim = light.data.dim\r\n\r\n        if (light.object === token) {\r\n            if (bright) return 'bright'\r\n            if (dim) exposure = 'dim'\r\n            continue\r\n        }\r\n\r\n        if (!light.shape.contains(center.x, center.y)) {\r\n            if (debug) drawDebugLine(light, center, 'red')\r\n            continue\r\n        }\r\n\r\n        if (light.ratio === 1) {\r\n            if (debug) drawDebugLine(light, center, 'green')\r\n            return 'bright'\r\n        }\r\n\r\n        if (light.ratio === 0) {\r\n            if (debug) drawDebugLine(light, center, 'blue')\r\n            exposure = 'dim'\r\n            continue\r\n        }\r\n\r\n        const distance = new Ray(light, center).distance\r\n        if (distance <= bright) {\r\n            if (debug) {\r\n                drawDebugLine(light, center, 'green')\r\n                exposure = 'bright'\r\n            } else return 'bright'\r\n        } else {\r\n            if (debug) {\r\n                drawDebugLine(light, center, 'blue')\r\n                if (exposure !== 'bright') exposure = 'dim'\r\n            } else exposure = 'dim'\r\n        }\r\n    }\r\n\r\n    return exposure\r\n}\r\n", "/**\r\n * Measure distance using Pathfinder 2e grid-counting rules\r\n * @param p0 The origin point\r\n * @param p1 The destination point\r\n */\r\nfunction measureDistance(p0, p1) {\r\n    if (!canvas.dimensions) return NaN\r\n\r\n    if (canvas.grid.type !== CONST.GRID_TYPES.SQUARE) {\r\n        return canvas.grid.measureDistance(p0, p1)\r\n    }\r\n\r\n    return measureDistanceOnGrid(new Ray(p0, p1))\r\n}\r\n\r\n/**\r\n * Given the distance in each dimension, measure the distance in grid units\r\n * @param segment A pair of x/y distances constituting the line segment between two points\r\n * @param [reach] If this is a reach measurement, the origin actor's reach\r\n */\r\nfunction measureDistanceOnGrid(segment, { reach = null } = {}) {\r\n    if (!canvas.dimensions) return NaN\r\n\r\n    const gridSize = canvas.dimensions.size\r\n    const gridDistance = canvas.dimensions.distance\r\n\r\n    const nx = Math.ceil(Math.abs(segment.dx / gridSize))\r\n    const ny = Math.ceil(Math.abs(segment.dy / gridSize))\r\n    const nz = Math.ceil(Math.abs((segment.dz || 0) / gridSize))\r\n\r\n    // ingore the lowest difference\r\n    const sortedDistance = [nx, ny, nz].sort((a, b) => a - b)\r\n    // Get the number of straight and diagonal moves\r\n    const squares = {\r\n        doubleDiagonal: sortedDistance[0],\r\n        diagonal: sortedDistance[1] - sortedDistance[0],\r\n        straight: sortedDistance[2] - sortedDistance[1],\r\n    }\r\n\r\n    // \"Unlike with measuring most distances, 10-foot reach can reach 2 squares diagonally.\" (CRB pg 455)\r\n    const reduction = squares.diagonal + squares.doubleDiagonal > 1 && reach === 10 ? 1 : 0\r\n\r\n    // Diagonals in PF pretty much count as 1.5 times a straight\r\n    // for diagonals across the x, y, and z axis count it as 1.75 as a best guess\r\n    const distance = Math.floor(squares.doubleDiagonal * 1.75 + squares.diagonal * 1.5 + squares.straight) - reduction\r\n\r\n    return distance * gridDistance\r\n}\r\n\r\n/** Highlight grid according to Pathfinder 2e effect-area shapes */\r\nexport function highlightGrid({ areaType, object, colors, document, collisionType = 'move', preview = false, collisionOrigin }) {\r\n    // Only highlight for objects that are non-previews (have IDs)\r\n    if (!object.id && !preview) return\r\n\r\n    const { grid, dimensions } = canvas\r\n    if (!(grid && dimensions)) return\r\n\r\n    // Set data defaults\r\n    const angle = document.angle ?? 0\r\n    const direction = document.direction ?? 45\r\n\r\n    // Clear existing highlight\r\n    const highlightLayer = grid.getHighlightLayer(object.highlightId)?.clear()\r\n    if (!highlightLayer) return\r\n\r\n    const [cx, cy] = grid.getCenter(document.x, document.y)\r\n    const [col0, row0] = grid.grid.getGridPositionFromPixels(cx, cy)\r\n    const minAngle = (360 + ((direction - angle * 0.5) % 360)) % 360\r\n    const maxAngle = (360 + ((direction + angle * 0.5) % 360)) % 360\r\n    const snappedOrigin = canvas.grid.getSnappedPosition(document.x, document.y, object.layer.gridPrecision)\r\n    const withinAngle = (min, max, value) => {\r\n        min = (360 + (min % 360)) % 360\r\n        max = (360 + (max % 360)) % 360\r\n        value = (360 + (value % 360)) % 360\r\n\r\n        if (min < max) return value >= min && value <= max\r\n        return value >= min || value <= max\r\n    }\r\n\r\n    // Offset measurement for cones to ensure that cones only start measuring from cell borders\r\n    const coneOriginOffset = (() => {\r\n        if (areaType !== 'cone') return { x: 0, y: 0 }\r\n\r\n        // Degrees anticlockwise from pointing right. In 45-degree increments from 0 to 360\r\n        const dir = (direction >= 0 ? 360 - direction : -direction) % 360\r\n        // If we're not on a border for X, offset by 0.5 or -0.5 to the border of the cell in the direction we're looking on X axis\r\n        const xOffset =\r\n            snappedOrigin.x % dimensions.size !== 0\r\n                ? Math.sign((1 * Math.round(Math.cos(Math.toRadians(dir)) * 100)) / 100) / 2\r\n                : 0\r\n        // Same for Y, but cos Y goes down on screens, we invert\r\n        const yOffset =\r\n            snappedOrigin.y % dimensions.size !== 0\r\n                ? -Math.sign((1 * Math.round(Math.sin(Math.toRadians(dir)) * 100)) / 100) / 2\r\n                : 0\r\n        return { x: xOffset * dimensions.size, y: yOffset * dimensions.size }\r\n    })()\r\n\r\n    // Point we are measuring distances from\r\n    const padding = Math.clamped(document.width ?? 0, 1.5, 2)\r\n    const docDistance = document.distance ?? 0\r\n    const padded = (docDistance * padding) / dimensions.distance\r\n    const rowCount = Math.ceil(padded / (dimensions.size / grid.h))\r\n    const columnCount = Math.ceil(padded / (dimensions.size / grid.w))\r\n\r\n    // If this is an emanation, measure from the outer squares of the token's space\r\n    const offsetEmanationOrigin = destination => {\r\n        if (!(areaType === 'emanation' && object instanceof Token)) {\r\n            return { x: 0, y: 0 }\r\n        }\r\n\r\n        // No offset is needed for medium and smaller creatures\r\n        if (object.w <= dimensions.size) return { x: 0, y: 0 }\r\n\r\n        const offset = (object.w - dimensions.size) / 2\r\n        const getCoordinate = (centerCoord, destCoord) =>\r\n            destCoord === centerCoord ? 0 : destCoord > centerCoord ? offset : -offset\r\n\r\n        return {\r\n            x: getCoordinate(object.center.x, destination.x),\r\n            y: getCoordinate(object.center.y, destination.y),\r\n        }\r\n    }\r\n\r\n    for (let a = -columnCount; a < columnCount; a++) {\r\n        for (let b = -rowCount; b < rowCount; b++) {\r\n            // Position of cell's top-left corner, in pixels\r\n            const [gx, gy] = canvas.grid.grid.getPixelsFromGridPosition(col0 + a, row0 + b)\r\n            // Position of cell's center in pixels\r\n            const destination = {\r\n                x: gx + dimensions.size * 0.5,\r\n                y: gy + dimensions.size * 0.5,\r\n            }\r\n            if (destination.x < 0 || destination.y < 0) continue\r\n\r\n            // Determine point of origin\r\n            const emanationOriginOffset = offsetEmanationOrigin(destination)\r\n            const origin = {\r\n                x: snappedOrigin.x + coneOriginOffset.x + emanationOriginOffset.x,\r\n                y: snappedOrigin.y + coneOriginOffset.y + emanationOriginOffset.y,\r\n            }\r\n\r\n            if (areaType === 'cone') {\r\n                const ray = new Ray(origin, destination)\r\n                const rayAngle = (360 + ((ray.angle / (Math.PI / 180)) % 360)) % 360\r\n                if (ray.distance > 0 && !withinAngle(minAngle, maxAngle, rayAngle)) {\r\n                    continue\r\n                }\r\n            }\r\n\r\n            // Determine grid-square point to which we're measuring the distance\r\n            const distance = measureDistance(destination, origin)\r\n            if (distance > docDistance) continue\r\n\r\n            const hasCollision =\r\n                canvas.ready &&\r\n                CONFIG.Canvas.polygonBackends[collisionType].testCollision(collisionOrigin ?? origin, destination, {\r\n                    type: collisionType,\r\n                    mode: 'any',\r\n                })\r\n\r\n            if (hasCollision) {\r\n                grid.grid.highlightGridPosition(highlightLayer, {\r\n                    x: gx,\r\n                    y: gy,\r\n                    border: 0x000001,\r\n                    color: 0x000000,\r\n                })\r\n                highlightLayer\r\n                    .beginFill(0x000000, 0.5)\r\n                    .moveTo(gx, gy)\r\n                    .lineTo(gx + dimensions.size, gy + dimensions.size)\r\n                    .endFill()\r\n            } else {\r\n                grid.grid.highlightGridPosition(highlightLayer, {\r\n                    x: gx,\r\n                    y: gy,\r\n                    border: colors.border,\r\n                    color: colors.fill,\r\n                })\r\n            }\r\n        }\r\n    }\r\n}\r\n", "import { DARKNESS_COLOR, DARKNESS_SLUGS, MIST_COLOR, MIST_SLUGS, POISON_GREEN } from './constants.js'\r\nimport { MODULE_ID, getFlag, localize } from './module.js'\r\nimport { highlightGrid } from './pf2e/highlight.js'\r\n\r\nconst templateConversion = {\r\n    burst: 'circle',\r\n    emanation: 'circle',\r\n    line: 'ray',\r\n    cone: 'cone',\r\n    rect: 'rect',\r\n}\r\n\r\nexport function createSeekTemplate({ type, token, distance }) {\r\n    if (!checkScene(token)) return\r\n\r\n    distance ??= type === 'cone' ? 30 : 15\r\n\r\n    createTemplate({\r\n        type,\r\n        distance,\r\n        traits: ['concentrate', 'secret'],\r\n        flags: {\r\n            type: 'seek',\r\n            tokenId: token.id,\r\n            collisionType: 'sight',\r\n            collisionOrigin: token.center,\r\n        },\r\n    })\r\n}\r\n\r\nexport function createDarknessTemplate({ type = 'burst', distance = 20, conceal = false } = {}) {\r\n    createTemplate({\r\n        type,\r\n        distance,\r\n        fillColor: DARKNESS_COLOR,\r\n        flags: {\r\n            type: 'darkness',\r\n            conceal,\r\n        },\r\n    })\r\n}\r\n\r\nexport function createMistTemplate({ type = 'burst', distance = 20 } = {}) {\r\n    createTemplate({\r\n        type,\r\n        distance,\r\n        fillColor: MIST_COLOR,\r\n        flags: {\r\n            type: 'mist',\r\n        },\r\n    })\r\n}\r\n\r\nfunction getTemplates(type, token) {\r\n    if (token && !checkScene(token)) return null\r\n    return canvas.scene.templates.filter(t => getFlag(t, 'type') === type) ?? []\r\n}\r\n\r\nexport function getDarknessTemplates(token) {\r\n    return getTemplates('darkness', token)\r\n}\r\n\r\nexport function getMistTemplates(token) {\r\n    return getTemplates('mist', token)\r\n}\r\n\r\nexport function getSeekTemplateTokens(token) {\r\n    if (!checkScene(token)) return null\r\n\r\n    const template = canvas.scene.templates.find(t => getFlag(t, 'type') === 'seek')\r\n    if (!template) return null\r\n\r\n    token = token instanceof Token ? token.document : token\r\n\r\n    return getTemplateTokens(template, { collisionType: 'sight', collisionOrigin: token.center })\r\n}\r\n\r\nexport async function deleteSeekTemplate(token) {\r\n    const templates = token.scene.templates.filter(t => getFlag(t, 'type') === 'seek' && getFlag(t, 'tokenId') === token.id)\r\n    for (const template of templates) {\r\n        await template.delete()\r\n    }\r\n}\r\n\r\nfunction checkScene(token) {\r\n    if (canvas.scene === token.scene) return true\r\n    ui.notifications.error(localize('template.scene'))\r\n    return false\r\n}\r\n\r\nexport function createTemplate({ type, distance, traits, fillColor, width, flags }) {\r\n    const templateData = {\r\n        distance,\r\n        t: templateConversion[type],\r\n        fillColor: fillColor || game.user.color,\r\n        flags: {\r\n            [MODULE_ID]: flags,\r\n        },\r\n    }\r\n\r\n    if (templateData.t === 'ray') {\r\n        templateData.width = width || CONFIG.MeasuredTemplate.defaults.width * (canvas.dimensions?.distance ?? 1)\r\n    } else if (templateData.t === 'cone') {\r\n        templateData.angle = CONFIG.MeasuredTemplate.defaults.angle\r\n    }\r\n\r\n    if (traits) setProperty(templateData, 'flags.pf2e.origin.traits', traits)\r\n\r\n    const templateDoc = new CONFIG.MeasuredTemplate.documentClass(templateData, { parent: canvas.scene })\r\n    new CONFIG.MeasuredTemplate.objectClass(templateDoc).drawPreview()\r\n}\r\n\r\n// TODO remove once it is in the system\r\nexport function getTemplateTokens(template, { collisionOrigin, collisionType = 'move' } = {}) {\r\n    template = template instanceof MeasuredTemplateDocument ? template.object : template\r\n\r\n    if (!canvas.scene) return []\r\n    const { grid, dimensions } = canvas\r\n    if (!(grid && dimensions)) return []\r\n\r\n    const gridHighlight = grid.getHighlightLayer(template.highlightId)\r\n    if (!gridHighlight || grid.type !== CONST.GRID_TYPES.SQUARE) return []\r\n    const origin = collisionOrigin ?? template.center\r\n\r\n    // Get all the tokens that are inside the highlight bounds\r\n    const tokens = canvas.tokens.quadtree.getObjects(gridHighlight.getLocalBounds(undefined, true))\r\n\r\n    const containedTokens = []\r\n    for (const token of tokens) {\r\n        const tokenDoc = token.document\r\n\r\n        // Collect the position of all grid squares that this token occupies as \"x.y\"\r\n        const tokenPositions = []\r\n        for (let h = 0; h < tokenDoc.height; h++) {\r\n            const y = token.y + h * grid.size\r\n            tokenPositions.push(`${token.x}.${y}`)\r\n            if (tokenDoc.width > 1) {\r\n                for (let w = 1; w < tokenDoc.width; w++) {\r\n                    tokenPositions.push(`${token.x + w * grid.size}.${y}`)\r\n                }\r\n            }\r\n        }\r\n\r\n        for (const position of tokenPositions) {\r\n            // Check if a position exists within this GridHiglight\r\n            if (!gridHighlight.positions.has(position)) {\r\n                continue\r\n            }\r\n            // Position of cell's top-left corner, in pixels\r\n            const [gx, gy] = position.split('.').map(s => Number(s))\r\n            // Position of cell's center in pixels\r\n            const destination = {\r\n                x: gx + dimensions.size * 0.5,\r\n                y: gy + dimensions.size * 0.5,\r\n            }\r\n            if (destination.x < 0 || destination.y < 0) continue\r\n\r\n            const hasCollision =\r\n                canvas.ready &&\r\n                collisionType &&\r\n                CONFIG.Canvas.polygonBackends[collisionType].testCollision(origin, destination, {\r\n                    type: collisionType,\r\n                    mode: 'any',\r\n                })\r\n\r\n            if (!hasCollision) {\r\n                containedTokens.push(token)\r\n                break\r\n            }\r\n        }\r\n    }\r\n    return containedTokens\r\n}\r\n\r\nexport function highlightTemplateGrid() {\r\n    if (!['circle', 'cone'].includes(this.type) || canvas.grid.type !== CONST.GRID_TYPES.SQUARE) {\r\n        return MeasuredTemplate.prototype.highlightGrid.call(this)\r\n    }\r\n\r\n    // Refrain from highlighting if not visible\r\n    if (!this.isVisible) {\r\n        canvas.grid.getHighlightLayer(this.highlightId)?.clear()\r\n        return\r\n    }\r\n\r\n    const collisionType = getFlag(this.document, 'collisionType')\r\n    const collisionOrigin = getFlag(this.document, 'collisionOrigin')\r\n\r\n    highlightGrid({\r\n        areaType: this.type === 'circle' ? 'burst' : 'cone',\r\n        object: this,\r\n        document: this.document,\r\n        colors: { border: this.borderColor, fill: this.fillColor },\r\n        preview: true,\r\n        collisionType,\r\n        collisionOrigin,\r\n    })\r\n}\r\n\r\nexport function preCreateMeasuredTemplate(template) {\r\n    const { type, slug, castLevel = 0 } = template.getFlag('pf2e', 'origin') ?? {}\r\n    if (type !== 'spell') return\r\n\r\n    if (DARKNESS_SLUGS.includes(slug)) {\r\n        template.updateSource({\r\n            fillColor: DARKNESS_COLOR,\r\n            [`flags.${MODULE_ID}`]: { type: 'darkness', conceal: castLevel >= 4 },\r\n        })\r\n    } else if (MIST_SLUGS.includes(slug)) {\r\n        template.updateSource({\r\n            fillColor: MIST_COLOR,\r\n            [`flags.${MODULE_ID}`]: { type: 'mist' },\r\n        })\r\n    } else if (slug === 'cloudkill') {\r\n        template.updateSource({\r\n            fillColor: POISON_GREEN,\r\n            [`flags.${MODULE_ID}`]: { type: 'mist' },\r\n        })\r\n    }\r\n}\r\n\r\nexport function onMeasuredTemplate(template) {\r\n    if (getFlag(template, 'type') === 'darkness') canvas.perception.update({ initializeVision: true })\r\n}\r\n", "import { getCoverEffect, hasGreaterDarkvision, isProne, seeInvisibility } from './actor.js'\r\nimport { PerceptionMenu } from './apps/perception.js'\r\nimport { COVERS, COVER_VALUES, ICONS_PATHS, VISIBILITY_VALUES, defaultValues } from './constants.js'\r\nimport { clearDebug, drawDebugLine, getRectEdges, lineIntersectWall, pointToTokenIntersectWall } from './geometry.js'\r\nimport { getLightExposure } from './lighting.js'\r\nimport { MODULE_ID, getFlag, getSetting, hasPermission, unsetFlag } from './module.js'\r\nimport { getPerception, updateFromPerceptionRules } from './rule-element.js'\r\nimport { getSceneSetting, getValidTokens } from './scene.js'\r\nimport { getDarknessTemplates, getMistTemplates, getTemplateTokens } from './template.js'\r\n\r\nexport function renderTokenHUD(hud, html) {\r\n    if (!hasPermission() || !hud.object.actor?.isOfType('creature')) return\r\n    html.find('.col.left').append(`<div class=\"control-icon\" data-action=\"pf2e-perception\"><i class=\"fa-solid fa-eye\"></i></div>`)\r\n    html.find('[data-action=pf2e-perception]').on('click', event => PerceptionMenu.openMenu({ token: hud.object }))\r\n}\r\n\r\nexport function pasteToken(originals, sources) {\r\n    for (const source of sources) {\r\n        delete source.flags?.[MODULE_ID]\r\n    }\r\n}\r\n\r\nexport function getTokenData(token, ...path) {\r\n    path.unshift('data')\r\n    token = token instanceof Token ? token.document : token\r\n    return getFlag(token, path.join('.'))\r\n}\r\n\r\nexport async function clearTokenData(token) {\r\n    token = token instanceof Token ? token.document : token\r\n    return unsetFlag(token, 'data')\r\n}\r\n\r\nexport async function setTokenData(token, data) {\r\n    const valid = getValidTokens(token).map(t => t.id)\r\n    const updates = {}\r\n\r\n    for (const tokenId in data) {\r\n        if (!valid.includes(tokenId)) {\r\n            updates[`flags.${MODULE_ID}.data.-=${tokenId}`] = true\r\n            continue\r\n        }\r\n\r\n        const current = data[tokenId]\r\n        const original = getTokenData(token, tokenId) ?? {}\r\n\r\n        if (current.visibility === defaultValues.visibility) delete current.visibility\r\n        if (current.cover === defaultValues.cover) delete current.cover\r\n\r\n        if (original.cover === current.cover && original.visibility === current.visibility) continue\r\n\r\n        if (!current.visibility && !current.cover) {\r\n            updates[`flags.${MODULE_ID}.data.-=${tokenId}`] = true\r\n        } else {\r\n            for (const property of ['cover', 'visibility']) {\r\n                if (original[property] === current[property]) continue\r\n                if (!current[property]) updates[`flags.${MODULE_ID}.data.${tokenId}.-=${property}`] = true\r\n                else updates[`flags.${MODULE_ID}.data.${tokenId}.${property}`] = current[property]\r\n            }\r\n        }\r\n    }\r\n\r\n    token = token instanceof Token ? token.document : token\r\n    return token.update(updates)\r\n}\r\n\r\nexport function getWallCover(origin, target, debug = false) {\r\n    const scene = origin.scene\r\n    if (!getSceneSetting(scene, 'standard')) return false\r\n\r\n    if (debug) clearDebug()\r\n\r\n    const standard = getSetting('standard-type')\r\n    const intersection = standard === 'points' ? pointToTokenIntersectWall : lineIntersectWall\r\n    const intersects = intersection(origin.center, target.center, debug)\r\n\r\n    return intersects ? 'standard' : undefined\r\n}\r\n\r\nconst SIZES = {\r\n    tiny: 0,\r\n    sm: 1,\r\n    med: 2,\r\n    lg: 3,\r\n    huge: 4,\r\n    grg: 5,\r\n}\r\n\r\nexport function getCover(origin, target, { perception = {}, options = [], affects = 'origin', debug = false } = {}) {\r\n    const prone = options.includes('item:ranged') ? isProne(target.actor) : false\r\n\r\n    const returnValue = value => {\r\n        return updateFromPerceptionRules(perception, affects, 'cover', value)\r\n    }\r\n\r\n    let systemCover = getCoverEffect(target.actor, true)\r\n    if (prone && COVER_VALUES[systemCover] > COVER_VALUES.lesser) return returnValue('greater-prone')\r\n\r\n    if (!prone && systemCover === 'greater-prone') systemCover = undefined\r\n\r\n    let cover = getTokenData(target, origin.id, 'cover')\r\n    if (prone && COVER_VALUES[cover] > COVER_VALUES.lesser) return returnValue('greater-prone')\r\n\r\n    if (!prone && cover === 'greater-prone') cover = undefined\r\n\r\n    if (COVER_VALUES[systemCover] < COVER_VALUES.standard) {\r\n        if (COVER_VALUES[cover] < COVER_VALUES.standard) {\r\n            const custom = game.modules.get(MODULE_ID).custom?.getWallCover\r\n\r\n            if (typeof custom === 'function') {\r\n                const customCover = custom(origin, target)\r\n\r\n                if (COVERS.includes(customCover)) cover = customCover\r\n                else cover = getWallCover(origin, target, debug)\r\n            } else {\r\n                cover = getWallCover(origin, target, debug)\r\n            }\r\n        }\r\n\r\n        if (COVER_VALUES[cover] < COVER_VALUES.standard && origin.distanceTo(target) > 5)\r\n            cover = getCreatureCover(origin, target, { perception, debug })\r\n    }\r\n\r\n    if (prone && COVER_VALUES[cover] > COVER_VALUES.lesser) return returnValue('greater-prone')\r\n    return returnValue(COVER_VALUES[cover] > COVER_VALUES[systemCover] ? cover : undefined)\r\n}\r\n\r\nexport function getCreatureCover(originToken, targetToken, { perception = {}, debug = false } = {}) {\r\n    const setting = getSetting('lesser')\r\n    if (setting === 'none') return undefined\r\n\r\n    originToken = originToken instanceof Token ? originToken.document : originToken\r\n    targetToken = targetToken instanceof Token ? targetToken.document : targetToken\r\n\r\n    const ignoreIds = (() => {\r\n        const originIds = Object.keys(perception.origin?.cover?.ignore ?? {})\r\n        const targetIds = Object.keys(perception.target?.cover?.ignore ?? {})\r\n        return new Set([...originIds, ...targetIds])\r\n    })()\r\n\r\n    let cover = undefined\r\n    const origin = originToken.center\r\n    const target = targetToken.center\r\n\r\n    if (debug) {\r\n        clearDebug()\r\n        drawDebugLine(origin, target)\r\n    }\r\n\r\n    const isExtraLarge = token => {\r\n        const size = SIZES[token.actor.size]\r\n        return size - originSize >= 2 && size - targetSize >= 2\r\n    }\r\n\r\n    const originSize = SIZES[originToken.actor.size]\r\n    const targetSize = SIZES[targetToken.actor.size]\r\n\r\n    const tokens = originToken.scene.tokens.contents\r\n        .filter(t => t.actor && !t.hidden && t !== originToken && t !== targetToken && !ignoreIds.has(t.id))\r\n        .sort((a, b) => SIZES[b.actor.size] - SIZES[a.actor.size])\r\n\r\n    let extralarges = originSize < SIZES.huge && targetSize < SIZES.huge && tokens.filter(isExtraLarge).length\r\n\r\n    const margin = setting === 'ten' ? 0.1 : setting === 'twenty' ? 0.2 : 0\r\n\r\n    const intersectsEdge = edge => {\r\n        if (debug) drawDebugLine(edge.A, edge.B, 'red')\r\n        return lineSegmentIntersects(origin, target, edge.A, edge.B)\r\n    }\r\n\r\n    const intersectsWith =\r\n        setting === 'cross'\r\n            ? edges => {\r\n                  return (\r\n                      (intersectsEdge(edges.top) && intersectsEdge(edges.bottom)) ||\r\n                      (intersectsEdge(edges.left) && intersectsEdge(edges.right))\r\n                  )\r\n              }\r\n            : edges => Object.values(edges).some(edge => intersectsEdge(edge))\r\n\r\n    for (const tokenDocument of tokens) {\r\n        const token = tokenDocument.object\r\n        const edges = getRectEdges(token.bounds, margin)\r\n        if (intersectsWith(edges)) return extralarges ? 'standard' : 'lesser'\r\n        else if (isExtraLarge(tokenDocument)) extralarges--\r\n    }\r\n\r\n    return cover\r\n}\r\n\r\nexport function getVisibility(origin, target, { perception = {}, affects = 'origin', debug = false } = {}) {\r\n    origin = origin instanceof Token ? origin : origin.object\r\n    target = target instanceof Token ? target : target.object\r\n\r\n    const originActor = origin.actor\r\n    const targetActor = target.actor\r\n\r\n    let systemVisibility = (() => {\r\n        if (!originActor) return\r\n        for (const visibility of ['unnoticed', 'undetected', 'hidden', 'concealed']) {\r\n            if (originActor.hasCondition(visibility)) return visibility\r\n        }\r\n    })()\r\n\r\n    const returnValue = value => {\r\n        if (!isInvisible) return updateFromPerceptionRules(perception, affects, 'visibility', value)\r\n\r\n        if (VISIBILITY_VALUES[value] < VISIBILITY_VALUES.hidden) value = 'hidden'\r\n\r\n        const seeInvis = seeInvisibility(targetActor) || getPerception(perception, affects, 'visibility', 'noinvis')\r\n        if (seeInvis) value = 'concealed'\r\n\r\n        return updateFromPerceptionRules(perception, affects, 'visibility', value)\r\n    }\r\n\r\n    const isInvisible = originActor?.hasCondition('invisible')\r\n    const visibility = getTokenData(origin, target.id, 'visibility')\r\n    let mergedVisibility = VISIBILITY_VALUES[systemVisibility] > VISIBILITY_VALUES[visibility] ? systemVisibility : visibility\r\n\r\n    if (VISIBILITY_VALUES[mergedVisibility] >= VISIBILITY_VALUES.hidden || isInvisible) return returnValue(mergedVisibility)\r\n\r\n    const targetLowlight = targetActor?.hasLowLightVision\r\n    const targetDarkvision = targetActor?.hasDarkvision\r\n    const targetGreaterDarkvision = targetActor && hasGreaterDarkvision(targetActor)\r\n    if (targetGreaterDarkvision && mergedVisibility === 'concealed') return returnValue(mergedVisibility)\r\n\r\n    let inDarkness\r\n    if (!targetGreaterDarkvision) {\r\n        const darknessTemplates = getDarknessTemplates(origin)\r\n        if (darknessTemplates?.length) {\r\n            let darknessVisibility\r\n\r\n            for (const template of darknessTemplates) {\r\n                const darknessTokens = getTemplateTokens(template)\r\n                if (!darknessTokens.length) continue\r\n\r\n                const inTemplate = darknessTokens.includes(origin) || darknessTokens.includes(target)\r\n                if (inTemplate) inDarkness = true\r\n                else continue\r\n\r\n                if (!targetDarkvision) return returnValue('hidden')\r\n\r\n                const templateConceals = getFlag(template, 'conceal')\r\n                if (templateConceals) darknessVisibility = 'concealed'\r\n            }\r\n\r\n            if (darknessVisibility === 'concealed') mergedVisibility = 'concealed'\r\n            if (inDarkness && mergedVisibility === 'concealed') return returnValue(mergedVisibility)\r\n        }\r\n    }\r\n\r\n    if (mergedVisibility !== 'concealed') {\r\n        const mistTemplates = getMistTemplates(origin)\r\n        if (mistTemplates?.length) {\r\n            for (const template of mistTemplates) {\r\n                const mistTokens = getTemplateTokens(template)\r\n                if (!mistTokens.length) continue\r\n\r\n                const inTemplate = mistTokens.includes(origin) || mistTokens.includes(target)\r\n                if (inTemplate) return returnValue('concealed')\r\n            }\r\n        }\r\n    }\r\n\r\n    if (inDarkness || targetGreaterDarkvision) return returnValue(mergedVisibility)\r\n\r\n    const exposure = getLightExposure(origin, debug)\r\n    let exposedVisibility = exposure === 'dim' ? 'concealed' : exposure === null ? 'hidden' : undefined\r\n    if (exposedVisibility === 'concealed' && targetLowlight) exposedVisibility = undefined\r\n    else if (exposedVisibility === 'hidden' && targetDarkvision) exposedVisibility = undefined\r\n\r\n    if (VISIBILITY_VALUES[exposedVisibility] > VISIBILITY_VALUES[mergedVisibility]) mergedVisibility = exposedVisibility\r\n    return returnValue(mergedVisibility)\r\n}\r\n\r\nexport function updateToken(token, data, context, userId) {\r\n    const flags = data.flags?.['pf2e-perception']\r\n\r\n    if (flags && (flags.data || flags['-=data'] !== undefined)) {\r\n        token.object.renderFlags.set({ refreshVisibility: true })\r\n\r\n        if (game.user.isGM) return\r\n\r\n        const hk = Hooks.on('refreshToken', refreshed => {\r\n            if (!token.object === refreshed) return\r\n            Hooks.off('refreshToken', hk)\r\n            if (game.combat?.getCombatantByToken(token.id)) ui.combat.render()\r\n        })\r\n    }\r\n}\r\n\r\nexport function hoverToken(token, hovered) {\r\n    if (hovered) showAllConditionals(token)\r\n    else clearConditionals(token)\r\n}\r\n\r\nexport function deleteToken(token) {\r\n    clearConditionals(token)\r\n    if (!game.user.isGM) ui.combat.render()\r\n}\r\n\r\nexport function controlToken(token, controlled) {\r\n    if (!controlled) return\r\n    clearConditionals()\r\n    Hooks.once('sightRefresh', () => token.hover && showAllConditionals(token))\r\n}\r\n\r\nexport function clearConditionals(token) {\r\n    const tokenId = token?.id\r\n    if (!tokenId) return $('.pf2e-conditionals').remove()\r\n    $(`.pf2e-conditionals[data-hover-id=${token.id}]`).remove()\r\n    $(`.pf2e-conditionals[data-token-id=${token.id}]`).remove()\r\n}\r\n\r\nexport function showAllConditionals(token) {\r\n    const tokens = getValidTokens(token)\r\n    for (const target of tokens) {\r\n        showConditionals(target, token)\r\n    }\r\n}\r\n\r\nexport async function showConditionals(origin, target) {\r\n    origin = origin instanceof Token ? origin : origin.object\r\n    if (!origin.visible || !origin.actor?.isOfType('creature')) return\r\n\r\n    let data = getTokenData(origin, target.id)\r\n    if (isEmpty(data)) return\r\n\r\n    if (!game.user.isGM && !target.document.hasPlayerOwner && VISIBILITY_VALUES[data.visibility] >= VISIBILITY_VALUES.hidden) {\r\n        if (!data.cover) return\r\n        data = { cover: data.cover }\r\n    }\r\n\r\n    const scale = origin.worldTransform.a\r\n    const coords = canvas.clientCoordinatesFromCanvas(origin.document._source)\r\n\r\n    let content = `<div class=\"pf2e-conditionals\" data-hover-id=\"${origin.id}\" data-token-id=\"${target.id}\" `\r\n    content += `style=\"top: ${coords.y}px; left: ${coords.x + (origin.hitArea.width * scale) / 2}px;\">`\r\n\r\n    const savedPaths = getSetting('icon-path')\r\n    Object.entries(data).map(([property, value]) => {\r\n        const icon = property === 'cover' ? 'cover' : value\r\n        let path = savedPaths[icon] || ICONS_PATHS[icon]\r\n        if (path.startsWith('systems') || path.startsWith('modules')) path = `../../../${path}`\r\n        content += `<div class=\"conditional\"><img src=\"${path}\"></img></div>`\r\n    })\r\n\r\n    content += '</div>'\r\n\r\n    $(document.body).append(content)\r\n}\r\n\r\nexport function rulesBasedVision() {\r\n    return !!(this.sight.enabled && this.actor?.isOfType('creature') && this.scene?.rulesBasedVision)\r\n}\r\n\r\nexport function preCreateToken(token) {\r\n    if (!getSceneSetting(token.scene, 'npc-vision')) return\r\n    if (!token.actor?.isOfType('npc')) return\r\n    token.updateSource({ 'sight.enabled': true })\r\n}\r\n", "import { COVER_UUID, COVER_VALUES, VISIBILITY_VALUES, VISION_LEVELS } from './constants.js'\r\nimport { createCoverSource, createFlatFootedSource, findChoiceSetRule } from './effect.js'\r\nimport { extractEphemeralEffects, getRangeIncrement, isOffGuardFromFlanking, traitSlugToObject } from './pf2e/helpers.js'\r\nimport { getPerception, perceptionRules } from './rule-element.js'\r\nimport { getCover, getVisibility } from './token.js'\r\nimport { asNumberOnly } from './utils.js'\r\n\r\nexport async function getRollContext(params) {\r\n    const [selfToken, targetToken] =\r\n        canvas.ready && !params.viewOnly\r\n            ? [\r\n                  canvas.tokens.controlled.find(t => t.actor === this) ?? this.getActiveTokens().shift() ?? null,\r\n                  params.target?.token ?? params.target?.actor?.getActiveTokens().shift() ?? null,\r\n              ]\r\n            : [null, null]\r\n\r\n    const selfOptions = this.getRollOptions(params.domains ?? [])\r\n\r\n    // Get ephemeral effects from the target that affect this actor while attacking\r\n    const originEphemeralEffects = await extractEphemeralEffects({\r\n        affects: 'origin',\r\n        origin: this,\r\n        target: params.target?.actor ?? targetToken?.actor ?? null,\r\n        item: params.item ?? null,\r\n        domains: params.domains,\r\n        options: [...params.options, ...(params.item?.getRollOptions('item') ?? [])],\r\n    })\r\n\r\n    const selfActor =\r\n        params.viewOnly || !targetToken?.actor\r\n            ? this\r\n            : this.getContextualClone([...selfOptions, ...targetToken.actor.getSelfRollOptions('target')], originEphemeralEffects)\r\n\r\n    const isStrike = params.statistic instanceof game.pf2e.StatisticModifier\r\n    const strikeActions = isStrike ? selfActor.system.actions?.flatMap(a => [a, a.altUsages ?? []].flat()) ?? [] : []\r\n\r\n    const statistic = params.viewOnly\r\n        ? params.statistic\r\n        : isStrike\r\n        ? strikeActions.find(action => {\r\n              // Find the matching weapon or melee item\r\n              if (params.item?.id !== action.item.id || params?.item.name !== action.item.name) return false\r\n              if (params.item.isOfType('melee') && action.item.isOfType('melee')) return true\r\n\r\n              // Discriminate between melee/thrown usages by checking that both are either melee or ranged\r\n              return (\r\n                  params.item.isOfType('weapon') && action.item.isOfType('weapon') && params.item.isMelee === action.item.isMelee\r\n              )\r\n          }) ?? params.statistic\r\n        : params.statistic\r\n\r\n    const selfItem = (() => {\r\n        // 1. Simplest case: no context clone, so used the item passed to this method\r\n        if (selfActor === this) return params.item ?? null\r\n\r\n        // 2. Get the item from the statistic if it's stored therein\r\n        if (\r\n            statistic &&\r\n            'item' in statistic &&\r\n            statistic.item instanceof Item &&\r\n            statistic.item.isOfType('melee', 'spell', 'weapon')\r\n        ) {\r\n            return statistic.item\r\n        }\r\n\r\n        // 3. Get the item directly from the context clone\r\n        const itemClone = selfActor.items.get(params.item?.id ?? '')\r\n        if (itemClone?.isOfType('melee', 'spell', 'weapon')) return itemClone\r\n\r\n        // 4 Give up :(\r\n        return params.item ?? null\r\n    })()\r\n\r\n    const itemOptions = selfItem?.getRollOptions('item') ?? []\r\n    const isAttackAction = ['attack', 'strike-damage', 'attack-spell-damage'].some(d => params.domains.includes(d))\r\n\r\n    const traitSlugs = [\r\n        isAttackAction ? 'attack' : [],\r\n        // CRB p. 544: \"Due to the complexity involved in preparing bombs, Strikes to throw alchemical bombs gain\r\n        // the manipulate trait.\"\r\n        isStrike && selfItem?.isOfType('weapon') && selfItem.baseType === 'alchemical-bomb' ? 'manipulate' : [],\r\n    ].flat()\r\n\r\n    if (selfItem?.isOfType('weapon', 'melee')) {\r\n        for (const adjustment of this.synthetics.strikeAdjustments) {\r\n            adjustment.adjustTraits?.(selfItem, traitSlugs)\r\n        }\r\n    }\r\n\r\n    const traits = traitSlugs.map(t => traitSlugToObject(t, CONFIG.PF2E.actionTraits))\r\n    // Calculate distance and range increment, set as a roll option\r\n    const distance = selfToken && targetToken ? selfToken.distanceTo(targetToken) : null\r\n    const [originDistance, targetDistance] =\r\n        typeof distance === 'number' ? [`origin:distance:${distance}`, `target:distance:${distance}`] : [null, null]\r\n\r\n    // Target roll options\r\n    const getTargetRollOptions = actor => {\r\n        const targetOptions = actor?.getSelfRollOptions('target') ?? []\r\n        if (targetToken) {\r\n            targetOptions.push('target') // An indicator that there is a target of any kind\r\n            const mark = this.synthetics.targetMarks.get(targetToken.document.uuid)\r\n            if (mark) targetOptions.push(`target:mark:${mark}`)\r\n        }\r\n        return targetOptions\r\n    }\r\n    const targetRollOptions = getTargetRollOptions(targetToken?.actor)\r\n\r\n    // Get ephemeral effects from this actor that affect the target while being attacked\r\n    const targetEphemeralEffects = await extractEphemeralEffects({\r\n        affects: 'target',\r\n        origin: selfActor,\r\n        target: targetToken?.actor ?? null,\r\n        item: selfItem,\r\n        domains: params.domains,\r\n        options: [...params.options, ...itemOptions, ...targetRollOptions],\r\n    })\r\n\r\n    const [reach, isMelee] = params.item?.isOfType('melee')\r\n        ? [params.item.reach, params.item.isMelee]\r\n        : params.item?.isOfType('weapon')\r\n        ? [this.getReach({ action: 'attack', weapon: params.item }), params.item.isMelee]\r\n        : [null, false]\r\n\r\n    /**\r\n     * WE ADDED STUFF HERE\r\n     */\r\n    if (selfToken?.actor && targetToken?.actor && !params.viewOnly) {\r\n        const perception = perceptionRules(selfToken, targetToken, {\r\n            extraOptions: itemOptions,\r\n            distance,\r\n        })\r\n\r\n        let visibility = getVisibility(selfToken, targetToken, { perception, affects: 'origin' })\r\n\r\n        if (visibility && getPerception(perception, 'target', 'visibility', 'noff', visibility)) {\r\n            visibility = undefined\r\n        }\r\n\r\n        if (VISIBILITY_VALUES[visibility] > VISIBILITY_VALUES.concealed)\r\n            targetEphemeralEffects.push(createFlatFootedSource(visibility))\r\n\r\n        let cover = getCover(selfToken, targetToken, { perception, affects: 'target', options: itemOptions })\r\n        let coverBonus = undefined\r\n\r\n        if (cover) {\r\n            let ac = asNumberOnly(getPerception(perception, 'target', 'cover', 'ac', cover)?.first())\r\n            if (ac === 0) cover = undefined\r\n            else if (ac) coverBonus = ac\r\n        }\r\n\r\n        if (COVER_VALUES[cover] > COVER_VALUES.none) targetEphemeralEffects.push(createCoverSource(cover, coverBonus))\r\n    }\r\n    /**\r\n     * END OF THE ADDED STUFF\r\n     */\r\n\r\n    // Add an epehemeral effect from flanking\r\n    const isFlankingStrike = !!(\r\n        isMelee &&\r\n        typeof reach === 'number' &&\r\n        params.statistic instanceof game.pf2e.StatisticModifier &&\r\n        targetToken?.actor &&\r\n        selfToken?.isFlanking(targetToken, { reach })\r\n    )\r\n    if (isFlankingStrike && isOffGuardFromFlanking(targetToken.actor, selfActor)) {\r\n        const name = game.i18n.localize('PF2E.Item.Condition.Flanked')\r\n        const condition = game.pf2e.ConditionManager.getCondition('off-guard', { name })\r\n        targetEphemeralEffects.push(condition.toObject())\r\n    }\r\n\r\n    // Clone the actor to recalculate its AC with contextual roll options\r\n    const targetActor = params.viewOnly\r\n        ? null\r\n        : (params.target?.actor ?? targetToken?.actor)?.getContextualClone(\r\n              [...selfActor.getSelfRollOptions('origin'), ...itemOptions, ...(originDistance ? [originDistance] : [])],\r\n              targetEphemeralEffects\r\n          ) ?? null\r\n\r\n    const rollOptions = new Set([\r\n        ...params.options,\r\n        ...selfOptions,\r\n        ...(targetActor ? getTargetRollOptions(targetActor) : targetRollOptions),\r\n        ...itemOptions,\r\n        // Backward compatibility for predication looking for an \"attack\" trait by its lonesome\r\n        'attack',\r\n    ])\r\n\r\n    if (targetDistance) rollOptions.add(targetDistance)\r\n    const rangeIncrement = selfItem ? getRangeIncrement(selfItem, distance) : null\r\n    if (rangeIncrement) rollOptions.add(`target:range-increment:${rangeIncrement}`)\r\n\r\n    const self = {\r\n        actor: selfActor,\r\n        token: selfToken?.document ?? null,\r\n        statistic,\r\n        item: selfItem,\r\n        modifiers: [],\r\n    }\r\n\r\n    const target =\r\n        targetActor && targetToken && distance !== null\r\n            ? { actor: targetActor, token: targetToken.document, distance, rangeIncrement }\r\n            : null\r\n\r\n    return {\r\n        options: rollOptions,\r\n        self,\r\n        target,\r\n        traits,\r\n    }\r\n}\r\n\r\nexport function getActorToken(actor, target = false) {\r\n    if (!actor) return undefined\r\n    const actorId = actor.id\r\n    const isToken = actor.isToken\r\n    const tokens = target ? game.user.targets : canvas.tokens.controlled\r\n    return (\r\n        tokens.find(token => (isToken ? token.actor === actor : token.actor.id === actorId)) ??\r\n        actor.getActiveTokens().shift() ??\r\n        null\r\n    )\r\n}\r\n\r\nexport function isProne(actor) {\r\n    return actor.itemTypes.condition.some(item => item.slug === 'prone')\r\n}\r\n\r\nexport function getCoverEffect(actor, selection = false) {\r\n    const effect = actor.itemTypes.effect.find(x => x.sourceId === COVER_UUID)\r\n    return selection ? findChoiceSetRule(effect)?.selection.level : effect\r\n}\r\n\r\nexport function getFeatWithUUID(actor, uuid) {\r\n    return actor.itemTypes.feat.find(f => f.sourceId === uuid)\r\n}\r\n\r\nexport function visionLevel() {\r\n    const sensesStr = this.system.traits.senses.value\r\n    const senses = splitNPCSenses(sensesStr)\r\n\r\n    const sensesRules = this.rules.filter(r => r.key === 'Sense').map(r => r.selector.toLowerCase())\r\n    senses.push(...sensesRules)\r\n\r\n    return this.getCondition('blinded')\r\n        ? VISION_LEVELS.BLINDED\r\n        : senses.includes('darkvision') || senses.includes('greaterdarkvision')\r\n        ? VISION_LEVELS.DARKVISION\r\n        : senses.includes('lowlightvision')\r\n        ? VISION_LEVELS.LOWLIGHT\r\n        : VISION_LEVELS.NORMAL\r\n}\r\n\r\nfunction hasSense(actor, sense) {\r\n    if (!actor || !sense || !actor.system.traits?.senses) return false\r\n\r\n    sense = sense.toLowerCase()\r\n\r\n    let senses = actor.system.traits.senses\r\n    if (Array.isArray(senses)) senses = senses.map(s => s.type.toLowerCase())\r\n    else senses = splitNPCSenses(senses.value)\r\n\r\n    return senses.includes(sense)\r\n}\r\n\r\nexport function hasGreaterDarkvision(actor) {\r\n    return hasSense(actor, 'greaterdarkvision')\r\n}\r\n\r\nexport function seeInvisibility(actor) {\r\n    return hasSense(actor, 'seeinvisibility')\r\n}\r\n\r\nfunction splitNPCSenses(sensesStr) {\r\n    return sensesStr.toLowerCase().replaceAll(/[ -]/g, '').split(',')\r\n}\r\n", "const DEGREE_ADJUSTMENT_AMOUNTS = {\r\n    LOWER_BY_TWO: -2,\r\n    LOWER: -1,\r\n    INCREASE: 1,\r\n    INCREASE_BY_TWO: 2,\r\n    TO_CRITICAL_FAILURE: 'criticalFailure',\r\n    TO_FAILURE: 'failure',\r\n    TO_SUCCESS: 'success',\r\n    TO_CRITICAL_SUCCESS: 'criticalSuccess',\r\n}\r\n\r\nconst DEGREE_OF_SUCCESS_STRINGS = ['criticalFailure', 'failure', 'success', 'criticalSuccess']\r\n\r\nexport class DegreeOfSuccess {\r\n    constructor(roll, dc, dosAdjustments = null) {\r\n        if (roll instanceof Roll) {\r\n            this.dieResult =\r\n                (roll.isDeterministic\r\n                    ? roll.terms.find(t => t instanceof NumericTerm)\r\n                    : roll.dice.find(d => d instanceof Die && d.faces === 20)\r\n                )?.total ?? 1\r\n            this.rollTotal = roll.total\r\n        } else {\r\n            this.dieResult = roll.dieValue\r\n            this.rollTotal = roll.dieValue + roll.modifier\r\n        }\r\n\r\n        this.dc = typeof dc === 'number' ? { value: dc } : dc\r\n\r\n        this.unadjusted = this.#calculateDegreeOfSuccess()\r\n        this.adjustment = this.#getDegreeAdjustment(this.unadjusted, dosAdjustments)\r\n        this.value = this.adjustment ? this.#adjustDegreeOfSuccess(this.adjustment.amount, this.unadjusted) : this.unadjusted\r\n    }\r\n\r\n    static CRITICAL_FAILURE = 0\r\n    static FAILURE = 1\r\n    static SUCCESS = 2\r\n    static CRITICAL_SUCCESS = 3\r\n\r\n    #getDegreeAdjustment(degree, adjustments) {\r\n        if (!adjustments) return null\r\n\r\n        for (const outcome of ['all', ...DEGREE_OF_SUCCESS_STRINGS]) {\r\n            const { label, amount } = adjustments[outcome] ?? {}\r\n            if (\r\n                amount &&\r\n                label &&\r\n                !(degree === DegreeOfSuccess.CRITICAL_SUCCESS && amount === DEGREE_ADJUSTMENT_AMOUNTS.INCREASE) &&\r\n                !(degree === DegreeOfSuccess.CRITICAL_FAILURE && amount === DEGREE_ADJUSTMENT_AMOUNTS.LOWER) &&\r\n                (outcome === 'all' || DEGREE_OF_SUCCESS_STRINGS.indexOf(outcome) === degree)\r\n            ) {\r\n                return { label, amount }\r\n            }\r\n        }\r\n\r\n        return null\r\n    }\r\n\r\n    #adjustDegreeOfSuccess(amount, degreeOfSuccess) {\r\n        switch (amount) {\r\n            case 'criticalFailure':\r\n                return 0\r\n            case 'failure':\r\n                return 1\r\n            case 'success':\r\n                return 2\r\n            case 'criticalSuccess':\r\n                return 3\r\n            default:\r\n                return Math.clamped(degreeOfSuccess + amount, 0, 3)\r\n        }\r\n    }\r\n\r\n    /**\r\n     * @param degree The current success value\r\n     * @return The new success value\r\n     */\r\n    #adjustDegreeByDieValue(degree) {\r\n        if (this.dieResult === 20) {\r\n            return this.#adjustDegreeOfSuccess(DEGREE_ADJUSTMENT_AMOUNTS.INCREASE, degree)\r\n        } else if (this.dieResult === 1) {\r\n            return this.#adjustDegreeOfSuccess(DEGREE_ADJUSTMENT_AMOUNTS.LOWER, degree)\r\n        }\r\n\r\n        return degree\r\n    }\r\n\r\n    #calculateDegreeOfSuccess() {\r\n        const dc = this.dc.value\r\n\r\n        if (this.rollTotal - dc >= 10) {\r\n            return this.#adjustDegreeByDieValue(DegreeOfSuccess.CRITICAL_SUCCESS)\r\n        } else if (dc - this.rollTotal >= 10) {\r\n            return this.#adjustDegreeByDieValue(DegreeOfSuccess.CRITICAL_FAILURE)\r\n        } else if (this.rollTotal >= dc) {\r\n            return this.#adjustDegreeByDieValue(DegreeOfSuccess.SUCCESS)\r\n        }\r\n\r\n        return this.#adjustDegreeByDieValue(DegreeOfSuccess.FAILURE)\r\n    }\r\n}\r\n", "import { validateMessage } from '../chat.js'\r\nimport { COVERS, VISIBILITIES, VISIBILITY_VALUES, defaultValues } from '../constants.js'\r\nimport { MODULE_ID, getSetting, localize, templatePath } from '../module.js'\r\nimport { DegreeOfSuccess } from '../pf2e/success.js'\r\nimport { getValidTokens } from '../scene.js'\r\nimport { deleteSeekTemplate } from '../template.js'\r\nimport { getTokenData } from '../token.js'\r\nimport { BaseMenu } from './base-menu.js'\r\n\r\nclass ValidationMenu extends BaseMenu {\r\n    static async openMenu(params, options) {\r\n        const validated = await super.openMenu(params, options)\r\n        if (validated && params.message) validateMessage(params.message)\r\n        return validated\r\n    }\r\n\r\n    get title() {\r\n        return localize('menu.validation.title', { name: this.token.name })\r\n    }\r\n\r\n    get template() {\r\n        return templatePath('validation')\r\n    }\r\n\r\n    get selected() {\r\n        const selected = super.selected\r\n        if (selected.length) return selected\r\n        return this.globalSelection\r\n    }\r\n\r\n    get globalSelection() {\r\n        const token = this.token\r\n        const alliance = token.actor.alliance\r\n        return getValidTokens(token)\r\n            .filter(t => t.actor.alliance !== alliance)\r\n            .map(t => t.id)\r\n    }\r\n\r\n    getSavedData(converted = true) {\r\n        const data = super.getSavedData()\r\n        return converted ? this._convertData(data) : data\r\n    }\r\n\r\n    _convertData(data) {\r\n        const property = this.property\r\n        const scene = this.scene\r\n        const selected = this.selected\r\n        const defaultValue = defaultValues[property]\r\n        const propertyList = property === 'cover' ? COVERS : VISIBILITIES\r\n\r\n        for (const tokenId of selected) {\r\n            const token = scene.tokens.get(tokenId)\r\n            const fullProperty = `${tokenId}.${property}`\r\n            const currentValue = getProperty(data, fullProperty) ?? defaultValue\r\n\r\n            let processedValue = this.processValue({ token, value: currentValue })\r\n            if (!propertyList.includes(processedValue)) processedValue = currentValue\r\n\r\n            if (currentValue === processedValue) continue\r\n            setProperty(data, fullProperty, processedValue)\r\n        }\r\n\r\n        return data\r\n    }\r\n\r\n    processValue(params) {\r\n        throw new Error(`${this.constructor.name} doesn't have a 'processValue' method defined`)\r\n    }\r\n\r\n    getData(options) {\r\n        const { covers, visibilities, i18n } = super.getData(options)\r\n        const currentData = this.currentData\r\n        const originalData = this.getSavedData(false)\r\n        const property = this.property\r\n\r\n        let selected = this.selected\r\n        let tokens = getValidTokens(this.token)\r\n\r\n        tokens = tokens.map(({ id, name, actor }) => {\r\n            const current = currentData[id] ?? {}\r\n            const original = originalData[id] ?? {}\r\n\r\n            return {\r\n                id,\r\n                name,\r\n                alliance: actor.alliance,\r\n                selected: selected.includes(id),\r\n                ...BaseMenu.createPropertyData(original, current, property),\r\n            }\r\n        })\r\n\r\n        const validation = getSetting('validation')\r\n        if (validation === 'selected') tokens = tokens.filter(t => t.selected)\r\n        else if (validation === 'changed') tokens = tokens.filter(t => t.changed)\r\n\r\n        return {\r\n            ...this._spliIntoAlliances(tokens),\r\n            i18n,\r\n            property: property,\r\n            options: property === 'cover' ? covers : visibilities,\r\n            showSelected: selected.length !== tokens.length && validation === 'all',\r\n            showChanges: validation !== 'changed',\r\n        }\r\n    }\r\n\r\n    activateListeners(html) {\r\n        super.activateListeners(html)\r\n\r\n        html.find('[data-action=cancel]').on('click', event => {\r\n            this.close()\r\n        })\r\n    }\r\n}\r\n\r\nexport class CoverValidationMenu extends ValidationMenu {\r\n    #value\r\n\r\n    constructor(params, options = {}) {\r\n        super(params, options)\r\n        this.#value = params.value\r\n    }\r\n\r\n    get property() {\r\n        return 'cover'\r\n    }\r\n\r\n    processValue() {\r\n        return this.#value\r\n    }\r\n}\r\n\r\nclass VisibilityValidationMenu extends ValidationMenu {\r\n    #roll\r\n\r\n    constructor(params, options = {}) {\r\n        super(params, options)\r\n        this.#roll = params.roll\r\n    }\r\n\r\n    get property() {\r\n        return 'visibility'\r\n    }\r\n\r\n    get roll() {\r\n        return this.#roll\r\n    }\r\n}\r\n\r\nexport class HideValidationMenu extends VisibilityValidationMenu {\r\n    processValue({ token, value }) {\r\n        const roll = this.roll\r\n        const dc = token.actor.perception.dc.value\r\n        const visibility = VISIBILITY_VALUES[value]\r\n        const success = new DegreeOfSuccess(roll, dc).value\r\n\r\n        if (success >= DegreeOfSuccess.SUCCESS && visibility < VISIBILITY_VALUES.hidden) return 'hidden'\r\n        else if (success <= DegreeOfSuccess.FAILURE && visibility >= VISIBILITY_VALUES.hidden) return 'observed'\r\n        else return value\r\n    }\r\n}\r\n\r\nexport class UnHideValidationMenu extends VisibilityValidationMenu {\r\n    get selected() {\r\n        return getValidTokens(this.token).map(t => t.id)\r\n    }\r\n\r\n    processValue({ token, value }) {\r\n        const visibility = VISIBILITY_VALUES[value]\r\n        if (visibility >= VISIBILITY_VALUES.hidden) return 'observed'\r\n        else return value\r\n    }\r\n}\r\n\r\nexport class PointOutValidationMenu extends VisibilityValidationMenu {\r\n    #originator\r\n\r\n    constructor(params, options = {}) {\r\n        super(params, options)\r\n        this.#originator = params.originator\r\n    }\r\n\r\n    get selected() {\r\n        const token = this.token\r\n        const alliance = token.actor.alliance\r\n        const originatorId = this.#originator.id\r\n        const data = getTokenData(token) ?? {}\r\n\r\n        return getValidTokens(token)\r\n            .filter(t => {\r\n                if (t.id === originatorId || t.actor.alliance === alliance) return false\r\n                const visibility = getProperty(data, `${t.id}.visibility`)\r\n                return VISIBILITY_VALUES[visibility] >= VISIBILITY_VALUES.undetected\r\n            })\r\n            .map(t => t.id)\r\n    }\r\n\r\n    processValue({ token, value }) {\r\n        return VISIBILITY_VALUES[value] >= VISIBILITY_VALUES.undetected ? 'hidden' : value\r\n    }\r\n}\r\n\r\nclass ReverseVisibilityValidationMenu extends VisibilityValidationMenu {\r\n    getSavedData(converted = true) {\r\n        const thisId = this.token.id\r\n        const tokens = getValidTokens(this.token)\r\n        const data = {}\r\n\r\n        for (const token of tokens) {\r\n            const tokenData = getTokenData(token, thisId)\r\n            if (tokenData) data[token.id] = deepClone(tokenData)\r\n        }\r\n\r\n        return converted ? this._convertData(data) : data\r\n    }\r\n\r\n    getData() {\r\n        const parentData = super.getData()\r\n        parentData.isReversed = true\r\n        parentData.options = VISIBILITIES.map(value => ({ value, label: localize(`visibility.reversed.${value}`) }))\r\n        return parentData\r\n    }\r\n\r\n    _saveData(currentData) {\r\n        const scene = this.scene\r\n        const thisId = this.token.id\r\n        const updates = []\r\n\r\n        for (const [tokenId, data] of Object.entries(currentData)) {\r\n            let update = { _id: tokenId }\r\n            const token = scene.tokens.get(tokenId)\r\n\r\n            if (token) {\r\n                if (data.visibility === defaultValues.visibility) delete data.visibility\r\n\r\n                const original = getTokenData(token, thisId) ?? {}\r\n                if (original?.visibility === data.visibility) continue\r\n\r\n                if (!original.cover && !data.visibility) {\r\n                    update[`flags.${MODULE_ID}.data.-=${thisId}`] = true\r\n                } else if (!data.visibility) {\r\n                    update[`flags.${MODULE_ID}.data.${thisId}.-=visibility`] = true\r\n                } else {\r\n                    update[`flags.${MODULE_ID}.data.${thisId}.visibility`] = data.visibility\r\n                }\r\n            } else update[`flags.${MODULE_ID}.data.-=${thisId}`] = true\r\n\r\n            updates.push(update)\r\n        }\r\n\r\n        scene.updateEmbeddedDocuments('Token', updates)\r\n    }\r\n}\r\n\r\nexport class SeekValidationMenu extends ReverseVisibilityValidationMenu {\r\n    #fromTemplate\r\n\r\n    constructor(params, options = {}) {\r\n        super(params, options)\r\n        this.#fromTemplate = params.fromTemplate\r\n    }\r\n\r\n    get globalSelection() {\r\n        if (this.#fromTemplate) return []\r\n        return super.globalSelection\r\n    }\r\n\r\n    static async openMenu(params, options) {\r\n        const validated = await super.openMenu(params, options)\r\n        if (validated) deleteSeekTemplate(params.token)\r\n    }\r\n\r\n    processValue({ token, value }) {\r\n        const roll = this.roll\r\n        const dc = token.actor.skills.stealth.dc.value\r\n        const visibility = VISIBILITY_VALUES[value]\r\n        const success = new DegreeOfSuccess(roll, dc).value\r\n\r\n        if (success >= DegreeOfSuccess.CRITICAL_SUCCESS && visibility >= VISIBILITY_VALUES.hidden) return 'observed'\r\n        else if (success >= DegreeOfSuccess.SUCCESS && visibility === VISIBILITY_VALUES.hidden) return 'observed'\r\n        else if (success >= DegreeOfSuccess.SUCCESS && visibility >= VISIBILITY_VALUES.undetected) return 'hidden'\r\n        else return value\r\n    }\r\n}\r\n", "import {\r\n    CoverValidationMenu,\r\n    HideValidationMenu,\r\n    PointOutValidationMenu,\r\n    SeekValidationMenu,\r\n    UnHideValidationMenu,\r\n} from './apps/validation.js'\r\nimport { attackCheckRoll } from './constants.js'\r\nimport { MODULE_ID, getFlag, getFlags, localize, setFlag } from './module.js'\r\nimport { deleteSeekTemplate } from './template.js'\r\n\r\nexport function renderChatMessage(message, html) {\r\n    const token = message.token\r\n    if (!token) return\r\n\r\n    const isGM = game.user.isGM\r\n    const hasPlayerOwner = token.hasPlayerOwner\r\n    const { cover, selected, skipWait, validated, pointOut } = getFlags(message)\r\n    const pf2eContext = message.getFlag('pf2e', 'context')\r\n\r\n    if (cover) {\r\n        if (isGM) {\r\n            const button = createValidateButton({ property: 'cover', skipWait, validated })\r\n            html.find('.message-content').append(button)\r\n            html.find('[data-action=validate-cover]').on('click', () => {\r\n                CoverValidationMenu.openMenu({ token, selected, value: cover, message })\r\n            })\r\n        } else if (!skipWait) {\r\n            const hint = createWaitHint('cover', validated)\r\n            html.find('.message-content').append(hint)\r\n        }\r\n    } else if (pf2eContext?.pf2ePerception?.visibility) {\r\n        if (!validated) html.find('.message-buttons').remove()\r\n\r\n        const flavor = html.find('.flavor-text')\r\n\r\n        if (!isGM && hasPlayerOwner) {\r\n            html.find('.message-sender').text(token.name)\r\n            flavor.empty()\r\n        }\r\n\r\n        const msg = localize(`message.flat-check.${validated === undefined ? 'blind' : validated ? 'success' : 'failure'}`)\r\n        const hint = createHint(msg, validated)\r\n        flavor.append(hint)\r\n\r\n        if (isGM) {\r\n            for (const type of ['success', 'failure']) {\r\n                flavor.append(\r\n                    createChatButton({\r\n                        action: `${type}-message`,\r\n                        icon: 'fa-solid fa-message',\r\n                        label: localize('message.flat-check.button', type),\r\n                    })\r\n                )\r\n                html.find(`[data-action=${type}-message]`).on('click', () => {\r\n                    setFlag(message, 'validated', type === 'success')\r\n                })\r\n            }\r\n        }\r\n    } else if (pf2eContext?.type === 'skill-check' && pf2eContext.pf2ePerception) {\r\n        if (isGM) {\r\n            if (pf2eContext.options.includes('action:hide')) {\r\n                const button = createValidateButton({ property: 'visibility', skipWait, validated })\r\n                html.find('.flavor-text').append(button)\r\n                html.find('[data-action=validate-visibility]').on('click', () => {\r\n                    HideValidationMenu.openMenu({\r\n                        token,\r\n                        message,\r\n                        roll: message.rolls[0],\r\n                        selected: pf2eContext.pf2ePerception.selected,\r\n                    })\r\n                })\r\n            }\r\n        } else if (hasPlayerOwner) {\r\n            if (pf2eContext.options.includes('action:hide')) {\r\n                addBlindSkillCheckFlavor({ token, message, html, validated })\r\n            }\r\n        }\r\n    } else if (pf2eContext?.type === 'perception-check' && pf2eContext.pf2ePerception) {\r\n        if (isGM) {\r\n            if (pf2eContext.options.includes('action:seek')) {\r\n                const buttons = createValidateCombo({\r\n                    skipWait,\r\n                    validated,\r\n                    smallAction: 'delete-template',\r\n                    smallIcon: 'fa-thin fa-cubes',\r\n                    smallSlashed: true,\r\n                })\r\n\r\n                html.find('.flavor-text').append(buttons)\r\n\r\n                html.find('[data-action=validate-visibility]').on('click', () => {\r\n                    SeekValidationMenu.openMenu({\r\n                        token,\r\n                        message,\r\n                        roll: message.rolls[0],\r\n                        selected: pf2eContext.pf2ePerception.selected,\r\n                        fromTemplate: pf2eContext.pf2ePerception.fromTemplate,\r\n                    })\r\n                })\r\n\r\n                html.find('[data-action=delete-template').on('click', () => {\r\n                    deleteSeekTemplate(token)\r\n                })\r\n            }\r\n        } else if (hasPlayerOwner) {\r\n            if (pf2eContext.options.includes('action:seek')) {\r\n                addBlindSkillCheckFlavor({ token, message, html, validated })\r\n            }\r\n        }\r\n    } else if (pointOut) {\r\n        const selectedToken = token.scene.tokens.get(pointOut)\r\n        if (!selectedToken) return\r\n\r\n        if (isGM) {\r\n            const buttons = createValidateCombo({\r\n                skipWait,\r\n                validated,\r\n                smallAction: 'ping-token',\r\n                smallIcon: 'fa-solid fa-signal-stream',\r\n            })\r\n\r\n            html.find('.message-content').append(buttons)\r\n\r\n            html.find('[data-action=validate-visibility]').on('click', () => {\r\n                PointOutValidationMenu.openMenu({\r\n                    message,\r\n                    token: selectedToken,\r\n                    originator: token,\r\n                    selected: canvas.tokens.controlled.map(t => t.id),\r\n                })\r\n            })\r\n\r\n            html.find('[data-action=ping-token]').on('click', () => {\r\n                canvas.ping(selectedToken.center)\r\n            })\r\n        } else if (hasPlayerOwner) {\r\n            const hint = createWaitHint('visibility', validated)\r\n            html.find('.message-content').append(hint)\r\n        }\r\n    }\r\n\r\n    if (isGM && attackCheckRoll.includes(pf2eContext?.type)) {\r\n        const tooltip = localize('message.unhide.tooltip')\r\n        const button = `<span style=\"position: absolute; right: 0px; bottom: 1px;\">\r\n    <button data-action=\"unhide\" title=\"${tooltip}\" style=\"width: 22px; height: 22px; font-size: 10px; line-height: 1px;\">\r\n        <i class=\"fa-duotone fa-eye-slash\" style=\"right: 1px;\"></i>\r\n    </button>\r\n</span>`\r\n        html.find('.dice-result .dice-total').append(button)\r\n        html.find('[data-action=unhide]').on('click', event => {\r\n            event.stopPropagation()\r\n            UnHideValidationMenu.openMenu({ token })\r\n        })\r\n    }\r\n}\r\n\r\nexport function validateMessage(message) {\r\n    if (!getFlag(message, 'validated')) setFlag(message, 'validated', true)\r\n}\r\n\r\nfunction createValidateCombo({ skipWait, validated, smallIcon, smallAction, smallSlashed }) {\r\n    let buttons = '<div style=\"display: grid; grid-template-columns: 1fr auto; gap: 3px\">'\r\n\r\n    buttons += createValidateButton({ property: 'visibility', skipWait, validated })\r\n    buttons += createChatButton({\r\n        action: smallAction,\r\n        icon: smallIcon,\r\n        slashed: smallSlashed,\r\n        tooltip: localize(`message.visibility.small-button.${smallAction}`),\r\n    })\r\n\r\n    buttons += '</div>'\r\n\r\n    return buttons\r\n}\r\n\r\nfunction addBlindSkillCheckFlavor({ html, token, message, validated }) {\r\n    html.find('.message-sender').text(token.name)\r\n    let flavor = message.getFlag('pf2e', 'modifierName')\r\n    flavor += createWaitHint('visibility', validated)\r\n    html.find('.flavor-text').html(flavor)\r\n}\r\n\r\nfunction createWaitHint(property, validated) {\r\n    const hint = localize(`message.${property}.player.${validated ? 'validated' : 'wait'}`)\r\n    return createHint(hint, validated)\r\n}\r\n\r\nfunction createHint(hint, validated) {\r\n    if (validated === true) hint = '<i class=\"fa-solid fa-check\" style=\"color: green;\"></i> ' + hint\r\n    else if (validated === false) hint = '<i class=\"fa-solid fa-xmark\" style=\"color: red;\"></i> ' + hint\r\n    return `<i style=\"display: block; font-size: .9em; text-align: end;\">${hint}</i>`\r\n}\r\n\r\nfunction createValidateButton({ skipWait, validated, property }) {\r\n    let label = localize(`message.${property}.gm.${skipWait ? 'check' : validated ? 'validated' : 'validate'}`)\r\n    if (!skipWait && validated) label += '<i class=\"fa-solid fa-check\" style=\"color: green; margin-left: 0.3em;\"></i>'\r\n    return createChatButton({\r\n        action: `validate-${property}`,\r\n        icon: 'fa-solid fa-list',\r\n        label,\r\n    })\r\n}\r\n\r\nexport function createChatButton({ action, icon, label, tooltip, slashed = false }) {\r\n    let button = `<button type=\"button\" style=\"margin: 0 0 5px; padding-block: 0; position: relative;\" data-action=\"${action}\" title=\"${tooltip}\">`\r\n\r\n    if (icon) {\r\n        button += `<i class=\"${icon}\" ${label ? '' : `style=\"margin: 0;\"`}></i>`\r\n        if (slashed) {\r\n            const style = 'position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); font-size: 1.2em;'\r\n            button += `<i class=\"fa-solid fa-slash-forward\" style=\"${style}\"></i>`\r\n        }\r\n    }\r\n    if (label) button += `${icon ? ' ' : ''}${label}`\r\n\r\n    button += '</button>'\r\n\r\n    return button\r\n}\r\n\r\nexport async function createTokenMessage({ content, token, flags, secret }) {\r\n    const data = { content, speaker: ChatMessage.getSpeaker({ token: token instanceof Token ? token.document : token }) }\r\n    if (flags) setProperty(data, `flags.${MODULE_ID}`, flags)\r\n    if (secret) {\r\n        data.type = CONST.CHAT_MESSAGE_TYPES.WHISPER\r\n        data.whisper = ChatMessage.getWhisperRecipients('gm')\r\n    }\r\n    return ChatMessage.create(data)\r\n}\r\n", "import { getActorToken, getCoverEffect, isProne } from './actor.js'\r\nimport { createTokenMessage } from './chat.js'\r\nimport { VISIBILITY_VALUES, defaultValues } from './constants.js'\r\nimport { createCoverSource } from './effect.js'\r\nimport { MODULE_ID, getSetting, localize, templatePath } from './module.js'\r\nimport { validateTokens } from './scene.js'\r\nimport { createSeekTemplate, deleteSeekTemplate } from './template.js'\r\nimport { clearTokenData, getTokenData, setTokenData } from './token.js'\r\nimport { getPrototype } from './utils.js'\r\n\r\nexport function setupActions() {\r\n    const hide = game.pf2e.actions.get('hide')\r\n    const BaseAction = getPrototype(hide, 2).constructor\r\n    const BaseActionVariant = getPrototype(hide.toActionVariant(), 2).constructor\r\n    const SingleCheckAction = getPrototype(hide, 1).constructor\r\n    const SingleCheckActionVariant = getPrototype(hide.toActionVariant(), 1).constructor\r\n\r\n    setupCover(BaseAction, BaseActionVariant)\r\n    setupHide(SingleCheckAction, SingleCheckActionVariant)\r\n    setupSneak(SingleCheckAction, SingleCheckActionVariant)\r\n    setupSeek(SingleCheckAction, SingleCheckActionVariant)\r\n    setupPointOut(BaseAction, BaseActionVariant)\r\n}\r\n\r\nfunction setupPointOut(BaseAction, BaseActionVariant) {\r\n    class PointOutVariant extends BaseActionVariant {\r\n        async use(options = {}) {\r\n            const action = localize('action.point-out')\r\n            const token = getSelectedToken(options, action)\r\n            if (token) pointOut(this, token)\r\n        }\r\n    }\r\n\r\n    class PointOut extends BaseAction {\r\n        constructor() {\r\n            super({\r\n                cost: 1,\r\n                name: `${MODULE_ID}.action.point-out`,\r\n                description: `${MODULE_ID}.action.point-out.description`,\r\n                rollOptions: ['action:point-out'],\r\n                slug: 'point-out',\r\n                traits: ['auditory', 'manipulate', 'visual'],\r\n            })\r\n        }\r\n\r\n        toActionVariant(data = {}) {\r\n            data.name ??= this.name\r\n            return new PointOutVariant(this, data)\r\n        }\r\n    }\r\n\r\n    game.pf2e.actions.set('point-out', new PointOut())\r\n}\r\n\r\nasync function pointOut({ name, traits }, token) {\r\n    const target = game.user.targets.filter(t => t.actor).first()\r\n    const visibility = target ? getTokenData(target, token.id, 'visibility') : undefined\r\n    const isVisible = target && VISIBILITY_VALUES[visibility] < VISIBILITY_VALUES.undetected\r\n\r\n    let description\r\n    if (isVisible) {\r\n        const dc = target.actor.skills.stealth.dc.value\r\n        description = localize('message.point-out.short-check', {\r\n            check: `@Check[type:perception|dc:${dc}|traits:auditory,manipulate,visual|showDC:gm]`,\r\n        })\r\n    } else description = localize('message.point-out.short')\r\n\r\n    const content = await renderTemplate(templatePath('point-out'), {\r\n        description,\r\n        name,\r\n        traits: traits.map(slug => ({\r\n            slug,\r\n            tooltip: CONFIG.PF2E.traitsDescriptions[slug],\r\n            name: CONFIG.PF2E.actionTraits[slug],\r\n        })),\r\n    })\r\n\r\n    const flags = {\r\n        pointOut: isVisible ? target.id : undefined,\r\n    }\r\n\r\n    createTokenMessage({ content, token, flags })\r\n}\r\n\r\nfunction setupSeek(SingleCheckAction, SingleCheckActionVariant) {\r\n    class SeekVariant extends SingleCheckActionVariant {\r\n        async use(options = {}) {\r\n            const action = game.i18n.localize('PF2E.Actions.Seek.Title')\r\n            const token = getSelectedToken(options, action)\r\n            if (!token) return\r\n\r\n            if (!(await seek(token))) return deleteSeekTemplate(token)\r\n\r\n            options.actors = [token.actor]\r\n            return super.use(options)\r\n        }\r\n    }\r\n\r\n    class Seek extends SingleCheckAction {\r\n        constructor() {\r\n            super({\r\n                cost: 1,\r\n                description: 'PF2E.Actions.Seek.Description',\r\n                name: 'PF2E.Actions.Seek.Title',\r\n                notes: [\r\n                    { outcome: ['criticalSuccess'], text: 'PF2E.Actions.Seek.Notes.criticalSuccess' },\r\n                    { outcome: ['success'], text: 'PF2E.Actions.Seek.Notes.success' },\r\n                ],\r\n                rollOptions: ['action:seek'],\r\n                slug: 'seek',\r\n                statistic: 'perception',\r\n                traits: ['concentrate', 'secret'],\r\n            })\r\n        }\r\n\r\n        toActionVariant(data) {\r\n            return new SeekVariant(this, data)\r\n        }\r\n    }\r\n\r\n    game.pf2e.actions.set('seek', new Seek())\r\n}\r\n\r\nasync function seek(token) {\r\n    const unit = game.i18n.localize('PF2E.Foot')\r\n\r\n    let content = '<p style=\"margin: 0 0.3em; text-align: center;\">'\r\n    content += `${localize('dialog.seek.hint')}</p><p>`\r\n\r\n    content += createButton(\r\n        'create-cone',\r\n        'fa-thin fa-cubes',\r\n        game.i18n.format('PF2E.TemplateLabel', {\r\n            size: 30,\r\n            unit,\r\n            shape: game.i18n.localize(CONFIG.PF2E.areaTypes.cone),\r\n        })\r\n    )\r\n\r\n    content += createButton(\r\n        'create-burst',\r\n        'fa-thin fa-cubes',\r\n        game.i18n.format('PF2E.TemplateLabel', {\r\n            size: 15,\r\n            unit,\r\n            shape: game.i18n.localize(CONFIG.PF2E.areaTypes.burst),\r\n        })\r\n    )\r\n\r\n    content += '</p>'\r\n\r\n    return Dialog.wait(\r\n        {\r\n            title: `${token.name} - ${game.i18n.localize('PF2E.Actions.Seek.Title')}`,\r\n            content,\r\n            buttons: {\r\n                ok: {\r\n                    icon: '<i class=\"fa-solid fa-check\"></i>',\r\n                    label: localize('dialog.seek.accept'),\r\n                    callback: () => true,\r\n                },\r\n                no: {\r\n                    icon: '<i class=\"fa-solid fa-xmark\"></i>',\r\n                    label: localize('dialog.seek.cancel'),\r\n                    callback: html => false,\r\n                },\r\n            },\r\n            close: () => false,\r\n            render: html => {\r\n                const content = html.filter('.dialog-content')\r\n                content.find('[data-action=create-cone], [data-action=create-burst]').on('click', event => {\r\n                    const { action } = event.currentTarget.dataset\r\n                    deleteSeekTemplate(token)\r\n                    createSeekTemplate({ type: action === 'create-cone' ? 'cone' : 'burst', token })\r\n                })\r\n            },\r\n        },\r\n        { width: 300, left: 10 }\r\n    )\r\n}\r\n\r\nfunction setupSneak(SingleCheckAction, SingleCheckActionVariant) {\r\n    class SneakVariant extends SingleCheckActionVariant {\r\n        async use(options = {}) {\r\n            const action = game.i18n.localize('PF2E.Actions.Sneak.Title')\r\n            const token = getSelectedToken(options, action)\r\n            if (!token) return\r\n\r\n            options.actors = [token.actor]\r\n            return super.use(options)\r\n        }\r\n    }\r\n\r\n    class Sneak extends SingleCheckAction {\r\n        constructor() {\r\n            super({\r\n                cost: 1,\r\n                description: `PF2E.Actions.Sneak.Description`,\r\n                name: `PF2E.Actions.Sneak.Title`,\r\n                notes: [\r\n                    { outcome: ['success', 'criticalSuccess'], text: `PF2E.Actions.Sneak.Notes.success` },\r\n                    { outcome: ['failure'], text: `PF2E.Actions.Sneak.Notes.failure` },\r\n                    { outcome: ['criticalFailure'], text: `PF2E.Actions.Sneak.Notes.criticalFailure` },\r\n                ],\r\n                rollOptions: ['action:sneak'],\r\n                slug: 'sneak',\r\n                traits: ['move', 'secret'],\r\n            })\r\n        }\r\n\r\n        toActionVariant(data) {\r\n            return new SneakVariant(this, data)\r\n        }\r\n    }\r\n\r\n    // game.pf2e.actions.set('sneak', new Sneak())\r\n}\r\n\r\nfunction setupHide(SingleCheckAction, SingleCheckActionVariant) {\r\n    class HideVariant extends SingleCheckActionVariant {\r\n        async use(options = {}) {\r\n            const action = game.i18n.localize('PF2E.Actions.Hide.Title')\r\n            const token = getSelectedToken(options, action)\r\n            if (!token) return\r\n\r\n            options.actors = [token.actor]\r\n            return super.use(options)\r\n        }\r\n    }\r\n\r\n    class Hide extends SingleCheckAction {\r\n        constructor() {\r\n            super({\r\n                cost: 1,\r\n                description: `PF2E.Actions.Hide.Description`,\r\n                name: `PF2E.Actions.Hide.Title`,\r\n                rollOptions: ['action:hide'],\r\n                slug: 'hide',\r\n                statistic: 'stealth',\r\n                traits: ['secret'],\r\n                notes: [{ outcome: ['success', 'criticalSuccess'], text: `PF2E.Actions.Hide.Notes.success` }],\r\n            })\r\n        }\r\n\r\n        toActionVariant(data) {\r\n            return new HideVariant(this, data)\r\n        }\r\n    }\r\n\r\n    game.pf2e.actions.set('hide', new Hide())\r\n}\r\n\r\nfunction setupCover(BaseAction, BaseActionVariant) {\r\n    class TakeCoverVariant extends BaseActionVariant {\r\n        async use(options = {}) {\r\n            const action = localize('action.take-cover')\r\n            const token = getSelectedToken(options, action)\r\n            if (token) takeCover(token)\r\n        }\r\n    }\r\n\r\n    class TakeCover extends BaseAction {\r\n        constructor() {\r\n            super({\r\n                cost: 1,\r\n                description: 'PF2E.Actions.TakeCover.Description',\r\n                img: 'systems/pf2e/icons/conditions-2/status_acup.webp',\r\n                name: 'PF2E.Actions.TakeCover.Title',\r\n                slug: 'take-cover',\r\n            })\r\n        }\r\n\r\n        toActionVariant(data) {\r\n            return new TakeCoverVariant(this, data)\r\n        }\r\n    }\r\n\r\n    game.pf2e.actions.set('take-cover', new TakeCover())\r\n}\r\n\r\nasync function takeCover(token) {\r\n    const actor = token.actor\r\n    const cover = getCoverEffect(actor)\r\n\r\n    const targets = validateTokens(token, game.user.targets.ids)\r\n    if (cover && !targets.length) return cover.delete()\r\n\r\n    const data = getTokenData(token) ?? {}\r\n    const covers = Object.entries(data).reduce((covers, [tokenId, { cover }]) => {\r\n        if (cover) covers[tokenId] = cover\r\n        return covers\r\n    }, {})\r\n\r\n    const content = await renderTemplate(templatePath('covers-dialog'), {\r\n        i18n: localize,\r\n        hasTargets: !!targets.length,\r\n        hasCovers: !isEmpty(covers),\r\n        hasTargetCover: targets.some(id => id in covers),\r\n        isProne: isProne(actor),\r\n    })\r\n\r\n    const dialog = new Dialog({\r\n        title: `${token.name} - ${localize('action.take-cover')}`,\r\n        content,\r\n        buttons: {},\r\n        render: html => {\r\n            html.find('button').on('click', async event => {\r\n                const { level } = event.currentTarget.dataset\r\n                const skip = getSetting('skip-cover')\r\n\r\n                const process = async (cover, selected) => {\r\n                    selected = selected ? targets : undefined\r\n\r\n                    const flavor = cover === defaultValues.cover ? (selected ? 'remove' : 'remove-all') : 'take'\r\n                    const message = await createTokenMessage({\r\n                        content: localize(`message.cover.${flavor}`, { cover: localize(`cover.${cover}`) }),\r\n                        flags: { selected, cover, skipWait: skip },\r\n                        token,\r\n                    })\r\n\r\n                    if (skip) {\r\n                        if (cover === defaultValues.cover && !selected) return clearTokenData(token)\r\n                        const data = deepClone(getTokenData(token)) ?? {}\r\n                        for (const tokenId of targets) {\r\n                            setProperty(data, `${tokenId}.cover`, cover)\r\n                        }\r\n                        return setTokenData(token, data)\r\n                    }\r\n                }\r\n\r\n                if (level === 'remove-all') process(defaultValues.cover)\r\n                else if (level === 'remove') process(defaultValues.cover, true)\r\n                else if (targets.length) process(level, true)\r\n                else {\r\n                    const source = createCoverSource(level)\r\n                    actor.createEmbeddedDocuments('Item', [source])\r\n                }\r\n\r\n                dialog.close()\r\n            })\r\n        },\r\n    }).render(true)\r\n}\r\n\r\nfunction getSelectedToken(options, action) {\r\n    let tokens = options.tokens?.filter(t => t.actor) ?? []\r\n    if (!Array.isArray(tokens)) tokens = [tokens]\r\n\r\n    let actors = options.actors ?? []\r\n    if (!Array.isArray(actors)) actors = [actors]\r\n\r\n    if (!tokens.length && actors.length === 1) tokens = [getActorToken(actors[0])].filter(Boolean)\r\n    if (!tokens.length) tokens = canvas.tokens.controlled.filter(t => t.actor)\r\n    if (!tokens.length) tokens = [getActorToken(game.user.character)].filter(Boolean)\r\n\r\n    if (tokens.length > 1) {\r\n        ui.notifications.warn(localize('action.only-one', { action }))\r\n        return\r\n    } else if (!tokens.length) {\r\n        ui.notifications.warn(localize('action.must-one', { action }))\r\n        return\r\n    }\r\n\r\n    const token = tokens[0]\r\n    if (!token?.actor?.isOfType('creature')) {\r\n        ui.notifications.warn(localize('action.must-creature', { action }))\r\n        return\r\n    }\r\n\r\n    return token\r\n}\r\n\r\nfunction createButton(action, icon, label) {\r\n    return `<button type=\"button\" data-action=\"${action}\" style=\"margin: 0 0 5px; padding: 0;\">\r\n    <i class=\"${icon}\"></i> ${label}</button>\r\n</button>`\r\n}\r\n", "import { getActorToken, getCoverEffect, hasGreaterDarkvision, isProne } from './actor.js'\r\nimport { clearDebug, getRectEdges, lineIntersectWall, pointToTokenIntersectWall } from './geometry.js'\r\nimport { getLightExposure } from './lighting.js'\r\nimport { getPerception, perceptionRules, updateFromPerceptionRules } from './rule-element.js'\r\nimport { getSceneSetting, getValidTokens, validateTokens } from './scene.js'\r\nimport {\r\n    createDarknessTemplate,\r\n    createMistTemplate,\r\n    createSeekTemplate,\r\n    createTemplate,\r\n    deleteSeekTemplate,\r\n    getDarknessTemplates,\r\n    getMistTemplates,\r\n    getSeekTemplateTokens,\r\n    getTemplateTokens,\r\n} from './template.js'\r\nimport {\r\n    clearConditionals,\r\n    getCover,\r\n    getCreatureCover,\r\n    getTokenData,\r\n    getVisibility,\r\n    getWallCover,\r\n    showAllConditionals,\r\n    showConditionals,\r\n} from './token.js'\r\n\r\nexport const API = {\r\n    geometry: {\r\n        clearDebug,\r\n        getRectEdges,\r\n        lineIntersectWall,\r\n        pointToTokenIntersectWall,\r\n    },\r\n    token: {\r\n        getCreatureCover,\r\n        getWallCover,\r\n        getVisibility,\r\n        clearConditionals,\r\n        showConditionals,\r\n        showAllConditionals,\r\n        getTokenData,\r\n        getCover,\r\n    },\r\n    lighting: {\r\n        getLightExposure,\r\n    },\r\n    actor: {\r\n        getActorToken,\r\n        isProne,\r\n        getCoverEffect,\r\n        hasGreaterDarkvision,\r\n    },\r\n    scene: {\r\n        getValidTokens,\r\n        validateTokens,\r\n        getSceneSetting,\r\n    },\r\n    template: {\r\n        createSeekTemplate,\r\n        createDarknessTemplate,\r\n        createMistTemplate,\r\n        getDarknessTemplates,\r\n        getMistTemplates,\r\n        getSeekTemplateTokens,\r\n        deleteSeekTemplate,\r\n        createTemplate,\r\n        getTemplateTokens,\r\n    },\r\n    ruleElement: {\r\n        perceptionRules,\r\n        getPerception,\r\n        updateFromPerceptionRules,\r\n    },\r\n}\r\n", "import { getActorToken, getCoverEffect, isProne } from './actor.js'\r\nimport { COVERS, COVER_UUID, VISIBILITY_VALUES, attackCheckRoll, validCheckRoll } from './constants.js'\r\nimport { createCoverSource, findChoiceSetRule } from './effect.js'\r\nimport { MODULE_ID, getFlag, getSetting, localize } from './module.js'\r\nimport { getPerception, perceptionRules } from './rule-element.js'\r\nimport { validateTokens } from './scene.js'\r\nimport { getSeekTemplateTokens } from './template.js'\r\nimport { getVisibility } from './token.js'\r\nimport { asNumberOnly } from './utils.js'\r\n\r\nexport async function checkRoll(wrapped, ...args) {\r\n    const context = args[1]\r\n    if (!context) return wrapped(...args)\r\n\r\n    if (Array.isArray(context.options)) context.options = new Set(context.options)\r\n\r\n    const { actor, createMessage = 'true', type, token, target, isReroll } = context\r\n    const originToken = token ?? getActorToken(actor)\r\n    const targetToken = target?.token\r\n    const isAttackRoll = attackCheckRoll.includes(type)\r\n    const flatCheck = getSetting('flat-check')\r\n\r\n    if (\r\n        isReroll ||\r\n        !createMessage ||\r\n        !originToken ||\r\n        !validCheckRoll.includes(type) ||\r\n        (isAttackRoll && (!targetToken || flatCheck === 'none'))\r\n    )\r\n        return wrapped(...args)\r\n\r\n    if (isAttackRoll && targetToken.actor) {\r\n        const event = args[2]\r\n        const perception = perceptionRules(originToken, targetToken, {\r\n            extraOptions: context.options.filter(o => o.startsWith('item:')),\r\n        })\r\n\r\n        const visibility = getVisibility(targetToken, originToken, { perception, affects: 'target' })\r\n        if (!visibility) return wrapped(...args)\r\n\r\n        let dc = asNumberOnly(getPerception(perception, 'target', 'visibility', 'dc', visibility)?.first())\r\n        if (dc === 0) return wrapped(...args)\r\n\r\n        const isUndetected = VISIBILITY_VALUES[visibility] >= VISIBILITY_VALUES.undetected\r\n        const isBlind = event?.ctrlKey || event?.metaKey\r\n\r\n        const roll = await new originToken.actor.perception.constructor(originToken.actor, {\r\n            slug: 'visibility-check',\r\n            label: `${game.i18n.localize('PF2E.FlatCheck')}: ${game.i18n.localize(`PF2E.condition.${visibility}.name`)}`,\r\n            check: { type: 'flat-check' },\r\n        }).roll({\r\n            dc: dc ?? visibility === 'concealed' ? 5 : 11,\r\n            target: targetToken.actor,\r\n            rollMode: isUndetected || isBlind ? (game.user.isGM ? 'gmroll' : 'blindroll') : 'roll',\r\n        })\r\n\r\n        const isSuccess = roll.degreeOfSuccess > 1\r\n\r\n        if (isUndetected) {\r\n            context.options.add('secret')\r\n            context.pf2ePerception = {\r\n                isSuccess: isSuccess,\r\n                visibility,\r\n            }\r\n        }\r\n\r\n        if (flatCheck !== 'roll' && !isUndetected && !isSuccess) return\r\n    } else if (context.options.has('action:hide')) {\r\n        setProperty(context, 'pf2ePerception.selected', game.user.targets.ids)\r\n        // } else if (context.options.has('action:sneak')) {\r\n        //     context.selected = game.user.targets.ids\r\n    } else if (context.options.has('action:seek')) {\r\n        const highlighted = getSeekTemplateTokens(originToken)\r\n        const tokens = highlighted ?? Array.from(game.user.targets)\r\n        const selected = validateTokens(originToken, tokens)\r\n            .filter(t => !t.document.hidden)\r\n            .map(t => t.id)\r\n\r\n        setProperty(context, 'pf2ePerception.selected', selected)\r\n        setProperty(context, 'pf2ePerception.fromTemplate', !!highlighted)\r\n    }\r\n\r\n    return wrapped(...args)\r\n}\r\n\r\nexport function renderCheckModifiersDialog(dialog, html) {\r\n    const { createMessage = 'true', type, token, target, isReroll, options, dc } = dialog.context\r\n    const originToken = token\r\n    const targetToken = target?.token\r\n    const targetActor = target?.actor\r\n\r\n    if (isReroll || !createMessage || !originToken || !targetToken || !targetActor || !attackCheckRoll.includes(type)) return\r\n\r\n    const coverEffect = getCoverEffect(targetActor)\r\n    const currentCover = coverEffect\r\n        ? findChoiceSetRule(coverEffect)?.selection.level ?? getFlag(coverEffect, 'level')\r\n        : undefined\r\n    let coverOverride = dialog[MODULE_ID]?.coverOverride ?? currentCover\r\n\r\n    let template = '<div class=\"roll-mode-panel\">'\r\n    template += `<div class=\"label\">${localize('dice-checks.cover.label')}</div>`\r\n    template += `<select name=\"overrideCover\"><option value=\"\">${localize('dice-checks.cover.none')}</option>`\r\n\r\n    const covers = isProne(targetActor) ? COVERS.slice(1) : COVERS.slice(1, -1)\r\n\r\n    covers.forEach(slug => {\r\n        const selected = slug === coverOverride ? 'selected' : ''\r\n        const label = localize(`cover.${slug}`)\r\n        template += `<option value=\"${slug}\" ${selected}>${label}</option>`\r\n    })\r\n\r\n    template += '</select></div>'\r\n\r\n    // visibility override here\r\n\r\n    template += '<hr>'\r\n\r\n    html.find('.roll-mode-panel').before(template)\r\n\r\n    html.find('select[name=overrideCover]').on('change', event => {\r\n        const value = event.currentTarget.value || undefined\r\n        setProperty(dialog, `${MODULE_ID}.coverOverride`, value)\r\n        coverOverride = value\r\n    })\r\n\r\n    html.find('button.roll')[0].addEventListener(\r\n        'click',\r\n        event => {\r\n            event.preventDefault()\r\n            event.stopPropagation()\r\n            event.stopImmediatePropagation()\r\n\r\n            let modified = false\r\n            const items = deepClone(targetActor._source.items)\r\n\r\n            if (coverOverride !== currentCover) {\r\n                modified = true\r\n\r\n                const coverIndex = items.findIndex(i => getProperty(i, 'flags.core.sourceId') === COVER_UUID)\r\n                if (coverIndex !== -1) items.splice(coverIndex, 1)\r\n\r\n                if (coverOverride) {\r\n                    const source = createCoverSource(coverOverride)\r\n                    items.push(source)\r\n                }\r\n            }\r\n\r\n            if (modified) {\r\n                target.actor = targetActor.clone({ items }, { keepId: true })\r\n\r\n                if (dc?.slug) {\r\n                    const statistic = target.actor.getStatistic(dc.slug)?.dc\r\n                    if (statistic) {\r\n                        dc.value = statistic.value\r\n                        dc.statistic = statistic\r\n                    }\r\n                }\r\n            }\r\n\r\n            dialog.resolve(true)\r\n            dialog.isResolved = true\r\n            dialog.close()\r\n        },\r\n        true\r\n    )\r\n\r\n    dialog.setPosition()\r\n}\r\n", "import { getSetting, localize, setSetting } from './module.js'\r\n\r\nexport function renderCombatTracker(tracker, html) {\r\n    if (getSetting('target')) setupToggleTarget(html)\r\n    // hideUndetected(html)\r\n}\r\n\r\nfunction hideUndetected(html) {\r\n    if (!canvas.ready) return\r\n\r\n    const combatants = game.combats.viewed?.combatants\r\n    if (!combatants?.size) return\r\n\r\n    html.find('#combat-tracker .combatant').each((i, li) => {\r\n        const { combatantId } = li.dataset\r\n        const token = combatants.get(combatantId ?? '')?.token\r\n        if (!token) return\r\n\r\n        // if (isUndetected(token, 'basicSight', true)) li.remove()\r\n    })\r\n}\r\n\r\nfunction setupToggleTarget(html) {\r\n    html.find('[data-control=toggleTarget]').each((_, el) => {\r\n        el.addEventListener(\r\n            'click',\r\n            event => {\r\n                event.preventDefault()\r\n                event.stopPropagation()\r\n                event.stopImmediatePropagation()\r\n\r\n                const { combatantId } = event.currentTarget.closest('.combatant').dataset\r\n                const combatant = game.combats.viewed.combatants.get(combatantId ?? '')\r\n                const token = combatant?.token\r\n                if (!token) return\r\n\r\n                const isTargeted = Array.from(game.user.targets).some(t => t.document === token)\r\n                token.object.setTarget(!isTargeted, { releaseOthers: !event.shiftKey })\r\n            },\r\n            true\r\n        )\r\n    })\r\n}\r\n\r\nexport function renderCombatTrackerConfig(config, html) {\r\n    const checked = getSetting('encounter')\r\n\r\n    html.find('.form-group').last().after(`<div class=\"form-group\">\r\n    <label>${localize('settings.encounter.name')}</label>\r\n    <input type=\"checkbox\" name=\"pf2e-perception.encounter\" ${checked ? 'checked' : ''}>\r\n    <p class=\"notes\">${localize('settings.encounter.short')}</p>\r\n</div>`)\r\n\r\n    html.find('input[name=\"pf2e-perception.encounter\"]').on('change', event => {\r\n        const checked = event.currentTarget.checked\r\n        setSetting('encounter', checked)\r\n    })\r\n}\r\n", "import { VISIBILITY_VALUES } from './constants.js'\r\nimport { perceptionRules } from './rule-element.js'\r\nimport { getVisibility } from './token.js'\r\n\r\nexport function detectionModeTestVisibility(visionSource, mode, config = {}) {\r\n    if (!mode.enabled) return false\r\n    if (!this._canDetect(visionSource, config.object, config)) return false\r\n    return config.tests.some(test => this._testPoint(visionSource, mode, config.object, test))\r\n}\r\n\r\nexport function basicSightCanDetect(visionSource, target, config) {\r\n    if (target instanceof PlaceableObject && target.document.hidden) return false\r\n    if (!(target instanceof Token)) return true\r\n\r\n    const origin = visionSource.object\r\n    const originDocument = origin.document\r\n    if (originDocument instanceof TokenDocument && originDocument.hasStatusEffect(CONFIG.specialStatusEffects.BLIND)) return false\r\n\r\n    if (!(origin instanceof Token)) {\r\n        return (\r\n            !target.document?.hasStatusEffect(CONFIG.specialStatusEffects.INVISIBLE) &&\r\n            !target.actor?.hasCondition('hidden', 'undetected', 'unnoticed')\r\n        )\r\n    }\r\n\r\n    return !reachesThreshold(origin, target, VISIBILITY_VALUES.hidden, config)\r\n}\r\n\r\nexport function hearingCanDetect(visionSource, target, config) {\r\n    if (target.document.hidden || !(target instanceof Token) || !target.actor?.emitsSound) return false\r\n    if (!game.settings.get('pf2e', 'automation.rulesBasedVision')) return true\r\n\r\n    const origin = visionSource.object\r\n    if (origin.actor?.hasCondition('deafened')) return false\r\n\r\n    if (!(origin instanceof Token)) {\r\n        return !target.actor?.hasCondition('undetected', 'unnoticed')\r\n    }\r\n\r\n    return !reachesThreshold(origin, target, VISIBILITY_VALUES.undetected, config)\r\n}\r\n\r\nexport function feelTremorCanDetect(visionSource, target, config) {\r\n    if (\r\n        target.document.hidden ||\r\n        !(target instanceof Token) ||\r\n        target.document.elevation > canvas.primary.background.elevation ||\r\n        target.actor?.isOfType('loot')\r\n    )\r\n        return false\r\n\r\n    const origin = visionSource.object\r\n    if (!(origin instanceof Token)) {\r\n        return !target.actor?.hasCondition('undetected', 'unnoticed')\r\n    }\r\n\r\n    return !reachesThreshold(origin, target, VISIBILITY_VALUES.undetected, config)\r\n}\r\n\r\nfunction reachesThreshold(origin, target, threshold, config = {}) {\r\n    if (!config.visibility) {\r\n        const perception = perceptionRules(origin, target)\r\n        config.visibility = getVisibility(target, origin, { perception, affects: 'target' })\r\n    }\r\n\r\n    return VISIBILITY_VALUES[config.visibility] >= threshold\r\n}\r\n", "import { ICONS_PATHS } from '../constants.js'\r\nimport { getSetting, localize, setSetting, templatePath } from '../module.js'\r\n\r\nconst ICONS = ['cover', 'concealed', 'hidden', 'undetected', 'unnoticed']\r\n\r\nexport class IconPathMenu extends FormApplication {\r\n    static get defaultOptions() {\r\n        return foundry.utils.mergeObject(super.defaultOptions, {\r\n            template: templatePath('icon-path-menu'),\r\n            title: localize('settings.icon-path.name'),\r\n            width: 500,\r\n        })\r\n    }\r\n\r\n    getData() {\r\n        const saved = getSetting('icon-path')\r\n\r\n        const icons = ICONS.map(name => ({\r\n            name,\r\n            placeholder: ICONS_PATHS[name],\r\n            value: saved[name] ?? '',\r\n            label: name === 'cover' ? localize('icon-path.cover') : game.i18n.localize(CONFIG.PF2E.conditionTypes[name]),\r\n        }))\r\n\r\n        return {\r\n            icons,\r\n            i18n: localize,\r\n        }\r\n    }\r\n\r\n    activateListeners(html) {\r\n        super.activateListeners(html)\r\n\r\n        html.find('button[name=cancel]').on('click', event => {\r\n            event.prefentDefault()\r\n            this.close()\r\n        })\r\n    }\r\n\r\n    async _updateObject(event, formData) {\r\n        setSetting('icon-path', formData)\r\n    }\r\n}\r\n", "import { IconPathMenu } from './apps/icon-path-menu.js'\r\nimport { MODULE_ID } from './module.js'\r\n\r\nexport function registerSettings() {\r\n    register('icon-path', Object, {}, { config: false })\r\n    game.settings.registerMenu(MODULE_ID, 'icon-path-menu', {\r\n        name: path('icon-path', 'name'),\r\n        label: path('icon-path', 'label'),\r\n        icon: 'fa-solid fa-list',\r\n        restricted: true,\r\n        type: IconPathMenu,\r\n    })\r\n\r\n    register('permission', String, CONST.USER_ROLES.GAMEMASTER, {\r\n        choices: {\r\n            1: path('permission', 'choices.1'),\r\n            2: path('permission', 'choices.2'),\r\n            3: path('permission', 'choices.3'),\r\n            4: path('permission', 'choices.4'),\r\n        },\r\n    })\r\n\r\n    register('npc-vision', Boolean, false)\r\n\r\n    register('target', Boolean, true, {\r\n        onChange: () => ui.combat?.render(),\r\n    })\r\n\r\n    register('lesser', String, 'ten', {\r\n        choices: {\r\n            none: path('lesser', 'choices.none'),\r\n            cross: path('lesser', 'choices.cross'),\r\n            zero: path('lesser', 'choices.zero'),\r\n            ten: path('lesser', 'choices.ten'),\r\n            twenty: path('lesser', 'choices.twenty'),\r\n        },\r\n    })\r\n\r\n    register('standard', Boolean, true)\r\n\r\n    register('standard-type', String, 'center', {\r\n        choices: {\r\n            center: path('standard-type', 'choices.center'),\r\n            points: path('standard-type', 'choices.points'),\r\n        },\r\n    })\r\n\r\n    register('skip-cover', Boolean, true)\r\n\r\n    register('validation', String, 'all', {\r\n        choices: {\r\n            all: path('validation', 'choices.all'),\r\n            selected: path('validation', 'choices.selected'),\r\n            changed: path('validation', 'choices.changed'),\r\n        },\r\n    })\r\n\r\n    register('flat-check', String, 'roll', {\r\n        choices: {\r\n            none: path('flat-check', 'choices.none'),\r\n            roll: path('flat-check', 'choices.roll'),\r\n            cancel: path('flat-check', 'choices.cancel'),\r\n        },\r\n    })\r\n\r\n    register('encounter', Boolean, false)\r\n}\r\n\r\nfunction path(setting, key) {\r\n    return `${MODULE_ID}.settings.${setting}.${key}`\r\n}\r\n\r\nfunction register(name, type, defValue, extra = {}) {\r\n    game.settings.register(MODULE_ID, name, {\r\n        name: path(name, 'name'),\r\n        hint: path(name, 'hint'),\r\n        scope: 'world',\r\n        config: true,\r\n        type,\r\n        default: defValue,\r\n        ...extra,\r\n    })\r\n}\r\n", "import { setupActions } from './action.js'\r\nimport { getRollContext, visionLevel } from './actor.js'\r\nimport { API } from './api.js'\r\nimport { renderChatMessage } from './chat.js'\r\nimport { checkRoll, renderCheckModifiersDialog } from './check.js'\r\nimport { renderCombatTracker, renderCombatTrackerConfig } from './combat.js'\r\nimport { basicSightCanDetect, detectionModeTestVisibility, feelTremorCanDetect, hearingCanDetect } from './detection.js'\r\nimport { MODULE_ID } from './module.js'\r\nimport { setupRuleElement } from './rule-element.js'\r\nimport { renderSceneConfig } from './scene.js'\r\nimport { registerSettings } from './settings.js'\r\nimport { highlightTemplateGrid, onMeasuredTemplate, preCreateMeasuredTemplate } from './template.js'\r\nimport {\r\n    clearConditionals,\r\n    controlToken,\r\n    deleteToken,\r\n    hoverToken,\r\n    pasteToken,\r\n    preCreateToken,\r\n    renderTokenHUD,\r\n    rulesBasedVision,\r\n    updateToken,\r\n} from './token.js'\r\n\r\nconst CHECK_ROLL = 'game.pf2e.Check.roll'\r\n\r\nconst RULES_BASED_VISION = 'CONFIG.Token.documentClass.prototype.rulesBasedVision'\r\n\r\nconst HIGHLIGHT_TEMPLATE_GRID = 'CONFIG.MeasuredTemplate.objectClass.prototype.highlightGrid'\r\n\r\nconst GET_ROLL_CONTEXT = 'CONFIG.Actor.documentClass.prototype.getRollContext'\r\nconst VISION_LEVEL = 'CONFIG.PF2E.Actor.documentClasses.npc.prototype.visionLevel'\r\n\r\nconst DETECTION_MODE_TEST_VISIBILITY = 'DetectionMode.prototype.testVisibility'\r\nconst BASIC_SIGHT_CAN_DETECT = 'CONFIG.Canvas.detectionModes.basicSight._canDetect'\r\nconst HEARING_CAN_DETECT = 'CONFIG.Canvas.detectionModes.hearing._canDetect'\r\nconst FEEL_TREMOR_CAN_DETECT = 'CONFIG.Canvas.detectionModes.feelTremor._canDetect'\r\n\r\nHooks.once('init', () => {\r\n    registerSettings()\r\n    setupActions()\r\n    setupRuleElement()\r\n\r\n    libWrapper.register(MODULE_ID, CHECK_ROLL, checkRoll)\r\n\r\n    libWrapper.register(MODULE_ID, HIGHLIGHT_TEMPLATE_GRID, highlightTemplateGrid, 'OVERRIDE')\r\n\r\n    libWrapper.register(MODULE_ID, RULES_BASED_VISION, rulesBasedVision, 'OVERRIDE')\r\n\r\n    libWrapper.register(MODULE_ID, GET_ROLL_CONTEXT, getRollContext, 'OVERRIDE')\r\n    libWrapper.register(MODULE_ID, VISION_LEVEL, visionLevel, 'OVERRIDE')\r\n\r\n    libWrapper.register(MODULE_ID, DETECTION_MODE_TEST_VISIBILITY, detectionModeTestVisibility, 'OVERRIDE')\r\n    libWrapper.register(MODULE_ID, BASIC_SIGHT_CAN_DETECT, basicSightCanDetect, 'OVERRIDE')\r\n    libWrapper.register(MODULE_ID, HEARING_CAN_DETECT, hearingCanDetect, 'OVERRIDE')\r\n    libWrapper.register(MODULE_ID, FEEL_TREMOR_CAN_DETECT, feelTremorCanDetect, 'OVERRIDE')\r\n\r\n    const isGM = game.data.users.find(x => x._id === game.data.userId).role >= CONST.USER_ROLES.GAMEMASTER\r\n    if (isGM) {\r\n        Hooks.on('renderSceneConfig', renderSceneConfig)\r\n        Hooks.on('renderCombatTrackerConfig', renderCombatTrackerConfig)\r\n    } else {\r\n        Hooks.on('renderCombatTracker', renderCombatTracker)\r\n    }\r\n\r\n    game.modules.get(MODULE_ID).custom = {\r\n        getWallCover: undefined,\r\n    }\r\n})\r\n\r\nHooks.once('ready', () => {\r\n    game.modules.get(MODULE_ID).api = API\r\n\r\n    Hooks.on('renderChatMessage', renderChatMessage)\r\n\r\n    for (const el of document.querySelectorAll('#chat-log .chat-message')) {\r\n        const message = game.messages.get(el.dataset.messageId)\r\n        if (!message) continue\r\n        renderChatMessage(message, $(el))\r\n    }\r\n\r\n    if (game.user.isGM && game.modules.get('pf2e-rules-based-npc-vision')?.active) {\r\n        ui.notifications.error(`${MODULE_ID}.warning.npc-vision`, { permanent: true, localize: true })\r\n    }\r\n})\r\n\r\nHooks.on('hoverToken', hoverToken)\r\nHooks.on('pasteToken', pasteToken)\r\nHooks.on('updateToken', updateToken)\r\nHooks.on('deleteToken', deleteToken)\r\nHooks.on('controlToken', controlToken)\r\nHooks.on('renderTokenHUD', renderTokenHUD)\r\nHooks.on('preCreateToken', preCreateToken)\r\n\r\nHooks.on('canvasPan', () => clearConditionals())\r\n\r\nHooks.on('renderCheckModifiersDialog', renderCheckModifiersDialog)\r\n\r\nHooks.on('preCreateMeasuredTemplate', preCreateMeasuredTemplate)\r\nHooks.on('createMeasuredTemplate', onMeasuredTemplate)\r\nHooks.on('updateMeasuredTemplate', onMeasuredTemplate)\r\nHooks.on('deleteMeasuredTemplate', onMeasuredTemplate)\r\n"],
  "mappings": "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",
  "names": ["COVER_UUID", "VISIBILITY_VALUES", "VISIBILITIES", "COVERS", "COVER_VALUES", "defaultValues", "attackCheckRoll", "validCheckRoll", "ICONS_PATHS", "VISION_LEVELS", "DARKNESS_COLOR", "MIST_COLOR", "POISON_GREEN", "DARKNESS_SLUGS", "MIST_SLUGS", "MODULE_ID", "templatePath", "template", "__name", "localize", "args", "data", "useFormat", "keys", "getFlag", "doc", "flag", "setFlag", "value", "unsetFlag", "getFlags", "getSetting", "setting", "setSetting", "hasPermission", "createFlatFootedSource", "visibility", "source", "__name", "createCoverSource", "level", "bonus", "COVER_VALUES", "localize", "COVER_UUID", "MODULE_ID", "findChoiceSetRule", "item", "flag", "rule", "extractEphemeralEffects", "affects", "origin", "target", "item", "domains", "options", "effectsFrom", "effectsTo", "fullOptions", "resolvables", "s", "d", "e", "__name", "traitSlugToObject", "trait", "dictionary", "traitObject", "objectHasKey", "obj", "key", "getRangeIncrement", "attackItem", "distance", "isOffGuardFromFlanking", "flanking", "DATA", "SELECTORS", "setupRuleElement", "rollOptionSchema", "PredicateField", "ResolvableValueField", "PF2ePerceptionRuleElement", "source", "options", "selectorType", "selector", "selectorWarn", "__name", "msg", "name", "uuid", "targetsType", "joinedTargets", "t", "valueType", "fields", "rollOptions", "password", "affects", "perception", "root", "verificator", "targets", "target", "path", "value", "perceptionRules", "origin", "distance", "extraOptions", "rules", "r", "selfOptions", "otherOptions", "distances", "prefix", "testOptions", "rule", "getPerception", "type", "cursor", "updateFromPerceptionRules", "list", "COVERS", "VISIBILITIES", "setValue", "index", "renderSceneConfig", "config", "html", "settings", "list", "setting", "checked", "getSceneSetting", "localize", "addedHeight", "height", "el", "__name", "getValidTokens", "token", "tokens", "t", "getSetting", "combat", "actor", "traits", "validateTokens", "validToken", "id", "scene", "getFlag", "getPrototype", "obj", "depth", "prototype", "__name", "sortByName", "a", "b", "asNumberOnly", "value", "BaseMenu", "#token", "#resolve", "#selected", "#_currentData", "#hoverTokenListener", "token", "resolve", "selected", "options", "hover", "tokenId", "tokens", "params", "localize", "MODULE_ID", "win", "x", "original", "current", "property", "defaultValue", "defaultValues", "originalValue", "currentValue", "validateTokens", "#currentData", "data", "getTokenData", "id", "COVERS", "value", "VISIBILITIES", "html", "event", "target", "tokenIds", "currentData", "setTokenData", "el", "allies", "enemies", "neutral", "alliance", "opposition", "actorAlliance", "sortByName", "__name", "PerceptionMenu", "BaseMenu", "localize", "templatePath", "options", "selected", "currentData", "originalData", "tokens", "getValidTokens", "id", "name", "actor", "current", "original", "html", "event", "section", "allSelected", "t", "__name", "RECT_SPREAD", "getRectEdges", "rect", "margin", "opposite", "getRectPoint", "__name", "lineIntersectWall", "origin", "target", "debug", "drawDebugLine", "pointToTokenIntersectWall", "token", "point", "rectSpread", "clearDebug", "color", "hex", "getLightExposure", "token", "debug", "scene", "clearDebug", "center", "exposure", "light", "bright", "dim", "drawDebugLine", "__name", "measureDistance", "p0", "p1", "measureDistanceOnGrid", "__name", "segment", "reach", "gridSize", "gridDistance", "nx", "ny", "nz", "sortedDistance", "a", "b", "squares", "reduction", "highlightGrid", "areaType", "object", "colors", "document", "collisionType", "preview", "collisionOrigin", "grid", "dimensions", "angle", "direction", "highlightLayer", "cx", "cy", "col0", "row0", "minAngle", "maxAngle", "snappedOrigin", "withinAngle", "min", "max", "value", "coneOriginOffset", "dir", "xOffset", "yOffset", "padding", "docDistance", "padded", "rowCount", "columnCount", "offsetEmanationOrigin", "destination", "offset", "getCoordinate", "centerCoord", "destCoord", "gx", "gy", "emanationOriginOffset", "origin", "ray", "rayAngle", "templateConversion", "createSeekTemplate", "type", "token", "distance", "checkScene", "createTemplate", "__name", "createDarknessTemplate", "conceal", "DARKNESS_COLOR", "createMistTemplate", "MIST_COLOR", "getTemplates", "t", "getFlag", "getDarknessTemplates", "getMistTemplates", "getSeekTemplateTokens", "template", "getTemplateTokens", "deleteSeekTemplate", "templates", "localize", "traits", "fillColor", "width", "flags", "templateData", "MODULE_ID", "templateDoc", "collisionOrigin", "collisionType", "grid", "dimensions", "gridHighlight", "origin", "tokens", "containedTokens", "tokenDoc", "tokenPositions", "h", "y", "w", "position", "gx", "gy", "s", "destination", "highlightTemplateGrid", "highlightGrid", "preCreateMeasuredTemplate", "slug", "castLevel", "DARKNESS_SLUGS", "MIST_SLUGS", "POISON_GREEN", "onMeasuredTemplate", "renderTokenHUD", "hud", "html", "hasPermission", "event", "PerceptionMenu", "__name", "pasteToken", "originals", "sources", "source", "MODULE_ID", "getTokenData", "token", "path", "getFlag", "clearTokenData", "unsetFlag", "setTokenData", "data", "valid", "getValidTokens", "t", "updates", "tokenId", "current", "original", "defaultValues", "property", "getWallCover", "origin", "target", "debug", "scene", "getSceneSetting", "clearDebug", "getSetting", "pointToTokenIntersectWall", "lineIntersectWall", "SIZES", "getCover", "perception", "options", "affects", "prone", "isProne", "returnValue", "value", "updateFromPerceptionRules", "systemCover", "getCoverEffect", "COVER_VALUES", "cover", "custom", "customCover", "COVERS", "getCreatureCover", "originToken", "targetToken", "setting", "ignoreIds", "originIds", "targetIds", "drawDebugLine", "isExtraLarge", "size", "originSize", "targetSize", "tokens", "a", "b", "extralarges", "margin", "intersectsEdge", "edge", "intersectsWith", "edges", "tokenDocument", "getRectEdges", "getVisibility", "originActor", "targetActor", "systemVisibility", "visibility", "isInvisible", "VISIBILITY_VALUES", "seeInvisibility", "getPerception", "mergedVisibility", "targetLowlight", "targetDarkvision", "targetGreaterDarkvision", "hasGreaterDarkvision", "inDarkness", "darknessTemplates", "getDarknessTemplates", "darknessVisibility", "template", "darknessTokens", "getTemplateTokens", "mistTemplates", "getMistTemplates", "mistTokens", "exposure", "getLightExposure", "exposedVisibility", "updateToken", "context", "userId", "flags", "hk", "refreshed", "hoverToken", "hovered", "showAllConditionals", "clearConditionals", "deleteToken", "controlToken", "controlled", "showConditionals", "scale", "coords", "content", "savedPaths", "icon", "ICONS_PATHS", "rulesBasedVision", "preCreateToken", "getRollContext", "params", "selfToken", "targetToken", "t", "selfOptions", "originEphemeralEffects", "extractEphemeralEffects", "selfActor", "isStrike", "strikeActions", "a", "statistic", "action", "selfItem", "itemClone", "itemOptions", "traitSlugs", "d", "adjustment", "traits", "traitSlugToObject", "distance", "originDistance", "targetDistance", "getTargetRollOptions", "__name", "actor", "targetOptions", "mark", "targetRollOptions", "targetEphemeralEffects", "reach", "isMelee", "perception", "perceptionRules", "visibility", "getVisibility", "getPerception", "VISIBILITY_VALUES", "createFlatFootedSource", "cover", "getCover", "coverBonus", "ac", "asNumberOnly", "COVER_VALUES", "createCoverSource", "isOffGuardFromFlanking", "name", "condition", "targetActor", "rollOptions", "rangeIncrement", "getRangeIncrement", "self", "target", "getActorToken", "actorId", "isToken", "token", "isProne", "item", "getCoverEffect", "selection", "effect", "x", "COVER_UUID", "findChoiceSetRule", "visionLevel", "sensesStr", "senses", "splitNPCSenses", "sensesRules", "r", "VISION_LEVELS", "__name", "hasSense", "actor", "sense", "s", "hasGreaterDarkvision", "seeInvisibility", "DEGREE_ADJUSTMENT_AMOUNTS", "DEGREE_OF_SUCCESS_STRINGS", "_getDegreeAdjustment", "getDegreeAdjustment_fn", "_adjustDegreeOfSuccess", "adjustDegreeOfSuccess_fn", "_adjustDegreeByDieValue", "adjustDegreeByDieValue_fn", "_calculateDegreeOfSuccess", "calculateDegreeOfSuccess_fn", "_DegreeOfSuccess", "roll", "dc", "dosAdjustments", "__privateAdd", "t", "d", "__privateMethod", "DegreeOfSuccess", "__name", "degree", "adjustments", "outcome", "label", "amount", "degreeOfSuccess", "__publicField", "ValidationMenu", "BaseMenu", "params", "options", "validated", "validateMessage", "localize", "templatePath", "selected", "token", "alliance", "getValidTokens", "t", "converted", "data", "property", "scene", "defaultValue", "defaultValues", "propertyList", "COVERS", "VISIBILITIES", "tokenId", "fullProperty", "currentValue", "processedValue", "covers", "visibilities", "i18n", "currentData", "originalData", "tokens", "id", "name", "actor", "current", "original", "validation", "getSetting", "html", "event", "__name", "CoverValidationMenu", "#value", "VisibilityValidationMenu", "#roll", "HideValidationMenu", "value", "roll", "dc", "visibility", "VISIBILITY_VALUES", "success", "DegreeOfSuccess", "UnHideValidationMenu", "PointOutValidationMenu", "#originator", "originatorId", "getTokenData", "ReverseVisibilityValidationMenu", "thisId", "tokenData", "parentData", "updates", "update", "MODULE_ID", "SeekValidationMenu", "#fromTemplate", "deleteSeekTemplate", "renderChatMessage", "message", "html", "token", "isGM", "hasPlayerOwner", "cover", "selected", "skipWait", "validated", "pointOut", "getFlags", "pf2eContext", "button", "createValidateButton", "CoverValidationMenu", "hint", "createWaitHint", "flavor", "msg", "localize", "createHint", "type", "createChatButton", "setFlag", "HideValidationMenu", "addBlindSkillCheckFlavor", "buttons", "createValidateCombo", "SeekValidationMenu", "deleteSeekTemplate", "selectedToken", "PointOutValidationMenu", "t", "attackCheckRoll", "event", "UnHideValidationMenu", "__name", "validateMessage", "getFlag", "smallIcon", "smallAction", "smallSlashed", "property", "label", "action", "icon", "tooltip", "slashed", "createTokenMessage", "content", "flags", "secret", "data", "MODULE_ID", "setupActions", "hide", "BaseAction", "getPrototype", "BaseActionVariant", "SingleCheckAction", "SingleCheckActionVariant", "setupCover", "setupHide", "setupSneak", "setupSeek", "setupPointOut", "__name", "PointOutVariant", "options", "action", "localize", "token", "getSelectedToken", "pointOut", "PointOut", "MODULE_ID", "data", "name", "traits", "target", "t", "visibility", "getTokenData", "isVisible", "VISIBILITY_VALUES", "description", "dc", "content", "templatePath", "slug", "flags", "createTokenMessage", "SeekVariant", "seek", "deleteSeekTemplate", "Seek", "unit", "createButton", "html", "event", "createSeekTemplate", "SneakVariant", "Sneak", "HideVariant", "Hide", "TakeCoverVariant", "takeCover", "TakeCover", "actor", "cover", "getCoverEffect", "targets", "validateTokens", "covers", "tokenId", "id", "isProne", "dialog", "level", "skip", "getSetting", "process", "selected", "flavor", "defaultValues", "message", "clearTokenData", "setTokenData", "source", "createCoverSource", "tokens", "actors", "getActorToken", "icon", "label", "API", "clearDebug", "getRectEdges", "lineIntersectWall", "pointToTokenIntersectWall", "getCreatureCover", "getWallCover", "getVisibility", "clearConditionals", "showConditionals", "showAllConditionals", "getTokenData", "getCover", "getLightExposure", "getActorToken", "isProne", "getCoverEffect", "hasGreaterDarkvision", "getValidTokens", "validateTokens", "getSceneSetting", "createSeekTemplate", "createDarknessTemplate", "createMistTemplate", "getDarknessTemplates", "getMistTemplates", "getSeekTemplateTokens", "deleteSeekTemplate", "createTemplate", "getTemplateTokens", "perceptionRules", "getPerception", "updateFromPerceptionRules", "checkRoll", "wrapped", "args", "context", "actor", "createMessage", "type", "token", "target", "isReroll", "originToken", "getActorToken", "targetToken", "isAttackRoll", "attackCheckRoll", "flatCheck", "getSetting", "validCheckRoll", "event", "perception", "perceptionRules", "o", "visibility", "getVisibility", "dc", "asNumberOnly", "getPerception", "isUndetected", "VISIBILITY_VALUES", "isBlind", "isSuccess", "highlighted", "getSeekTemplateTokens", "tokens", "selected", "validateTokens", "t", "__name", "renderCheckModifiersDialog", "dialog", "html", "options", "targetActor", "coverEffect", "getCoverEffect", "currentCover", "findChoiceSetRule", "getFlag", "coverOverride", "MODULE_ID", "template", "localize", "isProne", "COVERS", "slug", "label", "value", "modified", "items", "coverIndex", "i", "COVER_UUID", "source", "createCoverSource", "statistic", "renderCombatTracker", "tracker", "html", "getSetting", "setupToggleTarget", "__name", "setupToggleTarget", "html", "_", "el", "event", "combatantId", "token", "isTargeted", "t", "__name", "renderCombatTrackerConfig", "config", "checked", "getSetting", "localize", "setSetting", "detectionModeTestVisibility", "visionSource", "mode", "config", "test", "__name", "basicSightCanDetect", "target", "origin", "originDocument", "reachesThreshold", "VISIBILITY_VALUES", "hearingCanDetect", "feelTremorCanDetect", "threshold", "perception", "perceptionRules", "getVisibility", "ICONS", "IconPathMenu", "templatePath", "localize", "saved", "getSetting", "name", "ICONS_PATHS", "html", "event", "formData", "setSetting", "__name", "registerSettings", "register", "MODULE_ID", "path", "IconPathMenu", "__name", "setting", "key", "name", "type", "defValue", "extra", "CHECK_ROLL", "RULES_BASED_VISION", "HIGHLIGHT_TEMPLATE_GRID", "GET_ROLL_CONTEXT", "VISION_LEVEL", "DETECTION_MODE_TEST_VISIBILITY", "BASIC_SIGHT_CAN_DETECT", "HEARING_CAN_DETECT", "FEEL_TREMOR_CAN_DETECT", "registerSettings", "setupActions", "setupRuleElement", "MODULE_ID", "checkRoll", "highlightTemplateGrid", "rulesBasedVision", "getRollContext", "visionLevel", "detectionModeTestVisibility", "basicSightCanDetect", "hearingCanDetect", "feelTremorCanDetect", "x", "renderSceneConfig", "renderCombatTrackerConfig", "renderCombatTracker", "API", "renderChatMessage", "el", "message", "hoverToken", "pasteToken", "updateToken", "deleteToken", "controlToken", "renderTokenHUD", "preCreateToken", "clearConditionals", "renderCheckModifiersDialog", "preCreateMeasuredTemplate", "onMeasuredTemplate"]
}
